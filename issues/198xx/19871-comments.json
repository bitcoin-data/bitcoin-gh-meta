[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r483686130"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483686130"
         }
      },
      "author_association" : "MEMBER",
      "body" : "How about:\r\n\r\n```\r\n// Note that outbound block-relay peers are excluded from this protection, and thus always subject to eviction under the bad/lagging chain logic.\r\n```",
      "commit_id" : "d76925478efd35e6fd835370639f2139b28381e4",
      "created_at" : "2020-09-04T15:21:53Z",
      "diff_hunk" : "@@ -2021,8 +2021,8 @@ static void ProcessHeadersMessage(CNode& pfrom, CConnman& connman, ChainstateMan\n         if (!pfrom.fDisconnect && pfrom.IsFullOutboundConn() && nodestate->pindexBestKnownBlock != nullptr) {\n             // If this is an outbound full-relay peer, check to see if we should protect\n             // it from the bad/lagging chain logic.\n-            // Note that block-relay-only peers are already implicitly protected, so we\n-            // only consider setting m_protect for the full-relay peers.\n+            // Note that outbound block-relay peers are excluded from this protection and\n+            // thus passive of eviction by bad/lagging chain logic.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r483686130",
      "id" : 483686130,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY4NjEzMA==",
      "original_commit_id" : "b94ebc334a12a90b35ac187b610d7046fd86bff1",
      "original_line" : 2025,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 482741568,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-10T13:52:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483686130",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r483687757"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483687757"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Also, you may want to consider adding a comment that explains how `m_protect` is used by stale-tip-based eviction as well.  In particular, the stale-tip -> extra full outbound peer logic could cause an existing full outbound to be evicted, but peers with `m_protect` set will not be chosen for eviction.",
      "commit_id" : "d76925478efd35e6fd835370639f2139b28381e4",
      "created_at" : "2020-09-04T15:24:52Z",
      "diff_hunk" : "@@ -2021,8 +2021,8 @@ static void ProcessHeadersMessage(CNode& pfrom, CConnman& connman, ChainstateMan\n         if (!pfrom.fDisconnect && pfrom.IsFullOutboundConn() && nodestate->pindexBestKnownBlock != nullptr) {\n             // If this is an outbound full-relay peer, check to see if we should protect\n             // it from the bad/lagging chain logic.\n-            // Note that block-relay-only peers are already implicitly protected, so we\n-            // only consider setting m_protect for the full-relay peers.\n+            // Note that outbound block-relay peers are excluded from this protection and\n+            // thus passive of eviction by bad/lagging chain logic.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r483687757",
      "id" : 483687757,
      "in_reply_to_id" : 483686130,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY4Nzc1Nw==",
      "original_commit_id" : "b94ebc334a12a90b35ac187b610d7046fd86bff1",
      "original_line" : 2025,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 482741568,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-10T13:52:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483687757",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r483789959"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483789959"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks for the suggestion. Also added a commit on scope of m_protect w.r.t to both eviction logics.",
      "commit_id" : "d76925478efd35e6fd835370639f2139b28381e4",
      "created_at" : "2020-09-04T18:38:33Z",
      "diff_hunk" : "@@ -2021,8 +2021,8 @@ static void ProcessHeadersMessage(CNode& pfrom, CConnman& connman, ChainstateMan\n         if (!pfrom.fDisconnect && pfrom.IsFullOutboundConn() && nodestate->pindexBestKnownBlock != nullptr) {\n             // If this is an outbound full-relay peer, check to see if we should protect\n             // it from the bad/lagging chain logic.\n-            // Note that block-relay-only peers are already implicitly protected, so we\n-            // only consider setting m_protect for the full-relay peers.\n+            // Note that outbound block-relay peers are excluded from this protection and\n+            // thus passive of eviction by bad/lagging chain logic.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r483789959",
      "id" : 483789959,
      "in_reply_to_id" : 483686130,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc4OTk1OQ==",
      "original_commit_id" : "b94ebc334a12a90b35ac187b610d7046fd86bff1",
      "original_line" : 2025,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 482871788,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-10T13:52:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/483789959",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated at 6ce273b. I guess we could split up `m_protect` or clarify `ChainSyncTimeout` name but I don't want to interfere with actual refactoring of `CNodeState` (#19398). It would be easier to reorganize structures after completion of this project.",
      "created_at" : "2020-09-04T18:42:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19871#issuecomment-687317729",
      "id" : 687317729,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19871",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NzMxNzcyOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-04T18:42:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/687317729",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r484308509"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484308509"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This code is in the conditional `&& pfrom.IsFullOutboundConn()`.\r\n\r\nWhy comments about `block-relay-only` connections belong inside a block related to `full conns`?",
      "commit_id" : "d76925478efd35e6fd835370639f2139b28381e4",
      "created_at" : "2020-09-07T09:25:57Z",
      "diff_hunk" : "@@ -2021,8 +2021,8 @@ static void ProcessHeadersMessage(CNode& pfrom, CConnman& connman, ChainstateMan\n         if (!pfrom.fDisconnect && pfrom.IsFullOutboundConn() && nodestate->pindexBestKnownBlock != nullptr) {\n             // If this is an outbound full-relay peer, check to see if we should protect\n             // it from the bad/lagging chain logic.\n-            // Note that block-relay-only peers are already implicitly protected, so we\n-            // only consider setting m_protect for the full-relay peers.\n+            // Note that outbound block-relay peers are excluded from this protection, and",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r484308509",
      "id" : 484308509,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDMwODUwOQ==",
      "original_commit_id" : "61c2a4282ed8570ef8123ea4188e7969fa48971c",
      "original_line" : 2024,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483400013,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-10T13:52:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484308509",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r484309396"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484309396"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I would probably prefer to have a good big comment *before* the following line:\r\n```\r\n         if (!pfrom.fDisconnect && pfrom.IsFullOutboundConn() && nodestate->pindexBestKnownBlock != nullptr) {\r\n```",
      "commit_id" : "d76925478efd35e6fd835370639f2139b28381e4",
      "created_at" : "2020-09-07T09:27:23Z",
      "diff_hunk" : "@@ -2021,8 +2021,8 @@ static void ProcessHeadersMessage(CNode& pfrom, CConnman& connman, ChainstateMan\n         if (!pfrom.fDisconnect && pfrom.IsFullOutboundConn() && nodestate->pindexBestKnownBlock != nullptr) {\n             // If this is an outbound full-relay peer, check to see if we should protect\n             // it from the bad/lagging chain logic.\n-            // Note that block-relay-only peers are already implicitly protected, so we\n-            // only consider setting m_protect for the full-relay peers.\n+            // Note that outbound block-relay peers are excluded from this protection, and",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r484309396",
      "id" : 484309396,
      "in_reply_to_id" : 484308509,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDMwOTM5Ng==",
      "original_commit_id" : "61c2a4282ed8570ef8123ea4188e7969fa48971c",
      "original_line" : 2024,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483401135,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-10T13:52:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484309396",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r484475819"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484475819"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Moved comment above with new referral to ChainSyncTimeout.",
      "commit_id" : "d76925478efd35e6fd835370639f2139b28381e4",
      "created_at" : "2020-09-07T14:49:24Z",
      "diff_hunk" : "@@ -2021,8 +2021,8 @@ static void ProcessHeadersMessage(CNode& pfrom, CConnman& connman, ChainstateMan\n         if (!pfrom.fDisconnect && pfrom.IsFullOutboundConn() && nodestate->pindexBestKnownBlock != nullptr) {\n             // If this is an outbound full-relay peer, check to see if we should protect\n             // it from the bad/lagging chain logic.\n-            // Note that block-relay-only peers are already implicitly protected, so we\n-            // only consider setting m_protect for the full-relay peers.\n+            // Note that outbound block-relay peers are excluded from this protection, and",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r484475819",
      "id" : 484475819,
      "in_reply_to_id" : 484308509,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDQ3NTgxOQ==",
      "original_commit_id" : "61c2a4282ed8570ef8123ea4188e7969fa48971c",
      "original_line" : 2024,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483610143,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-10T13:52:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484475819",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r484699656"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484699656"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`* drop to the outbound one that least recently announced us a new block.` -> \r\n`* drop the outbound one that least recently announced us a new block.` (\"to\" does not belong here)",
      "commit_id" : "d76925478efd35e6fd835370639f2139b28381e4",
      "created_at" : "2020-09-08T07:14:09Z",
      "diff_hunk" : "@@ -334,6 +339,9 @@ struct CNodeState {\n       *     and set a shorter timeout, HEADERS_RESPONSE_TIME seconds in future.\n       *     If their best known block is still behind when that new timeout is\n       *     reached, disconnect.\n+      *\n+      * EXTRA_PEER_CHECK_INTERVAL: after each interval, if we have too many outbound peers,\n+      * drop to the outbound one that least recently announced us a new block.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r484699656",
      "id" : 484699656,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY5OTY1Ng==",
      "original_commit_id" : "706f1f0cff7178b62eafebead26964c7c703dcbf",
      "original_line" : 344,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483854244,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-10T13:52:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484699656",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r484701461"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484701461"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`and not having reached yet MAX_OUTBOUND_PEERS_TO_PROTECT_FROM_DISCONNECT` makes it sound like *the peer* is not having reached, not us. I suggest this:\r\n\r\nA peer is marked as protected if\r\n      - it gave us a valid connecting header\r\n      - it has a better chain than we have\r\n      - we haven't reached MAX_OUTBOUND_PEERS_TO_PROTECT_FROM_DISCONNECT yet",
      "commit_id" : "d76925478efd35e6fd835370639f2139b28381e4",
      "created_at" : "2020-09-08T07:17:28Z",
      "diff_hunk" : "@@ -321,10 +321,15 @@ struct CNodeState {\n      */\n     bool fSupportsDesiredCmpctVersion;\n \n-    /** State used to enforce CHAIN_SYNC_TIMEOUT\n-      * Only in effect for outbound, non-manual, full-relay connections, with\n-      * m_protect == false\n-      * Algorithm: if a peer's best known block has less work than our tip,\n+    /** State used to enforce CHAIN_SYNC_TIMEOUT and EXTRA_PEER_CHECK_INTERVAL logics.\n+      *\n+      * Both are only in effect for outbound, non-manual, non-protected connections.\n+      * Any peer protected (m_protect = true) is not chosen for eviction. Block-relay\n+      * peers are always excluded from protection. A peer is marked as protected under\n+      * the condition of receiving at least a valid connecting header, having a better\n+      * chain than us and not having reached yet MAX_OUTBOUND_PEERS_TO_PROTECT_FROM_DISCONNECT.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r484701461",
      "id" : 484701461,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDcwMTQ2MQ==",
      "original_commit_id" : "706f1f0cff7178b62eafebead26964c7c703dcbf",
      "original_line" : 330,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483856442,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-10T13:52:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484701461",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks @naumenkogs, took your last suggestion at b55f979",
      "created_at" : "2020-09-08T14:35:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19871#issuecomment-688920099",
      "id" : 688920099,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19871",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4ODkyMDA5OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-08T14:35:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688920099",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK b55f9790194746ce0180fc9fc5e085bdb118432c",
      "created_at" : "2020-09-09T10:52:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19871#issuecomment-689484439",
      "id" : 689484439,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19871",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4OTQ4NDQzOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-09T10:52:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/689484439",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r485528638"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485528638"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(drive-by review on the GitHub app from phone at lunch, feel free to ignore, will review properly):\n\nperhaps clarify s/if/if all of these are true/",
      "commit_id" : "b55f9790194746ce0180fc9fc5e085bdb118432c",
      "created_at" : "2020-09-09T11:10:17Z",
      "diff_hunk" : "@@ -321,10 +321,17 @@ struct CNodeState {\n      */\n     bool fSupportsDesiredCmpctVersion;\n \n-    /** State used to enforce CHAIN_SYNC_TIMEOUT\n-      * Only in effect for outbound, non-manual, full-relay connections, with\n-      * m_protect == false\n-      * Algorithm: if a peer's best known block has less work than our tip,\n+    /** State used to enforce CHAIN_SYNC_TIMEOUT and EXTRA_PEER_CHECK_INTERVAL logics.\n+      *\n+      * Both are only in effect for outbound, non-manual, non-protected connections.\n+      * Any peer protected (m_protect = true) is not chosen for eviction. A peer is\n+      * marked as protected if :",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r485528638",
      "id" : 485528638,
      "line" : 328,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTUyODYzOA==",
      "original_commit_id" : "b55f9790194746ce0180fc9fc5e085bdb118432c",
      "original_line" : 328,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 12,
      "pull_request_review_id" : 484899937,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-09T11:12:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485528638",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r485593886"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485593886"
         }
      },
      "author_association" : "MEMBER",
      "body" : "b55f9790 suggestions\r\n```diff\r\n-    /** State used to enforce CHAIN_SYNC_TIMEOUT and EXTRA_PEER_CHECK_INTERVAL logics.\r\n+    /** State used to enforce CHAIN_SYNC_TIMEOUT and EXTRA_PEER_CHECK_INTERVAL logic.\r\n       *\r\n       * Both are only in effect for outbound, non-manual, non-protected connections.\r\n       * Any peer protected (m_protect = true) is not chosen for eviction. A peer is\r\n-      * marked as protected if :\r\n+      * marked as protected if all of these are true:\r\n       *   - its connection type is IsBlockOnlyConn() == false\r\n       *   - it gave us a valid connecting header\r\n-      *   - it has a better chain than we have\r\n       *   - we haven't reached MAX_OUTBOUND_PEERS_TO_PROTECT_FROM_DISCONNECT yet\r\n+      *   - it has a better chain than we have\r\n+      *   - it is not already marked as protected\r\n```",
      "commit_id" : "d76925478efd35e6fd835370639f2139b28381e4",
      "created_at" : "2020-09-09T13:04:10Z",
      "diff_hunk" : "@@ -334,6 +341,9 @@ struct CNodeState {\n       *     and set a shorter timeout, HEADERS_RESPONSE_TIME seconds in future.\n       *     If their best known block is still behind when that new timeout is\n       *     reached, disconnect.\n+      *\n+      * EXTRA_PEER_CHECK_INTERVAL: after each interval, if we have too many outbound peers,\n+      * drop the outbound one that least recently announced us a new block.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r485593886",
      "id" : 485593886,
      "line" : 346,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU5Mzg4Ng==",
      "original_commit_id" : "b55f9790194746ce0180fc9fc5e085bdb118432c",
      "original_line" : 346,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 28,
      "pull_request_review_id" : 484985111,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-10T13:52:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485593886",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r485655554"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485655554"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, I'm going to leave it as it is. It's a bit confusing saying that something is \"marked as protected if it is not already marked as protected\".\r\n\r\nNote, actually CHAIN_SYNC_TIMEOUT and EXTRA_PEER_CHECK_INTERVAL are two different logics, thus the plural.",
      "commit_id" : "d76925478efd35e6fd835370639f2139b28381e4",
      "created_at" : "2020-09-09T14:26:46Z",
      "diff_hunk" : "@@ -334,6 +341,9 @@ struct CNodeState {\n       *     and set a shorter timeout, HEADERS_RESPONSE_TIME seconds in future.\n       *     If their best known block is still behind when that new timeout is\n       *     reached, disconnect.\n+      *\n+      * EXTRA_PEER_CHECK_INTERVAL: after each interval, if we have too many outbound peers,\n+      * drop the outbound one that least recently announced us a new block.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r485655554",
      "id" : 485655554,
      "in_reply_to_id" : 485593886,
      "line" : 346,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY1NTU1NA==",
      "original_commit_id" : "b55f9790194746ce0180fc9fc5e085bdb118432c",
      "original_line" : 346,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 28,
      "pull_request_review_id" : 485067046,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-10T13:52:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485655554",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r485659666"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485659666"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm aware. Logic is most often used as an uncountable noun, but it's not an issue.\n\nWhile rewriting this, I think it would be good to clarify that the list of conditions is \"if all of these\" and not \"if any of these\".\n\nThe reordering suggestion is to follow the order of the actual checks.\n\nI verified that the proposed documentation corresponds to the code.",
      "commit_id" : "d76925478efd35e6fd835370639f2139b28381e4",
      "created_at" : "2020-09-09T14:31:59Z",
      "diff_hunk" : "@@ -334,6 +341,9 @@ struct CNodeState {\n       *     and set a shorter timeout, HEADERS_RESPONSE_TIME seconds in future.\n       *     If their best known block is still behind when that new timeout is\n       *     reached, disconnect.\n+      *\n+      * EXTRA_PEER_CHECK_INTERVAL: after each interval, if we have too many outbound peers,\n+      * drop the outbound one that least recently announced us a new block.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r485659666",
      "id" : 485659666,
      "in_reply_to_id" : 485593886,
      "line" : 346,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY1OTY2Ng==",
      "original_commit_id" : "b55f9790194746ce0180fc9fc5e085bdb118432c",
      "original_line" : 346,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 28,
      "pull_request_review_id" : 485072556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-10T13:52:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485659666",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated at d769254, with last @jonatack suggestions.",
      "created_at" : "2020-09-10T13:56:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19871#issuecomment-690305619",
      "id" : 690305619,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19871",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5MDMwNTYxOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-10T13:56:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/690305619",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r486364880"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486364880"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks for the noun suggestion. Took it, also the re-ordering. But not the \"it is not already marked as protected\" it's a tautology IMO (it would false future triggering of protection if we don't due to g_outbound_peers_with_protect_from_disconnect is incremented in same conditional, but technically the state transition is defined without)",
      "commit_id" : "d76925478efd35e6fd835370639f2139b28381e4",
      "created_at" : "2020-09-10T13:57:14Z",
      "diff_hunk" : "@@ -334,6 +341,9 @@ struct CNodeState {\n       *     and set a shorter timeout, HEADERS_RESPONSE_TIME seconds in future.\n       *     If their best known block is still behind when that new timeout is\n       *     reached, disconnect.\n+      *\n+      * EXTRA_PEER_CHECK_INTERVAL: after each interval, if we have too many outbound peers,\n+      * drop the outbound one that least recently announced us a new block.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r486364880",
      "id" : 486364880,
      "in_reply_to_id" : 485593886,
      "line" : 346,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM2NDg4MA==",
      "original_commit_id" : "b55f9790194746ce0180fc9fc5e085bdb118432c",
      "original_line" : 346,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 28,
      "pull_request_review_id" : 485963409,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-10T13:57:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486364880",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK d76925478efd35e6fd835370639f2139b28381e4",
      "created_at" : "2020-09-10T14:03:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19871#issuecomment-690310733",
      "id" : 690310733,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19871",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5MDMxMDczMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-10T14:03:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/690310733",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r486371560"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486371560"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this explanation actually belongs to the declaration of `m_protect` better, but I don't care enough to ask for this... Consider this if you gonna update it. ",
      "commit_id" : "d76925478efd35e6fd835370639f2139b28381e4",
      "created_at" : "2020-09-10T14:05:47Z",
      "diff_hunk" : "@@ -321,10 +321,17 @@ struct CNodeState {\n      */\n     bool fSupportsDesiredCmpctVersion;\n \n-    /** State used to enforce CHAIN_SYNC_TIMEOUT\n-      * Only in effect for outbound, non-manual, full-relay connections, with\n-      * m_protect == false\n-      * Algorithm: if a peer's best known block has less work than our tip,\n+    /** State used to enforce CHAIN_SYNC_TIMEOUT and EXTRA_PEER_CHECK_INTERVAL logic.\n+      *\n+      * Both are only in effect for outbound, non-manual, non-protected connections.\n+      * Any peer protected (m_protect = true) is not chosen for eviction. A peer is",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r486371560",
      "id" : 486371560,
      "line" : 327,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM3MTU2MA==",
      "original_commit_id" : "d76925478efd35e6fd835370639f2139b28381e4",
      "original_line" : 327,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 11,
      "pull_request_review_id" : 485972330,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-10T14:05:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486371560",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK d76925478efd35e6fd835370639f2139b28381e4\r\n\r\nThanks for updating @ariard.",
      "created_at" : "2020-09-10T14:22:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19871#issuecomment-690322923",
      "id" : 690322923,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19871",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5MDMyMjkyMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-10T14:22:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/690322923",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r575550089"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575550089"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think this is quite right? \r\n\r\nthe relevant part of the check in `ProcessHeadersMessage` checks `nodestate->pindexBestKnownBlock->nChainWork >= ::ChainActive().Tip()->nChainWork`, aka would set `m_protect` to true if they have the same chain tip as we do. \r\n\r\nI think saying the peer \"has a better chain\" is misleading, because then I'd expect a long-running node to usually not have protected peers. Based on the logic I see, I'd expect a long-running node to usually have `MAX_OUTBOUND_PEERS_TO_PROTECT_FROM_DISCONNECT`.\r\n\r\nwhat do you think? ",
      "commit_id" : "d76925478efd35e6fd835370639f2139b28381e4",
      "created_at" : "2021-02-12T22:21:49Z",
      "diff_hunk" : "@@ -321,10 +321,17 @@ struct CNodeState {\n      */\n     bool fSupportsDesiredCmpctVersion;\n \n-    /** State used to enforce CHAIN_SYNC_TIMEOUT\n-      * Only in effect for outbound, non-manual, full-relay connections, with\n-      * m_protect == false\n-      * Algorithm: if a peer's best known block has less work than our tip,\n+    /** State used to enforce CHAIN_SYNC_TIMEOUT and EXTRA_PEER_CHECK_INTERVAL logic.\n+      *\n+      * Both are only in effect for outbound, non-manual, non-protected connections.\n+      * Any peer protected (m_protect = true) is not chosen for eviction. A peer is\n+      * marked as protected if all of these are true:\n+      *   - its connection type is IsBlockOnlyConn() == false\n+      *   - it gave us a valid connecting header\n+      *   - we haven't reached MAX_OUTBOUND_PEERS_TO_PROTECT_FROM_DISCONNECT yet\n+      *   - it has a better chain than we have",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19871#discussion_r575550089",
      "id" : 575550089,
      "line" : 332,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTU1MDA4OQ==",
      "original_commit_id" : "d76925478efd35e6fd835370639f2139b28381e4",
      "original_line" : 332,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 16,
      "pull_request_review_id" : 589875748,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19871",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-12T22:38:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575550089",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   }
]
