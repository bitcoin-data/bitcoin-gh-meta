[
   {
      "author_association" : "MEMBER",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [darosior](https://github.com/bitcoin/bitcoin/pull/25273#pullrequestreview-1354216199), [theStack](https://github.com/bitcoin/bitcoin/pull/25273#pullrequestreview-1411318920) |\n| Stale ACK | [furszy](https://github.com/bitcoin/bitcoin/pull/25273#pullrequestreview-1346792373) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#27601](https://github.com/bitcoin/bitcoin/pull/27601) (wallet: don't duplicate change output if already exist by furszy)\n* [#27286](https://github.com/bitcoin/bitcoin/pull/27286) (wallet: Keep track of the wallet's own transaction outputs in memory by achow101)\n* [#27101](https://github.com/bitcoin/bitcoin/pull/27101) (Support JSON-RPC 2.0 when requested by client by pinheadmz)\n* [#26902](https://github.com/bitcoin/bitcoin/pull/26902) (wallet: do not backdate locktime if it may lead to fingerprinting by rodentrabies)\n* [#24128](https://github.com/bitcoin/bitcoin/pull/24128) (wallet: BIP 326 sequence based anti-fee-snipe for taproot inputs by MarcoFalke)\n* [#21283](https://github.com/bitcoin/bitcoin/pull/21283) (Implement BIP 370 PSBTv2 by achow101)\n* [#19461](https://github.com/bitcoin/bitcoin/pull/19461) (multiprocess: Add bitcoin-gui -ipcconnect option by ryanofsky)\n* [#19460](https://github.com/bitcoin/bitcoin/pull/19460) (multiprocess: Add bitcoin-wallet -ipcconnect option by ryanofsky)\n* [#10102](https://github.com/bitcoin/bitcoin/pull/10102) (Multiprocess bitcoin by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2022-06-04T00:47:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#issuecomment-1146481423",
      "id" : 1146481423,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25273",
      "node_id" : "IC_kwDOABII585EVesP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1146481423/reactions"
      },
      "updated_at" : "2023-05-19T23:30:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1146481423",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r892703667"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/892703667"
         }
      },
      "author_association" : "MEMBER",
      "body" : "maybe inline?\r\n```suggestion\r\nif (it == m_selected.end() || !it->second.HasTxOut())) {\r\n    return false;\r\n}\r\n```",
      "commit_id" : "5a2e20bdfef12be86cccd8b8f8eba1743ade0994",
      "created_at" : "2022-06-08T18:00:30Z",
      "diff_hunk" : "@@ -66,77 +92,85 @@ class CCoinControl\n \n     bool HasSelected() const\n     {\n-        return (setSelected.size() > 0);\n+        return (m_selected.size() > 0);\n     }\n \n     bool IsSelected(const COutPoint& output) const\n     {\n-        return (setSelected.count(output) > 0);\n+        return (m_selected.count(output) > 0);\n     }\n \n     bool IsExternalSelected(const COutPoint& output) const\n     {\n-        return (m_external_txouts.count(output) > 0);\n+        const auto it = m_selected.find(output);\n+        if (it == m_selected.end()) {\n+            return false;\n+        }\n+        return it->second.HasTxOut();\n     }\n \n     bool GetExternalOutput(const COutPoint& outpoint, CTxOut& txout) const\n     {\n-        const auto ext_it = m_external_txouts.find(outpoint);\n-        if (ext_it == m_external_txouts.end()) {\n+        const auto it = m_selected.find(outpoint);\n+        if (it == m_selected.end()) {\n             return false;\n         }\n-        txout = ext_it->second;\n+        if (!it->second.HasTxOut()) {\n+            return false;\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r892703667",
      "id" : 892703667,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5841NZOz",
      "original_commit_id" : "99bd2a643d230ee2ce91b1d7a337d91386adb98a",
      "original_line" : 155,
      "original_position" : 68,
      "original_start_line" : 115,
      "path" : "src/wallet/coincontrol.h",
      "position" : null,
      "pull_request_review_id" : 1000211304,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/892703667/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-01-22T15:08:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/892703667",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r900971740"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/900971740"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Since this can never return a nullopt (errors throw), maybe just return `CreatedTransactionResult`?",
      "commit_id" : "5a2e20bdfef12be86cccd8b8f8eba1743ade0994",
      "created_at" : "2022-06-18T15:43:42Z",
      "diff_hunk" : "@@ -488,13 +487,13 @@ static std::vector<RPCArg> FundTxDoc(bool solving_data = true)\n     return args;\n }\n \n-void FundTransaction(CWallet& wallet, CMutableTransaction& tx, CAmount& fee_out, int& change_position, const UniValue& options, CCoinControl& coinControl, bool override_min_fee)\n+std::optional<CreatedTransactionResult> FundTransaction(CWallet& wallet, const CMutableTransaction& tx, const UniValue& options, CCoinControl& coinControl, bool override_min_fee)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r900971740",
      "id" : 900971740,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5841s7zc",
      "original_commit_id" : "664f7430478592fc89b7c2fdc423b7a649bc6c27",
      "original_line" : 490,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/wallet/rpc/spend.cpp",
      "position" : null,
      "pull_request_review_id" : 1011430105,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/900971740/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2022-06-18T15:43:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/900971740",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">Lastly, instead of using -1 as a magic number for the change output position, the change position is changed to be an optional with no value set indicating no desired change output position (when provided as an input parameter) or no change output present (in the result).\r\n\r\nI'm not sure this is an improvement. It just adds complexity, for no benefit in this particular instance?",
      "created_at" : "2022-06-18T15:48:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#issuecomment-1159486874",
      "id" : 1159486874,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25273",
      "node_id" : "IC_kwDOABII585FHF2a",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1159486874/reactions"
      },
      "updated_at" : "2022-06-18T15:48:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1159486874",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r900979687"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/900979687"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think it would be better to return the `PreselectedInput` and have the caller use `SetSequence` etc directly.",
      "commit_id" : "5a2e20bdfef12be86cccd8b8f8eba1743ade0994",
      "created_at" : "2022-06-18T15:55:02Z",
      "diff_hunk" : "@@ -61,82 +128,153 @@ class CCoinControl\n     int m_max_depth = DEFAULT_MAX_DEPTH;\n     //! SigningProvider that has pubkeys and scripts to do spend size estimation for external inputs\n     FlatSigningProvider m_external_provider;\n+    //! Locktime\n+    std::optional<uint32_t> m_locktime;\n+    //! Version\n+    std::optional<uint32_t> m_version;\n \n     CCoinControl();\n \n     bool HasSelected() const\n     {\n-        return (setSelected.size() > 0);\n+        return (m_selected.size() > 0);\n     }\n \n     bool IsSelected(const COutPoint& output) const\n     {\n-        return (setSelected.count(output) > 0);\n+        return (m_selected.count(output) > 0);\n     }\n \n     bool IsExternalSelected(const COutPoint& output) const\n     {\n-        return (m_external_txouts.count(output) > 0);\n+        const auto it = m_selected.find(output);\n+        if (it == m_selected.end()) {\n+            return false;\n+        }\n+        return it->second.HasTxOut();\n     }\n \n     bool GetExternalOutput(const COutPoint& outpoint, CTxOut& txout) const\n     {\n-        const auto ext_it = m_external_txouts.find(outpoint);\n-        if (ext_it == m_external_txouts.end()) {\n+        const auto it = m_selected.find(outpoint);\n+        if (it == m_selected.end()) {\n+            return false;\n+        }\n+        if (!it->second.HasTxOut()) {\n             return false;\n         }\n-        txout = ext_it->second;\n+        txout = it->second.GetTxOut();\n         return true;\n     }\n \n-    void Select(const COutPoint& output)\n+    void Select(const COutPoint& output, std::optional<uint32_t> sequence = std::nullopt, std::optional<CScript> script_sig = std::nullopt, std::optional<CScriptWitness> script_witness = std::nullopt)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r900979687",
      "id" : 900979687,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5841s9vn",
      "original_commit_id" : "664f7430478592fc89b7c2fdc423b7a649bc6c27",
      "original_line" : 170,
      "original_position" : 124,
      "original_start_line" : null,
      "path" : "src/wallet/coincontrol.h",
      "position" : null,
      "pull_request_review_id" : 1011430920,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/900979687/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2022-06-18T15:55:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/900979687",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r900983932"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/900983932"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why not? As long as one input has a non-final sequence, it should still work.\r\n\r\n(`DiscourageFeeSniping` would need its sanity checks adjusted to tolerate it, though)",
      "commit_id" : "5a2e20bdfef12be86cccd8b8f8eba1743ade0994",
      "created_at" : "2022-06-18T16:00:58Z",
      "diff_hunk" : "@@ -832,11 +845,33 @@ static std::optional<CreatedTransactionResult> CreateTransactionInternal(\n     // to avoid conflicting with other possible uses of nSequence,\n     // and in the spirit of \"smallest possible change from prior\n     // behavior.\"\n-    const uint32_t nSequence{coin_control.m_signal_bip125_rbf.value_or(wallet.m_signal_rbf) ? MAX_BIP125_RBF_SEQUENCE : CTxIn::MAX_SEQUENCE_NONFINAL};\n+    bool use_anti_fee_sniping = true;\n+    const uint32_t default_sequence{coin_control.m_signal_bip125_rbf.value_or(wallet.m_signal_rbf) ? MAX_BIP125_RBF_SEQUENCE : CTxIn::MAX_SEQUENCE_NONFINAL};\n     for (const auto& coin : selected_coins) {\n-        txNew.vin.push_back(CTxIn(coin.outpoint, CScript(), nSequence));\n+        uint32_t sequence = default_sequence;\n+        if (coin_control.HasSequence(coin.outpoint)) {\n+            sequence = coin_control.GetSequence(coin.outpoint);\n+            // If an input as a preset sequence, we can't do anti-fee-sniping",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r900983932",
      "id" : 900983932,
      "line" : 1032,
      "node_id" : "PRRC_kwDOABII5841s-x8",
      "original_commit_id" : "664f7430478592fc89b7c2fdc423b7a649bc6c27",
      "original_line" : 1032,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 112,
      "pull_request_review_id" : 1011431317,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/900983932/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2022-06-18T16:00:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/900983932",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r901781440"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/901781440"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is to retain the current behavior. The next step in a followup is to allow anti-fee-sniping and modify `DiscourageFeeSniping` to consider the preset sequences.",
      "commit_id" : "5a2e20bdfef12be86cccd8b8f8eba1743ade0994",
      "created_at" : "2022-06-20T15:13:05Z",
      "diff_hunk" : "@@ -832,11 +845,33 @@ static std::optional<CreatedTransactionResult> CreateTransactionInternal(\n     // to avoid conflicting with other possible uses of nSequence,\n     // and in the spirit of \"smallest possible change from prior\n     // behavior.\"\n-    const uint32_t nSequence{coin_control.m_signal_bip125_rbf.value_or(wallet.m_signal_rbf) ? MAX_BIP125_RBF_SEQUENCE : CTxIn::MAX_SEQUENCE_NONFINAL};\n+    bool use_anti_fee_sniping = true;\n+    const uint32_t default_sequence{coin_control.m_signal_bip125_rbf.value_or(wallet.m_signal_rbf) ? MAX_BIP125_RBF_SEQUENCE : CTxIn::MAX_SEQUENCE_NONFINAL};\n     for (const auto& coin : selected_coins) {\n-        txNew.vin.push_back(CTxIn(coin.outpoint, CScript(), nSequence));\n+        uint32_t sequence = default_sequence;\n+        if (coin_control.HasSequence(coin.outpoint)) {\n+            sequence = coin_control.GetSequence(coin.outpoint);\n+            // If an input as a preset sequence, we can't do anti-fee-sniping",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r901781440",
      "id" : 901781440,
      "in_reply_to_id" : 900983932,
      "line" : 1032,
      "node_id" : "PRRC_kwDOABII5841wBfA",
      "original_commit_id" : "664f7430478592fc89b7c2fdc423b7a649bc6c27",
      "original_line" : 1032,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 112,
      "pull_request_review_id" : 1012445513,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/901781440/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2022-06-20T15:13:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/901781440",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r901886622"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/901886622"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "5a2e20bdfef12be86cccd8b8f8eba1743ade0994",
      "created_at" : "2022-06-20T17:37:18Z",
      "diff_hunk" : "@@ -488,13 +487,13 @@ static std::vector<RPCArg> FundTxDoc(bool solving_data = true)\n     return args;\n }\n \n-void FundTransaction(CWallet& wallet, CMutableTransaction& tx, CAmount& fee_out, int& change_position, const UniValue& options, CCoinControl& coinControl, bool override_min_fee)\n+std::optional<CreatedTransactionResult> FundTransaction(CWallet& wallet, const CMutableTransaction& tx, const UniValue& options, CCoinControl& coinControl, bool override_min_fee)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r901886622",
      "id" : 901886622,
      "in_reply_to_id" : 900971740,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5841wbKe",
      "original_commit_id" : "664f7430478592fc89b7c2fdc423b7a649bc6c27",
      "original_line" : 490,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/wallet/rpc/spend.cpp",
      "position" : null,
      "pull_request_review_id" : 1012589713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/901886622/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2022-06-20T17:37:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/901886622",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r901886659"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/901886659"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "5a2e20bdfef12be86cccd8b8f8eba1743ade0994",
      "created_at" : "2022-06-20T17:37:23Z",
      "diff_hunk" : "@@ -61,82 +128,153 @@ class CCoinControl\n     int m_max_depth = DEFAULT_MAX_DEPTH;\n     //! SigningProvider that has pubkeys and scripts to do spend size estimation for external inputs\n     FlatSigningProvider m_external_provider;\n+    //! Locktime\n+    std::optional<uint32_t> m_locktime;\n+    //! Version\n+    std::optional<uint32_t> m_version;\n \n     CCoinControl();\n \n     bool HasSelected() const\n     {\n-        return (setSelected.size() > 0);\n+        return (m_selected.size() > 0);\n     }\n \n     bool IsSelected(const COutPoint& output) const\n     {\n-        return (setSelected.count(output) > 0);\n+        return (m_selected.count(output) > 0);\n     }\n \n     bool IsExternalSelected(const COutPoint& output) const\n     {\n-        return (m_external_txouts.count(output) > 0);\n+        const auto it = m_selected.find(output);\n+        if (it == m_selected.end()) {\n+            return false;\n+        }\n+        return it->second.HasTxOut();\n     }\n \n     bool GetExternalOutput(const COutPoint& outpoint, CTxOut& txout) const\n     {\n-        const auto ext_it = m_external_txouts.find(outpoint);\n-        if (ext_it == m_external_txouts.end()) {\n+        const auto it = m_selected.find(outpoint);\n+        if (it == m_selected.end()) {\n+            return false;\n+        }\n+        if (!it->second.HasTxOut()) {\n             return false;\n         }\n-        txout = ext_it->second;\n+        txout = it->second.GetTxOut();\n         return true;\n     }\n \n-    void Select(const COutPoint& output)\n+    void Select(const COutPoint& output, std::optional<uint32_t> sequence = std::nullopt, std::optional<CScript> script_sig = std::nullopt, std::optional<CScriptWitness> script_witness = std::nullopt)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r901886659",
      "id" : 901886659,
      "in_reply_to_id" : 900979687,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5841wbLD",
      "original_commit_id" : "664f7430478592fc89b7c2fdc423b7a649bc6c27",
      "original_line" : 170,
      "original_position" : 124,
      "original_start_line" : null,
      "path" : "src/wallet/coincontrol.h",
      "position" : null,
      "pull_request_review_id" : 1012589768,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/901886659/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2022-06-20T17:37:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/901886659",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> > Lastly, instead of using -1 as a magic number for the change output position, the change position is changed to be an optional with no value set indicating no desired change output position (when provided as an input parameter) or no change output present (in the result).\r\n> \r\n> I'm not sure this is an improvement. It just adds complexity, for no benefit in this particular instance?\r\n\r\nIMO it makes it easier to understand.\r\n\r\n> ```\r\n> SUMMARY: MemorySanitizer: use-of-uninitialized-value src/wallet/spend.cpp:1025:5 in wallet::CreateTransaction(wallet::CWallet&, std::__1::vector<wallet::CRecipient, std::__1::allocator<wallet::CRecipient> > const&, std::__1::optional<unsigned int>, bilingual_str&, wallet::CCoinControl const&, FeeCalculation&, bool)\r\n> ```\r\n\r\nI think I've fixed this.",
      "created_at" : "2022-06-20T17:38:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#issuecomment-1160699318",
      "id" : 1160699318,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25273",
      "node_id" : "IC_kwDOABII585FLt22",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1160699318/reactions"
      },
      "updated_at" : "2022-06-20T17:38:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1160699318",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r901991220"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/901991220"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Where is this behaviour in the current logic? I thought presently it would do the anti-sniping, and then possibly (at worst) have that partially \"broken\" by subsequent changes?",
      "commit_id" : "5a2e20bdfef12be86cccd8b8f8eba1743ade0994",
      "created_at" : "2022-06-20T20:48:02Z",
      "diff_hunk" : "@@ -832,11 +845,33 @@ static std::optional<CreatedTransactionResult> CreateTransactionInternal(\n     // to avoid conflicting with other possible uses of nSequence,\n     // and in the spirit of \"smallest possible change from prior\n     // behavior.\"\n-    const uint32_t nSequence{coin_control.m_signal_bip125_rbf.value_or(wallet.m_signal_rbf) ? MAX_BIP125_RBF_SEQUENCE : CTxIn::MAX_SEQUENCE_NONFINAL};\n+    bool use_anti_fee_sniping = true;\n+    const uint32_t default_sequence{coin_control.m_signal_bip125_rbf.value_or(wallet.m_signal_rbf) ? MAX_BIP125_RBF_SEQUENCE : CTxIn::MAX_SEQUENCE_NONFINAL};\n     for (const auto& coin : selected_coins) {\n-        txNew.vin.push_back(CTxIn(coin.outpoint, CScript(), nSequence));\n+        uint32_t sequence = default_sequence;\n+        if (coin_control.HasSequence(coin.outpoint)) {\n+            sequence = coin_control.GetSequence(coin.outpoint);\n+            // If an input as a preset sequence, we can't do anti-fee-sniping",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r901991220",
      "id" : 901991220,
      "in_reply_to_id" : 900983932,
      "line" : 1032,
      "node_id" : "PRRC_kwDOABII5841w0s0",
      "original_commit_id" : "664f7430478592fc89b7c2fdc423b7a649bc6c27",
      "original_line" : 1032,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 112,
      "pull_request_review_id" : 1012736964,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/901991220/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2022-06-20T20:48:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/901991220",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r902007567"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/902007567"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's more of a side effect of `FundTransaction` rather than explicit behavior. Currently, having preset sequences inherently means a preset locktime which would disable anti-fee-sniping. This is just due to how `FundTransaction` works, and `FundTransaction` is the only way that preset sequences can even be provided.\r\n\r\nUntil we update `DiscourageFeeSniping` to handle preset sequences and locktime, I would prefer that we have this check explicitly just to avoid any problems in the future with how and when preset sequences and locktimes can be set.",
      "commit_id" : "5a2e20bdfef12be86cccd8b8f8eba1743ade0994",
      "created_at" : "2022-06-20T21:29:39Z",
      "diff_hunk" : "@@ -832,11 +845,33 @@ static std::optional<CreatedTransactionResult> CreateTransactionInternal(\n     // to avoid conflicting with other possible uses of nSequence,\n     // and in the spirit of \"smallest possible change from prior\n     // behavior.\"\n-    const uint32_t nSequence{coin_control.m_signal_bip125_rbf.value_or(wallet.m_signal_rbf) ? MAX_BIP125_RBF_SEQUENCE : CTxIn::MAX_SEQUENCE_NONFINAL};\n+    bool use_anti_fee_sniping = true;\n+    const uint32_t default_sequence{coin_control.m_signal_bip125_rbf.value_or(wallet.m_signal_rbf) ? MAX_BIP125_RBF_SEQUENCE : CTxIn::MAX_SEQUENCE_NONFINAL};\n     for (const auto& coin : selected_coins) {\n-        txNew.vin.push_back(CTxIn(coin.outpoint, CScript(), nSequence));\n+        uint32_t sequence = default_sequence;\n+        if (coin_control.HasSequence(coin.outpoint)) {\n+            sequence = coin_control.GetSequence(coin.outpoint);\n+            // If an input as a preset sequence, we can't do anti-fee-sniping",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r902007567",
      "id" : 902007567,
      "in_reply_to_id" : 900983932,
      "line" : 1032,
      "node_id" : "PRRC_kwDOABII5841w4sP",
      "original_commit_id" : "664f7430478592fc89b7c2fdc423b7a649bc6c27",
      "original_line" : 1032,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 112,
      "pull_request_review_id" : 1012759867,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/902007567/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2022-06-20T21:29:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/902007567",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1025583116"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025583116"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 9aab806b:\r\n\r\nsounds like this could be unified and return an optional<uint32_t> so double lookups aren't needed (e.g. force callers to always call `HasSequence` first then `GetSequence`).",
      "commit_id" : "5a2e20bdfef12be86cccd8b8f8eba1743ade0994",
      "created_at" : "2022-11-17T18:57:45Z",
      "diff_hunk" : "@@ -163,6 +173,20 @@ class CCoinControl\n         return m_selected.at(outpoint).GetInputWeight();\n     }\n \n+    bool HasSequence(const COutPoint& outpoint) const\n+    {\n+        const auto it = m_selected.find(outpoint);\n+        if (it == m_selected.end()) {\n+            return false;\n+        }\n+        return it->second.HasSequence();\n+    }\n+\n+    uint32_t GetSequence(const COutPoint& outpoint) const\n+    {\n+        return m_selected.at(outpoint).GetSequence();\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1025583116",
      "id" : 1025583116,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5849ISgM",
      "original_commit_id" : "bd979e2b140e7e3d79ff007b8077ff16e8eda5d6",
      "original_line" : 206,
      "original_position" : 40,
      "original_start_line" : 176,
      "path" : "src/wallet/coincontrol.h",
      "position" : null,
      "pull_request_review_id" : 1000211304,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025583116/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-01-22T15:08:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1025583116",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1083460232"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1083460232"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 65550f8a:\r\n\r\nnit: could replace the inner if/else for\r\n```c++\r\nif (!wallet.IsMine(outPoint)) {\r\n    if (coins[outPoint].out.IsNull()) {\r\n        error = _(\"Unable to find UTXO for external input\");\r\n        return false;\r\n    }\r\n\r\n    // The input was not in the wallet, but is in the UTXO set, so select as external\r\n    preset_txin.SetTxOut(coins[outPoint].out);\r\n}\r\n```",
      "commit_id" : "5a2e20bdfef12be86cccd8b8f8eba1743ade0994",
      "created_at" : "2023-01-22T14:06:31Z",
      "diff_hunk" : "@@ -1136,15 +1136,15 @@ bool FundTransaction(CWallet& wallet, CMutableTransaction& tx, CAmount& nFeeRet,\n \n     for (const CTxIn& txin : tx.vin) {\n         const auto& outPoint = txin.prevout;\n-        if (wallet.IsMine(outPoint)) {\n-            // The input was found in the wallet, so select as internal\n-            coinControl.Select(outPoint);\n-        } else if (coins[outPoint].out.IsNull()) {\n-            error = _(\"Unable to find UTXO for external input\");\n-            return false;\n-        } else {\n-            // The input was not in the wallet, but is in the UTXO set, so select as external\n-            coinControl.SelectExternal(outPoint, coins[outPoint].out);\n+        PreselectedInput& preset_txin = coinControl.Select(outPoint);\n+        if (!wallet.IsMine(outPoint)) {\n+            if (!coins[outPoint].out.IsNull()) {\n+                // The input was not in the wallet, but is in the UTXO set, so select as external\n+                preset_txin.SetTxOut(coins[outPoint].out);\n+            } else {\n+                error = _(\"Unable to find UTXO for external input\");\n+                return false;\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1083460232",
      "id" : 1083460232,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585AlEqI",
      "original_commit_id" : "65550f8ac4a3bff8f31e5d918be83c0abfbd2457",
      "original_line" : 1250,
      "original_position" : 21,
      "original_start_line" : 1139,
      "path" : "src/wallet/spend.cpp",
      "position" : null,
      "pull_request_review_id" : 1000211304,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1083460232/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-01-22T15:08:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1083460232",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1083463841"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1083463841"
         }
      },
      "author_association" : "MEMBER",
      "body" : "what about using this information inside `FetchSelectedInputs`, in the `input_bytes` size calculation too.",
      "commit_id" : "5a2e20bdfef12be86cccd8b8f8eba1743ade0994",
      "created_at" : "2023-01-22T14:25:56Z",
      "diff_hunk" : "@@ -961,7 +961,15 @@ static util::Result<CreatedTransactionResult> CreateTransactionInternal(\n             // If an input as a preset sequence, we can't do anti-fee-sniping\n             use_anti_fee_sniping = false;\n         }\n-        txNew.vin.push_back(CTxIn(coin.outpoint, CScript(), sequence));\n+        CScript script_sig;\n+        CScriptWitness script_witness;\n+        if (coin_control.HasScripts(coin.outpoint)) {\n+            auto [ss, sw] = coin_control.GetScripts(coin.outpoint);\n+            script_sig = ss;\n+            script_witness = sw;\n+        }\n+        txNew.vin.push_back(CTxIn(coin.outpoint, script_sig, sequence));\n+        txNew.vin.back().scriptWitness = script_witness;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1083463841",
      "id" : 1083463841,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585AlFih",
      "original_commit_id" : "187f2168a700e60739c09fb81c12593cfa894fb8",
      "original_line" : 1041,
      "original_position" : 13,
      "original_start_line" : 966,
      "path" : "src/wallet/spend.cpp",
      "position" : null,
      "pull_request_review_id" : 1000211304,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1083463841/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-01-22T15:08:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1083463841",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1083468973"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1083468973"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 6fb62218:\r\n\r\nThis removal doesn't seems to be related to the changes scope (the goal of the PR is keep inputs data). Would be good to add some context for it.\r\n\r\nIn a first glance, seems that keeping the original outputs value might be useful when you want to discard the fee calculation. Basically enable SFFO on all the outputs to not create a change output, then overwrite the returned outputs amounts with the original ones (maybe you are calling `fundrawtransaction` on different wallets and want to only calculate the fee on the last call).",
      "commit_id" : "5a2e20bdfef12be86cccd8b8f8eba1743ade0994",
      "created_at" : "2023-01-22T14:52:35Z",
      "diff_hunk" : "@@ -1188,47 +1188,25 @@ bool FundTransaction(CWallet& wallet, CMutableTransaction& tx, CAmount& nFeeRet,\n                 // The input was not in the wallet, but is in the UTXO set, so select as external\n                 preset_txin.SetTxOut(coins[outPoint].out);\n             } else {\n-                error = _(\"Unable to find UTXO for external input\");\n-                return false;\n+                return util::Error{_(\"Unable to find UTXO for external input\")};\n             }\n         }\n         preset_txin.SetSequence(txin.nSequence);\n         preset_txin.SetScriptSig(txin.scriptSig);\n         preset_txin.SetScriptWitness(txin.scriptWitness);\n     }\n \n-    auto res = CreateTransaction(wallet, vecSend, nChangePosInOut == -1 ? std::nullopt : std::optional<unsigned int>((unsigned int)nChangePosInOut), coinControl, false);\n+    auto res = CreateTransaction(wallet, vecSend, change_pos, coinControl, false);\n     if (!res) {\n-        error = util::ErrorString(res);\n-        return false;\n-    }\n-    const auto& txr = *res;\n-    CTransactionRef tx_new = txr.tx;\n-    nFeeRet = txr.fee;\n-    nChangePosInOut = txr.change_pos ? *txr.change_pos : -1;\n-\n-    if (nChangePosInOut != -1) {\n-        tx.vout.insert(tx.vout.begin() + nChangePosInOut, tx_new->vout[nChangePosInOut]);\n-    }\n-\n-    // Copy output sizes from new transaction; they may have had the fee\n-    // subtracted from them.\n-    for (unsigned int idx = 0; idx < tx.vout.size(); idx++) {\n-        tx.vout[idx].nValue = tx_new->vout[idx].nValue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1083468973",
      "id" : 1083468973,
      "line" : 1234,
      "node_id" : "PRRC_kwDOABII585AlGyt",
      "original_commit_id" : "6fb622183a4d25fcdc03cbc4bcd30c77ff4ef635",
      "original_line" : 1234,
      "original_position" : 41,
      "original_start_line" : 1214,
      "path" : "src/wallet/spend.cpp",
      "position" : 281,
      "pull_request_review_id" : 1000211304,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1083468973/reactions"
      },
      "side" : "LEFT",
      "start_line" : 1231,
      "start_side" : "LEFT",
      "subject_type" : "line",
      "updated_at" : "2023-01-22T15:08:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1083468973",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> How is enforced that `SignTransaction` doesn't overwrite the provided inputs' scriptsig and witness data?. It's called after setting the data and, as far as can see, it isn't skipping not empty inputs.\r\n\r\nIt will ignore inputs that have a valid scriptSig and witness. `SignTransaction` calls `DataFromTransaction` which will perform a `VerifyScript` of the existing data. If this is successful, it will mark that input as complete (sets `SignatureData.complete`) which `ProduceSignature` checks before it does anything else.",
      "created_at" : "2023-01-23T21:23:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#issuecomment-1401000686",
      "id" : 1401000686,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25273",
      "node_id" : "IC_kwDOABII585TgZLu",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1401000686/reactions"
      },
      "updated_at" : "2023-01-23T21:23:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1401000686",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1084603200"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084603200"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think you misunderstand what the original code was doing. It isn't preserving the original values, it's replacing the original values with the values that `CreateTransaction` produces. Originally `FundTransaction` is calling `CreateTranasction` and copying specific parts of the result into the original transaction and returning that modified original. The change I've made here is to just return the result of `CreateTransaction` directly, which matches the previous behavior because the earlier commits are preserving all of the components of the transaction that `FundTranasction` was preserving.",
      "commit_id" : "5a2e20bdfef12be86cccd8b8f8eba1743ade0994",
      "created_at" : "2023-01-23T21:51:54Z",
      "diff_hunk" : "@@ -1188,47 +1188,25 @@ bool FundTransaction(CWallet& wallet, CMutableTransaction& tx, CAmount& nFeeRet,\n                 // The input was not in the wallet, but is in the UTXO set, so select as external\n                 preset_txin.SetTxOut(coins[outPoint].out);\n             } else {\n-                error = _(\"Unable to find UTXO for external input\");\n-                return false;\n+                return util::Error{_(\"Unable to find UTXO for external input\")};\n             }\n         }\n         preset_txin.SetSequence(txin.nSequence);\n         preset_txin.SetScriptSig(txin.scriptSig);\n         preset_txin.SetScriptWitness(txin.scriptWitness);\n     }\n \n-    auto res = CreateTransaction(wallet, vecSend, nChangePosInOut == -1 ? std::nullopt : std::optional<unsigned int>((unsigned int)nChangePosInOut), coinControl, false);\n+    auto res = CreateTransaction(wallet, vecSend, change_pos, coinControl, false);\n     if (!res) {\n-        error = util::ErrorString(res);\n-        return false;\n-    }\n-    const auto& txr = *res;\n-    CTransactionRef tx_new = txr.tx;\n-    nFeeRet = txr.fee;\n-    nChangePosInOut = txr.change_pos ? *txr.change_pos : -1;\n-\n-    if (nChangePosInOut != -1) {\n-        tx.vout.insert(tx.vout.begin() + nChangePosInOut, tx_new->vout[nChangePosInOut]);\n-    }\n-\n-    // Copy output sizes from new transaction; they may have had the fee\n-    // subtracted from them.\n-    for (unsigned int idx = 0; idx < tx.vout.size(); idx++) {\n-        tx.vout[idx].nValue = tx_new->vout[idx].nValue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1084603200",
      "id" : 1084603200,
      "in_reply_to_id" : 1083468973,
      "line" : 1234,
      "node_id" : "PRRC_kwDOABII585ApbtA",
      "original_commit_id" : "6fb622183a4d25fcdc03cbc4bcd30c77ff4ef635",
      "original_line" : 1234,
      "original_position" : 41,
      "original_start_line" : 1214,
      "path" : "src/wallet/spend.cpp",
      "position" : 281,
      "pull_request_review_id" : 1266411499,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084603200/reactions"
      },
      "side" : "LEFT",
      "start_line" : 1231,
      "start_side" : "LEFT",
      "subject_type" : "line",
      "updated_at" : "2023-01-23T21:51:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084603200",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1084630269"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084630269"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "5a2e20bdfef12be86cccd8b8f8eba1743ade0994",
      "created_at" : "2023-01-23T22:20:00Z",
      "diff_hunk" : "@@ -66,77 +92,85 @@ class CCoinControl\n \n     bool HasSelected() const\n     {\n-        return (setSelected.size() > 0);\n+        return (m_selected.size() > 0);\n     }\n \n     bool IsSelected(const COutPoint& output) const\n     {\n-        return (setSelected.count(output) > 0);\n+        return (m_selected.count(output) > 0);\n     }\n \n     bool IsExternalSelected(const COutPoint& output) const\n     {\n-        return (m_external_txouts.count(output) > 0);\n+        const auto it = m_selected.find(output);\n+        if (it == m_selected.end()) {\n+            return false;\n+        }\n+        return it->second.HasTxOut();\n     }\n \n     bool GetExternalOutput(const COutPoint& outpoint, CTxOut& txout) const\n     {\n-        const auto ext_it = m_external_txouts.find(outpoint);\n-        if (ext_it == m_external_txouts.end()) {\n+        const auto it = m_selected.find(outpoint);\n+        if (it == m_selected.end()) {\n             return false;\n         }\n-        txout = ext_it->second;\n+        if (!it->second.HasTxOut()) {\n+            return false;\n+        }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1084630269",
      "id" : 1084630269,
      "in_reply_to_id" : 892703667,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585ApiT9",
      "original_commit_id" : "99bd2a643d230ee2ce91b1d7a337d91386adb98a",
      "original_line" : 155,
      "original_position" : 68,
      "original_start_line" : 115,
      "path" : "src/wallet/coincontrol.h",
      "position" : null,
      "pull_request_review_id" : 1266464467,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084630269/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-01-23T22:20:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084630269",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1084630528"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084630528"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done, also for input weight and position.",
      "commit_id" : "5a2e20bdfef12be86cccd8b8f8eba1743ade0994",
      "created_at" : "2023-01-23T22:20:24Z",
      "diff_hunk" : "@@ -163,6 +173,20 @@ class CCoinControl\n         return m_selected.at(outpoint).GetInputWeight();\n     }\n \n+    bool HasSequence(const COutPoint& outpoint) const\n+    {\n+        const auto it = m_selected.find(outpoint);\n+        if (it == m_selected.end()) {\n+            return false;\n+        }\n+        return it->second.HasSequence();\n+    }\n+\n+    uint32_t GetSequence(const COutPoint& outpoint) const\n+    {\n+        return m_selected.at(outpoint).GetSequence();\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1084630528",
      "id" : 1084630528,
      "in_reply_to_id" : 1025583116,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585ApiYA",
      "original_commit_id" : "bd979e2b140e7e3d79ff007b8077ff16e8eda5d6",
      "original_line" : 206,
      "original_position" : 40,
      "original_start_line" : 176,
      "path" : "src/wallet/coincontrol.h",
      "position" : null,
      "pull_request_review_id" : 1266465174,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084630528/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-01-23T22:20:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084630528",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1084630593"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084630593"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done as suggested",
      "commit_id" : "5a2e20bdfef12be86cccd8b8f8eba1743ade0994",
      "created_at" : "2023-01-23T22:20:30Z",
      "diff_hunk" : "@@ -1136,15 +1136,15 @@ bool FundTransaction(CWallet& wallet, CMutableTransaction& tx, CAmount& nFeeRet,\n \n     for (const CTxIn& txin : tx.vin) {\n         const auto& outPoint = txin.prevout;\n-        if (wallet.IsMine(outPoint)) {\n-            // The input was found in the wallet, so select as internal\n-            coinControl.Select(outPoint);\n-        } else if (coins[outPoint].out.IsNull()) {\n-            error = _(\"Unable to find UTXO for external input\");\n-            return false;\n-        } else {\n-            // The input was not in the wallet, but is in the UTXO set, so select as external\n-            coinControl.SelectExternal(outPoint, coins[outPoint].out);\n+        PreselectedInput& preset_txin = coinControl.Select(outPoint);\n+        if (!wallet.IsMine(outPoint)) {\n+            if (!coins[outPoint].out.IsNull()) {\n+                // The input was not in the wallet, but is in the UTXO set, so select as external\n+                preset_txin.SetTxOut(coins[outPoint].out);\n+            } else {\n+                error = _(\"Unable to find UTXO for external input\");\n+                return false;\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1084630593",
      "id" : 1084630593,
      "in_reply_to_id" : 1083460232,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585ApiZB",
      "original_commit_id" : "65550f8ac4a3bff8f31e5d918be83c0abfbd2457",
      "original_line" : 1250,
      "original_position" : 21,
      "original_start_line" : 1139,
      "path" : "src/wallet/spend.cpp",
      "position" : null,
      "pull_request_review_id" : 1266465371,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084630593/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-01-23T22:20:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084630593",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1084632151"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084632151"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Right now, I don't think that's a good idea. Since we are always say that the preset inputs have scriptSigs and witnesses when they come from `FundTransaction`, any input weight calculation using them may be incorrect because those inputs are not necessarily complete or valid, so the final weight may actually differ.",
      "commit_id" : "5a2e20bdfef12be86cccd8b8f8eba1743ade0994",
      "created_at" : "2023-01-23T22:22:37Z",
      "diff_hunk" : "@@ -961,7 +961,15 @@ static util::Result<CreatedTransactionResult> CreateTransactionInternal(\n             // If an input as a preset sequence, we can't do anti-fee-sniping\n             use_anti_fee_sniping = false;\n         }\n-        txNew.vin.push_back(CTxIn(coin.outpoint, CScript(), sequence));\n+        CScript script_sig;\n+        CScriptWitness script_witness;\n+        if (coin_control.HasScripts(coin.outpoint)) {\n+            auto [ss, sw] = coin_control.GetScripts(coin.outpoint);\n+            script_sig = ss;\n+            script_witness = sw;\n+        }\n+        txNew.vin.push_back(CTxIn(coin.outpoint, script_sig, sequence));\n+        txNew.vin.back().scriptWitness = script_witness;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1084632151",
      "id" : 1084632151,
      "in_reply_to_id" : 1083463841,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585ApixX",
      "original_commit_id" : "187f2168a700e60739c09fb81c12593cfa894fb8",
      "original_line" : 1041,
      "original_position" : 13,
      "original_start_line" : 966,
      "path" : "src/wallet/spend.cpp",
      "position" : null,
      "pull_request_review_id" : 1266469541,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084632151/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-01-23T22:22:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1084632151",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1087910019"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1087910019"
         }
      },
      "author_association" : "MEMBER",
      "body" : "oops, yeah..  nvm then.",
      "commit_id" : "5a2e20bdfef12be86cccd8b8f8eba1743ade0994",
      "created_at" : "2023-01-26T14:17:51Z",
      "diff_hunk" : "@@ -1188,47 +1188,25 @@ bool FundTransaction(CWallet& wallet, CMutableTransaction& tx, CAmount& nFeeRet,\n                 // The input was not in the wallet, but is in the UTXO set, so select as external\n                 preset_txin.SetTxOut(coins[outPoint].out);\n             } else {\n-                error = _(\"Unable to find UTXO for external input\");\n-                return false;\n+                return util::Error{_(\"Unable to find UTXO for external input\")};\n             }\n         }\n         preset_txin.SetSequence(txin.nSequence);\n         preset_txin.SetScriptSig(txin.scriptSig);\n         preset_txin.SetScriptWitness(txin.scriptWitness);\n     }\n \n-    auto res = CreateTransaction(wallet, vecSend, nChangePosInOut == -1 ? std::nullopt : std::optional<unsigned int>((unsigned int)nChangePosInOut), coinControl, false);\n+    auto res = CreateTransaction(wallet, vecSend, change_pos, coinControl, false);\n     if (!res) {\n-        error = util::ErrorString(res);\n-        return false;\n-    }\n-    const auto& txr = *res;\n-    CTransactionRef tx_new = txr.tx;\n-    nFeeRet = txr.fee;\n-    nChangePosInOut = txr.change_pos ? *txr.change_pos : -1;\n-\n-    if (nChangePosInOut != -1) {\n-        tx.vout.insert(tx.vout.begin() + nChangePosInOut, tx_new->vout[nChangePosInOut]);\n-    }\n-\n-    // Copy output sizes from new transaction; they may have had the fee\n-    // subtracted from them.\n-    for (unsigned int idx = 0; idx < tx.vout.size(); idx++) {\n-        tx.vout[idx].nValue = tx_new->vout[idx].nValue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1087910019",
      "id" : 1087910019,
      "in_reply_to_id" : 1083468973,
      "line" : 1234,
      "node_id" : "PRRC_kwDOABII585A2DCD",
      "original_commit_id" : "6fb622183a4d25fcdc03cbc4bcd30c77ff4ef635",
      "original_line" : 1234,
      "original_position" : 41,
      "original_start_line" : 1214,
      "path" : "src/wallet/spend.cpp",
      "position" : 281,
      "pull_request_review_id" : 1271131964,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1087910019/reactions"
      },
      "side" : "LEFT",
      "start_line" : 1231,
      "start_side" : "LEFT",
      "subject_type" : "line",
      "updated_at" : "2023-01-26T14:17:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1087910019",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1146013592"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1146013592"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Making sure i got this one right. `use_anti_fee_sniping` may only be `false` if this is called from `FundTransaction`. And `FundTransaction` diregards the value of the `nLockTime` that may be set here anyways. (Well not anymore in the following commits, but at this stage in the commit series it does.)",
      "commit_id" : "5a2e20bdfef12be86cccd8b8f8eba1743ade0994",
      "created_at" : "2023-03-23T11:00:17Z",
      "diff_hunk" : "@@ -832,11 +845,33 @@ static std::optional<CreatedTransactionResult> CreateTransactionInternal(\n     // to avoid conflicting with other possible uses of nSequence,\n     // and in the spirit of \"smallest possible change from prior\n     // behavior.\"\n-    const uint32_t nSequence{coin_control.m_signal_bip125_rbf.value_or(wallet.m_signal_rbf) ? MAX_BIP125_RBF_SEQUENCE : CTxIn::MAX_SEQUENCE_NONFINAL};\n+    bool use_anti_fee_sniping = true;\n+    const uint32_t default_sequence{coin_control.m_signal_bip125_rbf.value_or(wallet.m_signal_rbf) ? MAX_BIP125_RBF_SEQUENCE : CTxIn::MAX_SEQUENCE_NONFINAL};\n     for (const auto& coin : selected_coins) {\n-        txNew.vin.push_back(CTxIn(coin.outpoint, CScript(), nSequence));\n+        uint32_t sequence = default_sequence;\n+        if (coin_control.HasSequence(coin.outpoint)) {\n+            sequence = coin_control.GetSequence(coin.outpoint);\n+            // If an input as a preset sequence, we can't do anti-fee-sniping",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1146013592",
      "id" : 1146013592,
      "in_reply_to_id" : 900983932,
      "line" : 1032,
      "node_id" : "PRRC_kwDOABII585ETseY",
      "original_commit_id" : "664f7430478592fc89b7c2fdc423b7a649bc6c27",
      "original_line" : 1032,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 112,
      "pull_request_review_id" : 1354216199,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1146013592/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-23T11:34:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1146013592",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1146387794"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1146387794"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, `FundTransaction` currently throws away `nLockTime` thereby disabling anti-fee-sniping, and this preserves that behavior.",
      "commit_id" : "5a2e20bdfef12be86cccd8b8f8eba1743ade0994",
      "created_at" : "2023-03-23T15:36:45Z",
      "diff_hunk" : "@@ -832,11 +845,33 @@ static std::optional<CreatedTransactionResult> CreateTransactionInternal(\n     // to avoid conflicting with other possible uses of nSequence,\n     // and in the spirit of \"smallest possible change from prior\n     // behavior.\"\n-    const uint32_t nSequence{coin_control.m_signal_bip125_rbf.value_or(wallet.m_signal_rbf) ? MAX_BIP125_RBF_SEQUENCE : CTxIn::MAX_SEQUENCE_NONFINAL};\n+    bool use_anti_fee_sniping = true;\n+    const uint32_t default_sequence{coin_control.m_signal_bip125_rbf.value_or(wallet.m_signal_rbf) ? MAX_BIP125_RBF_SEQUENCE : CTxIn::MAX_SEQUENCE_NONFINAL};\n     for (const auto& coin : selected_coins) {\n-        txNew.vin.push_back(CTxIn(coin.outpoint, CScript(), nSequence));\n+        uint32_t sequence = default_sequence;\n+        if (coin_control.HasSequence(coin.outpoint)) {\n+            sequence = coin_control.GetSequence(coin.outpoint);\n+            // If an input as a preset sequence, we can't do anti-fee-sniping",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1146387794",
      "id" : 1146387794,
      "in_reply_to_id" : 900983932,
      "line" : 1032,
      "node_id" : "PRRC_kwDOABII585EVH1S",
      "original_commit_id" : "664f7430478592fc89b7c2fdc423b7a649bc6c27",
      "original_line" : 1032,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 112,
      "pull_request_review_id" : 1354916353,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1146387794/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-23T15:36:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1146387794",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1181279440"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1181279440"
         }
      },
      "author_association" : "MEMBER",
      "body" : "tiny nit:\r\njust because I'm using this in another PR:\r\n```c++\r\nchange_pos == -1 ? std::nullopt : std::make_optional(change_pos)\r\n```",
      "commit_id" : "5a2e20bdfef12be86cccd8b8f8eba1743ade0994",
      "created_at" : "2023-04-30T19:07:22Z",
      "diff_hunk" : "@@ -258,12 +258,12 @@ class WalletImpl : public Wallet\n         CAmount& fee) override\n     {\n         LOCK(m_wallet->cs_wallet);\n-        auto res = CreateTransaction(*m_wallet, recipients, change_pos,\n+        auto res = CreateTransaction(*m_wallet, recipients, change_pos == -1 ? std::nullopt : std::optional<unsigned int>((unsigned int)change_pos),",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1181279440",
      "id" : 1181279440,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585GaOTQ",
      "original_commit_id" : "c158ad118a5e38a042e7a9fb04c8171c68df0f0d",
      "original_line" : 261,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/interfaces.cpp",
      "position" : null,
      "pull_request_review_id" : 1407167119,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1181279440/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-03T19:56:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1181279440",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1183946012"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1183946012"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(in commit bf275f358a5e816cf9a8ab6e7dbd39f6dcdf80d7) nit: this could just be a one-liner using [std::optional<T>::value_or](https://en.cppreference.com/w/cpp/utility/optional/value_or)\r\n```suggestion\r\n        return {m_script_sig.value_or(CScript{}), m_script_witness.value_or(CScriptWitness{})};\r\n```",
      "commit_id" : "5a2e20bdfef12be86cccd8b8f8eba1743ade0994",
      "created_at" : "2023-05-03T16:42:18Z",
      "diff_hunk" : "@@ -55,6 +59,22 @@ class PreselectedInput\n     {\n         return m_sequence;\n     }\n+\n+    void SetScriptSig(const CScript& script) { m_script_sig = script; }\n+    void SetScriptWitness(const CScriptWitness& script_wit) { m_script_witness = script_wit; }\n+    bool HasScripts() const { return m_script_sig.has_value() || m_script_witness.has_value(); }\n+    std::pair<CScript, CScriptWitness> GetScripts() const\n+    {\n+        CScript script_sig;\n+        if (m_script_sig.has_value()) {\n+            script_sig = m_script_sig.value();\n+        }\n+        CScriptWitness script_witness;\n+        if (m_script_witness.has_value()) {\n+            script_witness = m_script_witness.value();\n+        }\n+        return {script_sig, script_witness};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1183946012",
      "id" : 1183946012,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585GkZUc",
      "original_commit_id" : "bf275f358a5e816cf9a8ab6e7dbd39f6dcdf80d7",
      "original_line" : 76,
      "original_position" : 29,
      "original_start_line" : 68,
      "path" : "src/wallet/coincontrol.h",
      "position" : null,
      "pull_request_review_id" : 1411318920,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1183946012/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-05-03T17:00:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1183946012",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1183964527"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1183964527"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(in commit bf275f358a5e816cf9a8ab6e7dbd39f6dcdf80d7): nit: could avoid introducing temporary variables by directly assigning to script_sig/script_witness using std::tie\r\n```suggestion\r\n            std::tie(script_sig, script_witness) = coin_control.GetScripts(coin->outpoint);\r\n```",
      "commit_id" : "5a2e20bdfef12be86cccd8b8f8eba1743ade0994",
      "created_at" : "2023-05-03T16:57:43Z",
      "diff_hunk" : "@@ -982,7 +982,15 @@ static util::Result<CreatedTransactionResult> CreateTransactionInternal(\n             // If an input as a preset sequence, we can't do anti-fee-sniping\n             use_anti_fee_sniping = false;\n         }\n-        txNew.vin.push_back(CTxIn(coin->outpoint, CScript(), sequence.value_or(default_sequence)));\n+        CScript script_sig;\n+        CScriptWitness script_witness;\n+        if (coin_control.HasScripts(coin->outpoint)) {\n+            auto [ss, sw] = coin_control.GetScripts(coin->outpoint);\n+            script_sig = ss;\n+            script_witness = sw;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25273#discussion_r1183964527",
      "id" : 1183964527,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Gkd1v",
      "original_commit_id" : "bf275f358a5e816cf9a8ab6e7dbd39f6dcdf80d7",
      "original_line" : 990,
      "original_position" : 10,
      "original_start_line" : 988,
      "path" : "src/wallet/spend.cpp",
      "position" : null,
      "pull_request_review_id" : 1411318920,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25273",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1183964527/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-05-03T17:00:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1183964527",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   }
]
