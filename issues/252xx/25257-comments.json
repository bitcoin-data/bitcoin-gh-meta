[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25257#discussion_r886015373"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25257"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/886015373"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Working on the logging in this file right now and saw similar messages; this might be clearer\r\n```suggestion\r\n        LogPrintLevel(BCLog::NET, BCLog::Level::Warning, \"not disconnecting misbehaving peer %d because it has noban permission\\n\", peer.GetId());\r\n```\r\n",
      "commit_id" : "faead9a2c3b1ac26d17c8ceb9339b6918c09c2d3",
      "created_at" : "2022-05-31T18:42:26Z",
      "diff_hunk" : "@@ -1441,6 +1443,25 @@ void PeerManagerImpl::AddToCompactExtraTransactions(const CTransactionRef& tx)\n     vExtraTxnForCompactIt = (vExtraTxnForCompactIt + 1) % max_extra_txn;\n }\n \n+void PeerManagerImpl::MaybeDisconnect(CNode& peer, std::string_view message)\n+{\n+    if (peer.HasPermission(NetPermissionFlags::NoBan)) {\n+        LogPrintLevel(BCLog::NET, BCLog::Level::Warning, \"Not disconnecting noban peer %d!\\n\", peer.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25257#discussion_r886015373",
      "id" : 886015373,
      "line" : 1449,
      "node_id" : "PRRC_kwDOABII5840z4WN",
      "original_commit_id" : "faead9a2c3b1ac26d17c8ceb9339b6918c09c2d3",
      "original_line" : 1449,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 16,
      "pull_request_review_id" : 990984172,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25257",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/886015373/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-31T18:42:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/886015373",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "My primary issue with Misbehaving is actually neither of the things you bring up, but the fact that the scoring mechanism is arbitrary, and just introduces confusion. We should aim to have a protocol where all behavior is either OK or not OK, without hard-to-reason about levels in between. So I'm much more interested in seeing the scoring mechanism disappear than not using misbehaving/discouraging at all.\r\n\r\nRegarding the arguments you bring up:\r\n* It's a fair point that IP addresses are cheap, but that doesn't mean per-IP discouragement is useless. At the very least, it helps in avoiding connections to non-malicious but broken peers.\r\n* If we're concerned about malicious behavior, the possibility exists for a netgroup-level discouragement too. We already rely on certain (weakish) assumptions around attackers being unable to control many netgroups (as it's the basis for some of the eclipse attack protection in addrman) - so I think we could extend discouragement to this level too. It'd need to be weaker in effect than the per-IP discouragement in order to prevent a malicious peer from partitioning off the entire network it's in, but I do feel that it's not unreasonable to start deprioritizing connections to/from a netgroup if it turns out to host many misbehaving peers.\r\n* I don't see what the problem is with punishing all peers with a certain IP when one of them misbehaves. We should be able to assume they're controlled by the same entity?\r\n* No objection to dropping the exception to not disconnect manual connections and instead just rely on the NOBAN permission - but I'm unsure how much effect it'll have. At least if we're talking about non-oneshot addnode peers, the connection logic will try to reestablish the connection anyway.\r\n",
      "created_at" : "2022-05-31T21:26:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25257#issuecomment-1142654977",
      "id" : 1142654977,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25257",
      "node_id" : "IC_kwDOABII585EG4gB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1142654977/reactions"
      },
      "updated_at" : "2022-05-31T21:26:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1142654977",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the extended reply.\r\n\r\n> I don't see what the problem is with punishing all peers with a certain IP when one of them misbehaves. We should be able to assume they're controlled by the same entity?\r\n\r\nIt is probably more of an edge case, but I imagined a group sharing the same IP (for example a family with several connected devices). Though, I can also see how they can be seen as one entity.\r\n\r\n> No objection to dropping the exception to not disconnect manual connections and instead just rely on the NOBAN permission - but I'm unsure how much effect it'll have. At least if we're talking about non-oneshot addnode peers, the connection logic will try to reestablish the connection anyway.\r\n\r\nI had the same thought, so I was about to add it back to make the changes smaller. Though, given that discouragement isn't useless, it may be best to close this patch and instead focus on removing the misbehaviour score.",
      "created_at" : "2022-06-01T06:55:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25257#issuecomment-1143187516",
      "id" : 1143187516,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25257",
      "node_id" : "IC_kwDOABII585EI6g8",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1143187516/reactions"
      },
      "updated_at" : "2022-06-01T06:55:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1143187516",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">I don't see what the problem is with punishing all peers with a certain IP when one of them misbehaves. We should be able to assume they're controlled by the same entity?\r\n\r\nCGNAT is also a thing, and becoming more and more common :/",
      "created_at" : "2022-06-18T01:22:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25257#issuecomment-1159331045",
      "id" : 1159331045,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25257",
      "node_id" : "IC_kwDOABII585FGfzl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1159331045/reactions"
      },
      "updated_at" : "2022-06-18T01:22:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1159331045",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   }
]
