{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "NONE",
   "body" : "It seems to me, that GetDifficulty() function have truncation problem which is already observer now and could lead to further problems, up to division by zero.\n\n1) http://blockexplorer.com/b/124677 -> Difficulty?: 157 416.401843 (\"Bits\"?: 1a6a93b3)\n2) bitcoin.exe getdifficulty -> 157426.20628986 (at the moment)\nWhy so?\n\nhextarget = 0000 0000 0000 6A93 B300 00000000000000000000000000000000000000000000\nmaxtarget = 0000 0000 FFFF 0000 0000 00000000000000000000000000000000000000000000\nIf we divide them, result will be 157416.4018436490, value in block's info.\n\nProblem is in getdifficulty function:\n    int nShift = 256 - 32 - 31; // to fit in a uint\n    double dMinimum = (CBigNum().SetCompact(bnProofOfWorkLimit.GetCompact()) >> nShift).getuint();\n    double dCurrently = (CBigNum().SetCompact(pindexBest->nBits) >> nShift).getuint();\n    return dMinimum / dCurrently;\n\nSo, bnProofOfWorkLimit >> nShift = 0x7FFF8000\nwhile nBits >> nShift = 0x3549\nreturn will be 157426.20628986100 that we observe in bitcoin client, on blockexplorer's getdifficulty and so on.\n\nFrom 24 \"mantissa\" bits of hextarget only 15 are used, and problem will increase with difficulty. At 2 billions will will get divison by zero.\n",
   "closed_at" : "2011-06-07T18:33:59Z",
   "closed_by" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/331997?v=4",
      "events_url" : "https://api.github.com/users/gavinandresen/events{/privacy}",
      "followers_url" : "https://api.github.com/users/gavinandresen/followers",
      "following_url" : "https://api.github.com/users/gavinandresen/following{/other_user}",
      "gists_url" : "https://api.github.com/users/gavinandresen/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/gavinandresen",
      "id" : 331997,
      "login" : "gavinandresen",
      "node_id" : "MDQ6VXNlcjMzMTk5Nw==",
      "organizations_url" : "https://api.github.com/users/gavinandresen/orgs",
      "received_events_url" : "https://api.github.com/users/gavinandresen/received_events",
      "repos_url" : "https://api.github.com/users/gavinandresen/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/gavinandresen/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/gavinandresen"
   },
   "comments" : 1,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/236/comments",
   "created_at" : "2011-05-18T17:26:36Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/236/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/236",
   "id" : 922899,
   "labels" : [
      {
         "color" : "FBBAAB",
         "default" : false,
         "id" : 64585,
         "name" : "Bug",
         "node_id" : "MDU6TGFiZWw2NDU4NQ==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/236/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWU5MjI4OTk=",
   "number" : 236,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "Truncation bug in GetDifficulty, rpc.cpp",
   "updated_at" : "2011-06-07T18:33:59Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/236",
   "user" : {
      "avatar_url" : "https://avatars3.githubusercontent.com/u/796297?v=4",
      "events_url" : "https://api.github.com/users/OverQuantum/events{/privacy}",
      "followers_url" : "https://api.github.com/users/OverQuantum/followers",
      "following_url" : "https://api.github.com/users/OverQuantum/following{/other_user}",
      "gists_url" : "https://api.github.com/users/OverQuantum/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/OverQuantum",
      "id" : 796297,
      "login" : "OverQuantum",
      "node_id" : "MDQ6VXNlcjc5NjI5Nw==",
      "organizations_url" : "https://api.github.com/users/OverQuantum/orgs",
      "received_events_url" : "https://api.github.com/users/OverQuantum/received_events",
      "repos_url" : "https://api.github.com/users/OverQuantum/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/OverQuantum/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/OverQuantum/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/OverQuantum"
   }
}
