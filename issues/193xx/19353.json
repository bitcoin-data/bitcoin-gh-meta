{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "In master (8ef15e8a86038225afef2487ca23abc10ca5dffa) the \"previous\" and \"current\" lock orders are mistakenly swapped.\r\n\r\nThis PR:\r\n- fixes printed lock orders\r\n- improves the `sync_tests` unit test\r\n- makes the \"detected inconsistent lock order\" error message pointing to the lock location rather `tfm::format()` location.\r\n\r\nDebugger output example with this PR (with modified code, of course):\r\n```\r\n2020-06-22T15:46:56Z [msghand] POTENTIAL DEADLOCK DETECTED\r\n2020-06-22T15:46:56Z [msghand] Previous lock order was:\r\n2020-06-22T15:46:56Z [msghand]  (2) 'cs_main' in net_processing.cpp:2545 (in thread 'msghand')\r\n2020-06-22T15:46:56Z [msghand]  (1) 'g_cs_orphans' in net_processing.cpp:1400 (in thread 'msghand')\r\n2020-06-22T15:46:56Z [msghand] Current lock order is:\r\n2020-06-22T15:46:56Z [msghand]  (1) 'g_cs_orphans' in net_processing.cpp:2816 (in thread 'msghand')\r\n2020-06-22T15:46:56Z [msghand]  (2) 'cs_main' in net_processing.cpp:2816 (in thread 'msghand')\r\nAssertion failed: detected inconsistent lock order for 'cs_main' in net_processing.cpp:2816 (in thread 'msghand'), details in debug log.\r\nProcess 131393 stopped\r\n* thread #15, name = 'b-msghand', stop reason = signal SIGABRT\r\n    frame #0: 0x00007ffff775c18b libc.so.6`__GI_raise(sig=2) at raise.c:51:1\r\n(lldb) bt\r\n* thread #15, name = 'b-msghand', stop reason = signal SIGABRT\r\n  * frame #0: 0x00007ffff775c18b libc.so.6`__GI_raise(sig=2) at raise.c:51:1\r\n    frame #1: 0x00007ffff773b859 libc.so.6`__GI_abort at abort.c:79:7\r\n    frame #2: 0x0000555555e5b196 bitcoind`(anonymous namespace)::potential_deadlock_detected(mismatch=0x00007fff99ff6f30, s1=size=2, s2=size=2, lock_location=0x00007fff99ff7010) at sync.cpp:134:9\r\n    frame #3: 0x0000555555e5a1b1 bitcoind`(anonymous namespace)::push_lock(c=0x0000555556379220, locklocation=0x00007fff99ff7010) at sync.cpp:158:13\r\n    frame #4: 0x0000555555e59e8a bitcoind`EnterCritical(pszName=\"cs_main\", pszFile=\"net_processing.cpp\", nLine=2816, cs=0x0000555556379220, fTry=false) at sync.cpp:177:5\r\n    frame #5: 0x00005555555b0500 bitcoind`UniqueLock<AnnotatedMixin<std::recursive_mutex>, std::unique_lock<std::recursive_mutex> >::Enter(this=0x00007fff99ff8c20, pszName=\"cs_main\", pszFile=\"net_processing.cpp\", nLine=2816) at sync.h:134:9\r\n    frame #6: 0x00005555555b017f bitcoind`UniqueLock<AnnotatedMixin<std::recursive_mutex>, std::unique_lock<std::recursive_mutex> >::UniqueLock(this=0x00007fff99ff8c20, mutexIn=0x0000555556379220, pszName=\"cs_main\", pszFile=\"net_processing.cpp\", nLine=2816, fTry=false) at sync.h:160:13\r\n    frame #7: 0x00005555556aa57e bitcoind`ProcessMessage(pfrom=0x00007fff90001180, msg_type=error: summary string parsing error, vRecv=0x00007fff9c005ac0, nTimeReceived=1592840815980751, chainparams=0x00005555564b7110, chainman=0x0000555556380880, mempool=0x0000555556380ae0, connman=0x000055555657aa20, banman=0x00005555565167b0, interruptMsgProc=0x00005555565cae90) at net_processing.cpp:2816:9\r\n```",
   "closed_at" : "2020-07-15T18:54:29Z",
   "closed_by" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   },
   "comments" : 7,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19353/comments",
   "created_at" : "2020-06-22T15:55:20Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19353/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/19353",
   "id" : 643186871,
   "labels" : [
      {
         "color" : "d4c5f9",
         "default" : false,
         "description" : null,
         "id" : 62963516,
         "name" : "Tests",
         "node_id" : "MDU6TGFiZWw2Mjk2MzUxNg==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Tests"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19353/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDExOlB1bGxSZXF1ZXN0NDM4MDM0Nzk1",
   "number" : 19353,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/19353.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19353",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/19353.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19353"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "Fix mistakenly swapped \"previous\" and \"current\" lock orders",
   "updated_at" : "2020-07-15T18:54:29Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19353",
   "user" : {
      "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
      "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
      "followers_url" : "https://api.github.com/users/hebasto/followers",
      "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/hebasto",
      "id" : 32963518,
      "login" : "hebasto",
      "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
      "organizations_url" : "https://api.github.com/users/hebasto/orgs",
      "received_events_url" : "https://api.github.com/users/hebasto/received_events",
      "repos_url" : "https://api.github.com/users/hebasto/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/hebasto"
   }
}
