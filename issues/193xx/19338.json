{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "NONE",
   "body" : "It seems like issuing `listsinceblock` rpc calls while bitcoind is processing blocks can result in `lastblock` and `confirmations` values that disagree with each-other -- the number of confirmations is not relative to the `lastblock`.\r\n\r\nI'm able to reliably reproduce this by issuing `listsinceblock` calls from a `blocknotify` handler. Here's a reproduction script:\r\n\r\n```bash\r\n#!/bin/bash\r\nshopt -s expand_aliases\r\ntrap 'bcli stop' SIGINT SIGTERM EXIT\r\n\r\nDIR=/tmp/test-bitcoin\r\nrm -rf $DIR && mkdir $DIR\r\n\r\nbopt=\"-regtest -datadir=$DIR -rpcport=8763\"\r\nalias bcli=\"bitcoin-cli $bopt\"\r\nalias miner=\"bcli -rpcwallet=miner\"\r\nalias wallet=\"bcli -rpcwallet=wallet\"\r\n\r\n# Mine some coins without triggering `blocknotify` \r\nbitcoind $bopt -nolisten -daemon -wallet=miner\r\nminer generatetoaddress 101 `miner -rpcwait getnewaddress` > /dev/null\r\nbcli stop && sleep 1\r\n\r\n# Now start with `blocknotify` and create a separate wallet to avoid cluttering `listsinceblock` with mining-related txs\r\nbitcoind $bopt -nolisten -daemon -wallet=miner -fallbackfee=0.00001 \\\r\n    -blocknotify=\"bitcoin-cli $bopt -rpcwallet=wallet listsinceblock | tee -a $DIR/notify.log\"\r\nbcli -rpcwait createwallet wallet\r\n\r\nminer sendtoaddress `wallet getnewaddress` 1\r\nminer generatetoaddress 20 `miner getnewaddress`\r\n\r\ncat $DIR/notify.log | jq -c '{lastblock: .lastblock, tx: (.transactions[] | [.txid,.confirmations,.blockheight])}'\r\n```\r\n\r\nThis is the output of the `jq` command on the last line of the script, with Bitcoin Core 0.20.0:\r\n\r\n```\r\n{\"lastblock\":\"3d37a7b824a9250a87e78be88c1c58dcad737d4c43ddb1a1c6dea46e9a56b5ff\",\"tx\":[\"58cf095ffcd93ab838b6382435f1c9b7b8ea4daac8128c93a8b2d67b60715d16\",4,102]}\r\n{\"lastblock\":\"7092dd077f8e6306ac649e7ebbb24d2b7840702b8a509a225912d7192bf8f3ae\",\"tx\":[\"58cf095ffcd93ab838b6382435f1c9b7b8ea4daac8128c93a8b2d67b60715d16\",8,102]}\r\n{\"lastblock\":\"7092dd077f8e6306ac649e7ebbb24d2b7840702b8a509a225912d7192bf8f3ae\",\"tx\":[\"58cf095ffcd93ab838b6382435f1c9b7b8ea4daac8128c93a8b2d67b60715d16\",8,102]}\r\n{\"lastblock\":\"2f1370f3efd68cad09131a3aa4d763c79e37c7253175db2e136089bfd24387ea\",\"tx\":[\"58cf095ffcd93ab838b6382435f1c9b7b8ea4daac8128c93a8b2d67b60715d16\",9,102]}\r\n{\"lastblock\":\"2f1370f3efd68cad09131a3aa4d763c79e37c7253175db2e136089bfd24387ea\",\"tx\":[\"58cf095ffcd93ab838b6382435f1c9b7b8ea4daac8128c93a8b2d67b60715d16\",12,102]}\r\n{\"lastblock\":\"2f1370f3efd68cad09131a3aa4d763c79e37c7253175db2e136089bfd24387ea\",\"tx\":[\"58cf095ffcd93ab838b6382435f1c9b7b8ea4daac8128c93a8b2d67b60715d16\",12,102]}\r\n{\"lastblock\":\"4c2ccc8d0efda2d73a00a661f8fd7820bf60c59d8022894e63efb1d4f170c578\",\"tx\":[\"58cf095ffcd93ab838b6382435f1c9b7b8ea4daac8128c93a8b2d67b60715d16\",13,102]}\r\n{\"lastblock\":\"4c2ccc8d0efda2d73a00a661f8fd7820bf60c59d8022894e63efb1d4f170c578\",\"tx\":[\"58cf095ffcd93ab838b6382435f1c9b7b8ea4daac8128c93a8b2d67b60715d16\",14,102]}\r\n{\"lastblock\":\"4c2ccc8d0efda2d73a00a661f8fd7820bf60c59d8022894e63efb1d4f170c578\",\"tx\":[\"58cf095ffcd93ab838b6382435f1c9b7b8ea4daac8128c93a8b2d67b60715d16\",15,102]}\r\n{\"lastblock\":\"4c2ccc8d0efda2d73a00a661f8fd7820bf60c59d8022894e63efb1d4f170c578\",\"tx\":[\"58cf095ffcd93ab838b6382435f1c9b7b8ea4daac8128c93a8b2d67b60715d16\",15,102]}\r\n{\"lastblock\":\"4c2ccc8d0efda2d73a00a661f8fd7820bf60c59d8022894e63efb1d4f170c578\",\"tx\":[\"58cf095ffcd93ab838b6382435f1c9b7b8ea4daac8128c93a8b2d67b60715d16\",15,102]}\r\n{\"lastblock\":\"4c2ccc8d0efda2d73a00a661f8fd7820bf60c59d8022894e63efb1d4f170c578\",\"tx\":[\"58cf095ffcd93ab838b6382435f1c9b7b8ea4daac8128c93a8b2d67b60715d16\",15,102]}\r\n{\"lastblock\":\"635449428c88781cc80747a77b9c59d9f46263e6f606c8306b021116d32a8320\",\"tx\":[\"58cf095ffcd93ab838b6382435f1c9b7b8ea4daac8128c93a8b2d67b60715d16\",16,102]}\r\n{\"lastblock\":\"412240b03e197502b228b95396d3d8386499ed5acf2a0ac30d08b34e798b7bf0\",\"tx\":[\"58cf095ffcd93ab838b6382435f1c9b7b8ea4daac8128c93a8b2d67b60715d16\",18,102]}\r\n{\"lastblock\":\"54ea16118338039c672229f3834db8917cfc5b25b870c7db7d800587ea117895\",\"tx\":[\"58cf095ffcd93ab838b6382435f1c9b7b8ea4daac8128c93a8b2d67b60715d16\",19,102]}\r\n{\"lastblock\":\"54ea16118338039c672229f3834db8917cfc5b25b870c7db7d800587ea117895\",\"tx\":[\"58cf095ffcd93ab838b6382435f1c9b7b8ea4daac8128c93a8b2d67b60715d16\",19,102]}\r\n{\"lastblock\":\"181e7bbcee44402a67f171404611a3885238338555ab58039b1330249662f87f\",\"tx\":[\"58cf095ffcd93ab838b6382435f1c9b7b8ea4daac8128c93a8b2d67b60715d16\",20,102]}\r\n```\r\n\r\nNotice how `lastblock` is reported as `4c2ccc8d..` with 13 confirmations for tx `58cf095f...`, then later with 14 confirmations for the same block and tx, then later with 15.\r\n\r\nYou may need to generate more than 20 blocks if you're not able to catch this. For the tests I ran, it seems like 20 (or even 10) was sufficient.",
   "closed_at" : "2020-06-29T14:49:46Z",
   "closed_by" : {
      "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
      "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
      "followers_url" : "https://api.github.com/users/ryanofsky/followers",
      "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/ryanofsky",
      "id" : 7133040,
      "login" : "ryanofsky",
      "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
      "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
      "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
      "repos_url" : "https://api.github.com/users/ryanofsky/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/ryanofsky"
   },
   "comments" : 6,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19338/comments",
   "created_at" : "2020-06-20T16:45:14Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19338/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/19338",
   "id" : 642408350,
   "labels" : [
      {
         "color" : "FBBAAB",
         "default" : false,
         "description" : null,
         "id" : 64585,
         "name" : "Bug",
         "node_id" : "MDU6TGFiZWw2NDU4NQ==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19338/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWU2NDI0MDgzNTA=",
   "number" : 19338,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "Inconsistency in `listsinceblock` between `lastblock` and `confirmations`",
   "updated_at" : "2020-06-29T14:49:46Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19338",
   "user" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/877904?v=4",
      "events_url" : "https://api.github.com/users/shesek/events{/privacy}",
      "followers_url" : "https://api.github.com/users/shesek/followers",
      "following_url" : "https://api.github.com/users/shesek/following{/other_user}",
      "gists_url" : "https://api.github.com/users/shesek/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/shesek",
      "id" : 877904,
      "login" : "shesek",
      "node_id" : "MDQ6VXNlcjg3NzkwNA==",
      "organizations_url" : "https://api.github.com/users/shesek/orgs",
      "received_events_url" : "https://api.github.com/users/shesek/received_events",
      "repos_url" : "https://api.github.com/users/shesek/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/shesek/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/shesek/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/shesek"
   }
}
