[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19102 (wallet: Introduce and use DummyDatabase instead of dummy BerkeleyDatabase by achow101)\n* #18904 (Don't call lsn_reset in periodic flush by bvbfan)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-06-20T03:33:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19335#issuecomment-646931777",
      "id" : 646931777,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19335",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NjkzMTc3Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-23T07:36:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/646931777",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-07-01T14:24:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19335#issuecomment-652450310",
      "id" : 652450310,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19335",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MjQ1MDMxMA==",
      "updated_at" : "2020-07-01T14:24:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/652450310",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-07-05T22:38:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19335#issuecomment-653947713",
      "id" : 653947713,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19335",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1Mzk0NzcxMw==",
      "updated_at" : "2020-07-05T22:38:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/653947713",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-07-08T23:41:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19335#issuecomment-655812983",
      "id" : 655812983,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19335",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1NTgxMjk4Mw==",
      "updated_at" : "2020-07-08T23:41:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/655812983",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-07-11T12:44:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19335#issuecomment-657057648",
      "id" : 657057648,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19335",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1NzA1NzY0OA==",
      "updated_at" : "2020-07-11T12:44:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/657057648",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455415631"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/455415631"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"walletdb: track database file use as m_refcount within BerkeleyDatabase\" (61da2fa6a159b0d318978cb8713f83705bb97035)\r\n\r\nNotes for reviewers: Assert here is moving to `BerkeleyDatabase::Verify` below. The reason the assert is currently true is because of the `IsWalletLoaded` check and `cs_wallets` lock in wallets.cpp. The lock is just being dropped and not moving, but should not be needed because `m_refcount` is `std::atomic`\r\n\r\nSuggestion: `BerkeleyEnvironment::Verify `is only called one place in `BerkeleyDatabase::Verify`. Would suggest just removing and inlining the whole method instead of only moving the assert",
      "commit_id" : "74507ce71eb61105fb3ae8460999099234ca7b8b",
      "created_at" : "2020-07-15T23:08:36Z",
      "diff_hunk" : "@@ -245,9 +244,6 @@ BerkeleyEnvironment::BerkeleyEnvironment()\n \n bool BerkeleyEnvironment::Verify(const std::string& strFile)\n {\n-    LOCK(cs_db);\n-    assert(mapFileUseCount.count(strFile) == 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455415631",
      "id" : 455415631,
      "line" : 238,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQxNTYzMQ==",
      "original_commit_id" : "61da2fa6a159b0d318978cb8713f83705bb97035",
      "original_line" : 238,
      "original_position" : 16,
      "original_start_line" : 248,
      "path" : "src/wallet/bdb.cpp",
      "position" : 33,
      "pull_request_review_id" : 449402796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19335",
      "side" : "LEFT",
      "start_line" : 237,
      "start_side" : "LEFT",
      "updated_at" : "2020-07-23T03:36:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/455415631",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455422879"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/455422879"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"walletdb: track database file use as m_refcount within BerkeleyDatabase\" (61da2fa6a159b0d318978cb8713f83705bb97035)\r\n\r\nIt looks like there's a minor change behavior here could lead to extra logging and checkpoint and lsn reset calls. Previously this only iterated over unflushed databases, now it iterates over all databases even if they were already flushed.\r\n\r\nWould be good to either mention behavior change in commit message or possibly add line like `if (db_it.second.get().m_db)) continue;` to restore previous behavior.\r\n\r\nChange happens because previously 0 use count meant database was not in use but not yet flushed, and no use count meant database was actually flushed. (See previous note https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432708264)",
      "commit_id" : "74507ce71eb61105fb3ae8460999099234ca7b8b",
      "created_at" : "2020-07-15T23:30:51Z",
      "diff_hunk" : "@@ -591,10 +588,10 @@ void BerkeleyEnvironment::Flush(bool fShutdown)\n         return;\n     {\n         LOCK(cs_db);\n-        std::map<std::string, int>::iterator mi = mapFileUseCount.begin();\n-        while (mi != mapFileUseCount.end()) {\n-            std::string strFile = (*mi).first;\n-            int nRefCount = (*mi).second;\n+        bool no_dbs_accessed = true;\n+        for (auto& db_it : m_databases) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455422879",
      "id" : 455422879,
      "line" : 570,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQyMjg3OQ==",
      "original_commit_id" : "61da2fa6a159b0d318978cb8713f83705bb97035",
      "original_line" : 570,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.cpp",
      "position" : 232,
      "pull_request_review_id" : 449402796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19335",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-23T03:36:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/455422879",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455427236"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/455427236"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"walletdb: track database file use as m_refcount within BerkeleyDatabase\" (61da2fa6a159b0d318978cb8713f83705bb97035)\r\n\r\nThis looks like a bug that causes flushes to no longer happen when needed. Previous code checked if there were any batch operations since the last flush. New code is checking if a batch operation is currently in progress. This new check also appears to be always false due to the line immediately above.\r\n\r\nI think you might be able to replace this line with `if (!m_db) return false` to restore previous behavior",
      "commit_id" : "74507ce71eb61105fb3ae8460999099234ca7b8b",
      "created_at" : "2020-07-15T23:44:17Z",
      "diff_hunk" : "@@ -633,21 +630,19 @@ bool BerkeleyDatabase::PeriodicFlush()\n     if (!lockDb) return false;\n \n     // Don't flush if any databases are in use\n-    for (const auto& use_count : env->mapFileUseCount) {\n-        if (use_count.second > 0) return false;\n+    for (auto& it : env->m_databases) {\n+        if (it.second.get().m_refcount > 0) return false;\n     }\n \n     // Don't flush if there haven't been any batch writes for this database.\n-    auto it = env->mapFileUseCount.find(strFile);\n-    if (it == env->mapFileUseCount.end()) return false;\n+    if (m_refcount > 0) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455427236",
      "id" : 455427236,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQyNzIzNg==",
      "original_commit_id" : "61da2fa6a159b0d318978cb8713f83705bb97035",
      "original_line" : 638,
      "original_position" : 101,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.cpp",
      "position" : null,
      "pull_request_review_id" : 449402796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19335",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-23T03:36:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/455427236",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455438675"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/455438675"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"walletdb: Move Db->open to BerkeleyDatabase::Open\" (33554edc24a51685cfc3ca0053372c253d1fb4b9)\r\n\r\nThis is annoying, but I think there is another bug here. It's necessary to move the AddRef call before the Open call to avoid a race condition: https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437020063. But now there is another problem because if Open throws, then the reference count will never be decremented in the batch destructor because Batch::pdb will be null.\r\n\r\nEasiest way to fix this is probably to move the the AddRef() call here back after the Open() call but lock cs_db while calling both.\r\n\r\nAn alternate fix would move `m_database.RemoveRef()` from the batch close method to the batch destructor and make it unconditional the same way the `database.AddRef()` call is unconditional in the constructor right now.\r\n\r\nA third alternative would make reference counting internal to the database object and just give it symmetric Open and CloseIfUnused methods like I suggested twice previously https://github.com/bitcoin/bitcoin/pull/19334#discussion_r444428173 and https://github.com/bitcoin/bitcoin/pull/18971#discussion_r439615919, but this is a bigger change.\r\n\r\n\r\n",
      "commit_id" : "74507ce71eb61105fb3ae8460999099234ca7b8b",
      "created_at" : "2020-07-16T00:21:54Z",
      "diff_hunk" : "@@ -334,13 +334,27 @@ BerkeleyDatabase::~BerkeleyDatabase()\n \n BerkeleyBatch::BerkeleyBatch(BerkeleyDatabase& database, const char* pszMode, bool fFlushOnCloseIn) : pdb(nullptr), activeTxn(nullptr), m_cursor(nullptr), m_database(database)\n {\n+    database.AddRef();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455438675",
      "id" : 455438675,
      "line" : 322,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQzODY3NQ==",
      "original_commit_id" : "33554edc24a51685cfc3ca0053372c253d1fb4b9",
      "original_line" : 322,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.cpp",
      "position" : 69,
      "pull_request_review_id" : 449402796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19335",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-23T03:36:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/455438675",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455448730"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/455448730"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"walletdb: Use a global g_fileids instead of m_fileids for each env\" (8a98a83232fab6ff653c9475bb6e01249eadfa5c)\r\n\r\nI think now that we have .walletlock files, the \"in the future a more relaxed check\" TODO above has been implemented, and neither having the `for g_dbenvs` loop nor having a global fileid list make sense anymore. Like the comment and https://github.com/bitcoin/bitcoin/pull/18971#discussion_r436769899 say, the global fileid checking was a kludge to work around lack of locking. Since #11904, locking is implemented and the kludge should no longer necessary. I think this commit could be simplified to just drop the for loop and long comment here and call CheckUniqueFileid(*env, strFilename, *pdb_temp, env->m_fileids[strFile]);` here to delete the kludge instead of reimplementing and moving it.\r\n",
      "commit_id" : "74507ce71eb61105fb3ae8460999099234ca7b8b",
      "created_at" : "2020-07-16T00:59:42Z",
      "diff_hunk" : "@@ -389,24 +412,10 @@ void BerkeleyDatabase::Open(const char* pszMode)\n             if (ret != 0) {\n                 throw std::runtime_error(strprintf(\"BerkeleyDatabase: Error %d, can't open database %s\", ret, strFile));\n             }\n+            m_file_path = (env->Directory() / strFile).string();\n \n-            // Call CheckUniqueFileid on the containing BDB environment to\n-            // avoid BDB data consistency bugs that happen when different data\n-            // files in the same environment have the same fileid.\n-            //\n-            // Also call CheckUniqueFileid on all the other g_dbenvs to prevent\n-            // bitcoin from opening the same data file through another\n-            // environment when the file is referenced through equivalent but\n-            // not obviously identical symlinked or hard linked or bind mounted\n-            // paths. In the future a more relaxed check for equal inode and\n-            // device ids could be done instead, which would allow opening\n-            // different backup copies of a wallet at the same time. Maybe even\n-            // more ideally, an exclusive lock for accessing the database could\n-            // be implemented, so no equality checks are needed at all. (Newer\n-            // versions of BDB have an set_lk_exclusive method for this\n-            // purpose, but the older version we use does not.)\n-            for (const auto& env : g_dbenvs) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455448730",
      "id" : 455448730,
      "line" : 386,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTQ0ODczMA==",
      "original_commit_id" : "8a98a83232fab6ff653c9475bb6e01249eadfa5c",
      "original_line" : 386,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.cpp",
      "position" : 147,
      "pull_request_review_id" : 449402796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19335",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-23T03:36:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/455448730",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455989719"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/455989719"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've added a commit to merge `BerkeleyEnvironment::Verify` and `BerkeleyDatabase::Verify`",
      "commit_id" : "74507ce71eb61105fb3ae8460999099234ca7b8b",
      "created_at" : "2020-07-16T18:30:51Z",
      "diff_hunk" : "@@ -245,9 +244,6 @@ BerkeleyEnvironment::BerkeleyEnvironment()\n \n bool BerkeleyEnvironment::Verify(const std::string& strFile)\n {\n-    LOCK(cs_db);\n-    assert(mapFileUseCount.count(strFile) == 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455989719",
      "id" : 455989719,
      "in_reply_to_id" : 455415631,
      "line" : 238,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk4OTcxOQ==",
      "original_commit_id" : "61da2fa6a159b0d318978cb8713f83705bb97035",
      "original_line" : 238,
      "original_position" : 16,
      "original_start_line" : 248,
      "path" : "src/wallet/bdb.cpp",
      "position" : 33,
      "pull_request_review_id" : 450108667,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19335",
      "side" : "LEFT",
      "start_line" : 237,
      "start_side" : "LEFT",
      "updated_at" : "2020-07-23T03:36:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/455989719",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455990656"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/455990656"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've changed `m_refcount` to track when the database has been flushed by setting it to `-1`. This is being done everywhere `mapFileUseCount.erase()` was happening. This allows us to restore the original behavior by checking for `m_refcount < 0`.",
      "commit_id" : "74507ce71eb61105fb3ae8460999099234ca7b8b",
      "created_at" : "2020-07-16T18:32:31Z",
      "diff_hunk" : "@@ -591,10 +588,10 @@ void BerkeleyEnvironment::Flush(bool fShutdown)\n         return;\n     {\n         LOCK(cs_db);\n-        std::map<std::string, int>::iterator mi = mapFileUseCount.begin();\n-        while (mi != mapFileUseCount.end()) {\n-            std::string strFile = (*mi).first;\n-            int nRefCount = (*mi).second;\n+        bool no_dbs_accessed = true;\n+        for (auto& db_it : m_databases) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455990656",
      "id" : 455990656,
      "in_reply_to_id" : 455422879,
      "line" : 570,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk5MDY1Ng==",
      "original_commit_id" : "61da2fa6a159b0d318978cb8713f83705bb97035",
      "original_line" : 570,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.cpp",
      "position" : 232,
      "pull_request_review_id" : 450109840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19335",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-23T03:36:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/455990656",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455991075"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/455991075"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Changed to use `m_refcount < 0` as mentioned in a previous comment.",
      "commit_id" : "74507ce71eb61105fb3ae8460999099234ca7b8b",
      "created_at" : "2020-07-16T18:33:18Z",
      "diff_hunk" : "@@ -633,21 +630,19 @@ bool BerkeleyDatabase::PeriodicFlush()\n     if (!lockDb) return false;\n \n     // Don't flush if any databases are in use\n-    for (const auto& use_count : env->mapFileUseCount) {\n-        if (use_count.second > 0) return false;\n+    for (auto& it : env->m_databases) {\n+        if (it.second.get().m_refcount > 0) return false;\n     }\n \n     // Don't flush if there haven't been any batch writes for this database.\n-    auto it = env->mapFileUseCount.find(strFile);\n-    if (it == env->mapFileUseCount.end()) return false;\n+    if (m_refcount > 0) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455991075",
      "id" : 455991075,
      "in_reply_to_id" : 455427236,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk5MTA3NQ==",
      "original_commit_id" : "61da2fa6a159b0d318978cb8713f83705bb97035",
      "original_line" : 638,
      "original_position" : 101,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.cpp",
      "position" : null,
      "pull_request_review_id" : 450110385,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19335",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-23T03:36:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/455991075",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455991428"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/455991428"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've moved `m_database.RemoveRef()` to the destructor.",
      "commit_id" : "74507ce71eb61105fb3ae8460999099234ca7b8b",
      "created_at" : "2020-07-16T18:33:54Z",
      "diff_hunk" : "@@ -334,13 +334,27 @@ BerkeleyDatabase::~BerkeleyDatabase()\n \n BerkeleyBatch::BerkeleyBatch(BerkeleyDatabase& database, const char* pszMode, bool fFlushOnCloseIn) : pdb(nullptr), activeTxn(nullptr), m_cursor(nullptr), m_database(database)\n {\n+    database.AddRef();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455991428",
      "id" : 455991428,
      "in_reply_to_id" : 455438675,
      "line" : 322,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk5MTQyOA==",
      "original_commit_id" : "33554edc24a51685cfc3ca0053372c253d1fb4b9",
      "original_line" : 322,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.cpp",
      "position" : 69,
      "pull_request_review_id" : 450110815,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19335",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-23T03:36:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/455991428",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455991570"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/455991570"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Replaced that commit to do as you suggest.",
      "commit_id" : "74507ce71eb61105fb3ae8460999099234ca7b8b",
      "created_at" : "2020-07-16T18:34:06Z",
      "diff_hunk" : "@@ -389,24 +412,10 @@ void BerkeleyDatabase::Open(const char* pszMode)\n             if (ret != 0) {\n                 throw std::runtime_error(strprintf(\"BerkeleyDatabase: Error %d, can't open database %s\", ret, strFile));\n             }\n+            m_file_path = (env->Directory() / strFile).string();\n \n-            // Call CheckUniqueFileid on the containing BDB environment to\n-            // avoid BDB data consistency bugs that happen when different data\n-            // files in the same environment have the same fileid.\n-            //\n-            // Also call CheckUniqueFileid on all the other g_dbenvs to prevent\n-            // bitcoin from opening the same data file through another\n-            // environment when the file is referenced through equivalent but\n-            // not obviously identical symlinked or hard linked or bind mounted\n-            // paths. In the future a more relaxed check for equal inode and\n-            // device ids could be done instead, which would allow opening\n-            // different backup copies of a wallet at the same time. Maybe even\n-            // more ideally, an exclusive lock for accessing the database could\n-            // be implemented, so no equality checks are needed at all. (Newer\n-            // versions of BDB have an set_lk_exclusive method for this\n-            // purpose, but the older version we use does not.)\n-            for (const auto& env : g_dbenvs) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455991570",
      "id" : 455991570,
      "in_reply_to_id" : 455448730,
      "line" : 386,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTk5MTU3MA==",
      "original_commit_id" : "8a98a83232fab6ff653c9475bb6e01249eadfa5c",
      "original_line" : 386,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.cpp",
      "position" : 147,
      "pull_request_review_id" : 450110962,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19335",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-23T03:36:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/455991570",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19335#discussion_r456044809"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/456044809"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455990656\r\n\r\nIn commit \"walletdb: track database file use as m_refcount within BerkeleyDatabase\" (516084a2738364f3922c08d8703fd737541bb2da)\r\n\r\n> I've changed `m_refcount` to track when the database has been flushed by setting it to `-1`. This is being done everywhere `mapFileUseCount.erase()` was happening. This allows us to restore the original behavior by checking for `m_refcount < 0`.\r\n\r\nNote: I think there is still small change in behavior because m_refcount is initialized to 0 not -1, so never used databases are now treated like used and not yet flushed databases. I don't think the difference actually matters, though.",
      "commit_id" : "74507ce71eb61105fb3ae8460999099234ca7b8b",
      "created_at" : "2020-07-16T20:02:49Z",
      "diff_hunk" : "@@ -591,10 +588,10 @@ void BerkeleyEnvironment::Flush(bool fShutdown)\n         return;\n     {\n         LOCK(cs_db);\n-        std::map<std::string, int>::iterator mi = mapFileUseCount.begin();\n-        while (mi != mapFileUseCount.end()) {\n-            std::string strFile = (*mi).first;\n-            int nRefCount = (*mi).second;\n+        bool no_dbs_accessed = true;\n+        for (auto& db_it : m_databases) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19335#discussion_r456044809",
      "id" : 456044809,
      "in_reply_to_id" : 455422879,
      "line" : 570,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjA0NDgwOQ==",
      "original_commit_id" : "61da2fa6a159b0d318978cb8713f83705bb97035",
      "original_line" : 570,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.cpp",
      "position" : 232,
      "pull_request_review_id" : 450175041,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19335",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-23T03:36:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/456044809",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-07-22T07:38:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19335#issuecomment-662296166",
      "id" : 662296166,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19335",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2MjI5NjE2Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-22T07:38:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/662296166",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19335#discussion_r460336989"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/460336989"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why was this removed?",
      "commit_id" : "74507ce71eb61105fb3ae8460999099234ca7b8b",
      "created_at" : "2020-07-25T00:11:33Z",
      "diff_hunk" : "@@ -285,8 +284,7 @@ bool BerkeleyDatabase::Verify(bilingual_str& errorStr)\n \n     if (fs::exists(file_path))\n     {\n-        LOCK(cs_db);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19335#discussion_r460336989",
      "id" : 460336989,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMzNjk4OQ==",
      "original_commit_id" : "4fe4b3bf1b152877677a6115f82aefaf318dd514",
      "original_line" : 288,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.cpp",
      "position" : null,
      "pull_request_review_id" : 455240676,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19335",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-25T00:11:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/460336989",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19335#discussion_r460415741"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19335"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/460415741"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It was there to guard mapFileUseCount which we've now removed.",
      "commit_id" : "74507ce71eb61105fb3ae8460999099234ca7b8b",
      "created_at" : "2020-07-25T15:31:55Z",
      "diff_hunk" : "@@ -285,8 +284,7 @@ bool BerkeleyDatabase::Verify(bilingual_str& errorStr)\n \n     if (fs::exists(file_path))\n     {\n-        LOCK(cs_db);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19335#discussion_r460415741",
      "id" : 460415741,
      "in_reply_to_id" : 460336989,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDQxNTc0MQ==",
      "original_commit_id" : "4fe4b3bf1b152877677a6115f82aefaf318dd514",
      "original_line" : 288,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.cpp",
      "position" : null,
      "pull_request_review_id" : 455291939,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19335",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-25T15:31:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/460415741",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review ACK 74507ce71eb61105fb3ae8460999099234ca7b8b",
      "created_at" : "2020-07-29T16:02:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19335#issuecomment-665753008",
      "id" : 665753008,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19335",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NTc1MzAwOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-29T16:02:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/665753008",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
