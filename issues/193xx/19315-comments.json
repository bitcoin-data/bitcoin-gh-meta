[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #20726 (p2p: Add DISABLETX message for negotiating block-relay-only connections by sdaftuar)\n* #20277 (p2p: Stop processing unrequested transactions during IBD and extend p2p_ibd_txrelay.py coverage by ariard)\n* #20012 (rpc: Remove duplicate name and argNames from CRPCCommand by MarcoFalke)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-06-17T23:09:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-645672477",
      "id" : 645672477,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NTY3MjQ3Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-08T03:01:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/645672477",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. Being able to explicitly test different connection types including outbounds will be really useful.",
      "created_at" : "2020-06-18T19:49:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-646271653",
      "id" : 646271653,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NjI3MTY1Mw==",
      "updated_at" : "2020-06-18T19:49:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/646271653",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK, that's a substantial move to increase coverage of p2p!\r\n\r\n@t-bast, see https://github.com/ariard/bitcoin/commits/2020-07-tda-mitigation-block-relay, based on this PR, it should allow you to open manual block-relay-only connection to a side-node _without_ leaking its presence due to addr-relay. That's one of the mitigation we talked offline against time-dilation and it should prevent you against unknown in-protocol eclipses. This is experimental software ofc, beware of not killing any kittens :)",
      "created_at" : "2020-07-03T04:05:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-653332533",
      "id" : 653332533,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MzMzMjUzMw==",
      "updated_at" : "2020-07-03T04:05:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/653332533",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r449410050"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449410050"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "very nit: `conn_type` or `connType`?",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-07-03T06:59:16Z",
      "diff_hunk" : "@@ -367,8 +367,10 @@ static CAddress GetBindAddress(SOCKET sock)\n     return addr_bind;\n }\n \n-CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure, bool manual_connection, bool block_relay_only)\n+CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure, ConnectionType conn_type)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r449410050",
      "id" : 449410050,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQxMDA1MA==",
      "original_commit_id" : "b43b7dba9feadcdad6bd966eac924b01bca59e1c",
      "original_line" : 391,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 442187488,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449410050",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/31281497?v=4",
         "events_url" : "https://api.github.com/users/t-bast/events{/privacy}",
         "followers_url" : "https://api.github.com/users/t-bast/followers",
         "following_url" : "https://api.github.com/users/t-bast/following{/other_user}",
         "gists_url" : "https://api.github.com/users/t-bast/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/t-bast",
         "id" : 31281497,
         "login" : "t-bast",
         "node_id" : "MDQ6VXNlcjMxMjgxNDk3",
         "organizations_url" : "https://api.github.com/users/t-bast/orgs",
         "received_events_url" : "https://api.github.com/users/t-bast/received_events",
         "repos_url" : "https://api.github.com/users/t-bast/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/t-bast/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/t-bast/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/t-bast"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r449412035"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449412035"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "My 2 cents (feel free to ignore as I'm clearly very new to the bitcoin codebase): it feels to me that the distinction manual vs non-manual (automatic?) is orthogonal to the connection type and could be a separate enum.\r\n\r\nIIUC `MANUAL` can be composed with either `OUTBOUND`, `FEELER`, `BLOCK_RELAY` or `ADDR_FETCH`.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-07-03T07:04:32Z",
      "diff_hunk" : "@@ -113,6 +113,14 @@ struct CSerializedNetMsg\n     std::string command;\n };\n \n+enum class ConnectionType {\n+    INBOUND, // peer initiated connections\n+    OUTBOUND, // full relay connections (blocks, addrs, txns)\n+    MANUAL, // connections to addresses added via addnode or the connect command line argument",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r449412035",
      "id" : 449412035,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQxMjAzNQ==",
      "original_commit_id" : "b43b7dba9feadcdad6bd966eac924b01bca59e1c",
      "original_line" : 119,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 442187488,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449412035",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/31281497?v=4",
         "events_url" : "https://api.github.com/users/t-bast/events{/privacy}",
         "followers_url" : "https://api.github.com/users/t-bast/followers",
         "following_url" : "https://api.github.com/users/t-bast/following{/other_user}",
         "gists_url" : "https://api.github.com/users/t-bast/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/t-bast",
         "id" : 31281497,
         "login" : "t-bast",
         "node_id" : "MDQ6VXNlcjMxMjgxNDk3",
         "organizations_url" : "https://api.github.com/users/t-bast/orgs",
         "received_events_url" : "https://api.github.com/users/t-bast/received_events",
         "repos_url" : "https://api.github.com/users/t-bast/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/t-bast/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/t-bast/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/t-bast"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r449634741"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449634741"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`conn_type` is correct. See the developer guide: https://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md#coding-style-c",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-07-03T15:28:35Z",
      "diff_hunk" : "@@ -367,8 +367,10 @@ static CAddress GetBindAddress(SOCKET sock)\n     return addr_bind;\n }\n \n-CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure, bool manual_connection, bool block_relay_only)\n+CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure, ConnectionType conn_type)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r449634741",
      "id" : 449634741,
      "in_reply_to_id" : 449410050,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTYzNDc0MQ==",
      "original_commit_id" : "b43b7dba9feadcdad6bd966eac924b01bca59e1c",
      "original_line" : 391,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 442478780,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449634741",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r449634943"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449634943"
         }
      },
      "author_association" : "MEMBER",
      "body" : "See rationale here: https://github.com/bitcoin/bitcoin/pull/19316#issuecomment-646304479 and here: https://github.com/bitcoin/bitcoin/pull/19316#issuecomment-649776062",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-07-03T15:29:15Z",
      "diff_hunk" : "@@ -113,6 +113,14 @@ struct CSerializedNetMsg\n     std::string command;\n };\n \n+enum class ConnectionType {\n+    INBOUND, // peer initiated connections\n+    OUTBOUND, // full relay connections (blocks, addrs, txns)\n+    MANUAL, // connections to addresses added via addnode or the connect command line argument",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r449634943",
      "id" : 449634943,
      "in_reply_to_id" : 449412035,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTYzNDk0Mw==",
      "original_commit_id" : "b43b7dba9feadcdad6bd966eac924b01bca59e1c",
      "original_line" : 119,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 442479057,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449634943",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@t-bast I'd strongly encourage you to _not_ use this branch or anything based on it for anything other than testing:\r\n\r\n- it's not merged yet, so still unreviewed\r\n- it's intended for testing only, and there are no guarantees about how it would work long-term in production (for example, the way that CConnman tracks the number of open connections is not updated to take account of these test connections. The commit here: https://github.com/ariard/bitcoin/commit/ea9943251b051a59d1b4cc7ae0ff34aeaea441f4 doesn't fix that)\r\n- since it's for testing only and not a public method, it may be removed or changed at any time.",
      "created_at" : "2020-07-03T15:35:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-653599673",
      "id" : 653599673,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MzU5OTY3Mw==",
      "updated_at" : "2020-07-03T15:35:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/653599673",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r449646549"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449646549"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for the pointer, I was wondering about the inconsistency between variables (`addrConnect` instead of `addr_connect`), but this probably falls under `These are preferred in new code, but are not required when doing so would need changes to significant pieces of existing code.`",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-07-03T16:04:44Z",
      "diff_hunk" : "@@ -367,8 +367,10 @@ static CAddress GetBindAddress(SOCKET sock)\n     return addr_bind;\n }\n \n-CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure, bool manual_connection, bool block_relay_only)\n+CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure, ConnectionType conn_type)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r449646549",
      "id" : 449646549,
      "in_reply_to_id" : 449410050,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY0NjU0OQ==",
      "original_commit_id" : "b43b7dba9feadcdad6bd966eac924b01bca59e1c",
      "original_line" : 391,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 442493370,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449646549",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/31281497?v=4",
         "events_url" : "https://api.github.com/users/t-bast/events{/privacy}",
         "followers_url" : "https://api.github.com/users/t-bast/followers",
         "following_url" : "https://api.github.com/users/t-bast/following{/other_user}",
         "gists_url" : "https://api.github.com/users/t-bast/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/t-bast",
         "id" : 31281497,
         "login" : "t-bast",
         "node_id" : "MDQ6VXNlcjMxMjgxNDk3",
         "organizations_url" : "https://api.github.com/users/t-bast/orgs",
         "received_events_url" : "https://api.github.com/users/t-bast/received_events",
         "repos_url" : "https://api.github.com/users/t-bast/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/t-bast/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/t-bast/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/t-bast"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r449647582"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449647582"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks, I should have done my homework and read that PR first (as was clearly said in the PR description!).",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-07-03T16:08:07Z",
      "diff_hunk" : "@@ -113,6 +113,14 @@ struct CSerializedNetMsg\n     std::string command;\n };\n \n+enum class ConnectionType {\n+    INBOUND, // peer initiated connections\n+    OUTBOUND, // full relay connections (blocks, addrs, txns)\n+    MANUAL, // connections to addresses added via addnode or the connect command line argument",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r449647582",
      "id" : 449647582,
      "in_reply_to_id" : 449412035,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY0NzU4Mg==",
      "original_commit_id" : "b43b7dba9feadcdad6bd966eac924b01bca59e1c",
      "original_line" : 119,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 442494612,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/449647582",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/31281497?v=4",
         "events_url" : "https://api.github.com/users/t-bast/events{/privacy}",
         "followers_url" : "https://api.github.com/users/t-bast/followers",
         "following_url" : "https://api.github.com/users/t-bast/following{/other_user}",
         "gists_url" : "https://api.github.com/users/t-bast/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/t-bast",
         "id" : 31281497,
         "login" : "t-bast",
         "node_id" : "MDQ6VXNlcjMxMjgxNDk3",
         "organizations_url" : "https://api.github.com/users/t-bast/orgs",
         "received_events_url" : "https://api.github.com/users/t-bast/received_events",
         "repos_url" : "https://api.github.com/users/t-bast/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/t-bast/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/t-bast/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/t-bast"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Thanks for the concerns @jnewbery, no worries I'm not planning on using anything else than official `bitcoind` releases for `eclair`, I'm simply adding my concept ACK on the overall direction that will be quite helpful for hardening lightning!",
      "created_at" : "2020-07-03T16:10:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-653610473",
      "id" : 653610473,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MzYxMDQ3Mw==",
      "updated_at" : "2020-07-03T16:10:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/653610473",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/31281497?v=4",
         "events_url" : "https://api.github.com/users/t-bast/events{/privacy}",
         "followers_url" : "https://api.github.com/users/t-bast/followers",
         "following_url" : "https://api.github.com/users/t-bast/following{/other_user}",
         "gists_url" : "https://api.github.com/users/t-bast/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/t-bast",
         "id" : 31281497,
         "login" : "t-bast",
         "node_id" : "MDQ6VXNlcjMxMjgxNDk3",
         "organizations_url" : "https://api.github.com/users/t-bast/orgs",
         "received_events_url" : "https://api.github.com/users/t-bast/received_events",
         "repos_url" : "https://api.github.com/users/t-bast/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/t-bast/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/t-bast/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/t-bast"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jnewbery thanks to press on the warning. The provided commit is for experimentation-only and MUST NOT be used in production for reasons aforementioned.\r\n\r\nFor anyone reading this and providing more context, Lightning nodes interested to prevent against time-dilation attacks (a no-hashrate eclipse variant against offchain protocols) should have multiple access to the chain view. As of today, the classic infra setup is to run the LN stack on top of _one_ full-node, if this one gets sybilled and partitioned from the rest of the network, the channel funds are at risk. Running a self-hosted or controlled secondary node connected to your main node would mitigate at least eclipses due to weaknesses in addr management or peer selection. As of today, we do have automatic block-relay-only peers, for which in theory their topology should stay masked to an external observer. But a bug in peer selection may be leveraged to lure block-only-relay connections to attacker controlled-peers. Adding redundant _manual_ block-relay-only connections will prevent this. Manual block-only secondary nodes won't fit there as they do leak addr-relay, which can be used to learn about their presence.\r\n\r\nProvided commit (https://github.com/ariard/bitcoin/commit/ea9943251b051a59d1b4cc7ae0ff34aeaea441f4) let you experiment such primary/secondary block-relay-only topology setup. There is no guarantee that anything will stay stable. If by playing with it, you do see value in this configuration, please concept ack and help to review downstream branches. If you don't understand what you're doing don't use it or ask questions.\r\n\r\n ",
      "created_at" : "2020-07-03T17:02:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-653624340",
      "id" : 653624340,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1MzYyNDM0MA==",
      "updated_at" : "2020-07-03T17:17:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/653624340",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-07-07T18:28:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-655044251",
      "id" : 655044251,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1NTA0NDI1MQ==",
      "updated_at" : "2020-07-07T18:28:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/655044251",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Yay rebase! You can remove the \"This PR builds on #19316. Please review that first.\" from the PR description. Is this PR now ready for review?",
      "created_at" : "2020-08-18T18:59:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-675656643",
      "id" : 675656643,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3NTY1NjY0Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-18T18:59:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/675656643",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "hahha I was going to let the tests pass first, but yes it should be ready for review :) ",
      "created_at" : "2020-08-18T19:01:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-675657592",
      "id" : 675657592,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3NTY1NzU5Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-18T19:01:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/675657592",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r473836629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/473836629"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Either remove this comment or place it above `addpeeraddress`, since they're both not shown in help.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-20T09:59:17Z",
      "diff_hunk" : "@@ -841,6 +897,9 @@ static const CRPCCommand commands[] =\n     { \"network\",            \"setnetworkactive\",       &setnetworkactive,       {\"state\"} },\n     { \"network\",            \"getnodeaddresses\",       &getnodeaddresses,       {\"count\"} },\n     { \"hidden\",             \"addpeeraddress\",         &addpeeraddress,         {\"address\", \"port\"} },\n+\n+    /* Not shown in help */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r473836629",
      "id" : 473836629,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzgzNjYyOQ==",
      "original_commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "original_line" : 900,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 471442648,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/473836629",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r473841451"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/473841451"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style: sort and place on separate lines",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-20T10:04:43Z",
      "diff_hunk" : "@@ -65,7 +65,7 @@\n     NODE_WITNESS,\n     sha256,\n )\n-from test_framework.util import wait_until\n+from test_framework.util import wait_until, MAX_NODES, p2p_port",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r473841451",
      "id" : 473841451,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg0MTQ1MQ==",
      "original_commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "original_line" : 68,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/mininode.py",
      "position" : null,
      "pull_request_review_id" : 471442648,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/473841451",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r473856088"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/473856088"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Consider renaming this function (and the equivalents in `P2PInterface` and `TestNode`) to `peer_accept_connection()` or similar. From the perspective of the `P2PConnection`, this is an inbound connection since it's initiated by the bitcoind node.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-20T10:22:34Z",
      "diff_hunk" : "@@ -139,12 +139,20 @@ def peer_connect(self, dstaddr, dstport, *, net, timeout_factor):\n         self.on_connection_send_msg = None\n         self.recvbuf = b\"\"\n         self.magic_bytes = MAGIC_BYTES[net]\n-        logger.debug('Connecting to Bitcoin Node: %s:%d' % (self.dstaddr, self.dstport))\n+\n+    def peer_connect(self, dstaddr, dstport, *, net, timeout_factor):\n+        self.peer_connect_helper(dstaddr, dstport, net, timeout_factor)\n \n         loop = NetworkThread.network_event_loop\n-        conn_gen_unsafe = loop.create_connection(lambda: self, host=self.dstaddr, port=self.dstport)\n-        conn_gen = lambda: loop.call_soon_threadsafe(loop.create_task, conn_gen_unsafe)\n-        return conn_gen\n+        logger.debug('Connecting to Bitcoin Node: %s:%d' % (self.dstaddr, self.dstport))\n+        coroutine = loop.create_connection(lambda: self, host=self.dstaddr, port=self.dstport)\n+        return lambda: loop.call_soon_threadsafe(loop.create_task, coroutine)\n+\n+    def peer_outbound_connect(self, dstaddr, dstport, connect_cb, connect_id=0, *, net, timeout_factor):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r473856088",
      "id" : 473856088,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg1NjA4OA==",
      "original_commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "original_line" : 151,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/mininode.py",
      "position" : null,
      "pull_request_review_id" : 471442648,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/473856088",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r473860655"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/473860655"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This doesn't actually test that the transaction won't get announced by the node, since transaction announcements are batched and only sent when the `nNextInvSend` timer pops. The `sync_with_ping()` above doesn't guarantee that there's nothing in the `setInventoryTxToSend` waiting to be sent (ie I think this test would still pass if this were an outbound-full-relay peer). I don't have any good suggestions except maybe adding a comment. Testing for the absence of something is hard!",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-20T10:28:16Z",
      "diff_hunk" : "@@ -69,18 +49,55 @@ def run_test(self):\n         peer_2_info = self.nodes[0].getpeerinfo()[1]\n         assert_equal(peer_2_info['whitelisted'], True)\n         assert_equal(peer_2_info['permissions'], ['noban', 'forcerelay', 'relay', 'mempool', 'download'])\n-        assert_equal(self.nodes[0].testmempoolaccept([sigtx])[0]['allowed'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n \n         self.log.info('Check that the tx from forcerelay first_peer is relayed to others (ie.second_peer)')\n         with self.nodes[0].assert_debug_log([\"received getdata\"]):\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the forcerelay peer is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Forcerelay peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n+        self.nodes[0].sendrawtransaction(tx_hex)\n+        conn.sync_with_ping()\n+        assert(txid not in conn.get_invs())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r473860655",
      "id" : 473860655,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg2MDY1NQ==",
      "original_commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "original_line" : 82,
      "original_position" : 109,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 471442648,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/473860655",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r473866387"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/473866387"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`getnewaddress` requires a wallet, so this test fails without the wallet compiled. Can you replace it with a hard-coded address?",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-20T10:35:25Z",
      "diff_hunk" : "@@ -69,18 +49,55 @@ def run_test(self):\n         peer_2_info = self.nodes[0].getpeerinfo()[1]\n         assert_equal(peer_2_info['whitelisted'], True)\n         assert_equal(peer_2_info['permissions'], ['noban', 'forcerelay', 'relay', 'mempool', 'download'])\n-        assert_equal(self.nodes[0].testmempoolaccept([sigtx])[0]['allowed'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n \n         self.log.info('Check that the tx from forcerelay first_peer is relayed to others (ie.second_peer)')\n         with self.nodes[0].assert_debug_log([\"received getdata\"]):\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the forcerelay peer is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Forcerelay peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n+        self.nodes[0].sendrawtransaction(tx_hex)\n+        conn.sync_with_ping()\n+        assert(txid not in conn.get_invs())\n+\n+    def check_p2p_tx_violation(self, index=1):\n+        self.log.info('Check that txs from P2P are rejected and result in disconnect')\n+        input_txid = self.nodes[0].getblock(self.nodes[0].getblockhash(index), 2)['tx'][0]['txid']\n+        tx = create_transaction(self.nodes[0], input_txid, self.nodes[0].getnewaddress(), amount=50 - 0.001)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r473866387",
      "id" : 473866387,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzg2NjM4Nw==",
      "original_commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "original_line" : 99,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 471442648,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/473866387",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r474970241"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/474970241"
         }
      },
      "author_association" : "MEMBER",
      "body" : "great point. renaming this & the equivalent on `P2PInterface` to `peer_accept_connection()` is much clearer. \r\n\r\nbut for `TestNode`, I think `add_outbound_p2p_connection()` makes sense? its a connection from node -> p2p conn, so outbound for node. inbound / accept for the P2P connections.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-21T21:06:12Z",
      "diff_hunk" : "@@ -139,12 +139,20 @@ def peer_connect(self, dstaddr, dstport, *, net, timeout_factor):\n         self.on_connection_send_msg = None\n         self.recvbuf = b\"\"\n         self.magic_bytes = MAGIC_BYTES[net]\n-        logger.debug('Connecting to Bitcoin Node: %s:%d' % (self.dstaddr, self.dstport))\n+\n+    def peer_connect(self, dstaddr, dstport, *, net, timeout_factor):\n+        self.peer_connect_helper(dstaddr, dstport, net, timeout_factor)\n \n         loop = NetworkThread.network_event_loop\n-        conn_gen_unsafe = loop.create_connection(lambda: self, host=self.dstaddr, port=self.dstport)\n-        conn_gen = lambda: loop.call_soon_threadsafe(loop.create_task, conn_gen_unsafe)\n-        return conn_gen\n+        logger.debug('Connecting to Bitcoin Node: %s:%d' % (self.dstaddr, self.dstport))\n+        coroutine = loop.create_connection(lambda: self, host=self.dstaddr, port=self.dstport)\n+        return lambda: loop.call_soon_threadsafe(loop.create_task, coroutine)\n+\n+    def peer_outbound_connect(self, dstaddr, dstport, connect_cb, connect_id=0, *, net, timeout_factor):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r474970241",
      "id" : 474970241,
      "in_reply_to_id" : 473856088,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDk3MDI0MQ==",
      "original_commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "original_line" : 151,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/mininode.py",
      "position" : null,
      "pull_request_review_id" : 472819489,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/474970241",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r475454108"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475454108"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point. It makes sense for the `TestNode` function to stay as `add_outbound_p2p_connection()`.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-24T09:17:58Z",
      "diff_hunk" : "@@ -139,12 +139,20 @@ def peer_connect(self, dstaddr, dstport, *, net, timeout_factor):\n         self.on_connection_send_msg = None\n         self.recvbuf = b\"\"\n         self.magic_bytes = MAGIC_BYTES[net]\n-        logger.debug('Connecting to Bitcoin Node: %s:%d' % (self.dstaddr, self.dstport))\n+\n+    def peer_connect(self, dstaddr, dstport, *, net, timeout_factor):\n+        self.peer_connect_helper(dstaddr, dstport, net, timeout_factor)\n \n         loop = NetworkThread.network_event_loop\n-        conn_gen_unsafe = loop.create_connection(lambda: self, host=self.dstaddr, port=self.dstport)\n-        conn_gen = lambda: loop.call_soon_threadsafe(loop.create_task, conn_gen_unsafe)\n-        return conn_gen\n+        logger.debug('Connecting to Bitcoin Node: %s:%d' % (self.dstaddr, self.dstport))\n+        coroutine = loop.create_connection(lambda: self, host=self.dstaddr, port=self.dstport)\n+        return lambda: loop.call_soon_threadsafe(loop.create_task, coroutine)\n+\n+    def peer_outbound_connect(self, dstaddr, dstport, connect_cb, connect_id=0, *, net, timeout_factor):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r475454108",
      "id" : 475454108,
      "in_reply_to_id" : 473856088,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQ1NDEwOA==",
      "original_commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "original_line" : 151,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/mininode.py",
      "position" : null,
      "pull_request_review_id" : 473274510,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475454108",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r475884039"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475884039"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-24T20:46:35Z",
      "diff_hunk" : "@@ -841,6 +897,9 @@ static const CRPCCommand commands[] =\n     { \"network\",            \"setnetworkactive\",       &setnetworkactive,       {\"state\"} },\n     { \"network\",            \"getnodeaddresses\",       &getnodeaddresses,       {\"count\"} },\n     { \"hidden\",             \"addpeeraddress\",         &addpeeraddress,         {\"address\", \"port\"} },\n+\n+    /* Not shown in help */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r475884039",
      "id" : 475884039,
      "in_reply_to_id" : 473836629,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg4NDAzOQ==",
      "original_commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "original_line" : 900,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 473843859,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475884039",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r475884229"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475884229"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-24T20:46:55Z",
      "diff_hunk" : "@@ -65,7 +65,7 @@\n     NODE_WITNESS,\n     sha256,\n )\n-from test_framework.util import wait_until\n+from test_framework.util import wait_until, MAX_NODES, p2p_port",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r475884229",
      "id" : 475884229,
      "in_reply_to_id" : 473841451,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg4NDIyOQ==",
      "original_commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "original_line" : 68,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/mininode.py",
      "position" : null,
      "pull_request_review_id" : 473844072,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475884229",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r475884574"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475884574"
         }
      },
      "author_association" : "MEMBER",
      "body" : "renamed both instances of `peer_outbound_connect` to `peer_accept_connection`. thanks! ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-24T20:47:37Z",
      "diff_hunk" : "@@ -139,12 +139,20 @@ def peer_connect(self, dstaddr, dstport, *, net, timeout_factor):\n         self.on_connection_send_msg = None\n         self.recvbuf = b\"\"\n         self.magic_bytes = MAGIC_BYTES[net]\n-        logger.debug('Connecting to Bitcoin Node: %s:%d' % (self.dstaddr, self.dstport))\n+\n+    def peer_connect(self, dstaddr, dstport, *, net, timeout_factor):\n+        self.peer_connect_helper(dstaddr, dstport, net, timeout_factor)\n \n         loop = NetworkThread.network_event_loop\n-        conn_gen_unsafe = loop.create_connection(lambda: self, host=self.dstaddr, port=self.dstport)\n-        conn_gen = lambda: loop.call_soon_threadsafe(loop.create_task, conn_gen_unsafe)\n-        return conn_gen\n+        logger.debug('Connecting to Bitcoin Node: %s:%d' % (self.dstaddr, self.dstport))\n+        coroutine = loop.create_connection(lambda: self, host=self.dstaddr, port=self.dstport)\n+        return lambda: loop.call_soon_threadsafe(loop.create_task, coroutine)\n+\n+    def peer_outbound_connect(self, dstaddr, dstport, connect_cb, connect_id=0, *, net, timeout_factor):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r475884574",
      "id" : 475884574,
      "in_reply_to_id" : 473856088,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg4NDU3NA==",
      "original_commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "original_line" : 151,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/mininode.py",
      "position" : null,
      "pull_request_review_id" : 473844519,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475884574",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r475887647"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475887647"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ah, yeah I missed that. luckily `nNextInvSend` is mockable so I'm able to bump time forward to ensure the transaction would send. I also fixed a bug with the matching condition (was comparing different types). I think the test now functions correctly- if you remove the `connection_type=\"blockrelay\"` param when adding the p2p conn, the tx sends and the test fails. what do you think? ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-24T20:53:37Z",
      "diff_hunk" : "@@ -69,18 +49,55 @@ def run_test(self):\n         peer_2_info = self.nodes[0].getpeerinfo()[1]\n         assert_equal(peer_2_info['whitelisted'], True)\n         assert_equal(peer_2_info['permissions'], ['noban', 'forcerelay', 'relay', 'mempool', 'download'])\n-        assert_equal(self.nodes[0].testmempoolaccept([sigtx])[0]['allowed'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n \n         self.log.info('Check that the tx from forcerelay first_peer is relayed to others (ie.second_peer)')\n         with self.nodes[0].assert_debug_log([\"received getdata\"]):\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the forcerelay peer is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Forcerelay peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n+        self.nodes[0].sendrawtransaction(tx_hex)\n+        conn.sync_with_ping()\n+        assert(txid not in conn.get_invs())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r475887647",
      "id" : 475887647,
      "in_reply_to_id" : 473860655,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg4NzY0Nw==",
      "original_commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "original_line" : 82,
      "original_position" : 109,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 473848452,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475887647",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r475888230"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475888230"
         }
      },
      "author_association" : "MEMBER",
      "body" : "so simple! done :) ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-24T20:54:40Z",
      "diff_hunk" : "@@ -69,18 +49,55 @@ def run_test(self):\n         peer_2_info = self.nodes[0].getpeerinfo()[1]\n         assert_equal(peer_2_info['whitelisted'], True)\n         assert_equal(peer_2_info['permissions'], ['noban', 'forcerelay', 'relay', 'mempool', 'download'])\n-        assert_equal(self.nodes[0].testmempoolaccept([sigtx])[0]['allowed'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n \n         self.log.info('Check that the tx from forcerelay first_peer is relayed to others (ie.second_peer)')\n         with self.nodes[0].assert_debug_log([\"received getdata\"]):\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the forcerelay peer is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Forcerelay peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n+        self.nodes[0].sendrawtransaction(tx_hex)\n+        conn.sync_with_ping()\n+        assert(txid not in conn.get_invs())\n+\n+    def check_p2p_tx_violation(self, index=1):\n+        self.log.info('Check that txs from P2P are rejected and result in disconnect')\n+        input_txid = self.nodes[0].getblock(self.nodes[0].getblockhash(index), 2)['tx'][0]['txid']\n+        tx = create_transaction(self.nodes[0], input_txid, self.nodes[0].getnewaddress(), amount=50 - 0.001)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r475888230",
      "id" : 475888230,
      "in_reply_to_id" : 473866387,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTg4ODIzMA==",
      "original_commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "original_line" : 99,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 473849198,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/475888230",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r476194074"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476194074"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ah, looks like the blocktools helper uses wallet, so I ended up just adding `skip_if_no_wallet` and reverting this. ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-25T05:53:27Z",
      "diff_hunk" : "@@ -69,18 +49,55 @@ def run_test(self):\n         peer_2_info = self.nodes[0].getpeerinfo()[1]\n         assert_equal(peer_2_info['whitelisted'], True)\n         assert_equal(peer_2_info['permissions'], ['noban', 'forcerelay', 'relay', 'mempool', 'download'])\n-        assert_equal(self.nodes[0].testmempoolaccept([sigtx])[0]['allowed'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n \n         self.log.info('Check that the tx from forcerelay first_peer is relayed to others (ie.second_peer)')\n         with self.nodes[0].assert_debug_log([\"received getdata\"]):\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the forcerelay peer is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Forcerelay peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n+        self.nodes[0].sendrawtransaction(tx_hex)\n+        conn.sync_with_ping()\n+        assert(txid not in conn.get_invs())\n+\n+    def check_p2p_tx_violation(self, index=1):\n+        self.log.info('Check that txs from P2P are rejected and result in disconnect')\n+        input_txid = self.nodes[0].getblock(self.nodes[0].getblockhash(index), 2)['tx'][0]['txid']\n+        tx = create_transaction(self.nodes[0], input_txid, self.nodes[0].getnewaddress(), amount=50 - 0.001)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r476194074",
      "id" : 476194074,
      "in_reply_to_id" : 473866387,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjE5NDA3NA==",
      "original_commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "original_line" : 99,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 474154182,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476194074",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r476299424"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476299424"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: For new code it might be good to use the non-deprecated constructor (see e.g. #19528) ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-25T09:09:43Z",
      "diff_hunk" : "@@ -282,6 +283,61 @@ static UniValue addnode(const JSONRPCRequest& request)\n     return NullUniValue;\n }\n \n+static UniValue addconnection(const JSONRPCRequest& request)\n+{\n+    const RPCHelpMan help{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node (test only)\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connectiontype\", RPCArg::Type::STR, RPCArg::Optional::NO, \"'outbound' or 'blockrelay'\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connectiontype\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+    };\n+\n+    help.Check(request);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r476299424",
      "id" : 476299424,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI5OTQyNA==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 306,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 474288186,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476299424",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r476300109"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476300109"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: Would be good to either consistently mention this in every file where \"hidden\" is used or nowhere. Maybe just keep the newline?",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-25T09:10:49Z",
      "diff_hunk" : "@@ -840,7 +896,10 @@ static const CRPCCommand commands[] =\n     { \"network\",            \"clearbanned\",            &clearbanned,            {} },\n     { \"network\",            \"setnetworkactive\",       &setnetworkactive,       {\"state\"} },\n     { \"network\",            \"getnodeaddresses\",       &getnodeaddresses,       {\"count\"} },\n+\n+    /* Not shown in help */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r476300109",
      "id" : 476300109,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMwMDEwOQ==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 900,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 474288186,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476300109",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r476300969"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476300969"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: Any reason for this unrelated change? This also violates pep8",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-25T09:12:18Z",
      "diff_hunk" : "@@ -2,62 +2,46 @@\n # Copyright (c) 2019 The Bitcoin Core developers\n # Distributed under the MIT software license, see the accompanying\n # file COPYING or http://www.opensource.org/licenses/mit-license.php.\n-\"\"\"Test p2p blocksonly\"\"\"\n+\"\"\"Test p2p blocksonly mode & block-relay-only connections.\"\"\"\n \n-from test_framework.messages import msg_tx, CTransaction, FromHex\n-from test_framework.mininode import P2PInterface\n+import time\n+\n+from test_framework.blocktools import create_transaction\n+from test_framework.messages import msg_tx\n+from test_framework.mininode import P2PInterface, P2PTxInvStore\n from test_framework.test_framework import BitcoinTestFramework\n from test_framework.util import assert_equal\n \n-",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r476300969",
      "id" : 476300969,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMwMDk2OQ==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 12,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 474288186,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476300969",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r476304181"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476304181"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: Any reason to remove the star? I think keyword args that are simply passed on in python are denoted by `**kwargs` in intermediate function calls in the stack, not by explicitly listing them each. Though, I am not a python expert, so feel free to ignore.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-25T09:17:51Z",
      "diff_hunk" : "@@ -130,7 +134,7 @@ def __init__(self):\n     def is_connected(self):\n         return self._transport is not None\n \n-    def peer_connect(self, dstaddr, dstport, *, net, timeout_factor):\n+    def peer_connect_helper(self, dstaddr, dstport, net, timeout_factor):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r476304181",
      "id" : 476304181,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMwNDE4MQ==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 137,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/mininode.py",
      "position" : null,
      "pull_request_review_id" : 474288186,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476304181",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r476308135"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476308135"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The line times out intermittently: https://cirrus-ci.com/task/5292757864415232?command=ci#L5215\r\n\r\n```\r\n test  2020-08-25T06:50:18.197000Z TestFramework.node0 (DEBUG): RPC successfully started \r\n node0 2020-08-25T06:50:18.198698Z [http] Received a POST request for / from 127.0.0.1:43672 \r\n node0 2020-08-25T06:50:18.199052Z [httpworker.2] ThreadRPCServer method=getnetworkinfo user=__cookie__ \r\n test  2020-08-25T06:50:18.202000Z TestFramework.mininode (DEBUG): Listening for Bitcoin Node: 0: \r\n node0 2020-08-25T06:50:19.011416Z [scheduler] Leaving InitialBlockDownload (latching to false) \r\n node0 2020-08-25T06:51:15.798367Z [scheduler] Feeding 32910 bytes of dynamic environment data into RNG \r\n test  2020-08-25T06:51:18.213000Z TestFramework.utils (ERROR): wait_until() failed. Predicate: '''' \r\n                                           test_function = lambda: self.is_connected\r\n                                   '''\r\n test  2020-08-25T06:51:18.213000Z TestFramework (ERROR): Assertion failed \r\n                                   Traceback (most recent call last):\r\n                                     File \"/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/test/functional/test_framework/test_framework.py\", line 118, in main\r\n                                       self.run_test()\r\n                                     File \"/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/test/functional/p2p_blocksonly.py\", line 26, in run_test\r\n                                       self.blocks_relay_conn_tests()\r\n                                     File \"/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/test/functional/p2p_blocksonly.py\", line 76, in blocks_relay_conn_tests\r\n                                       self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\r\n                                     File \"/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/test/functional/test_framework/test_node.py\", line 561, in add_outbound_p2p_connection\r\n                                       p2p_conn.wait_for_connect()\r\n                                     File \"/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/test/functional/test_framework/mininode.py\", line 422, in wait_for_connect\r\n                                       wait_until(test_function, timeout=timeout, lock=mininode_lock)\r\n                                     File \"/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/test/functional/test_framework/util.py\", line 252, in wait_until\r\n                                       raise AssertionError(\"Predicate {} not true after {} seconds\".format(predicate_source, timeout))\r\n                                   AssertionError: Predicate ''''\r\n                                           test_function = lambda: self.is_connected\r\n                                   ''' not true after 60.0 seconds",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-25T09:24:05Z",
      "diff_hunk" : "@@ -69,18 +53,58 @@ def run_test(self):\n         peer_2_info = self.nodes[0].getpeerinfo()[1]\n         assert_equal(peer_2_info['whitelisted'], True)\n         assert_equal(peer_2_info['permissions'], ['noban', 'forcerelay', 'relay', 'mempool', 'download'])\n-        assert_equal(self.nodes[0].testmempoolaccept([sigtx])[0]['allowed'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n \n         self.log.info('Check that the tx from forcerelay first_peer is relayed to others (ie.second_peer)')\n         with self.nodes[0].assert_debug_log([\"received getdata\"]):\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the forcerelay peer is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Forcerelay peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r476308135",
      "id" : 476308135,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMwODEzNQ==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 81,
      "original_position" : 108,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 474288186,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476308135",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r476310077"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476310077"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ok, it's a bit of a shame to require the wallet to be compiled to run this test. Ideally, I think we'd want just the `wallet_` tests to require the wallet, but we're a long way from that.\r\n\r\nNo need to change this here, but a useful future project would be to eliminate the wallet dependency from the non-wallet tests.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-25T09:27:14Z",
      "diff_hunk" : "@@ -69,18 +49,55 @@ def run_test(self):\n         peer_2_info = self.nodes[0].getpeerinfo()[1]\n         assert_equal(peer_2_info['whitelisted'], True)\n         assert_equal(peer_2_info['permissions'], ['noban', 'forcerelay', 'relay', 'mempool', 'download'])\n-        assert_equal(self.nodes[0].testmempoolaccept([sigtx])[0]['allowed'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n \n         self.log.info('Check that the tx from forcerelay first_peer is relayed to others (ie.second_peer)')\n         with self.nodes[0].assert_debug_log([\"received getdata\"]):\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the forcerelay peer is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Forcerelay peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n+        self.nodes[0].sendrawtransaction(tx_hex)\n+        conn.sync_with_ping()\n+        assert(txid not in conn.get_invs())\n+\n+    def check_p2p_tx_violation(self, index=1):\n+        self.log.info('Check that txs from P2P are rejected and result in disconnect')\n+        input_txid = self.nodes[0].getblock(self.nodes[0].getblockhash(index), 2)['tx'][0]['txid']\n+        tx = create_transaction(self.nodes[0], input_txid, self.nodes[0].getnewaddress(), amount=50 - 0.001)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r476310077",
      "id" : 476310077,
      "in_reply_to_id" : 473866387,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMxMDA3Nw==",
      "original_commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "original_line" : 99,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 474301572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476310077",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for addressing all my comments @amitiuttarwar . Changes look good to me.\r\n\r\nI'll wait until you've resolved the test timeout issue before a full rereview.",
      "created_at" : "2020-08-25T10:18:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-679938150",
      "id" : 679938150,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3OTkzODE1MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-25T10:18:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/679938150",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-08-26T09:02:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-680754912",
      "id" : 680754912,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4MDc1NDkxMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-26T09:02:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/680754912",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r478509021"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478509021"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "For context, it looks like the star forces subsequent arguments to be present and named:\r\n\r\n```\r\ndef foo(a, b, *, c):\r\n    print(a, b, c)\r\n\r\nfoo(1, 2)\r\n# TypeError: foo() missing 1 required keyword-only argument: 'c'\r\n\r\nfoo(1, 2, 3)\r\n# TypeError: foo() takes 2 positional arguments but 3 were given\r\n\r\nfoo(1, 2, c=3)\r\n# 1 2 3\r\n```",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-27T15:32:07Z",
      "diff_hunk" : "@@ -130,7 +134,7 @@ def __init__(self):\n     def is_connected(self):\n         return self._transport is not None\n \n-    def peer_connect(self, dstaddr, dstport, *, net, timeout_factor):\n+    def peer_connect_helper(self, dstaddr, dstport, net, timeout_factor):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r478509021",
      "id" : 478509021,
      "in_reply_to_id" : 476304181,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUwOTAyMQ==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 137,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/mininode.py",
      "position" : null,
      "pull_request_review_id" : 476841303,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478509021",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4276679?v=4",
         "events_url" : "https://api.github.com/users/robot-dreams/events{/privacy}",
         "followers_url" : "https://api.github.com/users/robot-dreams/followers",
         "following_url" : "https://api.github.com/users/robot-dreams/following{/other_user}",
         "gists_url" : "https://api.github.com/users/robot-dreams/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/robot-dreams",
         "id" : 4276679,
         "login" : "robot-dreams",
         "node_id" : "MDQ6VXNlcjQyNzY2Nzk=",
         "organizations_url" : "https://api.github.com/users/robot-dreams/orgs",
         "received_events_url" : "https://api.github.com/users/robot-dreams/received_events",
         "repos_url" : "https://api.github.com/users/robot-dreams/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/robot-dreams/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/robot-dreams/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/robot-dreams"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r478529683"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478529683"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It looks like line 520 above checks `if 'dstport' not in kwargs:`; naive question, would this be needed here as well?",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-27T16:02:32Z",
      "diff_hunk" : "@@ -542,6 +542,30 @@ def add_p2p_connection(self, p2p_conn, *, wait_for_verack=True, **kwargs):\n \n         return p2p_conn\n \n+    def add_outbound_p2p_connection(self, p2p_conn, *, connection_type=\"outbound\", connect_id=0, **kwargs):\n+        \"\"\" Add an outbound p2p connection from node. Either\n+        full-relay(\"outbound\") or block-relay-only(\"blockrelay\") connection.\n+\n+        This method adds the p2p connection to the self.p2ps list and also\n+        returns the connection to the caller.\"\"\"\n+\n+        kwargs['dstport'] = p2p_port(self.index)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r478529683",
      "id" : 478529683,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODUyOTY4Mw==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 552,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : null,
      "pull_request_review_id" : 476841303,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478529683",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4276679?v=4",
         "events_url" : "https://api.github.com/users/robot-dreams/events{/privacy}",
         "followers_url" : "https://api.github.com/users/robot-dreams/followers",
         "following_url" : "https://api.github.com/users/robot-dreams/following{/other_user}",
         "gists_url" : "https://api.github.com/users/robot-dreams/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/robot-dreams",
         "id" : 4276679,
         "login" : "robot-dreams",
         "node_id" : "MDQ6VXNlcjQyNzY2Nzk=",
         "organizations_url" : "https://api.github.com/users/robot-dreams/orgs",
         "received_events_url" : "https://api.github.com/users/robot-dreams/received_events",
         "repos_url" : "https://api.github.com/users/robot-dreams/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/robot-dreams/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/robot-dreams/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/robot-dreams"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r478602722"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478602722"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm not sure if I'm understanding this correctly, but if you have more than `MAX_NODES / 2` nodes, could you get a port conflict?\r\n\r\ne.g. with `MAX_NODES = 12`:\r\n\r\n- Some code for node 7 calls `p2p_port(12 - 7)` here to get a p2p port on the Python side\r\n- Some other code for node 5 calls `p2p_port(5)` to get a p2p port for a `bitcoind` process",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-27T18:06:37Z",
      "diff_hunk" : "@@ -524,6 +551,33 @@ def close(self, timeout=10):\n         # Safe to remove event loop.\n         NetworkThread.network_event_loop = None\n \n+    @classmethod\n+    def listen(cls, p2p, callback, port=None, addr=None, idx=0):\n+        if port is None:\n+            assert idx >= 0 and idx < MAX_NODES\n+            port = p2p_port(MAX_NODES-idx)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r478602722",
      "id" : 478602722,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYwMjcyMg==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 558,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/mininode.py",
      "position" : null,
      "pull_request_review_id" : 476841303,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478602722",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4276679?v=4",
         "events_url" : "https://api.github.com/users/robot-dreams/events{/privacy}",
         "followers_url" : "https://api.github.com/users/robot-dreams/followers",
         "following_url" : "https://api.github.com/users/robot-dreams/following{/other_user}",
         "gists_url" : "https://api.github.com/users/robot-dreams/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/robot-dreams",
         "id" : 4276679,
         "login" : "robot-dreams",
         "node_id" : "MDQ6VXNlcjQyNzY2Nzk=",
         "organizations_url" : "https://api.github.com/users/robot-dreams/orgs",
         "received_events_url" : "https://api.github.com/users/robot-dreams/received_events",
         "repos_url" : "https://api.github.com/users/robot-dreams/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/robot-dreams/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/robot-dreams/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/robot-dreams"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r478611513"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478611513"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I looked into the flaky test a bit.\r\n\r\nLocally, I see this:\r\n\r\n\t2020-08-27T06:35:37.249000Z TestFramework.mininode (DEBUG): Listening for Bitcoin Node: 0:\r\n\t2020-08-27T06:35:37.250000Z TestFramework.mininode (DEBUG): Listening server on 127.0.0.1:15398 should be started\r\n\r\nHowever, in the CI logs, the \"Listening server on ...\" never appears:\r\n\r\n\t2020-08-25T06:50:18.202000Z TestFramework.mininode (DEBUG): Listening for Bitcoin Node: 0: \r\n\t2020-08-25T06:51:18.213000Z TestFramework.utils (ERROR): wait_until() failed.\r\n\t\r\nIt looks like on the CI servers, the `cls.network_event_loop.create_server` call didn't work:\r\n\r\n\tTraceback (most recent call last):\r\n\t  File \"/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/test/functional/test_framework/mininode.py\", line 575, in create_server\r\n\t    listener = await cls.network_event_loop.create_server(cls.peer_listener(addr, port), addr, port)\r\n\t  File \"/usr/lib/python3.8/asyncio/base_events.py\", line 1463, in create_server\r\n\t    raise OSError(err.errno, 'error while attempting '\r\n\tOSError: [Errno 98] error while attempting to bind on address ('127.0.0.1', 15020): address already in use\r\n\r\nUnfortunately, I have **no idea** why this port is already in use on the CI serverâthe CI logs make no other mention of port 15020 before this error.\r\n\r\n- Can we guarantee that port 15020 isn't used by any other processes on the CI server?\r\n- If not, would it make sense to retry the `create_server` with different ports on failure?",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-27T18:22:50Z",
      "diff_hunk" : "@@ -524,6 +551,33 @@ def close(self, timeout=10):\n         # Safe to remove event loop.\n         NetworkThread.network_event_loop = None\n \n+    @classmethod\n+    def listen(cls, p2p, callback, port=None, addr=None, idx=0):\n+        if port is None:\n+            assert idx >= 0 and idx < MAX_NODES\n+            port = p2p_port(MAX_NODES-idx)\n+        if addr is None:\n+            addr = '127.0.0.1'\n+        coroutine = cls.create_server(addr, port, callback, p2p)\n+        cls.network_event_loop.call_soon_threadsafe(cls.network_event_loop.create_task, coroutine)\n+\n+    @classmethod\n+    def peer_listener(cls, addr, port):\n+        def pl():\n+            x = cls.protos.get((addr,port))\n+            cls.protos[(addr,port)] = None\n+            return x\n+        return pl\n+\n+    @classmethod\n+    async def create_server(cls, addr, port, callback, proto):\n+        if (addr, port) not in cls.listeners:\n+            listener = await cls.network_event_loop.create_server(cls.peer_listener(addr, port), addr, port)\n+            logger.debug(\"Listening server on %s:%d should be started\" % (addr, port))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r478611513",
      "id" : 478611513,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODYxMTUxMw==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 576,
      "original_position" : 129,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/mininode.py",
      "position" : null,
      "pull_request_review_id" : 476841303,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478611513",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4276679?v=4",
         "events_url" : "https://api.github.com/users/robot-dreams/events{/privacy}",
         "followers_url" : "https://api.github.com/users/robot-dreams/followers",
         "following_url" : "https://api.github.com/users/robot-dreams/following{/other_user}",
         "gists_url" : "https://api.github.com/users/robot-dreams/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/robot-dreams",
         "id" : 4276679,
         "login" : "robot-dreams",
         "node_id" : "MDQ6VXNlcjQyNzY2Nzk=",
         "organizations_url" : "https://api.github.com/users/robot-dreams/orgs",
         "received_events_url" : "https://api.github.com/users/robot-dreams/received_events",
         "repos_url" : "https://api.github.com/users/robot-dreams/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/robot-dreams/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/robot-dreams/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/robot-dreams"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r478768406"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478768406"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, the `*` forces subsequent params to be specified by keyword not position",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-28T00:38:58Z",
      "diff_hunk" : "@@ -130,7 +134,7 @@ def __init__(self):\n     def is_connected(self):\n         return self._transport is not None\n \n-    def peer_connect(self, dstaddr, dstport, *, net, timeout_factor):\n+    def peer_connect_helper(self, dstaddr, dstport, net, timeout_factor):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r478768406",
      "id" : 478768406,
      "in_reply_to_id" : 476304181,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODc2ODQwNg==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 137,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/mininode.py",
      "position" : null,
      "pull_request_review_id" : 477169941,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478768406",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r479284359"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479284359"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe add a comment here mentioning this is only used for tests? I think it could be confusing without the context (e.g. a newcomer thinking this is how connections are added in general).\r\nI initially thought it should be named `AddTestOutbound` or something but I imagine this could be used for something else in the future, so a comment makes more sense.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-28T13:23:06Z",
      "diff_hunk" : "@@ -288,6 +288,15 @@ class CConnman\n     bool RemoveAddedNode(const std::string& node);\n     std::vector<AddedNodeInfo> GetAddedNodeInfo();\n \n+    /**\n+     * Attempts to open a connection.\n+     *\n+     * @param[in]   address     Address of node to try connecting to\n+     * @param[in]   conn_type   ConnectionType::OUTBOUND or ConnectionType::BLOCK_RELAY\n+     * @return      bool        Returns false if at max connection capacity\n+     */\n+    bool AddConnection(const std::string& address, const ConnectionType conn_type);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r479284359",
      "id" : 479284359,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTI4NDM1OQ==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 356,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 477723783,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479284359",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r479293812"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479293812"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: \"soon\" is pretty vague... Since you're refactoring, maybe edit a little bit like this?\r\n```suggestion\r\n        self.on_connection_send_msg = vt  # Will be sent in connection_made callback\r\n```",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-28T13:33:17Z",
      "diff_hunk" : "@@ -298,18 +310,27 @@ def __init__(self):\n         # The network services received from the peer\n         self.nServices = 0\n \n+    def peer_connect_send_version(self, services):\n+        # Send a version msg\n+        vt = msg_version()\n+        vt.nServices = services\n+        vt.addrTo.ip = self.dstaddr\n+        vt.addrTo.port = self.dstport\n+        vt.addrFrom.ip = \"0.0.0.0\"\n+        vt.addrFrom.port = 0\n+        self.on_connection_send_msg = vt  # Will be sent soon after connection_made",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r479293812",
      "id" : 479293812,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTI5MzgxMg==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 321,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/mininode.py",
      "position" : null,
      "pull_request_review_id" : 477723783,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479293812",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r479303202"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479303202"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "tiny pep nit: remove space before Add\r\nAnd put the closing \"\"\" on a newline",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-28T13:43:22Z",
      "diff_hunk" : "@@ -542,6 +542,30 @@ def add_p2p_connection(self, p2p_conn, *, wait_for_verack=True, **kwargs):\n \n         return p2p_conn\n \n+    def add_outbound_p2p_connection(self, p2p_conn, *, connection_type=\"outbound\", connect_id=0, **kwargs):\n+        \"\"\" Add an outbound p2p connection from node. Either\n+        full-relay(\"outbound\") or block-relay-only(\"blockrelay\") connection.\n+\n+        This method adds the p2p connection to the self.p2ps list and also\n+        returns the connection to the caller.\"\"\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r479303202",
      "id" : 479303202,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTMwMzIwMg==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 550,
      "original_position" : 18,
      "original_start_line" : 546,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : null,
      "pull_request_review_id" : 477723783,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479303202",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r479312039"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479312039"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit\r\n```suggestion\r\n    const bool success = context.connman->AddConnection(address, conn_type);\r\n```",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-28T13:52:45Z",
      "diff_hunk" : "@@ -282,6 +283,61 @@ static UniValue addnode(const JSONRPCRequest& request)\n     return NullUniValue;\n }\n \n+static UniValue addconnection(const JSONRPCRequest& request)\n+{\n+    const RPCHelpMan help{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node (test only)\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connectiontype\", RPCArg::Type::STR, RPCArg::Optional::NO, \"'outbound' or 'blockrelay'\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connectiontype\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+    };\n+\n+    help.Check(request);\n+\n+    if (!Params().IsMockableChain()) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in = request.params[1].get_str();\n+    ConnectionType conn_type{};\n+    if (conn_type_in == \"outbound\") {\n+        conn_type = ConnectionType::OUTBOUND;\n+    } else if (conn_type_in == \"blockrelay\") {\n+        conn_type = ConnectionType::BLOCK_RELAY;\n+    } else {\n+        throw std::runtime_error(help.ToString());\n+    }\n+\n+    NodeContext& context = EnsureNodeContext(request.context);\n+    if (!context.connman) {\n+        throw JSONRPCError(RPC_CLIENT_P2P_DISABLED, \"Error: Peer-to-peer functionality missing or disabled\");\n+    }\n+\n+    bool success = context.connman->AddConnection(address, conn_type);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r479312039",
      "id" : 479312039,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTMxMjAzOQ==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 329,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 477723783,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479312039",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r479312802"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479312802"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "or \r\n```suggestion\r\n    if(!context.connman->AddConnection(address, conn_type))\r\n```",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-28T13:53:33Z",
      "diff_hunk" : "@@ -282,6 +283,61 @@ static UniValue addnode(const JSONRPCRequest& request)\n     return NullUniValue;\n }\n \n+static UniValue addconnection(const JSONRPCRequest& request)\n+{\n+    const RPCHelpMan help{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node (test only)\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connectiontype\", RPCArg::Type::STR, RPCArg::Optional::NO, \"'outbound' or 'blockrelay'\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connectiontype\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+    };\n+\n+    help.Check(request);\n+\n+    if (!Params().IsMockableChain()) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in = request.params[1].get_str();\n+    ConnectionType conn_type{};\n+    if (conn_type_in == \"outbound\") {\n+        conn_type = ConnectionType::OUTBOUND;\n+    } else if (conn_type_in == \"blockrelay\") {\n+        conn_type = ConnectionType::BLOCK_RELAY;\n+    } else {\n+        throw std::runtime_error(help.ToString());\n+    }\n+\n+    NodeContext& context = EnsureNodeContext(request.context);\n+    if (!context.connman) {\n+        throw JSONRPCError(RPC_CLIENT_P2P_DISABLED, \"Error: Peer-to-peer functionality missing or disabled\");\n+    }\n+\n+    bool success = context.connman->AddConnection(address, conn_type);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r479312802",
      "id" : 479312802,
      "in_reply_to_id" : 479312039,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTMxMjgwMg==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 329,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 477723783,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479312802",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r479353496"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479353496"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why is this needed? If the test fails, is it not ok to fail for `sendrawtransaction` validation/mempool reasons?",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-28T14:46:29Z",
      "diff_hunk" : "@@ -69,18 +53,58 @@ def run_test(self):\n         peer_2_info = self.nodes[0].getpeerinfo()[1]\n         assert_equal(peer_2_info['whitelisted'], True)\n         assert_equal(peer_2_info['permissions'], ['noban', 'forcerelay', 'relay', 'mempool', 'download'])\n-        assert_equal(self.nodes[0].testmempoolaccept([sigtx])[0]['allowed'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n \n         self.log.info('Check that the tx from forcerelay first_peer is relayed to others (ie.second_peer)')\n         with self.nodes[0].assert_debug_log([\"received getdata\"]):\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the forcerelay peer is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Forcerelay peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        # bump time forward to ensure nNextInvSend timer pops\n+        self.nodes[0].setmocktime(int(time.time()) + 5)\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r479353496",
      "id" : 479353496,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM1MzQ5Ng==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 91,
      "original_position" : 118,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 477723783,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479353496",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r479354900"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479354900"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is this to clear the mempool?",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-28T14:48:51Z",
      "diff_hunk" : "@@ -69,18 +53,58 @@ def run_test(self):\n         peer_2_info = self.nodes[0].getpeerinfo()[1]\n         assert_equal(peer_2_info['whitelisted'], True)\n         assert_equal(peer_2_info['permissions'], ['noban', 'forcerelay', 'relay', 'mempool', 'download'])\n-        assert_equal(self.nodes[0].testmempoolaccept([sigtx])[0]['allowed'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n \n         self.log.info('Check that the tx from forcerelay first_peer is relayed to others (ie.second_peer)')\n         with self.nodes[0].assert_debug_log([\"received getdata\"]):\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the forcerelay peer is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Forcerelay peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r479354900",
      "id" : 479354900,
      "line" : 73,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM1NDkwMA==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 73,
      "original_position" : 100,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 103,
      "pull_request_review_id" : 477723783,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479354900",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r479358247"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479358247"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: I think `height` would be more clear than `index`",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-08-28T14:54:21Z",
      "diff_hunk" : "@@ -69,18 +53,58 @@ def run_test(self):\n         peer_2_info = self.nodes[0].getpeerinfo()[1]\n         assert_equal(peer_2_info['whitelisted'], True)\n         assert_equal(peer_2_info['permissions'], ['noban', 'forcerelay', 'relay', 'mempool', 'download'])\n-        assert_equal(self.nodes[0].testmempoolaccept([sigtx])[0]['allowed'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n \n         self.log.info('Check that the tx from forcerelay first_peer is relayed to others (ie.second_peer)')\n         with self.nodes[0].assert_debug_log([\"received getdata\"]):\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the forcerelay peer is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Forcerelay peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        # bump time forward to ensure nNextInvSend timer pops\n+        self.nodes[0].setmocktime(int(time.time()) + 5)\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n+        self.nodes[0].sendrawtransaction(tx_hex)\n+        conn.sync_with_ping()\n+        assert(int(txid, 16) not in conn.get_invs())\n+\n+    def check_p2p_tx_violation(self, index=1):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r479358247",
      "id" : 479358247,
      "line" : 100,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM1ODI0Nw==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 100,
      "original_position" : 123,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 130,
      "pull_request_review_id" : 477723783,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479358247",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK\r\n\r\nVery nice to be able to test this extremely important logic. Thanks for doing this!",
      "created_at" : "2020-08-29T01:13:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-683210775",
      "id" : 683210775,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4MzIxMDc3NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-29T01:13:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/683210775",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I've been [looking into](https://github.com/gzhao408/bitcoin/commit/651ef496dbd82e3fffad73e220f51372cf76ca17) the port management stuff to see the limits of how many connections can be opened. Quick [example_test.py](https://github.com/gzhao408/bitcoin/blob/651ef496dbd82e3fffad73e220f51372cf76ca17/test/functional/example_test.py): add 8 outbounds and 2 blockrelays to `nodes[0]` and `nodes[1]` each. This branch fails especially if you don't specify `connect_id` explicitly in `add_outbound_p2p_connection()` - I don't think you can add more than 1 outbound p2p connection because it'll try to reuse the same port. I tinkered with it to make it pass.\r\n\r\nI'm not 100% sure I understand everything correctly but I think the explanation is:\r\n-For inbounds, we care about the `dstaddr`/`dstport` which would be the same for all p2ps connected to one node. i.e. they all have the same destination -> they initiate the connection. So we use 1 port per test node, which is why arg to `p2p_port` needs to within the MAX_NODES range.\r\n-For outbounds, there's no \"destination\" since the p2ps are not initiating the connection. You need each p2p to listen on a different port. I guess the TestNode that's connecting would be called the \"origin\" or something.",
      "created_at" : "2020-08-30T17:00:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-683444413",
      "id" : 683444413,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4MzQ0NDQxMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-30T17:00:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/683444413",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/gzhao408/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gzhao408/followers",
         "following_url" : "https://api.github.com/users/gzhao408/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gzhao408/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gzhao408",
         "id" : 25183001,
         "login" : "gzhao408",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/gzhao408/orgs",
         "received_events_url" : "https://api.github.com/users/gzhao408/received_events",
         "repos_url" : "https://api.github.com/users/gzhao408/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gzhao408/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gzhao408/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gzhao408"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r488821301"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488821301"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Note for the future, I think we could refactor out this code snippet in some accounting type helper. We're computing `nOutboundFullRelay`/`nOutboundBlockRelay` in diverse parts of the codebase, at least after #19858 \r\n\r\nLike returning a struct with an aliased int for each type we have.\r\n```\r\nstruct SetConnectionType {\r\n       int  full_relay;\r\n       int   blocksonly;\r\n       ...\r\n};\r\n\r\nGetConnectionTypeCount()\r\n```",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-09-15T17:00:03Z",
      "diff_hunk" : "@@ -1069,6 +1069,29 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n+bool CConnman::AddConnection(const std::string& address)\n+{\n+    int nOutboundFullRelay = 0;\n+\n+    {\n+        LOCK(cs_vNodes);\n+        for (const CNode* pnode : vNodes) {\n+            if (pnode->m_conn_type == ConnectionType::OUTBOUND) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r488821301",
      "id" : 488821301,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgyMTMwMQ==",
      "original_commit_id" : "07dd3ba792bf25eb7e24833393406f559f68e8fb",
      "original_line" : 1079,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 488885293,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488821301",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r488823128"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488823128"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If understand new test well, could you document the 2 behaviors tested, namely that sender doesn't relay transaction to a block-relay-only peer and that receiver disconnect a block-relay-only peer relaying transaction ?",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-09-15T17:03:18Z",
      "diff_hunk" : "@@ -2,15 +2,16 @@\n # Copyright (c) 2019 The Bitcoin Core developers\n # Distributed under the MIT software license, see the accompanying\n # file COPYING or http://www.opensource.org/licenses/mit-license.php.\n-\"\"\"Test p2p blocksonly\"\"\"\n+\"\"\"Test p2p blocksonly mode & block-relay-only connections.\"\"\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r488823128",
      "id" : 488823128,
      "line" : 5,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODgyMzEyOA==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 5,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 5,
      "pull_request_review_id" : 488885293,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488823128",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2020-09-19T10:59:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-695199099",
      "id" : 695199099,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NTE5OTA5OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-19T10:59:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/695199099",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492403950"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492403950"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I haven't looked too closely at #19800 yet, but I think I should now be able to replace this `create_transaction` call with `miniwallet.send_self_transfer` and remove the wallet dependency? does this sound right? cc @MarcoFalke ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-09-21T23:35:58Z",
      "diff_hunk" : "@@ -69,18 +49,55 @@ def run_test(self):\n         peer_2_info = self.nodes[0].getpeerinfo()[1]\n         assert_equal(peer_2_info['whitelisted'], True)\n         assert_equal(peer_2_info['permissions'], ['noban', 'forcerelay', 'relay', 'mempool', 'download'])\n-        assert_equal(self.nodes[0].testmempoolaccept([sigtx])[0]['allowed'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n \n         self.log.info('Check that the tx from forcerelay first_peer is relayed to others (ie.second_peer)')\n         with self.nodes[0].assert_debug_log([\"received getdata\"]):\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the forcerelay peer is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Forcerelay peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n+        self.nodes[0].sendrawtransaction(tx_hex)\n+        conn.sync_with_ping()\n+        assert(txid not in conn.get_invs())\n+\n+    def check_p2p_tx_violation(self, index=1):\n+        self.log.info('Check that txs from P2P are rejected and result in disconnect')\n+        input_txid = self.nodes[0].getblock(self.nodes[0].getblockhash(index), 2)['tx'][0]['txid']\n+        tx = create_transaction(self.nodes[0], input_txid, self.nodes[0].getnewaddress(), amount=50 - 0.001)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492403950",
      "id" : 492403950,
      "in_reply_to_id" : 473866387,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQwMzk1MA==",
      "original_commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "original_line" : 99,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 493050008,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492403950",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492405564"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492405564"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done! how's it look now? \r\n\r\nq: is there anywhere that captures the current conventions around RPC functions? during original implementation I was looking around, but clearly wasn't able to successfully identify which methods are preferred",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-09-21T23:41:37Z",
      "diff_hunk" : "@@ -282,6 +283,61 @@ static UniValue addnode(const JSONRPCRequest& request)\n     return NullUniValue;\n }\n \n+static UniValue addconnection(const JSONRPCRequest& request)\n+{\n+    const RPCHelpMan help{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node (test only)\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connectiontype\", RPCArg::Type::STR, RPCArg::Optional::NO, \"'outbound' or 'blockrelay'\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connectiontype\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+    };\n+\n+    help.Check(request);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492405564",
      "id" : 492405564,
      "in_reply_to_id" : 476299424,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQwNTU2NA==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 306,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 493051862,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492405564",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492405610"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492405610"
         }
      },
      "author_association" : "MEMBER",
      "body" : "removed ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-09-21T23:41:47Z",
      "diff_hunk" : "@@ -840,7 +896,10 @@ static const CRPCCommand commands[] =\n     { \"network\",            \"clearbanned\",            &clearbanned,            {} },\n     { \"network\",            \"setnetworkactive\",       &setnetworkactive,       {\"state\"} },\n     { \"network\",            \"getnodeaddresses\",       &getnodeaddresses,       {\"count\"} },\n+\n+    /* Not shown in help */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492405610",
      "id" : 492405610,
      "in_reply_to_id" : 476300109,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQwNTYxMA==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 900,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 493051907,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492405610",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492405748"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492405748"
         }
      },
      "author_association" : "MEMBER",
      "body" : "oops, fixed now",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-09-21T23:42:15Z",
      "diff_hunk" : "@@ -2,62 +2,46 @@\n # Copyright (c) 2019 The Bitcoin Core developers\n # Distributed under the MIT software license, see the accompanying\n # file COPYING or http://www.opensource.org/licenses/mit-license.php.\n-\"\"\"Test p2p blocksonly\"\"\"\n+\"\"\"Test p2p blocksonly mode & block-relay-only connections.\"\"\"\n \n-from test_framework.messages import msg_tx, CTransaction, FromHex\n-from test_framework.mininode import P2PInterface\n+import time\n+\n+from test_framework.blocktools import create_transaction\n+from test_framework.messages import msg_tx\n+from test_framework.mininode import P2PInterface, P2PTxInvStore\n from test_framework.test_framework import BitcoinTestFramework\n from test_framework.util import assert_equal\n \n-",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492405748",
      "id" : 492405748,
      "in_reply_to_id" : 476300969,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQwNTc0OA==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 12,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 493052053,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492405748",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492406400"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492406400"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yup, thats why I removed the `*` from the helper. \r\n\r\nalso note that the `*` is still present in the `peer_connect` function, just git is showing the diff since I added the helper. I don't fully understand what's going on here with the `*` on the actual functions though (`peer_connect`, `peer_accept_connection`), so please let me know if I'm missing something / should dig in more. ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-09-21T23:44:32Z",
      "diff_hunk" : "@@ -130,7 +134,7 @@ def __init__(self):\n     def is_connected(self):\n         return self._transport is not None\n \n-    def peer_connect(self, dstaddr, dstport, *, net, timeout_factor):\n+    def peer_connect_helper(self, dstaddr, dstport, net, timeout_factor):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492406400",
      "id" : 492406400,
      "in_reply_to_id" : 476304181,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQwNjQwMA==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 137,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/mininode.py",
      "position" : null,
      "pull_request_review_id" : 493052765,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492406400",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492408256"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492408256"
         }
      },
      "author_association" : "MEMBER",
      "body" : "good point. I actually ended up removing `dstport` and `dstaddr` from the `peer_accept_connection` function signature, because they aren't being set here (we don't know the exact info until the listening server is spun up, which is why we pass a callback through)- so it seems more like a red herring.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-09-21T23:51:24Z",
      "diff_hunk" : "@@ -542,6 +542,30 @@ def add_p2p_connection(self, p2p_conn, *, wait_for_verack=True, **kwargs):\n \n         return p2p_conn\n \n+    def add_outbound_p2p_connection(self, p2p_conn, *, connection_type=\"outbound\", connect_id=0, **kwargs):\n+        \"\"\" Add an outbound p2p connection from node. Either\n+        full-relay(\"outbound\") or block-relay-only(\"blockrelay\") connection.\n+\n+        This method adds the p2p connection to the self.p2ps list and also\n+        returns the connection to the caller.\"\"\"\n+\n+        kwargs['dstport'] = p2p_port(self.index)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492408256",
      "id" : 492408256,
      "in_reply_to_id" : 478529683,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQwODI1Ng==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 552,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : null,
      "pull_request_review_id" : 493054871,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492408256",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492414635"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492414635"
         }
      },
      "author_association" : "MEMBER",
      "body" : "great question! however, I don't _think_ this is a problem. here's why: the `p2p_port` function in `util.py` calculates in a few different factors, one of which is the `PortSeed.n`, which is set by the `BitcoinTestFramework`. It either explicitly sets this value or defaults to the process id, which would be different for each test. so I think this would only cause a conflict if there are conflicting uses within the same test. (but I very much welcome a double check- this stuff is CONFUSING!)",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-09-22T00:15:03Z",
      "diff_hunk" : "@@ -524,6 +551,33 @@ def close(self, timeout=10):\n         # Safe to remove event loop.\n         NetworkThread.network_event_loop = None\n \n+    @classmethod\n+    def listen(cls, p2p, callback, port=None, addr=None, idx=0):\n+        if port is None:\n+            assert idx >= 0 and idx < MAX_NODES\n+            port = p2p_port(MAX_NODES-idx)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492414635",
      "id" : 492414635,
      "in_reply_to_id" : 478602722,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxNDYzNQ==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 558,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/mininode.py",
      "position" : null,
      "pull_request_review_id" : 493061764,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492414635",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492419398"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492419398"
         }
      },
      "author_association" : "MEMBER",
      "body" : "thank you very much for looking into the flaky test :) you are a brave soul! hahaha\r\n\r\nwith ~some~ a lot of help from @ajtowns, my best understanding of what was probably happening here is an off-by-one error. the port allocation is intended to have 12 unique slots for each test, allowing test runner to run multiple tests in parallel. previously, the idx was starting at 0, so p2p_port was being passed (MAX_NODES), which could lead to a port conflict with another test. to fix it, I'm starting the idx at 1 & have added the validations to check the proper range. let's see how CI does ð¤ð½\r\n\r\nto be more specific, the port conflict I'm referring to would occur if a test had pid `x` and invoked `p2p_port(12)`, and the next test had pid `x+1` and invoked `p2p_port(0)`. ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-09-22T00:35:02Z",
      "diff_hunk" : "@@ -524,6 +551,33 @@ def close(self, timeout=10):\n         # Safe to remove event loop.\n         NetworkThread.network_event_loop = None\n \n+    @classmethod\n+    def listen(cls, p2p, callback, port=None, addr=None, idx=0):\n+        if port is None:\n+            assert idx >= 0 and idx < MAX_NODES\n+            port = p2p_port(MAX_NODES-idx)\n+        if addr is None:\n+            addr = '127.0.0.1'\n+        coroutine = cls.create_server(addr, port, callback, p2p)\n+        cls.network_event_loop.call_soon_threadsafe(cls.network_event_loop.create_task, coroutine)\n+\n+    @classmethod\n+    def peer_listener(cls, addr, port):\n+        def pl():\n+            x = cls.protos.get((addr,port))\n+            cls.protos[(addr,port)] = None\n+            return x\n+        return pl\n+\n+    @classmethod\n+    async def create_server(cls, addr, port, callback, proto):\n+        if (addr, port) not in cls.listeners:\n+            listener = await cls.network_event_loop.create_server(cls.peer_listener(addr, port), addr, port)\n+            logger.debug(\"Listening server on %s:%d should be started\" % (addr, port))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492419398",
      "id" : 492419398,
      "in_reply_to_id" : 478611513,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxOTM5OA==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 576,
      "original_position" : 129,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/mininode.py",
      "position" : null,
      "pull_request_review_id" : 493066784,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492419398",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492419476"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492419476"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-09-22T00:35:26Z",
      "diff_hunk" : "@@ -288,6 +288,15 @@ class CConnman\n     bool RemoveAddedNode(const std::string& node);\n     std::vector<AddedNodeInfo> GetAddedNodeInfo();\n \n+    /**\n+     * Attempts to open a connection.\n+     *\n+     * @param[in]   address     Address of node to try connecting to\n+     * @param[in]   conn_type   ConnectionType::OUTBOUND or ConnectionType::BLOCK_RELAY\n+     * @return      bool        Returns false if at max connection capacity\n+     */\n+    bool AddConnection(const std::string& address, const ConnectionType conn_type);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492419476",
      "id" : 492419476,
      "in_reply_to_id" : 479284359,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxOTQ3Ng==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 356,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 493066866,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492419476",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492419538"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492419538"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-09-22T00:35:43Z",
      "diff_hunk" : "@@ -298,18 +310,27 @@ def __init__(self):\n         # The network services received from the peer\n         self.nServices = 0\n \n+    def peer_connect_send_version(self, services):\n+        # Send a version msg\n+        vt = msg_version()\n+        vt.nServices = services\n+        vt.addrTo.ip = self.dstaddr\n+        vt.addrTo.port = self.dstport\n+        vt.addrFrom.ip = \"0.0.0.0\"\n+        vt.addrFrom.port = 0\n+        self.on_connection_send_msg = vt  # Will be sent soon after connection_made",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492419538",
      "id" : 492419538,
      "in_reply_to_id" : 479293812,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxOTUzOA==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 321,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/mininode.py",
      "position" : null,
      "pull_request_review_id" : 493066942,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492419538",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492419934"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492419934"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done\r\n\r\nTIL about the closing \"\"\" on a newline. looks like quite a lot of our docstrings don't follow this convention ð",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-09-22T00:37:26Z",
      "diff_hunk" : "@@ -542,6 +542,30 @@ def add_p2p_connection(self, p2p_conn, *, wait_for_verack=True, **kwargs):\n \n         return p2p_conn\n \n+    def add_outbound_p2p_connection(self, p2p_conn, *, connection_type=\"outbound\", connect_id=0, **kwargs):\n+        \"\"\" Add an outbound p2p connection from node. Either\n+        full-relay(\"outbound\") or block-relay-only(\"blockrelay\") connection.\n+\n+        This method adds the p2p connection to the self.p2ps list and also\n+        returns the connection to the caller.\"\"\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492419934",
      "id" : 492419934,
      "in_reply_to_id" : 479303202,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQxOTkzNA==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 550,
      "original_position" : 18,
      "original_start_line" : 546,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : null,
      "pull_request_review_id" : 493067399,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492419934",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492421394"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492421394"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yeah, I know I could inline but I separated it into its own variable in an attempt to emphasize that this is where the actual work happens since it gets compiled out anyways. so I don't think the `const` does anything, but I threw it in there anyways",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-09-22T00:43:48Z",
      "diff_hunk" : "@@ -282,6 +283,61 @@ static UniValue addnode(const JSONRPCRequest& request)\n     return NullUniValue;\n }\n \n+static UniValue addconnection(const JSONRPCRequest& request)\n+{\n+    const RPCHelpMan help{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node (test only)\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connectiontype\", RPCArg::Type::STR, RPCArg::Optional::NO, \"'outbound' or 'blockrelay'\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connectiontype\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+    };\n+\n+    help.Check(request);\n+\n+    if (!Params().IsMockableChain()) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in = request.params[1].get_str();\n+    ConnectionType conn_type{};\n+    if (conn_type_in == \"outbound\") {\n+        conn_type = ConnectionType::OUTBOUND;\n+    } else if (conn_type_in == \"blockrelay\") {\n+        conn_type = ConnectionType::BLOCK_RELAY;\n+    } else {\n+        throw std::runtime_error(help.ToString());\n+    }\n+\n+    NodeContext& context = EnsureNodeContext(request.context);\n+    if (!context.connman) {\n+        throw JSONRPCError(RPC_CLIENT_P2P_DISABLED, \"Error: Peer-to-peer functionality missing or disabled\");\n+    }\n+\n+    bool success = context.connman->AddConnection(address, conn_type);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492421394",
      "id" : 492421394,
      "in_reply_to_id" : 479312039,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQyMTM5NA==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 329,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 493068983,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492421394",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492421519"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492421519"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yup, resetting to clean state for next test",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-09-22T00:44:19Z",
      "diff_hunk" : "@@ -69,18 +53,58 @@ def run_test(self):\n         peer_2_info = self.nodes[0].getpeerinfo()[1]\n         assert_equal(peer_2_info['whitelisted'], True)\n         assert_equal(peer_2_info['permissions'], ['noban', 'forcerelay', 'relay', 'mempool', 'download'])\n-        assert_equal(self.nodes[0].testmempoolaccept([sigtx])[0]['allowed'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n \n         self.log.info('Check that the tx from forcerelay first_peer is relayed to others (ie.second_peer)')\n         with self.nodes[0].assert_debug_log([\"received getdata\"]):\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the forcerelay peer is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Forcerelay peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492421519",
      "id" : 492421519,
      "in_reply_to_id" : 479354900,
      "line" : 73,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQyMTUxOQ==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 73,
      "original_position" : 100,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 103,
      "pull_request_review_id" : 493069106,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492421519",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492421829"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492421829"
         }
      },
      "author_association" : "MEMBER",
      "body" : "thanks but I'm a pass. its true that this number is used for block height, but I think index is more accurate to what's passed in, and height is how the index is used",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-09-22T00:45:40Z",
      "diff_hunk" : "@@ -69,18 +53,58 @@ def run_test(self):\n         peer_2_info = self.nodes[0].getpeerinfo()[1]\n         assert_equal(peer_2_info['whitelisted'], True)\n         assert_equal(peer_2_info['permissions'], ['noban', 'forcerelay', 'relay', 'mempool', 'download'])\n-        assert_equal(self.nodes[0].testmempoolaccept([sigtx])[0]['allowed'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n \n         self.log.info('Check that the tx from forcerelay first_peer is relayed to others (ie.second_peer)')\n         with self.nodes[0].assert_debug_log([\"received getdata\"]):\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the forcerelay peer is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Forcerelay peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        # bump time forward to ensure nNextInvSend timer pops\n+        self.nodes[0].setmocktime(int(time.time()) + 5)\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n+        self.nodes[0].sendrawtransaction(tx_hex)\n+        conn.sync_with_ping()\n+        assert(int(txid, 16) not in conn.get_invs())\n+\n+    def check_p2p_tx_violation(self, index=1):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492421829",
      "id" : 492421829,
      "in_reply_to_id" : 479358247,
      "line" : 100,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQyMTgyOQ==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 100,
      "original_position" : 123,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 130,
      "pull_request_review_id" : 493069429,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492421829",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492422923"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492422923"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't really understand this question- the test is essentially checking that there is a well formed transaction, submits it to the node, then checks if the p2p connection received the transaction. the goal is to isolate (as much as possible) the reason the conn didn't receive the transaction is due to being a block-relay-only connection.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-09-22T00:50:10Z",
      "diff_hunk" : "@@ -69,18 +53,58 @@ def run_test(self):\n         peer_2_info = self.nodes[0].getpeerinfo()[1]\n         assert_equal(peer_2_info['whitelisted'], True)\n         assert_equal(peer_2_info['permissions'], ['noban', 'forcerelay', 'relay', 'mempool', 'download'])\n-        assert_equal(self.nodes[0].testmempoolaccept([sigtx])[0]['allowed'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n \n         self.log.info('Check that the tx from forcerelay first_peer is relayed to others (ie.second_peer)')\n         with self.nodes[0].assert_debug_log([\"received getdata\"]):\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the forcerelay peer is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Forcerelay peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        # bump time forward to ensure nNextInvSend timer pops\n+        self.nodes[0].setmocktime(int(time.time()) + 5)\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492422923",
      "id" : 492422923,
      "in_reply_to_id" : 479353496,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQyMjkyMw==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 91,
      "original_position" : 118,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 493070575,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492422923",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492424295"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492424295"
         }
      },
      "author_association" : "MEMBER",
      "body" : "sounds good for a future PR ðð½\r\n\r\ngoing to resolve this conversation to keep the review comments focused on these changes ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-09-22T00:55:45Z",
      "diff_hunk" : "@@ -1069,6 +1069,29 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n+bool CConnman::AddConnection(const std::string& address)\n+{\n+    int nOutboundFullRelay = 0;\n+\n+    {\n+        LOCK(cs_vNodes);\n+        for (const CNode* pnode : vNodes) {\n+            if (pnode->m_conn_type == ConnectionType::OUTBOUND) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492424295",
      "id" : 492424295,
      "in_reply_to_id" : 488821301,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQyNDI5NQ==",
      "original_commit_id" : "07dd3ba792bf25eb7e24833393406f559f68e8fb",
      "original_line" : 1079,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 493071925,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492424295",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492426039"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492426039"
         }
      },
      "author_association" : "MEMBER",
      "body" : "hm, yeah those are the main behavioral checks for the block-relay-only connection, but there are also tests for blocks-only mode. the checks seem pretty well documented in the test logs (`self.log.info`), is there a particular reason you'd find them helpful here as well? ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-09-22T01:03:51Z",
      "diff_hunk" : "@@ -2,15 +2,16 @@\n # Copyright (c) 2019 The Bitcoin Core developers\n # Distributed under the MIT software license, see the accompanying\n # file COPYING or http://www.opensource.org/licenses/mit-license.php.\n-\"\"\"Test p2p blocksonly\"\"\"\n+\"\"\"Test p2p blocksonly mode & block-relay-only connections.\"\"\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492426039",
      "id" : 492426039,
      "in_reply_to_id" : 488823128,
      "line" : 5,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjQyNjAzOQ==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 5,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 5,
      "pull_request_review_id" : 493073850,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492426039",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "thank you for all of this awesome feedback! ðð½\r\n\r\nand CI is green! ðð¼  \r\nthis PR is ready for the next round of review :) \r\n\r\nsome updates since last time: \r\n- rebased onto master \r\n- reworked the port logic (as described [here](https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492419398)) \r\n- removed the `dstport` and `dstaddr` from `add_outbound_p2p_connection` & `peer_accept_connection` flow. It wasn't actually being set there because we don't know the port until its assigned in `NetworkThread.listen`, so this felt misleading.\r\n- added logic so `add_outbound_p2p_connection` is maintaining the connection index rather than requiring tests to manually manage.\r\n- added a test `p2p_add_connections` that sanity checks the behaviors of the test framework functionality \r\n\r\nopen questions / next steps: \r\n- RE `dstport` & `dstaddr`: right now, there is some awkward logging in `P2PConnection#connection_made`. Since `dstaddr` and `dstport` aren't able to be properly populated, if you run the tests you see `Connected & Listening: 0:0`. One option is to just have the logging behind an if statement that checks if there is a real value there, but I'd prefer a cleaner solution. I'll continue looking at it, but welcome any review suggestions. @MarcoFalke seems like you introduced these methods, do you have any ideas? \r\n\r\n- RE managing the connection index: I currently have added a `p2p_conn_index` field to `TestNode` to allow it to manage the index of various connections. I find it nicer for the test to not have to worry about keeping track & passing through the correct value. However, in an offline conversation with @ajtowns he expressed the preference towards having it be explicit, in favor of transparency and easier-to-debug failure scenarios. I'm curious what others think. I'm happy to switch back to tests managing index if that's preferable. \r\n\r\n- currently unsupported use case: with the node managing the index via a simple increment, there isn't the ability to reconnect to the same, existing P2P connection. two options for fixing this are 1. have test manage index as mentioned in previous bullet point, or 2. allow optionally passing through the index to `add_outbound_p2p_connection` for that circumstance. I don't currently have any examples of why we'd need to do this, so I've been more focused on getting the base cases working, but wanted to mention incase I should reprioritize / incorporate. \r\n\r\n- documentation: this stuff is complex. I've spent a long while trying to wrap my head around the mechanisms, and have to revisit often to really understand. I'm working on adding more documentation to hopefully make these code paths simpler to understand. \r\n\r\n",
      "created_at" : "2020-09-22T01:57:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-696470826",
      "id" : 696470826,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NjQ3MDgyNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-22T02:59:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/696470826",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492821017"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492821017"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> does this sound right? cc @MarcoFalke\r\n\r\nno idea ;)\r\n\r\nJust try it and let me know if you run into any problems. If there are bugs in miniwallet, feel free to fix them along the way.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-09-22T15:16:42Z",
      "diff_hunk" : "@@ -69,18 +49,55 @@ def run_test(self):\n         peer_2_info = self.nodes[0].getpeerinfo()[1]\n         assert_equal(peer_2_info['whitelisted'], True)\n         assert_equal(peer_2_info['permissions'], ['noban', 'forcerelay', 'relay', 'mempool', 'download'])\n-        assert_equal(self.nodes[0].testmempoolaccept([sigtx])[0]['allowed'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n \n         self.log.info('Check that the tx from forcerelay first_peer is relayed to others (ie.second_peer)')\n         with self.nodes[0].assert_debug_log([\"received getdata\"]):\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the forcerelay peer is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Forcerelay peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n+        self.nodes[0].sendrawtransaction(tx_hex)\n+        conn.sync_with_ping()\n+        assert(txid not in conn.get_invs())\n+\n+    def check_p2p_tx_violation(self, index=1):\n+        self.log.info('Check that txs from P2P are rejected and result in disconnect')\n+        input_txid = self.nodes[0].getblock(self.nodes[0].getblockhash(index), 2)['tx'][0]['txid']\n+        tx = create_transaction(self.nodes[0], input_txid, self.nodes[0].getnewaddress(), amount=50 - 0.001)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r492821017",
      "id" : 492821017,
      "in_reply_to_id" : 473866387,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgyMTAxNw==",
      "original_commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "original_line" : 99,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 493575352,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/492821017",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-22T21:23:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-696989776",
      "id" : 696989776,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5Njk4OTc3Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-22T21:23:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/696989776",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-23T18:21:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-697833357",
      "id" : 697833357,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NzgzMzM1Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-23T18:21:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/697833357",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-25T14:11:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-698952206",
      "id" : 698952206,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5ODk1MjIwNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-25T14:11:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/698952206",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r495517956"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/495517956"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hm, I guess I found it odd because `sendrawtransaction` will throw a JSONRPCError if validation fails just like `testmempoolaccept` would return False. I don't think they'd have different results unless mempool changes in between calls or something. So it seems like something unnecessary that the test needs to pass. It doesn't make the test incorrect or anything ofc, just seemed peculiar",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-09-27T02:27:51Z",
      "diff_hunk" : "@@ -69,18 +53,58 @@ def run_test(self):\n         peer_2_info = self.nodes[0].getpeerinfo()[1]\n         assert_equal(peer_2_info['whitelisted'], True)\n         assert_equal(peer_2_info['permissions'], ['noban', 'forcerelay', 'relay', 'mempool', 'download'])\n-        assert_equal(self.nodes[0].testmempoolaccept([sigtx])[0]['allowed'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n \n         self.log.info('Check that the tx from forcerelay first_peer is relayed to others (ie.second_peer)')\n         with self.nodes[0].assert_debug_log([\"received getdata\"]):\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the forcerelay peer is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Forcerelay peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        # bump time forward to ensure nNextInvSend timer pops\n+        self.nodes[0].setmocktime(int(time.time()) + 5)\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r495517956",
      "id" : 495517956,
      "in_reply_to_id" : 479353496,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUxNzk1Ng==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 91,
      "original_position" : 118,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 497044375,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/495517956",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r495600743"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/495600743"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "When I change this from 2 to 3 I won't get an RPC error (\"at capacity for connection type\") as I would have expected, but an \"address in use\" OSError from the python asyncio. Would it be possible to have some tolerance here, so that the node behavior at maximum outbound connections can be tested?",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-09-27T18:27:11Z",
      "diff_hunk" : "@@ -0,0 +1,94 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal, disconnect_nodes\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        disconnect_nodes(self.nodes[0], 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r495600743",
      "id" : 495600743,
      "line" : 34,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTYwMDc0Mw==",
      "original_commit_id" : "b489886b533809c9a4ee2643ceba7d34c278e03e",
      "original_line" : 34,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : 34,
      "pull_request_review_id" : 497100606,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/495600743",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r497199834"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/497199834"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ð¤ good question. I expected there to be some room because we allow 12 `MAX_NODES` and here we are using 10 of those ports, but indeed, I get the same issue. somehow that port is already being used, but I don't understand by what. its none of the other connections. I'll continue digging in. \r\n\r\nbut will note that we can check the bounds of each type if they came first. eg. by adding 9 full-relay outbounds in previous loop, or adding 3 block-relay outbounds in the loop on line 33 (which come before the full relay for that node)",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-09-30T01:54:35Z",
      "diff_hunk" : "@@ -0,0 +1,94 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal, disconnect_nodes\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        disconnect_nodes(self.nodes[0], 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r497199834",
      "id" : 497199834,
      "in_reply_to_id" : 495600743,
      "line" : 34,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE5OTgzNA==",
      "original_commit_id" : "b489886b533809c9a4ee2643ceba7d34c278e03e",
      "original_line" : 34,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : 34,
      "pull_request_review_id" : 499035278,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/497199834",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@mzumsande, thanks for taking a look :)  \r\n> I already used this some days ago for testing some outbound getaddr behavior, and it worked great!\r\n\r\nthats so awesome!! would it be a test we can permanently introduce with this patch? ",
      "created_at" : "2020-09-30T01:55:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-701112240",
      "id" : 701112240,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwMTExMjI0MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-30T01:55:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/701112240",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> thats so awesome!! would it be a test we can permanently introduce with this patch?\r\n\r\nI think it would best be one of (hopefully several) follow-ups, using the new possibilities introduced by this PR!",
      "created_at" : "2020-09-30T18:39:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-701571168",
      "id" : 701571168,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwMTU3MTE2OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-30T18:39:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/701571168",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r499484755"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499484755"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0958cbc7211b04e537b3742abd34213023196900\r\n\r\nCould add EOL and follow the current wording:\r\n```suggestion\r\n        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\r\n```\r\n?",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-10-05T10:04:20Z",
      "diff_hunk" : "@@ -296,6 +297,49 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node (test only)\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r499484755",
      "id" : 499484755,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQ4NDc1NQ==",
      "original_commit_id" : "0958cbc7211b04e537b3742abd34213023196900",
      "original_line" : 303,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 501903744,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499484755",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r499494832"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499494832"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0958cbc7211b04e537b3742abd34213023196900\r\nnit: It seems readability could be better w/o this empty line, no?",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-10-05T10:23:04Z",
      "diff_hunk" : "@@ -296,6 +297,49 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node (test only)\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r499494832",
      "id" : 499494832,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQ5NDgzMg==",
      "original_commit_id" : "0958cbc7211b04e537b3742abd34213023196900",
      "original_line" : 317,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 501903744,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499494832",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r499499590"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499499590"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0958cbc7211b04e537b3742abd34213023196900\r\n```suggestion\r\n    RPCTypeCheckArgument(request.params[0], UniValue::VSTR);\r\n```\r\n\r\nI know, that this LOC is changed in the next commit, but this commit is broken in its current state.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-10-05T10:31:27Z",
      "diff_hunk" : "@@ -296,6 +297,49 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node (test only)\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+\n+{\n+    if (!Params().IsMockableChain()) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only\");\n+    }\n+\n+    RPCTypeCheckArgument(request.params, UniValue::VSTR);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r499499590",
      "id" : 499499590,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQ5OTU5MA==",
      "original_commit_id" : "0958cbc7211b04e537b3742abd34213023196900",
      "original_line" : 323,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 501903744,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499499590",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r499503110"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499503110"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0958cbc7211b04e537b3742abd34213023196900\r\nMind being consistent about full stops at the end of the error messages :)",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-10-05T10:38:20Z",
      "diff_hunk" : "@@ -296,6 +297,49 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node (test only)\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+\n+{\n+    if (!Params().IsMockableChain()) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only\");\n+    }\n+\n+    RPCTypeCheckArgument(request.params, UniValue::VSTR);\n+    const std::string address = request.params[0].get_str();\n+    NodeContext& context = EnsureNodeContext(request.context);\n+    if (!context.connman) {\n+        throw JSONRPCError(RPC_CLIENT_P2P_DISABLED, \"Error: Peer-to-peer functionality missing or disabled\");\n+    }\n+\n+    const bool success = context.connman->AddConnection(address);\n+    if (!success) {\n+        throw JSONRPCError(RPC_CLIENT_NODE_CAPACITY_REACHED, \"Error: Max number of outbound full relay connections already open.\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r499503110",
      "id" : 499503110,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUwMzExMA==",
      "original_commit_id" : "0958cbc7211b04e537b3742abd34213023196900",
      "original_line" : 332,
      "original_position" : 44,
      "original_start_line" : 327,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 501903744,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499503110",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r499510944"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499510944"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0958cbc7211b04e537b3742abd34213023196900\r\nMind following naming convention?\r\n```suggestion\r\n    int outbound_full_relay = 0;\r\n```",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-10-05T10:54:09Z",
      "diff_hunk" : "@@ -1080,6 +1080,29 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n+bool CConnman::AddConnection(const std::string& address)\n+{\n+    int nOutboundFullRelay = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r499510944",
      "id" : 499510944,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUxMDk0NA==",
      "original_commit_id" : "0958cbc7211b04e537b3742abd34213023196900",
      "original_line" : 1085,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 501903744,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499510944",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r499511188"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499511188"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0958cbc7211b04e537b3742abd34213023196900\r\n```suggestion\r\n    OpenNetworkConnection(CAddress(), false, &grant, address.c_str(), ConnectionType::OUTBOUND_FULL_RELAY);\r\n```",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-10-05T10:54:39Z",
      "diff_hunk" : "@@ -1080,6 +1080,29 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n+bool CConnman::AddConnection(const std::string& address)\n+{\n+    int nOutboundFullRelay = 0;\n+\n+    {\n+        LOCK(cs_vNodes);\n+        for (const CNode* pnode : vNodes) {\n+            if (pnode->m_conn_type == ConnectionType::OUTBOUND_FULL_RELAY) {\n+                ++nOutboundFullRelay;\n+            }\n+        }\n+    }\n+\n+    if (nOutboundFullRelay >= m_max_outbound_full_relay) return false;\n+\n+    CSemaphoreGrant grant(*semOutbound, true);\n+    if (!grant) return false;\n+\n+    CAddress addr{};\n+    OpenNetworkConnection(addr, false, &grant, address.c_str(), ConnectionType::OUTBOUND_FULL_RELAY);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r499511188",
      "id" : 499511188,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUxMTE4OA==",
      "original_commit_id" : "0958cbc7211b04e537b3742abd34213023196900",
      "original_line" : 1102,
      "original_position" : 23,
      "original_start_line" : 1101,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 501903744,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499511188",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r499512363"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499512363"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0fb4635bbabb1bea10a215bde4c803ceb5bc5f26\r\nMind following naming convention?\r\n```suggestion\r\n    int outbound_block_relay = 0;\r\n```",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-10-05T10:56:55Z",
      "diff_hunk" : "@@ -1080,26 +1080,35 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n-bool CConnman::AddConnection(const std::string& address)\n+bool CConnman::AddConnection(const std::string& address, const ConnectionType conn_type)\n {\n+    assert(conn_type == ConnectionType::OUTBOUND_FULL_RELAY || conn_type == ConnectionType::BLOCK_RELAY);\n+\n     int nOutboundFullRelay = 0;\n+    int nOutboundBlockRelay = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r499512363",
      "id" : 499512363,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUxMjM2Mw==",
      "original_commit_id" : "0fb4635bbabb1bea10a215bde4c803ceb5bc5f26",
      "original_line" : 1088,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 501903744,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499512363",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r499515798"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499515798"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0fb4635bbabb1bea10a215bde4c803ceb5bc5f26\r\nWhy not keep consistency about full stops at the end of argument descriptions?",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-10-05T11:03:46Z",
      "diff_hunk" : "@@ -303,15 +303,17 @@ static RPCHelpMan addconnection()\n         \"\\nOpen an outbound connection to a specified node (test only)\",\n         {\n             {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connectiontype\", RPCArg::Type::STR, RPCArg::Optional::NO, \"'outbound' or 'blockrelay'\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r499515798",
      "id" : 499515798,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUxNTc5OA==",
      "original_commit_id" : "0fb4635bbabb1bea10a215bde4c803ceb5bc5f26",
      "original_line" : 306,
      "original_position" : 4,
      "original_start_line" : 305,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 501903744,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499515798",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r499519175"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499519175"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0fb4635bbabb1bea10a215bde4c803ceb5bc5f26\r\nDoes this error message describe not having `grant` in the `AddConnection` function?",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-10-05T11:10:28Z",
      "diff_hunk" : "@@ -320,20 +322,31 @@ static RPCHelpMan addconnection()\n         throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only\");\n     }\n \n-    RPCTypeCheckArgument(request.params, UniValue::VSTR);\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n     const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in = request.params[1].get_str();\n+    ConnectionType conn_type{};\n+    if (conn_type_in == \"outbound\") {\n+        conn_type = ConnectionType::OUTBOUND_FULL_RELAY;\n+    } else if (conn_type_in == \"blockrelay\") {\n+        conn_type = ConnectionType::BLOCK_RELAY;\n+    } else {\n+        throw std::runtime_error(self.ToString());\n+    }\n+\n     NodeContext& context = EnsureNodeContext(request.context);\n     if (!context.connman) {\n         throw JSONRPCError(RPC_CLIENT_P2P_DISABLED, \"Error: Peer-to-peer functionality missing or disabled\");\n     }\n \n-    const bool success = context.connman->AddConnection(address);\n+    const bool success = context.connman->AddConnection(address, conn_type);\n     if (!success) {\n-        throw JSONRPCError(RPC_CLIENT_NODE_CAPACITY_REACHED, \"Error: Max number of outbound full relay connections already open.\");\n+        throw JSONRPCError(RPC_CLIENT_NODE_CAPACITY_REACHED, \"Error: Already at capacity for specified connection type.\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r499519175",
      "id" : 499519175,
      "line" : 361,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUxOTE3NQ==",
      "original_commit_id" : "0fb4635bbabb1bea10a215bde4c803ceb5bc5f26",
      "original_line" : 361,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 55,
      "pull_request_review_id" : 501903744,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/499519175",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-10-11T02:23:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-706639465",
      "id" : 706639465,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwNjYzOTQ2NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-11T02:23:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/706639465",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r502860553"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/502860553"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "2 bitcoin nodes, 8 full relay outbounds, and 2 blocks-only outbounds fills up the `MAX_NODES==12` ports",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-10-11T03:38:39Z",
      "diff_hunk" : "@@ -0,0 +1,94 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal, disconnect_nodes\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        disconnect_nodes(self.nodes[0], 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r502860553",
      "id" : 502860553,
      "in_reply_to_id" : 495600743,
      "line" : 34,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjg2MDU1Mw==",
      "original_commit_id" : "b489886b533809c9a4ee2643ceba7d34c278e03e",
      "original_line" : 34,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : 34,
      "pull_request_review_id" : 506141031,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/502860553",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r513158022"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/513158022"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-10-28T03:27:29Z",
      "diff_hunk" : "@@ -296,6 +297,49 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node (test only)\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r513158022",
      "id" : 513158022,
      "in_reply_to_id" : 499484755,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE1ODAyMg==",
      "original_commit_id" : "0958cbc7211b04e537b3742abd34213023196900",
      "original_line" : 303,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 518298927,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/513158022",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r513161239"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/513161239"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-10-28T03:39:39Z",
      "diff_hunk" : "@@ -296,6 +297,49 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node (test only)\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r513161239",
      "id" : 513161239,
      "in_reply_to_id" : 499494832,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE2MTIzOQ==",
      "original_commit_id" : "0958cbc7211b04e537b3742abd34213023196900",
      "original_line" : 317,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 518302339,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/513161239",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r513161268"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/513161268"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed (by squashing the two commits) ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-10-28T03:39:46Z",
      "diff_hunk" : "@@ -296,6 +297,49 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node (test only)\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+\n+{\n+    if (!Params().IsMockableChain()) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only\");\n+    }\n+\n+    RPCTypeCheckArgument(request.params, UniValue::VSTR);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r513161268",
      "id" : 513161268,
      "in_reply_to_id" : 499499590,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE2MTI2OA==",
      "original_commit_id" : "0958cbc7211b04e537b3742abd34213023196900",
      "original_line" : 323,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 518302366,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/513161268",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r513164838"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/513164838"
         }
      },
      "author_association" : "MEMBER",
      "body" : "okay I think I got them all =P ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-10-28T03:52:45Z",
      "diff_hunk" : "@@ -296,6 +297,49 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node (test only)\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+\n+{\n+    if (!Params().IsMockableChain()) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only\");\n+    }\n+\n+    RPCTypeCheckArgument(request.params, UniValue::VSTR);\n+    const std::string address = request.params[0].get_str();\n+    NodeContext& context = EnsureNodeContext(request.context);\n+    if (!context.connman) {\n+        throw JSONRPCError(RPC_CLIENT_P2P_DISABLED, \"Error: Peer-to-peer functionality missing or disabled\");\n+    }\n+\n+    const bool success = context.connman->AddConnection(address);\n+    if (!success) {\n+        throw JSONRPCError(RPC_CLIENT_NODE_CAPACITY_REACHED, \"Error: Max number of outbound full relay connections already open.\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r513164838",
      "id" : 513164838,
      "in_reply_to_id" : 499503110,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE2NDgzOA==",
      "original_commit_id" : "0958cbc7211b04e537b3742abd34213023196900",
      "original_line" : 332,
      "original_position" : 44,
      "original_start_line" : 327,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 518306034,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/513164838",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r513164866"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/513164866"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-10-28T03:52:50Z",
      "diff_hunk" : "@@ -1080,6 +1080,29 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n+bool CConnman::AddConnection(const std::string& address)\n+{\n+    int nOutboundFullRelay = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r513164866",
      "id" : 513164866,
      "in_reply_to_id" : 499510944,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE2NDg2Ng==",
      "original_commit_id" : "0958cbc7211b04e537b3742abd34213023196900",
      "original_line" : 1085,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 518306058,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/513164866",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r513164912"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/513164912"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-10-28T03:53:01Z",
      "diff_hunk" : "@@ -1080,6 +1080,29 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n+bool CConnman::AddConnection(const std::string& address)\n+{\n+    int nOutboundFullRelay = 0;\n+\n+    {\n+        LOCK(cs_vNodes);\n+        for (const CNode* pnode : vNodes) {\n+            if (pnode->m_conn_type == ConnectionType::OUTBOUND_FULL_RELAY) {\n+                ++nOutboundFullRelay;\n+            }\n+        }\n+    }\n+\n+    if (nOutboundFullRelay >= m_max_outbound_full_relay) return false;\n+\n+    CSemaphoreGrant grant(*semOutbound, true);\n+    if (!grant) return false;\n+\n+    CAddress addr{};\n+    OpenNetworkConnection(addr, false, &grant, address.c_str(), ConnectionType::OUTBOUND_FULL_RELAY);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r513164912",
      "id" : 513164912,
      "in_reply_to_id" : 499511188,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE2NDkxMg==",
      "original_commit_id" : "0958cbc7211b04e537b3742abd34213023196900",
      "original_line" : 1102,
      "original_position" : 23,
      "original_start_line" : 1101,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 518306113,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/513164912",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r513164945"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/513164945"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-10-28T03:53:09Z",
      "diff_hunk" : "@@ -1080,26 +1080,35 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n-bool CConnman::AddConnection(const std::string& address)\n+bool CConnman::AddConnection(const std::string& address, const ConnectionType conn_type)\n {\n+    assert(conn_type == ConnectionType::OUTBOUND_FULL_RELAY || conn_type == ConnectionType::BLOCK_RELAY);\n+\n     int nOutboundFullRelay = 0;\n+    int nOutboundBlockRelay = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r513164945",
      "id" : 513164945,
      "in_reply_to_id" : 499512363,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE2NDk0NQ==",
      "original_commit_id" : "0fb4635bbabb1bea10a215bde4c803ceb5bc5f26",
      "original_line" : 1088,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 518306153,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/513164945",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r513165073"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/513165073"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-10-28T03:53:46Z",
      "diff_hunk" : "@@ -303,15 +303,17 @@ static RPCHelpMan addconnection()\n         \"\\nOpen an outbound connection to a specified node (test only)\",\n         {\n             {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connectiontype\", RPCArg::Type::STR, RPCArg::Optional::NO, \"'outbound' or 'blockrelay'\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r513165073",
      "id" : 513165073,
      "in_reply_to_id" : 499515798,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE2NTA3Mw==",
      "original_commit_id" : "0fb4635bbabb1bea10a215bde4c803ceb5bc5f26",
      "original_line" : 306,
      "original_position" : 4,
      "original_start_line" : 305,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 518306317,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/513165073",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r513166623"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/513166623"
         }
      },
      "author_association" : "MEMBER",
      "body" : "depends for what type. `AddConnection` goes through the nodes and counts how many full relays & block relays there currently are, then compares this to their respective max. it also checks the grant for the total outbound grants. if any of these fail, this error message is hit ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-10-28T04:00:08Z",
      "diff_hunk" : "@@ -320,20 +322,31 @@ static RPCHelpMan addconnection()\n         throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only\");\n     }\n \n-    RPCTypeCheckArgument(request.params, UniValue::VSTR);\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n     const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in = request.params[1].get_str();\n+    ConnectionType conn_type{};\n+    if (conn_type_in == \"outbound\") {\n+        conn_type = ConnectionType::OUTBOUND_FULL_RELAY;\n+    } else if (conn_type_in == \"blockrelay\") {\n+        conn_type = ConnectionType::BLOCK_RELAY;\n+    } else {\n+        throw std::runtime_error(self.ToString());\n+    }\n+\n     NodeContext& context = EnsureNodeContext(request.context);\n     if (!context.connman) {\n         throw JSONRPCError(RPC_CLIENT_P2P_DISABLED, \"Error: Peer-to-peer functionality missing or disabled\");\n     }\n \n-    const bool success = context.connman->AddConnection(address);\n+    const bool success = context.connman->AddConnection(address, conn_type);\n     if (!success) {\n-        throw JSONRPCError(RPC_CLIENT_NODE_CAPACITY_REACHED, \"Error: Max number of outbound full relay connections already open.\");\n+        throw JSONRPCError(RPC_CLIENT_NODE_CAPACITY_REACHED, \"Error: Already at capacity for specified connection type.\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r513166623",
      "id" : 513166623,
      "in_reply_to_id" : 499519175,
      "line" : 361,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE2NjYyMw==",
      "original_commit_id" : "0fb4635bbabb1bea10a215bde4c803ceb5bc5f26",
      "original_line" : 361,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 55,
      "pull_request_review_id" : 518308043,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/513166623",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r513168407"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/513168407"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@mzumsande do you think it would be useful to bump the port allocation, or does the workaround I proposed suffice for the use cases you're thinking about? I'm hesitant because of the potential of creating sporadic test framework issues, but I can look deeper into it if we have a good use case. ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-10-28T04:07:30Z",
      "diff_hunk" : "@@ -0,0 +1,94 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal, disconnect_nodes\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        disconnect_nodes(self.nodes[0], 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r513168407",
      "id" : 513168407,
      "in_reply_to_id" : 495600743,
      "line" : 34,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE2ODQwNw==",
      "original_commit_id" : "b489886b533809c9a4ee2643ceba7d34c278e03e",
      "original_line" : 34,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : 34,
      "pull_request_review_id" : 518310083,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/513168407",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased & incorporated @hebasto's suggestions",
      "created_at" : "2020-10-28T04:08:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-717682865",
      "id" : 717682865,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxNzY4Mjg2NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-28T04:08:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/717682865",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "fixed a silent merge conflict that was causing travis failure. \r\n\r\nready for review! ",
      "created_at" : "2020-10-30T05:21:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-719195613",
      "id" : 719195613,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxOTE5NTYxMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-30T05:21:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/719195613",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r520916884"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/520916884"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not sure, but I tend to think it is ok to keep it as it is. For none of the use cases I can think of, two bitcoin nodes are necessary. ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-10T22:33:28Z",
      "diff_hunk" : "@@ -0,0 +1,94 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal, disconnect_nodes\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        disconnect_nodes(self.nodes[0], 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r520916884",
      "id" : 520916884,
      "in_reply_to_id" : 495600743,
      "line" : 34,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkxNjg4NA==",
      "original_commit_id" : "b489886b533809c9a4ee2643ceba7d34c278e03e",
      "original_line" : 34,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : 34,
      "pull_request_review_id" : 527662228,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/520916884",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r521290049"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/521290049"
         }
      },
      "author_association" : "MEMBER",
      "body" : "There are several reasons that `OpenNetworkConnections()` can fail (eg a connection to that peer already exists, we fail to open a socket, etc). It'd be nice to change `OpenNetworkConnection()` to return a boolean and return that to the RPC caller.\r\n\r\nIf we don't return this value, then the RPC looks like it succeeded even if a connection has not been opened:\r\n\r\n```\r\nâ .bitcoin-cli addconnection i-am-not-an-address outbound\r\n{\r\n  \"address\": \"i-am-not-an-address\",\r\n  \"connectiontype\": \"outbound\"\r\n}\r\nâ ./bitcoin-cli getpeerinfo\r\n[\r\n]\r\n```",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-11T11:21:52Z",
      "diff_hunk" : "@@ -1152,6 +1152,37 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n+bool CConnman::AddConnection(const std::string& address, const ConnectionType conn_type)\n+{\n+    assert(conn_type == ConnectionType::OUTBOUND_FULL_RELAY || conn_type == ConnectionType::BLOCK_RELAY);\n+\n+    int outbound_full_relay = 0;\n+    int outbound_block_relay = 0;\n+\n+    {\n+        // count existing connections for each type\n+        LOCK(cs_vNodes);\n+        for (const CNode* pnode : vNodes) {\n+            if (pnode->m_conn_type == ConnectionType::OUTBOUND_FULL_RELAY) {\n+                ++outbound_full_relay;\n+            } else if (pnode->m_conn_type == ConnectionType::BLOCK_RELAY) {\n+                ++outbound_block_relay;\n+            }\n+        }\n+    }\n+\n+    // max connections of specified type already exist\n+    if (conn_type == ConnectionType::OUTBOUND_FULL_RELAY && outbound_full_relay >= m_max_outbound_full_relay) return false;\n+    if (conn_type == ConnectionType::BLOCK_RELAY && outbound_block_relay >= m_max_outbound_block_relay) return false;\n+\n+    // max total outbound connections already exist\n+    CSemaphoreGrant grant(*semOutbound, true);\n+    if (!grant) return false;\n+\n+    OpenNetworkConnection(CAddress(), false, &grant, address.c_str(), conn_type);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r521290049",
      "id" : 521290049,
      "line" : 1152,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI5MDA0OQ==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 1152,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 21,
      "pull_request_review_id" : 528084558,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/521290049",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r521293172"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/521293172"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You don't need to count the number both connection types if you're only going to test against one. It might also be clearer to use the standard library count_if rather than hand writing the loop.\r\n\r\nSee what you think of this:\r\n\r\n```suggestion\r\n    const int max_connections = conn_type == ConnectionType::OUTBOUND_FULL_RELAY ? m_max_outbound_full_relay :\r\n                                                                                   m_max_outbound_block_relay;\r\n\r\n    // Count existing connections\r\n    int existing_connections{0};\r\n    {\r\n        LOCK(cs_vNodes);\r\n        existing_connections = std::count_if(vNodes.begin(),\r\n                                             vNodes.end(),\r\n                                             [conn_type](CNode* node){return node->m_conn_type == conn_type;});\r\n    }\r\n\r\n    // Max connections of specified type already exist\r\n    if (existing_connections >= max_connections) return false;\r\n\r\n```",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-11T11:28:00Z",
      "diff_hunk" : "@@ -1152,6 +1152,37 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n+bool CConnman::AddConnection(const std::string& address, const ConnectionType conn_type)\n+{\n+    assert(conn_type == ConnectionType::OUTBOUND_FULL_RELAY || conn_type == ConnectionType::BLOCK_RELAY);\n+\n+    int outbound_full_relay = 0;\n+    int outbound_block_relay = 0;\n+\n+    {\n+        // count existing connections for each type\n+        LOCK(cs_vNodes);\n+        for (const CNode* pnode : vNodes) {\n+            if (pnode->m_conn_type == ConnectionType::OUTBOUND_FULL_RELAY) {\n+                ++outbound_full_relay;\n+            } else if (pnode->m_conn_type == ConnectionType::BLOCK_RELAY) {\n+                ++outbound_block_relay;\n+            }\n+        }\n+    }\n+\n+    // max connections of specified type already exist\n+    if (conn_type == ConnectionType::OUTBOUND_FULL_RELAY && outbound_full_relay >= m_max_outbound_full_relay) return false;\n+    if (conn_type == ConnectionType::BLOCK_RELAY && outbound_block_relay >= m_max_outbound_block_relay) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r521293172",
      "id" : 521293172,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI5MzE3Mg==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 1176,
      "original_position" : 25,
      "original_start_line" : 1159,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 528084558,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/521293172",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r521296406"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/521296406"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps make this less specific (e.g. FAILED_TO_CONNECT).",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-11T11:34:30Z",
      "diff_hunk" : "@@ -62,6 +62,7 @@ enum RPCErrorCode\n     RPC_CLIENT_NODE_NOT_CONNECTED   = -29, //!< Node to disconnect not found in connected nodes\n     RPC_CLIENT_INVALID_IP_OR_SUBNET = -30, //!< Invalid IP/Subnet\n     RPC_CLIENT_P2P_DISABLED         = -31, //!< No valid connection manager instance found\n+    RPC_CLIENT_NODE_CAPACITY_REACHED= -34, //!< Max number of outbound or block-relay connections already open",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r521296406",
      "id" : 521296406,
      "line" : 65,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI5NjQwNg==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 65,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/rpc/protocol.h",
      "position" : 4,
      "pull_request_review_id" : 528084558,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/521296406",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r521303287"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/521303287"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree. This doesn't seem necessary. You could just as easily call `sendrawtransaction` and then `getmempoolentry` to confirm that the transaction reached the mempool.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-11T11:48:24Z",
      "diff_hunk" : "@@ -69,18 +53,58 @@ def run_test(self):\n         peer_2_info = self.nodes[0].getpeerinfo()[1]\n         assert_equal(peer_2_info['whitelisted'], True)\n         assert_equal(peer_2_info['permissions'], ['noban', 'forcerelay', 'relay', 'mempool', 'download'])\n-        assert_equal(self.nodes[0].testmempoolaccept([sigtx])[0]['allowed'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n \n         self.log.info('Check that the tx from forcerelay first_peer is relayed to others (ie.second_peer)')\n         with self.nodes[0].assert_debug_log([\"received getdata\"]):\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the forcerelay peer is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Forcerelay peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        # bump time forward to ensure nNextInvSend timer pops\n+        self.nodes[0].setmocktime(int(time.time()) + 5)\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r521303287",
      "id" : 521303287,
      "in_reply_to_id" : 479353496,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMwMzI4Nw==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 91,
      "original_position" : 118,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 528084558,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/521303287",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r521304814"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/521304814"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Do we need some kind of sleep/setmocktime here? The node will only send out inventory to outbound connections every 2.5s on average, so this won't catch if we accidentally send out invs to this peer.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-11T11:51:27Z",
      "diff_hunk" : "@@ -78,13 +62,54 @@ def run_test(self):\n             # But if, for some reason, first_peer decides to relay transactions to us anyway, we should relay them to\n             # second_peer since we gave relay permission to first_peer.\n             # See https://github.com/bitcoin/bitcoin/issues/19943 for details.\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the peer with relay-permission is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Relay-permission peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        # bump time forward to ensure nNextInvSend timer pops\n+        self.nodes[0].setmocktime(int(time.time()) + 5)\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n+        self.nodes[0].sendrawtransaction(tx_hex)\n+        conn.sync_with_ping()\n+        assert(int(txid, 16) not in conn.get_invs())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r521304814",
      "id" : 521304814,
      "line" : 98,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTMwNDgxNA==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 98,
      "original_position" : 126,
      "original_start_line" : 93,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 128,
      "pull_request_review_id" : 528084558,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : 97,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/521304814",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r521500638"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/521500638"
         }
      },
      "author_association" : "MEMBER",
      "body" : "IMO, it's quite nice to have a succinct high-level description of test coverage without necessary getting into the details.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-11T16:58:12Z",
      "diff_hunk" : "@@ -2,15 +2,16 @@\n # Copyright (c) 2019 The Bitcoin Core developers\n # Distributed under the MIT software license, see the accompanying\n # file COPYING or http://www.opensource.org/licenses/mit-license.php.\n-\"\"\"Test p2p blocksonly\"\"\"\n+\"\"\"Test p2p blocksonly mode & block-relay-only connections.\"\"\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r521500638",
      "id" : 521500638,
      "in_reply_to_id" : 488823128,
      "line" : 5,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTUwMDYzOA==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 5,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 5,
      "pull_request_review_id" : 528359578,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/521500638",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r521589772"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/521589772"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't understand exactly what `CSemaphoreGrant` is enforcing given that:\r\n* `semOutbound` is initialized with a value of `std::min(m_max_outbound, nMaxConnections)` (L2510 in `src/net.cpp`)\r\n* thread \"addconnection\" is accessing this semaphore L1179 in `src/net.cpp` with `fTry=true` thus calling `CSemaphoreGrant::TryAcquire`, decrementing the semaphore by one (L281 in `src/sync.h`) and returning a successful grant taking\r\n* thread \"addconnection is calling `OpenNetworkConnection` which itself calls `CSemaphoreGrant::MoveTo()` (L2205 in `src/net.cpp`) if connection opening is successful. `MoveTo()` calls `CSemaphoreGrant::Release()` then `CSemaphore::post()`. This last function _increments_ back the semaphore.\r\n* a thread `opencon` is accessing the semaphore in `ThreadOpenConnections` (L1918) and indirectly calls `CSemaphore::wait`, but the conditional predicate doesn't matter as `addconnection` thread incremented back the semaphore. Thus sooner or latter `wait()` will return and a new outbound should be established.\r\n\r\n`CSemaphoreGrant`/`CSemaphore`/`CConnman::semOutbound` are poorly documented so it's hard to understand what exactly it aims to achieve. So we might theoritcally bypass `m_max_outbound` but I wouldn't surprised you see nothing in practice as block-relay-only/full-relay are checked on their own and other outbound are short-lived ?",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-11T19:30:36Z",
      "diff_hunk" : "@@ -1152,6 +1152,37 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n+bool CConnman::AddConnection(const std::string& address, const ConnectionType conn_type)\n+{\n+    assert(conn_type == ConnectionType::OUTBOUND_FULL_RELAY || conn_type == ConnectionType::BLOCK_RELAY);\n+\n+    int outbound_full_relay = 0;\n+    int outbound_block_relay = 0;\n+\n+    {\n+        // count existing connections for each type\n+        LOCK(cs_vNodes);\n+        for (const CNode* pnode : vNodes) {\n+            if (pnode->m_conn_type == ConnectionType::OUTBOUND_FULL_RELAY) {\n+                ++outbound_full_relay;\n+            } else if (pnode->m_conn_type == ConnectionType::BLOCK_RELAY) {\n+                ++outbound_block_relay;\n+            }\n+        }\n+    }\n+\n+    // max connections of specified type already exist\n+    if (conn_type == ConnectionType::OUTBOUND_FULL_RELAY && outbound_full_relay >= m_max_outbound_full_relay) return false;\n+    if (conn_type == ConnectionType::BLOCK_RELAY && outbound_block_relay >= m_max_outbound_block_relay) return false;\n+\n+    // max total outbound connections already exist\n+    CSemaphoreGrant grant(*semOutbound, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r521589772",
      "id" : 521589772,
      "line" : 1149,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU4OTc3Mg==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 1149,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 18,
      "pull_request_review_id" : 528473200,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/521589772",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r521590231"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/521590231"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: \"max outbound connection\"",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-11T19:31:32Z",
      "diff_hunk" : "@@ -346,6 +346,15 @@ class CConnman\n     bool RemoveAddedNode(const std::string& node);\n     std::vector<AddedNodeInfo> GetAddedNodeInfo();\n \n+    /**\n+     * Attempts to open a connection. Currently only used from tests.\n+     *\n+     * @param[in]   address     Address of node to try connecting to\n+     * @param[in]   conn_type   ConnectionType::OUTBOUND or ConnectionType::BLOCK_RELAY\n+     * @return      bool        Returns false if at max connection capacity",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r521590231",
      "id" : 521590231,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU5MDIzMQ==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 354,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 528473200,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/521590231",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r522558783"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/522558783"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`./bitcoin-cli addnode i-am-not-an-address onetry` gives the same result, as does trying with a valid but unreachable address. Even with NET logging enabled, I only see an error in debug.log for the unreachable address (\"connection to XXX timeout\"). Having a more reliable indication *somewhere* of what went wrong would probably be a good idea both here and for addnode might be good. Not sure that needs to be in this PR though, behaving no worse than the existing addnode doesn't seem too bad.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-13T01:53:19Z",
      "diff_hunk" : "@@ -1152,6 +1152,37 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n+bool CConnman::AddConnection(const std::string& address, const ConnectionType conn_type)\n+{\n+    assert(conn_type == ConnectionType::OUTBOUND_FULL_RELAY || conn_type == ConnectionType::BLOCK_RELAY);\n+\n+    int outbound_full_relay = 0;\n+    int outbound_block_relay = 0;\n+\n+    {\n+        // count existing connections for each type\n+        LOCK(cs_vNodes);\n+        for (const CNode* pnode : vNodes) {\n+            if (pnode->m_conn_type == ConnectionType::OUTBOUND_FULL_RELAY) {\n+                ++outbound_full_relay;\n+            } else if (pnode->m_conn_type == ConnectionType::BLOCK_RELAY) {\n+                ++outbound_block_relay;\n+            }\n+        }\n+    }\n+\n+    // max connections of specified type already exist\n+    if (conn_type == ConnectionType::OUTBOUND_FULL_RELAY && outbound_full_relay >= m_max_outbound_full_relay) return false;\n+    if (conn_type == ConnectionType::BLOCK_RELAY && outbound_block_relay >= m_max_outbound_block_relay) return false;\n+\n+    // max total outbound connections already exist\n+    CSemaphoreGrant grant(*semOutbound, true);\n+    if (!grant) return false;\n+\n+    OpenNetworkConnection(CAddress(), false, &grant, address.c_str(), conn_type);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r522558783",
      "id" : 522558783,
      "in_reply_to_id" : 521290049,
      "line" : 1152,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU1ODc4Mw==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 1152,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 21,
      "pull_request_review_id" : 529645624,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/522558783",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r522561165"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/522561165"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`a.MoveTo(b)` calls `b.Release()` -- but `b` in this case is a brand new `CSemaphoreGrant` that was default initialized, so `b.fHaveGrant` is false and `b.Release()` is a no-op, and `b.sem->post()` is not called.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-13T02:01:40Z",
      "diff_hunk" : "@@ -1152,6 +1152,37 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n+bool CConnman::AddConnection(const std::string& address, const ConnectionType conn_type)\n+{\n+    assert(conn_type == ConnectionType::OUTBOUND_FULL_RELAY || conn_type == ConnectionType::BLOCK_RELAY);\n+\n+    int outbound_full_relay = 0;\n+    int outbound_block_relay = 0;\n+\n+    {\n+        // count existing connections for each type\n+        LOCK(cs_vNodes);\n+        for (const CNode* pnode : vNodes) {\n+            if (pnode->m_conn_type == ConnectionType::OUTBOUND_FULL_RELAY) {\n+                ++outbound_full_relay;\n+            } else if (pnode->m_conn_type == ConnectionType::BLOCK_RELAY) {\n+                ++outbound_block_relay;\n+            }\n+        }\n+    }\n+\n+    // max connections of specified type already exist\n+    if (conn_type == ConnectionType::OUTBOUND_FULL_RELAY && outbound_full_relay >= m_max_outbound_full_relay) return false;\n+    if (conn_type == ConnectionType::BLOCK_RELAY && outbound_block_relay >= m_max_outbound_block_relay) return false;\n+\n+    // max total outbound connections already exist\n+    CSemaphoreGrant grant(*semOutbound, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r522561165",
      "id" : 522561165,
      "in_reply_to_id" : 521589772,
      "line" : 1149,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjU2MTE2NQ==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 1149,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 18,
      "pull_request_review_id" : 529648300,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/522561165",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r525413509"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/525413509"
         }
      },
      "author_association" : "MEMBER",
      "body" : "seems related to your previous feedback https://github.com/bitcoin/bitcoin/pull/19315#discussion_r473860655. thanks for helping me ensure this test is meaningful :) \r\n\r\nthe way I've sanity tested this assertion is by removing the `connection_type=\"blockrelay\"` arg to see that it fails. I think the mocktime bump a few lines up should be covering the `INVENTORY_BROADCAST_INTERVAL` delay. is that what you're referring to?\r\n\r\nhowever, even though it appropriately fails (when removing `blockrelay` arg) on my computer, it might still be worth adding a small delay (maybe 0.1 second sleep?) to ensure the `SendMessages` loop is actually hit on every machine? \r\n\r\nwhat do you think?",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-17T19:04:21Z",
      "diff_hunk" : "@@ -78,13 +62,54 @@ def run_test(self):\n             # But if, for some reason, first_peer decides to relay transactions to us anyway, we should relay them to\n             # second_peer since we gave relay permission to first_peer.\n             # See https://github.com/bitcoin/bitcoin/issues/19943 for details.\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the peer with relay-permission is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Relay-permission peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        # bump time forward to ensure nNextInvSend timer pops\n+        self.nodes[0].setmocktime(int(time.time()) + 5)\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n+        self.nodes[0].sendrawtransaction(tx_hex)\n+        conn.sync_with_ping()\n+        assert(int(txid, 16) not in conn.get_invs())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r525413509",
      "id" : 525413509,
      "in_reply_to_id" : 521304814,
      "line" : 98,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQxMzUwOQ==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 98,
      "original_position" : 126,
      "original_start_line" : 93,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 128,
      "pull_request_review_id" : 532697174,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : 97,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/525413509",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r525414419"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/525414419"
         }
      },
      "author_association" : "MEMBER",
      "body" : "? \r\n\r\nreturns false if its at max connection of the specified type (full relay or block relay), as well as checking total outbound connections ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-17T19:05:45Z",
      "diff_hunk" : "@@ -346,6 +346,15 @@ class CConnman\n     bool RemoveAddedNode(const std::string& node);\n     std::vector<AddedNodeInfo> GetAddedNodeInfo();\n \n+    /**\n+     * Attempts to open a connection. Currently only used from tests.\n+     *\n+     * @param[in]   address     Address of node to try connecting to\n+     * @param[in]   conn_type   ConnectionType::OUTBOUND or ConnectionType::BLOCK_RELAY\n+     * @return      bool        Returns false if at max connection capacity",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r525414419",
      "id" : 525414419,
      "in_reply_to_id" : 521590231,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQxNDQxOQ==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 354,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 532698272,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/525414419",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r525435591"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/525435591"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agree that this can be done separately if the behaviour here is the same as for `addnode`.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-17T19:35:45Z",
      "diff_hunk" : "@@ -1152,6 +1152,37 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n+bool CConnman::AddConnection(const std::string& address, const ConnectionType conn_type)\n+{\n+    assert(conn_type == ConnectionType::OUTBOUND_FULL_RELAY || conn_type == ConnectionType::BLOCK_RELAY);\n+\n+    int outbound_full_relay = 0;\n+    int outbound_block_relay = 0;\n+\n+    {\n+        // count existing connections for each type\n+        LOCK(cs_vNodes);\n+        for (const CNode* pnode : vNodes) {\n+            if (pnode->m_conn_type == ConnectionType::OUTBOUND_FULL_RELAY) {\n+                ++outbound_full_relay;\n+            } else if (pnode->m_conn_type == ConnectionType::BLOCK_RELAY) {\n+                ++outbound_block_relay;\n+            }\n+        }\n+    }\n+\n+    // max connections of specified type already exist\n+    if (conn_type == ConnectionType::OUTBOUND_FULL_RELAY && outbound_full_relay >= m_max_outbound_full_relay) return false;\n+    if (conn_type == ConnectionType::BLOCK_RELAY && outbound_block_relay >= m_max_outbound_block_relay) return false;\n+\n+    // max total outbound connections already exist\n+    CSemaphoreGrant grant(*semOutbound, true);\n+    if (!grant) return false;\n+\n+    OpenNetworkConnection(CAddress(), false, &grant, address.c_str(), conn_type);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r525435591",
      "id" : 525435591,
      "in_reply_to_id" : 521290049,
      "line" : 1152,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQzNTU5MQ==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 1152,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 21,
      "pull_request_review_id" : 532745351,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/525435591",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r525437816"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/525437816"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@ariard I agree that `CSemaphoreGrant` is far-from-ideal, and that its strange / redundant that we also have the individual counts of our different types. However, I'm not understanding exactly what you're trying to suggest here. Are you saying that the overall design of this mechanism is confusing, and the guarantees minimal? Or are you saying that this proposed implementation is problematic? ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-17T19:37:42Z",
      "diff_hunk" : "@@ -1152,6 +1152,37 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n+bool CConnman::AddConnection(const std::string& address, const ConnectionType conn_type)\n+{\n+    assert(conn_type == ConnectionType::OUTBOUND_FULL_RELAY || conn_type == ConnectionType::BLOCK_RELAY);\n+\n+    int outbound_full_relay = 0;\n+    int outbound_block_relay = 0;\n+\n+    {\n+        // count existing connections for each type\n+        LOCK(cs_vNodes);\n+        for (const CNode* pnode : vNodes) {\n+            if (pnode->m_conn_type == ConnectionType::OUTBOUND_FULL_RELAY) {\n+                ++outbound_full_relay;\n+            } else if (pnode->m_conn_type == ConnectionType::BLOCK_RELAY) {\n+                ++outbound_block_relay;\n+            }\n+        }\n+    }\n+\n+    // max connections of specified type already exist\n+    if (conn_type == ConnectionType::OUTBOUND_FULL_RELAY && outbound_full_relay >= m_max_outbound_full_relay) return false;\n+    if (conn_type == ConnectionType::BLOCK_RELAY && outbound_block_relay >= m_max_outbound_block_relay) return false;\n+\n+    // max total outbound connections already exist\n+    CSemaphoreGrant grant(*semOutbound, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r525437816",
      "id" : 525437816,
      "in_reply_to_id" : 521589772,
      "line" : 1149,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQzNzgxNg==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 1149,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 18,
      "pull_request_review_id" : 532746669,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/525437816",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r525438953"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/525438953"
         }
      },
      "author_association" : "MEMBER",
      "body" : "cc @MarcoFalke, test sync expert ð",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-17T19:38:37Z",
      "diff_hunk" : "@@ -78,13 +62,54 @@ def run_test(self):\n             # But if, for some reason, first_peer decides to relay transactions to us anyway, we should relay them to\n             # second_peer since we gave relay permission to first_peer.\n             # See https://github.com/bitcoin/bitcoin/issues/19943 for details.\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the peer with relay-permission is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Relay-permission peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        # bump time forward to ensure nNextInvSend timer pops\n+        self.nodes[0].setmocktime(int(time.time()) + 5)\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n+        self.nodes[0].sendrawtransaction(tx_hex)\n+        conn.sync_with_ping()\n+        assert(int(txid, 16) not in conn.get_invs())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r525438953",
      "id" : 525438953,
      "in_reply_to_id" : 521304814,
      "line" : 98,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQzODk1Mw==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 98,
      "original_position" : 126,
      "original_start_line" : 93,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 128,
      "pull_request_review_id" : 532747324,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : 97,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/525438953",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r525533443"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/525533443"
         }
      },
      "author_association" : "MEMBER",
      "body" : "resolving this conversation so we can continue over here: https://github.com/bitcoin/bitcoin/pull/19315#discussion_r525413509",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-17T21:23:38Z",
      "diff_hunk" : "@@ -69,18 +49,55 @@ def run_test(self):\n         peer_2_info = self.nodes[0].getpeerinfo()[1]\n         assert_equal(peer_2_info['whitelisted'], True)\n         assert_equal(peer_2_info['permissions'], ['noban', 'forcerelay', 'relay', 'mempool', 'download'])\n-        assert_equal(self.nodes[0].testmempoolaccept([sigtx])[0]['allowed'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n \n         self.log.info('Check that the tx from forcerelay first_peer is relayed to others (ie.second_peer)')\n         with self.nodes[0].assert_debug_log([\"received getdata\"]):\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the forcerelay peer is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Forcerelay peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n+        self.nodes[0].sendrawtransaction(tx_hex)\n+        conn.sync_with_ping()\n+        assert(txid not in conn.get_invs())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r525533443",
      "id" : 525533443,
      "in_reply_to_id" : 473860655,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTUzMzQ0Mw==",
      "original_commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "original_line" : 82,
      "original_position" : 109,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 532823851,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/525533443",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r525544492"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/525544492"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ok. I didn't look closely at exactly what errors `testmempoolaccept` returns vs `sendrawtransaction`. I think I probably just copied the existing pattern in the tests. \r\n\r\n@glozow - are you suggesting I should just delete this line? (fine by me, just trying to understand)\r\n\r\n@jnewbery your suggestion just seems like an alternative that's about the same? ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-17T21:44:06Z",
      "diff_hunk" : "@@ -69,18 +53,58 @@ def run_test(self):\n         peer_2_info = self.nodes[0].getpeerinfo()[1]\n         assert_equal(peer_2_info['whitelisted'], True)\n         assert_equal(peer_2_info['permissions'], ['noban', 'forcerelay', 'relay', 'mempool', 'download'])\n-        assert_equal(self.nodes[0].testmempoolaccept([sigtx])[0]['allowed'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n \n         self.log.info('Check that the tx from forcerelay first_peer is relayed to others (ie.second_peer)')\n         with self.nodes[0].assert_debug_log([\"received getdata\"]):\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the forcerelay peer is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Forcerelay peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        # bump time forward to ensure nNextInvSend timer pops\n+        self.nodes[0].setmocktime(int(time.time()) + 5)\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r525544492",
      "id" : 525544492,
      "in_reply_to_id" : 479353496,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU0NDQ5Mg==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 91,
      "original_position" : 118,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 532837761,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/525544492",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r525552821"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/525552821"
         }
      },
      "author_association" : "MEMBER",
      "body" : "agree with the idea. I've started a branch to incorporate: https://github.com/amitiuttarwar/bitcoin/commits/2020-11-open-conn-improvements. I want to add some testing and review the failures / think through logging. but will do this as a follow up. ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-17T21:59:42Z",
      "diff_hunk" : "@@ -1152,6 +1152,37 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n+bool CConnman::AddConnection(const std::string& address, const ConnectionType conn_type)\n+{\n+    assert(conn_type == ConnectionType::OUTBOUND_FULL_RELAY || conn_type == ConnectionType::BLOCK_RELAY);\n+\n+    int outbound_full_relay = 0;\n+    int outbound_block_relay = 0;\n+\n+    {\n+        // count existing connections for each type\n+        LOCK(cs_vNodes);\n+        for (const CNode* pnode : vNodes) {\n+            if (pnode->m_conn_type == ConnectionType::OUTBOUND_FULL_RELAY) {\n+                ++outbound_full_relay;\n+            } else if (pnode->m_conn_type == ConnectionType::BLOCK_RELAY) {\n+                ++outbound_block_relay;\n+            }\n+        }\n+    }\n+\n+    // max connections of specified type already exist\n+    if (conn_type == ConnectionType::OUTBOUND_FULL_RELAY && outbound_full_relay >= m_max_outbound_full_relay) return false;\n+    if (conn_type == ConnectionType::BLOCK_RELAY && outbound_block_relay >= m_max_outbound_block_relay) return false;\n+\n+    // max total outbound connections already exist\n+    CSemaphoreGrant grant(*semOutbound, true);\n+    if (!grant) return false;\n+\n+    OpenNetworkConnection(CAddress(), false, &grant, address.c_str(), conn_type);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r525552821",
      "id" : 525552821,
      "in_reply_to_id" : 521290049,
      "line" : 1152,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU1MjgyMQ==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 1152,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 21,
      "pull_request_review_id" : 532847890,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/525552821",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r525552977"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/525552977"
         }
      },
      "author_association" : "MEMBER",
      "body" : "this is great! thank you! I've incorporated the suggestion ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-17T21:59:58Z",
      "diff_hunk" : "@@ -1152,6 +1152,37 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n+bool CConnman::AddConnection(const std::string& address, const ConnectionType conn_type)\n+{\n+    assert(conn_type == ConnectionType::OUTBOUND_FULL_RELAY || conn_type == ConnectionType::BLOCK_RELAY);\n+\n+    int outbound_full_relay = 0;\n+    int outbound_block_relay = 0;\n+\n+    {\n+        // count existing connections for each type\n+        LOCK(cs_vNodes);\n+        for (const CNode* pnode : vNodes) {\n+            if (pnode->m_conn_type == ConnectionType::OUTBOUND_FULL_RELAY) {\n+                ++outbound_full_relay;\n+            } else if (pnode->m_conn_type == ConnectionType::BLOCK_RELAY) {\n+                ++outbound_block_relay;\n+            }\n+        }\n+    }\n+\n+    // max connections of specified type already exist\n+    if (conn_type == ConnectionType::OUTBOUND_FULL_RELAY && outbound_full_relay >= m_max_outbound_full_relay) return false;\n+    if (conn_type == ConnectionType::BLOCK_RELAY && outbound_block_relay >= m_max_outbound_block_relay) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r525552977",
      "id" : 525552977,
      "in_reply_to_id" : 521293172,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU1Mjk3Nw==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 1176,
      "original_position" : 25,
      "original_start_line" : 1159,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 532848065,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/525552977",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r525553290"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/525553290"
         }
      },
      "author_association" : "MEMBER",
      "body" : "leaving it for this PR since the specificity is accurate, but updating in the branch (https://github.com/amitiuttarwar/bitcoin/commits/2020-11-open-conn-improvements) that generalizes and returns more general failures",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-17T22:00:33Z",
      "diff_hunk" : "@@ -62,6 +62,7 @@ enum RPCErrorCode\n     RPC_CLIENT_NODE_NOT_CONNECTED   = -29, //!< Node to disconnect not found in connected nodes\n     RPC_CLIENT_INVALID_IP_OR_SUBNET = -30, //!< Invalid IP/Subnet\n     RPC_CLIENT_P2P_DISABLED         = -31, //!< No valid connection manager instance found\n+    RPC_CLIENT_NODE_CAPACITY_REACHED= -34, //!< Max number of outbound or block-relay connections already open",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r525553290",
      "id" : 525553290,
      "in_reply_to_id" : 521296406,
      "line" : 65,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTU1MzI5MA==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 65,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/rpc/protocol.h",
      "position" : 4,
      "pull_request_review_id" : 532848441,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/525553290",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r525847965"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/525847965"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`sendrawtransaction` error handling is undocumented, but it will indeed return an jsonrpc error when the tx couldn't be added to the mempool",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-18T06:45:13Z",
      "diff_hunk" : "@@ -69,18 +53,58 @@ def run_test(self):\n         peer_2_info = self.nodes[0].getpeerinfo()[1]\n         assert_equal(peer_2_info['whitelisted'], True)\n         assert_equal(peer_2_info['permissions'], ['noban', 'forcerelay', 'relay', 'mempool', 'download'])\n-        assert_equal(self.nodes[0].testmempoolaccept([sigtx])[0]['allowed'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n \n         self.log.info('Check that the tx from forcerelay first_peer is relayed to others (ie.second_peer)')\n         with self.nodes[0].assert_debug_log([\"received getdata\"]):\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the forcerelay peer is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Forcerelay peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        # bump time forward to ensure nNextInvSend timer pops\n+        self.nodes[0].setmocktime(int(time.time()) + 5)\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r525847965",
      "id" : 525847965,
      "in_reply_to_id" : 479353496,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTg0Nzk2NQ==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 91,
      "original_position" : 118,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 533142971,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/525847965",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r525848859"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/525848859"
         }
      },
      "author_association" : "MEMBER",
      "body" : "wouldn't the setmocktime be called after the tx has been added to the mempool?",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-18T06:47:38Z",
      "diff_hunk" : "@@ -78,13 +62,54 @@ def run_test(self):\n             # But if, for some reason, first_peer decides to relay transactions to us anyway, we should relay them to\n             # second_peer since we gave relay permission to first_peer.\n             # See https://github.com/bitcoin/bitcoin/issues/19943 for details.\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the peer with relay-permission is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Relay-permission peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        # bump time forward to ensure nNextInvSend timer pops\n+        self.nodes[0].setmocktime(int(time.time()) + 5)\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n+        self.nodes[0].sendrawtransaction(tx_hex)\n+        conn.sync_with_ping()\n+        assert(int(txid, 16) not in conn.get_invs())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r525848859",
      "id" : 525848859,
      "in_reply_to_id" : 521304814,
      "line" : 98,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTg0ODg1OQ==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 98,
      "original_position" : 126,
      "original_start_line" : 93,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 128,
      "pull_request_review_id" : 533144031,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : 97,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/525848859",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r526336974"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/526336974"
         }
      },
      "author_association" : "MEMBER",
      "body" : "oh great point. I think its working fine on my machine bc the window between bumping mocktime + making txn is small enough, but I've just pushed an update to have the right order.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-18T18:47:10Z",
      "diff_hunk" : "@@ -78,13 +62,54 @@ def run_test(self):\n             # But if, for some reason, first_peer decides to relay transactions to us anyway, we should relay them to\n             # second_peer since we gave relay permission to first_peer.\n             # See https://github.com/bitcoin/bitcoin/issues/19943 for details.\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the peer with relay-permission is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Relay-permission peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        # bump time forward to ensure nNextInvSend timer pops\n+        self.nodes[0].setmocktime(int(time.time()) + 5)\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n+        self.nodes[0].sendrawtransaction(tx_hex)\n+        conn.sync_with_ping()\n+        assert(int(txid, 16) not in conn.get_invs())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r526336974",
      "id" : 526336974,
      "in_reply_to_id" : 521304814,
      "line" : 98,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjMzNjk3NA==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 98,
      "original_position" : 126,
      "original_start_line" : 93,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 128,
      "pull_request_review_id" : 533770159,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : 97,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/526336974",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "looks like the CI failure is just a generic timeout? if yes -> PR is ready for review. all review comments have been addressed",
      "created_at" : "2020-11-18T23:18:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-730017485",
      "id" : 730017485,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczMDAxNzQ4NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-18T23:18:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/730017485",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> looks like the CI failure is just a generic timeout?\r\n\r\nI believe this is improved in master. @MarcoFalke would know. Perhaps try rebasing on latest master?",
      "created_at" : "2020-11-19T10:19:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-730274196",
      "id" : 730274196,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczMDI3NDE5Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-19T10:19:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/730274196",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Yes, the valgrind fuzzer timeout issue was affecting everyone and was resolved in master a few days ago; rebasing fixed it for me. Will review.",
      "created_at" : "2020-11-19T10:23:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-730276841",
      "id" : 730276841,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczMDI3Njg0MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-19T10:23:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/730276841",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "thanks, rebased! and CI is green (appveyor pending) \r\n",
      "created_at" : "2020-11-20T02:19:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-730802652",
      "id" : 730802652,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczMDgwMjY1Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-20T02:19:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/730802652",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527789415"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527789415"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0c4d67371 argument name in snakecase and improved description\r\n```suggestion\r\n            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The type of connection to open, either (case insensitive) \\\"outbound\\\" or \\\"blockrelay\\\".\"},\r\n```",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-20T16:00:06Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connectiontype\", RPCArg::Type::STR, RPCArg::Optional::NO, \"'outbound' or 'blockrelay'.\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527789415",
      "id" : 527789415,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc4OTQxNQ==",
      "original_commit_id" : "50720f411e05cf1bbaa91174b389c54f3c5287cf",
      "original_line" : 332,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 535555222,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527789415",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527790065"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527790065"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0c4d67371\r\n```suggestion\r\n                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },\r\n```",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-20T16:01:06Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connectiontype\", RPCArg::Type::STR, RPCArg::Optional::NO, \"'outbound' or 'blockrelay'.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connectiontype\", \"Type of connection opened.\" },",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527790065",
      "id" : 527790065,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc5MDA2NQ==",
      "original_commit_id" : "50720f411e05cf1bbaa91174b389c54f3c5287cf",
      "original_line" : 338,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 535555222,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527790065",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527790484"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527790484"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0c4d673716f2eb37 trim and make case-insensitive\r\n```suggestion\r\n    const std::string conn_type_in{ToLower(TrimString(request.params[1].get_str()))};\r\n```\r\n",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-20T16:01:46Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connectiontype\", RPCArg::Type::STR, RPCArg::Optional::NO, \"'outbound' or 'blockrelay'.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connectiontype\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    if (!Params().IsMockableChain()) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only.\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in = request.params[1].get_str();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527790484",
      "id" : 527790484,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc5MDQ4NA==",
      "original_commit_id" : "50720f411e05cf1bbaa91174b389c54f3c5287cf",
      "original_line" : 352,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 535555222,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527790484",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527791265"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527791265"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0c4d673716f2eb37\r\n```suggestion\r\n    info.pushKV(\"connection_type\", conn_type_in);\r\n```",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-20T16:02:59Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connectiontype\", RPCArg::Type::STR, RPCArg::Optional::NO, \"'outbound' or 'blockrelay'.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connectiontype\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    if (!Params().IsMockableChain()) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only.\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in = request.params[1].get_str();\n+    ConnectionType conn_type{};\n+    if (conn_type_in == \"outbound\") {\n+        conn_type = ConnectionType::OUTBOUND_FULL_RELAY;\n+    } else if (conn_type_in == \"blockrelay\") {\n+        conn_type = ConnectionType::BLOCK_RELAY;\n+    } else {\n+        throw std::runtime_error(self.ToString());\n+    }\n+\n+    NodeContext& context = EnsureNodeContext(request.context);\n+    if (!context.connman) {\n+        throw JSONRPCError(RPC_CLIENT_P2P_DISABLED, \"Error: Peer-to-peer functionality missing or disabled.\");\n+    }\n+\n+    const bool success = context.connman->AddConnection(address, conn_type);\n+    if (!success) {\n+        throw JSONRPCError(RPC_CLIENT_NODE_CAPACITY_REACHED, \"Error: Already at capacity for specified connection type.\");\n+    }\n+\n+    UniValue info(UniValue::VOBJ);\n+    info.pushKV(\"address\", address);\n+    info.pushKV(\"connectiontype\", conn_type_in);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527791265",
      "id" : 527791265,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc5MTI2NQ==",
      "original_commit_id" : "50720f411e05cf1bbaa91174b389c54f3c5287cf",
      "original_line" : 374,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 535555222,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527791265",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527791634"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527791634"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0c4d673716f2eb37efdb81ad2d7d20f69de960b3 wishlist :)\r\n```diff\r\n+    info.pushKV(\"peer id\", number);\r\n+    info.pushKV(\"result\", \"...string description...\");\r\n```\r\n",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-20T16:03:36Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connectiontype\", RPCArg::Type::STR, RPCArg::Optional::NO, \"'outbound' or 'blockrelay'.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connectiontype\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    if (!Params().IsMockableChain()) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only.\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in = request.params[1].get_str();\n+    ConnectionType conn_type{};\n+    if (conn_type_in == \"outbound\") {\n+        conn_type = ConnectionType::OUTBOUND_FULL_RELAY;\n+    } else if (conn_type_in == \"blockrelay\") {\n+        conn_type = ConnectionType::BLOCK_RELAY;\n+    } else {\n+        throw std::runtime_error(self.ToString());\n+    }\n+\n+    NodeContext& context = EnsureNodeContext(request.context);\n+    if (!context.connman) {\n+        throw JSONRPCError(RPC_CLIENT_P2P_DISABLED, \"Error: Peer-to-peer functionality missing or disabled.\");\n+    }\n+\n+    const bool success = context.connman->AddConnection(address, conn_type);\n+    if (!success) {\n+        throw JSONRPCError(RPC_CLIENT_NODE_CAPACITY_REACHED, \"Error: Already at capacity for specified connection type.\");\n+    }\n+\n+    UniValue info(UniValue::VOBJ);\n+    info.pushKV(\"address\", address);\n+    info.pushKV(\"connectiontype\", conn_type_in);\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527791634",
      "id" : 527791634,
      "line" : 367,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc5MTYzNA==",
      "original_commit_id" : "50720f411e05cf1bbaa91174b389c54f3c5287cf",
      "original_line" : 367,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 61,
      "pull_request_review_id" : 535555222,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527791634",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527792294"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527792294"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0c4d673716f2eb37efdb81ad2d7d20f69de960b3 s/connectiontype/connection_type/ (nit, sort before addpeeraddress)",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-20T16:04:39Z",
      "diff_hunk" : "@@ -906,7 +962,9 @@ static const CRPCCommand commands[] =\n     { \"network\",            \"clearbanned\",            &clearbanned,            {} },\n     { \"network\",            \"setnetworkactive\",       &setnetworkactive,       {\"state\"} },\n     { \"network\",            \"getnodeaddresses\",       &getnodeaddresses,       {\"count\"} },\n+\n     { \"hidden\",             \"addpeeraddress\",         &addpeeraddress,         {\"address\", \"port\"} },\n+    { \"hidden\",             \"addconnection\",          &addconnection,          {\"address\", \"connectiontype\"} },",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527792294",
      "id" : 527792294,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc5MjI5NA==",
      "original_commit_id" : "50720f411e05cf1bbaa91174b389c54f3c5287cf",
      "original_line" : 967,
      "original_position" : 76,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 535555222,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527792294",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527793436"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527793436"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0c4d673716f2eb37efdb81ad2d7d20f69de960b3 nit, pass by value or by reference to const, but not const value, idem for the declaration in net.h\r\n```suggestion\r\nbool CConnman::AddConnection(const std::string& address, ConnectionType conn_type)\r\n```",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-20T16:06:18Z",
      "diff_hunk" : "@@ -1156,6 +1156,30 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n+bool CConnman::AddConnection(const std::string& address, const ConnectionType conn_type)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527793436",
      "id" : 527793436,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc5MzQzNg==",
      "original_commit_id" : "50720f411e05cf1bbaa91174b389c54f3c5287cf",
      "original_line" : 1159,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 535555222,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527793436",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527795332"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527795332"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0c4d673716f2eb37efdb81ad2d7d2\r\n\r\n```suggestion\r\n    OpenNetworkConnection(CAddress(), /* fCountFailure */ false, &grant, address.c_str(), conn_type);\r\n```",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-20T16:09:25Z",
      "diff_hunk" : "@@ -1152,6 +1152,37 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n+bool CConnman::AddConnection(const std::string& address, const ConnectionType conn_type)\n+{\n+    assert(conn_type == ConnectionType::OUTBOUND_FULL_RELAY || conn_type == ConnectionType::BLOCK_RELAY);\n+\n+    int outbound_full_relay = 0;\n+    int outbound_block_relay = 0;\n+\n+    {\n+        // count existing connections for each type\n+        LOCK(cs_vNodes);\n+        for (const CNode* pnode : vNodes) {\n+            if (pnode->m_conn_type == ConnectionType::OUTBOUND_FULL_RELAY) {\n+                ++outbound_full_relay;\n+            } else if (pnode->m_conn_type == ConnectionType::BLOCK_RELAY) {\n+                ++outbound_block_relay;\n+            }\n+        }\n+    }\n+\n+    // max connections of specified type already exist\n+    if (conn_type == ConnectionType::OUTBOUND_FULL_RELAY && outbound_full_relay >= m_max_outbound_full_relay) return false;\n+    if (conn_type == ConnectionType::BLOCK_RELAY && outbound_block_relay >= m_max_outbound_block_relay) return false;\n+\n+    // max total outbound connections already exist\n+    CSemaphoreGrant grant(*semOutbound, true);\n+    if (!grant) return false;\n+\n+    OpenNetworkConnection(CAddress(), false, &grant, address.c_str(), conn_type);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527795332",
      "id" : 527795332,
      "in_reply_to_id" : 521290049,
      "line" : 1152,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc5NTMzMg==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 1152,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 21,
      "pull_request_review_id" : 535555222,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527795332",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527796158"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527796158"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree with returning a boolean; it may also be convenient for it to return the peer id of the connection via an out param.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-20T16:10:36Z",
      "diff_hunk" : "@@ -1152,6 +1152,37 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n+bool CConnman::AddConnection(const std::string& address, const ConnectionType conn_type)\n+{\n+    assert(conn_type == ConnectionType::OUTBOUND_FULL_RELAY || conn_type == ConnectionType::BLOCK_RELAY);\n+\n+    int outbound_full_relay = 0;\n+    int outbound_block_relay = 0;\n+\n+    {\n+        // count existing connections for each type\n+        LOCK(cs_vNodes);\n+        for (const CNode* pnode : vNodes) {\n+            if (pnode->m_conn_type == ConnectionType::OUTBOUND_FULL_RELAY) {\n+                ++outbound_full_relay;\n+            } else if (pnode->m_conn_type == ConnectionType::BLOCK_RELAY) {\n+                ++outbound_block_relay;\n+            }\n+        }\n+    }\n+\n+    // max connections of specified type already exist\n+    if (conn_type == ConnectionType::OUTBOUND_FULL_RELAY && outbound_full_relay >= m_max_outbound_full_relay) return false;\n+    if (conn_type == ConnectionType::BLOCK_RELAY && outbound_block_relay >= m_max_outbound_block_relay) return false;\n+\n+    // max total outbound connections already exist\n+    CSemaphoreGrant grant(*semOutbound, true);\n+    if (!grant) return false;\n+\n+    OpenNetworkConnection(CAddress(), false, &grant, address.c_str(), conn_type);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527796158",
      "id" : 527796158,
      "in_reply_to_id" : 521290049,
      "line" : 1152,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc5NjE1OA==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 1152,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 21,
      "pull_request_review_id" : 535555222,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527796158",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527797992"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527797992"
         }
      },
      "author_association" : "MEMBER",
      "body" : "50720f411e05 Suggest also testing passing \"outbound\" in one of these calls (and one with e.g. \"  OUTbound \" if you make it case-insensitive and trimmed)",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-20T16:13:28Z",
      "diff_hunk" : "@@ -0,0 +1,94 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527797992",
      "id" : 527797992,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc5Nzk5Mg==",
      "original_commit_id" : "50720f411e05cf1bbaa91174b389c54f3c5287cf",
      "original_line" : 26,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 535555222,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527797992",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527799898"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527799898"
         }
      },
      "author_association" : "MEMBER",
      "body" : "50720f411e05cf1bba fun nit, can use `product` here (thanks to @jnewbery for the tip a few months ago) to replace these two blocks:\r\n```diff\r\n+from itertools import product\r\n...\r\n-        self.log.info(\"Add 2 block-relay-only connections to node 0\")\r\n-        for i in range(2):\r\n-            self.log.info(\"block-relay-only: {}\".format(i))\r\n-            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\r\n-\r\n-        self.log.info(\"Add 2 block-relay-only connections to node 1\")\r\n-        for i in range(2):\r\n-            self.log.info(\"block-relay-only: {}\".format(i))\r\n-            self.nodes[1].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\r\n+        self.log.info(\"Add 2 block-relay-only connections to nodes 0 and 1\")\r\n+        for node, conn in product(range(2), range(2)):\r\n+            self.log.info(\"node {}, block-relay-only conn {}\".format(node, conn))\r\n+            self.nodes[node].add_outbound_p2p_connection(P2PInterface(), connection_type=\"BlockRelay\")\r\n```\r\n ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-20T16:16:24Z",
      "diff_hunk" : "@@ -0,0 +1,94 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 1\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527799898",
      "id" : 527799898,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc5OTg5OA==",
      "original_commit_id" : "50720f411e05cf1bbaa91174b389c54f3c5287cf",
      "original_line" : 41,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 535555222,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527799898",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527801276"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527801276"
         }
      },
      "author_association" : "MEMBER",
      "body" : "50720f411e05c maybe log and simplify\r\n```diff\r\n-        # check node0 has all outbound connections\r\n-        node0_peers = []\r\n-        for i in range(10):\r\n-            node0_peers.append(self.nodes[0].getpeerinfo()[i]['inbound'])\r\n-        assert_equal(node0_peers.count(False), 10)\r\n+        self.log.info(\"Check node 0 has outbound connections only\")\r\n+        info = self.nodes[0].getnetworkinfo()\r\n+        assert_equal([0, 10], [info[\"connections_in\"], info[\"connections_out\"]])\r\n```",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-20T16:18:38Z",
      "diff_hunk" : "@@ -0,0 +1,94 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 1\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add some inbound connections to node 1\")\n+        for i in range(5):\n+            self.log.info(\"inbound: {}\".format(i))\n+            self.nodes[1].add_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 8 outbounds to node 1\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Check the connections opened as expected\")\n+        assert_equal(len(self.nodes[0].getpeerinfo()), 10)\n+        assert_equal(len(self.nodes[1].getpeerinfo()), 15)\n+\n+        # check node0 has all outbound connections\n+        node0_peers = []\n+        for i in range(10):\n+            node0_peers.append(self.nodes[0].getpeerinfo()[i]['inbound'])\n+        assert_equal(node0_peers.count(False), 10)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527801276",
      "id" : 527801276,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgwMTI3Ng==",
      "original_commit_id" : "50720f411e05cf1bbaa91174b389c54f3c5287cf",
      "original_line" : 56,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 535555222,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527801276",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527802854"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527802854"
         }
      },
      "author_association" : "MEMBER",
      "body" : "50720f411e05cf1bbaa91174b389c54f3c5287cf perhaps log and simplify\r\n```diff\r\n-        # check node1 has 10 outbounds & 5 inbounds\r\n-        node1_peers = []\r\n-        for i in range(15):\r\n-            node1_peers.append(self.nodes[1].getpeerinfo()[i]['inbound'])\r\n \r\n-        assert_equal(node1_peers.count(False), 10)\r\n-        assert_equal(node1_peers.count(True), 5)\r\n+        self.log.info(\"Check node 1 has 5 inbound and 10 outbound connections\")\r\n+        info = self.nodes[1].getnetworkinfo()\r\n+        assert_equal([5, 10], [info[\"connections_in\"], info[\"connections_out\"]])\r\n```\r\n",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-20T16:20:50Z",
      "diff_hunk" : "@@ -0,0 +1,94 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 1\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add some inbound connections to node 1\")\n+        for i in range(5):\n+            self.log.info(\"inbound: {}\".format(i))\n+            self.nodes[1].add_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 8 outbounds to node 1\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Check the connections opened as expected\")\n+        assert_equal(len(self.nodes[0].getpeerinfo()), 10)\n+        assert_equal(len(self.nodes[1].getpeerinfo()), 15)\n+\n+        # check node0 has all outbound connections\n+        node0_peers = []\n+        for i in range(10):\n+            node0_peers.append(self.nodes[0].getpeerinfo()[i]['inbound'])\n+        assert_equal(node0_peers.count(False), 10)\n+\n+        # check node1 has 10 outbounds & 5 inbounds\n+        node1_peers = []\n+        for i in range(15):\n+            node1_peers.append(self.nodes[1].getpeerinfo()[i]['inbound'])\n+\n+        assert_equal(node1_peers.count(False), 10)\n+        assert_equal(node1_peers.count(True), 5)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527802854",
      "id" : 527802854,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgwMjg1NA==",
      "original_commit_id" : "50720f411e05cf1bbaa91174b389c54f3c5287cf",
      "original_line" : 64,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 535555222,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527802854",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527803556"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527803556"
         }
      },
      "author_association" : "MEMBER",
      "body" : "50720f411e05cf1bba added these as sanity checks. Could add a helper test that checks the passed number of in/out connections for each node, e.g. `self.test_conns([(0, 10), (5, 10)])` to assert these convienently \r\n```diff\r\n         self.log.info(\"Disconnect p2p connections & try to re-open\")\r\n         self.nodes[0].disconnect_p2ps()\r\n+        assert_equal(self.nodes[0].getnetworkinfo()[\"connections_out\"], 0)\r\n+        assert_equal(self.nodes[1].getnetworkinfo()[\"connections_in\"], 5)\r\n+        assert_equal(self.nodes[1].getnetworkinfo()[\"connections_out\"], 10)\r\n \r\n         self.log.info(\"Add 8 outbounds to node 0\")\r\n         for i in range(8):\r\n             self.log.info(\"outbound: {}\".format(i))\r\n             self.nodes[0].add_outbound_p2p_connection(P2PInterface())\r\n+        assert_equal(self.nodes[0].getnetworkinfo()[\"connections_out\"], 8)\r\n+        assert_equal(self.nodes[1].getnetworkinfo()[\"connections\"], 15)\r\n \r\n         self.log.info(\"Add 2 block-relay-only connections to node 0\")\r\n         for i in range(2):\r\n             self.log.info(\"block-relay-only: {}\".format(i))\r\n             self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\r\n+        assert_equal(self.nodes[0].getnetworkinfo()[\"connections_out\"], 10)\r\n+        assert_equal(self.nodes[1].getnetworkinfo()[\"connections\"], 15)\r\n \r\n         self.log.info(\"Restart node 0 and try to reconnect to p2ps\")\r\n         self.restart_node(0)\r\n@@ -83,11 +82,15 @@ class P2PAddConnections(BitcoinTestFramework):\r\n         for i in range(8):\r\n             self.log.info(\"outbound: {}\".format(i))\r\n             self.nodes[0].add_outbound_p2p_connection(P2PInterface())\r\n+        assert_equal(self.nodes[0].getnetworkinfo()[\"connections_out\"], 8)\r\n+        assert_equal(self.nodes[1].getnetworkinfo()[\"connections\"], 15)\r\n \r\n         self.log.info(\"Add 2 block-relay-only connections to node 0\")\r\n         for i in range(2):\r\n             self.log.info(\"block-relay-only: {}\".format(i))\r\n             self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\r\n+        assert_equal(self.nodes[0].getnetworkinfo()[\"connections_out\"], 10)\r\n+        assert_equal(self.nodes[1].getnetworkinfo()[\"connections\"], 15)\r\n ```\r\n",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-20T16:21:59Z",
      "diff_hunk" : "@@ -0,0 +1,94 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 1\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add some inbound connections to node 1\")\n+        for i in range(5):\n+            self.log.info(\"inbound: {}\".format(i))\n+            self.nodes[1].add_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 8 outbounds to node 1\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Check the connections opened as expected\")\n+        assert_equal(len(self.nodes[0].getpeerinfo()), 10)\n+        assert_equal(len(self.nodes[1].getpeerinfo()), 15)\n+\n+        # check node0 has all outbound connections\n+        node0_peers = []\n+        for i in range(10):\n+            node0_peers.append(self.nodes[0].getpeerinfo()[i]['inbound'])\n+        assert_equal(node0_peers.count(False), 10)\n+\n+        # check node1 has 10 outbounds & 5 inbounds\n+        node1_peers = []\n+        for i in range(15):\n+            node1_peers.append(self.nodes[1].getpeerinfo()[i]['inbound'])\n+\n+        assert_equal(node1_peers.count(False), 10)\n+        assert_equal(node1_peers.count(True), 5)\n+\n+        self.log.info(\"Disconnect p2p connections & try to re-open\")\n+        self.nodes[0].disconnect_p2ps()\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Restart node 0 and try to reconnect to p2ps\")\n+        self.restart_node(0)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527803556",
      "id" : 527803556,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgwMzU1Ng==",
      "original_commit_id" : "50720f411e05cf1bbaa91174b389c54f3c5287cf",
      "original_line" : 85,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 535555222,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527803556",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527812329"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527812329"
         }
      },
      "author_association" : "MEMBER",
      "body" : "OCD nit, maybe enclose `50 - 0.001` in parens, or better yet, assign this magical entity to a well-named variable (or with a comment) that documents what/why",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-20T16:35:08Z",
      "diff_hunk" : "@@ -69,18 +49,55 @@ def run_test(self):\n         peer_2_info = self.nodes[0].getpeerinfo()[1]\n         assert_equal(peer_2_info['whitelisted'], True)\n         assert_equal(peer_2_info['permissions'], ['noban', 'forcerelay', 'relay', 'mempool', 'download'])\n-        assert_equal(self.nodes[0].testmempoolaccept([sigtx])[0]['allowed'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n \n         self.log.info('Check that the tx from forcerelay first_peer is relayed to others (ie.second_peer)')\n         with self.nodes[0].assert_debug_log([\"received getdata\"]):\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the forcerelay peer is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Forcerelay peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n+        self.nodes[0].sendrawtransaction(tx_hex)\n+        conn.sync_with_ping()\n+        assert(txid not in conn.get_invs())\n+\n+    def check_p2p_tx_violation(self, index=1):\n+        self.log.info('Check that txs from P2P are rejected and result in disconnect')\n+        input_txid = self.nodes[0].getblock(self.nodes[0].getblockhash(index), 2)['tx'][0]['txid']\n+        tx = create_transaction(self.nodes[0], input_txid, self.nodes[0].getnewaddress(), amount=50 - 0.001)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527812329",
      "id" : 527812329,
      "in_reply_to_id" : 473866387,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgxMjMyOQ==",
      "original_commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "original_line" : 99,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 535555222,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527812329",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527816958"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527816958"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(\"BlockRelay\" in the suggestion because I was testing the case-insensitive code above)",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-20T16:42:11Z",
      "diff_hunk" : "@@ -0,0 +1,94 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 1\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527816958",
      "id" : 527816958,
      "in_reply_to_id" : 527799898,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgxNjk1OA==",
      "original_commit_id" : "50720f411e05cf1bbaa91174b389c54f3c5287cf",
      "original_line" : 41,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 535590786,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527816958",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527820759"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527820759"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(getnetworkinfo didn't have these two fields yet when you opened this PR)",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-20T16:47:16Z",
      "diff_hunk" : "@@ -0,0 +1,94 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 1\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add some inbound connections to node 1\")\n+        for i in range(5):\n+            self.log.info(\"inbound: {}\".format(i))\n+            self.nodes[1].add_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 8 outbounds to node 1\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Check the connections opened as expected\")\n+        assert_equal(len(self.nodes[0].getpeerinfo()), 10)\n+        assert_equal(len(self.nodes[1].getpeerinfo()), 15)\n+\n+        # check node0 has all outbound connections\n+        node0_peers = []\n+        for i in range(10):\n+            node0_peers.append(self.nodes[0].getpeerinfo()[i]['inbound'])\n+        assert_equal(node0_peers.count(False), 10)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527820759",
      "id" : 527820759,
      "in_reply_to_id" : 527801276,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgyMDc1OQ==",
      "original_commit_id" : "50720f411e05cf1bbaa91174b389c54f3c5287cf",
      "original_line" : 56,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 535595686,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/527820759",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528262717"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528262717"
         }
      },
      "author_association" : "MEMBER",
      "body" : "what would be described in the result field? ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-22T00:45:29Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connectiontype\", RPCArg::Type::STR, RPCArg::Optional::NO, \"'outbound' or 'blockrelay'.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connectiontype\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    if (!Params().IsMockableChain()) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only.\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in = request.params[1].get_str();\n+    ConnectionType conn_type{};\n+    if (conn_type_in == \"outbound\") {\n+        conn_type = ConnectionType::OUTBOUND_FULL_RELAY;\n+    } else if (conn_type_in == \"blockrelay\") {\n+        conn_type = ConnectionType::BLOCK_RELAY;\n+    } else {\n+        throw std::runtime_error(self.ToString());\n+    }\n+\n+    NodeContext& context = EnsureNodeContext(request.context);\n+    if (!context.connman) {\n+        throw JSONRPCError(RPC_CLIENT_P2P_DISABLED, \"Error: Peer-to-peer functionality missing or disabled.\");\n+    }\n+\n+    const bool success = context.connman->AddConnection(address, conn_type);\n+    if (!success) {\n+        throw JSONRPCError(RPC_CLIENT_NODE_CAPACITY_REACHED, \"Error: Already at capacity for specified connection type.\");\n+    }\n+\n+    UniValue info(UniValue::VOBJ);\n+    info.pushKV(\"address\", address);\n+    info.pushKV(\"connectiontype\", conn_type_in);\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528262717",
      "id" : 528262717,
      "in_reply_to_id" : 527791634,
      "line" : 367,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI2MjcxNw==",
      "original_commit_id" : "50720f411e05cf1bbaa91174b389c54f3c5287cf",
      "original_line" : 367,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 61,
      "pull_request_review_id" : 536019931,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528262717",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528268488"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528268488"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-22T01:56:16Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connectiontype\", RPCArg::Type::STR, RPCArg::Optional::NO, \"'outbound' or 'blockrelay'.\"},",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528268488",
      "id" : 528268488,
      "in_reply_to_id" : 527789415,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI2ODQ4OA==",
      "original_commit_id" : "50720f411e05cf1bbaa91174b389c54f3c5287cf",
      "original_line" : 332,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 536022695,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528268488",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528268519"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528268519"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-22T01:56:35Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connectiontype\", RPCArg::Type::STR, RPCArg::Optional::NO, \"'outbound' or 'blockrelay'.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connectiontype\", \"Type of connection opened.\" },",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528268519",
      "id" : 528268519,
      "in_reply_to_id" : 527790065,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI2ODUxOQ==",
      "original_commit_id" : "50720f411e05cf1bbaa91174b389c54f3c5287cf",
      "original_line" : 338,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 536022708,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528268519",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528268543"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528268543"
         }
      },
      "author_association" : "MEMBER",
      "body" : "cool, thanks. done ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-22T01:57:02Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connectiontype\", RPCArg::Type::STR, RPCArg::Optional::NO, \"'outbound' or 'blockrelay'.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connectiontype\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    if (!Params().IsMockableChain()) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only.\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in = request.params[1].get_str();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528268543",
      "id" : 528268543,
      "in_reply_to_id" : 527790484,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI2ODU0Mw==",
      "original_commit_id" : "50720f411e05cf1bbaa91174b389c54f3c5287cf",
      "original_line" : 352,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 536022724,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528268543",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528268593"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528268593"
         }
      },
      "author_association" : "MEMBER",
      "body" : "also, what are some use cases you have in mind for returning the peer's id? ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-22T01:57:39Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connectiontype\", RPCArg::Type::STR, RPCArg::Optional::NO, \"'outbound' or 'blockrelay'.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connectiontype\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    if (!Params().IsMockableChain()) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only.\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in = request.params[1].get_str();\n+    ConnectionType conn_type{};\n+    if (conn_type_in == \"outbound\") {\n+        conn_type = ConnectionType::OUTBOUND_FULL_RELAY;\n+    } else if (conn_type_in == \"blockrelay\") {\n+        conn_type = ConnectionType::BLOCK_RELAY;\n+    } else {\n+        throw std::runtime_error(self.ToString());\n+    }\n+\n+    NodeContext& context = EnsureNodeContext(request.context);\n+    if (!context.connman) {\n+        throw JSONRPCError(RPC_CLIENT_P2P_DISABLED, \"Error: Peer-to-peer functionality missing or disabled.\");\n+    }\n+\n+    const bool success = context.connman->AddConnection(address, conn_type);\n+    if (!success) {\n+        throw JSONRPCError(RPC_CLIENT_NODE_CAPACITY_REACHED, \"Error: Already at capacity for specified connection type.\");\n+    }\n+\n+    UniValue info(UniValue::VOBJ);\n+    info.pushKV(\"address\", address);\n+    info.pushKV(\"connectiontype\", conn_type_in);\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528268593",
      "id" : 528268593,
      "in_reply_to_id" : 527791634,
      "line" : 367,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI2ODU5Mw==",
      "original_commit_id" : "50720f411e05cf1bbaa91174b389c54f3c5287cf",
      "original_line" : 367,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 61,
      "pull_request_review_id" : 536022743,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528268593",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528268612"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528268612"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-22T01:57:56Z",
      "diff_hunk" : "@@ -1156,6 +1156,30 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n+bool CConnman::AddConnection(const std::string& address, const ConnectionType conn_type)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528268612",
      "id" : 528268612,
      "in_reply_to_id" : 527793436,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI2ODYxMg==",
      "original_commit_id" : "50720f411e05cf1bbaa91174b389c54f3c5287cf",
      "original_line" : 1159,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 536022752,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528268612",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528268634"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528268634"
         }
      },
      "author_association" : "MEMBER",
      "body" : "added outbound to one and BlockRelay to another ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-22T01:58:17Z",
      "diff_hunk" : "@@ -0,0 +1,94 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528268634",
      "id" : 528268634,
      "in_reply_to_id" : 527797992,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI2ODYzNA==",
      "original_commit_id" : "50720f411e05cf1bbaa91174b389c54f3c5287cf",
      "original_line" : 26,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 536022764,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528268634",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528269456"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528269456"
         }
      },
      "author_association" : "MEMBER",
      "body" : "thanks but I am a pass, within the context of this test, I find this a bit less clear in terms of test structure (putting together node 0 & 1) and logging. ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-22T02:08:30Z",
      "diff_hunk" : "@@ -0,0 +1,94 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 1\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528269456",
      "id" : 528269456,
      "in_reply_to_id" : 527799898,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI2OTQ1Ng==",
      "original_commit_id" : "50720f411e05cf1bbaa91174b389c54f3c5287cf",
      "original_line" : 41,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 536023157,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528269456",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528269529"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528269529"
         }
      },
      "author_association" : "MEMBER",
      "body" : "cool thanks, incorporated the `getnetworkinfo` call. definitely cleaner.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-22T02:09:19Z",
      "diff_hunk" : "@@ -0,0 +1,94 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 1\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add some inbound connections to node 1\")\n+        for i in range(5):\n+            self.log.info(\"inbound: {}\".format(i))\n+            self.nodes[1].add_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 8 outbounds to node 1\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Check the connections opened as expected\")\n+        assert_equal(len(self.nodes[0].getpeerinfo()), 10)\n+        assert_equal(len(self.nodes[1].getpeerinfo()), 15)\n+\n+        # check node0 has all outbound connections\n+        node0_peers = []\n+        for i in range(10):\n+            node0_peers.append(self.nodes[0].getpeerinfo()[i]['inbound'])\n+        assert_equal(node0_peers.count(False), 10)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528269529",
      "id" : 528269529,
      "in_reply_to_id" : 527801276,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI2OTUyOQ==",
      "original_commit_id" : "50720f411e05cf1bbaa91174b389c54f3c5287cf",
      "original_line" : 56,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 536023186,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528269529",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528269676"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528269676"
         }
      },
      "author_association" : "MEMBER",
      "body" : "same as https://github.com/bitcoin/bitcoin/pull/19315#discussion_r527801276, it's been updated",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-22T02:10:34Z",
      "diff_hunk" : "@@ -0,0 +1,94 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 1\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add some inbound connections to node 1\")\n+        for i in range(5):\n+            self.log.info(\"inbound: {}\".format(i))\n+            self.nodes[1].add_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 8 outbounds to node 1\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Check the connections opened as expected\")\n+        assert_equal(len(self.nodes[0].getpeerinfo()), 10)\n+        assert_equal(len(self.nodes[1].getpeerinfo()), 15)\n+\n+        # check node0 has all outbound connections\n+        node0_peers = []\n+        for i in range(10):\n+            node0_peers.append(self.nodes[0].getpeerinfo()[i]['inbound'])\n+        assert_equal(node0_peers.count(False), 10)\n+\n+        # check node1 has 10 outbounds & 5 inbounds\n+        node1_peers = []\n+        for i in range(15):\n+            node1_peers.append(self.nodes[1].getpeerinfo()[i]['inbound'])\n+\n+        assert_equal(node1_peers.count(False), 10)\n+        assert_equal(node1_peers.count(True), 5)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528269676",
      "id" : 528269676,
      "in_reply_to_id" : 527802854,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI2OTY3Ng==",
      "original_commit_id" : "50720f411e05cf1bbaa91174b389c54f3c5287cf",
      "original_line" : 64,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 536023237,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528269676",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528269702"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528269702"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ð added a helper to compare connections using `getnetworkinfo` and added more checks. ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-22T02:11:01Z",
      "diff_hunk" : "@@ -0,0 +1,94 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 1\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add some inbound connections to node 1\")\n+        for i in range(5):\n+            self.log.info(\"inbound: {}\".format(i))\n+            self.nodes[1].add_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 8 outbounds to node 1\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Check the connections opened as expected\")\n+        assert_equal(len(self.nodes[0].getpeerinfo()), 10)\n+        assert_equal(len(self.nodes[1].getpeerinfo()), 15)\n+\n+        # check node0 has all outbound connections\n+        node0_peers = []\n+        for i in range(10):\n+            node0_peers.append(self.nodes[0].getpeerinfo()[i]['inbound'])\n+        assert_equal(node0_peers.count(False), 10)\n+\n+        # check node1 has 10 outbounds & 5 inbounds\n+        node1_peers = []\n+        for i in range(15):\n+            node1_peers.append(self.nodes[1].getpeerinfo()[i]['inbound'])\n+\n+        assert_equal(node1_peers.count(False), 10)\n+        assert_equal(node1_peers.count(True), 5)\n+\n+        self.log.info(\"Disconnect p2p connections & try to re-open\")\n+        self.nodes[0].disconnect_p2ps()\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Restart node 0 and try to reconnect to p2ps\")\n+        self.restart_node(0)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528269702",
      "id" : 528269702,
      "in_reply_to_id" : 527803556,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI2OTcwMg==",
      "original_commit_id" : "50720f411e05cf1bbaa91174b389c54f3c5287cf",
      "original_line" : 85,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 536023249,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528269702",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528269854"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528269854"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@MarcoFalke, @jnewbery if you get the chance, lmk if this looks good and I'll resolve. but leaving the thread open for now bc I want a second opinion on whether I've solved the issue ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-22T02:12:47Z",
      "diff_hunk" : "@@ -78,13 +62,54 @@ def run_test(self):\n             # But if, for some reason, first_peer decides to relay transactions to us anyway, we should relay them to\n             # second_peer since we gave relay permission to first_peer.\n             # See https://github.com/bitcoin/bitcoin/issues/19943 for details.\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the peer with relay-permission is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Relay-permission peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        # bump time forward to ensure nNextInvSend timer pops\n+        self.nodes[0].setmocktime(int(time.time()) + 5)\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n+        self.nodes[0].sendrawtransaction(tx_hex)\n+        conn.sync_with_ping()\n+        assert(int(txid, 16) not in conn.get_invs())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528269854",
      "id" : 528269854,
      "in_reply_to_id" : 521304814,
      "line" : 98,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODI2OTg1NA==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 98,
      "original_position" : 126,
      "original_start_line" : 93,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 128,
      "pull_request_review_id" : 536023321,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : 97,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528269854",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "thanks for the review @jonatack, I've taken most of your feedback (and left comments / questions on the rest) \r\n\r\nlooks like the [one CI failure](https://cirrus-ci.com/task/4545582645641216?command=ci#L3449) is indeed based on this code. In `p2p_add_connections`, in the section \"Disconnect p2p connections & try to re-open\", the call to `check_node_connections` is failing because it seems that `getnetworkinfo()['connections_out']` is returning 4 instead of 0. it seems strange because `TestNode.disconnect_p2ps()` waits until `self.getpeerinfo()` is 0 for all peers with `['subver']` set (aka p2p connections). I'm not currently seeing how this inconsistency can arise, so I'll have to dig deeper. Sharing here incase anybody has ideas or pointers :) \r\n",
      "created_at" : "2020-11-23T01:21:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-731884495",
      "id" : 731884495,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczMTg4NDQ5NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-23T01:21:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/731884495",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528441996"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528441996"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yep, `testmempoolaccept` is unnecessary here. And if you need to make sure it's in mempool then submit + `getmempoolentry` is the move.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-23T02:01:01Z",
      "diff_hunk" : "@@ -69,18 +53,58 @@ def run_test(self):\n         peer_2_info = self.nodes[0].getpeerinfo()[1]\n         assert_equal(peer_2_info['whitelisted'], True)\n         assert_equal(peer_2_info['permissions'], ['noban', 'forcerelay', 'relay', 'mempool', 'download'])\n-        assert_equal(self.nodes[0].testmempoolaccept([sigtx])[0]['allowed'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n \n         self.log.info('Check that the tx from forcerelay first_peer is relayed to others (ie.second_peer)')\n         with self.nodes[0].assert_debug_log([\"received getdata\"]):\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the forcerelay peer is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Forcerelay peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        # bump time forward to ensure nNextInvSend timer pops\n+        self.nodes[0].setmocktime(int(time.time()) + 5)\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528441996",
      "id" : 528441996,
      "in_reply_to_id" : 479353496,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ0MTk5Ng==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 91,
      "original_position" : 118,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 536145820,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528441996",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528970423"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528970423"
         }
      },
      "author_association" : "MEMBER",
      "body" : "New helper :+1:, just add named args in the callers (maybe drop the `num_` prefixes).\r\n```suggestion\r\n        self.check_node_connections(num_node=1, num_in=5, num_out=10)\r\n```",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-23T20:16:25Z",
      "diff_hunk" : "@@ -0,0 +1,92 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def check_node_connections(self, num_node, num_in, num_out):\n+        info = self.nodes[num_node].getnetworkinfo()\n+        assert_equal(info[\"connections_in\"], num_in)\n+        assert_equal(info[\"connections_out\"], num_out)\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"outbound\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"BlockRelay\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 1\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add some inbound connections to node 1\")\n+        for i in range(5):\n+            self.log.info(\"inbound: {}\".format(i))\n+            self.nodes[1].add_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 8 outbounds to node 1\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Check the connections opened as expected\")\n+        self.check_node_connections(0, 0, 10)\n+        self.check_node_connections(1, 5, 10)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528970423",
      "id" : 528970423,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk3MDQyMw==",
      "original_commit_id" : "e400c7eb7dec42db50c2d667d72b0a87f0a25ab1",
      "original_line" : 55,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 536813087,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528970423",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528974077"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528974077"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Heh, to re-test I found myself looking for a test file named \"rpc_addconnection.py\"",
      "commit_id" : "e400c7eb7dec42db50c2d667d72b0a87f0a25ab1",
      "created_at" : "2020-11-23T20:23:43Z",
      "diff_hunk" : "@@ -0,0 +1,92 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def check_node_connections(self, num_node, num_in, num_out):\n+        info = self.nodes[num_node].getnetworkinfo()\n+        assert_equal(info[\"connections_in\"], num_in)\n+        assert_equal(info[\"connections_out\"], num_out)\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"outbound\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"BlockRelay\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 1\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add some inbound connections to node 1\")\n+        for i in range(5):\n+            self.log.info(\"inbound: {}\".format(i))\n+            self.nodes[1].add_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 8 outbounds to node 1\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Check the connections opened as expected\")\n+        self.check_node_connections(0, 0, 10)\n+        self.check_node_connections(1, 5, 10)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528974077",
      "id" : 528974077,
      "in_reply_to_id" : 528970423,
      "line" : 55,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk3NDA3Nw==",
      "original_commit_id" : "e400c7eb7dec42db50c2d667d72b0a87f0a25ab1",
      "original_line" : 55,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : 55,
      "pull_request_review_id" : 536817893,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-23T20:23:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528974077",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528979140"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528979140"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is there any point in also testing calls like\r\n```python\r\nself.nodes[0].addconnection(\"127.0.0.1:36848\", \"outbound\")\r\n```\r\n",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-23T20:33:51Z",
      "diff_hunk" : "@@ -0,0 +1,92 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def check_node_connections(self, num_node, num_in, num_out):\n+        info = self.nodes[num_node].getnetworkinfo()\n+        assert_equal(info[\"connections_in\"], num_in)\n+        assert_equal(info[\"connections_out\"], num_out)\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"outbound\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528979140",
      "id" : 528979140,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk3OTE0MA==",
      "original_commit_id" : "e400c7eb7dec42db50c2d667d72b0a87f0a25ab1",
      "original_line" : 31,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 536824378,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528979140",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528984312"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528984312"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Off-hand, I imagined the peer id might be useful for testing, but that can wait until there is an actual use case or need for it. The result might be a success (`\"result\": \"connection successful\"`) or failure (`\"error\": \"unable to connect\"`), but I'm not sure how much `addconnection` would be used manually in the CLI or like https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528979140 that returns the object (I didn't look at how to introspect  test_framework.p2p.P2PInterface objects yet). At any rate, I don't want to hold this up. We need more p2p testing tools.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-23T20:44:07Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connectiontype\", RPCArg::Type::STR, RPCArg::Optional::NO, \"'outbound' or 'blockrelay'.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connectiontype\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    if (!Params().IsMockableChain()) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only.\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in = request.params[1].get_str();\n+    ConnectionType conn_type{};\n+    if (conn_type_in == \"outbound\") {\n+        conn_type = ConnectionType::OUTBOUND_FULL_RELAY;\n+    } else if (conn_type_in == \"blockrelay\") {\n+        conn_type = ConnectionType::BLOCK_RELAY;\n+    } else {\n+        throw std::runtime_error(self.ToString());\n+    }\n+\n+    NodeContext& context = EnsureNodeContext(request.context);\n+    if (!context.connman) {\n+        throw JSONRPCError(RPC_CLIENT_P2P_DISABLED, \"Error: Peer-to-peer functionality missing or disabled.\");\n+    }\n+\n+    const bool success = context.connman->AddConnection(address, conn_type);\n+    if (!success) {\n+        throw JSONRPCError(RPC_CLIENT_NODE_CAPACITY_REACHED, \"Error: Already at capacity for specified connection type.\");\n+    }\n+\n+    UniValue info(UniValue::VOBJ);\n+    info.pushKV(\"address\", address);\n+    info.pushKV(\"connectiontype\", conn_type_in);\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r528984312",
      "id" : 528984312,
      "in_reply_to_id" : 527791634,
      "line" : 367,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk4NDMxMg==",
      "original_commit_id" : "50720f411e05cf1bbaa91174b389c54f3c5287cf",
      "original_line" : 367,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 61,
      "pull_request_review_id" : 536830825,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/528984312",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> looks like the [one CI failure](https://cirrus-ci.com/task/4545582645641216?command=ci#L3449) is indeed based on this code. In `p2p_add_connections`, in the section \"Disconnect p2p connections & try to re-open\", the call to `check_node_connections` is failing because it seems that `getnetworkinfo()['connections_out']` is returning 4 instead of 0. it seems strange because `TestNode.disconnect_p2ps()` waits until `self.getpeerinfo()` is 0 for all peers with `['subver']` set (aka p2p connections). I'm not currently seeing how this inconsistency can arise, so I'll have to dig deeper. Sharing here incase anybody has ideas or pointers :)\r\n\r\nThe test passes for me locally. The issue is only in the multiprocess CI task. Maybe a data race? Edit: maybe compare with the getpeerinfo counts? Ignore me if that doesn't make sense; it's late.",
      "created_at" : "2020-11-23T20:49:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-732418091",
      "id" : 732418091,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczMjQxODA5MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-23T20:53:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/732418091",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r531729151"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/531729151"
         }
      },
      "author_association" : "MEMBER",
      "body" : "okay, I'm going to resolve this comment. we can revisit once there are specific use cases",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-27T18:39:50Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connectiontype\", RPCArg::Type::STR, RPCArg::Optional::NO, \"'outbound' or 'blockrelay'.\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connectiontype\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    if (!Params().IsMockableChain()) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only.\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in = request.params[1].get_str();\n+    ConnectionType conn_type{};\n+    if (conn_type_in == \"outbound\") {\n+        conn_type = ConnectionType::OUTBOUND_FULL_RELAY;\n+    } else if (conn_type_in == \"blockrelay\") {\n+        conn_type = ConnectionType::BLOCK_RELAY;\n+    } else {\n+        throw std::runtime_error(self.ToString());\n+    }\n+\n+    NodeContext& context = EnsureNodeContext(request.context);\n+    if (!context.connman) {\n+        throw JSONRPCError(RPC_CLIENT_P2P_DISABLED, \"Error: Peer-to-peer functionality missing or disabled.\");\n+    }\n+\n+    const bool success = context.connman->AddConnection(address, conn_type);\n+    if (!success) {\n+        throw JSONRPCError(RPC_CLIENT_NODE_CAPACITY_REACHED, \"Error: Already at capacity for specified connection type.\");\n+    }\n+\n+    UniValue info(UniValue::VOBJ);\n+    info.pushKV(\"address\", address);\n+    info.pushKV(\"connectiontype\", conn_type_in);\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r531729151",
      "id" : 531729151,
      "in_reply_to_id" : 527791634,
      "line" : 367,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTcyOTE1MQ==",
      "original_commit_id" : "50720f411e05cf1bbaa91174b389c54f3c5287cf",
      "original_line" : 367,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 61,
      "pull_request_review_id" : 540136505,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/531729151",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r532096690"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532096690"
         }
      },
      "author_association" : "MEMBER",
      "body" : "removed `testmempoolaccept` call ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-28T19:22:55Z",
      "diff_hunk" : "@@ -69,18 +53,58 @@ def run_test(self):\n         peer_2_info = self.nodes[0].getpeerinfo()[1]\n         assert_equal(peer_2_info['whitelisted'], True)\n         assert_equal(peer_2_info['permissions'], ['noban', 'forcerelay', 'relay', 'mempool', 'download'])\n-        assert_equal(self.nodes[0].testmempoolaccept([sigtx])[0]['allowed'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n \n         self.log.info('Check that the tx from forcerelay first_peer is relayed to others (ie.second_peer)')\n         with self.nodes[0].assert_debug_log([\"received getdata\"]):\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the forcerelay peer is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Forcerelay peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        # bump time forward to ensure nNextInvSend timer pops\n+        self.nodes[0].setmocktime(int(time.time()) + 5)\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r532096690",
      "id" : 532096690,
      "in_reply_to_id" : 479353496,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA5NjY5MA==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 91,
      "original_position" : 118,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 540412202,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532096690",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "All review comments are addressed. CI is green.\r\n\r\nThe CI failure was caused by a test framework issue addressed in #20522 (thanks for the find @jnewbery!) Rebased, so hopefully now CI will be green.\r\n\r\nI'm going to resolve comments that propose ideas for follow-ups, and am consolidating them here for convenient future reference \r\n- remove `p2p_blocksonly.py` wallet dependency by using `miniwallet` https://github.com/bitcoin/bitcoin/pull/19315#discussion_r473866387\r\n- update `OpenNetworkConnection()` to return a boolean upon failure & handle appropriately from `addconnection` and `addnode` RPC endpoints https://github.com/bitcoin/bitcoin/pull/19315#discussion_r521290049, including generalizing the error message https://github.com/bitcoin/bitcoin/pull/19315#discussion_r521296406\r\n- add sanity tests for `addconnection` RPC endpoint \r\n\r\nAlso, a reminder for reviewers about https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-696470826, where I left some open questions around design choices, incase anyone wants to weigh in. ",
      "created_at" : "2020-11-28T19:48:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-735282520",
      "id" : 735282520,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNTI4MjUyMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-30T23:50:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/735282520",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r532099463"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532099463"
         }
      },
      "author_association" : "MEMBER",
      "body" : "resolving this conversation, tracking as a future improvement at https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-735282520",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-28T19:50:17Z",
      "diff_hunk" : "@@ -69,18 +49,55 @@ def run_test(self):\n         peer_2_info = self.nodes[0].getpeerinfo()[1]\n         assert_equal(peer_2_info['whitelisted'], True)\n         assert_equal(peer_2_info['permissions'], ['noban', 'forcerelay', 'relay', 'mempool', 'download'])\n-        assert_equal(self.nodes[0].testmempoolaccept([sigtx])[0]['allowed'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n \n         self.log.info('Check that the tx from forcerelay first_peer is relayed to others (ie.second_peer)')\n         with self.nodes[0].assert_debug_log([\"received getdata\"]):\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the forcerelay peer is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Forcerelay peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n+        self.nodes[0].sendrawtransaction(tx_hex)\n+        conn.sync_with_ping()\n+        assert(txid not in conn.get_invs())\n+\n+    def check_p2p_tx_violation(self, index=1):\n+        self.log.info('Check that txs from P2P are rejected and result in disconnect')\n+        input_txid = self.nodes[0].getblock(self.nodes[0].getblockhash(index), 2)['tx'][0]['txid']\n+        tx = create_transaction(self.nodes[0], input_txid, self.nodes[0].getnewaddress(), amount=50 - 0.001)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r532099463",
      "id" : 532099463,
      "in_reply_to_id" : 473866387,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA5OTQ2Mw==",
      "original_commit_id" : "e00848600f27c1495ff1bbc5e6aaa3d4f0cf5c95",
      "original_line" : 99,
      "original_position" : 114,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : null,
      "pull_request_review_id" : 540413701,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532099463",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r532099696"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532099696"
         }
      },
      "author_association" : "MEMBER",
      "body" : "resolving this conversation, tracking better return value from OpenNetworkConnection as a future improvement in https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-735282520",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-28T19:53:07Z",
      "diff_hunk" : "@@ -1152,6 +1152,37 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n+bool CConnman::AddConnection(const std::string& address, const ConnectionType conn_type)\n+{\n+    assert(conn_type == ConnectionType::OUTBOUND_FULL_RELAY || conn_type == ConnectionType::BLOCK_RELAY);\n+\n+    int outbound_full_relay = 0;\n+    int outbound_block_relay = 0;\n+\n+    {\n+        // count existing connections for each type\n+        LOCK(cs_vNodes);\n+        for (const CNode* pnode : vNodes) {\n+            if (pnode->m_conn_type == ConnectionType::OUTBOUND_FULL_RELAY) {\n+                ++outbound_full_relay;\n+            } else if (pnode->m_conn_type == ConnectionType::BLOCK_RELAY) {\n+                ++outbound_block_relay;\n+            }\n+        }\n+    }\n+\n+    // max connections of specified type already exist\n+    if (conn_type == ConnectionType::OUTBOUND_FULL_RELAY && outbound_full_relay >= m_max_outbound_full_relay) return false;\n+    if (conn_type == ConnectionType::BLOCK_RELAY && outbound_block_relay >= m_max_outbound_block_relay) return false;\n+\n+    // max total outbound connections already exist\n+    CSemaphoreGrant grant(*semOutbound, true);\n+    if (!grant) return false;\n+\n+    OpenNetworkConnection(CAddress(), false, &grant, address.c_str(), conn_type);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r532099696",
      "id" : 532099696,
      "in_reply_to_id" : 521290049,
      "line" : 1152,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA5OTY5Ng==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 1152,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 21,
      "pull_request_review_id" : 540413855,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532099696",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r532099720"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532099720"
         }
      },
      "author_association" : "MEMBER",
      "body" : "added named args",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-28T19:53:36Z",
      "diff_hunk" : "@@ -0,0 +1,92 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def check_node_connections(self, num_node, num_in, num_out):\n+        info = self.nodes[num_node].getnetworkinfo()\n+        assert_equal(info[\"connections_in\"], num_in)\n+        assert_equal(info[\"connections_out\"], num_out)\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"outbound\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"BlockRelay\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 1\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add some inbound connections to node 1\")\n+        for i in range(5):\n+            self.log.info(\"inbound: {}\".format(i))\n+            self.nodes[1].add_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 8 outbounds to node 1\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Check the connections opened as expected\")\n+        self.check_node_connections(0, 0, 10)\n+        self.check_node_connections(1, 5, 10)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r532099720",
      "id" : 532099720,
      "in_reply_to_id" : 528970423,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA5OTcyMA==",
      "original_commit_id" : "e400c7eb7dec42db50c2d667d72b0a87f0a25ab1",
      "original_line" : 55,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 540413873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532099720",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r532099993"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532099993"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`addconnection` currently doesn't have sanity tests to the RPC endpoint, but I'm leaving that as a future improvement since I'm trying to maximize reviewability and the added benefit seems small (esp since its a test-only RPC endpoint). this future improvement is tracked in https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-735282520",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-11-28T19:56:04Z",
      "diff_hunk" : "@@ -0,0 +1,92 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def check_node_connections(self, num_node, num_in, num_out):\n+        info = self.nodes[num_node].getnetworkinfo()\n+        assert_equal(info[\"connections_in\"], num_in)\n+        assert_equal(info[\"connections_out\"], num_out)\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"outbound\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r532099993",
      "id" : 532099993,
      "in_reply_to_id" : 528979140,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA5OTk5Mw==",
      "original_commit_id" : "e400c7eb7dec42db50c2d667d72b0a87f0a25ab1",
      "original_line" : 31,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 540414002,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/532099993",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "forgot to update- CI is green. this PR is ready for review! ",
      "created_at" : "2020-11-30T23:51:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-736124441",
      "id" : 736124441,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNjEyNDQ0MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-30T23:51:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/736124441",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533388268"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533388268"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The average delay between sending INVs to outbound peers is 2.5s, so bumping mocktime by 5 seconds is only double the mean. Is there any downside in bumping it by a minute so there's overwhelming probability that the node's timer for sending an INV to this peer has popped?\r\n\r\nYou could also update this to call `sync_with_ping()` twice to ensure that the node has called `SendMessages()` for this peer. Without that, there's a window where the node calls `ProcessMessages()` for the peer, sends the `pong` response and the test moves on to the `assert(int(txid, 16) not in conn.get_invs())` without the node hitting `SendMessages()`. Syncing twice with pings ensures that `ProcessMessages()` is called twice, which means that `SendMessages()` must have been called once.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-01T12:58:43Z",
      "diff_hunk" : "@@ -78,13 +62,54 @@ def run_test(self):\n             # But if, for some reason, first_peer decides to relay transactions to us anyway, we should relay them to\n             # second_peer since we gave relay permission to first_peer.\n             # See https://github.com/bitcoin/bitcoin/issues/19943 for details.\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the peer with relay-permission is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Relay-permission peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        # bump time forward to ensure nNextInvSend timer pops\n+        self.nodes[0].setmocktime(int(time.time()) + 5)\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n+        self.nodes[0].sendrawtransaction(tx_hex)\n+        conn.sync_with_ping()\n+        assert(int(txid, 16) not in conn.get_invs())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533388268",
      "id" : 533388268,
      "in_reply_to_id" : 521304814,
      "line" : 98,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM4ODI2OA==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 98,
      "original_position" : 126,
      "original_start_line" : 93,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 128,
      "pull_request_review_id" : 541868752,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : 97,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533388268",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533390362"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533390362"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You always call this function with all arguments, so no need to have defaults (and in fact the function would fail if you called it without arguments because `self.nodes[None]` is a TypeError.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-01T13:02:26Z",
      "diff_hunk" : "@@ -0,0 +1,92 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def check_node_connections(self, node=None, num_in=None, num_out=None):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533390362",
      "id" : 533390362,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM5MDM2Mg==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 20,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 541871547,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533390362",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533392053"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533392053"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You could also change this to be a standalone function rather than a method in the P2PAddConnections class and just take a node as an argument rather than an index:\r\n\r\n```python\r\ndef check_node_connections(node, num_in, num_out):\r\n    info = node.getnetworkinfo()\r\n    assert_equal(info[\"connections_in\"], num_in)\r\n    assert_equal(info[\"connections_out\"], num_out)\r\n```",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-01T13:05:22Z",
      "diff_hunk" : "@@ -0,0 +1,92 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def check_node_connections(self, node=None, num_in=None, num_out=None):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533392053",
      "id" : 533392053,
      "in_reply_to_id" : 533390362,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM5MjA1Mw==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 20,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 541871547,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533392053",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533393627"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533393627"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Rather than connecting two nodes and then disconnecting them, you can just not have them connect to each other by overriding the `setup_network()` method:\r\n\r\n```python\r\ndef setup_network(self):\r\n    self.setup_nodes()\r\n    # Don't connect the nodes\r\n```",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-01T13:08:06Z",
      "diff_hunk" : "@@ -0,0 +1,92 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def check_node_connections(self, node=None, num_in=None, num_out=None):\n+        info = self.nodes[node].getnetworkinfo()\n+        assert_equal(info[\"connections_in\"], num_in)\n+        assert_equal(info[\"connections_out\"], num_out)\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533393627",
      "id" : 533393627,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM5MzYyNw==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 26,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 541871547,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533393627",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533394134"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533394134"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is there any reason for this line?",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-01T13:08:55Z",
      "diff_hunk" : "@@ -0,0 +1,92 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def check_node_connections(self, node=None, num_in=None, num_out=None):\n+        info = self.nodes[node].getnetworkinfo()\n+        assert_equal(info[\"connections_in\"], num_in)\n+        assert_equal(info[\"connections_out\"], num_out)\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"outbound\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 1\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add some inbound connections to node 1\")\n+        for i in range(5):\n+            self.log.info(\"inbound: {}\".format(i))\n+            self.nodes[1].add_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 8 outbounds to node 1\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Check the connections opened as expected\")\n+        self.check_node_connections(node=0, num_in=0, num_out=10)\n+        self.check_node_connections(node=1, num_in=5, num_out=10)\n+\n+        self.log.info(\"Disconnect p2p connections & try to re-open\")\n+        self.nodes[0].disconnect_p2ps()\n+        self.check_node_connections(node=0, num_in=0, num_out=0)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+        self.check_node_connections(node=0, num_in=0, num_out=8)\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        self.check_node_connections(node=0, num_in=0, num_out=10)\n+\n+        self.log.info(\"Restart node 0 and try to reconnect to p2ps\")\n+        self.restart_node(0)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+        self.check_node_connections(node=0, num_in=0, num_out=8)\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        self.check_node_connections(node=0, num_in=0, num_out=10)\n+\n+        self.check_node_connections(node=1, num_in=5, num_out=10)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533394134",
      "id" : 533394134,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM5NDEzNA==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 88,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 541871547,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533394134",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533394335"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533394335"
         }
      },
      "author_association" : "MEMBER",
      "body" : "sort",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-01T13:09:15Z",
      "diff_hunk" : "@@ -0,0 +1,92 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533394335",
      "id" : 533394335,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM5NDMzNQ==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 7,
      "original_position" : 8,
      "original_start_line" : 7,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 541871547,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533394335",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533394769"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533394769"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Remove this. The test can run without a wallet.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-01T13:09:58Z",
      "diff_hunk" : "@@ -0,0 +1,92 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533394769",
      "id" : 533394769,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM5NDc2OQ==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 19,
      "original_position" : 19,
      "original_start_line" : 17,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 541871547,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533394769",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533455822"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533455822"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That was a nit, to specify _outbound_ at argument comment :p ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-01T14:38:33Z",
      "diff_hunk" : "@@ -346,6 +346,15 @@ class CConnman\n     bool RemoveAddedNode(const std::string& node);\n     std::vector<AddedNodeInfo> GetAddedNodeInfo();\n \n+    /**\n+     * Attempts to open a connection. Currently only used from tests.\n+     *\n+     * @param[in]   address     Address of node to try connecting to\n+     * @param[in]   conn_type   ConnectionType::OUTBOUND or ConnectionType::BLOCK_RELAY\n+     * @return      bool        Returns false if at max connection capacity",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533455822",
      "id" : 533455822,
      "in_reply_to_id" : 521590231,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ1NTgyMg==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 354,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 541962127,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533455822",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533473895"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533473895"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks @ajtowns  for the code reading correction! Okay so the semaphore should accomplish its design of preventing to open too much outbound connections.\r\n\r\n@amitiuttarwar yes I was saying the overall design of this mechanism is confusing thus making it hard to understand the proposed implementation, but not an issue introduced by the present PR. `CSemaphoreGrant` would gain to be documented better but not proposing myself for this :see_no_evil: ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-01T14:54:13Z",
      "diff_hunk" : "@@ -1152,6 +1152,37 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n+bool CConnman::AddConnection(const std::string& address, const ConnectionType conn_type)\n+{\n+    assert(conn_type == ConnectionType::OUTBOUND_FULL_RELAY || conn_type == ConnectionType::BLOCK_RELAY);\n+\n+    int outbound_full_relay = 0;\n+    int outbound_block_relay = 0;\n+\n+    {\n+        // count existing connections for each type\n+        LOCK(cs_vNodes);\n+        for (const CNode* pnode : vNodes) {\n+            if (pnode->m_conn_type == ConnectionType::OUTBOUND_FULL_RELAY) {\n+                ++outbound_full_relay;\n+            } else if (pnode->m_conn_type == ConnectionType::BLOCK_RELAY) {\n+                ++outbound_block_relay;\n+            }\n+        }\n+    }\n+\n+    // max connections of specified type already exist\n+    if (conn_type == ConnectionType::OUTBOUND_FULL_RELAY && outbound_full_relay >= m_max_outbound_full_relay) return false;\n+    if (conn_type == ConnectionType::BLOCK_RELAY && outbound_block_relay >= m_max_outbound_block_relay) return false;\n+\n+    // max total outbound connections already exist\n+    CSemaphoreGrant grant(*semOutbound, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533473895",
      "id" : 533473895,
      "in_reply_to_id" : 521589772,
      "line" : 1149,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ3Mzg5NQ==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 1149,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 18,
      "pull_request_review_id" : 541979845,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533473895",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533553730"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533553730"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I guess that hebasto point is this message could be \"Error: Already at capacity for specified connection type or max total outbound connection already exist\" to cover both failure cases.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-01T16:35:02Z",
      "diff_hunk" : "@@ -320,20 +322,31 @@ static RPCHelpMan addconnection()\n         throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only\");\n     }\n \n-    RPCTypeCheckArgument(request.params, UniValue::VSTR);\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n     const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in = request.params[1].get_str();\n+    ConnectionType conn_type{};\n+    if (conn_type_in == \"outbound\") {\n+        conn_type = ConnectionType::OUTBOUND_FULL_RELAY;\n+    } else if (conn_type_in == \"blockrelay\") {\n+        conn_type = ConnectionType::BLOCK_RELAY;\n+    } else {\n+        throw std::runtime_error(self.ToString());\n+    }\n+\n     NodeContext& context = EnsureNodeContext(request.context);\n     if (!context.connman) {\n         throw JSONRPCError(RPC_CLIENT_P2P_DISABLED, \"Error: Peer-to-peer functionality missing or disabled\");\n     }\n \n-    const bool success = context.connman->AddConnection(address);\n+    const bool success = context.connman->AddConnection(address, conn_type);\n     if (!success) {\n-        throw JSONRPCError(RPC_CLIENT_NODE_CAPACITY_REACHED, \"Error: Max number of outbound full relay connections already open.\");\n+        throw JSONRPCError(RPC_CLIENT_NODE_CAPACITY_REACHED, \"Error: Already at capacity for specified connection type.\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533553730",
      "id" : 533553730,
      "in_reply_to_id" : 499519175,
      "line" : 361,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU1MzczMA==",
      "original_commit_id" : "0fb4635bbabb1bea10a215bde4c803ceb5bc5f26",
      "original_line" : 361,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 55,
      "pull_request_review_id" : 542084165,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533553730",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533554882"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533554882"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should this RPC returns an error if the connection is already existent, like RPC_CLIENT_NODE_ALREADY_ADDED ? It's for test-only but at least it would catch this kind of logic bug in test framework ?",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-01T16:36:32Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533554882",
      "id" : 533554882,
      "line" : 318,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU1NDg4Mg==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 318,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 12,
      "pull_request_review_id" : 542084165,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533554882",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533557365"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533557365"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Isn't this redundant as this information is already passed by caller and RPC won't swap connection type for any reason ? Maybe remove this result field ?",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-01T16:39:48Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound\\\" or \\\"blockrelay\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533557365",
      "id" : 533557365,
      "line" : 330,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU1NzM2NQ==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 330,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 24,
      "pull_request_review_id" : 542084165,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533557365",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533562928"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533562928"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: \"Add 5 inbound connections...\" ?",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-01T16:47:17Z",
      "diff_hunk" : "@@ -0,0 +1,92 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def check_node_connections(self, node=None, num_in=None, num_out=None):\n+        info = self.nodes[node].getnetworkinfo()\n+        assert_equal(info[\"connections_in\"], num_in)\n+        assert_equal(info[\"connections_out\"], num_out)\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"outbound\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 1\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add some inbound connections to node 1\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533562928",
      "id" : 533562928,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU2MjkyOA==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 43,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 542084165,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533562928",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533932612"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533932612"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Possibly it's nice to check that nothing has happened to node 1 since disconnecting and reconnecting the peers of node 0.\r\n\r\nNote: This is a reply to a thread.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-02T06:49:17Z",
      "diff_hunk" : "@@ -0,0 +1,92 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def check_node_connections(self, node=None, num_in=None, num_out=None):\n+        info = self.nodes[node].getnetworkinfo()\n+        assert_equal(info[\"connections_in\"], num_in)\n+        assert_equal(info[\"connections_out\"], num_out)\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"outbound\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 1\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add some inbound connections to node 1\")\n+        for i in range(5):\n+            self.log.info(\"inbound: {}\".format(i))\n+            self.nodes[1].add_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 8 outbounds to node 1\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Check the connections opened as expected\")\n+        self.check_node_connections(node=0, num_in=0, num_out=10)\n+        self.check_node_connections(node=1, num_in=5, num_out=10)\n+\n+        self.log.info(\"Disconnect p2p connections & try to re-open\")\n+        self.nodes[0].disconnect_p2ps()\n+        self.check_node_connections(node=0, num_in=0, num_out=0)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+        self.check_node_connections(node=0, num_in=0, num_out=8)\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        self.check_node_connections(node=0, num_in=0, num_out=10)\n+\n+        self.log.info(\"Restart node 0 and try to reconnect to p2ps\")\n+        self.restart_node(0)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+        self.check_node_connections(node=0, num_in=0, num_out=8)\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        self.check_node_connections(node=0, num_in=0, num_out=10)\n+\n+        self.check_node_connections(node=1, num_in=5, num_out=10)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533932612",
      "id" : 533932612,
      "in_reply_to_id" : 533394134,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzkzMjYxMg==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 88,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 542539699,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533932612",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533934701"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533934701"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is checking `IsMockableChain` the best way to ensure we're in a test?  Have you considered checking `NetworkIDString != CBaseChainParams::REGTEST` instead?",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-02T06:55:02Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound\\\" or \\\"blockrelay\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    if (!Params().IsMockableChain()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533934701",
      "id" : 533934701,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzkzNDcwMQ==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 346,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 542539699,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533934701",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533936622"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533936622"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Probably `throw JSONRPCError(RPC_INVALID_PARAMS, \"Something...\");` is better here.  `RPC_INVALID_PARAMS` is a standard JSON-RPC 2.0 error.  However, we seem to use our custom `RPC_INVALID_PARAMETER` more often, so maybe that's a better choice.  (2 instances to 136 instances)",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-02T07:00:12Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound\\\" or \\\"blockrelay\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    if (!Params().IsMockableChain()) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only.\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in{ToLower(TrimString(request.params[1].get_str()))};\n+    ConnectionType conn_type{};\n+    if (conn_type_in == \"outbound\") {\n+        conn_type = ConnectionType::OUTBOUND_FULL_RELAY;\n+    } else if (conn_type_in == \"blockrelay\") {\n+        conn_type = ConnectionType::BLOCK_RELAY;\n+    } else {\n+        throw std::runtime_error(self.ToString());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533936622",
      "id" : 533936622,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzkzNjYyMg==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 359,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 542539699,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533936622",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533939178"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533939178"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: I'm really not fond of this name, being that it appears to be an intentional collision with `asyncio`'s `create_server`.  It's hard enough to tell _who's_ calling _what_ and _when_ in concurrent python, and this makes it harder.  Maybe something like `listen_helper`?",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-02T07:06:50Z",
      "diff_hunk" : "@@ -539,6 +566,33 @@ def close(self, timeout=10):\n         # Safe to remove event loop.\n         NetworkThread.network_event_loop = None\n \n+    @classmethod\n+    def listen(cls, p2p, callback, port=None, addr=None, idx=1):\n+        if port is None:\n+            assert 0 < idx <= MAX_NODES\n+            port = p2p_port(MAX_NODES - idx)\n+        if addr is None:\n+            addr = '127.0.0.1'\n+        coroutine = cls.create_server(addr, port, callback, p2p)\n+        cls.network_event_loop.call_soon_threadsafe(cls.network_event_loop.create_task, coroutine)\n+\n+    @classmethod\n+    def peer_listener(cls, addr, port):\n+        def pl():\n+            x = cls.protos.get((addr,port))\n+            cls.protos[(addr,port)] = None\n+            return x\n+        return pl\n+\n+    @classmethod\n+    async def create_server(cls, addr, port, callback, proto):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533939178",
      "id" : 533939178,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzkzOTE3OA==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 588,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/p2p.py",
      "position" : null,
      "pull_request_review_id" : 542539699,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533939178",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533941575"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533941575"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Since this is a sanity check, it would be nice if the values weren't the same as when we called this before restarting the node.  Maybe add only 7 outbounds and a few inbounds?",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-02T07:12:44Z",
      "diff_hunk" : "@@ -0,0 +1,92 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def check_node_connections(self, node=None, num_in=None, num_out=None):\n+        info = self.nodes[node].getnetworkinfo()\n+        assert_equal(info[\"connections_in\"], num_in)\n+        assert_equal(info[\"connections_out\"], num_out)\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"outbound\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 1\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add some inbound connections to node 1\")\n+        for i in range(5):\n+            self.log.info(\"inbound: {}\".format(i))\n+            self.nodes[1].add_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 8 outbounds to node 1\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Check the connections opened as expected\")\n+        self.check_node_connections(node=0, num_in=0, num_out=10)\n+        self.check_node_connections(node=1, num_in=5, num_out=10)\n+\n+        self.log.info(\"Disconnect p2p connections & try to re-open\")\n+        self.nodes[0].disconnect_p2ps()\n+        self.check_node_connections(node=0, num_in=0, num_out=0)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+        self.check_node_connections(node=0, num_in=0, num_out=8)\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        self.check_node_connections(node=0, num_in=0, num_out=10)\n+\n+        self.log.info(\"Restart node 0 and try to reconnect to p2ps\")\n+        self.restart_node(0)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+        self.check_node_connections(node=0, num_in=0, num_out=8)\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        self.check_node_connections(node=0, num_in=0, num_out=10)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533941575",
      "id" : 533941575,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk0MTU3NQ==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 86,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 542539699,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533941575",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533943505"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533943505"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I agree with ariard here, I would prefer this comment was longer and more verbose.  \"Returns false if at max connection capacity for given connection type or at max total outbound connection capacity\"",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-02T07:17:22Z",
      "diff_hunk" : "@@ -346,6 +346,15 @@ class CConnman\n     bool RemoveAddedNode(const std::string& node);\n     std::vector<AddedNodeInfo> GetAddedNodeInfo();\n \n+    /**\n+     * Attempts to open a connection. Currently only used from tests.\n+     *\n+     * @param[in]   address     Address of node to try connecting to\n+     * @param[in]   conn_type   ConnectionType::OUTBOUND or ConnectionType::BLOCK_RELAY\n+     * @return      bool        Returns false if at max connection capacity",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533943505",
      "id" : 533943505,
      "in_reply_to_id" : 521590231,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk0MzUwNQ==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 354,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 542552445,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533943505",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533944308"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533944308"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Same as https://github.com/bitcoin/bitcoin/pull/19315/files#r533943505, consider making this more detailed?  I could see this being misleading if the RPC fails because of max total outbound capacity, as opposed to max capacity for the given type.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-02T07:19:18Z",
      "diff_hunk" : "@@ -320,20 +322,31 @@ static RPCHelpMan addconnection()\n         throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only\");\n     }\n \n-    RPCTypeCheckArgument(request.params, UniValue::VSTR);\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n     const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in = request.params[1].get_str();\n+    ConnectionType conn_type{};\n+    if (conn_type_in == \"outbound\") {\n+        conn_type = ConnectionType::OUTBOUND_FULL_RELAY;\n+    } else if (conn_type_in == \"blockrelay\") {\n+        conn_type = ConnectionType::BLOCK_RELAY;\n+    } else {\n+        throw std::runtime_error(self.ToString());\n+    }\n+\n     NodeContext& context = EnsureNodeContext(request.context);\n     if (!context.connman) {\n         throw JSONRPCError(RPC_CLIENT_P2P_DISABLED, \"Error: Peer-to-peer functionality missing or disabled\");\n     }\n \n-    const bool success = context.connman->AddConnection(address);\n+    const bool success = context.connman->AddConnection(address, conn_type);\n     if (!success) {\n-        throw JSONRPCError(RPC_CLIENT_NODE_CAPACITY_REACHED, \"Error: Max number of outbound full relay connections already open.\");\n+        throw JSONRPCError(RPC_CLIENT_NODE_CAPACITY_REACHED, \"Error: Already at capacity for specified connection type.\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r533944308",
      "id" : 533944308,
      "in_reply_to_id" : 499519175,
      "line" : 361,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk0NDMwOA==",
      "original_commit_id" : "0fb4635bbabb1bea10a215bde4c803ceb5bc5f26",
      "original_line" : 361,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 55,
      "pull_request_review_id" : 542553393,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533944308",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534033801"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534033801"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This field confirms what the RPC parsed from the user input per Postel's Law. If you pass \" BLOCKRELAY   \", it's good to know, without needing to check the source code, that it was correctly understood as \"blockrelay\".",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-02T09:52:48Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound\\\" or \\\"blockrelay\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534033801",
      "id" : 534033801,
      "in_reply_to_id" : 533557365,
      "line" : 330,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAzMzgwMQ==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 330,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 24,
      "pull_request_review_id" : 542665208,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534033801",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534052888"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534052888"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If the args can't be parsed, a parse failure will be thrown already https://github.com/bitcoin/bitcoin/pull/19315/files#r533936622\r\n",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-02T10:20:11Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound\\\" or \\\"blockrelay\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534052888",
      "id" : 534052888,
      "in_reply_to_id" : 533557365,
      "line" : 330,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA1Mjg4OA==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 330,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 24,
      "pull_request_review_id" : 542689276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534052888",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534056768"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534056768"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agree with @jnewbery's suggestions. @MarcoFalke also reminded me recently in https://github.com/bitcoin/bitcoin/pull/20403#discussion_r530307834 that you can enforce use of named args with the splat. [Example](https://github.com/bitcoin/bitcoin/pull/20391/files#diff-5450eea6e8ed6364028357e2f1abc3dfcf458177655f518336266f08190f0dcfR323).\r\n```suggestion\r\n    def check_node_connections(*, node, num_in, num_out):\r\n```",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-02T10:25:47Z",
      "diff_hunk" : "@@ -0,0 +1,92 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def check_node_connections(self, node=None, num_in=None, num_out=None):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534056768",
      "id" : 534056768,
      "in_reply_to_id" : 533390362,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA1Njc2OA==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 20,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 542693994,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534056768",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534059297"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534059297"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, but in the absence of failure, feedback is better than uncertainty or requiring the user to check the source code.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-02T10:29:32Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound\\\" or \\\"blockrelay\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534059297",
      "id" : 534059297,
      "in_reply_to_id" : 533557365,
      "line" : 330,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA1OTI5Nw==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 330,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 24,
      "pull_request_review_id" : 542697262,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534059297",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534190714"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534190714"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oh, now that the minimum Python version has been bumped to 3.6 (in #19504), you can use Python f-strings instead of `format` for new code.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-02T14:04:47Z",
      "diff_hunk" : "@@ -0,0 +1,92 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def check_node_connections(self, node=None, num_in=None, num_out=None):\n+        info = self.nodes[node].getnetworkinfo()\n+        assert_equal(info[\"connections_in\"], num_in)\n+        assert_equal(info[\"connections_out\"], num_out)\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"outbound\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 1\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add some inbound connections to node 1\")\n+        for i in range(5):\n+            self.log.info(\"inbound: {}\".format(i))\n+            self.nodes[1].add_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 8 outbounds to node 1\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Check the connections opened as expected\")\n+        self.check_node_connections(node=0, num_in=0, num_out=10)\n+        self.check_node_connections(node=1, num_in=5, num_out=10)\n+\n+        self.log.info(\"Disconnect p2p connections & try to re-open\")\n+        self.nodes[0].disconnect_p2ps()\n+        self.check_node_connections(node=0, num_in=0, num_out=0)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534190714",
      "id" : 534190714,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDE5MDcxNA==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 63,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 542865494,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534190714",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534587053"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534587053"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yup exactly, sanity check that there aren't unexpected interactions ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-03T01:00:05Z",
      "diff_hunk" : "@@ -0,0 +1,92 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def check_node_connections(self, node=None, num_in=None, num_out=None):\n+        info = self.nodes[node].getnetworkinfo()\n+        assert_equal(info[\"connections_in\"], num_in)\n+        assert_equal(info[\"connections_out\"], num_out)\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"outbound\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 1\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add some inbound connections to node 1\")\n+        for i in range(5):\n+            self.log.info(\"inbound: {}\".format(i))\n+            self.nodes[1].add_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 8 outbounds to node 1\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Check the connections opened as expected\")\n+        self.check_node_connections(node=0, num_in=0, num_out=10)\n+        self.check_node_connections(node=1, num_in=5, num_out=10)\n+\n+        self.log.info(\"Disconnect p2p connections & try to re-open\")\n+        self.nodes[0].disconnect_p2ps()\n+        self.check_node_connections(node=0, num_in=0, num_out=0)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+        self.check_node_connections(node=0, num_in=0, num_out=8)\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        self.check_node_connections(node=0, num_in=0, num_out=10)\n+\n+        self.log.info(\"Restart node 0 and try to reconnect to p2ps\")\n+        self.restart_node(0)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+        self.check_node_connections(node=0, num_in=0, num_out=8)\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        self.check_node_connections(node=0, num_in=0, num_out=10)\n+\n+        self.check_node_connections(node=1, num_in=5, num_out=10)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534587053",
      "id" : 534587053,
      "in_reply_to_id" : 533394134,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDU4NzA1Mw==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 88,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 543360556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534587053",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534617752"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534617752"
         }
      },
      "author_association" : "MEMBER",
      "body" : "it's hard to hit the total max without hitting the max for the type :) \r\n\r\nthe max values are \r\noutbound: 8\r\nblock-relay-only: 2\r\ntotal: 10 ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-03T02:21:36Z",
      "diff_hunk" : "@@ -320,20 +322,31 @@ static RPCHelpMan addconnection()\n         throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only\");\n     }\n \n-    RPCTypeCheckArgument(request.params, UniValue::VSTR);\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n     const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in = request.params[1].get_str();\n+    ConnectionType conn_type{};\n+    if (conn_type_in == \"outbound\") {\n+        conn_type = ConnectionType::OUTBOUND_FULL_RELAY;\n+    } else if (conn_type_in == \"blockrelay\") {\n+        conn_type = ConnectionType::BLOCK_RELAY;\n+    } else {\n+        throw std::runtime_error(self.ToString());\n+    }\n+\n     NodeContext& context = EnsureNodeContext(request.context);\n     if (!context.connman) {\n         throw JSONRPCError(RPC_CLIENT_P2P_DISABLED, \"Error: Peer-to-peer functionality missing or disabled\");\n     }\n \n-    const bool success = context.connman->AddConnection(address);\n+    const bool success = context.connman->AddConnection(address, conn_type);\n     if (!success) {\n-        throw JSONRPCError(RPC_CLIENT_NODE_CAPACITY_REACHED, \"Error: Max number of outbound full relay connections already open.\");\n+        throw JSONRPCError(RPC_CLIENT_NODE_CAPACITY_REACHED, \"Error: Already at capacity for specified connection type.\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534617752",
      "id" : 534617752,
      "in_reply_to_id" : 499519175,
      "line" : 361,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDYxNzc1Mg==",
      "original_commit_id" : "0fb4635bbabb1bea10a215bde4c803ceb5bc5f26",
      "original_line" : 361,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 55,
      "pull_request_review_id" : 543391673,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534617752",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534633804"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534633804"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Filed an issue for this at #20552",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-03T03:07:29Z",
      "diff_hunk" : "@@ -1152,6 +1152,37 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n+bool CConnman::AddConnection(const std::string& address, const ConnectionType conn_type)\n+{\n+    assert(conn_type == ConnectionType::OUTBOUND_FULL_RELAY || conn_type == ConnectionType::BLOCK_RELAY);\n+\n+    int outbound_full_relay = 0;\n+    int outbound_block_relay = 0;\n+\n+    {\n+        // count existing connections for each type\n+        LOCK(cs_vNodes);\n+        for (const CNode* pnode : vNodes) {\n+            if (pnode->m_conn_type == ConnectionType::OUTBOUND_FULL_RELAY) {\n+                ++outbound_full_relay;\n+            } else if (pnode->m_conn_type == ConnectionType::BLOCK_RELAY) {\n+                ++outbound_block_relay;\n+            }\n+        }\n+    }\n+\n+    // max connections of specified type already exist\n+    if (conn_type == ConnectionType::OUTBOUND_FULL_RELAY && outbound_full_relay >= m_max_outbound_full_relay) return false;\n+    if (conn_type == ConnectionType::BLOCK_RELAY && outbound_block_relay >= m_max_outbound_block_relay) return false;\n+\n+    // max total outbound connections already exist\n+    CSemaphoreGrant grant(*semOutbound, true);\n+    if (!grant) return false;\n+\n+    OpenNetworkConnection(CAddress(), false, &grant, address.c_str(), conn_type);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534633804",
      "id" : 534633804,
      "in_reply_to_id" : 521290049,
      "line" : 1152,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDYzMzgwNA==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 1152,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 21,
      "pull_request_review_id" : 543408191,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534633804",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534640401"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534640401"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Could shorten it to:\r\n\r\n```c++\r\n    int existing_connections = WITH_LOCK(cs_vNodes,\r\n        return std::count_if(vNodes.begin(), vNodes.end(), [conn_type](CNode* node) { return node->m_conn_type == conn_type; });-\r\n    );\r\n```\r\n\r\n(EDIT: remove redundant `{}`)\r\n\r\nI think there's a race condition here in that you could decide there's currently one block relay outbound so it's fine to create a second while at the same time another thread draws the same conclusion and also attempts to make a new outbound block relay, and you end up with three instead of two. Probably reasonably hard to get to that state though, and this is a test-only API, so shouldn't matter.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-03T03:27:25Z",
      "diff_hunk" : "@@ -1143,6 +1143,30 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n+bool CConnman::AddConnection(const std::string& address, ConnectionType conn_type)\n+{\n+    assert(conn_type == ConnectionType::OUTBOUND_FULL_RELAY || conn_type == ConnectionType::BLOCK_RELAY);\n+\n+    const int max_connections = conn_type == ConnectionType::OUTBOUND_FULL_RELAY ? m_max_outbound_full_relay : m_max_outbound_block_relay;\n+\n+    // Count existing connections\n+    int existing_connections{0};\n+    {\n+        LOCK(cs_vNodes);\n+        existing_connections = std::count_if(vNodes.begin(), vNodes.end(), [conn_type](CNode* node) { return node->m_conn_type == conn_type; });\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534640401",
      "id" : 534640401,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY0MDQwMQ==",
      "original_commit_id" : "ae7f4fdfe7f7a1d42c35589a7d61e9d44c32091a",
      "original_line" : 1157,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 543415029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534640401",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534643176"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534643176"
         }
      },
      "author_association" : "MEMBER",
      "body" : "good point & clever trick! I've bumped the mocktime by a minute, added two calls to `sync_with_ping()` and a comment explaining this reasoning. \r\n\r\nthanks for this thoughtful response! going to resolve the comment now, let me know incase there's anything else I should be thinking about.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-03T03:36:25Z",
      "diff_hunk" : "@@ -78,13 +62,54 @@ def run_test(self):\n             # But if, for some reason, first_peer decides to relay transactions to us anyway, we should relay them to\n             # second_peer since we gave relay permission to first_peer.\n             # See https://github.com/bitcoin/bitcoin/issues/19943 for details.\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the peer with relay-permission is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Relay-permission peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        # bump time forward to ensure nNextInvSend timer pops\n+        self.nodes[0].setmocktime(int(time.time()) + 5)\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n+        self.nodes[0].sendrawtransaction(tx_hex)\n+        conn.sync_with_ping()\n+        assert(int(txid, 16) not in conn.get_invs())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534643176",
      "id" : 534643176,
      "in_reply_to_id" : 521304814,
      "line" : 98,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY0MzE3Ng==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 98,
      "original_position" : 126,
      "original_start_line" : 93,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 128,
      "pull_request_review_id" : 543418027,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : 97,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534643176",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534643978"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534643978"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ah, yes I put in the defaults to try to enforce the named args. cool splat trick @jonatack.\r\n\r\nalso converted to standalone function ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-03T03:39:01Z",
      "diff_hunk" : "@@ -0,0 +1,92 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def check_node_connections(self, node=None, num_in=None, num_out=None):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534643978",
      "id" : 534643978,
      "in_reply_to_id" : 533390362,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY0Mzk3OA==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 20,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 543418886,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534643978",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534644050"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534644050"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ðð½ done",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-03T03:39:17Z",
      "diff_hunk" : "@@ -0,0 +1,92 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def check_node_connections(self, node=None, num_in=None, num_out=None):\n+        info = self.nodes[node].getnetworkinfo()\n+        assert_equal(info[\"connections_in\"], num_in)\n+        assert_equal(info[\"connections_out\"], num_out)\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534644050",
      "id" : 534644050,
      "in_reply_to_id" : 533393627,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY0NDA1MA==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 26,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 543418957,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534644050",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534644227"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534644227"
         }
      },
      "author_association" : "MEMBER",
      "body" : "since this test is 50% sanity checks & I don't think it detracts to leave this one in, I'm resolving this conversation. ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-03T03:39:55Z",
      "diff_hunk" : "@@ -0,0 +1,92 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def check_node_connections(self, node=None, num_in=None, num_out=None):\n+        info = self.nodes[node].getnetworkinfo()\n+        assert_equal(info[\"connections_in\"], num_in)\n+        assert_equal(info[\"connections_out\"], num_out)\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"outbound\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 1\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add some inbound connections to node 1\")\n+        for i in range(5):\n+            self.log.info(\"inbound: {}\".format(i))\n+            self.nodes[1].add_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 8 outbounds to node 1\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Check the connections opened as expected\")\n+        self.check_node_connections(node=0, num_in=0, num_out=10)\n+        self.check_node_connections(node=1, num_in=5, num_out=10)\n+\n+        self.log.info(\"Disconnect p2p connections & try to re-open\")\n+        self.nodes[0].disconnect_p2ps()\n+        self.check_node_connections(node=0, num_in=0, num_out=0)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+        self.check_node_connections(node=0, num_in=0, num_out=8)\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        self.check_node_connections(node=0, num_in=0, num_out=10)\n+\n+        self.log.info(\"Restart node 0 and try to reconnect to p2ps\")\n+        self.restart_node(0)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+        self.check_node_connections(node=0, num_in=0, num_out=8)\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        self.check_node_connections(node=0, num_in=0, num_out=10)\n+\n+        self.check_node_connections(node=1, num_in=5, num_out=10)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534644227",
      "id" : 534644227,
      "in_reply_to_id" : 533394134,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY0NDIyNw==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 88,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 543419152,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534644227",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534644613"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534644613"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-03T03:41:07Z",
      "diff_hunk" : "@@ -0,0 +1,92 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534644613",
      "id" : 534644613,
      "in_reply_to_id" : 533394335,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY0NDYxMw==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 7,
      "original_position" : 8,
      "original_start_line" : 7,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 543419518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534644613",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534645028"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534645028"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ð¡\r\n\r\nthanks :) ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-03T03:42:24Z",
      "diff_hunk" : "@@ -0,0 +1,92 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534645028",
      "id" : 534645028,
      "in_reply_to_id" : 533394769,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY0NTAyOA==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 19,
      "original_position" : 19,
      "original_start_line" : 17,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 543419918,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534645028",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534646521"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534646521"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I feel completely indifferent as to whether there's a return result or not. I believe the initial implementation left it out but then I got review comments requesting it be added. \r\n\r\nHappy to do whatever reviewers prefer. To me it doesn't feel super important one way or the other since its a test-only RPC so we don't have to adhere to normal RPC deprecation rules. ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-03T03:47:21Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound\\\" or \\\"blockrelay\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534646521",
      "id" : 534646521,
      "in_reply_to_id" : 533557365,
      "line" : 330,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY0NjUyMQ==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 330,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 24,
      "pull_request_review_id" : 543421434,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534646521",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534646659"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534646659"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-03T03:47:44Z",
      "diff_hunk" : "@@ -0,0 +1,92 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def check_node_connections(self, node=None, num_in=None, num_out=None):\n+        info = self.nodes[node].getnetworkinfo()\n+        assert_equal(info[\"connections_in\"], num_in)\n+        assert_equal(info[\"connections_out\"], num_out)\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"outbound\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 1\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add some inbound connections to node 1\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534646659",
      "id" : 534646659,
      "in_reply_to_id" : 533562928,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY0NjY1OQ==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 43,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 543421566,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534646659",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534646707"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534646707"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think the `ToLower` here is a good idea. The RPC interface is, in general, case-sensitive -- eg, `addnode .. OneTry` will give an error, changing the capitalisation of a wallet name refers to a different wallet, and calling `AddConnection` instead of `addconnection` will give `Method not found`. Special-casing this particular argument just seems confusing.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-03T03:47:56Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound\\\" or \\\"blockrelay\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    if (Params().NetworkIDString() != CBaseChainParams::REGTEST) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only.\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in{ToLower(TrimString(request.params[1].get_str()))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534646707",
      "id" : 534646707,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY0NjcwNw==",
      "original_commit_id" : "d010c5ef0664514f0aedc8ee14d68b4226fafe35",
      "original_line" : 352,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 543415029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534646707",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534646857"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534646857"
         }
      },
      "author_association" : "MEMBER",
      "body" : "oh nice, that is more direct / explicit. done.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-03T03:48:25Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound\\\" or \\\"blockrelay\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    if (!Params().IsMockableChain()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534646857",
      "id" : 534646857,
      "in_reply_to_id" : 533934701,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY0Njg1Nw==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 346,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 543421799,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534646857",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534647465"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534647465"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done.\r\n\r\nyeah interesting that we have both `RPC_INVALID_PARAMS` and `RPC_INVALID_PARAMETER`. opted for the second since its more used. ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-03T03:50:12Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound\\\" or \\\"blockrelay\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    if (!Params().IsMockableChain()) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only.\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in{ToLower(TrimString(request.params[1].get_str()))};\n+    ConnectionType conn_type{};\n+    if (conn_type_in == \"outbound\") {\n+        conn_type = ConnectionType::OUTBOUND_FULL_RELAY;\n+    } else if (conn_type_in == \"blockrelay\") {\n+        conn_type = ConnectionType::BLOCK_RELAY;\n+    } else {\n+        throw std::runtime_error(self.ToString());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534647465",
      "id" : 534647465,
      "in_reply_to_id" : 533936622,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY0NzQ2NQ==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 359,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 543422354,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534647465",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534648609"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534648609"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yeah that's reasonable, I updated to `create_listen_server` ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-03T03:54:06Z",
      "diff_hunk" : "@@ -539,6 +566,33 @@ def close(self, timeout=10):\n         # Safe to remove event loop.\n         NetworkThread.network_event_loop = None\n \n+    @classmethod\n+    def listen(cls, p2p, callback, port=None, addr=None, idx=1):\n+        if port is None:\n+            assert 0 < idx <= MAX_NODES\n+            port = p2p_port(MAX_NODES - idx)\n+        if addr is None:\n+            addr = '127.0.0.1'\n+        coroutine = cls.create_server(addr, port, callback, p2p)\n+        cls.network_event_loop.call_soon_threadsafe(cls.network_event_loop.create_task, coroutine)\n+\n+    @classmethod\n+    def peer_listener(cls, addr, port):\n+        def pl():\n+            x = cls.protos.get((addr,port))\n+            cls.protos[(addr,port)] = None\n+            return x\n+        return pl\n+\n+    @classmethod\n+    async def create_server(cls, addr, port, callback, proto):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534648609",
      "id" : 534648609,
      "in_reply_to_id" : 533939178,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY0ODYwOQ==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 588,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/p2p.py",
      "position" : null,
      "pull_request_review_id" : 543423521,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534648609",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534648639"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534648639"
         }
      },
      "author_association" : "MEMBER",
      "body" : "kewl, done.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-03T03:54:14Z",
      "diff_hunk" : "@@ -0,0 +1,92 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def check_node_connections(self, node=None, num_in=None, num_out=None):\n+        info = self.nodes[node].getnetworkinfo()\n+        assert_equal(info[\"connections_in\"], num_in)\n+        assert_equal(info[\"connections_out\"], num_out)\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"outbound\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 1\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add some inbound connections to node 1\")\n+        for i in range(5):\n+            self.log.info(\"inbound: {}\".format(i))\n+            self.nodes[1].add_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 8 outbounds to node 1\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Check the connections opened as expected\")\n+        self.check_node_connections(node=0, num_in=0, num_out=10)\n+        self.check_node_connections(node=1, num_in=5, num_out=10)\n+\n+        self.log.info(\"Disconnect p2p connections & try to re-open\")\n+        self.nodes[0].disconnect_p2ps()\n+        self.check_node_connections(node=0, num_in=0, num_out=0)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+        self.check_node_connections(node=0, num_in=0, num_out=8)\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        self.check_node_connections(node=0, num_in=0, num_out=10)\n+\n+        self.log.info(\"Restart node 0 and try to reconnect to p2ps\")\n+        self.restart_node(0)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface())\n+        self.check_node_connections(node=0, num_in=0, num_out=8)\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        self.check_node_connections(node=0, num_in=0, num_out=10)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534648639",
      "id" : 534648639,
      "in_reply_to_id" : 533941575,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY0ODYzOQ==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 86,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 543423560,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534648639",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534648707"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534648707"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-03T03:54:23Z",
      "diff_hunk" : "@@ -0,0 +1,92 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test add_outbound_p2p_connection test framework functionality\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.p2p import P2PInterface\n+from test_framework.util import assert_equal\n+\n+\n+class P2PAddConnections(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = False\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def check_node_connections(self, node=None, num_in=None, num_out=None):\n+        info = self.nodes[node].getnetworkinfo()\n+        assert_equal(info[\"connections_in\"], num_in)\n+        assert_equal(info[\"connections_out\"], num_out)\n+\n+    def run_test(self):\n+        self.disconnect_nodes(0, 1)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"outbound\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 0\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add 2 block-relay-only connections to node 1\")\n+        for i in range(2):\n+            self.log.info(\"block-relay-only: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+\n+        self.log.info(\"Add some inbound connections to node 1\")\n+        for i in range(5):\n+            self.log.info(\"inbound: {}\".format(i))\n+            self.nodes[1].add_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Add 8 outbounds to node 1\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))\n+            self.nodes[1].add_outbound_p2p_connection(P2PInterface())\n+\n+        self.log.info(\"Check the connections opened as expected\")\n+        self.check_node_connections(node=0, num_in=0, num_out=10)\n+        self.check_node_connections(node=1, num_in=5, num_out=10)\n+\n+        self.log.info(\"Disconnect p2p connections & try to re-open\")\n+        self.nodes[0].disconnect_p2ps()\n+        self.check_node_connections(node=0, num_in=0, num_out=0)\n+\n+        self.log.info(\"Add 8 outbounds to node 0\")\n+        for i in range(8):\n+            self.log.info(\"outbound: {}\".format(i))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534648707",
      "id" : 534648707,
      "in_reply_to_id" : 534190714,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY0ODcwNw==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 63,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "test/functional/p2p_add_connections.py",
      "position" : null,
      "pull_request_review_id" : 543423605,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534648707",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534650523"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534650523"
         }
      },
      "author_association" : "MEMBER",
      "body" : "haha, I fully agree ð\r\n\r\ngoing to resolve this conversation to help me keep track of outstanding issues on this PR",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-03T04:00:00Z",
      "diff_hunk" : "@@ -1152,6 +1152,37 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n+bool CConnman::AddConnection(const std::string& address, const ConnectionType conn_type)\n+{\n+    assert(conn_type == ConnectionType::OUTBOUND_FULL_RELAY || conn_type == ConnectionType::BLOCK_RELAY);\n+\n+    int outbound_full_relay = 0;\n+    int outbound_block_relay = 0;\n+\n+    {\n+        // count existing connections for each type\n+        LOCK(cs_vNodes);\n+        for (const CNode* pnode : vNodes) {\n+            if (pnode->m_conn_type == ConnectionType::OUTBOUND_FULL_RELAY) {\n+                ++outbound_full_relay;\n+            } else if (pnode->m_conn_type == ConnectionType::BLOCK_RELAY) {\n+                ++outbound_block_relay;\n+            }\n+        }\n+    }\n+\n+    // max connections of specified type already exist\n+    if (conn_type == ConnectionType::OUTBOUND_FULL_RELAY && outbound_full_relay >= m_max_outbound_full_relay) return false;\n+    if (conn_type == ConnectionType::BLOCK_RELAY && outbound_block_relay >= m_max_outbound_block_relay) return false;\n+\n+    // max total outbound connections already exist\n+    CSemaphoreGrant grant(*semOutbound, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534650523",
      "id" : 534650523,
      "in_reply_to_id" : 521589772,
      "line" : 1149,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY1MDUyMw==",
      "original_commit_id" : "f51006b8184a56fe18a5e64f43846f38fb982993",
      "original_line" : 1149,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 18,
      "pull_request_review_id" : 543425475,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534650523",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534668415"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534668415"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Should this just return `false` for different connection types rather than assert?",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-03T04:56:45Z",
      "diff_hunk" : "@@ -1143,6 +1143,30 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n+bool CConnman::AddConnection(const std::string& address, ConnectionType conn_type)\n+{\n+    assert(conn_type == ConnectionType::OUTBOUND_FULL_RELAY || conn_type == ConnectionType::BLOCK_RELAY);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534668415",
      "id" : 534668415,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY2ODQxNQ==",
      "original_commit_id" : "d010c5ef0664514f0aedc8ee14d68b4226fafe35",
      "original_line" : 1148,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 543415029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534668415",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534669600"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534669600"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Shouldn't these match `ConnectionTypeAsString()` -- ie `outbound-full-relay` and `block-relay-only` ?",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-03T05:00:37Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound\\\" or \\\"blockrelay\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    if (Params().NetworkIDString() != CBaseChainParams::REGTEST) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only.\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in{ToLower(TrimString(request.params[1].get_str()))};\n+    ConnectionType conn_type{};\n+    if (conn_type_in == \"outbound\") {\n+        conn_type = ConnectionType::OUTBOUND_FULL_RELAY;\n+    } else if (conn_type_in == \"blockrelay\") {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534669600",
      "id" : 534669600,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY2OTYwMA==",
      "original_commit_id" : "d010c5ef0664514f0aedc8ee14d68b4226fafe35",
      "original_line" : 356,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 543415029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534669600",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534669954"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534669954"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is `NodeContext& node` everywhere else?",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-03T05:01:44Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound\\\" or \\\"blockrelay\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    if (Params().NetworkIDString() != CBaseChainParams::REGTEST) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only.\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in{ToLower(TrimString(request.params[1].get_str()))};\n+    ConnectionType conn_type{};\n+    if (conn_type_in == \"outbound\") {\n+        conn_type = ConnectionType::OUTBOUND_FULL_RELAY;\n+    } else if (conn_type_in == \"blockrelay\") {\n+        conn_type = ConnectionType::BLOCK_RELAY;\n+    } else {\n+        throw JSONRPCError(RPC_INVALID_PARAMETER, self.ToString());\n+    }\n+\n+    NodeContext& context = EnsureNodeContext(request.context);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534669954",
      "id" : 534669954,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY2OTk1NA==",
      "original_commit_id" : "d010c5ef0664514f0aedc8ee14d68b4226fafe35",
      "original_line" : 367,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 543415029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534669954",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534747237"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534747237"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this could use some refactoring and comments. Maybe something like:\r\n\r\n```python\r\n    @classmethod\r\n    def listen(cls, p2p, callback, port=None, addr=None, idx=1):\r\n        \"\"\"Ensure a listening server is running on the given port, and run the protocol\r\n           specified by `p2p` on the next connection to it. Once ready for connections,\r\n           call `callback`.\"\"\"\r\n\r\n        if port is None:\r\n            assert 0 < idx <= MAX_NODES\r\n            port = p2p_port(MAX_NODES - idx)\r\n        if addr is None:\r\n            addr = '127.0.0.1'\r\n\r\n        coroutine = cls.create_server(addr, port, callback, p2p)\r\n        cls.network_event_loop.call_soon_threadsafe(cls.network_event_loop.create_task, coroutine)\r\n\r\n    @classmethod\r\n    async def create_server(cls, addr, port, callback, proto):\r\n        def peer_protocol():\r\n            \"\"\"Returns a function that does the protocol handling for a new connection.\r\n               To allow different connections to have different behaviour, the protocol\r\n               function is put in the cls.protos dict first, then the connection is made,\r\n               at which point this function removes the protocol function from that\r\n               dict, and returns it so that the event loop can start executing it.\"\"\"\r\n            response = cls.protos.get((addr, port))\r\n            cls.protos[(addr, port)] = None\r\n            return response\r\n\r\n        if (addr, port) not in cls.listeners:\r\n            # When creating a listener on a given addr,port we only need to do it once;\r\n            # even if we want different behaviours for different connections we can do\r\n            # that by providing different `proto` function.\r\n\r\n            listener = await cls.network_event_loop.create_server(peer_protocol, addr, port)\r\n            logger.debug(\"Listening server on %s:%d should be started\" % (addr, port))\r\n            cls.listeners[(addr, port)] = listener\r\n\r\n        cls.protos[(addr, port)] = proto\r\n        callback(addr,port)\r\n```\r\n",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-03T06:47:40Z",
      "diff_hunk" : "@@ -539,6 +566,34 @@ def close(self, timeout=10):\n         # Safe to remove event loop.\n         NetworkThread.network_event_loop = None\n \n+    @classmethod\n+    def listen(cls, p2p, callback, port=None, addr=None, idx=1):\n+        if port is None:\n+            assert 0 < idx <= MAX_NODES\n+            port = p2p_port(MAX_NODES - idx)\n+        if addr is None:\n+            addr = '127.0.0.1'\n+        coroutine = cls.create_listen_server(addr, port, callback, p2p)\n+        cls.network_event_loop.call_soon_threadsafe(cls.network_event_loop.create_task, coroutine)\n+\n+    @classmethod\n+    def peer_listener(cls, addr, port):\n+        def pl():\n+            x = cls.protos.get((addr, port))\n+            cls.protos[(addr, port)] = None\n+            return x\n+        return pl\n+\n+    @classmethod\n+    async def create_listen_server(cls, addr, port, callback, proto):\n+        if (addr, port) not in cls.listeners:\n+            listener = await cls.network_event_loop.create_server(cls.peer_listener(addr, port), addr, port)\n+            logger.debug(\"Listening server on %s:%d should be started\" % (addr, port))\n+            cls.listeners[(addr, port)] = listener\n+        cls.protos[(addr, port)] = proto\n+        callback(addr, port)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534747237",
      "id" : 534747237,
      "line" : 611,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDc0NzIzNw==",
      "original_commit_id" : "6e53cfba586e599151cdbc1396accb81deff0830",
      "original_line" : 611,
      "original_position" : 133,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/p2p.py",
      "position" : 147,
      "pull_request_review_id" : 543415029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534747237",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534751258"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534751258"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think specifying the `p2p_conn_index` explicitly, eg with\r\n\r\n```python\r\ndef add_outbound_p2p_connection(self, p2p_conn, *, p2pidx, connection_type=\"outbound\", **kwargs)\r\n```\r\nand calling it as:\r\n\r\n```python\r\nconn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), p2pidx=1, connection_type=\"blockrelay\")\r\n```\r\n\r\nwould make the tests clearer. At present it's very hard to track what port `add_outbound_p2p_connection` will be trying to connect to, which is probably mostly okay while it's not used very intensively, but if it does lead to bugs they'll be hard to find and hard to fix with an automagic api...\r\n\r\nMight be worth thinking about how to extend the api to allow testing #17428 -- I think that would be much more comprehensible with an explicit `p2pidx`.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-03T06:51:28Z",
      "diff_hunk" : "@@ -542,6 +546,29 @@ def add_p2p_connection(self, p2p_conn, *, wait_for_verack=True, **kwargs):\n \n         return p2p_conn\n \n+    def add_outbound_p2p_connection(self, p2p_conn, *, connection_type=\"outbound\", **kwargs):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534751258",
      "id" : 534751258,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDc1MTI1OA==",
      "original_commit_id" : "6e53cfba586e599151cdbc1396accb81deff0830",
      "original_line" : 549,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : null,
      "pull_request_review_id" : 543415029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534751258",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534874538"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534874538"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Many RPCs (sendtoaddress, sendmany, send, fundrawtransaction, walletcreatefundedpsbt, and bumpfee) have a case-insensitive string param, estimate_mode, that is also indicated as case insensitive in the various helps.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-03T08:08:10Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound\\\" or \\\"blockrelay\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    if (Params().NetworkIDString() != CBaseChainParams::REGTEST) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only.\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in{ToLower(TrimString(request.params[1].get_str()))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534874538",
      "id" : 534874538,
      "in_reply_to_id" : 534646707,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDg3NDUzOA==",
      "original_commit_id" : "d010c5ef0664514f0aedc8ee14d68b4226fafe35",
      "original_line" : 352,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 543693312,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534874538",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534922036"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534922036"
         }
      },
      "author_association" : "MEMBER",
      "body" : "With params like estimate_mode and connection_type (and addnode type too) where we ask users to supply a string word to select an option, I think it's reasonable to be lenient about capitalization as a thoughtful touch.",
      "commit_id" : "25f73a9713dab0ba30bf67ab9af18fa57f1f2941",
      "created_at" : "2020-12-03T08:35:12Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound\\\" or \\\"blockrelay\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    if (Params().NetworkIDString() != CBaseChainParams::REGTEST) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only.\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in{ToLower(TrimString(request.params[1].get_str()))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r534922036",
      "id" : 534922036,
      "in_reply_to_id" : 534646707,
      "line" : 352,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDkyMjAzNg==",
      "original_commit_id" : "d010c5ef0664514f0aedc8ee14d68b4226fafe35",
      "original_line" : 352,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 38,
      "pull_request_review_id" : 543712769,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-03T08:35:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534922036",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r535063313"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/535063313"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree with @ajtowns. We should be strict about capitalization in rpc arguments. Adding a special case here doesn't make sense.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-03T10:23:37Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound\\\" or \\\"blockrelay\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    if (Params().NetworkIDString() != CBaseChainParams::REGTEST) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only.\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in{ToLower(TrimString(request.params[1].get_str()))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r535063313",
      "id" : 535063313,
      "in_reply_to_id" : 534646707,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTA2MzMxMw==",
      "original_commit_id" : "d010c5ef0664514f0aedc8ee14d68b4226fafe35",
      "original_line" : 352,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 543807720,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/535063313",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r535071140"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/535071140"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I thnk `estimate_mode` only allows case-insensitivity because it initially required all-uppercase, see https://github.com/bitcoin/bitcoin/pull/11413#pullrequestreview-271355849 . Doesn't seem like a good example to replicate.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-03T10:30:21Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound\\\" or \\\"blockrelay\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    if (Params().NetworkIDString() != CBaseChainParams::REGTEST) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only.\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in{ToLower(TrimString(request.params[1].get_str()))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r535071140",
      "id" : 535071140,
      "in_reply_to_id" : 534646707,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTA3MTE0MA==",
      "original_commit_id" : "d010c5ef0664514f0aedc8ee14d68b4226fafe35",
      "original_line" : 352,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 543813804,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/535071140",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r535090093"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/535090093"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't see the reason or UX advantage of case strictness for string words to select a choice, or even for the API endpoints/commands, but maybe that's from writing a number of clients that consumed APIs which were generally case indifferent (or from writing Lisp ð). ",
      "commit_id" : "25f73a9713dab0ba30bf67ab9af18fa57f1f2941",
      "created_at" : "2020-12-03T10:47:23Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound\\\" or \\\"blockrelay\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    if (Params().NetworkIDString() != CBaseChainParams::REGTEST) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only.\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in{ToLower(TrimString(request.params[1].get_str()))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r535090093",
      "id" : 535090093,
      "in_reply_to_id" : 534646707,
      "line" : 352,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTA5MDA5Mw==",
      "original_commit_id" : "d010c5ef0664514f0aedc8ee14d68b4226fafe35",
      "original_line" : 352,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 38,
      "pull_request_review_id" : 543827713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-03T10:47:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/535090093",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r535330737"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/535330737"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ok, noted. Grepping a bit, it looks like `estimate_mode` is the only one.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-03T15:28:16Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound\\\" or \\\"blockrelay\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    if (Params().NetworkIDString() != CBaseChainParams::REGTEST) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only.\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in{ToLower(TrimString(request.params[1].get_str()))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r535330737",
      "id" : 535330737,
      "in_reply_to_id" : 534646707,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTMzMDczNw==",
      "original_commit_id" : "d010c5ef0664514f0aedc8ee14d68b4226fafe35",
      "original_line" : 352,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 544076315,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/535330737",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r540305220"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540305220"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@jonatack I don't have a strong opinion on this, I was more surprised to notify the discrepancy with other usual RPCs. \r\n\r\nMaybe this RPC design principle should be documented in https://github.com/bitcoin/bitcoin/blob/master/doc/JSON-RPC-interface.md ? The Postel's Law sounds a rational good enough to me but I'm not heavily developing against Core RPC so don't feel competent here to evaluate here :) ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-10T16:22:02Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound\\\" or \\\"blockrelay\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r540305220",
      "id" : 540305220,
      "in_reply_to_id" : 533557365,
      "line" : 330,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDMwNTIyMA==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 330,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 24,
      "pull_request_review_id" : 549369999,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540305220",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r540621380"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540621380"
         }
      },
      "author_association" : "MEMBER",
      "body" : "updated to `WITH_LOCK` syntax. \r\n\r\nwe discussed this offline, but to document here for other reviewers- \r\n\r\nSince we hold the `cs_vNodes` lock for counting open connections but then release it before invoking `OpenNetworkConnection`, `AddConnection` and `ThreadOpenConnections` could both count, determine there's space for an extra, and attempt to open a block-relay-only. We could fix this by having a counter / boolean that indicates opening a connection is \"in progress\", but that seems unnecessary here because its a low likelihood and this is a test-only API. ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-11T01:25:01Z",
      "diff_hunk" : "@@ -1143,6 +1143,30 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n+bool CConnman::AddConnection(const std::string& address, ConnectionType conn_type)\n+{\n+    assert(conn_type == ConnectionType::OUTBOUND_FULL_RELAY || conn_type == ConnectionType::BLOCK_RELAY);\n+\n+    const int max_connections = conn_type == ConnectionType::OUTBOUND_FULL_RELAY ? m_max_outbound_full_relay : m_max_outbound_block_relay;\n+\n+    // Count existing connections\n+    int existing_connections{0};\n+    {\n+        LOCK(cs_vNodes);\n+        existing_connections = std::count_if(vNodes.begin(), vNodes.end(), [conn_type](CNode* node) { return node->m_conn_type == conn_type; });\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r540621380",
      "id" : 540621380,
      "in_reply_to_id" : 534640401,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDYyMTM4MA==",
      "original_commit_id" : "ae7f4fdfe7f7a1d42c35589a7d61e9d44c32091a",
      "original_line" : 1157,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 549737305,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540621380",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r540621708"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540621708"
         }
      },
      "author_association" : "MEMBER",
      "body" : "reverted to being case sensitive ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-11T01:25:56Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound\\\" or \\\"blockrelay\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    if (Params().NetworkIDString() != CBaseChainParams::REGTEST) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only.\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in{ToLower(TrimString(request.params[1].get_str()))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r540621708",
      "id" : 540621708,
      "in_reply_to_id" : 534646707,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDYyMTcwOA==",
      "original_commit_id" : "d010c5ef0664514f0aedc8ee14d68b4226fafe35",
      "original_line" : 352,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 549737622,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540621708",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r540623057"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540623057"
         }
      },
      "author_association" : "MEMBER",
      "body" : "sure. the `addconnection` RPC currently interprets `false` to be `Error: Already at capacity for specified connection type.`, which I think is reasonable enough that I've kept it (capacity for other connection types is 0.) I'm also planning to make this net wider in the follow-up, as discussed here:  https://github.com/bitcoin/bitcoin/pull/19315#discussion_r525552821. For now, I've updated to return false and added documentation in the header comment for `AddConnection`. ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-11T01:29:39Z",
      "diff_hunk" : "@@ -1143,6 +1143,30 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     RandAddEvent((uint32_t)id);\n }\n \n+bool CConnman::AddConnection(const std::string& address, ConnectionType conn_type)\n+{\n+    assert(conn_type == ConnectionType::OUTBOUND_FULL_RELAY || conn_type == ConnectionType::BLOCK_RELAY);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r540623057",
      "id" : 540623057,
      "in_reply_to_id" : 534668415,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDYyMzA1Nw==",
      "original_commit_id" : "d010c5ef0664514f0aedc8ee14d68b4226fafe35",
      "original_line" : 1148,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 549738840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540623057",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r540623169"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540623169"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yes definitely. thanks, fixed.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-11T01:29:59Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound\\\" or \\\"blockrelay\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    if (Params().NetworkIDString() != CBaseChainParams::REGTEST) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only.\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in{ToLower(TrimString(request.params[1].get_str()))};\n+    ConnectionType conn_type{};\n+    if (conn_type_in == \"outbound\") {\n+        conn_type = ConnectionType::OUTBOUND_FULL_RELAY;\n+    } else if (conn_type_in == \"blockrelay\") {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r540623169",
      "id" : 540623169,
      "in_reply_to_id" : 534669600,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDYyMzE2OQ==",
      "original_commit_id" : "d010c5ef0664514f0aedc8ee14d68b4226fafe35",
      "original_line" : 356,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 549738948,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540623169",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r540623277"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540623277"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yeah but I find that pretty confusing so I made it context ð",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-11T01:30:19Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound\\\" or \\\"blockrelay\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    if (Params().NetworkIDString() != CBaseChainParams::REGTEST) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only.\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in{ToLower(TrimString(request.params[1].get_str()))};\n+    ConnectionType conn_type{};\n+    if (conn_type_in == \"outbound\") {\n+        conn_type = ConnectionType::OUTBOUND_FULL_RELAY;\n+    } else if (conn_type_in == \"blockrelay\") {\n+        conn_type = ConnectionType::BLOCK_RELAY;\n+    } else {\n+        throw JSONRPCError(RPC_INVALID_PARAMETER, self.ToString());\n+    }\n+\n+    NodeContext& context = EnsureNodeContext(request.context);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r540623277",
      "id" : 540623277,
      "in_reply_to_id" : 534669954,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDYyMzI3Nw==",
      "original_commit_id" : "d010c5ef0664514f0aedc8ee14d68b4226fafe35",
      "original_line" : 367,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 549739058,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540623277",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r540623816"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540623816"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ok AJ, you have convinced me, I made the counter explicit :) ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-11T01:31:56Z",
      "diff_hunk" : "@@ -542,6 +546,29 @@ def add_p2p_connection(self, p2p_conn, *, wait_for_verack=True, **kwargs):\n \n         return p2p_conn\n \n+    def add_outbound_p2p_connection(self, p2p_conn, *, connection_type=\"outbound\", **kwargs):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r540623816",
      "id" : 540623816,
      "in_reply_to_id" : 534751258,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDYyMzgxNg==",
      "original_commit_id" : "6e53cfba586e599151cdbc1396accb81deff0830",
      "original_line" : 549,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : null,
      "pull_request_review_id" : 549739595,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540623816",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r540632078"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540632078"
         }
      },
      "author_association" : "MEMBER",
      "body" : "hmmm, I see that `addnode` RPC returns this error, but seems like that's what is indicated by the bool that the `AddNode` function returns since it's comparing to `vAddedNodes`. In the current implementation, we don't currently know that information until we call through to `OpenNetworkConnection`, which simply returns if we are  `AlreadyConnectedToAddress(addrConnect))`. We could add a call from `AddConnection` to check that and return early. And then it would have to populate a boolean as an in/out param (since the existing return value indicates whether there is sufficient capacity). This is all doable, but I'm not really seeing the additional value. It would be able to catch a bug in the test framework logic I'm adding, but that bug would also be caught by the tests in `p2p_add_connections.py`. And I don't think this would be helpful for additional tests that use the test framework utilities? What do you think? ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-11T01:55:14Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r540632078",
      "id" : 540632078,
      "in_reply_to_id" : 533554882,
      "line" : 318,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDYzMjA3OA==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 318,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 12,
      "pull_request_review_id" : 549747214,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540632078",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r540632971"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540632971"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yes this looks great, thank you ðð½\r\n\r\nI like the refactor into making `peer_protocol` a part of `create_server`. Helps makes the usage pattern more apparent. \r\n\r\nAlso appreciate the comments. I was struggling to write helpful words. \r\n\r\nTook the patch pretty much as is. Convenient that you are already a co-author on the commit :) ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-11T01:57:24Z",
      "diff_hunk" : "@@ -539,6 +566,34 @@ def close(self, timeout=10):\n         # Safe to remove event loop.\n         NetworkThread.network_event_loop = None\n \n+    @classmethod\n+    def listen(cls, p2p, callback, port=None, addr=None, idx=1):\n+        if port is None:\n+            assert 0 < idx <= MAX_NODES\n+            port = p2p_port(MAX_NODES - idx)\n+        if addr is None:\n+            addr = '127.0.0.1'\n+        coroutine = cls.create_listen_server(addr, port, callback, p2p)\n+        cls.network_event_loop.call_soon_threadsafe(cls.network_event_loop.create_task, coroutine)\n+\n+    @classmethod\n+    def peer_listener(cls, addr, port):\n+        def pl():\n+            x = cls.protos.get((addr, port))\n+            cls.protos[(addr, port)] = None\n+            return x\n+        return pl\n+\n+    @classmethod\n+    async def create_listen_server(cls, addr, port, callback, proto):\n+        if (addr, port) not in cls.listeners:\n+            listener = await cls.network_event_loop.create_server(cls.peer_listener(addr, port), addr, port)\n+            logger.debug(\"Listening server on %s:%d should be started\" % (addr, port))\n+            cls.listeners[(addr, port)] = listener\n+        cls.protos[(addr, port)] = proto\n+        callback(addr, port)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r540632971",
      "id" : 540632971,
      "in_reply_to_id" : 534747237,
      "line" : 611,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDYzMjk3MQ==",
      "original_commit_id" : "6e53cfba586e599151cdbc1396accb81deff0830",
      "original_line" : 611,
      "original_position" : 133,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/p2p.py",
      "position" : 147,
      "pull_request_review_id" : 549747991,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540632971",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "thank you for these thoughtful reviews! \r\n\r\nreview comments addressed and CI is green ",
      "created_at" : "2020-12-11T20:24:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-743408776",
      "id" : 743408776,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0MzQwODc3Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-11T20:24:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/743408776",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-12-16T18:02:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-746740923",
      "id" : 746740923,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0Njc0MDkyMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-16T18:02:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/746740923",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased ",
      "created_at" : "2020-12-16T19:31:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-746885067",
      "id" : 746885067,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0Njg4NTA2Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-16T19:31:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/746885067",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r544639295"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/544639295"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "\"node\" seems much less confusing to me; `node` gives you access to all the bits of the node, `request.context` gives you the overall context available for the rpc. In general, picking a convention and sticking with it makes the codebase much easier to navigate.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-16T21:34:58Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound\\\" or \\\"blockrelay\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    if (Params().NetworkIDString() != CBaseChainParams::REGTEST) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only.\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in{ToLower(TrimString(request.params[1].get_str()))};\n+    ConnectionType conn_type{};\n+    if (conn_type_in == \"outbound\") {\n+        conn_type = ConnectionType::OUTBOUND_FULL_RELAY;\n+    } else if (conn_type_in == \"blockrelay\") {\n+        conn_type = ConnectionType::BLOCK_RELAY;\n+    } else {\n+        throw JSONRPCError(RPC_INVALID_PARAMETER, self.ToString());\n+    }\n+\n+    NodeContext& context = EnsureNodeContext(request.context);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r544639295",
      "id" : 544639295,
      "in_reply_to_id" : 534669954,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDYzOTI5NQ==",
      "original_commit_id" : "d010c5ef0664514f0aedc8ee14d68b4226fafe35",
      "original_line" : 367,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 554102983,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/544639295",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r544705501"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/544705501"
         }
      },
      "author_association" : "MEMBER",
      "body" : "alright, I definitely agree with the rationale of staying consistent with conventions, so I pushed a fix ",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2020-12-16T23:48:26Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound\\\" or \\\"blockrelay\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    if (Params().NetworkIDString() != CBaseChainParams::REGTEST) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only.\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in{ToLower(TrimString(request.params[1].get_str()))};\n+    ConnectionType conn_type{};\n+    if (conn_type_in == \"outbound\") {\n+        conn_type = ConnectionType::OUTBOUND_FULL_RELAY;\n+    } else if (conn_type_in == \"blockrelay\") {\n+        conn_type = ConnectionType::BLOCK_RELAY;\n+    } else {\n+        throw JSONRPCError(RPC_INVALID_PARAMETER, self.ToString());\n+    }\n+\n+    NodeContext& context = EnsureNodeContext(request.context);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r544705501",
      "id" : 544705501,
      "in_reply_to_id" : 534669954,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDcwNTUwMQ==",
      "original_commit_id" : "d010c5ef0664514f0aedc8ee14d68b4226fafe35",
      "original_line" : 367,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : null,
      "pull_request_review_id" : 554176377,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-07T18:31:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/544705501",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "small update to address aj's suggestion about variable name ",
      "created_at" : "2020-12-16T23:49:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-747109525",
      "id" : 747109525,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0NzEwOTUyNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-16T23:49:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/747109525",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-12-31T17:59:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-753017014",
      "id" : 753017014,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MzAxNzAxNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-31T17:59:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/753017014",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2021-01-01T19:15:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-753370155",
      "id" : 753370155,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1MzM3MDE1NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-01T19:15:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/753370155",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "reACK 092da16e89b42de7e44a83b184d95a967875f135\r\n\r\nWith some help from `git range-diff master 22ba154 HEAD`.\r\n\r\nThe changes to the python asyncio pieces (renames, refactors, comments) are great!\r\n",
      "created_at" : "2021-01-06T03:11:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-755048206",
      "id" : 755048206,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1NTA0ODIwNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-06T03:11:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/755048206",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-01-07T15:07:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-756172788",
      "id" : 756172788,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1NjE3Mjc4OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-07T15:07:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/756172788",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2021-01-07T18:31:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-756298162",
      "id" : 756298162,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1NjI5ODE2Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-07T18:31:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/756298162",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "thanks for the re-review @troygiorshev ! should be trivial to re-ack, the rebase was just because of adjacent lines in `net.h`",
      "created_at" : "2021-01-07T18:32:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-756298630",
      "id" : 756298630,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1NjI5ODYzMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-07T18:32:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/756298630",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r553855408"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/553855408"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This seems like an appropriate amount of detail for an error message (especially one for an RPC which is test-only).",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2021-01-08T10:11:43Z",
      "diff_hunk" : "@@ -320,20 +322,31 @@ static RPCHelpMan addconnection()\n         throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only\");\n     }\n \n-    RPCTypeCheckArgument(request.params, UniValue::VSTR);\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n     const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in = request.params[1].get_str();\n+    ConnectionType conn_type{};\n+    if (conn_type_in == \"outbound\") {\n+        conn_type = ConnectionType::OUTBOUND_FULL_RELAY;\n+    } else if (conn_type_in == \"blockrelay\") {\n+        conn_type = ConnectionType::BLOCK_RELAY;\n+    } else {\n+        throw std::runtime_error(self.ToString());\n+    }\n+\n     NodeContext& context = EnsureNodeContext(request.context);\n     if (!context.connman) {\n         throw JSONRPCError(RPC_CLIENT_P2P_DISABLED, \"Error: Peer-to-peer functionality missing or disabled\");\n     }\n \n-    const bool success = context.connman->AddConnection(address);\n+    const bool success = context.connman->AddConnection(address, conn_type);\n     if (!success) {\n-        throw JSONRPCError(RPC_CLIENT_NODE_CAPACITY_REACHED, \"Error: Max number of outbound full relay connections already open.\");\n+        throw JSONRPCError(RPC_CLIENT_NODE_CAPACITY_REACHED, \"Error: Already at capacity for specified connection type.\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r553855408",
      "id" : 553855408,
      "in_reply_to_id" : 499519175,
      "line" : 361,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzg1NTQwOA==",
      "original_commit_id" : "0fb4635bbabb1bea10a215bde4c803ceb5bc5f26",
      "original_line" : 361,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 55,
      "pull_request_review_id" : 564144934,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-08T10:11:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/553855408",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r553856609"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/553856609"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Similar to https://github.com/bitcoin/bitcoin/pull/19315#discussion_r525435591, I think more detailed error reporting can be done in a follow-up PR.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2021-01-08T10:14:17Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r553856609",
      "id" : 553856609,
      "in_reply_to_id" : 533554882,
      "line" : 318,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzg1NjYwOQ==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 318,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 12,
      "pull_request_review_id" : 564146644,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-08T10:14:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/553856609",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r553856841"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/553856841"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It seems no-one has a strong opinion on this. I think it's fine as is. Resolve?",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2021-01-08T10:14:47Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound\\\" or \\\"blockrelay\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r553856841",
      "id" : 553856841,
      "in_reply_to_id" : 533557365,
      "line" : 330,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzg1Njg0MQ==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 330,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 24,
      "pull_request_review_id" : 564146979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-08T10:14:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/553856841",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r553858110"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/553858110"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(Only if you have to retouch this branch for other reasons): use new style string formatting (`\"{}\".format(var)`) here, or even better, f-strings (`f\"{var}\"`).",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2021-01-08T10:17:19Z",
      "diff_hunk" : "@@ -148,12 +152,20 @@ def peer_connect(self, dstaddr, dstport, *, net, timeout_factor):\n         self.on_connection_send_msg = None\n         self.recvbuf = b\"\"\n         self.magic_bytes = MAGIC_BYTES[net]\n-        logger.debug('Connecting to Bitcoin Node: %s:%d' % (self.dstaddr, self.dstport))\n+\n+    def peer_connect(self, dstaddr, dstport, *, net, timeout_factor):\n+        self.peer_connect_helper(dstaddr, dstport, net, timeout_factor)\n \n         loop = NetworkThread.network_event_loop\n-        conn_gen_unsafe = loop.create_connection(lambda: self, host=self.dstaddr, port=self.dstport)\n-        conn_gen = lambda: loop.call_soon_threadsafe(loop.create_task, conn_gen_unsafe)\n-        return conn_gen\n+        logger.debug('Connecting to Bitcoin Node: %s:%d' % (self.dstaddr, self.dstport))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r553858110",
      "id" : 553858110,
      "line" : 160,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzg1ODExMA==",
      "original_commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "original_line" : 160,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/p2p.py",
      "position" : 35,
      "pull_request_review_id" : 564148613,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-08T11:00:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/553858110",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r553859419"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/553859419"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm not sure what \"should be\" means here. I think the log could just say \"Listening server on x started\". Also, could use new style string formatting or f-strings.\r\n\r\nThis isn't a big deal. Only change it if you need to retouch the branch.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2021-01-08T10:20:02Z",
      "diff_hunk" : "@@ -542,6 +569,48 @@ def close(self, timeout=10):\n         # Safe to remove event loop.\n         NetworkThread.network_event_loop = None\n \n+    @classmethod\n+    def listen(cls, p2p, callback, port=None, addr=None, idx=1):\n+        \"\"\" Ensure a listening server is running on the given port, and run the\n+        protocol specified by `p2p` on the next connection to it. Once ready\n+        for connections, call `callback`.\"\"\"\n+\n+        if port is None:\n+            assert 0 < idx <= MAX_NODES\n+            port = p2p_port(MAX_NODES - idx)\n+        if addr is None:\n+            addr = '127.0.0.1'\n+\n+        coroutine = cls.create_listen_server(addr, port, callback, p2p)\n+        cls.network_event_loop.call_soon_threadsafe(cls.network_event_loop.create_task, coroutine)\n+\n+    @classmethod\n+    async def create_listen_server(cls, addr, port, callback, proto):\n+        def peer_protocol():\n+            \"\"\"Returns a function that does the protocol handling for a new\n+            connection. To allow different connections to have different\n+            behaviors, the protocol function is first put in the cls.protos\n+            dict. When the connection is made, the function removes the\n+            protocol function from that dict, and returns it so the event loop\n+            can start executing it.\"\"\"\n+            response = cls.protos.get((addr, port))\n+            cls.protos[(addr, port)] = None\n+            return response\n+\n+        if (addr, port) not in cls.listeners:\n+            # When creating a listener on a given (addr, port) we only need to\n+            # do it once. If we want different behaviors for different\n+            # connections, we can accomplish this by providing different\n+            # `proto` functions\n+\n+            listener = await cls.network_event_loop.create_server(peer_protocol, addr, port)\n+            logger.debug(\"Listening server on %s:%d should be started\" % (addr, port))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r553859419",
      "id" : 553859419,
      "line" : 607,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzg1OTQxOQ==",
      "original_commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "original_line" : 607,
      "original_position" : 143,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/p2p.py",
      "position" : 143,
      "pull_request_review_id" : 564148613,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-08T11:00:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/553859419",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r553876856"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/553876856"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(re: https://github.com/bitcoin/bitcoin/pull/19315#discussion_r479358247)\r\n\r\nI don't think you need to pass the height at all. Just get the block at the tip:\r\n\r\n```diff\r\ndiff --git a/test/functional/p2p_blocksonly.py b/test/functional/p2p_blocksonly.py\r\nindex c592ab52b1..e6c3f75955 100755\r\n--- a/test/functional/p2p_blocksonly.py\r\n+++ b/test/functional/p2p_blocksonly.py\r\n@@ -80,7 +80,7 @@ class P2PBlocksOnly(BitcoinTestFramework):\r\n         # Ensure we disconnect if a block-relay-only connection sends us a transaction\r\n         self.nodes[0].add_outbound_p2p_connection(P2PInterface(), p2p_idx=0, connection_type=\"block-relay-only\")\r\n         assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\r\n-        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\r\n+        _, txid, tx_hex = self.check_p2p_tx_violation()\r\n \r\n         self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\r\n         conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), p2p_idx=1, connection_type=\"block-relay-only\")\r\n@@ -97,9 +97,10 @@ class P2PBlocksOnly(BitcoinTestFramework):\r\n         conn.sync_with_ping()\r\n         assert(int(txid, 16) not in conn.get_invs())\r\n \r\n-    def check_p2p_tx_violation(self, index=1):\r\n+    def check_p2p_tx_violation(self):\r\n         self.log.info('Check that txs from P2P are rejected and result in disconnect')\r\n-        input_txid = self.nodes[0].getblock(self.nodes[0].getblockhash(index), 2)['tx'][0]['txid']\r\n+\r\n+        input_txid = self.nodes[0].getblock(self.nodes[0].getbestblockhash(), 2)['tx'][0]['txid']\r\n         tx = create_transaction(self.nodes[0], input_txid, self.nodes[0].getnewaddress(), amount=(50 - 0.001))\r\n         txid = tx.rehash()\r\n         tx_hex = tx.serialize().hex()\r\n```",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2021-01-08T10:56:02Z",
      "diff_hunk" : "@@ -69,18 +53,58 @@ def run_test(self):\n         peer_2_info = self.nodes[0].getpeerinfo()[1]\n         assert_equal(peer_2_info['whitelisted'], True)\n         assert_equal(peer_2_info['permissions'], ['noban', 'forcerelay', 'relay', 'mempool', 'download'])\n-        assert_equal(self.nodes[0].testmempoolaccept([sigtx])[0]['allowed'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n \n         self.log.info('Check that the tx from forcerelay first_peer is relayed to others (ie.second_peer)')\n         with self.nodes[0].assert_debug_log([\"received getdata\"]):\n-            first_peer.send_message(msg_tx(FromHex(CTransaction(), sigtx)))\n+            first_peer.send_message(msg_tx(tx))\n             self.log.info('Check that the forcerelay peer is still connected after sending the transaction')\n             assert_equal(first_peer.is_connected, True)\n             second_peer.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)\n         self.log.info(\"Forcerelay peer's transaction is accepted and relayed\")\n \n+        self.nodes[0].disconnect_p2ps()\n+        self.nodes[0].generate(1)\n+\n+    def blocks_relay_conn_tests(self):\n+        self.log.info('Tests with node in normal mode with block-relay-only connections')\n+        self.restart_node(0, [\"-noblocksonly\"])  # disables blocks only mode\n+        assert_equal(self.nodes[0].getnetworkinfo()['localrelay'], True)\n+\n+        # Ensure we disconnect if a block-relay-only connection sends us a transaction\n+        self.nodes[0].add_outbound_p2p_connection(P2PInterface(), connection_type=\"blockrelay\")\n+        assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], False)\n+        _, txid, tx_hex = self.check_p2p_tx_violation(index=2)\n+\n+        self.log.info(\"Check that txs from RPC are not sent to blockrelay connection\")\n+        conn = self.nodes[0].add_outbound_p2p_connection(P2PTxInvStore(), connection_type=\"blockrelay\")\n+\n+        # bump time forward to ensure nNextInvSend timer pops\n+        self.nodes[0].setmocktime(int(time.time()) + 5)\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)\n+        self.nodes[0].sendrawtransaction(tx_hex)\n+        conn.sync_with_ping()\n+        assert(int(txid, 16) not in conn.get_invs())\n+\n+    def check_p2p_tx_violation(self, index=1):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r553876856",
      "id" : 553876856,
      "in_reply_to_id" : 479358247,
      "line" : 100,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzg3Njg1Ng==",
      "original_commit_id" : "3bb87e7fb200637e61d25f07ce20672081fad4ab",
      "original_line" : 100,
      "original_position" : 123,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 130,
      "pull_request_review_id" : 564148613,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-08T11:01:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/553876856",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think this is very close to being ready for merge.\r\n\r\nPrevious ACKs: @troygiorshev (https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-755048206)\r\nPrevious concept/approack ACKs: @ajtowns (https://github.com/bitcoin/bitcoin/pull/19315#pullrequestreview-543415029), @jonatack (https://github.com/bitcoin/bitcoin/pull/19315#pullrequestreview-535555222), @hebasto (https://github.com/bitcoin/bitcoin/pull/19315#pullrequestreview-501903744), @mzumsande (https://github.com/bitcoin/bitcoin/pull/19315#pullrequestreview-497100606), @ariard (https://github.com/bitcoin/bitcoin/pull/19315#pullrequestreview-488885293), @practicalswift (https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-683210775), @glozow (https://github.com/bitcoin/bitcoin/pull/19315#pullrequestreview-477723783), @robot-dreams (https://github.com/bitcoin/bitcoin/pull/19315#pullrequestreview-476841303), @MarcoFalke (https://github.com/bitcoin/bitcoin/pull/19315#pullrequestreview-474288186), @t-bast (https://github.com/bitcoin/bitcoin/pull/19315#pullrequestreview-442187488)",
      "created_at" : "2021-01-08T11:07:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-756697355",
      "id" : 756697355,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1NjY5NzM1NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-08T11:07:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/756697355",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "reACK b4dd2ef8009703b81235e2d9a2a736a3a5e8152f\r\n\r\nTrivial from my last ACK :)\r\n\r\nFor anyone interested resources on the python asyncio parts, [the python asyncio docs](https://docs.python.org/3/library/asyncio.html), especially the [transports and protocols page](https://docs.python.org/3/library/asyncio-protocol.html) and the examples on the bottom of that page are useful!",
      "created_at" : "2021-01-08T22:13:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#issuecomment-757025249",
      "id" : 757025249,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19315",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1NzAyNTI0OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-08T22:13:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/757025249",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r555025874"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555025874"
         }
      },
      "author_association" : "MEMBER",
      "body" : "5bc04e8837c0452923cebd1b823a85e5c4dcdfa6:\r\n\r\nIf this is only used in test, why not call it `AddTestConnection`? Otherwise someone might use it in \"production\".",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2021-01-11T12:53:14Z",
      "diff_hunk" : "@@ -955,6 +955,19 @@ class CConnman\n     bool RemoveAddedNode(const std::string& node);\n     std::vector<AddedNodeInfo> GetAddedNodeInfo();\n \n+    /**\n+     * Attempts to open a connection. Currently only used from tests.\n+     *\n+     * @param[in]   address     Address of node to try connecting to\n+     * @param[in]   conn_type   ConnectionType::OUTBOUND or ConnectionType::BLOCK_RELAY\n+     * @return      bool        Returns false if there are no available\n+     *                          slots for this connection:\n+     *                          - conn_type not a supported ConnectionType\n+     *                          - Max total outbound connection capacity filled\n+     *                          - Max connection capacity for type is filled\n+     */\n+    bool AddConnection(const std::string& address, ConnectionType conn_type);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r555025874",
      "id" : 555025874,
      "line" : 969,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTAyNTg3NA==",
      "original_commit_id" : "5bc04e8837c0452923cebd1b823a85e5c4dcdfa6",
      "original_line" : 969,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 15,
      "pull_request_review_id" : 565326029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-11T19:33:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555025874",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r555121932"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555121932"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I still think this should be removed. If this can't be parsed, a parse-failure will already be thrown.\r\n\r\nThough, can be done in a follow-up to not invalidate reviews.\r\n\r\nUnrelated, but posels' law is probably not applicable to security sensitive software, see http://www.langsec.org/papers/postel-patch.pdf",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2021-01-11T15:21:41Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound\\\" or \\\"blockrelay\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r555121932",
      "id" : 555121932,
      "in_reply_to_id" : 533557365,
      "line" : 330,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTEyMTkzMg==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 330,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 24,
      "pull_request_review_id" : 565326029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-11T19:33:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555121932",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r555127628"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555127628"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same commit: Any reason to trim the string? We don't do this anywhere else.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2021-01-11T15:29:38Z",
      "diff_hunk" : "@@ -314,6 +315,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound-full-relay\\\" or \\\"block-relay-only\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound-full-relay\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound-full-relay\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    if (Params().NetworkIDString() != CBaseChainParams::REGTEST) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only.\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in{TrimString(request.params[1].get_str())};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r555127628",
      "id" : 555127628,
      "line" : 344,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTEyNzYyOA==",
      "original_commit_id" : "5bc04e8837c0452923cebd1b823a85e5c4dcdfa6",
      "original_line" : 344,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 38,
      "pull_request_review_id" : 565326029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-11T19:33:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555127628",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r555230229"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555230229"
         }
      },
      "author_association" : "MEMBER",
      "body" : "3997ab915451a702eed2153a0727b0a78c0450ac:\r\n\r\nWhat is this?",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2021-01-11T17:48:04Z",
      "diff_hunk" : "@@ -71,6 +71,7 @@ def __init__(self, i, datadir, *, chain, rpchost, timewait, timeout_factor, bitc\n         \"\"\"\n \n         self.index = i\n+        self.p2p_conn_index = 1",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r555230229",
      "id" : 555230229,
      "line" : 74,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTIzMDIyOQ==",
      "original_commit_id" : "3997ab915451a702eed2153a0727b0a78c0450ac",
      "original_line" : 74,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : 4,
      "pull_request_review_id" : 565326029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-11T19:33:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555230229",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r555230459"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555230459"
         }
      },
      "author_association" : "MEMBER",
      "body" : "3997ab915451a702eed2153a0727b0a78c0450ac: The `+1` seems like a layer violation that should be done in the p2p module instead.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2021-01-11T17:48:26Z",
      "diff_hunk" : "@@ -546,6 +547,29 @@ def add_p2p_connection(self, p2p_conn, *, wait_for_verack=True, **kwargs):\n \n         return p2p_conn\n \n+    def add_outbound_p2p_connection(self, p2p_conn, *, p2p_idx, connection_type=\"outbound-full-relay\", **kwargs):\n+        \"\"\"Add an outbound p2p connection from node. Either\n+        full-relay(\"outbound-full-relay\") or\n+        block-relay-only(\"block-relay-only\") connection.\n+\n+        This method adds the p2p connection to the self.p2ps list and returns\n+        the connection to the caller.\n+        \"\"\"\n+\n+        def addconnection_callback(address, port):\n+            self.log.debug(\"Connecting to %s:%d %s\" % (address, port, connection_type))\n+            self.addconnection('%s:%d' % (address, port), connection_type)\n+\n+        p2p_conn.peer_accept_connection(connect_cb=addconnection_callback, connect_id=p2p_idx + 1, net=self.chain, timeout_factor=self.timeout_factor, **kwargs)()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r555230459",
      "id" : 555230459,
      "line" : 563,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTIzMDQ1OQ==",
      "original_commit_id" : "3997ab915451a702eed2153a0727b0a78c0450ac",
      "original_line" : 563,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : 34,
      "pull_request_review_id" : 565326029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-11T19:33:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555230459",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r555246808"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555246808"
         }
      },
      "author_association" : "MEMBER",
      "body" : "3997ab915451a702eed2153a0727b0a78c0450ac:\r\n\r\nAny reason to add default arguments for an arg that is set in all call sites? I don't think it makes sense to skip the connect_cb here?\r\n\r\nAlso could enforce named args with `*`",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2021-01-11T18:16:28Z",
      "diff_hunk" : "@@ -148,12 +152,20 @@ def peer_connect(self, dstaddr, dstport, *, net, timeout_factor):\n         self.on_connection_send_msg = None\n         self.recvbuf = b\"\"\n         self.magic_bytes = MAGIC_BYTES[net]\n-        logger.debug('Connecting to Bitcoin Node: %s:%d' % (self.dstaddr, self.dstport))\n+\n+    def peer_connect(self, dstaddr, dstport, *, net, timeout_factor):\n+        self.peer_connect_helper(dstaddr, dstport, net, timeout_factor)\n \n         loop = NetworkThread.network_event_loop\n-        conn_gen_unsafe = loop.create_connection(lambda: self, host=self.dstaddr, port=self.dstport)\n-        conn_gen = lambda: loop.call_soon_threadsafe(loop.create_task, conn_gen_unsafe)\n-        return conn_gen\n+        logger.debug('Connecting to Bitcoin Node: %s:%d' % (self.dstaddr, self.dstport))\n+        coroutine = loop.create_connection(lambda: self, host=self.dstaddr, port=self.dstport)\n+        return lambda: loop.call_soon_threadsafe(loop.create_task, coroutine)\n+\n+    def peer_accept_connection(self, connect_id, connect_cb=lambda: None, *, net, timeout_factor):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r555246808",
      "id" : 555246808,
      "line" : 164,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI0NjgwOA==",
      "original_commit_id" : "3997ab915451a702eed2153a0727b0a78c0450ac",
      "original_line" : 164,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/p2p.py",
      "position" : 39,
      "pull_request_review_id" : 565326029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-11T19:33:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555246808",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r555249793"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555249793"
         }
      },
      "author_association" : "MEMBER",
      "body" : "3997ab9:\r\n\r\nWould be nice to not use the helper unless necessary. It doesn't matter here, but  it won't propagate the scaling factor",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2021-01-11T18:21:46Z",
      "diff_hunk" : "@@ -414,6 +435,10 @@ def test_function():\n \n         wait_until_helper(test_function, timeout=timeout, lock=p2p_lock, timeout_factor=self.timeout_factor)\n \n+    def wait_for_connect(self, timeout=60):\n+        test_function = lambda: self.is_connected\n+        wait_until_helper(test_function, timeout=timeout, lock=p2p_lock)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r555249793",
      "id" : 555249793,
      "line" : 440,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI0OTc5Mw==",
      "original_commit_id" : "3997ab915451a702eed2153a0727b0a78c0450ac",
      "original_line" : 440,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/p2p.py",
      "position" : 90,
      "pull_request_review_id" : 565326029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-11T19:33:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555249793",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r555253158"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555253158"
         }
      },
      "author_association" : "MEMBER",
      "body" : "same commit:\r\n\r\nWhat is the point of allowing those args when they are never set? I'd say *if* there is ever a test that needs them set, that pull can make the needed changes here. Because other changes are required for this anyway to work.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2021-01-11T18:27:46Z",
      "diff_hunk" : "@@ -542,6 +569,48 @@ def close(self, timeout=10):\n         # Safe to remove event loop.\n         NetworkThread.network_event_loop = None\n \n+    @classmethod\n+    def listen(cls, p2p, callback, port=None, addr=None, idx=1):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r555253158",
      "id" : 555253158,
      "line" : 573,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI1MzE1OA==",
      "original_commit_id" : "3997ab915451a702eed2153a0727b0a78c0450ac",
      "original_line" : 573,
      "original_position" : 109,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/p2p.py",
      "position" : 109,
      "pull_request_review_id" : 565326029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-11T19:33:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555253158",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r555274018"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555274018"
         }
      },
      "author_association" : "MEMBER",
      "body" : "99791e7560d40ad094eaa73e0be3987581338e2d: If you touch this, I'd prefer to remove it. This doesn't check anything",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2021-01-11T19:05:30Z",
      "diff_hunk" : "@@ -51,13 +40,13 @@ def run_test(self):\n \n         self.log.info('Check that txs from rpc are not rejected and relayed to other peers')\n         assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r555274018",
      "id" : 555274018,
      "line" : 40,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI3NDAxOA==",
      "original_commit_id" : "99791e7560d40ad094eaa73e0be3987581338e2d",
      "original_line" : 44,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 69,
      "pull_request_review_id" : 565326029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-11T19:33:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555274018",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r555274399"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555274399"
         }
      },
      "author_association" : "MEMBER",
      "body" : "99791e7560d40ad094eaa73e0be3987581338e2d: Same",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2021-01-11T19:06:08Z",
      "diff_hunk" : "@@ -67,8 +56,7 @@ def run_test(self):\n         assert_equal(peer_1_info['permissions'], ['relay'])\n         peer_2_info = self.nodes[0].getpeerinfo()[1]\n         assert_equal(peer_2_info['permissions'], ['relay'])\n-        assert_equal(self.nodes[0].testmempoolaccept([sigtx])[0]['allowed'], True)\n-        txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n+        assert_equal(self.nodes[0].testmempoolaccept([tx_hex])[0]['allowed'], True)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r555274399",
      "id" : 555274399,
      "line" : 55,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI3NDM5OQ==",
      "original_commit_id" : "99791e7560d40ad094eaa73e0be3987581338e2d",
      "original_line" : 59,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "test/functional/p2p_blocksonly.py",
      "position" : 86,
      "pull_request_review_id" : 565326029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-11T19:33:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555274399",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r555320342"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555320342"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That paper on Postel's Law appears to discuss issues of computational complexity involving difficult parsing or high ambiguity, which IIRC isn't the case for this RPC, and states among other things that a balance should be struck, which I agree with. In security-sensitive missions for airports, power grids, industry manufacturers, etc., my experience was that it depended on the context, stakeholders and product managers. Usually, anyone whose code didn't handle simple, unambiguous input in a robust and non-annoying way got a bug report and a phone call by a PM or scrum master, so it became an instinct to do so and not provide reasons for them to beat us over the head--which I'm unlearning here to adapt to the consensus of the stakeholders on this project. It's a process!",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2021-01-11T20:33:12Z",
      "diff_hunk" : "@@ -322,6 +323,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound\\\" or \\\"blockrelay\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r555320342",
      "id" : 555320342,
      "in_reply_to_id" : 533557365,
      "line" : 330,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTMyMDM0Mg==",
      "original_commit_id" : "22ba154178594c21e1342657f3d9a14c877623da",
      "original_line" : 330,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 24,
      "pull_request_review_id" : 565714923,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-11T20:36:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555320342",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r555331970"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555331970"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This was my fault--I suggested it earlier on.",
      "commit_id" : "b4dd2ef8009703b81235e2d9a2a736a3a5e8152f",
      "created_at" : "2021-01-11T20:56:04Z",
      "diff_hunk" : "@@ -314,6 +315,61 @@ static RPCHelpMan addnode()\n     };\n }\n \n+static RPCHelpMan addconnection()\n+{\n+    return RPCHelpMan{\"addconnection\",\n+        \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n+        {\n+            {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound-full-relay\\\" or \\\"block-relay-only\\\".\"},\n+        },\n+        RPCResult{\n+            RPCResult::Type::OBJ, \"\", \"\",\n+            {\n+                { RPCResult::Type::STR, \"address\", \"Address of newly added connection.\" },\n+                { RPCResult::Type::STR, \"connection_type\", \"Type of connection opened.\" },\n+            }},\n+        RPCExamples{\n+            HelpExampleCli(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound-full-relay\\\"\")\n+            + HelpExampleRpc(\"addconnection\", \"\\\"192.168.0.6:8333\\\" \\\"outbound-full-relay\\\"\")\n+        },\n+        [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n+{\n+    if (Params().NetworkIDString() != CBaseChainParams::REGTEST) {\n+        throw std::runtime_error(\"addconnection is for regression testing (-regtest mode) only.\");\n+    }\n+\n+    RPCTypeCheck(request.params, {UniValue::VSTR, UniValue::VSTR});\n+    const std::string address = request.params[0].get_str();\n+    const std::string conn_type_in{TrimString(request.params[1].get_str())};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19315#discussion_r555331970",
      "id" : 555331970,
      "in_reply_to_id" : 555127628,
      "line" : 344,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTMzMTk3MA==",
      "original_commit_id" : "5bc04e8837c0452923cebd1b823a85e5c4dcdfa6",
      "original_line" : 344,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/rpc/net.cpp",
      "position" : 38,
      "pull_request_review_id" : 565729834,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19315",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-11T20:56:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/555331970",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   }
]
