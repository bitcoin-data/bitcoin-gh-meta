[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441621704"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441621704"
         }
      },
      "author_association" : "MEMBER",
      "body" : "use `assert_equal`",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T15:10:27Z",
      "diff_hunk" : "@@ -42,13 +43,30 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers\")\n+        conn = self.nodes[0].add_p2p_connection(P2PDataStore())\n+        # Create valid message\n+        msg = conn.build_message(msg_ping(nonce=12345))\n+        cut_pos = 12    # Chosen at an arbitrary position within the header\n+        # Send message in two pieces\n+        before = self.nodes[0].getnettotals()['totalbytesrecv']\n+        conn.send_raw_message(msg[:cut_pos])\n+        middle = self.nodes[0].getnettotals()['totalbytesrecv']\n+        # If this assert fails, we've hit an unlikely race\n+        # where the test framework sent a message in between the two halves\n+        assert middle == before + cut_pos",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441621704",
      "id" : 441621704,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYyMTcwNA==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 66,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432503750,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441621704",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441623383"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441623383"
         }
      },
      "author_association" : "MEMBER",
      "body" : "suggestion: perhaps describe the expected result",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T15:12:29Z",
      "diff_hunk" : "@@ -42,13 +43,30 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441623383",
      "id" : 441623383,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYyMzM4Mw==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 59,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432503750,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441623383",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441624037"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441624037"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why not test the debug log output as well, e.g. `Incomplete headerReceived`. I think this works; maybe it can be improved on:\r\n\r\n```diff\r\n-        msg = conn.build_message(msg_ping(nonce=12345))\r\n-        cut_pos = 12    # Chosen at an arbitrary position within the header\r\n-        # Send message in two pieces\r\n-        before = self.nodes[0].getnettotals()['totalbytesrecv']\r\n-        conn.send_raw_message(msg[:cut_pos])\r\n-        middle = self.nodes[0].getnettotals()['totalbytesrecv']\r\n-        # If this assert fails, we've hit an unlikely race\r\n-        # where the test framework sent a message in between the two halves\r\n-        assert middle == before + cut_pos\r\n-        conn.send_raw_message(msg[cut_pos:])\r\n-        conn.sync_with_ping(timeout=1)\r\n+        with self.nodes[0].assert_debug_log(['Incomplete headerReceived']):\r\n+            msg = conn.build_message(msg_ping(nonce=12345))\r\n+            cut_pos = 12    # Chosen at an arbitrary position within the header\r\n+            # Send message in two pieces\r\n+            before = self.nodes[0].getnettotals()['totalbytesrecv']\r\n+            conn.send_raw_message(msg[:cut_pos])\r\n+            middle = self.nodes[0].getnettotals()['totalbytesrecv']\r\n+            # If this assert fails, we've hit an unlikely race\r\n+            # where the test framework sent a message in between the two halves\r\n+            assert middle == before + cut_pos\r\n+            conn.send_raw_message(msg[cut_pos:])\r\n+            conn.sync_with_ping(timeout=1)\r\n\r\nwith self.nodes[0].assert_debug_log(['[net] Incomplete headerReceived']):\r\n```",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T15:13:12Z",
      "diff_hunk" : "@@ -42,13 +43,30 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers\")\n+        conn = self.nodes[0].add_p2p_connection(P2PDataStore())\n+        # Create valid message\n+        msg = conn.build_message(msg_ping(nonce=12345))\n+        cut_pos = 12    # Chosen at an arbitrary position within the header\n+        # Send message in two pieces\n+        before = self.nodes[0].getnettotals()['totalbytesrecv']\n+        conn.send_raw_message(msg[:cut_pos])\n+        middle = self.nodes[0].getnettotals()['totalbytesrecv']\n+        # If this assert fails, we've hit an unlikely race\n+        # where the test framework sent a message in between the two halves\n+        assert middle == before + cut_pos",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441624037",
      "id" : 441624037,
      "in_reply_to_id" : 441621704,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYyNDAzNw==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 66,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432503750,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441624037",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441639243"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441639243"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Why not test the debug log output as well\r\n\r\nI'd prefer not to do this. My view is that functional tests should be as black box as possible, and test the functionality rather than the implementation. Using the debug log to test that an event has happened should be used only when there's no other way to test, since doing so binds the test to the exact implementation, and any changes to control flow or logging in the product mean that the tests need to be updated.\r\n\r\n> use assert_equal\r\n\r\n:+1: ",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T15:34:41Z",
      "diff_hunk" : "@@ -42,13 +43,30 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers\")\n+        conn = self.nodes[0].add_p2p_connection(P2PDataStore())\n+        # Create valid message\n+        msg = conn.build_message(msg_ping(nonce=12345))\n+        cut_pos = 12    # Chosen at an arbitrary position within the header\n+        # Send message in two pieces\n+        before = self.nodes[0].getnettotals()['totalbytesrecv']\n+        conn.send_raw_message(msg[:cut_pos])\n+        middle = self.nodes[0].getnettotals()['totalbytesrecv']\n+        # If this assert fails, we've hit an unlikely race\n+        # where the test framework sent a message in between the two halves\n+        assert middle == before + cut_pos",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441639243",
      "id" : 441639243,
      "in_reply_to_id" : 441621704,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYzOTI0Mw==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 66,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432526952,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441639243",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441640185"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441640185"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If #19272 if merged first, these changes in `test_large_inv()` won't be needed.",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T15:36:04Z",
      "diff_hunk" : "@@ -95,13 +113,13 @@ def test_msgtype(self):\n \n     def test_large_inv(self):\n         conn = self.nodes[0].add_p2p_connection(P2PInterface())\n-        with self.nodes[0].assert_debug_log(['Misbehaving', 'peer=4 (0 -> 20): message inv size() = 50001']):\n+        with self.nodes[0].assert_debug_log(['Misbehaving', '(0 -> 20): message inv size() = 50001']):\n             msg = msg_inv([CInv(MSG_TX, 1)] * 50001)\n             conn.send_and_ping(msg)\n-        with self.nodes[0].assert_debug_log(['Misbehaving', 'peer=4 (20 -> 40): message getdata size() = 50001']):\n+        with self.nodes[0].assert_debug_log(['Misbehaving', '(20 -> 40): message getdata size() = 50001']):\n             msg = msg_getdata([CInv(MSG_TX, 1)] * 50001)\n             conn.send_and_ping(msg)\n-        with self.nodes[0].assert_debug_log(['Misbehaving', 'peer=4 (40 -> 60): headers message size = 2001']):\n+        with self.nodes[0].assert_debug_log(['Misbehaving', '(40 -> 60): headers message size = 2001']):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441640185",
      "id" : 441640185,
      "line" : 130,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY0MDE4NQ==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 130,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : 73,
      "pull_request_review_id" : 432528258,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441640185",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441640309"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441640309"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "We don't currently log that an incomplete header was received.  IMO we shouldn't, it's just an implementation detail of sockets, it doesn't really mean anything on any Bitcoin level.  At the very least maybe changing bitcoind logging is out of scope for this PR?",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T15:36:15Z",
      "diff_hunk" : "@@ -42,13 +43,30 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441640309",
      "id" : 441640309,
      "in_reply_to_id" : 441623383,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY0MDMwOQ==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 59,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432528431,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441640309",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441640372"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441640372"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "See below",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T15:36:21Z",
      "diff_hunk" : "@@ -42,13 +43,30 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers\")\n+        conn = self.nodes[0].add_p2p_connection(P2PDataStore())\n+        # Create valid message\n+        msg = conn.build_message(msg_ping(nonce=12345))\n+        cut_pos = 12    # Chosen at an arbitrary position within the header\n+        # Send message in two pieces\n+        before = self.nodes[0].getnettotals()['totalbytesrecv']\n+        conn.send_raw_message(msg[:cut_pos])\n+        middle = self.nodes[0].getnettotals()['totalbytesrecv']\n+        # If this assert fails, we've hit an unlikely race\n+        # where the test framework sent a message in between the two halves\n+        assert middle == before + cut_pos",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441640372",
      "id" : 441640372,
      "in_reply_to_id" : 441621704,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY0MDM3Mg==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 66,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432528518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441640372",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441641495"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441641495"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Please join this with the import from `test_framework.messages` above.",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T15:38:03Z",
      "diff_hunk" : "@@ -17,6 +17,7 @@\n     P2PInterface,\n )\n from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import msg_ping",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441641495",
      "id" : 441641495,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY0MTQ5NQ==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 20,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432530048,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441641495",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441641575"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441641575"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "+1, I'm more than happy to rebase this one if #19272 goes in first",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T15:38:10Z",
      "diff_hunk" : "@@ -95,13 +113,13 @@ def test_msgtype(self):\n \n     def test_large_inv(self):\n         conn = self.nodes[0].add_p2p_connection(P2PInterface())\n-        with self.nodes[0].assert_debug_log(['Misbehaving', 'peer=4 (0 -> 20): message inv size() = 50001']):\n+        with self.nodes[0].assert_debug_log(['Misbehaving', '(0 -> 20): message inv size() = 50001']):\n             msg = msg_inv([CInv(MSG_TX, 1)] * 50001)\n             conn.send_and_ping(msg)\n-        with self.nodes[0].assert_debug_log(['Misbehaving', 'peer=4 (20 -> 40): message getdata size() = 50001']):\n+        with self.nodes[0].assert_debug_log(['Misbehaving', '(20 -> 40): message getdata size() = 50001']):\n             msg = msg_getdata([CInv(MSG_TX, 1)] * 50001)\n             conn.send_and_ping(msg)\n-        with self.nodes[0].assert_debug_log(['Misbehaving', 'peer=4 (40 -> 60): headers message size = 2001']):\n+        with self.nodes[0].assert_debug_log(['Misbehaving', '(40 -> 60): headers message size = 2001']):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441641575",
      "id" : 441641575,
      "in_reply_to_id" : 441640185,
      "line" : 130,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY0MTU3NQ==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 130,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : 73,
      "pull_request_review_id" : 432530153,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441641575",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441643412"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441643412"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I suggest you disconnect the connection at the end of this subtest, so that the node and test fixture are the same state at the end of each subtest as at the start.\r\n\r\nIdeally, it should be possible to permute subtests in any order and have the test pass. That prevents brittleness like the asserts on peer numbers that you've had to change in an unrelated subtest here.",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T15:40:58Z",
      "diff_hunk" : "@@ -42,13 +43,30 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers\")\n+        conn = self.nodes[0].add_p2p_connection(P2PDataStore())\n+        # Create valid message\n+        msg = conn.build_message(msg_ping(nonce=12345))\n+        cut_pos = 12    # Chosen at an arbitrary position within the header\n+        # Send message in two pieces\n+        before = self.nodes[0].getnettotals()['totalbytesrecv']\n+        conn.send_raw_message(msg[:cut_pos])\n+        middle = self.nodes[0].getnettotals()['totalbytesrecv']\n+        # If this assert fails, we've hit an unlikely race\n+        # where the test framework sent a message in between the two halves\n+        assert middle == before + cut_pos\n+        conn.send_raw_message(msg[cut_pos:])\n+        conn.sync_with_ping(timeout=1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441643412",
      "id" : 441643412,
      "line" : 75,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY0MzQxMg==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 75,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : 54,
      "pull_request_review_id" : 432530048,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441643412",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK. Thanks for adding the test, will test after assert_equal nit is addressed",
      "created_at" : "2020-06-17T15:41:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#issuecomment-645453492",
      "id" : 645453492,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19304",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NTQ1MzQ5Mg==",
      "updated_at" : "2020-06-17T15:41:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/645453492",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441645507"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441645507"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In https://github.com/bitcoin/bitcoin/pull/19302#discussion_r441521857 you added `LogPrintf(\"Incomplete header\");`\r\n\r\n",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T15:43:59Z",
      "diff_hunk" : "@@ -42,13 +43,30 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441645507",
      "id" : 441645507,
      "in_reply_to_id" : 441623383,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY0NTUwNw==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 59,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432535295,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441645507",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441645591"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441645591"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@jonatack are you sure? I don't see anywhere in the product code that logs \"Incomplete headerReceived\" (and would be surprised to, since this is purely an implementation detail)",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T15:44:06Z",
      "diff_hunk" : "@@ -42,13 +43,30 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441645591",
      "id" : 441645591,
      "in_reply_to_id" : 441623383,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY0NTU5MQ==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 59,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432535406,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441645591",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441645947"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441645947"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> \r\n> \r\n> The idea is to mention the expected result. The rest was an example, success, failure, disconnects peer, etc.\r\n\r\nAh I agree, I'll make this a bit more descriptive",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T15:44:40Z",
      "diff_hunk" : "@@ -42,13 +43,30 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441645947",
      "id" : 441645947,
      "in_reply_to_id" : 441623383,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY0NTk0Nw==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 59,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432535884,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441645947",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441657274"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441657274"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oh right, if it's just sockets then agreed.",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T16:01:37Z",
      "diff_hunk" : "@@ -42,13 +43,30 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers\")\n+        conn = self.nodes[0].add_p2p_connection(P2PDataStore())\n+        # Create valid message\n+        msg = conn.build_message(msg_ping(nonce=12345))\n+        cut_pos = 12    # Chosen at an arbitrary position within the header\n+        # Send message in two pieces\n+        before = self.nodes[0].getnettotals()['totalbytesrecv']\n+        conn.send_raw_message(msg[:cut_pos])\n+        middle = self.nodes[0].getnettotals()['totalbytesrecv']\n+        # If this assert fails, we've hit an unlikely race\n+        # where the test framework sent a message in between the two halves\n+        assert middle == before + cut_pos",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441657274",
      "id" : 441657274,
      "in_reply_to_id" : 441621704,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY1NzI3NA==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 66,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432550163,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441657274",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441661988"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441661988"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> @jonatack are you sure? I don't see anywhere in the product code that logs \"Incomplete headerReceived\" (and would be surprised to, since this is purely an implementation detail)\r\n\r\nWeird. I think it was a non-consistent result. Sorry about that.",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T16:09:17Z",
      "diff_hunk" : "@@ -42,13 +43,30 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441661988",
      "id" : 441661988,
      "in_reply_to_id" : 441623383,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY2MTk4OA==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 59,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432556200,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441661988",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Compare c5904c82e05cb4f5856cc55877f9fa268a9cd031 to 3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1.  Changed to assert_equal and made log more descriptive.  Disconnects peer at the end of the test, I'll keep that discussion in #19272 and I'll follow the status quo here.\r\n\r\nHad to add a short sleep, as I was finding my RPC call occationally went before the first half of the message was received by the node.",
      "created_at" : "2020-06-17T16:13:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#issuecomment-645470937",
      "id" : 645470937,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19304",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NTQ3MDkzNw==",
      "updated_at" : "2020-06-17T16:13:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/645470937",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441670483"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441670483"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> In [#19302 (comment)](https://github.com/bitcoin/bitcoin/pull/19302#discussion_r441521857) you added `LogPrintf(\"Incomplete header\");`\r\n\r\nHm, it's possible I didn't rebuild properly. It's late here :) will finish review of your net headers refactoring tomorrow fresh and early",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T16:23:21Z",
      "diff_hunk" : "@@ -42,13 +43,30 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441670483",
      "id" : 441670483,
      "in_reply_to_id" : 441623383,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY3MDQ4Mw==",
      "original_commit_id" : "c5904c82e05cb4f5856cc55877f9fa268a9cd031",
      "original_line" : 59,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432567237,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441670483",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441690648"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441690648"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think a sleep will consistently avoid races. Any reason why a `sync_with_ping` (on a different connection) or a `wait_until` is not working?",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T16:55:55Z",
      "diff_hunk" : "@@ -42,13 +47,32 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers, should be received\")\n+        conn = self.nodes[0].add_p2p_connection(P2PDataStore())\n+        # Create valid message\n+        msg = conn.build_message(msg_ping(nonce=12345))\n+        cut_pos = 12    # Chosen at an arbitrary position within the header\n+        # Send message in two pieces\n+        before = int(self.nodes[0].getnettotals()['totalbytesrecv'])\n+        conn.send_raw_message(msg[:cut_pos])\n+        time.sleep(0.01) # Prevent the RPC call from going too early",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441690648",
      "id" : 441690648,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTY5MDY0OA==",
      "original_commit_id" : "3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1",
      "original_line" : 67,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432594507,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441690648",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441720939"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441720939"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think `getnettotals` returns information about all peers, so `sync_with_ping` would affect `totalbytesrecv` right? You could take that into account too, something like:\r\n\r\n```py\r\npinger = node.add_p2p_connection()\r\n...\r\nconn.send_raw_message(msg[:cut_pos])\r\npinger.sync_with_ping()\r\n...\r\nassert_equal(middle, before + cut_pos + PING_SIZE)\r\n```\r\nI don't think this guarantees that `conn`'s message has been processed just because `pinger`'s ping has been though...?",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T17:47:08Z",
      "diff_hunk" : "@@ -42,13 +47,32 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers, should be received\")\n+        conn = self.nodes[0].add_p2p_connection(P2PDataStore())\n+        # Create valid message\n+        msg = conn.build_message(msg_ping(nonce=12345))\n+        cut_pos = 12    # Chosen at an arbitrary position within the header\n+        # Send message in two pieces\n+        before = int(self.nodes[0].getnettotals()['totalbytesrecv'])\n+        conn.send_raw_message(msg[:cut_pos])\n+        time.sleep(0.01) # Prevent the RPC call from going too early",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441720939",
      "id" : 441720939,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyMDkzOQ==",
      "original_commit_id" : "3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1",
      "original_line" : 67,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432634262,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441720939",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/gzhao408/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gzhao408/followers",
         "following_url" : "https://api.github.com/users/gzhao408/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gzhao408/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gzhao408",
         "id" : 25183001,
         "login" : "gzhao408",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/gzhao408/orgs",
         "received_events_url" : "https://api.github.com/users/gzhao408/received_events",
         "repos_url" : "https://api.github.com/users/gzhao408/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gzhao408/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gzhao408/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gzhao408"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441723603"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441723603"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Do you want to make an assertion about `totalbytesrecv` here too? Or is it unnecessary?\r\nAlso, I know this just tests that the 2 halves are received so this might be out of scope, but do you expect a `pong` in return? Could be tested using `conn.message_count`?",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T17:51:44Z",
      "diff_hunk" : "@@ -42,13 +47,32 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers, should be received\")\n+        conn = self.nodes[0].add_p2p_connection(P2PDataStore())\n+        # Create valid message\n+        msg = conn.build_message(msg_ping(nonce=12345))\n+        cut_pos = 12    # Chosen at an arbitrary position within the header\n+        # Send message in two pieces\n+        before = int(self.nodes[0].getnettotals()['totalbytesrecv'])\n+        conn.send_raw_message(msg[:cut_pos])\n+        time.sleep(0.01) # Prevent the RPC call from going too early\n+        middle = int(self.nodes[0].getnettotals()['totalbytesrecv'])\n+        # If this assert fails, we've hit an unlikely race\n+        # where the test framework sent a message in between the two halves\n+        assert_equal(middle, before + cut_pos)\n+        conn.send_raw_message(msg[cut_pos:])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441723603",
      "id" : 441723603,
      "line" : 74,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyMzYwMw==",
      "original_commit_id" : "3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1",
      "original_line" : 74,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : 53,
      "pull_request_review_id" : 432634262,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441723603",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/gzhao408/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gzhao408/followers",
         "following_url" : "https://api.github.com/users/gzhao408/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gzhao408/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gzhao408",
         "id" : 25183001,
         "login" : "gzhao408",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/gzhao408/orgs",
         "received_events_url" : "https://api.github.com/users/gzhao408/received_events",
         "repos_url" : "https://api.github.com/users/gzhao408/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gzhao408/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gzhao408/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gzhao408"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441729612"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441729612"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Actually, I think `wait_until` might be better:\r\n```suggestion\r\n       wait_until(lambda: self.nodes[0].getnettotals()['totalbytesrecv'] == before + cut_pos)\r\n```\r\nWishful thinking, it'd be nice if `cut_pos` is a size that couldn't possibly be = another message (does this exist?). It will still fail if the node receives another message in between the halves, but can't pass if it isn't received.",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T18:01:18Z",
      "diff_hunk" : "@@ -42,13 +47,32 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers, should be received\")\n+        conn = self.nodes[0].add_p2p_connection(P2PDataStore())\n+        # Create valid message\n+        msg = conn.build_message(msg_ping(nonce=12345))\n+        cut_pos = 12    # Chosen at an arbitrary position within the header\n+        # Send message in two pieces\n+        before = int(self.nodes[0].getnettotals()['totalbytesrecv'])\n+        conn.send_raw_message(msg[:cut_pos])\n+        time.sleep(0.01) # Prevent the RPC call from going too early",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441729612",
      "id" : 441729612,
      "in_reply_to_id" : 441720939,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyOTYxMg==",
      "original_commit_id" : "3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1",
      "original_line" : 67,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432634262,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441729612",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/gzhao408/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gzhao408/followers",
         "following_url" : "https://api.github.com/users/gzhao408/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gzhao408/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gzhao408",
         "id" : 25183001,
         "login" : "gzhao408",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/gzhao408/orgs",
         "received_events_url" : "https://api.github.com/users/gzhao408/received_events",
         "repos_url" : "https://api.github.com/users/gzhao408/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gzhao408/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gzhao408/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gzhao408"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441746483"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441746483"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ok, I like `wait_until` better.  More expressive at the very least.  How do you like this?\r\n```suggestion\r\n        # Prevent the RPC call from going too early\r\n        conn.wait_util(int(self.nodes[0].getnettotals()['totalbytesrecv']) != before)\r\n```",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T18:31:36Z",
      "diff_hunk" : "@@ -42,13 +47,32 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers, should be received\")\n+        conn = self.nodes[0].add_p2p_connection(P2PDataStore())\n+        # Create valid message\n+        msg = conn.build_message(msg_ping(nonce=12345))\n+        cut_pos = 12    # Chosen at an arbitrary position within the header\n+        # Send message in two pieces\n+        before = int(self.nodes[0].getnettotals()['totalbytesrecv'])\n+        conn.send_raw_message(msg[:cut_pos])\n+        time.sleep(0.01) # Prevent the RPC call from going too early",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441746483",
      "id" : 441746483,
      "in_reply_to_id" : 441690648,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0NjQ4Mw==",
      "original_commit_id" : "3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1",
      "original_line" : 67,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432667616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441746483",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441747548"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441747548"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should be fine. In case it fails the `assert_equal(middle, before + cut_pos)` should trigger",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T18:33:36Z",
      "diff_hunk" : "@@ -42,13 +47,32 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers, should be received\")\n+        conn = self.nodes[0].add_p2p_connection(P2PDataStore())\n+        # Create valid message\n+        msg = conn.build_message(msg_ping(nonce=12345))\n+        cut_pos = 12    # Chosen at an arbitrary position within the header\n+        # Send message in two pieces\n+        before = int(self.nodes[0].getnettotals()['totalbytesrecv'])\n+        conn.send_raw_message(msg[:cut_pos])\n+        time.sleep(0.01) # Prevent the RPC call from going too early",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441747548",
      "id" : 441747548,
      "in_reply_to_id" : 441690648,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0NzU0OA==",
      "original_commit_id" : "3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1",
      "original_line" : 67,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432669038,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441747548",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441755606"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441755606"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah we came up with almost the same thing!  I thought of this https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441746483.  Regarding `cut_pos`, we actually have what you're looking for.  `cut_pos = 12` and the size of the smallest message (any of the messages with no payload) is 24 ð \r\n\r\nI'll think about `getpeerinfo` vs `getnettotals`",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T18:47:45Z",
      "diff_hunk" : "@@ -42,13 +47,32 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers, should be received\")\n+        conn = self.nodes[0].add_p2p_connection(P2PDataStore())\n+        # Create valid message\n+        msg = conn.build_message(msg_ping(nonce=12345))\n+        cut_pos = 12    # Chosen at an arbitrary position within the header\n+        # Send message in two pieces\n+        before = int(self.nodes[0].getnettotals()['totalbytesrecv'])\n+        conn.send_raw_message(msg[:cut_pos])\n+        time.sleep(0.01) # Prevent the RPC call from going too early",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441755606",
      "id" : 441755606,
      "in_reply_to_id" : 441720939,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc1NTYwNg==",
      "original_commit_id" : "3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1",
      "original_line" : 67,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432681527,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441755606",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441758738"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441758738"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "We do expect a `pong` in return, but it doesn't really matter in this test.  I've just chosen `ping` because it's really simple, any valid message would have worked.",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T18:50:43Z",
      "diff_hunk" : "@@ -42,13 +47,32 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers, should be received\")\n+        conn = self.nodes[0].add_p2p_connection(P2PDataStore())\n+        # Create valid message\n+        msg = conn.build_message(msg_ping(nonce=12345))\n+        cut_pos = 12    # Chosen at an arbitrary position within the header\n+        # Send message in two pieces\n+        before = int(self.nodes[0].getnettotals()['totalbytesrecv'])\n+        conn.send_raw_message(msg[:cut_pos])\n+        time.sleep(0.01) # Prevent the RPC call from going too early\n+        middle = int(self.nodes[0].getnettotals()['totalbytesrecv'])\n+        # If this assert fails, we've hit an unlikely race\n+        # where the test framework sent a message in between the two halves\n+        assert_equal(middle, before + cut_pos)\n+        conn.send_raw_message(msg[cut_pos:])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441758738",
      "id" : 441758738,
      "in_reply_to_id" : 441723603,
      "line" : 74,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc1ODczOA==",
      "original_commit_id" : "3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1",
      "original_line" : 74,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : 53,
      "pull_request_review_id" : 432683684,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441758738",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441761870"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441761870"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : ">I don't think this guarantees that conn's message has been processed just because pinger's ping has been though...?\r\n\r\nI'm pretty sure you're right.  However, we're looking at a race in a test for a race inside a test at this point, so I'm going to prefer the simpler fix.",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T18:53:35Z",
      "diff_hunk" : "@@ -42,13 +47,32 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers, should be received\")\n+        conn = self.nodes[0].add_p2p_connection(P2PDataStore())\n+        # Create valid message\n+        msg = conn.build_message(msg_ping(nonce=12345))\n+        cut_pos = 12    # Chosen at an arbitrary position within the header\n+        # Send message in two pieces\n+        before = int(self.nodes[0].getnettotals()['totalbytesrecv'])\n+        conn.send_raw_message(msg[:cut_pos])\n+        time.sleep(0.01) # Prevent the RPC call from going too early",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441761870",
      "id" : 441761870,
      "in_reply_to_id" : 441720939,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc2MTg3MA==",
      "original_commit_id" : "3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1",
      "original_line" : 67,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432685762,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441761870",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441764282"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441764282"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "TWINSIES ð¯ \r\n(If I may, I think `== before + cut_pos` is stronger than  `>= before` or `!= before`)\r\n> we actually have what you're looking for\r\n\r\nOoh!! Genius, should be in the comment.",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T18:55:58Z",
      "diff_hunk" : "@@ -42,13 +47,32 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers, should be received\")\n+        conn = self.nodes[0].add_p2p_connection(P2PDataStore())\n+        # Create valid message\n+        msg = conn.build_message(msg_ping(nonce=12345))\n+        cut_pos = 12    # Chosen at an arbitrary position within the header\n+        # Send message in two pieces\n+        before = int(self.nodes[0].getnettotals()['totalbytesrecv'])\n+        conn.send_raw_message(msg[:cut_pos])\n+        time.sleep(0.01) # Prevent the RPC call from going too early",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441764282",
      "id" : 441764282,
      "in_reply_to_id" : 441720939,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc2NDI4Mg==",
      "original_commit_id" : "3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1",
      "original_line" : 67,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432687395,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441764282",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/gzhao408/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gzhao408/followers",
         "following_url" : "https://api.github.com/users/gzhao408/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gzhao408/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gzhao408",
         "id" : 25183001,
         "login" : "gzhao408",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/gzhao408/orgs",
         "received_events_url" : "https://api.github.com/users/gzhao408/received_events",
         "repos_url" : "https://api.github.com/users/gzhao408/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gzhao408/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gzhao408/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gzhao408"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441771871"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441771871"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`== before + cut_pos` is stronger, but I see three possible situations that I would rather be caught by different asserts.  This is possible with `!=` and the later `assert_equal`\r\n\r\n1. Something terrible happens and the first half of the message is never processed.  `wait_until` times out and throws an exception.\r\n2. The node takes a while but eventually processes the first half of the message (and only that).  `wait_until` tries `getnettotals` a few times and then we continue past, and the test passes.\r\n3.  The race occurs and the node processes more than just the first half of the message.  The `assert_equals` fails and we see the exception there.\r\n\r\nChoosing `== before + cut_pos` or `>= before` could make both 1. and 3. fail on the `wait_until`, which is just a little harder to debug.",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T19:06:50Z",
      "diff_hunk" : "@@ -42,13 +47,32 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers, should be received\")\n+        conn = self.nodes[0].add_p2p_connection(P2PDataStore())\n+        # Create valid message\n+        msg = conn.build_message(msg_ping(nonce=12345))\n+        cut_pos = 12    # Chosen at an arbitrary position within the header\n+        # Send message in two pieces\n+        before = int(self.nodes[0].getnettotals()['totalbytesrecv'])\n+        conn.send_raw_message(msg[:cut_pos])\n+        time.sleep(0.01) # Prevent the RPC call from going too early",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441771871",
      "id" : 441771871,
      "in_reply_to_id" : 441720939,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc3MTg3MQ==",
      "original_commit_id" : "3cd538a1a6c64c8ab4b6f02be72f45d2c865b9f1",
      "original_line" : 67,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432694778,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441771871",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441779231"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441779231"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n```",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T19:21:06Z",
      "diff_hunk" : "@@ -3,12 +3,16 @@\n # Distributed under the MIT software license, see the accompanying\n # file COPYING or http://www.opensource.org/licenses/mit-license.php.\n \"\"\"Test node responses to invalid network messages.\"\"\"\n+\n+import time",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441779231",
      "id" : 441779231,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc3OTIzMQ==",
      "original_commit_id" : "cac346ce9f5f4c4ace19796e055ced2082f3b3ed",
      "original_line" : 7,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432704493,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441779231",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Implemented `wait_until` as discussed.",
      "created_at" : "2020-06-17T19:21:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#issuecomment-645572880",
      "id" : 645572880,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19304",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NTU3Mjg4MA==",
      "updated_at" : "2020-06-17T19:21:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/645572880",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441779924"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441779924"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "MarcoFalke = faster than linter",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T19:22:22Z",
      "diff_hunk" : "@@ -3,12 +3,16 @@\n # Distributed under the MIT software license, see the accompanying\n # file COPYING or http://www.opensource.org/licenses/mit-license.php.\n \"\"\"Test node responses to invalid network messages.\"\"\"\n+\n+import time",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441779924",
      "id" : 441779924,
      "in_reply_to_id" : 441779231,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc3OTkyNA==",
      "original_commit_id" : "cac346ce9f5f4c4ace19796e055ced2082f3b3ed",
      "original_line" : 7,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432705403,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441779924",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/gzhao408/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gzhao408/followers",
         "following_url" : "https://api.github.com/users/gzhao408/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gzhao408/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gzhao408",
         "id" : 25183001,
         "login" : "gzhao408",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/gzhao408/orgs",
         "received_events_url" : "https://api.github.com/users/gzhao408/received_events",
         "repos_url" : "https://api.github.com/users/gzhao408/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gzhao408/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gzhao408/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gzhao408"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441780225"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441780225"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "_glares at pylint_\r\n\r\nthx",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T19:22:54Z",
      "diff_hunk" : "@@ -3,12 +3,16 @@\n # Distributed under the MIT software license, see the accompanying\n # file COPYING or http://www.opensource.org/licenses/mit-license.php.\n \"\"\"Test node responses to invalid network messages.\"\"\"\n+\n+import time",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441780225",
      "id" : 441780225,
      "in_reply_to_id" : 441779231,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4MDIyNQ==",
      "original_commit_id" : "cac346ce9f5f4c4ace19796e055ced2082f3b3ed",
      "original_line" : 7,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : null,
      "pull_request_review_id" : 432705795,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:23:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441780225",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "And removed unused import.",
      "created_at" : "2020-06-17T19:23:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#issuecomment-645573945",
      "id" : 645573945,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19304",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NTU3Mzk0NQ==",
      "updated_at" : "2020-06-17T19:23:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/645573945",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441782105"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441782105"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: extra newline here?\r\n```suggestion\r\n```",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T19:26:36Z",
      "diff_hunk" : "@@ -3,12 +3,14 @@\n # Distributed under the MIT software license, see the accompanying\n # file COPYING or http://www.opensource.org/licenses/mit-license.php.\n \"\"\"Test node responses to invalid network messages.\"\"\"\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441782105",
      "id" : 441782105,
      "line" : 6,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4MjEwNQ==",
      "original_commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "original_line" : 6,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : 4,
      "pull_request_review_id" : 432708255,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:51:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441782105",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/gzhao408/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gzhao408/followers",
         "following_url" : "https://api.github.com/users/gzhao408/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gzhao408/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gzhao408",
         "id" : 25183001,
         "login" : "gzhao408",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/gzhao408/orgs",
         "received_events_url" : "https://api.github.com/users/gzhao408/received_events",
         "repos_url" : "https://api.github.com/users/gzhao408/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gzhao408/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gzhao408/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gzhao408"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "tested ACK 80d4423f997e15780bfa3f91bf4b4bf656b8ea45 (added an assert(false) to observe deterministic coverage) ð¦\r\n\r\n<details><summary>Show signature and timestamp</summary>\r\n\r\nSignature:\r\n\r\n```\r\n-----BEGIN PGP SIGNED MESSAGE-----\r\nHash: SHA512\r\n\r\ntested ACK 80d4423f997e15780bfa3f91bf4b4bf656b8ea45 (added an assert(false) to observe deterministic coverage) ð¦\r\n-----BEGIN PGP SIGNATURE-----\r\n\r\niQGzBAEBCgAdFiEE+rVPoUahrI9sLGYTzit1aX5ppUgFAlwqrYAACgkQzit1aX5p\r\npUg1fgwAr3kntpEQs2aiIVSBgAO5mxLPeIy/CfdZirlGL0VYvHOPl2BvcIwBOSXt\r\n/mjQVNutfafKTcpxz5pvMMX934qEA0K49aX92hU2jt+q5q5zggMsBjd996Cwm6ww\r\nJ5+Zz3AJFWSU2CVHll0vHIjNolBBe+HnB5w8enUgdz8TPGf4mS1LWtS9uE36a0ja\r\nUor7i7wdN46jV+c35KXfH8gxVNyEirHlDAdDfQkHZpjdFBoMmEK4yML3PflEqkpy\r\nCVoKNfVr7ziGfjUDAG2JNl7wSDSJtomvBRcBsSwP0h0lPBONjv6JntoLSjeTHaY2\r\nwzx/mwB2lXx1QWw3E/VU/H1ivNiwcI5uIt8EdiVNhficdOUwhEgVGhI6TREpn8W1\r\nDgriZXSNI0v9SDhWM8fWV7MBR6XElZC5m31pM4aqknD5+4gftrZxUiI7Hg4t4tVC\r\nGz/G1FEAo2icWAgmodUbSp+ti87Y2HhPi+9rDdvuHgWG2BPFviGO55tbLta14tiO\r\nU7YBmVXz\r\n=QULl\r\n-----END PGP SIGNATURE-----\r\n```\r\n\r\n[Timestamp of file with hash `1e2f468bf771db8cdab09da071ec81ccf7eb4d5341ad83699ce0369e01a45610  -`](https://opentimestamps.org/info/?004f70656e54696d657374616d7073000050726f6f6600bf89e2e884e8929401081e2f468bf771db8cdab09da071ec81ccf7eb4d5341ad83699ce0369e01a45610f010500a465bb4170e8ab401c6db6df06d9008fff01041d41c50c5d56005737b78ba2e9a091008f1045eea6f15f0084149b21fb0ab95280083dfe30d2ef90c8e2e2d68747470733a2f2f616c6963652e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267fff010620ee4d1577822c3706d274bf2447c3708f0208cda61240ebc4bd138e43f9f516c8dbf92a3d4a889c3cc08e9de1ffff29f5ca608f1045eea6f15f008320c390edfe4a6060083dfe30d2ef90c8e232268747470733a2f2f6274632e63616c656e6461722e636174616c6c6178792e636f6dfff010c6cb32e1ec07bc5b0e183488502a513c08f1045eea6f15f00840169c4479b40af80083dfe30d2ef90c8e292868747470733a2f2f66696e6e65792e63616c656e6461722e657465726e69747977616c6c2e636f6df010f8b5fe8aa823030a561d356201c1dee808f0208285aef4fa8edaf406da147c328183a71994007014e1e0a9cdc7a0350b552f9c08f1045eea6f15f008df1675983c6a2b200083dfe30d2ef90c8e2c2b68747470733a2f2f626f622e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267)\r\n\r\n</details>\r\n",
      "created_at" : "2020-06-17T19:29:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#issuecomment-645576792",
      "id" : 645576792,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19304",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NTU3Njc5Mg==",
      "updated_at" : "2020-06-17T19:29:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/645576792",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441784071"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441784071"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: I think the fact that `cut_pos` < smallest message size is pretty smart and non-arbitrary :)\r\n```suggestion\r\n        cut_pos = 12    # Smaller than any other P2P message and thus easily distinguishable\r\n```",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T19:30:29Z",
      "diff_hunk" : "@@ -42,13 +48,33 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers, should be received\")\n+        conn = self.nodes[0].add_p2p_connection(P2PDataStore())\n+        # Create valid message\n+        msg = conn.build_message(msg_ping(nonce=12345))\n+        cut_pos = 12    # Chosen at an arbitrary position within the header",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441784071",
      "id" : 441784071,
      "line" : 64,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc4NDA3MQ==",
      "original_commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "original_line" : 64,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : 43,
      "pull_request_review_id" : 432708255,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:51:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441784071",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/gzhao408/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gzhao408/followers",
         "following_url" : "https://api.github.com/users/gzhao408/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gzhao408/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gzhao408",
         "id" : 25183001,
         "login" : "gzhao408",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/gzhao408/orgs",
         "received_events_url" : "https://api.github.com/users/gzhao408/received_events",
         "repos_url" : "https://api.github.com/users/gzhao408/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gzhao408/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gzhao408/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gzhao408"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441794356"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441794356"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> This sends a valid message.\r\n\r\nEr... I'm very sorry if I'm being a pain in the ass, but why is this in p2p_invalid_messages?",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T19:50:05Z",
      "diff_hunk" : "@@ -3,12 +3,14 @@\n # Distributed under the MIT software license, see the accompanying\n # file COPYING or http://www.opensource.org/licenses/mit-license.php.\n \"\"\"Test node responses to invalid network messages.\"\"\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441794356",
      "id" : 441794356,
      "line" : 5,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc5NDM1Ng==",
      "original_commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "original_line" : 5,
      "original_position" : 3,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : 3,
      "pull_request_review_id" : 432708255,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T19:51:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441794356",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/gzhao408/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gzhao408/followers",
         "following_url" : "https://api.github.com/users/gzhao408/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gzhao408/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gzhao408",
         "id" : 25183001,
         "login" : "gzhao408",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/gzhao408/orgs",
         "received_events_url" : "https://api.github.com/users/gzhao408/received_events",
         "repos_url" : "https://api.github.com/users/gzhao408/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gzhao408/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gzhao408/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gzhao408"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19272 (test: p2p_invalid_messages and test framework improvements by jonatack)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.<!--2502f1a698b3751726fa55edcda76cd3-->\n\n### Coverage\n\n| Coverage  | Change ([pull 19304](https://drahtbot.github.io/reports/coverage/bitcoin/bitcoin/19304/total.coverage/index.html), 181023380aeabcf62a25f7a546b465626c5be3d4) | Reference ([master](https://drahtbot.github.io/reports/coverage/bitcoin/bitcoin/master/total.coverage/index.html), 35ed88f187c9bc7eedc3a1cf12193e0fbf222057)   |\n|-----------|-------------------------|--------------------|\n| Lines     | +0.0249 %            | 90.7991 %        |\n| Functions | +0.0818 %            | 85.6072 %        |\n| Branches  | +0.0126 %            | 51.9831 %        |\n\n<sup>Updated at: 2020-06-17T20:17:17.128362.</sup>\n",
      "created_at" : "2020-06-17T20:17:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#issuecomment-645601508",
      "id" : 645601508,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19304",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NTYwMTUwOA==",
      "updated_at" : "2020-06-17T23:24:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/645601508",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441823785"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441823785"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> I'm very sorry if I'm being a pain in the ass, but why is this in p2p_invalid_messages?\r\n\r\nYou're not. Because we couldn't think of anywhere better to put it ð¤·ââï¸ ",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T20:45:31Z",
      "diff_hunk" : "@@ -3,12 +3,14 @@\n # Distributed under the MIT software license, see the accompanying\n # file COPYING or http://www.opensource.org/licenses/mit-license.php.\n \"\"\"Test node responses to invalid network messages.\"\"\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441823785",
      "id" : 441823785,
      "in_reply_to_id" : 441794356,
      "line" : 5,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgyMzc4NQ==",
      "original_commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "original_line" : 5,
      "original_position" : 3,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : 3,
      "pull_request_review_id" : 432762770,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T20:45:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441823785",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441845573"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441845573"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Using [PEP 257](https://www.python.org/dev/peps/pep-0257/#id17) as a basis, this could be argued either way.  I like this better, and it's consistent with the 7 or so other test files that I just checked.",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-17T21:30:22Z",
      "diff_hunk" : "@@ -3,12 +3,14 @@\n # Distributed under the MIT software license, see the accompanying\n # file COPYING or http://www.opensource.org/licenses/mit-license.php.\n \"\"\"Test node responses to invalid network messages.\"\"\"\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441845573",
      "id" : 441845573,
      "in_reply_to_id" : 441782105,
      "line" : 6,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg0NTU3Mw==",
      "original_commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "original_line" : 6,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : 4,
      "pull_request_review_id" : 432790863,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-17T21:32:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441845573",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK: good to have this code path tested deterministically!",
      "created_at" : "2020-06-17T21:45:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#issuecomment-645641849",
      "id" : 645641849,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19304",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NTY0MTg0OQ==",
      "updated_at" : "2020-06-17T21:45:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/645641849",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441977469"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441977469"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This would allow not changing `test_large_inv()`:\r\n```diff\r\n     def run_test(self):\r\n-        self.test_buffer()\r\n         self.test_magic_bytes()\r\n         self.test_checksum()\r\n         self.test_size()\r\n         self.test_msgtype()\r\n         self.test_large_inv()\r\n+        self.test_buffer()\r\n         self.test_resource_exhaustion()\r\n```",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-18T05:32:42Z",
      "diff_hunk" : "@@ -42,13 +48,33 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441977469",
      "id" : 441977469,
      "line" : 51,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk3NzQ2OQ==",
      "original_commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "original_line" : 51,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : 30,
      "pull_request_review_id" : 432952164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-18T05:32:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441977469",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441977803"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441977803"
         }
      },
      "author_association" : "MEMBER",
      "body" : ":+1: ",
      "commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "created_at" : "2020-06-18T05:33:59Z",
      "diff_hunk" : "@@ -42,13 +48,33 @@ def set_test_params(self):\n         self.setup_clean_chain = True\n \n     def run_test(self):\n+        self.test_buffer()\n         self.test_magic_bytes()\n         self.test_checksum()\n         self.test_size()\n         self.test_msgtype()\n         self.test_large_inv()\n         self.test_resource_exhaustion()\n \n+    def test_buffer(self):\n+        self.log.info(\"Test message with header split across two buffers, should be received\")\n+        conn = self.nodes[0].add_p2p_connection(P2PDataStore())\n+        # Create valid message\n+        msg = conn.build_message(msg_ping(nonce=12345))\n+        cut_pos = 12    # Chosen at an arbitrary position within the header",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#discussion_r441977803",
      "id" : 441977803,
      "in_reply_to_id" : 441784071,
      "line" : 64,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk3NzgwMw==",
      "original_commit_id" : "80d4423f997e15780bfa3f91bf4b4bf656b8ea45",
      "original_line" : 64,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_messages.py",
      "position" : 43,
      "pull_request_review_id" : 432952555,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19304",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-18T05:33:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441977803",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Going to merge this. I think it is more important to have this test than it is to find the exact right location for this test. I picked an invalid message in #19302 to accomodate the file name, but if it really turns out to be problematic, one could add a comment like `# This test can equivalently be done with an invalid or valid message, for simplicity it is done here with a valid message`",
      "created_at" : "2020-06-18T11:37:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19304#issuecomment-645960502",
      "id" : 645960502,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19304",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NTk2MDUwMg==",
      "updated_at" : "2020-06-18T11:37:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/645960502",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
