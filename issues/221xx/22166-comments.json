[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #13062 (Make script interpreter independent from storage type CScript by sipa)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-06-06T14:36:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#issuecomment-855409415",
      "id" : 855409415,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22166",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1NTQwOTQxNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-18T11:50:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/855409415",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r646907609"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/646907609"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 77466ae5c58b4a46e545d3d24521fa635f7b8fbe \"Taproot descriptor inference\"\r\n\r\nIt would be useful to explain in more detail why these conditions matter.\r\n\r\nIIUC, this happens because in the section above, if we have duplicate subtrees, we end up making the same side of the tree when we have duplicates which means that the normal tree handling part of this loop runs out of nodes to look at on the other side of the branch.\r\n\r\nHowever it is still not clear to me why `!node.sub[1]->sub[0]` is necessary.",
      "commit_id" : "77466ae5c58b4a46e545d3d24521fa635f7b8fbe",
      "created_at" : "2021-06-07T20:12:52Z",
      "diff_hunk" : "@@ -516,3 +516,120 @@ TaprootSpendData TaprootBuilder::GetSpendData() const\n     }\n     return spd;\n }\n+\n+std::optional<std::vector<std::tuple<int, CScript, int>>> InferTaprootTree(const TaprootSpendData& spenddata, const XOnlyPubKey& output)\n+{\n+    // Verify that the output matches the assumed Merkle root and internal key.\n+    auto tweak = spenddata.internal_key.CreateTapTweak(spenddata.merkle_root.IsNull() ? nullptr : &spenddata.merkle_root);\n+    if (!tweak || tweak->first != output) return std::nullopt;\n+    // If the Merkle root is 0, the tree is empty, and we're done.\n+    std::vector<std::tuple<int, CScript, int>> ret;\n+    if (spenddata.merkle_root.IsNull()) return ret;\n+\n+    /** Data structure to represent the nodes of the tree we're going to be build. */\n+    struct TreeNode {\n+        /** Hash of this none, if known; 0 otherwise. */\n+        uint256 hash;\n+        /** The left and right subtrees (note that their order is irrelevant). */\n+        std::unique_ptr<TreeNode> sub[2];\n+        /** If this is known to be a leaf node, a pointer to the (script, leaf_ver) pair.\n+         *  nullptr otherwise. */\n+        const std::pair<CScript, int>* leaf = nullptr;\n+        /** Whether or not we have produced output for this subtree. */\n+        bool done = false;\n+    };\n+\n+    // Build tree from the provides branches.\n+    TreeNode root;\n+    root.hash = spenddata.merkle_root;\n+    for (const auto& elem : spenddata.scripts) {\n+        const CScript& script = elem.first.first;\n+        int leaf_ver = elem.first.second;\n+        const std::vector<unsigned char>& control = elem.second;\n+        // Skip script records with nonsensical leaf version.\n+        if (leaf_ver < 0 || leaf_ver >= 0x100 || leaf_ver & 1) continue;\n+        // Skip script records with invalid control block sizes.\n+        if (control.size() < TAPROOT_CONTROL_BASE_SIZE || control.size() > TAPROOT_CONTROL_MAX_SIZE ||\n+            ((control.size() - TAPROOT_CONTROL_BASE_SIZE) % TAPROOT_CONTROL_NODE_SIZE) != 0) continue;\n+        // Skip script records that don't match the control block.\n+        if ((control[0] & TAPROOT_LEAF_MASK) != leaf_ver) continue;\n+        // Skip script records that don't match the provided Merkle root.\n+        const uint256 leaf_hash = ComputeTapleafHash(leaf_ver, script);\n+        const uint256 merkle_root = ComputeTaprootMerkleRoot(control, leaf_hash);\n+        if (merkle_root != spenddata.merkle_root) continue;\n+\n+        TreeNode* node = &root;\n+        size_t levels = (control.size() - TAPROOT_CONTROL_BASE_SIZE) / TAPROOT_CONTROL_NODE_SIZE;\n+        for (size_t depth = 0; depth < levels; ++depth) {\n+            // Can't descend into a node which we already know is a leaf.\n+            if (node->leaf) return std::nullopt;\n+\n+            // Extract partner hash from Merkle branch in control block.\n+            uint256 hash;\n+            std::copy(control.begin() + TAPROOT_CONTROL_BASE_SIZE + (levels - 1 - depth) * TAPROOT_CONTROL_NODE_SIZE,\n+                      control.begin() + TAPROOT_CONTROL_BASE_SIZE + (levels - depth) * TAPROOT_CONTROL_NODE_SIZE,\n+                      hash.begin());\n+\n+            if (node->sub[0]) {\n+                // Descend into the existing left or right branch.\n+                bool desc = false;\n+                for (int i = 0; i < 2; ++i) {\n+                    if (node->sub[i]->hash == hash || (node->sub[i]->hash.IsNull() && node->sub[1-i]->hash != hash)) {\n+                        node->sub[i]->hash = hash;\n+                        node = &*node->sub[1-i];\n+                        desc = true;\n+                        break;\n+                    }\n+                }\n+                if (!desc) return std::nullopt; // This probably requires a hash collision to hit.\n+            } else {\n+                // We're in an unexplored node. Create subtrees and descend.\n+                node->sub[0] = std::make_unique<TreeNode>();\n+                node->sub[1] = std::make_unique<TreeNode>();\n+                node->sub[1]->hash = hash;\n+                node = &*node->sub[0];\n+            }\n+        }\n+        // Cannot turn a known inner node into a leaf.\n+        if (node->sub[0]) return std::nullopt;\n+        node->leaf = &elem.first;\n+        node->hash = leaf_hash;\n+    }\n+\n+    // Recursive processing to turn the tree into flattened output. Use an explicit stack here to avoid\n+    // overflowing the call stack (the tree may be 128 levels deep).\n+    std::vector<TreeNode*> stack{&root};\n+    while (!stack.empty()) {\n+        TreeNode& node = *stack.back();\n+        if (node.leaf) {\n+            // Leaf node; produce output.\n+            ret.emplace_back(stack.size() - 1, node.leaf->first, node.leaf->second);\n+            node.done = true;\n+            stack.pop_back();\n+        } else if (!node.sub[0]) {\n+            // Unexplored node, which means the tree is incomplete.\n+            return std::nullopt;\n+        } else if (node.sub[0]->done && !node.sub[1]->done && !node.sub[1]->leaf && !node.sub[1]->sub[0] && !node.sub[1]->hash.IsNull() &&\n+                   (CHashWriter{HASHER_TAPBRANCH} << node.sub[1]->hash << node.sub[1]->hash).GetSHA256() == node.hash) {\n+            // Special case to deal with duplicate subtrees: after exploring the left subtree (which holds actual data),\n+            // iterate through it again, but mark the right (unexplored, but implicitly identical) subtree as finished,\n+            // so that we don't end up in an infinite loop.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r646907609",
      "id" : 646907609,
      "line" : 616,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NjkwNzYwOQ==",
      "original_commit_id" : "77466ae5c58b4a46e545d3d24521fa635f7b8fbe",
      "original_line" : 616,
      "original_position" : 101,
      "original_start_line" : 612,
      "path" : "src/script/standard.cpp",
      "position" : 184,
      "pull_request_review_id" : 677840299,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166",
      "side" : "RIGHT",
      "start_line" : 612,
      "start_side" : "RIGHT",
      "updated_at" : "2021-06-07T21:05:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/646907609",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r647029293"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/647029293"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Restructured things a bit by adding explicit \"explored\" and \"inner\" flags to the nodes. This avoids the need for testing the specifics of the unexplored child.\r\n\r\nAlso expanded the comment to explain this better.",
      "commit_id" : "f9d6f9a52c61833bbc5c611ff6a3e59066e1c92f",
      "created_at" : "2021-06-08T00:38:06Z",
      "diff_hunk" : "@@ -516,3 +516,120 @@ TaprootSpendData TaprootBuilder::GetSpendData() const\n     }\n     return spd;\n }\n+\n+std::optional<std::vector<std::tuple<int, CScript, int>>> InferTaprootTree(const TaprootSpendData& spenddata, const XOnlyPubKey& output)\n+{\n+    // Verify that the output matches the assumed Merkle root and internal key.\n+    auto tweak = spenddata.internal_key.CreateTapTweak(spenddata.merkle_root.IsNull() ? nullptr : &spenddata.merkle_root);\n+    if (!tweak || tweak->first != output) return std::nullopt;\n+    // If the Merkle root is 0, the tree is empty, and we're done.\n+    std::vector<std::tuple<int, CScript, int>> ret;\n+    if (spenddata.merkle_root.IsNull()) return ret;\n+\n+    /** Data structure to represent the nodes of the tree we're going to be build. */\n+    struct TreeNode {\n+        /** Hash of this none, if known; 0 otherwise. */\n+        uint256 hash;\n+        /** The left and right subtrees (note that their order is irrelevant). */\n+        std::unique_ptr<TreeNode> sub[2];\n+        /** If this is known to be a leaf node, a pointer to the (script, leaf_ver) pair.\n+         *  nullptr otherwise. */\n+        const std::pair<CScript, int>* leaf = nullptr;\n+        /** Whether or not we have produced output for this subtree. */\n+        bool done = false;\n+    };\n+\n+    // Build tree from the provides branches.\n+    TreeNode root;\n+    root.hash = spenddata.merkle_root;\n+    for (const auto& elem : spenddata.scripts) {\n+        const CScript& script = elem.first.first;\n+        int leaf_ver = elem.first.second;\n+        const std::vector<unsigned char>& control = elem.second;\n+        // Skip script records with nonsensical leaf version.\n+        if (leaf_ver < 0 || leaf_ver >= 0x100 || leaf_ver & 1) continue;\n+        // Skip script records with invalid control block sizes.\n+        if (control.size() < TAPROOT_CONTROL_BASE_SIZE || control.size() > TAPROOT_CONTROL_MAX_SIZE ||\n+            ((control.size() - TAPROOT_CONTROL_BASE_SIZE) % TAPROOT_CONTROL_NODE_SIZE) != 0) continue;\n+        // Skip script records that don't match the control block.\n+        if ((control[0] & TAPROOT_LEAF_MASK) != leaf_ver) continue;\n+        // Skip script records that don't match the provided Merkle root.\n+        const uint256 leaf_hash = ComputeTapleafHash(leaf_ver, script);\n+        const uint256 merkle_root = ComputeTaprootMerkleRoot(control, leaf_hash);\n+        if (merkle_root != spenddata.merkle_root) continue;\n+\n+        TreeNode* node = &root;\n+        size_t levels = (control.size() - TAPROOT_CONTROL_BASE_SIZE) / TAPROOT_CONTROL_NODE_SIZE;\n+        for (size_t depth = 0; depth < levels; ++depth) {\n+            // Can't descend into a node which we already know is a leaf.\n+            if (node->leaf) return std::nullopt;\n+\n+            // Extract partner hash from Merkle branch in control block.\n+            uint256 hash;\n+            std::copy(control.begin() + TAPROOT_CONTROL_BASE_SIZE + (levels - 1 - depth) * TAPROOT_CONTROL_NODE_SIZE,\n+                      control.begin() + TAPROOT_CONTROL_BASE_SIZE + (levels - depth) * TAPROOT_CONTROL_NODE_SIZE,\n+                      hash.begin());\n+\n+            if (node->sub[0]) {\n+                // Descend into the existing left or right branch.\n+                bool desc = false;\n+                for (int i = 0; i < 2; ++i) {\n+                    if (node->sub[i]->hash == hash || (node->sub[i]->hash.IsNull() && node->sub[1-i]->hash != hash)) {\n+                        node->sub[i]->hash = hash;\n+                        node = &*node->sub[1-i];\n+                        desc = true;\n+                        break;\n+                    }\n+                }\n+                if (!desc) return std::nullopt; // This probably requires a hash collision to hit.\n+            } else {\n+                // We're in an unexplored node. Create subtrees and descend.\n+                node->sub[0] = std::make_unique<TreeNode>();\n+                node->sub[1] = std::make_unique<TreeNode>();\n+                node->sub[1]->hash = hash;\n+                node = &*node->sub[0];\n+            }\n+        }\n+        // Cannot turn a known inner node into a leaf.\n+        if (node->sub[0]) return std::nullopt;\n+        node->leaf = &elem.first;\n+        node->hash = leaf_hash;\n+    }\n+\n+    // Recursive processing to turn the tree into flattened output. Use an explicit stack here to avoid\n+    // overflowing the call stack (the tree may be 128 levels deep).\n+    std::vector<TreeNode*> stack{&root};\n+    while (!stack.empty()) {\n+        TreeNode& node = *stack.back();\n+        if (node.leaf) {\n+            // Leaf node; produce output.\n+            ret.emplace_back(stack.size() - 1, node.leaf->first, node.leaf->second);\n+            node.done = true;\n+            stack.pop_back();\n+        } else if (!node.sub[0]) {\n+            // Unexplored node, which means the tree is incomplete.\n+            return std::nullopt;\n+        } else if (node.sub[0]->done && !node.sub[1]->done && !node.sub[1]->leaf && !node.sub[1]->sub[0] && !node.sub[1]->hash.IsNull() &&\n+                   (CHashWriter{HASHER_TAPBRANCH} << node.sub[1]->hash << node.sub[1]->hash).GetSHA256() == node.hash) {\n+            // Special case to deal with duplicate subtrees: after exploring the left subtree (which holds actual data),\n+            // iterate through it again, but mark the right (unexplored, but implicitly identical) subtree as finished,\n+            // so that we don't end up in an infinite loop.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r647029293",
      "id" : 647029293,
      "in_reply_to_id" : 646907609,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NzAyOTI5Mw==",
      "original_commit_id" : "77466ae5c58b4a46e545d3d24521fa635f7b8fbe",
      "original_line" : 616,
      "original_position" : 101,
      "original_start_line" : 612,
      "path" : "src/script/standard.cpp",
      "position" : null,
      "pull_request_review_id" : 677993161,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-06-08T00:38:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/647029293",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK f9d6f9a52c61833bbc5c611ff6a3e59066e1c92f",
      "created_at" : "2021-06-08T16:22:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#issuecomment-856912364",
      "id" : 856912364,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22166",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1NjkxMjM2NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-08T16:22:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/856912364",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Reviewed that the consensus commit (e3739fb3b042c3805b5b6357f6f79df787d11144) is a pure refactor.\r\n\r\nCode review ACK 13c6ab699eb6906c6554b4319a377c33fa0d157f",
      "created_at" : "2021-06-14T15:21:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#issuecomment-860771902",
      "id" : 860771902,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22166",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MDc3MTkwMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-15T11:26:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/860771902",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-ACK 13c6ab699eb6906c6554b4319a377c33fa0d157f",
      "created_at" : "2021-06-14T19:33:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#issuecomment-860939242",
      "id" : 860939242,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22166",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MDkzOTI0Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-14T19:33:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/860939242",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r651702477"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651702477"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I would have a slight preference to use constants here instead of hardcoding `0x02` (and `0x03` below) and `33`.",
      "commit_id" : "13c6ab699eb6906c6554b4319a377c33fa0d157f",
      "created_at" : "2021-06-15T11:35:08Z",
      "diff_hunk" : "@@ -1217,44 +1219,68 @@ std::unique_ptr<DescriptorImpl> ParseScript(uint32_t& key_exp_index, Span<const\n     return nullptr;\n }\n \n-std::unique_ptr<PubkeyProvider> InferPubkey(const CPubKey& pubkey, ParseScriptContext, const SigningProvider& provider)\n+std::unique_ptr<PubkeyProvider> InferPubkey(const CPubKey& pubkey, ParseScriptContext, const SigningProvider& provider, bool xonly = false)\n {\n-    std::unique_ptr<PubkeyProvider> key_provider = std::make_unique<ConstPubkeyProvider>(0, pubkey);\n+    std::unique_ptr<PubkeyProvider> key_provider = std::make_unique<ConstPubkeyProvider>(0, pubkey, xonly);\n     KeyOriginInfo info;\n     if (provider.GetKeyOrigin(pubkey.GetID(), info)) {\n         return std::make_unique<OriginPubkeyProvider>(0, std::move(info), std::move(key_provider));\n     }\n     return key_provider;\n }\n \n+std::unique_ptr<PubkeyProvider> InferXOnlyPubkey(const XOnlyPubKey& xkey, ParseScriptContext ctx, const SigningProvider& provider)\n+{\n+    unsigned char full_key[33] = {0x02};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r651702477",
      "id" : 651702477,
      "line" : 1234,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTcwMjQ3Nw==",
      "original_commit_id" : "13c6ab699eb6906c6554b4319a377c33fa0d157f",
      "original_line" : 1234,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/script/descriptor.cpp",
      "position" : 29,
      "pull_request_review_id" : 683888716,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-15T11:35:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651702477",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r651704018"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651704018"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It looks like the optional `xonly` argument to `InferPubkey` is never passed?",
      "commit_id" : "13c6ab699eb6906c6554b4319a377c33fa0d157f",
      "created_at" : "2021-06-15T11:37:29Z",
      "diff_hunk" : "@@ -1217,44 +1219,68 @@ std::unique_ptr<DescriptorImpl> ParseScript(uint32_t& key_exp_index, Span<const\n     return nullptr;\n }\n \n-std::unique_ptr<PubkeyProvider> InferPubkey(const CPubKey& pubkey, ParseScriptContext, const SigningProvider& provider)\n+std::unique_ptr<PubkeyProvider> InferPubkey(const CPubKey& pubkey, ParseScriptContext, const SigningProvider& provider, bool xonly = false)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r651704018",
      "id" : 651704018,
      "line" : 1222,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTcwNDAxOA==",
      "original_commit_id" : "13c6ab699eb6906c6554b4319a377c33fa0d157f",
      "original_line" : 1222,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/script/descriptor.cpp",
      "position" : 16,
      "pull_request_review_id" : 683890636,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-15T11:37:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651704018",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r651729225"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651729225"
         }
      },
      "author_association" : "MEMBER",
      "body" : "would be nice to add an assertion here with regard to `control.size()` before indexing into it (maybe same for `program`)",
      "commit_id" : "13c6ab699eb6906c6554b4319a377c33fa0d157f",
      "created_at" : "2021-06-15T12:13:27Z",
      "diff_hunk" : "@@ -1868,8 +1866,19 @@ static bool VerifyTaprootCommitment(const std::vector<unsigned char>& control, c\n         }\n         k = ss_branch.GetSHA256();\n     }\n+    return k;\n+}\n+\n+static bool VerifyTaprootCommitment(const std::vector<unsigned char>& control, const std::vector<unsigned char>& program, const uint256& tapleaf_hash)\n+{\n+    //! The internal pubkey (x-only, so no Y coordinate parity).\n+    const XOnlyPubKey p{uint256(std::vector<unsigned char>(control.begin() + 1, control.begin() + TAPROOT_CONTROL_BASE_SIZE))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r651729225",
      "id" : 651729225,
      "line" : 1875,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTcyOTIyNQ==",
      "original_commit_id" : "13c6ab699eb6906c6554b4319a377c33fa0d157f",
      "original_line" : 1875,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/script/interpreter.cpp",
      "position" : 33,
      "pull_request_review_id" : 683923913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-15T12:14:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651729225",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Reviewing tonight/tomorrow.",
      "created_at" : "2021-06-15T17:04:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#issuecomment-861673120",
      "id" : 861673120,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22166",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MTY3MzEyMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-15T17:04:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/861673120",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r652163469"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/652163469"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree with this, but prefer keeping it for a follow-up. There are several places where this is already done, and I'd like to introduce constants for it, as well as using them everywhere in the same PR - doing so here would be a distraction.",
      "commit_id" : "834935511c2c799c8cb2312d617dbed6336000c4",
      "created_at" : "2021-06-15T21:24:20Z",
      "diff_hunk" : "@@ -1217,44 +1219,68 @@ std::unique_ptr<DescriptorImpl> ParseScript(uint32_t& key_exp_index, Span<const\n     return nullptr;\n }\n \n-std::unique_ptr<PubkeyProvider> InferPubkey(const CPubKey& pubkey, ParseScriptContext, const SigningProvider& provider)\n+std::unique_ptr<PubkeyProvider> InferPubkey(const CPubKey& pubkey, ParseScriptContext, const SigningProvider& provider, bool xonly = false)\n {\n-    std::unique_ptr<PubkeyProvider> key_provider = std::make_unique<ConstPubkeyProvider>(0, pubkey);\n+    std::unique_ptr<PubkeyProvider> key_provider = std::make_unique<ConstPubkeyProvider>(0, pubkey, xonly);\n     KeyOriginInfo info;\n     if (provider.GetKeyOrigin(pubkey.GetID(), info)) {\n         return std::make_unique<OriginPubkeyProvider>(0, std::move(info), std::move(key_provider));\n     }\n     return key_provider;\n }\n \n+std::unique_ptr<PubkeyProvider> InferXOnlyPubkey(const XOnlyPubKey& xkey, ParseScriptContext ctx, const SigningProvider& provider)\n+{\n+    unsigned char full_key[33] = {0x02};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r652163469",
      "id" : 652163469,
      "in_reply_to_id" : 651702477,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MjE2MzQ2OQ==",
      "original_commit_id" : "13c6ab699eb6906c6554b4319a377c33fa0d157f",
      "original_line" : 1234,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/script/descriptor.cpp",
      "position" : null,
      "pull_request_review_id" : 684504137,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-15T21:24:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/652163469",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r652163550"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/652163550"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "834935511c2c799c8cb2312d617dbed6336000c4",
      "created_at" : "2021-06-15T21:24:27Z",
      "diff_hunk" : "@@ -1217,44 +1219,68 @@ std::unique_ptr<DescriptorImpl> ParseScript(uint32_t& key_exp_index, Span<const\n     return nullptr;\n }\n \n-std::unique_ptr<PubkeyProvider> InferPubkey(const CPubKey& pubkey, ParseScriptContext, const SigningProvider& provider)\n+std::unique_ptr<PubkeyProvider> InferPubkey(const CPubKey& pubkey, ParseScriptContext, const SigningProvider& provider, bool xonly = false)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r652163550",
      "id" : 652163550,
      "in_reply_to_id" : 651704018,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MjE2MzU1MA==",
      "original_commit_id" : "13c6ab699eb6906c6554b4319a377c33fa0d157f",
      "original_line" : 1222,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/script/descriptor.cpp",
      "position" : null,
      "pull_request_review_id" : 684504210,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-15T21:24:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/652163550",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r652182119"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/652182119"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "834935511c2c799c8cb2312d617dbed6336000c4",
      "created_at" : "2021-06-15T21:57:32Z",
      "diff_hunk" : "@@ -1868,8 +1866,19 @@ static bool VerifyTaprootCommitment(const std::vector<unsigned char>& control, c\n         }\n         k = ss_branch.GetSHA256();\n     }\n+    return k;\n+}\n+\n+static bool VerifyTaprootCommitment(const std::vector<unsigned char>& control, const std::vector<unsigned char>& program, const uint256& tapleaf_hash)\n+{\n+    //! The internal pubkey (x-only, so no Y coordinate parity).\n+    const XOnlyPubKey p{uint256(std::vector<unsigned char>(control.begin() + 1, control.begin() + TAPROOT_CONTROL_BASE_SIZE))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r652182119",
      "id" : 652182119,
      "in_reply_to_id" : 651729225,
      "line" : 1877,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MjE4MjExOQ==",
      "original_commit_id" : "13c6ab699eb6906c6554b4319a377c33fa0d157f",
      "original_line" : 1877,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/script/interpreter.cpp",
      "position" : 35,
      "pull_request_review_id" : 684527827,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-15T21:57:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/652182119",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Addressed some comments, and also made this observable change:\r\n\r\n```diff\r\n             if (permit_uncompressed || key.IsCompressed()) {\r\n                 CPubKey pubkey = key.GetPubKey();\r\n                 out.keys.emplace(pubkey.GetID(), key);\r\n-                return std::make_unique<ConstPubkeyProvider>(key_exp_index, pubkey);\r\n+                return std::make_unique<ConstPubkeyProvider>(key_exp_index, pubkey, ctx == ParseScriptContext::P2TR);\r\n             } else {\r\n```\r\n\r\nWhich will make descriptors with a provided private key inside `tr()` be interpreted as the equivalent xonly pubkey rather than the compressed or uncompressed one.",
      "created_at" : "2021-06-15T22:01:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#issuecomment-861865268",
      "id" : 861865268,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22166",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MTg2NTI2OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-15T22:01:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/861865268",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-ACK 834935511c2c799c8cb2312d617dbed6336000c4",
      "created_at" : "2021-06-16T16:53:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#issuecomment-862546343",
      "id" : 862546343,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22166",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MjU0NjM0Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-16T16:53:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/862546343",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "It's too hot here to review code, but I can confirm that this correctly infers my `tr(xpub...)` and `tr(xpub1, pk(xpub2))` descriptors (and surviving a roundtrip through `deriveaddresses`). Might be a good sanity check to try with a rebased #21329 too.",
      "created_at" : "2021-06-16T19:35:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#issuecomment-862658229",
      "id" : 862658229,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22166",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MjY1ODIyOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-16T19:35:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/862658229",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> It's too hot here to review code\r\n\r\nSame, I propose we postpone the feature freeze a bit. Not able to concentrate at the moment.",
      "created_at" : "2021-06-17T10:33:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#issuecomment-863127161",
      "id" : 863127161,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22166",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MzEyNzE2MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-17T10:33:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/863127161",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r653469576"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/653469576"
         }
      },
      "author_association" : "MEMBER",
      "body" : "70ff719c364999346495a2368760f6fbb5a6ca36: why would a script have more than one control block? I assume this only happens if an identical script appears in multiple branches? Can you expand the comment?",
      "commit_id" : "834935511c2c799c8cb2312d617dbed6336000c4",
      "created_at" : "2021-06-17T11:18:34Z",
      "diff_hunk" : "@@ -209,15 +210,38 @@ CScript GetScriptForRawPubKey(const CPubKey& pubkey);\n /** Generate a multisig script. */\n CScript GetScriptForMultisig(int nRequired, const std::vector<CPubKey>& keys);\n \n+struct TaprootSpendData\n+{\n+    /** The BIP341 internal key. */\n+    XOnlyPubKey internal_key;\n+    /** The Merkle root of the script tree (0 if no scripts). */\n+    uint256 merkle_root;\n+    /** Map from (script, leaf_version) to (sets of) control blocks. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r653469576",
      "id" : 653469576,
      "line" : 219,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MzQ2OTU3Ng==",
      "original_commit_id" : "70ff719c364999346495a2368760f6fbb5a6ca36",
      "original_line" : 219,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/script/standard.h",
      "position" : 18,
      "pull_request_review_id" : 686180622,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-17T13:37:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/653469576",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r653524666"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/653524666"
         }
      },
      "author_association" : "MEMBER",
      "body" : "70ff719c364999346495a2368760f6fbb5a6ca36 : maybe assert `IsComplete()`?",
      "commit_id" : "834935511c2c799c8cb2312d617dbed6336000c4",
      "created_at" : "2021-06-17T12:39:01Z",
      "diff_hunk" : "@@ -464,8 +490,33 @@ TaprootBuilder& TaprootBuilder::Finalize(const XOnlyPubKey& internal_key)\n     m_internal_key = internal_key;\n     auto ret = m_internal_key.CreateTapTweak(m_branch.size() == 0 ? nullptr : &m_branch[0]->hash);\n     assert(ret.has_value());\n-    std::tie(m_output_key, std::ignore) = *ret;\n+    std::tie(m_output_key, m_parity) = *ret;\n     return *this;\n }\n \n WitnessV1Taproot TaprootBuilder::GetOutput() { return WitnessV1Taproot{m_output_key}; }\n+\n+TaprootSpendData TaprootBuilder::GetSpendData() const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r653524666",
      "id" : 653524666,
      "line" : 499,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MzUyNDY2Ng==",
      "original_commit_id" : "70ff719c364999346495a2368760f6fbb5a6ca36",
      "original_line" : 499,
      "original_position" : 67,
      "original_start_line" : null,
      "path" : "src/script/standard.cpp",
      "position" : 67,
      "pull_request_review_id" : 686180622,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-17T13:37:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/653524666",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r653550686"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/653550686"
         }
      },
      "author_association" : "MEMBER",
      "body" : "834935511c2c799c8cb2312d617dbed6336000c4: rather than failing, could we return `raw()` (at least for `leaf_ver == TAPROOT_LEAF_TAPSCRIPT`)? That can wait for a followup though, since we can't have `tr()` descriptors with raw leaves in the wallet anyway atm, and `raw()` is still limited to the top level.",
      "commit_id" : "834935511c2c799c8cb2312d617dbed6336000c4",
      "created_at" : "2021-06-17T13:11:56Z",
      "diff_hunk" : "@@ -1282,6 +1306,40 @@ std::unique_ptr<DescriptorImpl> InferScript(const CScript& script, ParseScriptCo\n             if (sub) return std::make_unique<WSHDescriptor>(std::move(sub));\n         }\n     }\n+    if (txntype == TxoutType::WITNESS_V1_TAPROOT && ctx == ParseScriptContext::TOP) {\n+        // Extract x-only pubkey from output.\n+        XOnlyPubKey pubkey;\n+        std::copy(data[0].begin(), data[0].end(), pubkey.begin());\n+        // Request spending data.\n+        TaprootSpendData tap;\n+        if (provider.GetTaprootSpendData(pubkey, tap)) {\n+            // If found, convert it back to tree form.\n+            auto tree = InferTaprootTree(tap, pubkey);\n+            if (tree) {\n+                // If that works, try to infer subdescriptors for all leaves.\n+                bool ok = true;\n+                std::vector<std::unique_ptr<DescriptorImpl>> subscripts; //!< list of script subexpressions\n+                std::vector<int> depths; //!< depth in the tree of each subexpression (same length subscripts)\n+                for (const auto& [depth, script, leaf_ver] : *tree) {\n+                    std::unique_ptr<DescriptorImpl> subdesc;\n+                    if (leaf_ver == TAPROOT_LEAF_TAPSCRIPT) {\n+                        subdesc = InferScript(script, ParseScriptContext::P2TR, provider);\n+                    }\n+                    if (!subdesc) {\n+                        ok = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r653550686",
      "id" : 653550686,
      "line" : 1329,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MzU1MDY4Ng==",
      "original_commit_id" : "834935511c2c799c8cb2312d617dbed6336000c4",
      "original_line" : 1329,
      "original_position" : 132,
      "original_start_line" : null,
      "path" : "src/script/descriptor.cpp",
      "position" : 143,
      "pull_request_review_id" : 686180622,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-17T13:37:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/653550686",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-06-17T21:59:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#issuecomment-863590155",
      "id" : 863590155,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22166",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MzU5MDE1NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-17T21:59:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/863590155",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r654079583"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/654079583"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done in https://github.com/bitcoin/bitcoin/pull/22275.",
      "commit_id" : "9d1d0541829c19f6f109f66ae92aaaa0b4beb88a",
      "created_at" : "2021-06-18T01:18:55Z",
      "diff_hunk" : "@@ -464,8 +490,33 @@ TaprootBuilder& TaprootBuilder::Finalize(const XOnlyPubKey& internal_key)\n     m_internal_key = internal_key;\n     auto ret = m_internal_key.CreateTapTweak(m_branch.size() == 0 ? nullptr : &m_branch[0]->hash);\n     assert(ret.has_value());\n-    std::tie(m_output_key, std::ignore) = *ret;\n+    std::tie(m_output_key, m_parity) = *ret;\n     return *this;\n }\n \n WitnessV1Taproot TaprootBuilder::GetOutput() { return WitnessV1Taproot{m_output_key}; }\n+\n+TaprootSpendData TaprootBuilder::GetSpendData() const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r654079583",
      "id" : 654079583,
      "in_reply_to_id" : 653524666,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDA3OTU4Mw==",
      "original_commit_id" : "70ff719c364999346495a2368760f6fbb5a6ca36",
      "original_line" : 499,
      "original_position" : 67,
      "original_start_line" : null,
      "path" : "src/script/standard.cpp",
      "position" : null,
      "pull_request_review_id" : 686959048,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-18T01:18:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/654079583",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r654079643"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/654079643"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Doing so in https://github.com/bitcoin/bitcoin/pull/22275.",
      "commit_id" : "9d1d0541829c19f6f109f66ae92aaaa0b4beb88a",
      "created_at" : "2021-06-18T01:19:04Z",
      "diff_hunk" : "@@ -209,15 +210,38 @@ CScript GetScriptForRawPubKey(const CPubKey& pubkey);\n /** Generate a multisig script. */\n CScript GetScriptForMultisig(int nRequired, const std::vector<CPubKey>& keys);\n \n+struct TaprootSpendData\n+{\n+    /** The BIP341 internal key. */\n+    XOnlyPubKey internal_key;\n+    /** The Merkle root of the script tree (0 if no scripts). */\n+    uint256 merkle_root;\n+    /** Map from (script, leaf_version) to (sets of) control blocks. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r654079643",
      "id" : 654079643,
      "in_reply_to_id" : 653469576,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDA3OTY0Mw==",
      "original_commit_id" : "70ff719c364999346495a2368760f6fbb5a6ca36",
      "original_line" : 219,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/script/standard.h",
      "position" : null,
      "pull_request_review_id" : 686959122,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-18T01:19:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/654079643",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r654080186"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/654080186"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think that's exactly what this code does.",
      "commit_id" : "9d1d0541829c19f6f109f66ae92aaaa0b4beb88a",
      "created_at" : "2021-06-18T01:20:45Z",
      "diff_hunk" : "@@ -1282,6 +1306,40 @@ std::unique_ptr<DescriptorImpl> InferScript(const CScript& script, ParseScriptCo\n             if (sub) return std::make_unique<WSHDescriptor>(std::move(sub));\n         }\n     }\n+    if (txntype == TxoutType::WITNESS_V1_TAPROOT && ctx == ParseScriptContext::TOP) {\n+        // Extract x-only pubkey from output.\n+        XOnlyPubKey pubkey;\n+        std::copy(data[0].begin(), data[0].end(), pubkey.begin());\n+        // Request spending data.\n+        TaprootSpendData tap;\n+        if (provider.GetTaprootSpendData(pubkey, tap)) {\n+            // If found, convert it back to tree form.\n+            auto tree = InferTaprootTree(tap, pubkey);\n+            if (tree) {\n+                // If that works, try to infer subdescriptors for all leaves.\n+                bool ok = true;\n+                std::vector<std::unique_ptr<DescriptorImpl>> subscripts; //!< list of script subexpressions\n+                std::vector<int> depths; //!< depth in the tree of each subexpression (same length subscripts)\n+                for (const auto& [depth, script, leaf_ver] : *tree) {\n+                    std::unique_ptr<DescriptorImpl> subdesc;\n+                    if (leaf_ver == TAPROOT_LEAF_TAPSCRIPT) {\n+                        subdesc = InferScript(script, ParseScriptContext::P2TR, provider);\n+                    }\n+                    if (!subdesc) {\n+                        ok = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r654080186",
      "id" : 654080186,
      "in_reply_to_id" : 653550686,
      "line" : 1329,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDA4MDE4Ng==",
      "original_commit_id" : "834935511c2c799c8cb2312d617dbed6336000c4",
      "original_line" : 1329,
      "original_position" : 132,
      "original_start_line" : null,
      "path" : "src/script/descriptor.cpp",
      "position" : 108,
      "pull_request_review_id" : 686959815,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-18T01:20:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/654080186",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased, will work on adding some tests for failure cases of `InferTaprootTree`.",
      "created_at" : "2021-06-18T01:23:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#issuecomment-863663554",
      "id" : 863663554,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22166",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MzY2MzU1NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-18T01:23:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/863663554",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r654527282"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/654527282"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think you lost the asserts in your rebase:\r\n```\r\nassert(control.size() >= TAPROOT_CONTROL_BASE_SIZE);\r\nassert(program.size() >= uint256::size());\r\n```",
      "commit_id" : "9d1d0541829c19f6f109f66ae92aaaa0b4beb88a",
      "created_at" : "2021-06-18T15:38:28Z",
      "diff_hunk" : "@@ -1868,8 +1866,19 @@ static bool VerifyTaprootCommitment(const std::vector<unsigned char>& control, c\n         }\n         k = ss_branch.GetSHA256();\n     }\n+    return k;\n+}\n+\n+static bool VerifyTaprootCommitment(const std::vector<unsigned char>& control, const std::vector<unsigned char>& program, const uint256& tapleaf_hash)\n+{\n+    //! The internal pubkey (x-only, so no Y coordinate parity).\n+    const XOnlyPubKey p{uint256(std::vector<unsigned char>(control.begin() + 1, control.begin() + TAPROOT_CONTROL_BASE_SIZE))};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r654527282",
      "id" : 654527282,
      "in_reply_to_id" : 651729225,
      "line" : 1875,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDUyNzI4Mg==",
      "original_commit_id" : "13c6ab699eb6906c6554b4319a377c33fa0d157f",
      "original_line" : 1875,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/script/interpreter.cpp",
      "position" : 33,
      "pull_request_review_id" : 687537328,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-18T15:43:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/654527282",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@Sjors Oops, thanks for catching that. I redid the rebase; does it look better now?",
      "created_at" : "2021-06-18T18:33:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#issuecomment-864209850",
      "id" : 864209850,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22166",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NDIwOTg1MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-18T18:33:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/864209850",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-ACK d637a9b397816e34652d0c4d383308e39770737a\r\n\r\nRebase looks good.",
      "created_at" : "2021-06-18T18:44:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#issuecomment-864215272",
      "id" : 864215272,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22166",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NDIxNTI3Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-18T18:44:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/864215272",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-utACK d637a9b\r\n\r\nMuch better",
      "created_at" : "2021-06-21T15:48:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#issuecomment-865144862",
      "id" : 865144862,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22166",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NTE0NDg2Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-21T15:48:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/865144862",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r656947824"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/656947824"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: `to build`",
      "commit_id" : "d637a9b397816e34652d0c4d383308e39770737a",
      "created_at" : "2021-06-23T10:02:25Z",
      "diff_hunk" : "@@ -520,3 +520,138 @@ TaprootSpendData TaprootBuilder::GetSpendData() const\n     }\n     return spd;\n }\n+\n+std::optional<std::vector<std::tuple<int, CScript, int>>> InferTaprootTree(const TaprootSpendData& spenddata, const XOnlyPubKey& output)\n+{\n+    // Verify that the output matches the assumed Merkle root and internal key.\n+    auto tweak = spenddata.internal_key.CreateTapTweak(spenddata.merkle_root.IsNull() ? nullptr : &spenddata.merkle_root);\n+    if (!tweak || tweak->first != output) return std::nullopt;\n+    // If the Merkle root is 0, the tree is empty, and we're done.\n+    std::vector<std::tuple<int, CScript, int>> ret;\n+    if (spenddata.merkle_root.IsNull()) return ret;\n+\n+    /** Data structure to represent the nodes of the tree we're going to be build. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r656947824",
      "id" : 656947824,
      "line" : 533,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1Njk0NzgyNA==",
      "original_commit_id" : "d637a9b397816e34652d0c4d383308e39770737a",
      "original_line" : 533,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/script/standard.cpp",
      "position" : 14,
      "pull_request_review_id" : 690454669,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-23T10:18:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/656947824",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/meshcollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/meshcollider/followers",
         "following_url" : "https://api.github.com/users/meshcollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/meshcollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/meshcollider",
         "id" : 3211283,
         "login" : "meshcollider",
         "node_id" : "MDQ6VXNlcjMyMTEyODM=",
         "organizations_url" : "https://api.github.com/users/meshcollider/orgs",
         "received_events_url" : "https://api.github.com/users/meshcollider/received_events",
         "repos_url" : "https://api.github.com/users/meshcollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/meshcollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/meshcollider"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r656948503"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/656948503"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: `node`",
      "commit_id" : "d637a9b397816e34652d0c4d383308e39770737a",
      "created_at" : "2021-06-23T10:03:15Z",
      "diff_hunk" : "@@ -520,3 +520,138 @@ TaprootSpendData TaprootBuilder::GetSpendData() const\n     }\n     return spd;\n }\n+\n+std::optional<std::vector<std::tuple<int, CScript, int>>> InferTaprootTree(const TaprootSpendData& spenddata, const XOnlyPubKey& output)\n+{\n+    // Verify that the output matches the assumed Merkle root and internal key.\n+    auto tweak = spenddata.internal_key.CreateTapTweak(spenddata.merkle_root.IsNull() ? nullptr : &spenddata.merkle_root);\n+    if (!tweak || tweak->first != output) return std::nullopt;\n+    // If the Merkle root is 0, the tree is empty, and we're done.\n+    std::vector<std::tuple<int, CScript, int>> ret;\n+    if (spenddata.merkle_root.IsNull()) return ret;\n+\n+    /** Data structure to represent the nodes of the tree we're going to be build. */\n+    struct TreeNode {\n+        /** Hash of this none, if known; 0 otherwise. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r656948503",
      "id" : 656948503,
      "line" : 535,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1Njk0ODUwMw==",
      "original_commit_id" : "d637a9b397816e34652d0c4d383308e39770737a",
      "original_line" : 535,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/script/standard.cpp",
      "position" : 16,
      "pull_request_review_id" : 690454669,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-23T10:18:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/656948503",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/meshcollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/meshcollider/followers",
         "following_url" : "https://api.github.com/users/meshcollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/meshcollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/meshcollider",
         "id" : 3211283,
         "login" : "meshcollider",
         "node_id" : "MDQ6VXNlcjMyMTEyODM=",
         "organizations_url" : "https://api.github.com/users/meshcollider/orgs",
         "received_events_url" : "https://api.github.com/users/meshcollider/received_events",
         "repos_url" : "https://api.github.com/users/meshcollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/meshcollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/meshcollider"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r656949147"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/656949147"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: `provided`",
      "commit_id" : "d637a9b397816e34652d0c4d383308e39770737a",
      "created_at" : "2021-06-23T10:04:07Z",
      "diff_hunk" : "@@ -520,3 +520,138 @@ TaprootSpendData TaprootBuilder::GetSpendData() const\n     }\n     return spd;\n }\n+\n+std::optional<std::vector<std::tuple<int, CScript, int>>> InferTaprootTree(const TaprootSpendData& spenddata, const XOnlyPubKey& output)\n+{\n+    // Verify that the output matches the assumed Merkle root and internal key.\n+    auto tweak = spenddata.internal_key.CreateTapTweak(spenddata.merkle_root.IsNull() ? nullptr : &spenddata.merkle_root);\n+    if (!tweak || tweak->first != output) return std::nullopt;\n+    // If the Merkle root is 0, the tree is empty, and we're done.\n+    std::vector<std::tuple<int, CScript, int>> ret;\n+    if (spenddata.merkle_root.IsNull()) return ret;\n+\n+    /** Data structure to represent the nodes of the tree we're going to be build. */\n+    struct TreeNode {\n+        /** Hash of this none, if known; 0 otherwise. */\n+        uint256 hash;\n+        /** The left and right subtrees (note that their order is irrelevant). */\n+        std::unique_ptr<TreeNode> sub[2];\n+        /** If this is known to be a leaf node, a pointer to the (script, leaf_ver) pair.\n+         *  nullptr otherwise. */\n+        const std::pair<CScript, int>* leaf = nullptr;\n+        /** Whether or not this node has been explored (is known to be a leaf, or known to have children). */\n+        bool explored = false;\n+        /** Whether or not this node is an inner node (unknown until explored = true). */\n+        bool inner;\n+        /** Whether or not we have produced output for this subtree. */\n+        bool done = false;\n+    };\n+\n+    // Build tree from the provides branches.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r656949147",
      "id" : 656949147,
      "line" : 550,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1Njk0OTE0Nw==",
      "original_commit_id" : "d637a9b397816e34652d0c4d383308e39770737a",
      "original_line" : 550,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/script/standard.cpp",
      "position" : 31,
      "pull_request_review_id" : 690454669,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-23T10:18:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/656949147",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3211283?v=4",
         "events_url" : "https://api.github.com/users/meshcollider/events{/privacy}",
         "followers_url" : "https://api.github.com/users/meshcollider/followers",
         "following_url" : "https://api.github.com/users/meshcollider/following{/other_user}",
         "gists_url" : "https://api.github.com/users/meshcollider/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/meshcollider",
         "id" : 3211283,
         "login" : "meshcollider",
         "node_id" : "MDQ6VXNlcjMyMTEyODM=",
         "organizations_url" : "https://api.github.com/users/meshcollider/orgs",
         "received_events_url" : "https://api.github.com/users/meshcollider/received_events",
         "repos_url" : "https://api.github.com/users/meshcollider/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/meshcollider/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/meshcollider"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r657010291"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/657010291"
         }
      },
      "author_association" : "MEMBER",
      "body" : "touched up the various nits in #22323, feel free to add any others there",
      "commit_id" : "d637a9b397816e34652d0c4d383308e39770737a",
      "created_at" : "2021-06-23T11:37:45Z",
      "diff_hunk" : "@@ -520,3 +520,138 @@ TaprootSpendData TaprootBuilder::GetSpendData() const\n     }\n     return spd;\n }\n+\n+std::optional<std::vector<std::tuple<int, CScript, int>>> InferTaprootTree(const TaprootSpendData& spenddata, const XOnlyPubKey& output)\n+{\n+    // Verify that the output matches the assumed Merkle root and internal key.\n+    auto tweak = spenddata.internal_key.CreateTapTweak(spenddata.merkle_root.IsNull() ? nullptr : &spenddata.merkle_root);\n+    if (!tweak || tweak->first != output) return std::nullopt;\n+    // If the Merkle root is 0, the tree is empty, and we're done.\n+    std::vector<std::tuple<int, CScript, int>> ret;\n+    if (spenddata.merkle_root.IsNull()) return ret;\n+\n+    /** Data structure to represent the nodes of the tree we're going to be build. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r657010291",
      "id" : 657010291,
      "in_reply_to_id" : 656947824,
      "line" : 533,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NzAxMDI5MQ==",
      "original_commit_id" : "d637a9b397816e34652d0c4d383308e39770737a",
      "original_line" : 533,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/script/standard.cpp",
      "position" : 14,
      "pull_request_review_id" : 690536100,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-23T11:37:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/657010291",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r944606302"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944606302"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I mildly object the the use of the type `CScript` here.  While it is true that BIP-341 names this stack item \"script\", this value is only interpreted as a CScript in the case of BIP-342 where the `leaf_version` is equal to `TAPROOT_LEAF_TAPSCRIPT` (modulo `TAPROOT_LEAF_MASK`).  Otherwise it is simply a bytestring.",
      "commit_id" : "d637a9b397816e34652d0c4d383308e39770737a",
      "created_at" : "2022-08-12T15:59:10Z",
      "diff_hunk" : "@@ -1847,16 +1847,14 @@ static bool ExecuteWitnessScript(const Span<const valtype>& stack_span, const CS\n     return true;\n }\n \n-static bool VerifyTaprootCommitment(const std::vector<unsigned char>& control, const std::vector<unsigned char>& program, const CScript& script, uint256& tapleaf_hash)\n+uint256 ComputeTapleafHash(uint8_t leaf_version, const CScript& script)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22166#discussion_r944606302",
      "id" : 944606302,
      "line" : 1850,
      "node_id" : "PRRC_kwDOABII5844TYxe",
      "original_commit_id" : "d637a9b397816e34652d0c4d383308e39770737a",
      "original_line" : 1850,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/script/interpreter.cpp",
      "position" : 5,
      "pull_request_review_id" : 1071301871,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22166",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944606302/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-12T15:59:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/944606302",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/21371712?v=4",
         "events_url" : "https://api.github.com/users/roconnor-blockstream/events{/privacy}",
         "followers_url" : "https://api.github.com/users/roconnor-blockstream/followers",
         "following_url" : "https://api.github.com/users/roconnor-blockstream/following{/other_user}",
         "gists_url" : "https://api.github.com/users/roconnor-blockstream/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/roconnor-blockstream",
         "id" : 21371712,
         "login" : "roconnor-blockstream",
         "node_id" : "MDQ6VXNlcjIxMzcxNzEy",
         "organizations_url" : "https://api.github.com/users/roconnor-blockstream/orgs",
         "received_events_url" : "https://api.github.com/users/roconnor-blockstream/received_events",
         "repos_url" : "https://api.github.com/users/roconnor-blockstream/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/roconnor-blockstream/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/roconnor-blockstream/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/roconnor-blockstream"
      }
   }
]
