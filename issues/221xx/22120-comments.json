[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Two concept ACKs, but this needs review comments addressing, added \"waiting for author\" https://github.com/bitcoin/bitcoin/pull/17872#issuecomment-815473116\r\n\r\nConcept ACK, cool you picked this up.\r\n\r\nnit: I think the title should be `test:` or `qa:` ie lower case rather than upper case\r\n\r\n> test, qa or ci for changes to the unit tests, QA tests or CI code test, https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#creating-the-pull-request",
      "created_at" : "2021-06-01T18:23:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22120#issuecomment-852348017",
      "id" : 852348017,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22120",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1MjM0ODAxNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-01T18:27:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/852348017",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/16323900?v=4",
         "events_url" : "https://api.github.com/users/michaelfolkson/events{/privacy}",
         "followers_url" : "https://api.github.com/users/michaelfolkson/followers",
         "following_url" : "https://api.github.com/users/michaelfolkson/following{/other_user}",
         "gists_url" : "https://api.github.com/users/michaelfolkson/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/michaelfolkson",
         "id" : 16323900,
         "login" : "michaelfolkson",
         "node_id" : "MDQ6VXNlcjE2MzIzOTAw",
         "organizations_url" : "https://api.github.com/users/michaelfolkson/orgs",
         "received_events_url" : "https://api.github.com/users/michaelfolkson/received_events",
         "repos_url" : "https://api.github.com/users/michaelfolkson/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/michaelfolkson/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/michaelfolkson/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/michaelfolkson"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r643767595"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/643767595"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is a comment, there's no need to say \"NOTE\"\r\n```suggestion\r\n        # Need force_send because the block will get rejected without a getdata otherwise\r\n```",
      "commit_id" : "1e9796e31f8c8cc980688d2cf1fce60204fce03a",
      "created_at" : "2021-06-02T09:06:02Z",
      "diff_hunk" : "@@ -133,5 +136,19 @@ def run_test(self):\n         self.log.info(\"Test inflation by duplicating input\")\n         peer.send_blocks_and_test([block4], node, success=False,  reject_reason='bad-txns-inputs-duplicate')\n \n+\n+        self.log.info(\"Test accepting identical block after rejecting it due to a future timestamp.\")\n+\n+        t = int(time.time())\n+        node.setmocktime(t)\n+        block = create_block(tip, create_coinbase(height), t + 7201)\n+        block.hashMerkleRoot = block.calc_merkle_root()\n+        block.solve()\n+        # NOTE: Need force_send because the block will get rejected without a getdata otherwise",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r643767595",
      "id" : 643767595,
      "line" : 147,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0Mzc2NzU5NQ==",
      "original_commit_id" : "1e9796e31f8c8cc980688d2cf1fce60204fce03a",
      "original_line" : 147,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_block.py",
      "position" : 24,
      "pull_request_review_id" : 673937371,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-02T09:30:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/643767595",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r643768936"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/643768936"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'd prefer referencing the p2p object directly instead of through the node's p2p list, similar to the code above. If a subtest is added that connects/disconnects peers, this index could no longer refer to the peer you want.\r\n\r\n```suggestion\r\n        peer.send_blocks_and_test([block], node, force_send=True, success=False, reject_reason='time-too-new')\r\n\r\n        node.setmocktime(t + 1)\r\n        peer.send_blocks_and_test([block], node, success=True, timeout=5)\r\n```",
      "commit_id" : "1e9796e31f8c8cc980688d2cf1fce60204fce03a",
      "created_at" : "2021-06-02T09:07:55Z",
      "diff_hunk" : "@@ -133,5 +136,19 @@ def run_test(self):\n         self.log.info(\"Test inflation by duplicating input\")\n         peer.send_blocks_and_test([block4], node, success=False,  reject_reason='bad-txns-inputs-duplicate')\n \n+\n+        self.log.info(\"Test accepting identical block after rejecting it due to a future timestamp.\")\n+\n+        t = int(time.time())\n+        node.setmocktime(t)\n+        block = create_block(tip, create_coinbase(height), t + 7201)\n+        block.hashMerkleRoot = block.calc_merkle_root()\n+        block.solve()\n+        # NOTE: Need force_send because the block will get rejected without a getdata otherwise\n+        node.p2ps[0].send_blocks_and_test([block], node, force_send=True, success=False, reject_reason='time-too-new')\n+\n+        node.setmocktime(t + 1)\n+        node.p2ps[0].send_blocks_and_test([block], node, success=True, timeout=5)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r643768936",
      "id" : 643768936,
      "line" : 151,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0Mzc2ODkzNg==",
      "original_commit_id" : "1e9796e31f8c8cc980688d2cf1fce60204fce03a",
      "original_line" : 151,
      "original_position" : 28,
      "original_start_line" : 148,
      "path" : "test/functional/p2p_invalid_block.py",
      "position" : 28,
      "pull_request_review_id" : 673937371,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120",
      "side" : "RIGHT",
      "start_line" : 148,
      "start_side" : "RIGHT",
      "updated_at" : "2021-06-02T09:30:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/643768936",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r643774433"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/643774433"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is 1 second away from the cutoff right? Perhaps a slightly larger buffer would be better because the functional tests usually run multithreaded.",
      "commit_id" : "1e9796e31f8c8cc980688d2cf1fce60204fce03a",
      "created_at" : "2021-06-02T09:15:37Z",
      "diff_hunk" : "@@ -133,5 +136,19 @@ def run_test(self):\n         self.log.info(\"Test inflation by duplicating input\")\n         peer.send_blocks_and_test([block4], node, success=False,  reject_reason='bad-txns-inputs-duplicate')\n \n+\n+        self.log.info(\"Test accepting identical block after rejecting it due to a future timestamp.\")\n+\n+        t = int(time.time())\n+        node.setmocktime(t)\n+        block = create_block(tip, create_coinbase(height), t + 7201)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r643774433",
      "id" : 643774433,
      "line" : 144,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0Mzc3NDQzMw==",
      "original_commit_id" : "1e9796e31f8c8cc980688d2cf1fce60204fce03a",
      "original_line" : 144,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_block.py",
      "position" : 21,
      "pull_request_review_id" : 673937371,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-02T09:30:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/643774433",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r643778376"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/643778376"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Another small suggestion, using `2 * 60 * 60` or `MAX_FUTURE_BLOCK_TIME` instead of a magic number might be a bit more clear",
      "commit_id" : "1e9796e31f8c8cc980688d2cf1fce60204fce03a",
      "created_at" : "2021-06-02T09:21:05Z",
      "diff_hunk" : "@@ -133,5 +136,19 @@ def run_test(self):\n         self.log.info(\"Test inflation by duplicating input\")\n         peer.send_blocks_and_test([block4], node, success=False,  reject_reason='bad-txns-inputs-duplicate')\n \n+\n+        self.log.info(\"Test accepting identical block after rejecting it due to a future timestamp.\")\n+\n+        t = int(time.time())\n+        node.setmocktime(t)\n+        block = create_block(tip, create_coinbase(height), t + 7201)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r643778376",
      "id" : 643778376,
      "in_reply_to_id" : 643774433,
      "line" : 144,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0Mzc3ODM3Ng==",
      "original_commit_id" : "1e9796e31f8c8cc980688d2cf1fce60204fce03a",
      "original_line" : 144,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_block.py",
      "position" : 21,
      "pull_request_review_id" : 673937371,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-02T09:30:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/643778376",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r644246318"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644246318"
         }
      },
      "author_association" : "NONE",
      "body" : "Removed!",
      "commit_id" : "8172d58318fce221164e6cce2cc82515d1bbd2e1",
      "created_at" : "2021-06-02T19:03:42Z",
      "diff_hunk" : "@@ -133,5 +136,19 @@ def run_test(self):\n         self.log.info(\"Test inflation by duplicating input\")\n         peer.send_blocks_and_test([block4], node, success=False,  reject_reason='bad-txns-inputs-duplicate')\n \n+\n+        self.log.info(\"Test accepting identical block after rejecting it due to a future timestamp.\")\n+\n+        t = int(time.time())\n+        node.setmocktime(t)\n+        block = create_block(tip, create_coinbase(height), t + 7201)\n+        block.hashMerkleRoot = block.calc_merkle_root()\n+        block.solve()\n+        # NOTE: Need force_send because the block will get rejected without a getdata otherwise",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r644246318",
      "id" : 644246318,
      "in_reply_to_id" : 643767595,
      "line" : 150,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDI0NjMxOA==",
      "original_commit_id" : "1e9796e31f8c8cc980688d2cf1fce60204fce03a",
      "original_line" : 150,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_block.py",
      "position" : 34,
      "pull_request_review_id" : 674585170,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-02T19:03:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644246318",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r644247408"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644247408"
         }
      },
      "author_association" : "NONE",
      "body" : "Thanks, I agree this is both clearer and better.",
      "commit_id" : "8172d58318fce221164e6cce2cc82515d1bbd2e1",
      "created_at" : "2021-06-02T19:05:31Z",
      "diff_hunk" : "@@ -133,5 +136,19 @@ def run_test(self):\n         self.log.info(\"Test inflation by duplicating input\")\n         peer.send_blocks_and_test([block4], node, success=False,  reject_reason='bad-txns-inputs-duplicate')\n \n+\n+        self.log.info(\"Test accepting identical block after rejecting it due to a future timestamp.\")\n+\n+        t = int(time.time())\n+        node.setmocktime(t)\n+        block = create_block(tip, create_coinbase(height), t + 7201)\n+        block.hashMerkleRoot = block.calc_merkle_root()\n+        block.solve()\n+        # NOTE: Need force_send because the block will get rejected without a getdata otherwise\n+        node.p2ps[0].send_blocks_and_test([block], node, force_send=True, success=False, reject_reason='time-too-new')\n+\n+        node.setmocktime(t + 1)\n+        node.p2ps[0].send_blocks_and_test([block], node, success=True, timeout=5)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r644247408",
      "id" : 644247408,
      "in_reply_to_id" : 643768936,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDI0NzQwOA==",
      "original_commit_id" : "1e9796e31f8c8cc980688d2cf1fce60204fce03a",
      "original_line" : 153,
      "original_position" : 28,
      "original_start_line" : 148,
      "path" : "test/functional/p2p_invalid_block.py",
      "position" : null,
      "pull_request_review_id" : 674586631,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-06-02T19:05:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644247408",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r644248601"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644248601"
         }
      },
      "author_association" : "NONE",
      "body" : "I went for `MAX_FUTURE_BLOCK_TIME` in the end and added a new `t_premature = 60`, so that we have a 60 second buffer to avoid any potential issues.",
      "commit_id" : "8172d58318fce221164e6cce2cc82515d1bbd2e1",
      "created_at" : "2021-06-02T19:07:30Z",
      "diff_hunk" : "@@ -133,5 +136,19 @@ def run_test(self):\n         self.log.info(\"Test inflation by duplicating input\")\n         peer.send_blocks_and_test([block4], node, success=False,  reject_reason='bad-txns-inputs-duplicate')\n \n+\n+        self.log.info(\"Test accepting identical block after rejecting it due to a future timestamp.\")\n+\n+        t = int(time.time())\n+        node.setmocktime(t)\n+        block = create_block(tip, create_coinbase(height), t + 7201)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r644248601",
      "id" : 644248601,
      "in_reply_to_id" : 643774433,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDI0ODYwMQ==",
      "original_commit_id" : "1e9796e31f8c8cc980688d2cf1fce60204fce03a",
      "original_line" : 144,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_block.py",
      "position" : null,
      "pull_request_review_id" : 674588213,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-02T19:07:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644248601",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r646627839"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/646627839"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hm, I don't think it's been removed?",
      "commit_id" : "8172d58318fce221164e6cce2cc82515d1bbd2e1",
      "created_at" : "2021-06-07T14:14:21Z",
      "diff_hunk" : "@@ -133,5 +136,19 @@ def run_test(self):\n         self.log.info(\"Test inflation by duplicating input\")\n         peer.send_blocks_and_test([block4], node, success=False,  reject_reason='bad-txns-inputs-duplicate')\n \n+\n+        self.log.info(\"Test accepting identical block after rejecting it due to a future timestamp.\")\n+\n+        t = int(time.time())\n+        node.setmocktime(t)\n+        block = create_block(tip, create_coinbase(height), t + 7201)\n+        block.hashMerkleRoot = block.calc_merkle_root()\n+        block.solve()\n+        # NOTE: Need force_send because the block will get rejected without a getdata otherwise",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r646627839",
      "id" : 646627839,
      "in_reply_to_id" : 643767595,
      "line" : 150,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NjYyNzgzOQ==",
      "original_commit_id" : "1e9796e31f8c8cc980688d2cf1fce60204fce03a",
      "original_line" : 150,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_block.py",
      "position" : 34,
      "pull_request_review_id" : 677467109,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-07T14:14:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/646627839",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r648935320"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/648935320"
         }
      },
      "author_association" : "MEMBER",
      "body" : "why? I changed to `1` and nothing happened",
      "commit_id" : "7879b4679e83b4de3ef3f67eafc6681291ff3dc5",
      "created_at" : "2021-06-10T07:47:43Z",
      "diff_hunk" : "@@ -133,5 +139,19 @@ def run_test(self):\n         self.log.info(\"Test inflation by duplicating input\")\n         peer.send_blocks_and_test([block4], node, success=False,  reject_reason='bad-txns-inputs-duplicate')\n \n+        self.log.info(\"Test accepting identical block after rejecting it due to a future timestamp.\")\n+        t = int(time.time())\n+        # Make block timestamp validity 60 seconds premature to avoid test-timing issues",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r648935320",
      "id" : 648935320,
      "line" : 144,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0ODkzNTMyMA==",
      "original_commit_id" : "7879b4679e83b4de3ef3f67eafc6681291ff3dc5",
      "original_line" : 144,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_block.py",
      "position" : 28,
      "pull_request_review_id" : 680452184,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-10T07:48:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/648935320",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r648935864"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/648935864"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        peer.send_blocks_and_test([block], node, success=True)\r\n```\r\n\r\nNo need to lower this. User can adjust via `--timeout-factor=0.1`",
      "commit_id" : "7879b4679e83b4de3ef3f67eafc6681291ff3dc5",
      "created_at" : "2021-06-10T07:48:23Z",
      "diff_hunk" : "@@ -133,5 +139,19 @@ def run_test(self):\n         self.log.info(\"Test inflation by duplicating input\")\n         peer.send_blocks_and_test([block4], node, success=False,  reject_reason='bad-txns-inputs-duplicate')\n \n+        self.log.info(\"Test accepting identical block after rejecting it due to a future timestamp.\")\n+        t = int(time.time())\n+        # Make block timestamp validity 60 seconds premature to avoid test-timing issues\n+        t_premature = 60\n+        node.setmocktime(t)\n+        block = create_block(tip, create_coinbase(height), t + MAX_FUTURE_BLOCK_TIME + t_premature)\n+        block.hashMerkleRoot = block.calc_merkle_root()\n+        block.solve()\n+        # Need force_send because the block will get rejected without a getdata otherwise\n+        peer.send_blocks_and_test([block], node, force_send=True, success=False, reject_reason='time-too-new')\n+        node.setmocktime(t + t_premature)\n+        peer.send_blocks_and_test([block], node, success=True, timeout=5)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r648935864",
      "id" : 648935864,
      "line" : 153,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0ODkzNTg2NA==",
      "original_commit_id" : "7879b4679e83b4de3ef3f67eafc6681291ff3dc5",
      "original_line" : 153,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_block.py",
      "position" : 37,
      "pull_request_review_id" : 680452184,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-10T07:48:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/648935864",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r651577974"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651577974"
         }
      },
      "author_association" : "NONE",
      "body" : "I also had no difficulty/local failures with t=1, but there was a raised concern that multi-threaded tests could jeopardise this [here](https://github.com/bitcoin/bitcoin/pull/22120#discussion_r643774433). It doesn't seem like something that threat timing issues could throw off to me as time is advanced before validity is re-checked, but I am not 100% on that.\r\n\r\nI am going to reset this to 1 along with the timeout change suggested as a means to restart appveyor which failed.\r\n\r\nEdit: @MarcoFalke can you confirm that node time cannot advance automatically once setmocktime rpc has been called? If so then I will be convinced that multi-threading these tests will not cause any issues with t=1",
      "commit_id" : "7879b4679e83b4de3ef3f67eafc6681291ff3dc5",
      "created_at" : "2021-06-15T08:41:53Z",
      "diff_hunk" : "@@ -133,5 +139,19 @@ def run_test(self):\n         self.log.info(\"Test inflation by duplicating input\")\n         peer.send_blocks_and_test([block4], node, success=False,  reject_reason='bad-txns-inputs-duplicate')\n \n+        self.log.info(\"Test accepting identical block after rejecting it due to a future timestamp.\")\n+        t = int(time.time())\n+        # Make block timestamp validity 60 seconds premature to avoid test-timing issues",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r651577974",
      "id" : 651577974,
      "in_reply_to_id" : 648935320,
      "line" : 144,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTU3Nzk3NA==",
      "original_commit_id" : "7879b4679e83b4de3ef3f67eafc6681291ff3dc5",
      "original_line" : 144,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_block.py",
      "position" : 28,
      "pull_request_review_id" : 683725350,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-15T08:52:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651577974",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r651587109"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651587109"
         }
      },
      "author_association" : "NONE",
      "body" : "Thanks. Will update this with or without the time premature (=1) suggestion.",
      "commit_id" : "7879b4679e83b4de3ef3f67eafc6681291ff3dc5",
      "created_at" : "2021-06-15T08:52:52Z",
      "diff_hunk" : "@@ -133,5 +139,19 @@ def run_test(self):\n         self.log.info(\"Test inflation by duplicating input\")\n         peer.send_blocks_and_test([block4], node, success=False,  reject_reason='bad-txns-inputs-duplicate')\n \n+        self.log.info(\"Test accepting identical block after rejecting it due to a future timestamp.\")\n+        t = int(time.time())\n+        # Make block timestamp validity 60 seconds premature to avoid test-timing issues\n+        t_premature = 60\n+        node.setmocktime(t)\n+        block = create_block(tip, create_coinbase(height), t + MAX_FUTURE_BLOCK_TIME + t_premature)\n+        block.hashMerkleRoot = block.calc_merkle_root()\n+        block.solve()\n+        # Need force_send because the block will get rejected without a getdata otherwise\n+        peer.send_blocks_and_test([block], node, force_send=True, success=False, reject_reason='time-too-new')\n+        node.setmocktime(t + t_premature)\n+        peer.send_blocks_and_test([block], node, success=True, timeout=5)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r651587109",
      "id" : 651587109,
      "in_reply_to_id" : 648935864,
      "line" : 153,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTU4NzEwOQ==",
      "original_commit_id" : "7879b4679e83b4de3ef3f67eafc6681291ff3dc5",
      "original_line" : 153,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_block.py",
      "position" : 37,
      "pull_request_review_id" : 683737235,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-15T08:52:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651587109",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r651633522"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651633522"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Edit: @MarcoFalke can you confirm that node time cannot advance automatically once setmocktime rpc has been called? If so then I will be convinced that multi-threading these tests will not cause any issues with t=1\r\n\r\nThe wall clock time for the node still advances, but the mocktime is pinned once `setmocktime` is set to a non-zero value.",
      "commit_id" : "7879b4679e83b4de3ef3f67eafc6681291ff3dc5",
      "created_at" : "2021-06-15T09:52:29Z",
      "diff_hunk" : "@@ -133,5 +139,19 @@ def run_test(self):\n         self.log.info(\"Test inflation by duplicating input\")\n         peer.send_blocks_and_test([block4], node, success=False,  reject_reason='bad-txns-inputs-duplicate')\n \n+        self.log.info(\"Test accepting identical block after rejecting it due to a future timestamp.\")\n+        t = int(time.time())\n+        # Make block timestamp validity 60 seconds premature to avoid test-timing issues",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r651633522",
      "id" : 651633522,
      "in_reply_to_id" : 648935320,
      "line" : 144,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTYzMzUyMg==",
      "original_commit_id" : "7879b4679e83b4de3ef3f67eafc6681291ff3dc5",
      "original_line" : 144,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_block.py",
      "position" : 28,
      "pull_request_review_id" : 683798250,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-15T09:52:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651633522",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Pushed to address nits and restart appveyor (which failed during fastly outage).\r\n\r\n* Removed `t_premature` and reverted to simple `+ 1` seconds past `MAX_FUTURE_BLOCK_TIME`\r\n* Removed `timeout` from `send_blocks_and_test` as suggested [here](https://github.com/bitcoin/bitcoin/pull/22120#discussion_r648935864)\r\n\r\n```\r\n$ git range-diff HEAD~1..7879b46 HEAD~1..754e802\r\n\r\n1:  7879b4679 ! 1:  754e80227 test: check rejected future block later accepted\r\n    @@ test/functional/p2p_invalid_block.py: class InvalidBlockRequestTest(BitcoinTestF\r\n\r\n     +        self.log.info(\"Test accepting identical block after rejecting it due to a future timestamp.\")\r\n     +        t = int(time.time())\r\n    -+        # Make block timestamp validity 60 seconds premature to avoid test-timing issues\r\n    -+        t_premature = 60\r\n     +        node.setmocktime(t)\r\n    -+        block = create_block(tip, create_coinbase(height), t + MAX_FUTURE_BLOCK_TIME + t_premature)\r\n    ++        # Set block time +1 second past max future validity\r\n    ++        block = create_block(tip, create_coinbase(height), t + MAX_FUTURE_BLOCK_TIME + 1)\r\n     +        block.hashMerkleRoot = block.calc_merkle_root()\r\n     +        block.solve()\r\n     +        # Need force_send because the block will get rejected without a getdata otherwise\r\n     +        peer.send_blocks_and_test([block], node, force_send=True, success=False, reject_reason='time-too-new')\r\n    -+        node.setmocktime(t + t_premature)\r\n    -+        peer.send_blocks_and_test([block], node, success=True, timeout=5)\r\n    ++        node.setmocktime(t + 1)\r\n    ++        peer.send_blocks_and_test([block], node, success=True)\r\n     +\r\n     +\r\n      if __name__ == '__main__':\r\n```",
      "created_at" : "2021-06-15T21:44:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22120#issuecomment-861853803",
      "id" : 861853803,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22120",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MTg1MzgwMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-15T21:44:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/861853803",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r652173996"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/652173996"
         }
      },
      "author_association" : "NONE",
      "body" : "Removed in 754e802",
      "commit_id" : "754e802274e9373ad7e1dccb710acf74ded6e7fb",
      "created_at" : "2021-06-15T21:44:26Z",
      "diff_hunk" : "@@ -133,5 +139,19 @@ def run_test(self):\n         self.log.info(\"Test inflation by duplicating input\")\n         peer.send_blocks_and_test([block4], node, success=False,  reject_reason='bad-txns-inputs-duplicate')\n \n+        self.log.info(\"Test accepting identical block after rejecting it due to a future timestamp.\")\n+        t = int(time.time())\n+        # Make block timestamp validity 60 seconds premature to avoid test-timing issues\n+        t_premature = 60\n+        node.setmocktime(t)\n+        block = create_block(tip, create_coinbase(height), t + MAX_FUTURE_BLOCK_TIME + t_premature)\n+        block.hashMerkleRoot = block.calc_merkle_root()\n+        block.solve()\n+        # Need force_send because the block will get rejected without a getdata otherwise\n+        peer.send_blocks_and_test([block], node, force_send=True, success=False, reject_reason='time-too-new')\n+        node.setmocktime(t + t_premature)\n+        peer.send_blocks_and_test([block], node, success=True, timeout=5)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r652173996",
      "id" : 652173996,
      "in_reply_to_id" : 648935864,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MjE3Mzk5Ng==",
      "original_commit_id" : "7879b4679e83b4de3ef3f67eafc6681291ff3dc5",
      "original_line" : 153,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_block.py",
      "position" : null,
      "pull_request_review_id" : 684517347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-15T21:44:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/652173996",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r652174173"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/652174173"
         }
      },
      "author_association" : "NONE",
      "body" : "Thanks, unnecessary constant now removed in 754e802",
      "commit_id" : "754e802274e9373ad7e1dccb710acf74ded6e7fb",
      "created_at" : "2021-06-15T21:44:47Z",
      "diff_hunk" : "@@ -133,5 +139,19 @@ def run_test(self):\n         self.log.info(\"Test inflation by duplicating input\")\n         peer.send_blocks_and_test([block4], node, success=False,  reject_reason='bad-txns-inputs-duplicate')\n \n+        self.log.info(\"Test accepting identical block after rejecting it due to a future timestamp.\")\n+        t = int(time.time())\n+        # Make block timestamp validity 60 seconds premature to avoid test-timing issues",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22120#discussion_r652174173",
      "id" : 652174173,
      "in_reply_to_id" : 648935320,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MjE3NDE3Mw==",
      "original_commit_id" : "7879b4679e83b4de3ef3f67eafc6681291ff3dc5",
      "original_line" : 144,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_invalid_block.py",
      "position" : null,
      "pull_request_review_id" : 684517558,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22120",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-15T21:44:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/652174173",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "review ACK 754e802274e9373ad7e1dccb710acf74ded6e7fb",
      "created_at" : "2021-06-17T07:05:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22120#issuecomment-862987039",
      "id" : 862987039,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22120",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2Mjk4NzAzOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-17T07:05:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/862987039",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This PR may be causing heisenbug CI failures ([example](https://github.com/bitcoin/bitcoin/pull/22350/checks?check_run_id=3002374670)). I can reproduce the failure on my laptop after several attempts:\r\n```\r\n2021-07-06T22:15:40.550000Z TestFramework (INFO): Create a new block with an anyone-can-spend coinbase\r\n2021-07-06T22:15:40.653000Z TestFramework (INFO): Mature the block.\r\n2021-07-06T22:15:40.991000Z TestFramework (INFO): Test merkle root malleability.\r\n2021-07-06T22:15:41.096000Z TestFramework (INFO): Test duplicate input block.\r\n2021-07-06T22:15:41.200000Z TestFramework (INFO): Test very broken block.\r\n2021-07-06T22:15:41.304000Z TestFramework (INFO): Test accepting original block after rejecting its mutated version.\r\n2021-07-06T22:15:41.357000Z TestFramework (INFO): Test inflation by duplicating input\r\n2021-07-06T22:15:41.460000Z TestFramework (INFO): Test accepting identical block after rejecting it due to a future timestamp.\r\n2021-07-06T22:15:43.489000Z TestFramework (ERROR): Assertion failed\r\nTraceback (most recent call last):\r\n  File \"/g/bitcoin/test/functional/test_framework/test_framework.py\", line 128, in main\r\n    self.run_test()\r\n  File \"test/functional/p2p_invalid_block.py\", line 150, in run_test\r\n    peer.send_blocks_and_test([block], node, force_send=True, success=False, reject_reason='time-too-new')\r\n  File \"/g/bitcoin/test/functional/test_framework/p2p.py\", line 730, in send_blocks_and_test\r\n    assert node.getbestblockhash() != blocks[-1].hash\r\n  File \"/usr/lib/python3.8/contextlib.py\", line 120, in __exit__\r\n    next(self.gen)\r\n  File \"/g/bitcoin/test/functional/test_framework/test_node.py\", line 400, in assert_debug_log\r\n    self._raise_assertion_error('Expected messages \"{}\" does not partially match log:\\n\\n{}\\n\\n'.format(str(expected_msgs), print_log))\r\n  File \"/g/bitcoin/test/functional/test_framework/test_node.py\", line 166, in _raise_assertion_error\r\n    raise AssertionError(self._node_msg(msg))\r\nAssertionError: [node 0] Expected messages \"['time-too-new']\" does not partially match log:\r\n```",
      "created_at" : "2021-07-07T00:57:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22120#issuecomment-875186505",
      "id" : 875186505,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22120",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NTE4NjUwNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-07T00:57:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/875186505",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Are you sure this is failing on master?\r\n\r\nDebug log rotation must be disabled for the tests to work properly, as some are reading within the file by offset.",
      "created_at" : "2021-07-07T07:29:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22120#issuecomment-875360205",
      "id" : 875360205,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22120",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NTM2MDIwNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-07T07:29:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/875360205",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Are you sure this is failing on master?\r\n> \r\n> Debug log rotation must be disabled for the tests to work properly, as some are reading within the file by offset.\r\n\r\nAAACK! You're right, sorry about that! I didn't imagine the log file would get large enough to rotate, but I forgot that tests run with `-debug` (all logs enabled). Should I delete my comment above to keep this PR's conversation clean (and this one too, and you can delete yours)?",
      "created_at" : "2021-07-07T16:33:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22120#issuecomment-875752579",
      "id" : 875752579,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22120",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NTc1MjU3OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-07T16:33:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/875752579",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   }
]
