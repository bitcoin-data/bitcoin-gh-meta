[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22147#discussion_r645778792"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/645778792"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Optional, if retouch perhaps hoist the `3` here and in line 854 to a constexpr and maybe the following mini-wishlist:\r\n```diff\r\n         int num_outbound_hb_peers = 0;\r\n         for (std::list<NodeId>::iterator it = lNodesAnnouncingHeaderAndIDs.begin(); it != lNodesAnnouncingHeaderAndIDs.end(); it++) {\r\n             if (*it == nodeid) {\r\n+                // Move this nodeid to the end of the list.\r\n                 lNodesAnnouncingHeaderAndIDs.erase(it);\r\n                 lNodesAnnouncingHeaderAndIDs.push_back(nodeid);\r\n                 return;\r\n@@ -1556,7 +1557,7 @@ void PeerManagerImpl::BlockChecked(const CBlock& block, const BlockValidationSta\r\n              !m_chainman.ActiveChainstate().IsInitialBlockDownload() &&\r\n              mapBlocksInFlight.count(hash) == mapBlocksInFlight.size()) {\r\n         if (it != mapBlockSource.end()) {\r\n-            MaybeSetPeerAsAnnouncingHeaderAndIDs(it->second.first);\r\n+            MaybeSetPeerAsAnnouncingHeaderAndIDs(/*nodeid=*/ it->second.first);\r\n         }\r\n```\r\n",
      "commit_id" : "3aba63158a388047a114b34a73728201b5444712",
      "created_at" : "2021-06-04T18:41:23Z",
      "diff_hunk" : "@@ -825,12 +825,27 @@ void PeerManagerImpl::MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid)\n         return;\n     }\n     if (nodestate->fProvidesHeaderAndIDs) {\n+        int num_outbound_hb_peers = 0;\n         for (std::list<NodeId>::iterator it = lNodesAnnouncingHeaderAndIDs.begin(); it != lNodesAnnouncingHeaderAndIDs.end(); it++) {\n             if (*it == nodeid) {\n                 lNodesAnnouncingHeaderAndIDs.erase(it);\n                 lNodesAnnouncingHeaderAndIDs.push_back(nodeid);\n                 return;\n             }\n+            CNodeState *state = State(*it);\n+            if (state != nullptr && !state->m_is_inbound) ++num_outbound_hb_peers;\n+        }\n+        if (nodestate->m_is_inbound) {\n+            // If we're adding an inbound HB peer, make sure we're not removing\n+            // our last outbound HB peer in the process.\n+            if (lNodesAnnouncingHeaderAndIDs.size() >= 3 && num_outbound_hb_peers == 1) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22147#discussion_r645778792",
      "id" : 645778792,
      "line" : 841,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NTc3ODc5Mg==",
      "original_commit_id" : "6efbcec4ded6116a42d2783c96c60ef0f255a1b2",
      "original_line" : 841,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 17,
      "pull_request_review_id" : 676572076,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22147",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-04T20:39:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/645778792",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK 6efbcec\r\n\r\nAs jonatack mentioned, I think extending the existing functional test would be good.",
      "created_at" : "2021-06-06T18:04:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22147#issuecomment-855438190",
      "id" : 855438190,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22147",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1NTQzODE5MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-06T18:04:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/855438190",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/15145615?v=4",
         "events_url" : "https://api.github.com/users/Crypt-iQ/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypt-iQ/followers",
         "following_url" : "https://api.github.com/users/Crypt-iQ/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypt-iQ/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypt-iQ",
         "id" : 15145615,
         "login" : "Crypt-iQ",
         "node_id" : "MDQ6VXNlcjE1MTQ1NjE1",
         "organizations_url" : "https://api.github.com/users/Crypt-iQ/orgs",
         "received_events_url" : "https://api.github.com/users/Crypt-iQ/received_events",
         "repos_url" : "https://api.github.com/users/Crypt-iQ/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypt-iQ/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypt-iQ/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypt-iQ"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. It seems reasonable to protect one outbound peer as an HB compact block source.\r\n\r\nI agree with @jonatack and @Crypt-iQ that it'd be good to see a test for this new behaviour.\r\n\r\nI've always found the `MaybeSetPeerAsAnnouncingHeaderAndIDs()` logic to be strangely convoluted and difficult to follow - is there a good reason to recursively call into `ForNode()` instead of just calling it serially to first switch off hb for one node and then enable it for the other? If we did that, then this logic would be a lot easier to read - we wouldn't need to `std::swap` elements in a list only to later pop off the front of that list.",
      "created_at" : "2021-06-07T10:48:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22147#issuecomment-855821435",
      "id" : 855821435,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22147",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1NTgyMTQzNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-07T10:48:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/855821435",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I agree a test would be nice -- I'm not planning to write one myself, but if someone contributes one I'd be happy to include it here.\r\n\r\n> I've always found the MaybeSetPeerAsAnnouncingHeaderAndIDs() logic to be strangely convoluted and difficult to follow - is there a good reason to recursively call into ForNode() instead of just calling it serially to first switch off hb for one node and then enable it for the other? If we did that, then this logic would be a lot easier to read - we wouldn't need to std::swap elements in a list only to later pop off the front of that list.\r\n\r\nI don't know for sure, but my guess is that it's easiest to reason about the logic if the substitution of going from one HB peer to another all happens within one lock acquisition?  At any rate, I think the real problem with readability is having `ForNode()` at all; its existence implies that our model for how net and net_processing interact is broken (see eg #11604).  I think the goal is to eventually refactor all the code like this so that we don't have `ForNode()` or `ForEachNode()` in our code anymore, so I don't think there's much value in refactoring the existing logic here just to have it rewritten in the future.",
      "created_at" : "2021-06-07T13:00:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22147#issuecomment-855904105",
      "id" : 855904105,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22147",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1NTkwNDEwNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-07T13:00:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/855904105",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Here is an RPC-based test for compact blocks HB selection: https://github.com/sipa/bitcoin/commits/sdaftuar-2021-06-reserve-outbound-hb",
      "created_at" : "2021-06-09T01:05:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22147#issuecomment-857293997",
      "id" : 857293997,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22147",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1NzI5Mzk5Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-09T01:05:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/857293997",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@sipa Thanks, I've cherry-picked that commit onto this branch.",
      "created_at" : "2021-06-09T11:27:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22147#issuecomment-857615734",
      "id" : 857615734,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22147",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1NzYxNTczNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-09T11:27:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/857615734",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22147#discussion_r648251055"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/648251055"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This member variable is unused.",
      "commit_id" : "3aba63158a388047a114b34a73728201b5444712",
      "created_at" : "2021-06-09T12:26:52Z",
      "diff_hunk" : "@@ -0,0 +1,95 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test compact blocks HB selection logic.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class CompactBlocksConnectionTest(BitcoinTestFramework):\n+    \"\"\"Test class for verifying selection of HB peer connections.\"\"\"\n+\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 6\n+        self.connection_ids = {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22147#discussion_r648251055",
      "id" : 648251055,
      "line" : 17,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0ODI1MTA1NQ==",
      "original_commit_id" : "3aba63158a388047a114b34a73728201b5444712",
      "original_line" : 17,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_hb.py",
      "position" : 17,
      "pull_request_review_id" : 679583918,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22147",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-09T12:26:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/648251055",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22147#discussion_r648427253"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/648427253"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oh, indeed. Leftover from an earlier iteration.",
      "commit_id" : "3aba63158a388047a114b34a73728201b5444712",
      "created_at" : "2021-06-09T15:30:20Z",
      "diff_hunk" : "@@ -0,0 +1,95 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test compact blocks HB selection logic.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class CompactBlocksConnectionTest(BitcoinTestFramework):\n+    \"\"\"Test class for verifying selection of HB peer connections.\"\"\"\n+\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 6\n+        self.connection_ids = {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22147#discussion_r648427253",
      "id" : 648427253,
      "in_reply_to_id" : 648251055,
      "line" : 17,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0ODQyNzI1Mw==",
      "original_commit_id" : "3aba63158a388047a114b34a73728201b5444712",
      "original_line" : 17,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_hb.py",
      "position" : 17,
      "pull_request_review_id" : 679817949,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22147",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-09T15:30:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/648427253",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22147#discussion_r648524486"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/648524486"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Made a few style improvements to the commit in https://github.com/sipa/bitcoin/commits/sdaftuar-2021-06-reserve-outbound-hb",
      "commit_id" : "3aba63158a388047a114b34a73728201b5444712",
      "created_at" : "2021-06-09T17:31:19Z",
      "diff_hunk" : "@@ -0,0 +1,95 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test compact blocks HB selection logic.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class CompactBlocksConnectionTest(BitcoinTestFramework):\n+    \"\"\"Test class for verifying selection of HB peer connections.\"\"\"\n+\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 6\n+        self.connection_ids = {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22147#discussion_r648524486",
      "id" : 648524486,
      "in_reply_to_id" : 648251055,
      "line" : 17,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0ODUyNDQ4Ng==",
      "original_commit_id" : "3aba63158a388047a114b34a73728201b5444712",
      "original_line" : 17,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_hb.py",
      "position" : 17,
      "pull_request_review_id" : 679948123,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22147",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-09T17:31:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/648524486",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22147#discussion_r649232972"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/649232972"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, cherry-picked the latest commit on that branch.",
      "commit_id" : "30aee2dfe671b347438c1c327c6f79edfacff1ce",
      "created_at" : "2021-06-10T14:23:24Z",
      "diff_hunk" : "@@ -0,0 +1,95 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test compact blocks HB selection logic.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class CompactBlocksConnectionTest(BitcoinTestFramework):\n+    \"\"\"Test class for verifying selection of HB peer connections.\"\"\"\n+\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 6\n+        self.connection_ids = {}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22147#discussion_r649232972",
      "id" : 649232972,
      "in_reply_to_id" : 648251055,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0OTIzMjk3Mg==",
      "original_commit_id" : "3aba63158a388047a114b34a73728201b5444712",
      "original_line" : 17,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_hb.py",
      "position" : null,
      "pull_request_review_id" : 680852767,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22147",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-10T14:23:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/649232972",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22147#discussion_r650138822"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650138822"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If you touch this branch again, consider using f-strings for string formatting (https://github.com/bitcoin/bitcoin/blob/master/test/functional/README.md#style-guidelines)",
      "commit_id" : "30aee2dfe671b347438c1c327c6f79edfacff1ce",
      "created_at" : "2021-06-11T16:58:36Z",
      "diff_hunk" : "@@ -0,0 +1,97 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test compact blocks HB selection logic.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+\n+class CompactBlocksConnectionTest(BitcoinTestFramework):\n+    \"\"\"Test class for verifying selection of HB peer connections.\"\"\"\n+\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 6\n+\n+    def peer_info(self, from_node, to_node):\n+        \"\"\"Query from_node for its getpeerinfo about to_node.\"\"\"\n+        for peerinfo in self.nodes[from_node].getpeerinfo():\n+            if \"(testnode%i)\" % to_node in peerinfo['subver']:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22147#discussion_r650138822",
      "id" : 650138822,
      "line" : 21,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MDEzODgyMg==",
      "original_commit_id" : "30aee2dfe671b347438c1c327c6f79edfacff1ce",
      "original_line" : 21,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks_hb.py",
      "position" : 21,
      "pull_request_review_id" : 682049522,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22147",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-11T16:58:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650138822",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "My node at bitcoin.sipa.be currently has all 3 HB connections on inbounds (it has 250 connections).",
      "created_at" : "2021-06-15T17:08:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22147#issuecomment-861676412",
      "id" : 861676412,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22147",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MTY3NjQxMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-15T17:08:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/861676412",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@sipa thanks -- good to hear about different peer topologies. Am probably restarting too often (for testing pulls) to see anything close to that many inbounds.",
      "created_at" : "2021-06-15T17:14:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22147#issuecomment-861680709",
      "id" : 861680709,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22147",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MTY4MDcwOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-15T17:14:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/861680709",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 30aee2dfe671b347438c1c327c6f79edfacff1ce\r\n\r\nReviewed code and checked that the test fails on master but passes with this PR.",
      "created_at" : "2021-06-15T18:21:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22147#issuecomment-861731677",
      "id" : 861731677,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22147",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MTczMTY3Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-15T18:21:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/861731677",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code ACK 30aee2dfe\r\n\r\nOur last oubound HB compact block peer could still be evicted under our CHAIN_SYNC_TIMEOUT/EXTRA_PEER_CHECK_INTERVAL logics if it appears slow on block-delivery. Hitting this eviction on our side would require from an attacker to control our peer's block-relay, assuming this peer's implementation has the same mitigations in place against adversarial peers, it sounds hard to achieve.",
      "created_at" : "2021-06-16T15:23:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22147#issuecomment-862473546",
      "id" : 862473546,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22147",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MjQ3MzU0Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-16T15:23:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/862473546",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. I agree with protecting last outbound HB peer.",
      "created_at" : "2021-06-18T09:47:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22147#issuecomment-863910719",
      "id" : 863910719,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22147",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MzkxMDcxOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-18T09:47:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/863910719",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   }
]
