{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "NONE",
   "body" : "**Issue**\r\n\r\nIn Bitcoin Core you cannot spend unconfirmed UTXO (except using `createrawtransaction` or `createpsbt` in CLI) and if `avoidpartialspends=1` UTXOs will grouped by addresses. So an attacker can send small amounts in Tx1(100sat/vByte) and Tx2(1sat/vByte) to address A. If only one of the UTXO (Tx1) associated with address A is spent then it can be assumed the victim is using Bitcoin Core wallet.\r\n\r\nIf `avoidpartialspends=0` (default) then its easier to identify, get more information about victim's addresses because other wallets do the grouping by default.\r\n\r\n**Expected behavior**\r\n\r\n`avoidpartialspends=1` should be default IMO\r\n\r\n1. If 'reused address' group has an unconfirmed UTXO, then the whole group is unconfirmed.\r\n2. Users should be able to spend unconfirmed UTXO\r\n\r\nIf we only fix 1, attacker can do more than just fingerprinting because users will be unable to spend from addresses used in attack except if they are good with Bitcoin Core RPCs like `createrawtransaction` or `createpsbt`. Or we can consider it same as Joinmarket in which any deposit to an already-used address is freezed by default.\r\n\r\nIf we only fix 2, it may help but not sure if enough people will agree to such change based on https://github.com/bitcoin-core/gui/issues/242#issuecomment-802666743\r\n\r\n**Actual behavior**\r\n\r\nExamples of few transactions in different wallets (PoC):\r\n\r\nBitcoin Core: \r\n`e710968190ce5ee3d4a23c5c2773ae227baddbe8b2221a6677f46d030cba6741` (using GUI)\r\n`82d3180b7f6bd29acf8c21c2b6cfdc2f9afa4660b5abd53f2536e2741b5e221e` (using [CLI](https://pastebin.com/raw/Cm39rsPt))\r\n\r\nSamourai: `60b80ecace4d1357f797b1d62eb0f514a57779fc5d37256f8256e5be229f9190`\r\nElectrum: `35ce2d882eaf870011002958351aef7ef882720116c8abbb9d5b68d97d490d28`\r\nWasabi: `35ce2d882eaf870011002958351aef7ef882720116c8abbb9d5b68d97d490d28`\r\n\r\n**To reproduce**\r\n\r\n1. Create a new wallet\r\n2. Create new receiving address\r\n3. Send 0.01 to address returned in (2) and wait for 1 confirmation\r\n4. Send 0.01 to address returned in (2)\r\n5. Send 0.008 to a random address \r\n\r\n**System information**\r\n\r\nBitcoin Core v0.21.1\r\n\r\n**Other information**\r\n\r\nThere are other things which may help in wallet fingerprinting: version, locktime, rbf, fee estimation, change address, address type etc. but I wanted to focus on `avoidpartialspends` in this issue.\r\n\r\nSending small amounts in more than 10 transactions to same address can also help in fingerprinting as there are no such max limits in lot of other wallets. OUTPUT_GROUP_MAX_ENTRIES will be increased to 100 if PR: https://github.com/bitcoin/bitcoin/pull/18418 is merged which makes the attack costly but still worth trying depending on the victim, attacker's goal and money. IMO there should not be any limit like other wallets or let the users decide. Bitcoin Core with default settings is even easier to attack because other wallets that I mentioned above use the groups/buckets by default.\r\n",
   "closed_at" : "2022-08-11T15:25:58Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
      "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
      "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/MarcoFalke",
      "id" : 6399679,
      "login" : "MarcoFalke",
      "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
      "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
      "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
      "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/MarcoFalke"
   },
   "comments" : 13,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22018/comments",
   "created_at" : "2021-05-21T21:45:22Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22018/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/22018",
   "id" : 898570940,
   "labels" : [],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22018/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWU4OTg1NzA5NDA=",
   "number" : 22018,
   "performed_via_github_app" : null,
   "reactions" : {
      "+1" : 1,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 1,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 2,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22018/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "state_reason" : "completed",
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22018/timeline",
   "title" : "Wallet fingerprinting and `avoidpartialspends`",
   "updated_at" : "2022-08-11T15:25:59Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22018",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/10137?v=4",
      "events_url" : "https://api.github.com/users/ghost/events{/privacy}",
      "followers_url" : "https://api.github.com/users/ghost/followers",
      "following_url" : "https://api.github.com/users/ghost/following{/other_user}",
      "gists_url" : "https://api.github.com/users/ghost/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/ghost",
      "id" : 10137,
      "login" : "ghost",
      "node_id" : "MDQ6VXNlcjEwMTM3",
      "organizations_url" : "https://api.github.com/users/ghost/orgs",
      "received_events_url" : "https://api.github.com/users/ghost/received_events",
      "repos_url" : "https://api.github.com/users/ghost/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/ghost/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/ghost/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/ghost"
   }
}
