{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "This PR adds documentation for User-Space, Statically Defined Tracing (USDT) as well as three tracepoints (including documentation and usage examples).\r\n\r\n## Context\r\nThe `TRACEx` macros for tracepoints and build system changes for USDT were merged in https://github.com/bitcoin/bitcoin/pull/19866 earlier this year. Issue https://github.com/bitcoin/bitcoin/issues/20981 contains discussion about potential tracepoints and guidelines for adding them (also documented with this PR). USDT was a topic in a [core-dev-meeting discussion](https://bitcoin.jonasschnelli.ch/ircmeetings/logs/bitcoin-core-dev/2021/bitcoin-core-dev.2021-01-21-19.00.moin.txt) on 21st Jan, 2021.\r\n\r\n- [collabora.com: An eBPF overview, part 1: Introduction](https://www.collabora.com/news-and-blog/blog/2019/04/05/an-ebpf-overview-part-1-introduction/)\r\n- [collabora.com: An eBPF overview, part 2: Machine & bytecode](https://www.collabora.com/news-and-blog/blog/2019/04/15/an-ebpf-overview-part-2-machine-and-bytecode/)\r\n- [Brendan D. Gregg's blog posts, and book on on eBPF](http://www.brendangregg.com/)\r\n- [Brendan D. Gregg: Linux bcc/BPF Node.js USDT Tracing](http://www.brendangregg.com/blog/2016-10-12/linux-bcc-nodejs-usdt.html)\r\n\r\n\r\n## USDT? Stablecoin?\r\n\r\nUser-space, Statically Defined Tracing (USDT) allows for more observability during development, debugging, code review, and production usage. The tracepoints make it possible to keep track of custom statistics and enable detailed monitoring of otherwise hidden internals and have little to no performance impact when unused. Linux kernels (4.x or newer) can hook into the tracepoints and execute [eBPF] programs in a kernel VM once the tracepoint is called.\r\n\r\nThis PR includes, for example, tracepoints for in- and outbound P2P messages.\r\n\r\n```\r\nUSDT and eBPF Overview\r\n======================\r\n\r\n                ââââââââââââââââââââ            ââââââââââââââââ\r\n                â tracing script   â            â bitcoind     â\r\n                â==================â      2.    â==============â\r\n                â  eBPF  â tracing â      hooks â              â\r\n                â  code  â logic   â      intoâââ¤âºtracepoint 1ââ¼ââââ 3.\r\n                ââââââ¬ââââ´âââ²âââââââ          âââ¤âºtracepoint 2 â   â pass args\r\n            1.       â      â 4.              â â ...          â   â to eBPF\r\n    User    compiles â      â pass data to    â ââââââââââââââââ   â program\r\n    Space    & loads â      â tracing script  â                    â\r\n    ââââââââââââââââââ¼âââââââ¼ââââââââââââââââââ¼âââââââââââââââââââââ¼âââ\r\n    Kernel           â      â                 â                    â\r\n    Space       ââââ¬ââ¼âââââââ´ââââââââââââââââââ´âââââââââââââ       â\r\n                â  â  eBPF program                         âââââââââ\r\n                â  âââââââââââââââââââââââââââââââââââââââââ¤\r\n                â eBPF kernel Virtual Machine (sandboxed)  â\r\n                ââââââââââââââââââââââââââââââââââââââââââââ\r\n\r\n1. The tracing script compiles the eBPF code and loads the eBFP program into a kernel VM\r\n2. The eBPF program hooks into one or more tracepoints\r\n3. When the tracepoint is called, the arguments are passed to the eBPF program\r\n4. The eBPF program processes the arguments and returns data to the tracing script\r\n```\r\n\r\nThe two main [eBPF] front-ends with support for USDT are [bpftrace] an [BPF Compiler Collection (BCC)]. BCC is used for complex tools and daemons and `bpftrace` is preferred for one-liners and shorter scripts. Example tracing scripts for both are provided with this PR.\r\n\r\n[eBPF]: https://ebpf.io/\r\n[bpftrace]: https://github.com/iovisor/bpftrace\r\n[BPF Compiler Collection (BCC)]: https://github.com/iovisor/bcc\r\n\r\nThis PR adds three tracepoints:\r\n- `net:inbound_message`\r\n- `net:outbound_message`\r\n- `valildation:block_connected`\r\n\r\nSee `doc/tracing.md` and `contrib/tracing/` for documentation and example tracing scripts. \r\n\r\n## Open Questions (Not in scope for this PR)\r\n-  How to use these tracepoints under macOS?\r\n-  Release builds with USDT support?\r\n-  Should and can the tracepoints be automatically tested?\r\n\r\n## Todo (before undraft)\r\n- [x] bcc example showing how to read raw P2P messages up to 32kb\r\n- [x] document that you need `sys/sdt.h` from `systemtap` for USDT support in Bitcoin Core (`apt install systemtap-sdt-dev` on debian-like). See https://github.com/bitcoin/bitcoin/pull/19866/commits/933ab8a720cb9b3341adec4109cffb6dc5b322a5\r\n- [ ] release notes?\r\n",
   "closed_at" : "2021-07-27T17:47:55Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   },
   "comments" : 17,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22006/comments",
   "created_at" : "2021-05-20T17:16:04Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22006/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/22006",
   "id" : 897154083,
   "labels" : [
      {
         "color" : "d2db6d",
         "default" : false,
         "description" : "",
         "id" : 493267104,
         "name" : "Needs release note",
         "node_id" : "MDU6TGFiZWw0OTMyNjcxMDQ=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Needs%20release%20note"
      },
      {
         "color" : "5319e7",
         "default" : false,
         "description" : "",
         "id" : 241832923,
         "name" : "Utils/log/libs",
         "node_id" : "MDU6TGFiZWwyNDE4MzI5MjM=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Utils/log/libs"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22006/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDExOlB1bGxSZXF1ZXN0NjQ5MTg2NzE0",
   "number" : 22006,
   "performed_via_github_app" : null,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/22006.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22006",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/22006.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22006"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "tracing: first tracepoints and documentation on User-Space, Statically Defined Tracing (USDT)",
   "updated_at" : "2021-07-27T17:47:55Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22006",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/19157360?v=4",
      "events_url" : "https://api.github.com/users/0xB10C/events{/privacy}",
      "followers_url" : "https://api.github.com/users/0xB10C/followers",
      "following_url" : "https://api.github.com/users/0xB10C/following{/other_user}",
      "gists_url" : "https://api.github.com/users/0xB10C/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/0xB10C",
      "id" : 19157360,
      "login" : "0xB10C",
      "node_id" : "MDQ6VXNlcjE5MTU3MzYw",
      "organizations_url" : "https://api.github.com/users/0xB10C/orgs",
      "received_events_url" : "https://api.github.com/users/0xB10C/received_events",
      "repos_url" : "https://api.github.com/users/0xB10C/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/0xB10C/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/0xB10C/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/0xB10C"
   }
}
