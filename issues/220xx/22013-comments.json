[
   {
      "author_association" : "MEMBER",
      "body" : "utACK fe3d17d\r\n\r\n`IsFullOutboundConn()` indeed seems the right replacement for `IsOutboundOrBlockRelayConn()`, given their respective definitions:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/eb4df9a628bdcdd1333c7fa4fb23c73df9642902/src/net.h#L468-L485",
      "created_at" : "2021-05-21T13:37:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22013#issuecomment-845956468",
      "id" : 845956468,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22013",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NTk1NjQ2OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-21T13:37:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/845956468",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Oh good catch.\r\n\r\nConcept ACK",
      "created_at" : "2021-05-21T19:57:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22013#issuecomment-846220688",
      "id" : 846220688,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22013",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NjIyMDY4OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-21T19:57:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/846220688",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK fe3d17df04decc4e856121eb311636977d60f80f, this impacts the very common case where we stop/start a node, persisting anchors & have a non-empty addrman (although, to be clear, wouldn't be particularly problematic in the common cases where the addrman has valid addresses)\r\n\r\nI tried to figure out if I could write a functional test to cover this code path, but seems like a no go- I can add outbound-block-relay only connections & then shut down the node to persist them to anchors, but they can't reconnect before hitting `ThreadDNSAddressSeed` on startup unless we do something more invasive to the test framework, which doesn't seem worth it. ",
      "created_at" : "2021-05-21T23:22:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22013#issuecomment-846307024",
      "id" : 846307024,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22013",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NjMwNzAyNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-21T23:24:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/846307024",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This is not the first bug in p2p bootstrap behaviour (#19795, #15434), so in due time having a functional test for this would be nice.",
      "created_at" : "2021-05-22T12:07:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22013#issuecomment-846398960",
      "id" : 846398960,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22013",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NjM5ODk2MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-22T12:07:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/846398960",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK fe3d17df04decc4e856121eb311636977d60f80f\r\n\r\n> I tried to figure out if I could write a functional test to cover this code path, but seems like a no go- I can add outbound-block-relay only connections & then shut down the node to persist them to anchors, but they can't reconnect before hitting `ThreadDNSAddressSeed` on startup unless we do something more invasive to the test framework, which doesn't seem worth it.\r\n\r\nI think the main issue is that this code is inside of a loop over the DNS seeds, and regtest doesn't have any. If there was a  unreachable dummy dns seed for regtest, this could be tested: \r\n`ThreadDNSAddressSeed` sleeps for 11s/5min depending on addrman size before querying, during this time one could add block-relay-only or full outbound peers and test that the behavior is different e.g. by looking at log messages.\r\n",
      "created_at" : "2021-05-22T14:43:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22013#issuecomment-846417811",
      "id" : 846417811,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22013",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NjQxNzgxMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-22T14:58:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/846417811",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK\r\n\r\nChange in https://github.com/bitcoin/bitcoin/commit/fe3d17df04decc4e856121eb311636977d60f80f makes sense however I was not able to reproduce the issue by compiling master branch. Not sure if I am testing it correctly.\r\n\r\n1. DNS seeding is skipped if I have 0 block relay connections in `anchors.dat` but few full relay connections in `peers.dat`\r\n\r\n```\r\n2021-05-22T15:04:15Z New outbound peer connected: version: 70015, blocks=1976272, peer=0 (outbound-full-relay)\r\n2021-05-22T15:04:19Z Synchronizing blockheaders, height: 19999 (~4.15%)\r\n2021-05-22T15:04:21Z New outbound peer connected: version: 70015, blocks=1976272, peer=1 (outbound-full-relay)\r\n2021-05-22T15:04:22Z Synchronizing blockheaders, height: 21999 (~4.58%)\r\n2021-05-22T15:04:25Z P2P peers available. Skipped DNS seeding.\r\n```\r\n2. Deleted everything from `testnet3` directory, compiled master branch and run `bitcoind` with `testnet=1`\r\n3. 2 outbound block-relay-only peer addresses saved in anchors.dat\r\n```2021-05-22T14:54:04Z 0 block-relay-only anchors will be tried for connections.\r\n2021-05-22T14:54:04Z init message: Starting network threadsâ¦\r\n2021-05-22T14:54:04Z init message: Done loading\r\n2021-05-22T14:54:04Z msghand thread start\r\n2021-05-22T14:54:04Z opencon thread start\r\n2021-05-22T14:54:04Z addcon thread start\r\n2021-05-22T14:54:04Z dnsseed thread start\r\n2021-05-22T14:54:04Z Loading addresses from DNS seed testnet-seed.bluematt.me\r\n2021-05-22T14:54:04Z net thread start\r\n2021-05-22T14:54:05Z Loading addresses from DNS seed testnet-seed.bitcoin.jonasschnelli.ch\r\n2021-05-22T14:54:06Z Loading addresses from DNS seed seed.testnet.bitcoin.sprovoost.nl\r\n2021-05-22T14:54:08Z Loading addresses from DNS seed seed.tbtc.petertodd.org\r\n2021-05-22T14:54:08Z 112 addresses found from DNS seeds\r\n2021-05-22T14:54:08Z dnsseed thread exit\r\n2021-05-22T14:54:27Z New outbound peer connected: version: 70015, blocks=1976271, peer=0 (outbound-full-relay)\r\n\r\n\r\n\r\n2021-05-22T15:14:33Z DumpAnchors: Flush 2 outbound block-relay-only peer addresses to anchors.dat completed (0.00s)\r\n```\r\n\r\n4. Delete `peers.dat` run `bitcoind` again\r\n\r\n```\r\n2021-05-22T15:19:35Z Loaded 2 addresses from \"anchors.dat\"\r\n2021-05-22T15:19:35Z 2 block-relay-only anchors will be tried for connections.\r\n2021-05-22T15:19:35Z init message: Starting network threadsâ¦\r\n2021-05-22T15:19:35Z net thread start\r\n2021-05-22T15:19:35Z dnsseed thread start\r\n2021-05-22T15:19:35Z Loading addresses from DNS seed seed.tbtc.petertodd.org\r\n2021-05-22T15:19:36Z addcon thread start\r\n2021-05-22T15:19:36Z opencon thread start\r\n2021-05-22T15:19:36Z init message: Done loading\r\n2021-05-22T15:19:36Z msghand thread start\r\n2021-05-22T15:19:37Z Loading addresses from DNS seed testnet-seed.bluematt.me\r\n2021-05-22T15:19:38Z Loading addresses from DNS seed seed.testnet.bitcoin.sprovoost.nl\r\n2021-05-22T15:19:38Z Loading addresses from DNS seed testnet-seed.bitcoin.jonasschnelli.ch\r\n2021-05-22T15:19:38Z New outbound peer connected: version: 70016, blocks=1976272, peer=0 (block-relay-only)\r\n2021-05-22T15:19:38Z 112 addresses found from DNS seeds\r\n2021-05-22T15:19:38Z dnsseed thread exit\r\n2021-05-22T15:19:40Z Synchronizing blockheaders, height: 507998 (~62.33%)\r\n2021-05-22T15:19:40Z New outbound peer connected: version: 70016, blocks=1976272, peer=1 (block-relay-only)\r\n```\r\n\r\n5. Restart with 2 block-relay-only anchors and few outbound full relay in `peers.dat`\r\n\r\n```\r\n2021-05-22T15:44:26Z 2 block-relay-only anchors will be tried for connections.\r\n2021-05-22T15:44:26Z init message: Starting network threadsâ¦\r\n2021-05-22T15:44:26Z init message: Done loading\r\n2021-05-22T15:44:26Z addcon thread start\r\n2021-05-22T15:44:26Z dnsseed thread start\r\n2021-05-22T15:44:26Z Waiting 300 seconds before querying DNS seeds.\r\n2021-05-22T15:44:26Z opencon thread start\r\n2021-05-22T15:44:26Z msghand thread start\r\n2021-05-22T15:44:26Z net thread start\r\n2021-05-22T15:44:29Z New outbound peer connected: version: 70016, blocks=1976274, peer=1 (block-relay-only)\r\n2021-05-22T15:44:29Z New outbound peer connected: version: 70016, blocks=1976274, peer=0 (block-relay-only)\r\n2021-05-22T15:44:29Z New outbound peer connected: version: 70015, blocks=1976274, peer=2 (outbound-full-relay)\r\n2021-05-22T15:44:32Z Synchronizing blockheaders, height: 929997 (~79.16%)\r\n2021-05-22T15:44:36Z Synchronizing blockheaders, height: 931997 (~79.19%)\r\n2021-05-22T15:44:37Z P2P peers available. Skipped DNS seeding.\r\n```\r\n\r\n",
      "created_at" : "2021-05-22T15:52:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22013#issuecomment-846427080",
      "id" : 846427080,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22013",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NjQyNzA4MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-22T15:52:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/846427080",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@prayank23 In order to hit this on testnet, you need to have a non-empty addrman, but with no valid addresses - the following should work if you start with empty peers.dat and two good anchors:\r\n```\r\nbitcoind --testnet -dnsseed=0 -fixedseeds=0\r\nbitcoin-cli --testnet addpeeraddress <INVALID ADDRESS> 18333\r\nbitcoin-cli --testnet stop\r\nbitcoind --testnet\r\n```\r\nIn the second run, you'll have two block-only peers but will never query a DNS seeds on master - whereas on this branch you will.",
      "created_at" : "2021-05-22T16:51:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22013#issuecomment-846434819",
      "id" : 846434819,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22013",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NjQzNDgxOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-22T16:57:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/846434819",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@mzumsande \r\n\r\n> I think the main issue is that this code is inside of a loop over the DNS seeds, and regtest doesn't have any. If there was a unreachable dummy dns seed for regtest, this could be tested:\r\nThreadDNSAddressSeed sleeps for 11s/5min depending on addrman size before querying, during this time one could add block-relay-only or full outbound peers and test that the behavior is different e.g. by looking at log messages.\r\n\r\nyup, this was the approach I took- added dummy seeds to regtest chain params & from the test made sure addrman has addresses & was asserting against log messages. the step I haven't been able to figure out is adding the connections during the sleep, with the test framework timing playing nicely with bitcoind timing. the branch is a bit of a mess, but lmk if you'd like me to clean it up and share- very possible I'm missing a viable solution! ",
      "created_at" : "2021-05-22T18:25:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22013#issuecomment-846446138",
      "id" : 846446138,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22013",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NjQ0NjEzOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-22T18:25:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/846446138",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@mzumsande these manual test instructions are quite useful; I might test it next week.\r\n\r\n@amitiuttarwar maybe mention those in the PR description, so it's a bit easier to find with `git blame` later. I often use the \"blame\" feature in Github to figure out when a line was last changed, which links to the commit, which in turn links to the pull request.",
      "created_at" : "2021-05-22T19:10:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22013#issuecomment-846451245",
      "id" : 846451245,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22013",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NjQ1MTI0NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-22T19:12:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/846451245",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@Sjors did you mean to tag @ajtowns to update OP? It's not my PR ð",
      "created_at" : "2021-05-22T19:24:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22013#issuecomment-846452732",
      "id" : 846452732,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22013",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NjQ1MjczMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-22T19:24:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/846452732",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@amitiuttarwar See https://github.com/mzumsande/bitcoin/commit/237d75472ba1f8b90c286519e48f58d07a50b431 for what I did to test this PR. But I have no idea if adding dummy seeds to regtest is viable or breaks anything... ",
      "created_at" : "2021-05-22T19:58:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22013#issuecomment-846456475",
      "id" : 846456475,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22013",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NjQ1NjQ3NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-22T19:58:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/846456475",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks @mzumsande I was able to reproduce the issue. \r\n\r\n1. Run bitcoind for few minutes and get 2 block only peers in `anchors.dat`\r\n```\r\n2021-05-23T14:13:31Z DumpAnchors: Flush 2 outbound block-relay-only peer addresses to anchors.dat completed (0.00s)\r\n```\r\n2. Delete `peers.dat`\r\n3. `bitcoind -dnsseed=0 -fixedseeds=0`\r\n4. `bitcoin-cli --testnet addpeeraddress <INVALID ADDRESS> 18333`\r\n\r\nThings that I tried in INVALID ADDRESS:\r\n\r\n```\r\nprayank@ubuntu:~$ bitcoin-cli --testnet addpeeraddress \"i11\\/^Â£||>|pÎ»<>râ¬ss\" 18333\r\n{\r\n  \"success\": false\r\n}\r\nprayank@ubuntu:~$ bitcoin-cli --testnet addpeeraddress \"invalidip\" 18333\r\n{\r\n  \"success\": false\r\n}\r\nprayank@ubuntu:~$ bitcoin-cli --testnet addpeeraddress \"8.8.8.8.8.8.8\" 18333\r\n{\r\n  \"success\": false\r\n}\r\nprayank@ubuntu:~$ bitcoin-cli --testnet addpeeraddress \"8.8.8.8\" 18333\r\n{\r\n  \"success\": true\r\n}\r\n```\r\n5. bitcoin-cli stop\r\n6. bitcoind (run for few minutes)\r\n7. bitcoin-cli `getpeerfinfo`: 2 block-relay-only connections\r\n8. bitcoin-cli stop\r\n\r\ndebug.log (DNS seeding was skipped because of peer=1 which is a block-relay-only connection)\r\n\r\n```\r\n2021-05-23T14:29:24Z New outbound peer connected: version: 70016, blocks=1976375, peer=1 (block-relay-only)\r\n\r\n2021-05-23T14:29:25Z sending getdata (577 bytes) peer=1\r\n2021-05-23T14:29:28Z connection attempt to 8.8.8.8:18333 timed out\r\n2021-05-23T14:29:29Z trying connection 8.8.8.8:18333 lastseen=0.0hrs\r\n2021-05-23T14:29:32Z received: block (745874 bytes) peer=1\r\n2021-05-23T14:29:32Z P2P peers available. Skipped DNS seeding.\r\n2021-05-23T14:29:32Z dnsseed thread exit\r\n```\r\n\r\nLogs had lot of connections attempts for invalid peer:\r\n\r\n```\r\n2021-05-23T14:37:05Z connection attempt to 8.8.8.8:18333 timed out\r\n2021-05-23T14:37:06Z trying connection 8.8.8.8:18333 lastseen=0.1hrs\r\n```\r\nbitcoin.conf\r\n\r\n```\r\ntestnet=1\r\ndebug=net\r\n```",
      "created_at" : "2021-05-23T16:15:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22013#issuecomment-846587816",
      "id" : 846587816,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22013",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NjU4NzgxNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-23T16:15:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/846587816",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I retarted bitcoind few times to see if something changes. It recovered, used DNS seed and had [outbound full relay connections](https://pastebin.com/raw/FYRAcSX8).\r\n\r\n```\r\n2021-05-23T17:03:38Z connection attempt to 8.8.8.8:18333 timed out\r\n2021-05-23T17:03:39Z trying connection 8.8.8.8:18333 lastseen=1.0hrs\r\n2021-05-23T17:03:41Z Loading addresses from DNS seed testnet-seed.bluematt.me\r\n```\r\n```\r\n2021-05-23T17:04:39Z DumpAnchors: Flush 1 outbound block-relay-only peer addresses to anchors.dat started\r\n2021-05-23T17:04:39Z DumpAnchors: Flush 1 outbound block-relay-only peer addresses to anchors.dat completed (0.00s)\r\n2021-05-23T17:04:39Z disconnecting peer=0\r\n2021-05-23T17:04:39Z Cleared nodestate for peer=0\r\n2021-05-23T17:04:39Z disconnecting peer=1\r\n2021-05-23T17:04:39Z Cleared nodestate for peer=1\r\n2021-05-23T17:04:39Z disconnecting peer=2\r\n2021-05-23T17:04:39Z Cleared nodestate for peer=2\r\n2021-05-23T17:04:39Z disconnecting peer=3\r\n2021-05-23T17:04:39Z Cleared nodestate for peer=3\r\n2021-05-23T17:04:39Z disconnecting peer=4\r\n2021-05-23T17:04:39Z Cleared nodestate for peer=4\r\n```\r\n\r\n",
      "created_at" : "2021-05-23T17:18:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22013#issuecomment-846596143",
      "id" : 846596143,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22013",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NjU5NjE0Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-23T17:29:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/846596143",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "opened #22098 based on the convo here. huge props @mzumsande for figuring out the technique for timing around DNS logic with block-relay-only vs full-outbound connections ð\r\n\r\nthe second commit on that PR 3548b571521b3f0693bbba39677344a626a406c5 fails prior to these changes. ",
      "created_at" : "2021-05-28T22:13:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22013#issuecomment-850699986",
      "id" : 850699986,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22013",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1MDY5OTk4Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-28T22:13:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/850699986",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   }
]
