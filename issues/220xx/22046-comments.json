[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Personally I find the existing version easier to reason about. I think I'd prefer leaving this as-is, especially considering that this is consensus critical code :)",
      "created_at" : "2021-05-24T19:49:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22046#issuecomment-847292108",
      "id" : 847292108,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22046",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NzI5MjEwOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-24T20:06:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/847292108",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22046#discussion_r638264272"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22046"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638264272"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Just `&& !mutation` here?",
      "commit_id" : "d783fb0bfa411ae6dbe32f5df729537a5a0bef8d",
      "created_at" : "2021-05-24T20:53:55Z",
      "diff_hunk" : "@@ -43,11 +43,11 @@\n \n \n uint256 ComputeMerkleRoot(std::vector<uint256> hashes, bool* mutated) {\n-    bool mutation = false;\n+    if (mutated) *mutated = false;\n     while (hashes.size() > 1) {\n-        if (mutated) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22046#discussion_r638264272",
      "id" : 638264272,
      "line" : 48,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODI2NDI3Mg==",
      "original_commit_id" : "d783fb0bfa411ae6dbe32f5df729537a5a0bef8d",
      "original_line" : 48,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/consensus/merkle.cpp",
      "position" : 7,
      "pull_request_review_id" : 667159738,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22046",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-24T20:57:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638264272",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22046#discussion_r638529865"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22046"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638529865"
         }
      },
      "author_association" : "NONE",
      "body" : "There are two optimizations included here:\r\n1. stop wasting computation time once mutated gets set\r\n2. use the parameter value directly instead of local copy\r\n\r\nWhile the second saves one compare+assign operation and might be insignificant, the first effectively saves useless processing as the result is already known.\r\n\r\nTo me it is not only optimization but causing a trigger that something was forgotten when reading the code.\r\n\r\n@practicalswift : would you support @promag's suggestion to limit the proposal to include only the first part, which would limit the change to one line and gain the most potential savings, or do you oppose the change generally?",
      "commit_id" : "d783fb0bfa411ae6dbe32f5df729537a5a0bef8d",
      "created_at" : "2021-05-25T07:33:55Z",
      "diff_hunk" : "@@ -43,11 +43,11 @@\n \n \n uint256 ComputeMerkleRoot(std::vector<uint256> hashes, bool* mutated) {\n-    bool mutation = false;\n+    if (mutated) *mutated = false;\n     while (hashes.size() > 1) {\n-        if (mutated) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22046#discussion_r638529865",
      "id" : 638529865,
      "in_reply_to_id" : 638264272,
      "line" : 48,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODUyOTg2NQ==",
      "original_commit_id" : "d783fb0bfa411ae6dbe32f5df729537a5a0bef8d",
      "original_line" : 48,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/consensus/merkle.cpp",
      "position" : 7,
      "pull_request_review_id" : 667485097,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22046",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-25T07:33:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638529865",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1355386?v=4",
         "events_url" : "https://api.github.com/users/zefir-k/events{/privacy}",
         "followers_url" : "https://api.github.com/users/zefir-k/followers",
         "following_url" : "https://api.github.com/users/zefir-k/following{/other_user}",
         "gists_url" : "https://api.github.com/users/zefir-k/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/zefir-k",
         "id" : 1355386,
         "login" : "zefir-k",
         "node_id" : "MDQ6VXNlcjEzNTUzODY=",
         "organizations_url" : "https://api.github.com/users/zefir-k/orgs",
         "received_events_url" : "https://api.github.com/users/zefir-k/received_events",
         "repos_url" : "https://api.github.com/users/zefir-k/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/zefir-k/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/zefir-k/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/zefir-k"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Does this improve IBD speed significantly? Otherwise it might not be worth it the review effort.",
      "created_at" : "2021-05-25T07:47:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22046#issuecomment-847634497",
      "id" : 847634497,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22046",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NzYzNDQ5Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-25T07:47:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/847634497",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> Does this improve IBD speed significantly? Otherwise it might not be worth it the review effort.\r\n\r\nI reduced the change to the relevant (one-line) part, which should be trivial to review.\r\n\r\nMaybe the overall speed improvement is not significant, but the local is obvious: if the rightest-most bottom-leaf is a copy, the flag becomes true immediately, but the (then waste) checks continue for every next level up to the root.\r\n\r\nAs kernel developer I might be more waste sensitive than required here, so if you think it is not worth it, I'm fine with closing - and sorry for noise.",
      "created_at" : "2021-05-25T08:39:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22046#issuecomment-847674273",
      "id" : 847674273,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22046",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0NzY3NDI3Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-25T08:39:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/847674273",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1355386?v=4",
         "events_url" : "https://api.github.com/users/zefir-k/events{/privacy}",
         "followers_url" : "https://api.github.com/users/zefir-k/followers",
         "following_url" : "https://api.github.com/users/zefir-k/following{/other_user}",
         "gists_url" : "https://api.github.com/users/zefir-k/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/zefir-k",
         "id" : 1355386,
         "login" : "zefir-k",
         "node_id" : "MDQ6VXNlcjEzNTUzODY=",
         "organizations_url" : "https://api.github.com/users/zefir-k/orgs",
         "received_events_url" : "https://api.github.com/users/zefir-k/received_events",
         "repos_url" : "https://api.github.com/users/zefir-k/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/zefir-k/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/zefir-k/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/zefir-k"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> I don't see significant gains. I've even tried other tweaks with the same result:\r\n> \r\n\r\n\r\nThanks, the hashing cost in fact is so dominant that the comparison operation remains below measurement accuracy:\r\n```\r\n|             ns/leaf |              leaf/s |    err% |     total | benchmark\r\n|--------------------:|--------------------:|--------:|----------:|:----------\r\n|               60.88 |       16,424,775.25 |    0.1% |      0.04 | `MerkleRoot`\r\n|               60.30 |       16,584,351.40 |    0.0% |      0.04 | `MerkleRoot_no_mutation`\r\n|               60.71 |       16,471,608.02 |    0.1% |      0.04 | `MerkleRoot_patch`\r\n```\r\n... not worth it.",
      "created_at" : "2021-05-25T13:52:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22046#issuecomment-847888756",
      "id" : 847888756,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22046",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg0Nzg4ODc1Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-25T13:52:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/847888756",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1355386?v=4",
         "events_url" : "https://api.github.com/users/zefir-k/events{/privacy}",
         "followers_url" : "https://api.github.com/users/zefir-k/followers",
         "following_url" : "https://api.github.com/users/zefir-k/following{/other_user}",
         "gists_url" : "https://api.github.com/users/zefir-k/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/zefir-k",
         "id" : 1355386,
         "login" : "zefir-k",
         "node_id" : "MDQ6VXNlcjEzNTUzODY=",
         "organizations_url" : "https://api.github.com/users/zefir-k/orgs",
         "received_events_url" : "https://api.github.com/users/zefir-k/received_events",
         "repos_url" : "https://api.github.com/users/zefir-k/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/zefir-k/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/zefir-k/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/zefir-k"
      }
   }
]
