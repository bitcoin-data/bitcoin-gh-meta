[
   {
      "author_association" : "NONE",
      "body" : "Thanks for the explanation in the PR. I like your approach, but I'm wondering if this will still be accurate about `create_self_transfer`:\r\n`\"\"\"Create and return a tx with the specified fee_rate. Fee may be exact or at most one satoshi higher than needed.\"\"\"`\r\nBecause right now, using a fee rate of `Decimal(\"0.003\")` the P2PK tx will have a fee of `Decimal('0.0005025')`, but the exact fee rates should either be\r\n`Decimal('0.000504')` for `168` vbytes, or \r\n`Decimal('0.000501')` for `167` vbytes\r\n\r\nSo it seems like the fee rate won't be exact anymore unless i'm missing something. I feel like it might be a problem for some tests if `create_self_transfer` created transactions where the fee rate wasn't exactly the same as what was specified. \r\n\r\nIt's probably not an issue when no fee rate has been specified, but perhaps in the case where the user does specify a fee rate then the signature could be restricted to 71 bytes?",
      "created_at" : "2021-05-28T03:10:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22089#issuecomment-850079016",
      "id" : 850079016,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22089",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1MDA3OTAxNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-28T03:11:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/850079016",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/41220998?v=4",
         "events_url" : "https://api.github.com/users/DariusParvin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DariusParvin/followers",
         "following_url" : "https://api.github.com/users/DariusParvin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DariusParvin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DariusParvin",
         "id" : 41220998,
         "login" : "DariusParvin",
         "node_id" : "MDQ6VXNlcjQxMjIwOTk4",
         "organizations_url" : "https://api.github.com/users/DariusParvin/orgs",
         "received_events_url" : "https://api.github.com/users/DariusParvin/received_events",
         "repos_url" : "https://api.github.com/users/DariusParvin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DariusParvin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DariusParvin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DariusParvin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@DariusParvin: Thanks for reviewing, you brought up an interesting point here.\r\n\r\nIndeed, the promise \"`Fee may be exact or at most one satoshi higher than needed.`\" does currently not apply for MiniWallet transaction created in P2PK mode (and on the master branch it's obviously totally off, since the vsize was not set properly). As far as I can tell the only way to achieve this would be with a constant signature size, otherwise we have a chicken and egg situation: for creating a signature we need to have the output amount already set  (which determines the fee), but for a achieving a certain fee-rate we need to know the transaction size which is not known until the signature is created.\r\n\r\n\r\n> So it seems like the fee rate won't be exact anymore unless i'm missing something. I feel like it might be a problem for some tests if create_self_transfer created transactions where the fee rate wasn't exactly the same as what was specified.\r\n\r\nGood question, I don't know enough of the \"big picture\" of all tests to know whether having exact fees is something that is really needed (and if it really is, if the anyone-can-spend modes are not sufficient then?).\r\n\r\nI could generally think of two possible solutions:\r\n* Keep the current logic in the PR and only adapt the comment (e.g. something like \"_For anyone-can-spend outputs, the fee may be exact or at least most one satoshi higher than needed. For P2PK outputs, the fee is approximated due to varying signature size._\")\r\n* Grind signatures to always have fixed size (potentially slow since `.sign_ecdsa` has to be executed about twice on average to get a single signature), as you suggested:\r\n\r\n> It's probably not an issue when no fee rate has been specified, but perhaps in the case where the user does specify a fee rate then the signature could be restricted to 71 bytes?\r\n\r\nSince the `fee_rate` is a parameter with default value, I don't think we can tell whether the user specified an explicit fee rate or not (at least not with the current interface of `create_self_transfer()`). What I could think of though is introducing a parameter to `sign_tx` that specifies if the signature should be forced to have a fixed size (false by default), and setting it to true in the `create_self_transfer()` method. That maybe is a good compromise: for transaction created with the wallet, the fee is calculated exactly, for external uses of `.sign_tx` the signature size and fee don't matter, since the transaction probably doesn't end up in the mempool anyway, but only in blocks.\r\n",
      "created_at" : "2021-05-28T11:10:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22089#issuecomment-850342413",
      "id" : 850342413,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22089",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1MDM0MjQxMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-28T11:17:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/850342413",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #22092 (test: convert documentation into type annotations by fanquake)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-05-28T15:21:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22089#issuecomment-850493910",
      "id" : 850493910,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22089",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1MDQ5MzkxMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-28T15:21:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/850493910",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-06-07T05:43:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22089#issuecomment-855597910",
      "id" : 855597910,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22089",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1NTU5NzkxMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-07T05:43:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/855597910",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@theStack \r\n> What I could think of though is introducing a parameter to sign_tx that specifies if the signature should be forced to have a fixed size (false by default), and setting it to true in the create_self_transfer() method. That maybe is a good compromise: for transaction created with the wallet, the fee is calculated exactly, for external uses of .sign_tx the signature size and fee don't matter, since the transaction probably doesn't end up in the mempool anyway, but only in blocks.\r\n\r\nI think that's a reasonable compromise. The only thing is I think it might be better to have the default be True instead, mainly because the fee rate is quite important for a few tests (e.g. getting included in a block, replaced in the mempool, fee limits) and it could be very hard to debug if the fee rate is random between test runs.",
      "created_at" : "2021-06-07T06:34:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22089#issuecomment-855630403",
      "id" : 855630403,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22089",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1NTYzMDQwMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-07T06:34:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/855630403",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/41220998?v=4",
         "events_url" : "https://api.github.com/users/DariusParvin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DariusParvin/followers",
         "following_url" : "https://api.github.com/users/DariusParvin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DariusParvin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DariusParvin",
         "id" : 41220998,
         "login" : "DariusParvin",
         "node_id" : "MDQ6VXNlcjQxMjIwOTk4",
         "organizations_url" : "https://api.github.com/users/DariusParvin/orgs",
         "received_events_url" : "https://api.github.com/users/DariusParvin/received_events",
         "repos_url" : "https://api.github.com/users/DariusParvin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DariusParvin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DariusParvin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DariusParvin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased on master, changed `sign_tx` to create fixed-size signatures (71 bytes) by default ([as proposed by DariusParvin](https://github.com/bitcoin/bitcoin/pull/22089#issuecomment-850079016)), force-pushed and updated the PR description.\r\n\r\n> @theStack\r\n> \r\n> > What I could think of though is introducing a parameter to sign_tx that specifies if the signature should be forced to have a fixed size (false by default), and setting it to true in the create_self_transfer() method. That maybe is a good compromise: for transaction created with the wallet, the fee is calculated exactly, for external uses of .sign_tx the signature size and fee don't matter, since the transaction probably doesn't end up in the mempool anyway, but only in blocks.\r\n> \r\n> I think that's a reasonable compromise. The only thing is I think it might be better to have the default be True instead, mainly because the fee rate is quite important for a few tests (e.g. getting included in a block, replaced in the mempool, fee limits) and it could be very hard to debug if the fee rate is random between test runs.\r\n\r\n@DariusParvin: After repeatedly executing the test `feature_csv_activation.py` (the only one so far making extensive use of `sign_tx()`), I didn't see significant differences in execution time, so I guess grinding to a fixed size is okay. I agree that in a test framework it is preferrable to have reproducible results rather than squeezing out a little less execution time. If that is a concern in future test that create lots of signatures, the parameter `fixed_length` can be set to False explicitely.",
      "created_at" : "2021-06-08T18:05:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22089#issuecomment-856980842",
      "id" : 856980842,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22089",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1Njk4MDg0Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-08T18:10:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/856980842",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   }
]
