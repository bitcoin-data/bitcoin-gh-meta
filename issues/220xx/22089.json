{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "This PR is a follow-up to #21945. It aims to both fix the fee calculation for P2PK mode transactions and enable its vsize check. Currently, the latter assumes a fixed tx length, which is fine for anyone-can-spend txs but doesn't apply to P2PK output spends due to varying DER signature size; the vsize check is therefore disabled for P2PK mode on master branch.\r\n\r\nCreating one million DER signatures with MiniWallet shows the following distribution of sizes (smart people with better math skills probably could deduce the ratios without trying, but hey):\r\n\r\n| DER signature size [bytes]  | #occurences (ratio) |\r\n| ------------- | ------------- |\r\n| 71  | 498893 (49.89%) |\r\n| 70 | 497244 (49.72%) |\r\n| 69 | 3837 (0.38%) |\r\n| 68 | 22 (0.0022%) |\r\n\r\nNote that even smaller signatures are possible (for smaller R and S values with leading zero bytes), it's just that the probability decreases exponentially.     Instead of choosing a large vsize check range and hoping that smaller signatures are never created (potentially leading to flaky tests), the proposed solution is to limit the signature size to the two most common sizes 71 and 70 (>99.6% probability) and then accordingly only check for two vsize values; the value to be used for fee calculation is a decimal right between the two possible sizes (167.5 vbytes) and for the vsize check it's rounded down/up integer values are used.\r\n\r\nThe idea of grinding signatures to a fixed size (similar to https://github.com/bitcoin/bitcoin/pull/13666 which grinds to low-R values) would be counter-productive, as the signature creation in the test suite is quite expensive and this would significantly slow down tests that calculate hundreds of signatures (like e.g. feature_csv_activation.py). \r\n\r\nFor more about transaction sizes on different input/output types, see the following interesting article: https://medium.com/coinmonks/on-bitcoin-transaction-sizes-97e31bc9d816\r\n",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 0,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22089/comments",
   "created_at" : "2021-05-27T20:17:35Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22089/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/22089",
   "id" : 904150496,
   "labels" : [
      {
         "color" : "d4c5f9",
         "default" : false,
         "description" : null,
         "id" : 62963516,
         "name" : "Tests",
         "node_id" : "MDU6TGFiZWw2Mjk2MzUxNg==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Tests"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22089/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDExOlB1bGxSZXF1ZXN0NjU1MzIzMzU4",
   "number" : 22089,
   "performed_via_github_app" : null,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/22089.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22089",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/22089.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22089"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "title" : "test: MiniWallet: fix fee calculation for P2PK and check tx vsize",
   "updated_at" : "2021-05-27T21:25:55Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22089",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
      "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
      "followers_url" : "https://api.github.com/users/theStack/followers",
      "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
      "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/theStack",
      "id" : 91535,
      "login" : "theStack",
      "node_id" : "MDQ6VXNlcjkxNTM1",
      "organizations_url" : "https://api.github.com/users/theStack/orgs",
      "received_events_url" : "https://api.github.com/users/theStack/received_events",
      "repos_url" : "https://api.github.com/users/theStack/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/theStack"
   }
}
