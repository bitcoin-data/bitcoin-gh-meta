{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "This is the main tracking issue for the `libbitcoinkernel` project.\r\n\r\nThe `libbitcoinkernel` project is a new attempt at extracting out our consensus engine. The `kernel` part of the name highlights one of the key functional differences from `libbitcoinconsensus` and in fact, most libraries: it is a stateful library that can spawn threads, do caching, do I/O, and many other things which one may not normally expect from a library.\r\n\r\nThis statefulness is necessary for `libbitcoinkernel`'s decidedly incremental approach to extracting our consensus engine. This approach favors:\r\n\r\n1. Reusing existing code\r\n   ...which allows us to be continually integrated with Bitcoin Core and benefit from our extensive test suite\r\n2. Incremental decoupling instead of building from scratch\r\n   ...which allows us to avoid having to prematurely optimizing for a \"perfect\" boundary or API (tends to be highly subjective, non-obvious, may lead to unproductive bike-shedding before we've even done anything meaningful)\r\n\r\nI believe that the work of extracting out our consensus engine into a library and making the API ergonomic is likely to be a multi-release project involving multiple contributors. The incremental approach takes this into account, and respects the sheer size of work (both in writing code and getting it through review) that needs to be undertaken.\r\n\r\n## The Game Plan\r\n\r\n### Stage 1: Extracting out a usable `libbitcoinkernel.{so,dylib,dll}`\r\n\r\n#### Step 1: Introduce internal `bitcoin-chainstate` and `libbitcoinkernel`\r\n##### a.k.a. What `.cpp` files do we need?\r\n\r\nThis `bitcoin-chainstate` executable uses our consensus engine and its build system code will reveal the minimal set of files we need to link in to use our consensus engine as-is. It is important to note that this list of files will serve as a guiding \"North Star\" for this first stage of the plan: as we decouple more and more modules of the codebase from our consensus engine, this list will grow shorter and shorter.\r\n\r\nThis list of files (the `_SOURCES` in `Automake` speak) then serves as the basis for a `libbitcoinkernel`, which `bitcoin-chainstate` will be linked against.\r\n\r\n**Key Result:** Any further coupling of our consensus engine with non-consensus modules will result in linker errors, preventing this project from becoming a sisyphean task of battling coupling regressions.\r\n\r\n#### Step 2: Decouple most non-consensus code from `libbitcoinkernel`\r\n##### a.k.a. Prune the unnecessary `.cpp` files!\r\n\r\nThere are many modules which do not logically belong in `libbitcoinkernel` (e.g. `index/*.cpp`, `netaddress.cpp`), but are nevertheless necessary to be included in its `_SOURCES` for `bitcoin-chainstate` to link correctly. This is because Bitcoin Core's existing codebase is full of unnecessary dependencies/couplings that need to be untangled/decoupled/broken up.\r\n\r\nThis step is where we do the decoupling for:\r\n1. `netaddress.cpp`\r\n2. Parts of `timedata.cpp`\r\n3. Parts of `init/common.cpp`\r\n4. `ArgsManager` (this one's a doozy)\r\n5. `index/*.cpp`\r\n6. `shutdown.cpp`\r\n7. `logging.cpp`\r\n\r\n**Developer Note:** We do not decouple the mempool *yet* because most users of `libbitcoinkernel` may want to have an embedded mempool with Bitcoin Core's policies and we can decouple it later.\r\n\r\n#### Step 3: Introduce an external `bitcoin-chainstate`\r\n##### a.k.a. What `.h` files do we need?\r\n\r\nBefore this step, `bitcoin-chainstate` has been an internal executable managed by our build system with access to all files and headers. In this step, we add an external `bitcoin-chainstate` with a separate build system to reveal the minimal set of headers we need to ship in order to make the `libbitcoinkernel` library usable.\r\n\r\n#### Step 4: Decouple most non-consensus headers from `libbitcoinkernel`\r\n##### a.k.a. Prune the unnecessary `.h` files!\r\n\r\nSimilar to Step 2, there are lots of small decoupling of the header dependency tree here. A notable piece of this step is to remove `leveldb` includes from our headers to avoid needing to re-ship `leveldb` headers.\r\n\r\n\r\n### Stage 2: Polishing the API / Continual De-coupling\r\n\r\nAt this point, we have a usable `libbitcoinkernel` that is _somewhat_ minimally linked. However, it has a very idiosyncratic, Bitcoin Core-specific C++ interface. The goal of this stage is to incrementally make the `libbitcoinkernel` API more ergonomic for users outside of Bitcoin Core. Bindings to other languages (first C, then others) should be introduced.\r\n\r\nPersonally, I have near-zero experience with library API design and langauge bindings, so I think ***it would be wise for other contributors to lead this stage***. Ideally, they would be able to work with users looking to integrate with `libbitcoinkernel` who can give an accurate account of the API ergonomics from the library user's point of view. \r\n\r\n\r\n## Getting `libbitcoinkernel` Through Review\r\n\r\nMost of the changes to be made are \"move only\", but there are a lot of these \"move only\" changes to be made. Of course comments/reviews regarding correctness are always more than welcome, but I want very much to avoid losing momentum on this project because of style or style-adjacent comments/reviews.\r\n\r\nI propose the following ground rules to make this process more streamlined for all parties involved and a few things that I can do to help:\r\n\r\n1. Any outstanding style or style-adjacent comments/reviews should not delay/block the merging of the core functionality of PRs. I will make sure to open a separate issue tracking all the leftover style or style-adjacent comments/reviews so that they won't be missed and can be addressed one by one.\r\n2. Whenever the PR reaches a stage where there are only style-related outstanding comments/reviews left, I will make a comment saying so. This might make it easier for maintainers to determine roughly where the PR is at in its lifecycle (ofc don't trust me, verify :smile:).\r\n\r\n## Action Items\r\n\r\n1. If you have any questions, please post them below!\r\n2. If you plan on reviewing `libbitcoinkernel` or are a maintainer:\r\n    1. Please make sure you've read the \"Getting `libbitcoinkernel` Through Review\" section above.\r\n    2. Please let me know if there's anything else I can do to help streamline the review process.\r\n3. If you would like to take the lead on \"Stage 2: Polishing the API / Continual De-coupling\", please leave a comment below, I'd love to talk!",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 1,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24303/comments",
   "created_at" : "2022-02-09T20:45:22Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24303/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/24303",
   "id" : 1129004032,
   "labels" : [],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24303/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "I_kwDOABII585DSzwA",
   "number" : 24303,
   "performed_via_github_app" : null,
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24303/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24303/timeline",
   "title" : "The `libbitcoinkernel` Project",
   "updated_at" : "2022-02-09T20:54:21Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24303",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
      "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
      "followers_url" : "https://api.github.com/users/dongcarl/followers",
      "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
      "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/dongcarl",
      "id" : 3445290,
      "login" : "dongcarl",
      "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
      "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
      "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
      "repos_url" : "https://api.github.com/users/dongcarl/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/dongcarl"
   }
}
