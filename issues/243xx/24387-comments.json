[
   {
      "author_association" : "MEMBER",
      "body" : "This is likely better opened upstream.",
      "created_at" : "2022-02-19T10:28:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/24387#issuecomment-1045986129",
      "id" : 1045986129,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24387",
      "node_id" : "IC_kwDOABII584-WHtR",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1045986129/reactions"
      },
      "updated_at" : "2022-02-19T10:28:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1045986129",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> This is likely better opened upstream.\r\n\r\nIt seems a makefile recipe calls target binary `depends/arm-linux-gnueabihf/bin/capnp` instead of native `depends/arm-linux-gnueabihf/native/bin/capnp` one.",
      "created_at" : "2022-02-19T19:30:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/24387#issuecomment-1046088849",
      "id" : 1046088849,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24387",
      "node_id" : "IC_kwDOABII584-WgyR",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1046088849/reactions"
      },
      "updated_at" : "2022-02-19T19:30:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1046088849",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I think I'm seeing something a little different when I try to reproduce this with `make -C depends libmultiprocess MULTIPROCESS=1 HOST=arm-linux-gnueabihf`. The build succeeds at HEAD 3a618c1e3b793b387a9d38ffe1498883cd4be35c but seems to create a package in `arm-linux-gnueabihf/libmultiprocess-(...).tar.gz` that has an x86-64 binary instead of an arm one.\r\n\r\n> > This is likely better opened upstream.\r\n> \r\n> It seems a makefile recipe calls target binary `depends/arm-linux-gnueabihf/bin/capnp` instead of native `depends/arm-linux-gnueabihf/native/bin/capnp` one.\r\n\r\nI'm happy to help with any issues (either here or if you want to move it upstream https://github.com/chaincodelabs/libmultiprocess/issues/new)\r\n\r\nIs there an easy to way to get depends not to delete the build/staging directories when it finishes building something? So far I couldn't check what is happening with the build because all the directories are deleted.",
      "created_at" : "2022-02-22T16:46:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/24387#issuecomment-1047997287",
      "id" : 1047997287,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24387",
      "node_id" : "IC_kwDOABII584-dytn",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1047997287/reactions"
      },
      "updated_at" : "2022-02-22T16:46:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1047997287",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> The build succeeds at HEAD 3a618c1e3b793b387a9d38ffe1498883cd4be35c...\r\n\r\nConfirming the [same](https://github.com/bitcoin/bitcoin/issues/24387#issue-1144631512) error when building at HEAD 3a618c1e3b793b387a9d38ffe1498883cd4be35c.\r\n\r\n> Is there an easy to way to get depends not to delete the build/staging directories when it finishes building something?\r\n\r\nYou could use a `..._built` \"subtarget\" to get a building directory `depends/work/build/arm-linux-gnueabihf/native_capnp/...` available:\r\n```\r\n$ make -C depends native_capnp_built MULTIPROCESS=1 HOST=arm-linux-gnueabihf\r\n```\r\n\r\nand a `..._staged` one to get a staging directory `depends/work/staging/arm-linux-gnueabihf/native_capnp/...`:\r\n\r\n```\r\n$ make -C depends native_capnp_staged MULTIPROCESS=1 HOST=arm-linux-gnueabihf\r\n```\r\n\r\nAlso: https://github.com/bitcoin/bitcoin/blob/master/depends/packages.md#build-targets\r\n\r\n\r\n",
      "created_at" : "2022-02-22T21:07:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/24387#issuecomment-1048212494",
      "id" : 1048212494,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24387",
      "node_id" : "IC_kwDOABII584-enQO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1048212494/reactions"
      },
      "updated_at" : "2022-02-22T21:07:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1048212494",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Ok. I am making some progress debugging this but I still can't reproduce the failure, and I've pretty confused about a number of things. My earlier build seemed to succeed only because I didn't have a cross compiler installed, so for some unknown reason the depends build was using the native compiler and appearing to succeed but actually building the wrong thing.\r\n\r\nNow I've set up the cross compiler...\r\n\r\n<details><summary>(details)</summary>\r\n<p>\r\n\r\nI'm running `nix-shell --pure` with `shell.nix`\r\n\r\n```nix\r\n{ nixpkgs ? import <nixpkgs> }:\r\n\r\nlet\r\n  pkgs = nixpkgs { };\r\n  crossPkgs = nixpkgs {\r\n    crossSystem = {\r\n      config = \"aarch64-unknown-linux-gnu\";\r\n    };\r\n  };\r\nin\r\ncrossPkgs.callPackage\r\n  ({ mkShell, cmake, curl, gcc, pkg-config }:\r\n    mkShell {\r\n      buildInputs = [ ];\r\n      nativeBuildInputs = [\r\n        cmake\r\n        curl\r\n        pkg-config\r\n        pkgs.gcc\r\n      ];\r\n\r\n      SSL_CERT_FILE = \"/etc/ssl/certs/ca-bundle.crt\";\r\n    }\r\n  )\r\n{ }\r\n```\r\n</details>\r\n\r\n...and build seems to be succeeding and producing ARM output, so I can't reproduce the original error. But I also don't understand why it's succeeding. Specifically I'm seeing cross-compiled libmultiprocess package build somehow detecting the native capnproto package (in CMakeCache.txt file):\r\n\r\n```\r\nCapnProto_DIR:PATH=/.../depends/arm-linux-gnueabihf/native/lib/cmake/CapnProto\r\n```\r\n\r\ndespite the fact that depends build is explicitly setting non-native lib/cmake path (in `make V=1` output):\r\n\r\n```\r\nCMAKE_MODULE_PATH=/.../depends/arm-linux-gnueabihf/lib/cmake\r\n```\r\n\r\nIt's a mystery to me how it is detecting the native package when CMAKE_MODULE_PATH does not include /native/\r\n\r\nEven more strangely. I don't understand how the `CMakeCache.txt` also contains lines like `CapnProto_kj_IMPORTED_LOCATION:FILEPATH=.../depends/arm-linux-gnueabihf/lib/libkj-0.7.0.so` which point at non-native libraries. So it is somehow finding the right non-native libraries despite using the wrong native package.\r\n\r\nIdeally the cross-compiled non-native multiprocess package should be depending on the cross-compiled non-native capnp package, so it uses the right capnp libraries. This appears to be happening in the original bug report, but is not happening for me.\r\n\r\nIn any case the depends build does appear to be buggy. I think `packages/libmultiprocess.mk` probably needs to be passing a `-DCAPNP_EXECUTABLE=.../depends/arm-linux-gnueabihf/native/bin/capnp` argument to cmake. Also the package should have dependencies on both `capnp` and `native_capnp`. I don't understand why it currently has a dependency on `native_$(package)`. That may be causing it to work indirectly, but doesn't seem to make much sense.\r\n\r\nIt'd be helpful to know what build environment / operating system the original bug report was happening on so I can try to reproduce and fix the problem on a system that isn't mysteriously working like mine.",
      "created_at" : "2022-02-28T23:00:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/24387#issuecomment-1054776195",
      "id" : 1054776195,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24387",
      "node_id" : "IC_kwDOABII584-3puD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1054776195/reactions"
      },
      "updated_at" : "2022-02-28T23:00:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1054776195",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
