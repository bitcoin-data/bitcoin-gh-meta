[
   {
      "author_association" : "MEMBER",
      "body" : "The code currently rebuckets entries (losing the additional bucket positions) if the asmap checksum changes. I'm not sure if that's necessary and don't see any downside to keeping the same bucketing if restarting with a new asmap. If others agree, I can update this PR to not do that rebucketing.",
      "created_at" : "2020-12-03T11:39:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#issuecomment-737888519",
      "id" : 737888519,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20557",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNzg4ODUxOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-03T11:39:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/737888519",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "We should also add a regression test for this. I think a good test would be to add a round trip serialize/unserialize to the addrman fuzz test, and compare the addrman before and after that round trip. There's some internal state that isn't reconstructed from serialize/unserialize (eg the vRandom ordering), but a comparator function that checked number of entries and bucket->entry pairs should work.\r\n\r\nIf anyone wants to add that fuzz test or other tests, I'm happy to add them to this PR.",
      "created_at" : "2020-12-03T11:43:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#issuecomment-737890278",
      "id" : 737890278,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20557",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNzg5MDI3OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-03T11:43:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/737890278",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r535204097"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/535204097"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        const bool restore_bucketing{nUBuckets == ADDRMAN_NEW_BUCKET_COUNT &&\r\n```",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2020-12-03T12:55:03Z",
      "diff_hunk" : "@@ -500,47 +501,59 @@ friend class CAddrManTest;\n         nTried -= nLost;\n \n         // Store positions in the new table buckets to apply later (if possible).\n-        std::map<int, int> entryToBucket; // Represents which entry belonged to which bucket when serializing\n-\n-        for (int bucket = 0; bucket < nUBuckets; bucket++) {\n-            int nSize = 0;\n-            s >> nSize;\n-            for (int n = 0; n < nSize; n++) {\n-                int nIndex = 0;\n-                s >> nIndex;\n-                if (nIndex >= 0 && nIndex < nNew) {\n-                    entryToBucket[nIndex] = bucket;\n+        // An entry may appear in up to ADDRMAN_NEW_BUCKETS_PER_ADDRESS buckets,\n+        // so we store all bucket-entry_index pairs to iterate through later.\n+        std::vector<std::pair<int, int>> bucket_entries;\n+\n+        for (int bucket = 0; bucket < nUBuckets; ++bucket) {\n+            int bucket_size{0};\n+            s >> bucket_size;\n+            for (int n = 0; n < bucket_size; ++n) {\n+                int entry_index{0};\n+                s >> entry_index;\n+                if (entry_index >= 0 && entry_index < nNew) {\n+                    bucket_entries.emplace_back(bucket, entry_index);\n                 }\n             }\n         }\n \n-        uint256 supplied_asmap_version;\n+        // Attempt to restore the entry's new buckets if the bucket count and asmap\n+        // checksum haven't changed\n+        uint256 supplied_asmap_checksum;\n         if (m_asmap.size() != 0) {\n-            supplied_asmap_version = SerializeHash(m_asmap);\n+            supplied_asmap_checksum = SerializeHash(m_asmap);\n         }\n-        uint256 serialized_asmap_version;\n+        uint256 serialized_asmap_checksum;\n         if (format >= Format::V2_ASMAP) {\n-            s >> serialized_asmap_version;\n+            s >> serialized_asmap_checksum;\n         }\n+        const bool restore_bucketing{nUBuckets == ADDRMAN_NEW_BUCKET_COUNT && ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r535204097",
      "id" : 535204097,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTIwNDA5Nw==",
      "original_commit_id" : "595e9e56d58afdd283dc83e9bff554d431a34b8c",
      "original_line" : 530,
      "original_position" : 81,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 543923638,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-29T12:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/535204097",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r535206817"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/535206817"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2020-12-03T12:59:23Z",
      "diff_hunk" : "@@ -500,47 +501,59 @@ friend class CAddrManTest;\n         nTried -= nLost;\n \n         // Store positions in the new table buckets to apply later (if possible).\n-        std::map<int, int> entryToBucket; // Represents which entry belonged to which bucket when serializing\n-\n-        for (int bucket = 0; bucket < nUBuckets; bucket++) {\n-            int nSize = 0;\n-            s >> nSize;\n-            for (int n = 0; n < nSize; n++) {\n-                int nIndex = 0;\n-                s >> nIndex;\n-                if (nIndex >= 0 && nIndex < nNew) {\n-                    entryToBucket[nIndex] = bucket;\n+        // An entry may appear in up to ADDRMAN_NEW_BUCKETS_PER_ADDRESS buckets,\n+        // so we store all bucket-entry_index pairs to iterate through later.\n+        std::vector<std::pair<int, int>> bucket_entries;\n+\n+        for (int bucket = 0; bucket < nUBuckets; ++bucket) {\n+            int bucket_size{0};\n+            s >> bucket_size;\n+            for (int n = 0; n < bucket_size; ++n) {\n+                int entry_index{0};\n+                s >> entry_index;\n+                if (entry_index >= 0 && entry_index < nNew) {\n+                    bucket_entries.emplace_back(bucket, entry_index);\n                 }\n             }\n         }\n \n-        uint256 supplied_asmap_version;\n+        // Attempt to restore the entry's new buckets if the bucket count and asmap\n+        // checksum haven't changed\n+        uint256 supplied_asmap_checksum;\n         if (m_asmap.size() != 0) {\n-            supplied_asmap_version = SerializeHash(m_asmap);\n+            supplied_asmap_checksum = SerializeHash(m_asmap);\n         }\n-        uint256 serialized_asmap_version;\n+        uint256 serialized_asmap_checksum;\n         if (format >= Format::V2_ASMAP) {\n-            s >> serialized_asmap_version;\n+            s >> serialized_asmap_checksum;\n         }\n+        const bool restore_bucketing{nUBuckets == ADDRMAN_NEW_BUCKET_COUNT && ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r535206817",
      "id" : 535206817,
      "in_reply_to_id" : 535204097,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTIwNjgxNw==",
      "original_commit_id" : "595e9e56d58afdd283dc83e9bff554d431a34b8c",
      "original_line" : 530,
      "original_position" : 81,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 543926955,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-29T12:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/535206817",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.",
      "created_at" : "2020-12-03T13:28:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#issuecomment-737994022",
      "id" : 737994022,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20557",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNzk5NDAyMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-01T15:57:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/737994022",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.\r\n\r\n>The code currently rebuckets entries (losing the additional bucket positions) if the asmap checksum changes. I'm not sure if that's necessary and don't see any downside to keeping the same bucketing if restarting with a new asmap. If others agree, I can update this PR to not do that rebucketing.\r\n\r\nThat would mean that asmap is applied to only newly learned addresses, which is a downside (assuming asmap is an improvement). On the other hand, losing the existing 8 buckets is unfortunate.\r\nI'm fine either way.\r\n\r\nWe could do the 8 existing + 1 asmap bucket if we really want... but that also has some consequences of potentially overriding existing buckets etc.\r\n\r\nAlso, we should keep in mind that non-rebucketing on a new asmap may allow existing records to appear in 16 buckets now instead of 8 (probably *all* existing records on first asmap appearance). Which is... also not particularly terrible but should be considered?",
      "created_at" : "2020-12-04T01:57:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#issuecomment-738505022",
      "id" : 738505022,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20557",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczODUwNTAyMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-04T01:57:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/738505022",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> That would mean that asmap is applied to only newly learned addresses, which is a downside (assuming asmap is an improvement)\r\n\r\nCurrently the bucket positions for existing new addresses are lost entirely when changing asmap, so I don't understand how this is a downside. The choice is between throwing away those bucket positions or not.\r\n\r\n> Also, we should keep in mind that non-rebucketing on a new asmap may allow existing records to appear in 16 buckets now instead of 8 (probably all existing records on first asmap appearance). Which is... also not particularly terrible but should be considered?\r\n\r\nNo. We won't add an entry to more than 8 buckets: https://github.com/bitcoin/bitcoin/blob/257cf05f9b841ba30202f23a94bcdb1743feded2/src/addrman.cpp#L294-L296.",
      "created_at" : "2020-12-04T09:39:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#issuecomment-738680739",
      "id" : 738680739,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20557",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczODY4MDczOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-04T09:39:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/738680739",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Currently the bucket positions for existing new addresses are lost entirely when changing asmap, so I don't understand how this is a downside. The choice is between throwing away those bucket positions or not.\r\n\r\nI expressed my agreement with you in the following sentence: \"On the other hand, losing the existing 8 buckets is unfortunate.\". Still, ideally, we would apply a new asmap to existing addrs without losing the data. Unfortunately, since we don't store addr source, we have to make this choice between the two. And I agree that of these 2 choices, the one you're suggesting is probably better.\r\n\r\n>No. We won't add an entry to more than 8 buckets: \r\n\r\nGood to know! That was just my wrong assumption without looking deep into code :)",
      "created_at" : "2020-12-04T17:38:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#issuecomment-738917757",
      "id" : 738917757,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20557",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczODkxNzc1Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-04T17:39:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/738917757",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r538141515"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/538141515"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This comment is weird in general. I don't think we have anything like `ADDRMAN_UNKNOWN_BUCKET_COUNT` anymore?",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2020-12-08T08:40:13Z",
      "diff_hunk" : "@@ -348,8 +349,8 @@ friend class CAddrManTest;\n      * Notice that vvTried, mapAddr and vVector are never encoded explicitly;\n      * they are instead reconstructed from the other information.\n      *\n-     * vvNew is serialized, but only used if ADDRMAN_UNKNOWN_BUCKET_COUNT didn't change,\n-     * otherwise it is reconstructed as well.\n+     * vvNew is serialized, but only used if ADDRMAN_UNKNOWN_BUCKET_COUNT and the asmap checksum",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r538141515",
      "id" : 538141515,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE0MTUxNQ==",
      "original_commit_id" : "3d438273fd3a0d6f0065244a31b423664a99f990",
      "original_line" : 352,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 546862075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-29T12:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/538141515",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r538142013"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/538142013"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should be talking about ADDRMAN_NEW_BUCKET_COUNT, ADDRMAN_NEW_BUCKETS_PER_ADDRESS.",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2020-12-08T08:41:02Z",
      "diff_hunk" : "@@ -348,8 +349,8 @@ friend class CAddrManTest;\n      * Notice that vvTried, mapAddr and vVector are never encoded explicitly;\n      * they are instead reconstructed from the other information.\n      *\n-     * vvNew is serialized, but only used if ADDRMAN_UNKNOWN_BUCKET_COUNT didn't change,\n-     * otherwise it is reconstructed as well.\n+     * vvNew is serialized, but only used if ADDRMAN_UNKNOWN_BUCKET_COUNT and the asmap checksum",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r538142013",
      "id" : 538142013,
      "in_reply_to_id" : 538141515,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE0MjAxMw==",
      "original_commit_id" : "3d438273fd3a0d6f0065244a31b423664a99f990",
      "original_line" : 352,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 546862698,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-29T12:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/538142013",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r538144329"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/538144329"
         }
      },
      "author_association" : "MEMBER",
      "body" : "So this happens if a new version of Bitcoin Core reduced `ADDRMAN_NEW_BUCKETS_PER_ADDRESS`, and in this case we completely forget the extra addrs.\r\n\r\nWhy do you think it's more reasonable? Assuming addrman is less-than-half-full, there's a good chance this odd addr can find a new place without evicting anything.",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2020-12-08T08:44:35Z",
      "diff_hunk" : "@@ -525,19 +527,26 @@ friend class CAddrManTest;\n         if (format >= Format::V2_ASMAP) {\n             s >> serialized_asmap_checksum;\n         }\n+        const bool restore_bucketing{nUBuckets == ADDRMAN_NEW_BUCKET_COUNT &&\n+                                     serialized_asmap_checksum == supplied_asmap_checksum};\n \n         for (auto bucket_entry : bucket_entries) {\n             int bucket{bucket_entry.first};\n             const int entry_index{bucket_entry.second};\n             CAddrInfo& info = mapInfo[entry_index];\n+\n+            // The entry shouldn't appear in more than\n+            // ADDRMAN_NEW_BUCKETS_PER_ADDRESS. If it has already, just skip\n+            // this bucket_entry.\n+            if (info.nRefCount >= ADDRMAN_NEW_BUCKETS_PER_ADDRESS) continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r538144329",
      "id" : 538144329,
      "line" : 543,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE0NDMyOQ==",
      "original_commit_id" : "75c4f0f3f4b73b62ce9f5a5c93f7aff24b0e878f",
      "original_line" : 542,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 113,
      "pull_request_review_id" : 546865300,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-29T12:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/538144329",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r538145834"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/538145834"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I find it hard to parse \"restore the entry's new buckets\".\r\n1. Not only buckets, but also positions.\r\n2. What exactly is \"restore\" is also a bit unclear, I'm thinking if there's a better verb. Perhaps just \"use the serialized [...]\"",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2020-12-08T08:47:01Z",
      "diff_hunk" : "@@ -517,6 +517,8 @@ friend class CAddrManTest;\n             }\n         }\n \n+        // Attempt to restore the entry's new buckets if the bucket count and asmap",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r538145834",
      "id" : 538145834,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE0NTgzNA==",
      "original_commit_id" : "75c4f0f3f4b73b62ce9f5a5c93f7aff24b0e878f",
      "original_line" : 520,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 546867085,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-29T12:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/538145834",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r540073174"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540073174"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, changed to ADDRMAN_NEW_BUCKET_COUNT.",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2020-12-10T10:57:41Z",
      "diff_hunk" : "@@ -348,8 +349,8 @@ friend class CAddrManTest;\n      * Notice that vvTried, mapAddr and vVector are never encoded explicitly;\n      * they are instead reconstructed from the other information.\n      *\n-     * vvNew is serialized, but only used if ADDRMAN_UNKNOWN_BUCKET_COUNT didn't change,\n-     * otherwise it is reconstructed as well.\n+     * vvNew is serialized, but only used if ADDRMAN_UNKNOWN_BUCKET_COUNT and the asmap checksum",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r540073174",
      "id" : 540073174,
      "in_reply_to_id" : 538141515,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA3MzE3NA==",
      "original_commit_id" : "3d438273fd3a0d6f0065244a31b423664a99f990",
      "original_line" : 352,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 549079380,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-29T12:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540073174",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r540073873"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540073873"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Because `ADDRMAN_NEW_BUCKETS_PER_ADDRESS` should be an invariant in addrman. No entry should appear in no more than `ADDRMAN_NEW_BUCKETS_PER_ADDRESS` buckets.",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2020-12-10T10:58:47Z",
      "diff_hunk" : "@@ -525,19 +527,26 @@ friend class CAddrManTest;\n         if (format >= Format::V2_ASMAP) {\n             s >> serialized_asmap_checksum;\n         }\n+        const bool restore_bucketing{nUBuckets == ADDRMAN_NEW_BUCKET_COUNT &&\n+                                     serialized_asmap_checksum == supplied_asmap_checksum};\n \n         for (auto bucket_entry : bucket_entries) {\n             int bucket{bucket_entry.first};\n             const int entry_index{bucket_entry.second};\n             CAddrInfo& info = mapInfo[entry_index];\n+\n+            // The entry shouldn't appear in more than\n+            // ADDRMAN_NEW_BUCKETS_PER_ADDRESS. If it has already, just skip\n+            // this bucket_entry.\n+            if (info.nRefCount >= ADDRMAN_NEW_BUCKETS_PER_ADDRESS) continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r540073873",
      "id" : 540073873,
      "in_reply_to_id" : 538144329,
      "line" : 543,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA3Mzg3Mw==",
      "original_commit_id" : "75c4f0f3f4b73b62ce9f5a5c93f7aff24b0e878f",
      "original_line" : 542,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 113,
      "pull_request_review_id" : 549080242,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-29T12:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540073873",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r540075665"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540075665"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Changed wording to \"If the bucket count and asmap checksum haven't changed, then attempt to restore the entries to the buckets/positions they were in before serialization.\" Hopefully that's clearer!\r\n",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2020-12-10T11:01:35Z",
      "diff_hunk" : "@@ -517,6 +517,8 @@ friend class CAddrManTest;\n             }\n         }\n \n+        // Attempt to restore the entry's new buckets if the bucket count and asmap",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r540075665",
      "id" : 540075665,
      "in_reply_to_id" : 538145834,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDA3NTY2NQ==",
      "original_commit_id" : "75c4f0f3f4b73b62ce9f5a5c93f7aff24b0e878f",
      "original_line" : 520,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 549082343,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-29T12:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540075665",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @naumenkogs. I've addressed all your comments.",
      "created_at" : "2020-12-10T11:02:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#issuecomment-742449291",
      "id" : 742449291,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20557",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0MjQ0OTI5MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-10T11:02:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/742449291",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK, and the code change looks overall good to me. \r\n\r\n> https://github.com/bitcoin/bitcoin/pull/20557#issuecomment-737890278\r\n\r\nAgree that a test would be useful, to make it easier to see that this fixes the mentioned problems and prevent future regression.",
      "created_at" : "2020-12-10T13:08:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#issuecomment-742510425",
      "id" : 742510425,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20557",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0MjUxMDQyNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-10T13:08:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/742510425",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK dbdf63c6d82ae8d1ca73f11d1b8844614f0bf8e3",
      "created_at" : "2020-12-11T07:48:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#issuecomment-743033626",
      "id" : 743033626,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20557",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0MzAzMzYyNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-11T07:48:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/743033626",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r556985482"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556985482"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Just to clarify... this is the number of entries in this bucket, right? Not the capacity of the bucket, which is `ADDRMAN_BUCKET_SIZE`?",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-01-14T01:28:16Z",
      "diff_hunk" : "@@ -504,14 +504,14 @@ friend class CAddrManTest;\n         // so we store all bucket-entry_index pairs to iterate through later.\n         std::vector<std::pair<int, int>> bucket_entries;\n \n-        for (int bucket = 0; bucket < nUBuckets; bucket++) {\n-            int nSize = 0;\n-            s >> nSize;\n-            for (int n = 0; n < nSize; n++) {\n-                int nIndex = 0;\n-                s >> nIndex;\n-                if (nIndex >= 0 && nIndex < nNew) {\n-                    bucket_entries.emplace_back(bucket, nIndex);\n+        for (int bucket = 0; bucket < nUBuckets; ++bucket) {\n+            int bucket_size{0};\n+            s >> bucket_size;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r556985482",
      "id" : 556985482,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njk4NTQ4Mg==",
      "original_commit_id" : "41f2fd90eba1447c23efa9a5df031daa448897ee",
      "original_line" : 509,
      "original_position" : 14,
      "original_start_line" : 508,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 567787742,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-29T12:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556985482",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r556991230"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556991230"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "So you're removing the `format >= Format::V2_ASMAP` condition here because otherwise it'd be impossible for `serialized_asmap_checksum == supplied_asmap_checksum` yes?",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-01-14T01:46:13Z",
      "diff_hunk" : "@@ -525,19 +527,26 @@ friend class CAddrManTest;\n         if (format >= Format::V2_ASMAP) {\n             s >> serialized_asmap_checksum;\n         }\n+        const bool restore_bucketing{nUBuckets == ADDRMAN_NEW_BUCKET_COUNT &&\n+                                     serialized_asmap_checksum == supplied_asmap_checksum};\n \n         for (auto bucket_entry : bucket_entries) {\n             int bucket{bucket_entry.first};\n             const int entry_index{bucket_entry.second};\n             CAddrInfo& info = mapInfo[entry_index];\n+\n+            // The entry shouldn't appear in more than\n+            // ADDRMAN_NEW_BUCKETS_PER_ADDRESS. If it has already, just skip\n+            // this bucket_entry.\n+            if (info.nRefCount >= ADDRMAN_NEW_BUCKETS_PER_ADDRESS) continue;\n+\n             int nUBucketPos = info.GetBucketPosition(nKey, true, bucket);\n-            if (format >= Format::V2_ASMAP && nUBuckets == ADDRMAN_NEW_BUCKET_COUNT && vvNew[bucket][nUBucketPos] == -1 &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r556991230",
      "id" : 556991230,
      "line" : 530,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Njk5MTIzMA==",
      "original_commit_id" : "03002228b16b6729f7720acb761e5a78d49312ef",
      "original_line" : 530,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 99,
      "pull_request_review_id" : 567787742,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-29T12:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/556991230",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r557383675"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557383675"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Exactly (see the comment above about serialization format: https://github.com/jnewbery/bitcoin/blob/dbdf63c6d82ae8d1ca73f11d1b8844614f0bf8e3/src/addrman.h#L341)",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-01-14T13:11:31Z",
      "diff_hunk" : "@@ -504,14 +504,14 @@ friend class CAddrManTest;\n         // so we store all bucket-entry_index pairs to iterate through later.\n         std::vector<std::pair<int, int>> bucket_entries;\n \n-        for (int bucket = 0; bucket < nUBuckets; bucket++) {\n-            int nSize = 0;\n-            s >> nSize;\n-            for (int n = 0; n < nSize; n++) {\n-                int nIndex = 0;\n-                s >> nIndex;\n-                if (nIndex >= 0 && nIndex < nNew) {\n-                    bucket_entries.emplace_back(bucket, nIndex);\n+        for (int bucket = 0; bucket < nUBuckets; ++bucket) {\n+            int bucket_size{0};\n+            s >> bucket_size;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r557383675",
      "id" : 557383675,
      "in_reply_to_id" : 556985482,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzM4MzY3NQ==",
      "original_commit_id" : "41f2fd90eba1447c23efa9a5df031daa448897ee",
      "original_line" : 509,
      "original_position" : 14,
      "original_start_line" : 508,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 568217486,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-29T12:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557383675",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r557384721"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557384721"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Correct. If format == V1_DETERMINISTIC, then serialized_asmap_checksum must be 0.",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-01-14T13:13:19Z",
      "diff_hunk" : "@@ -525,19 +527,26 @@ friend class CAddrManTest;\n         if (format >= Format::V2_ASMAP) {\n             s >> serialized_asmap_checksum;\n         }\n+        const bool restore_bucketing{nUBuckets == ADDRMAN_NEW_BUCKET_COUNT &&\n+                                     serialized_asmap_checksum == supplied_asmap_checksum};\n \n         for (auto bucket_entry : bucket_entries) {\n             int bucket{bucket_entry.first};\n             const int entry_index{bucket_entry.second};\n             CAddrInfo& info = mapInfo[entry_index];\n+\n+            // The entry shouldn't appear in more than\n+            // ADDRMAN_NEW_BUCKETS_PER_ADDRESS. If it has already, just skip\n+            // this bucket_entry.\n+            if (info.nRefCount >= ADDRMAN_NEW_BUCKETS_PER_ADDRESS) continue;\n+\n             int nUBucketPos = info.GetBucketPosition(nKey, true, bucket);\n-            if (format >= Format::V2_ASMAP && nUBuckets == ADDRMAN_NEW_BUCKET_COUNT && vvNew[bucket][nUBucketPos] == -1 &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r557384721",
      "id" : 557384721,
      "in_reply_to_id" : 556991230,
      "line" : 530,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzM4NDcyMQ==",
      "original_commit_id" : "03002228b16b6729f7720acb761e5a78d49312ef",
      "original_line" : 530,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 99,
      "pull_request_review_id" : 568218932,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-29T12:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/557384721",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r558689266"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/558689266"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I just thought both being called \"size\" is a bit confusing so `num_entries` would have been my choice for naming, but it's the nittiest of nits, non-blocking",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-01-15T23:56:58Z",
      "diff_hunk" : "@@ -504,14 +504,14 @@ friend class CAddrManTest;\n         // so we store all bucket-entry_index pairs to iterate through later.\n         std::vector<std::pair<int, int>> bucket_entries;\n \n-        for (int bucket = 0; bucket < nUBuckets; bucket++) {\n-            int nSize = 0;\n-            s >> nSize;\n-            for (int n = 0; n < nSize; n++) {\n-                int nIndex = 0;\n-                s >> nIndex;\n-                if (nIndex >= 0 && nIndex < nNew) {\n-                    bucket_entries.emplace_back(bucket, nIndex);\n+        for (int bucket = 0; bucket < nUBuckets; ++bucket) {\n+            int bucket_size{0};\n+            s >> bucket_size;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r558689266",
      "id" : 558689266,
      "in_reply_to_id" : 556985482,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODY4OTI2Ng==",
      "original_commit_id" : "41f2fd90eba1447c23efa9a5df031daa448897ee",
      "original_line" : 509,
      "original_position" : 14,
      "original_start_line" : 508,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 569778256,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-29T12:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/558689266",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r559563695"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559563695"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree that this is confusing. I've renamed to `num_entries`.",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-01-18T13:23:38Z",
      "diff_hunk" : "@@ -504,14 +504,14 @@ friend class CAddrManTest;\n         // so we store all bucket-entry_index pairs to iterate through later.\n         std::vector<std::pair<int, int>> bucket_entries;\n \n-        for (int bucket = 0; bucket < nUBuckets; bucket++) {\n-            int nSize = 0;\n-            s >> nSize;\n-            for (int n = 0; n < nSize; n++) {\n-                int nIndex = 0;\n-                s >> nIndex;\n-                if (nIndex >= 0 && nIndex < nNew) {\n-                    bucket_entries.emplace_back(bucket, nIndex);\n+        for (int bucket = 0; bucket < nUBuckets; ++bucket) {\n+            int bucket_size{0};\n+            s >> bucket_size;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r559563695",
      "id" : 559563695,
      "in_reply_to_id" : 556985482,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTU2MzY5NQ==",
      "original_commit_id" : "41f2fd90eba1447c23efa9a5df031daa448897ee",
      "original_line" : 509,
      "original_position" : 14,
      "original_start_line" : 508,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 570485643,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-29T12:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559563695",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Improved the naming of one of the variables as suggested in https://github.com/bitcoin/bitcoin/pull/20557#discussion_r556985482 :\r\n https://github.com/bitcoin/bitcoin/compare/dbdf63c6d82ae8d1ca73f11d1b8844614f0bf8e3..36f3d9d8a48541f0b44ea4cff52a770cab43f2f0.",
      "created_at" : "2021-01-18T13:25:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#issuecomment-762249254",
      "id" : 762249254,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20557",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2MjI0OTI1NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-18T13:25:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/762249254",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased on master",
      "created_at" : "2021-01-18T14:36:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#issuecomment-762289179",
      "id" : 762289179,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20557",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2MjI4OTE3OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-18T14:36:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/762289179",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK ac3547eddd8a7d67b4103508f30d5d02a9c1f148",
      "created_at" : "2021-01-19T07:11:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#issuecomment-762648732",
      "id" : 762648732,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20557",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2MjY0ODczMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-19T07:11:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/762648732",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r563877014"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563877014"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@naumenkogs if a new Bitcoin Core reduces `ADDRMAN_NEW_BUCKETS_PER_ADDRESS` from 8 to e.g. 6 and this condition becomes true in the new version, then the address is already in 6 buckets in memory. So we would not completely forget it, or do I miss something?",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-01-25T16:51:27Z",
      "diff_hunk" : "@@ -525,19 +527,26 @@ friend class CAddrManTest;\n         if (format >= Format::V2_ASMAP) {\n             s >> serialized_asmap_checksum;\n         }\n+        const bool restore_bucketing{nUBuckets == ADDRMAN_NEW_BUCKET_COUNT &&\n+                                     serialized_asmap_checksum == supplied_asmap_checksum};\n \n         for (auto bucket_entry : bucket_entries) {\n             int bucket{bucket_entry.first};\n             const int entry_index{bucket_entry.second};\n             CAddrInfo& info = mapInfo[entry_index];\n+\n+            // The entry shouldn't appear in more than\n+            // ADDRMAN_NEW_BUCKETS_PER_ADDRESS. If it has already, just skip\n+            // this bucket_entry.\n+            if (info.nRefCount >= ADDRMAN_NEW_BUCKETS_PER_ADDRESS) continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r563877014",
      "id" : 563877014,
      "in_reply_to_id" : 538144329,
      "line" : 543,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mzg3NzAxNA==",
      "original_commit_id" : "75c4f0f3f4b73b62ce9f5a5c93f7aff24b0e878f",
      "original_line" : 542,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 113,
      "pull_request_review_id" : 575596316,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-29T12:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563877014",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r564225855"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/564225855"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`vVector` does not exist. More importantly - none of the members is serialized explicitly/directly. So, I think the following changes would make a better description of the source code:\r\n\r\n```diff\r\ndiff --git i/src/addrman.h w/src/addrman.h\r\nindex cde864f25..983a1f4fd 100644\r\n--- i/src/addrman.h\r\n+++ w/src/addrman.h\r\n@@ -332,29 +332,26 @@ public:\r\n      *     (format=5, lowest_compatible=5) and so any versions that do not know how to parse\r\n      *     format=5 will not try to read the file.\r\n      * * nKey\r\n      * * nNew\r\n      * * nTried\r\n      * * number of \"new\" buckets XOR 2**30\r\n-     * * all nNew addrinfos in vvNew\r\n-     * * all nTried addrinfos in vvTried\r\n-     * * for each bucket:\r\n+     * * all new addresses (total count: nNew)\r\n+     * * all tried addresses (total count: nTried)\r\n+     * * for each new bucket:\r\n      *   * number of elements\r\n-     *   * for each element: index\r\n+     *   * for each element: index in the serialized \"all new addresses\"\r\n      * * asmap checksum\r\n      *\r\n      * 2**30 is xorred with the number of buckets to make addrman deserializer v0 detect it\r\n      * as incompatible. This is necessary because it did not check the version number on\r\n      * deserialization.\r\n      *\r\n-     * Notice that vvTried, mapAddr and vVector are never encoded explicitly;\r\n+     * Notice that vvNew, vvTried, mapAddr, mapInfo and vRandom are never encoded explicitly;\r\n      * they are instead reconstructed from the other information.\r\n      *\r\n-     * vvNew is serialized, but only used if ADDRMAN_NEW_BUCKET_COUNT and the asmap checksum\r\n-     * didn't change, otherwise it is reconstructed as well.\r\n-     *\r\n      * This format is more complex, but significantly smaller (at most 1.5 MiB), and supports\r\n      * changes to the ADDRMAN_ parameters without breaking the on-disk structure.\r\n      *\r\n      * We don't use SERIALIZE_METHODS since the serialization and deserialization code has\r\n      * very little in common.\r\n      */\r\n```\r\n\r\nWhy `vvNew` is not serialized? Because `vvNew[i][j]` contains the `id` under which the element can be found in `mapInfo`. We serialize a condensed version of `vvNew` (without the `-1`s), but instead of that `id` we store an index in the serialized list of `CAddrInfo` which exists only on disk.",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-01-26T05:36:55Z",
      "diff_hunk" : "@@ -348,8 +349,8 @@ friend class CAddrManTest;\n      * Notice that vvTried, mapAddr and vVector are never encoded explicitly;\n      * they are instead reconstructed from the other information.\n      *\n-     * vvNew is serialized, but only used if ADDRMAN_UNKNOWN_BUCKET_COUNT didn't change,\n-     * otherwise it is reconstructed as well.\n+     * vvNew is serialized, but only used if ADDRMAN_NEW_BUCKET_COUNT and the asmap checksum\n+     * didn't change, otherwise it is reconstructed as well.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r564225855",
      "id" : 564225855,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDIyNTg1NQ==",
      "original_commit_id" : "ac3547eddd8a7d67b4103508f30d5d02a9c1f148",
      "original_line" : 353,
      "original_position" : 15,
      "original_start_line" : 349,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 576028779,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-29T12:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/564225855",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r564232061"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/564232061"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Under what conditions could it happen that `restore_bucketing` is `false` and `vvNew[bucket][bucket_position] != -1` (occupied)?\r\n\r\nIs it only if `ADDRMAN_BUCKET_SIZE` has been changed? If that has happened then we shouldn't try to restore the bucketing (i.e. should set `restore_bucketing` to `false`), but unfortunately the old `ADDRMAN_BUCKET_SIZE` is not saved on disk, so we can only indirectly observe that the file was written with a different `ADDRMAN_BUCKET_SIZE`.\r\n\r\n(the above is not a suggestion for a change, just a few questions to confirm my understanding is correct)",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-01-26T05:48:12Z",
      "diff_hunk" : "@@ -500,47 +501,60 @@ friend class CAddrManTest;\n         nTried -= nLost;\n \n         // Store positions in the new table buckets to apply later (if possible).\n-        std::map<int, int> entryToBucket; // Represents which entry belonged to which bucket when serializing\n-\n-        for (int bucket = 0; bucket < nUBuckets; bucket++) {\n-            int nSize = 0;\n-            s >> nSize;\n-            for (int n = 0; n < nSize; n++) {\n-                int nIndex = 0;\n-                s >> nIndex;\n-                if (nIndex >= 0 && nIndex < nNew) {\n-                    entryToBucket[nIndex] = bucket;\n+        // An entry may appear in up to ADDRMAN_NEW_BUCKETS_PER_ADDRESS buckets,\n+        // so we store all bucket-entry_index pairs to iterate through later.\n+        std::vector<std::pair<int, int>> bucket_entries;\n+\n+        for (int bucket = 0; bucket < nUBuckets; ++bucket) {\n+            int num_entries{0};\n+            s >> num_entries;\n+            for (int n = 0; n < num_entries; ++n) {\n+                int entry_index{0};\n+                s >> entry_index;\n+                if (entry_index >= 0 && entry_index < nNew) {\n+                    bucket_entries.emplace_back(bucket, entry_index);\n                 }\n             }\n         }\n \n-        uint256 supplied_asmap_version;\n+        // If the bucket count and asmap checksum haven't changed, then attempt\n+        // to restore the entries to the buckets/positions they were in before\n+        // serialization.\n+        uint256 supplied_asmap_checksum;\n         if (m_asmap.size() != 0) {\n-            supplied_asmap_version = SerializeHash(m_asmap);\n+            supplied_asmap_checksum = SerializeHash(m_asmap);\n         }\n-        uint256 serialized_asmap_version;\n+        uint256 serialized_asmap_checksum;\n         if (format >= Format::V2_ASMAP) {\n-            s >> serialized_asmap_version;\n+            s >> serialized_asmap_checksum;\n         }\n+        const bool restore_bucketing{nUBuckets == ADDRMAN_NEW_BUCKET_COUNT &&\n+                                     serialized_asmap_checksum == supplied_asmap_checksum};\n \n-        for (int n = 0; n < nNew; n++) {\n-            CAddrInfo &info = mapInfo[n];\n-            int bucket = entryToBucket[n];\n-            int nUBucketPos = info.GetBucketPosition(nKey, true, bucket);\n-            if (format >= Format::V2_ASMAP && nUBuckets == ADDRMAN_NEW_BUCKET_COUNT && vvNew[bucket][nUBucketPos] == -1 &&\n-                info.nRefCount < ADDRMAN_NEW_BUCKETS_PER_ADDRESS && serialized_asmap_version == supplied_asmap_version) {\n+        for (auto bucket_entry : bucket_entries) {\n+            int bucket{bucket_entry.first};\n+            const int entry_index{bucket_entry.second};\n+            CAddrInfo& info = mapInfo[entry_index];\n+\n+            // The entry shouldn't appear in more than\n+            // ADDRMAN_NEW_BUCKETS_PER_ADDRESS. If it has already, just skip\n+            // this bucket_entry.\n+            if (info.nRefCount >= ADDRMAN_NEW_BUCKETS_PER_ADDRESS) continue;\n+\n+            int bucket_position = info.GetBucketPosition(nKey, true, bucket);\n+            if (restore_bucketing && vvNew[bucket][bucket_position] == -1) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r564232061",
      "id" : 564232061,
      "line" : 546,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDIzMjA2MQ==",
      "original_commit_id" : "ac3547eddd8a7d67b4103508f30d5d02a9c1f148",
      "original_line" : 545,
      "original_position" : 102,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 116,
      "pull_request_review_id" : 576028779,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-29T12:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/564232061",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r564248956"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/564248956"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If `restore_bucketing` is `false`, then this will be printed for every address, possibly _many_ times. But it does not include the address itself. What about printing the address:\r\n\r\n```suggestion\r\n                LogPrint(BCLog::ADDRMAN, \"Bucketing method was updated, re-bucketing addrman entry from disk for %s\\n\", info.ToString());\r\n```\r\n\r\nor print the generic message once:\r\n\r\n```suggestion\r\n                if (!printed) {\r\n                    LogPrint(BCLog::ADDRMAN, \"Bucketing method was updated, re-bucketing addrman entries from disk\\n\");\r\n                    printed = true;\r\n                }\r\n```",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-01-26T06:04:22Z",
      "diff_hunk" : "@@ -500,47 +501,60 @@ friend class CAddrManTest;\n         nTried -= nLost;\n \n         // Store positions in the new table buckets to apply later (if possible).\n-        std::map<int, int> entryToBucket; // Represents which entry belonged to which bucket when serializing\n-\n-        for (int bucket = 0; bucket < nUBuckets; bucket++) {\n-            int nSize = 0;\n-            s >> nSize;\n-            for (int n = 0; n < nSize; n++) {\n-                int nIndex = 0;\n-                s >> nIndex;\n-                if (nIndex >= 0 && nIndex < nNew) {\n-                    entryToBucket[nIndex] = bucket;\n+        // An entry may appear in up to ADDRMAN_NEW_BUCKETS_PER_ADDRESS buckets,\n+        // so we store all bucket-entry_index pairs to iterate through later.\n+        std::vector<std::pair<int, int>> bucket_entries;\n+\n+        for (int bucket = 0; bucket < nUBuckets; ++bucket) {\n+            int num_entries{0};\n+            s >> num_entries;\n+            for (int n = 0; n < num_entries; ++n) {\n+                int entry_index{0};\n+                s >> entry_index;\n+                if (entry_index >= 0 && entry_index < nNew) {\n+                    bucket_entries.emplace_back(bucket, entry_index);\n                 }\n             }\n         }\n \n-        uint256 supplied_asmap_version;\n+        // If the bucket count and asmap checksum haven't changed, then attempt\n+        // to restore the entries to the buckets/positions they were in before\n+        // serialization.\n+        uint256 supplied_asmap_checksum;\n         if (m_asmap.size() != 0) {\n-            supplied_asmap_version = SerializeHash(m_asmap);\n+            supplied_asmap_checksum = SerializeHash(m_asmap);\n         }\n-        uint256 serialized_asmap_version;\n+        uint256 serialized_asmap_checksum;\n         if (format >= Format::V2_ASMAP) {\n-            s >> serialized_asmap_version;\n+            s >> serialized_asmap_checksum;\n         }\n+        const bool restore_bucketing{nUBuckets == ADDRMAN_NEW_BUCKET_COUNT &&\n+                                     serialized_asmap_checksum == supplied_asmap_checksum};\n \n-        for (int n = 0; n < nNew; n++) {\n-            CAddrInfo &info = mapInfo[n];\n-            int bucket = entryToBucket[n];\n-            int nUBucketPos = info.GetBucketPosition(nKey, true, bucket);\n-            if (format >= Format::V2_ASMAP && nUBuckets == ADDRMAN_NEW_BUCKET_COUNT && vvNew[bucket][nUBucketPos] == -1 &&\n-                info.nRefCount < ADDRMAN_NEW_BUCKETS_PER_ADDRESS && serialized_asmap_version == supplied_asmap_version) {\n+        for (auto bucket_entry : bucket_entries) {\n+            int bucket{bucket_entry.first};\n+            const int entry_index{bucket_entry.second};\n+            CAddrInfo& info = mapInfo[entry_index];\n+\n+            // The entry shouldn't appear in more than\n+            // ADDRMAN_NEW_BUCKETS_PER_ADDRESS. If it has already, just skip\n+            // this bucket_entry.\n+            if (info.nRefCount >= ADDRMAN_NEW_BUCKETS_PER_ADDRESS) continue;\n+\n+            int bucket_position = info.GetBucketPosition(nKey, true, bucket);\n+            if (restore_bucketing && vvNew[bucket][bucket_position] == -1) {\n                 // Bucketing has not changed, using existing bucket positions for the new table\n-                vvNew[bucket][nUBucketPos] = n;\n-                info.nRefCount++;\n+                vvNew[bucket][bucket_position] = entry_index;\n+                ++info.nRefCount;\n             } else {\n-                // In case the new table data cannot be used (format unknown, bucket count wrong or new asmap),\n+                // In case the new table data cannot be used (bucket count wrong or new asmap),\n                 // try to give them a reference based on their primary source address.\n                 LogPrint(BCLog::ADDRMAN, \"Bucketing method was updated, re-bucketing addrman entries from disk\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r564248956",
      "id" : 564248956,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDI0ODk1Ng==",
      "original_commit_id" : "ac3547eddd8a7d67b4103508f30d5d02a9c1f148",
      "original_line" : 552,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 576028779,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-29T12:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/564248956",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I think a good test would be to add a round trip serialize/unserialize to the addrman fuzz test, and compare the addrman before and after that round trip. There's some internal state that isn't reconstructed from serialize/unserialize (eg the vRandom ordering), but a comparator function that checked number of entries and bucket->entry pairs should work.\r\n\r\nCreated such test at: https://github.com/jnewbery/bitcoin/pull/18.\r\n\r\n~~It does not compare bucket->entry though because the ids (the keys into `mapInfo`) could be different after ser/unser.~~",
      "created_at" : "2021-01-26T16:42:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#issuecomment-767671839",
      "id" : 767671839,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20557",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2NzY3MTgzOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-26T17:11:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/767671839",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r566720943"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566720943"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If both `restore_bucketing` is false and `vvNew[bucket][bucket_position] != -1` then it means that two addresses hash into the same position in the same new bucket, which is possible based on the source address. `restore_bucketing` would be false if the number of new buckets had changed or the as map had changed.",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-01-29T10:23:37Z",
      "diff_hunk" : "@@ -500,47 +501,60 @@ friend class CAddrManTest;\n         nTried -= nLost;\n \n         // Store positions in the new table buckets to apply later (if possible).\n-        std::map<int, int> entryToBucket; // Represents which entry belonged to which bucket when serializing\n-\n-        for (int bucket = 0; bucket < nUBuckets; bucket++) {\n-            int nSize = 0;\n-            s >> nSize;\n-            for (int n = 0; n < nSize; n++) {\n-                int nIndex = 0;\n-                s >> nIndex;\n-                if (nIndex >= 0 && nIndex < nNew) {\n-                    entryToBucket[nIndex] = bucket;\n+        // An entry may appear in up to ADDRMAN_NEW_BUCKETS_PER_ADDRESS buckets,\n+        // so we store all bucket-entry_index pairs to iterate through later.\n+        std::vector<std::pair<int, int>> bucket_entries;\n+\n+        for (int bucket = 0; bucket < nUBuckets; ++bucket) {\n+            int num_entries{0};\n+            s >> num_entries;\n+            for (int n = 0; n < num_entries; ++n) {\n+                int entry_index{0};\n+                s >> entry_index;\n+                if (entry_index >= 0 && entry_index < nNew) {\n+                    bucket_entries.emplace_back(bucket, entry_index);\n                 }\n             }\n         }\n \n-        uint256 supplied_asmap_version;\n+        // If the bucket count and asmap checksum haven't changed, then attempt\n+        // to restore the entries to the buckets/positions they were in before\n+        // serialization.\n+        uint256 supplied_asmap_checksum;\n         if (m_asmap.size() != 0) {\n-            supplied_asmap_version = SerializeHash(m_asmap);\n+            supplied_asmap_checksum = SerializeHash(m_asmap);\n         }\n-        uint256 serialized_asmap_version;\n+        uint256 serialized_asmap_checksum;\n         if (format >= Format::V2_ASMAP) {\n-            s >> serialized_asmap_version;\n+            s >> serialized_asmap_checksum;\n         }\n+        const bool restore_bucketing{nUBuckets == ADDRMAN_NEW_BUCKET_COUNT &&\n+                                     serialized_asmap_checksum == supplied_asmap_checksum};\n \n-        for (int n = 0; n < nNew; n++) {\n-            CAddrInfo &info = mapInfo[n];\n-            int bucket = entryToBucket[n];\n-            int nUBucketPos = info.GetBucketPosition(nKey, true, bucket);\n-            if (format >= Format::V2_ASMAP && nUBuckets == ADDRMAN_NEW_BUCKET_COUNT && vvNew[bucket][nUBucketPos] == -1 &&\n-                info.nRefCount < ADDRMAN_NEW_BUCKETS_PER_ADDRESS && serialized_asmap_version == supplied_asmap_version) {\n+        for (auto bucket_entry : bucket_entries) {\n+            int bucket{bucket_entry.first};\n+            const int entry_index{bucket_entry.second};\n+            CAddrInfo& info = mapInfo[entry_index];\n+\n+            // The entry shouldn't appear in more than\n+            // ADDRMAN_NEW_BUCKETS_PER_ADDRESS. If it has already, just skip\n+            // this bucket_entry.\n+            if (info.nRefCount >= ADDRMAN_NEW_BUCKETS_PER_ADDRESS) continue;\n+\n+            int bucket_position = info.GetBucketPosition(nKey, true, bucket);\n+            if (restore_bucketing && vvNew[bucket][bucket_position] == -1) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r566720943",
      "id" : 566720943,
      "in_reply_to_id" : 564232061,
      "line" : 546,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjcyMDk0Mw==",
      "original_commit_id" : "ac3547eddd8a7d67b4103508f30d5d02a9c1f148",
      "original_line" : 545,
      "original_position" : 102,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 116,
      "pull_request_review_id" : 579122926,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-29T12:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566720943",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r566723508"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566723508"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good catch! I'm just going to move the log to outside the loop to avoid it printing many times. Only printing once seems to be the original intent of this log. Improved logging can be left for a future PR.",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-01-29T10:27:48Z",
      "diff_hunk" : "@@ -500,47 +501,60 @@ friend class CAddrManTest;\n         nTried -= nLost;\n \n         // Store positions in the new table buckets to apply later (if possible).\n-        std::map<int, int> entryToBucket; // Represents which entry belonged to which bucket when serializing\n-\n-        for (int bucket = 0; bucket < nUBuckets; bucket++) {\n-            int nSize = 0;\n-            s >> nSize;\n-            for (int n = 0; n < nSize; n++) {\n-                int nIndex = 0;\n-                s >> nIndex;\n-                if (nIndex >= 0 && nIndex < nNew) {\n-                    entryToBucket[nIndex] = bucket;\n+        // An entry may appear in up to ADDRMAN_NEW_BUCKETS_PER_ADDRESS buckets,\n+        // so we store all bucket-entry_index pairs to iterate through later.\n+        std::vector<std::pair<int, int>> bucket_entries;\n+\n+        for (int bucket = 0; bucket < nUBuckets; ++bucket) {\n+            int num_entries{0};\n+            s >> num_entries;\n+            for (int n = 0; n < num_entries; ++n) {\n+                int entry_index{0};\n+                s >> entry_index;\n+                if (entry_index >= 0 && entry_index < nNew) {\n+                    bucket_entries.emplace_back(bucket, entry_index);\n                 }\n             }\n         }\n \n-        uint256 supplied_asmap_version;\n+        // If the bucket count and asmap checksum haven't changed, then attempt\n+        // to restore the entries to the buckets/positions they were in before\n+        // serialization.\n+        uint256 supplied_asmap_checksum;\n         if (m_asmap.size() != 0) {\n-            supplied_asmap_version = SerializeHash(m_asmap);\n+            supplied_asmap_checksum = SerializeHash(m_asmap);\n         }\n-        uint256 serialized_asmap_version;\n+        uint256 serialized_asmap_checksum;\n         if (format >= Format::V2_ASMAP) {\n-            s >> serialized_asmap_version;\n+            s >> serialized_asmap_checksum;\n         }\n+        const bool restore_bucketing{nUBuckets == ADDRMAN_NEW_BUCKET_COUNT &&\n+                                     serialized_asmap_checksum == supplied_asmap_checksum};\n \n-        for (int n = 0; n < nNew; n++) {\n-            CAddrInfo &info = mapInfo[n];\n-            int bucket = entryToBucket[n];\n-            int nUBucketPos = info.GetBucketPosition(nKey, true, bucket);\n-            if (format >= Format::V2_ASMAP && nUBuckets == ADDRMAN_NEW_BUCKET_COUNT && vvNew[bucket][nUBucketPos] == -1 &&\n-                info.nRefCount < ADDRMAN_NEW_BUCKETS_PER_ADDRESS && serialized_asmap_version == supplied_asmap_version) {\n+        for (auto bucket_entry : bucket_entries) {\n+            int bucket{bucket_entry.first};\n+            const int entry_index{bucket_entry.second};\n+            CAddrInfo& info = mapInfo[entry_index];\n+\n+            // The entry shouldn't appear in more than\n+            // ADDRMAN_NEW_BUCKETS_PER_ADDRESS. If it has already, just skip\n+            // this bucket_entry.\n+            if (info.nRefCount >= ADDRMAN_NEW_BUCKETS_PER_ADDRESS) continue;\n+\n+            int bucket_position = info.GetBucketPosition(nKey, true, bucket);\n+            if (restore_bucketing && vvNew[bucket][bucket_position] == -1) {\n                 // Bucketing has not changed, using existing bucket positions for the new table\n-                vvNew[bucket][nUBucketPos] = n;\n-                info.nRefCount++;\n+                vvNew[bucket][bucket_position] = entry_index;\n+                ++info.nRefCount;\n             } else {\n-                // In case the new table data cannot be used (format unknown, bucket count wrong or new asmap),\n+                // In case the new table data cannot be used (bucket count wrong or new asmap),\n                 // try to give them a reference based on their primary source address.\n                 LogPrint(BCLog::ADDRMAN, \"Bucketing method was updated, re-bucketing addrman entries from disk\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r566723508",
      "id" : 566723508,
      "in_reply_to_id" : 564248956,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjcyMzUwOA==",
      "original_commit_id" : "ac3547eddd8a7d67b4103508f30d5d02a9c1f148",
      "original_line" : 552,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 579126118,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-29T12:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566723508",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r566725650"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566725650"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good suggestions. I've added a new commit that makes these changes.",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-01-29T10:31:30Z",
      "diff_hunk" : "@@ -348,8 +349,8 @@ friend class CAddrManTest;\n      * Notice that vvTried, mapAddr and vVector are never encoded explicitly;\n      * they are instead reconstructed from the other information.\n      *\n-     * vvNew is serialized, but only used if ADDRMAN_UNKNOWN_BUCKET_COUNT didn't change,\n-     * otherwise it is reconstructed as well.\n+     * vvNew is serialized, but only used if ADDRMAN_NEW_BUCKET_COUNT and the asmap checksum\n+     * didn't change, otherwise it is reconstructed as well.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r566725650",
      "id" : 566725650,
      "in_reply_to_id" : 564225855,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjcyNTY1MA==",
      "original_commit_id" : "ac3547eddd8a7d67b4103508f30d5d02a9c1f148",
      "original_line" : 353,
      "original_position" : 15,
      "original_start_line" : 349,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 579129011,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-29T12:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566725650",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @vasild. I've resolved your review comments.\r\n\r\nI haven't taken your fuzz test yet since it seems like there's a bit more work to make sure that it's getting reliable coverage.",
      "created_at" : "2021-01-29T10:32:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#issuecomment-769722383",
      "id" : 769722383,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20557",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2OTcyMjM4Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-29T10:32:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/769722383",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r566738795"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566738795"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks! `s/vVector/vRandom/` in that commit - there is no member named `vVector`.\r\nAlso, consider adding `mapInfo` to the list of members that \"are never encoded explicitly\" - the ids (the keys of that map) are not serialized, only the values (and in different order than in the map).",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-01-29T10:54:35Z",
      "diff_hunk" : "@@ -348,8 +349,8 @@ friend class CAddrManTest;\n      * Notice that vvTried, mapAddr and vVector are never encoded explicitly;\n      * they are instead reconstructed from the other information.\n      *\n-     * vvNew is serialized, but only used if ADDRMAN_UNKNOWN_BUCKET_COUNT didn't change,\n-     * otherwise it is reconstructed as well.\n+     * vvNew is serialized, but only used if ADDRMAN_NEW_BUCKET_COUNT and the asmap checksum\n+     * didn't change, otherwise it is reconstructed as well.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r566738795",
      "id" : 566738795,
      "in_reply_to_id" : 564225855,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjczODc5NQ==",
      "original_commit_id" : "ac3547eddd8a7d67b4103508f30d5d02a9c1f148",
      "original_line" : 353,
      "original_position" : 15,
      "original_start_line" : 349,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 579146221,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-29T12:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566738795",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r566749293"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566749293"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes! So it follows that (correct me if I am wrong):\r\n\r\n* If `restore_bucketing` is `true` then `vvNew[bucket][bucket_position] == -1` is also `true` (position is free, not occupied). So the `if` condition can be reduced to just `if (restore_bucketing) {`.\r\n\r\n* If `restore_bucketing` is `false` then `vvNew[bucket][bucket_position] == -1` may be `true` or `false` depending on the hashing. In this case too, the `if` condition is equivalent to just `if (restore_bucketing) {`.",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-01-29T11:14:00Z",
      "diff_hunk" : "@@ -500,47 +501,60 @@ friend class CAddrManTest;\n         nTried -= nLost;\n \n         // Store positions in the new table buckets to apply later (if possible).\n-        std::map<int, int> entryToBucket; // Represents which entry belonged to which bucket when serializing\n-\n-        for (int bucket = 0; bucket < nUBuckets; bucket++) {\n-            int nSize = 0;\n-            s >> nSize;\n-            for (int n = 0; n < nSize; n++) {\n-                int nIndex = 0;\n-                s >> nIndex;\n-                if (nIndex >= 0 && nIndex < nNew) {\n-                    entryToBucket[nIndex] = bucket;\n+        // An entry may appear in up to ADDRMAN_NEW_BUCKETS_PER_ADDRESS buckets,\n+        // so we store all bucket-entry_index pairs to iterate through later.\n+        std::vector<std::pair<int, int>> bucket_entries;\n+\n+        for (int bucket = 0; bucket < nUBuckets; ++bucket) {\n+            int num_entries{0};\n+            s >> num_entries;\n+            for (int n = 0; n < num_entries; ++n) {\n+                int entry_index{0};\n+                s >> entry_index;\n+                if (entry_index >= 0 && entry_index < nNew) {\n+                    bucket_entries.emplace_back(bucket, entry_index);\n                 }\n             }\n         }\n \n-        uint256 supplied_asmap_version;\n+        // If the bucket count and asmap checksum haven't changed, then attempt\n+        // to restore the entries to the buckets/positions they were in before\n+        // serialization.\n+        uint256 supplied_asmap_checksum;\n         if (m_asmap.size() != 0) {\n-            supplied_asmap_version = SerializeHash(m_asmap);\n+            supplied_asmap_checksum = SerializeHash(m_asmap);\n         }\n-        uint256 serialized_asmap_version;\n+        uint256 serialized_asmap_checksum;\n         if (format >= Format::V2_ASMAP) {\n-            s >> serialized_asmap_version;\n+            s >> serialized_asmap_checksum;\n         }\n+        const bool restore_bucketing{nUBuckets == ADDRMAN_NEW_BUCKET_COUNT &&\n+                                     serialized_asmap_checksum == supplied_asmap_checksum};\n \n-        for (int n = 0; n < nNew; n++) {\n-            CAddrInfo &info = mapInfo[n];\n-            int bucket = entryToBucket[n];\n-            int nUBucketPos = info.GetBucketPosition(nKey, true, bucket);\n-            if (format >= Format::V2_ASMAP && nUBuckets == ADDRMAN_NEW_BUCKET_COUNT && vvNew[bucket][nUBucketPos] == -1 &&\n-                info.nRefCount < ADDRMAN_NEW_BUCKETS_PER_ADDRESS && serialized_asmap_version == supplied_asmap_version) {\n+        for (auto bucket_entry : bucket_entries) {\n+            int bucket{bucket_entry.first};\n+            const int entry_index{bucket_entry.second};\n+            CAddrInfo& info = mapInfo[entry_index];\n+\n+            // The entry shouldn't appear in more than\n+            // ADDRMAN_NEW_BUCKETS_PER_ADDRESS. If it has already, just skip\n+            // this bucket_entry.\n+            if (info.nRefCount >= ADDRMAN_NEW_BUCKETS_PER_ADDRESS) continue;\n+\n+            int bucket_position = info.GetBucketPosition(nKey, true, bucket);\n+            if (restore_bucketing && vvNew[bucket][bucket_position] == -1) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r566749293",
      "id" : 566749293,
      "in_reply_to_id" : 564232061,
      "line" : 546,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njc0OTI5Mw==",
      "original_commit_id" : "ac3547eddd8a7d67b4103508f30d5d02a9c1f148",
      "original_line" : 545,
      "original_position" : 102,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 116,
      "pull_request_review_id" : 579160313,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-29T12:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566749293",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r566750699"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566750699"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`s/restore_bucketing/!restore_bucketing/` in 9a0760db4?",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-01-29T11:16:40Z",
      "diff_hunk" : "@@ -500,47 +501,60 @@ friend class CAddrManTest;\n         nTried -= nLost;\n \n         // Store positions in the new table buckets to apply later (if possible).\n-        std::map<int, int> entryToBucket; // Represents which entry belonged to which bucket when serializing\n-\n-        for (int bucket = 0; bucket < nUBuckets; bucket++) {\n-            int nSize = 0;\n-            s >> nSize;\n-            for (int n = 0; n < nSize; n++) {\n-                int nIndex = 0;\n-                s >> nIndex;\n-                if (nIndex >= 0 && nIndex < nNew) {\n-                    entryToBucket[nIndex] = bucket;\n+        // An entry may appear in up to ADDRMAN_NEW_BUCKETS_PER_ADDRESS buckets,\n+        // so we store all bucket-entry_index pairs to iterate through later.\n+        std::vector<std::pair<int, int>> bucket_entries;\n+\n+        for (int bucket = 0; bucket < nUBuckets; ++bucket) {\n+            int num_entries{0};\n+            s >> num_entries;\n+            for (int n = 0; n < num_entries; ++n) {\n+                int entry_index{0};\n+                s >> entry_index;\n+                if (entry_index >= 0 && entry_index < nNew) {\n+                    bucket_entries.emplace_back(bucket, entry_index);\n                 }\n             }\n         }\n \n-        uint256 supplied_asmap_version;\n+        // If the bucket count and asmap checksum haven't changed, then attempt\n+        // to restore the entries to the buckets/positions they were in before\n+        // serialization.\n+        uint256 supplied_asmap_checksum;\n         if (m_asmap.size() != 0) {\n-            supplied_asmap_version = SerializeHash(m_asmap);\n+            supplied_asmap_checksum = SerializeHash(m_asmap);\n         }\n-        uint256 serialized_asmap_version;\n+        uint256 serialized_asmap_checksum;\n         if (format >= Format::V2_ASMAP) {\n-            s >> serialized_asmap_version;\n+            s >> serialized_asmap_checksum;\n         }\n+        const bool restore_bucketing{nUBuckets == ADDRMAN_NEW_BUCKET_COUNT &&\n+                                     serialized_asmap_checksum == supplied_asmap_checksum};\n \n-        for (int n = 0; n < nNew; n++) {\n-            CAddrInfo &info = mapInfo[n];\n-            int bucket = entryToBucket[n];\n-            int nUBucketPos = info.GetBucketPosition(nKey, true, bucket);\n-            if (format >= Format::V2_ASMAP && nUBuckets == ADDRMAN_NEW_BUCKET_COUNT && vvNew[bucket][nUBucketPos] == -1 &&\n-                info.nRefCount < ADDRMAN_NEW_BUCKETS_PER_ADDRESS && serialized_asmap_version == supplied_asmap_version) {\n+        for (auto bucket_entry : bucket_entries) {\n+            int bucket{bucket_entry.first};\n+            const int entry_index{bucket_entry.second};\n+            CAddrInfo& info = mapInfo[entry_index];\n+\n+            // The entry shouldn't appear in more than\n+            // ADDRMAN_NEW_BUCKETS_PER_ADDRESS. If it has already, just skip\n+            // this bucket_entry.\n+            if (info.nRefCount >= ADDRMAN_NEW_BUCKETS_PER_ADDRESS) continue;\n+\n+            int bucket_position = info.GetBucketPosition(nKey, true, bucket);\n+            if (restore_bucketing && vvNew[bucket][bucket_position] == -1) {\n                 // Bucketing has not changed, using existing bucket positions for the new table\n-                vvNew[bucket][nUBucketPos] = n;\n-                info.nRefCount++;\n+                vvNew[bucket][bucket_position] = entry_index;\n+                ++info.nRefCount;\n             } else {\n-                // In case the new table data cannot be used (format unknown, bucket count wrong or new asmap),\n+                // In case the new table data cannot be used (bucket count wrong or new asmap),\n                 // try to give them a reference based on their primary source address.\n                 LogPrint(BCLog::ADDRMAN, \"Bucketing method was updated, re-bucketing addrman entries from disk\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r566750699",
      "id" : 566750699,
      "in_reply_to_id" : 564248956,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njc1MDY5OQ==",
      "original_commit_id" : "ac3547eddd8a7d67b4103508f30d5d02a9c1f148",
      "original_line" : 552,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 579162110,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-29T12:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566750699",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r566789137"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566789137"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think `vvNew[bucket][bucket_position] == -1` is just a belt-and-suspenders. It shouldn't be hit (if so, then something has gone wrong with the position serializing/deserializing to place two addresses in the same bucket/position). I think you're right that we can just remove it, but can we leave that as a follow-up? We can't fix _all_ of addrman's problems in one PR :)",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-01-29T12:30:50Z",
      "diff_hunk" : "@@ -500,47 +501,60 @@ friend class CAddrManTest;\n         nTried -= nLost;\n \n         // Store positions in the new table buckets to apply later (if possible).\n-        std::map<int, int> entryToBucket; // Represents which entry belonged to which bucket when serializing\n-\n-        for (int bucket = 0; bucket < nUBuckets; bucket++) {\n-            int nSize = 0;\n-            s >> nSize;\n-            for (int n = 0; n < nSize; n++) {\n-                int nIndex = 0;\n-                s >> nIndex;\n-                if (nIndex >= 0 && nIndex < nNew) {\n-                    entryToBucket[nIndex] = bucket;\n+        // An entry may appear in up to ADDRMAN_NEW_BUCKETS_PER_ADDRESS buckets,\n+        // so we store all bucket-entry_index pairs to iterate through later.\n+        std::vector<std::pair<int, int>> bucket_entries;\n+\n+        for (int bucket = 0; bucket < nUBuckets; ++bucket) {\n+            int num_entries{0};\n+            s >> num_entries;\n+            for (int n = 0; n < num_entries; ++n) {\n+                int entry_index{0};\n+                s >> entry_index;\n+                if (entry_index >= 0 && entry_index < nNew) {\n+                    bucket_entries.emplace_back(bucket, entry_index);\n                 }\n             }\n         }\n \n-        uint256 supplied_asmap_version;\n+        // If the bucket count and asmap checksum haven't changed, then attempt\n+        // to restore the entries to the buckets/positions they were in before\n+        // serialization.\n+        uint256 supplied_asmap_checksum;\n         if (m_asmap.size() != 0) {\n-            supplied_asmap_version = SerializeHash(m_asmap);\n+            supplied_asmap_checksum = SerializeHash(m_asmap);\n         }\n-        uint256 serialized_asmap_version;\n+        uint256 serialized_asmap_checksum;\n         if (format >= Format::V2_ASMAP) {\n-            s >> serialized_asmap_version;\n+            s >> serialized_asmap_checksum;\n         }\n+        const bool restore_bucketing{nUBuckets == ADDRMAN_NEW_BUCKET_COUNT &&\n+                                     serialized_asmap_checksum == supplied_asmap_checksum};\n \n-        for (int n = 0; n < nNew; n++) {\n-            CAddrInfo &info = mapInfo[n];\n-            int bucket = entryToBucket[n];\n-            int nUBucketPos = info.GetBucketPosition(nKey, true, bucket);\n-            if (format >= Format::V2_ASMAP && nUBuckets == ADDRMAN_NEW_BUCKET_COUNT && vvNew[bucket][nUBucketPos] == -1 &&\n-                info.nRefCount < ADDRMAN_NEW_BUCKETS_PER_ADDRESS && serialized_asmap_version == supplied_asmap_version) {\n+        for (auto bucket_entry : bucket_entries) {\n+            int bucket{bucket_entry.first};\n+            const int entry_index{bucket_entry.second};\n+            CAddrInfo& info = mapInfo[entry_index];\n+\n+            // The entry shouldn't appear in more than\n+            // ADDRMAN_NEW_BUCKETS_PER_ADDRESS. If it has already, just skip\n+            // this bucket_entry.\n+            if (info.nRefCount >= ADDRMAN_NEW_BUCKETS_PER_ADDRESS) continue;\n+\n+            int bucket_position = info.GetBucketPosition(nKey, true, bucket);\n+            if (restore_bucketing && vvNew[bucket][bucket_position] == -1) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r566789137",
      "id" : 566789137,
      "in_reply_to_id" : 564232061,
      "line" : 546,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njc4OTEzNw==",
      "original_commit_id" : "ac3547eddd8a7d67b4103508f30d5d02a9c1f148",
      "original_line" : 545,
      "original_position" : 102,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 116,
      "pull_request_review_id" : 579212255,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-29T12:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566789137",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r566789249"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566789249"
         }
      },
      "author_association" : "MEMBER",
      "body" : ":man_facepalming: You're right of course. I'll fix.",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-01-29T12:31:04Z",
      "diff_hunk" : "@@ -500,47 +501,60 @@ friend class CAddrManTest;\n         nTried -= nLost;\n \n         // Store positions in the new table buckets to apply later (if possible).\n-        std::map<int, int> entryToBucket; // Represents which entry belonged to which bucket when serializing\n-\n-        for (int bucket = 0; bucket < nUBuckets; bucket++) {\n-            int nSize = 0;\n-            s >> nSize;\n-            for (int n = 0; n < nSize; n++) {\n-                int nIndex = 0;\n-                s >> nIndex;\n-                if (nIndex >= 0 && nIndex < nNew) {\n-                    entryToBucket[nIndex] = bucket;\n+        // An entry may appear in up to ADDRMAN_NEW_BUCKETS_PER_ADDRESS buckets,\n+        // so we store all bucket-entry_index pairs to iterate through later.\n+        std::vector<std::pair<int, int>> bucket_entries;\n+\n+        for (int bucket = 0; bucket < nUBuckets; ++bucket) {\n+            int num_entries{0};\n+            s >> num_entries;\n+            for (int n = 0; n < num_entries; ++n) {\n+                int entry_index{0};\n+                s >> entry_index;\n+                if (entry_index >= 0 && entry_index < nNew) {\n+                    bucket_entries.emplace_back(bucket, entry_index);\n                 }\n             }\n         }\n \n-        uint256 supplied_asmap_version;\n+        // If the bucket count and asmap checksum haven't changed, then attempt\n+        // to restore the entries to the buckets/positions they were in before\n+        // serialization.\n+        uint256 supplied_asmap_checksum;\n         if (m_asmap.size() != 0) {\n-            supplied_asmap_version = SerializeHash(m_asmap);\n+            supplied_asmap_checksum = SerializeHash(m_asmap);\n         }\n-        uint256 serialized_asmap_version;\n+        uint256 serialized_asmap_checksum;\n         if (format >= Format::V2_ASMAP) {\n-            s >> serialized_asmap_version;\n+            s >> serialized_asmap_checksum;\n         }\n+        const bool restore_bucketing{nUBuckets == ADDRMAN_NEW_BUCKET_COUNT &&\n+                                     serialized_asmap_checksum == supplied_asmap_checksum};\n \n-        for (int n = 0; n < nNew; n++) {\n-            CAddrInfo &info = mapInfo[n];\n-            int bucket = entryToBucket[n];\n-            int nUBucketPos = info.GetBucketPosition(nKey, true, bucket);\n-            if (format >= Format::V2_ASMAP && nUBuckets == ADDRMAN_NEW_BUCKET_COUNT && vvNew[bucket][nUBucketPos] == -1 &&\n-                info.nRefCount < ADDRMAN_NEW_BUCKETS_PER_ADDRESS && serialized_asmap_version == supplied_asmap_version) {\n+        for (auto bucket_entry : bucket_entries) {\n+            int bucket{bucket_entry.first};\n+            const int entry_index{bucket_entry.second};\n+            CAddrInfo& info = mapInfo[entry_index];\n+\n+            // The entry shouldn't appear in more than\n+            // ADDRMAN_NEW_BUCKETS_PER_ADDRESS. If it has already, just skip\n+            // this bucket_entry.\n+            if (info.nRefCount >= ADDRMAN_NEW_BUCKETS_PER_ADDRESS) continue;\n+\n+            int bucket_position = info.GetBucketPosition(nKey, true, bucket);\n+            if (restore_bucketing && vvNew[bucket][bucket_position] == -1) {\n                 // Bucketing has not changed, using existing bucket positions for the new table\n-                vvNew[bucket][nUBucketPos] = n;\n-                info.nRefCount++;\n+                vvNew[bucket][bucket_position] = entry_index;\n+                ++info.nRefCount;\n             } else {\n-                // In case the new table data cannot be used (format unknown, bucket count wrong or new asmap),\n+                // In case the new table data cannot be used (bucket count wrong or new asmap),\n                 // try to give them a reference based on their primary source address.\n                 LogPrint(BCLog::ADDRMAN, \"Bucketing method was updated, re-bucketing addrman entries from disk\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r566789249",
      "id" : 566789249,
      "in_reply_to_id" : 564248956,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njc4OTI0OQ==",
      "original_commit_id" : "ac3547eddd8a7d67b4103508f30d5d02a9c1f148",
      "original_line" : 552,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 579212417,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-29T12:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566789249",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r566793958"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566793958"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks. I applied the diff by hand and missed those. Now fixed!",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-01-29T12:40:18Z",
      "diff_hunk" : "@@ -348,8 +349,8 @@ friend class CAddrManTest;\n      * Notice that vvTried, mapAddr and vVector are never encoded explicitly;\n      * they are instead reconstructed from the other information.\n      *\n-     * vvNew is serialized, but only used if ADDRMAN_UNKNOWN_BUCKET_COUNT didn't change,\n-     * otherwise it is reconstructed as well.\n+     * vvNew is serialized, but only used if ADDRMAN_NEW_BUCKET_COUNT and the asmap checksum\n+     * didn't change, otherwise it is reconstructed as well.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r566793958",
      "id" : 566793958,
      "in_reply_to_id" : 564225855,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njc5Mzk1OA==",
      "original_commit_id" : "ac3547eddd8a7d67b4103508f30d5d02a9c1f148",
      "original_line" : 353,
      "original_position" : 15,
      "original_start_line" : 349,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 579218968,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-01-29T12:40:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566793958",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK 4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b\r\n\r\n* The addition of a fuzzing test (https://github.com/jnewbery/bitcoin/pull/18) is not a show stopper for this PR.\r\n* To my understanding, the unneeded [`vvNew[bucket][bucket_position] == -1`](https://github.com/bitcoin/bitcoin/pull/20557/files#diff-164bd9e2e30f54d0a79eb7cc372309e2f2155edc6c3f051290ab078f03f6a771R546) can be removed. It was part of the code before this PR and is doing no harm (other than confusion). Not a show stopper either.",
      "created_at" : "2021-01-29T14:24:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#issuecomment-769834905",
      "id" : 769834905,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20557",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2OTgzNDkwNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-29T14:24:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/769834905",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r566859824"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566859824"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Alright, so either we are both correct that this is redundant and not needed, or we are both wrong!\r\n\r\nIf we are wrong, and it can happen that `restore_bucketing` is `true` and `vvNew[bucket][bucket_position] == -1` is `false` (occupied!) then moving the `LogPrint()` call was wrong because it would have been executed inside the `else` branch and now it will not be executed because now it is conditional only on `restore_bucketing`.",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-01-29T14:30:02Z",
      "diff_hunk" : "@@ -500,47 +501,60 @@ friend class CAddrManTest;\n         nTried -= nLost;\n \n         // Store positions in the new table buckets to apply later (if possible).\n-        std::map<int, int> entryToBucket; // Represents which entry belonged to which bucket when serializing\n-\n-        for (int bucket = 0; bucket < nUBuckets; bucket++) {\n-            int nSize = 0;\n-            s >> nSize;\n-            for (int n = 0; n < nSize; n++) {\n-                int nIndex = 0;\n-                s >> nIndex;\n-                if (nIndex >= 0 && nIndex < nNew) {\n-                    entryToBucket[nIndex] = bucket;\n+        // An entry may appear in up to ADDRMAN_NEW_BUCKETS_PER_ADDRESS buckets,\n+        // so we store all bucket-entry_index pairs to iterate through later.\n+        std::vector<std::pair<int, int>> bucket_entries;\n+\n+        for (int bucket = 0; bucket < nUBuckets; ++bucket) {\n+            int num_entries{0};\n+            s >> num_entries;\n+            for (int n = 0; n < num_entries; ++n) {\n+                int entry_index{0};\n+                s >> entry_index;\n+                if (entry_index >= 0 && entry_index < nNew) {\n+                    bucket_entries.emplace_back(bucket, entry_index);\n                 }\n             }\n         }\n \n-        uint256 supplied_asmap_version;\n+        // If the bucket count and asmap checksum haven't changed, then attempt\n+        // to restore the entries to the buckets/positions they were in before\n+        // serialization.\n+        uint256 supplied_asmap_checksum;\n         if (m_asmap.size() != 0) {\n-            supplied_asmap_version = SerializeHash(m_asmap);\n+            supplied_asmap_checksum = SerializeHash(m_asmap);\n         }\n-        uint256 serialized_asmap_version;\n+        uint256 serialized_asmap_checksum;\n         if (format >= Format::V2_ASMAP) {\n-            s >> serialized_asmap_version;\n+            s >> serialized_asmap_checksum;\n         }\n+        const bool restore_bucketing{nUBuckets == ADDRMAN_NEW_BUCKET_COUNT &&\n+                                     serialized_asmap_checksum == supplied_asmap_checksum};\n \n-        for (int n = 0; n < nNew; n++) {\n-            CAddrInfo &info = mapInfo[n];\n-            int bucket = entryToBucket[n];\n-            int nUBucketPos = info.GetBucketPosition(nKey, true, bucket);\n-            if (format >= Format::V2_ASMAP && nUBuckets == ADDRMAN_NEW_BUCKET_COUNT && vvNew[bucket][nUBucketPos] == -1 &&\n-                info.nRefCount < ADDRMAN_NEW_BUCKETS_PER_ADDRESS && serialized_asmap_version == supplied_asmap_version) {\n+        for (auto bucket_entry : bucket_entries) {\n+            int bucket{bucket_entry.first};\n+            const int entry_index{bucket_entry.second};\n+            CAddrInfo& info = mapInfo[entry_index];\n+\n+            // The entry shouldn't appear in more than\n+            // ADDRMAN_NEW_BUCKETS_PER_ADDRESS. If it has already, just skip\n+            // this bucket_entry.\n+            if (info.nRefCount >= ADDRMAN_NEW_BUCKETS_PER_ADDRESS) continue;\n+\n+            int bucket_position = info.GetBucketPosition(nKey, true, bucket);\n+            if (restore_bucketing && vvNew[bucket][bucket_position] == -1) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r566859824",
      "id" : 566859824,
      "in_reply_to_id" : 564232061,
      "line" : 546,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njg1OTgyNA==",
      "original_commit_id" : "ac3547eddd8a7d67b4103508f30d5d02a9c1f148",
      "original_line" : 545,
      "original_position" : 102,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 116,
      "pull_request_review_id" : 579307091,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-29T14:30:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566859824",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "re-ACK https://github.com/bitcoin/bitcoin/commit/4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b, changes were a rename, comments, and removing repeat-logging.",
      "created_at" : "2021-01-29T23:28:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#issuecomment-770103446",
      "id" : 770103446,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20557",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3MDEwMzQ0Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-29T23:28:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/770103446",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 4676a4f",
      "created_at" : "2021-01-30T09:04:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#issuecomment-770181141",
      "id" : 770181141,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20557",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3MDE4MTE0MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-30T09:04:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/770181141",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@MarcoFalke or @laanwj - this PR now has 3 ACKs. If one of you re-reviewed, then it might be ready for merge.",
      "created_at" : "2021-02-03T11:13:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#issuecomment-772430279",
      "id" : 772430279,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20557",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3MjQzMDI3OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-03T11:13:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/772430279",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572398580"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572398580"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[addrman] Fix new table bucketing during unserialization\" (b4c5fda417dd9ff8bf9fe24a87d384a649e3730d)\r\n\r\nCould avoid some verbosity here with\r\n\r\n```diff\r\n-        for (auto bucket_entry : bucket_entries) {\r\n-            int bucket{bucket_entry.first};\r\n-            const int n{bucket_entry.second};\r\n+        for (auto [bucket, n] : bucket_entries) {\r\n```",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-02-08T21:50:11Z",
      "diff_hunk" : "@@ -523,9 +525,10 @@ friend class CAddrManTest;\n             s >> serialized_asmap_version;\n         }\n \n-        for (int n = 0; n < nNew; n++) {\n-            CAddrInfo &info = mapInfo[n];\n-            int bucket = entryToBucket[n];\n+        for (auto bucket_entry : bucket_entries) {\n+            int bucket{bucket_entry.first};\n+            const int n{bucket_entry.second};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572398580",
      "id" : 572398580,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjM5ODU4MA==",
      "original_commit_id" : "b4c5fda417dd9ff8bf9fe24a87d384a649e3730d",
      "original_line" : 530,
      "original_position" : 29,
      "original_start_line" : 528,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 585955142,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-02-09T02:43:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572398580",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572401734"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572401734"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[addrman] Fix new table bucketing during unserialization\" (b4c5fda417dd9ff8bf9fe24a87d384a649e3730d)\r\n\r\nSeems like having a data structure here is superfluous if it's just going to be filled up then immediately iterated over and discarded. Maybe it would make sense to remove this vector later.",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-02-08T21:55:44Z",
      "diff_hunk" : "@@ -500,7 +500,9 @@ friend class CAddrManTest;\n         nTried -= nLost;\n \n         // Store positions in the new table buckets to apply later (if possible).\n-        std::map<int, int> entryToBucket; // Represents which entry belonged to which bucket when serializing\n+        // An entry may appear in up to ADDRMAN_NEW_BUCKETS_PER_ADDRESS buckets,\n+        // so we store all bucket-entry_index pairs to iterate through later.\n+        std::vector<std::pair<int, int>> bucket_entries;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572401734",
      "id" : 572401734,
      "line" : 503,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjQwMTczNA==",
      "original_commit_id" : "b4c5fda417dd9ff8bf9fe24a87d384a649e3730d",
      "original_line" : 505,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 63,
      "pull_request_review_id" : 585955142,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-09T02:43:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572401734",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572410044"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572410044"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[addrman] Fix new table bucketing during unserialization\" (b4c5fda417dd9ff8bf9fe24a87d384a649e3730d)\r\n\r\nIt would be good to have some test coverage for this. A functional test might be hard but I would think a c++ unit test should be straightforward. Past bugs predict future bugs so a test here could steer coverage in a useful direction.",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-02-08T22:07:17Z",
      "diff_hunk" : "@@ -509,7 +511,7 @@ friend class CAddrManTest;\n                 int nIndex = 0;\n                 s >> nIndex;\n                 if (nIndex >= 0 && nIndex < nNew) {\n-                    entryToBucket[nIndex] = bucket;\n+                    bucket_entries.emplace_back(bucket, nIndex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572410044",
      "id" : 572410044,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjQxMDA0NA==",
      "original_commit_id" : "b4c5fda417dd9ff8bf9fe24a87d384a649e3730d",
      "original_line" : 514,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 585955142,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-09T02:43:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572410044",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572506601"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572506601"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The old code iterates over `mapInfo[0..nNew]`, so we were guaranteed that all `CAddrInfo`s in the new table make their way into `vvNew` (either in the old buckets, or newly assigned ones in the else block below). With the new code, we have an implicit assumption that `bucket_entries.size() == nNew`. Is that safe to assume? I _think_ it is but just wanted to ask since we are iterating over a different part of the serialized data now.",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-02-09T01:43:45Z",
      "diff_hunk" : "@@ -523,9 +525,10 @@ friend class CAddrManTest;\n             s >> serialized_asmap_version;\n         }\n \n-        for (int n = 0; n < nNew; n++) {\n-            CAddrInfo &info = mapInfo[n];\n-            int bucket = entryToBucket[n];\n+        for (auto bucket_entry : bucket_entries) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572506601",
      "id" : 572506601,
      "line" : 535,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjUwNjYwMQ==",
      "original_commit_id" : "b4c5fda417dd9ff8bf9fe24a87d384a649e3730d",
      "original_line" : 528,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 105,
      "pull_request_review_id" : 586080477,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-09T02:12:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572506601",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572507304"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572507304"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "(nit) since `entry_index` can be confused with the for-loop index, perhaps `entry_id` is better (to match `nIdCount`)?",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-02-09T01:45:45Z",
      "diff_hunk" : "@@ -504,14 +504,14 @@ friend class CAddrManTest;\n         // so we store all bucket-entry_index pairs to iterate through later.\n         std::vector<std::pair<int, int>> bucket_entries;\n \n-        for (int bucket = 0; bucket < nUBuckets; bucket++) {\n-            int nSize = 0;\n-            s >> nSize;\n-            for (int n = 0; n < nSize; n++) {\n-                int nIndex = 0;\n-                s >> nIndex;\n-                if (nIndex >= 0 && nIndex < nNew) {\n-                    bucket_entries.emplace_back(bucket, nIndex);\n+        for (int bucket = 0; bucket < nUBuckets; ++bucket) {\n+            int num_entries{0};\n+            s >> num_entries;\n+            for (int n = 0; n < num_entries; ++n) {\n+                int entry_index{0};\n+                s >> entry_index;\n+                if (entry_index >= 0 && entry_index < nNew) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572507304",
      "id" : 572507304,
      "line" : 511,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjUwNzMwNA==",
      "original_commit_id" : "009b8e0fdf3bfb11668edacced5d8b70726d5d0e",
      "original_line" : 513,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 71,
      "pull_request_review_id" : 586080477,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-09T02:08:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572507304",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572507981"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572507981"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thank you! I actually tripped over this while reading the old code.\r\n\r\n(nit) could this is a `scripted-diff`?",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-02-09T01:47:41Z",
      "diff_hunk" : "@@ -413,13 +414,13 @@ friend class CAddrManTest;\n                 }\n             }\n         }\n-        // Store asmap version after bucket entries so that it\n+        // Store asmap checksum after bucket entries so that it\n         // can be ignored by older clients for backward compatibility.\n-        uint256 asmap_version;\n+        uint256 asmap_checksum;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572507981",
      "id" : 572507981,
      "line" : 416,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjUwNzk4MQ==",
      "original_commit_id" : "8062d928ce5c495c1b6ecd18e4b30c12da822d90",
      "original_line" : 419,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 37,
      "pull_request_review_id" : 586080477,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-09T02:08:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572507981",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572509364"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572509364"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[addrman] Don't rebucket new table entries unnecessarily\" (a5c9b04959f443372400f9a736c6eaf5502284a1)\r\n\r\nIt would be good if comment could say when this condition happens. Particularly if there is any case where it's expected to happen, or if it can only happen loading bad data.\r\n\r\nAlso, discarding entries after max buckets reached seems like another subtle change in behavior that could benefit from a simple unit test. (Or if this an unimportant edge case that doesn't merit a test, maybe it also doesn't merit special handling in the code.)",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-02-09T01:51:21Z",
      "diff_hunk" : "@@ -525,19 +527,26 @@ friend class CAddrManTest;\n         if (format >= Format::V2_ASMAP) {\n             s >> serialized_asmap_checksum;\n         }\n+        const bool restore_bucketing{nUBuckets == ADDRMAN_NEW_BUCKET_COUNT &&\n+                                     serialized_asmap_checksum == supplied_asmap_checksum};\n \n         for (auto bucket_entry : bucket_entries) {\n             int bucket{bucket_entry.first};\n             const int entry_index{bucket_entry.second};\n             CAddrInfo& info = mapInfo[entry_index];\n+\n+            // The entry shouldn't appear in more than\n+            // ADDRMAN_NEW_BUCKETS_PER_ADDRESS. If it has already, just skip\n+            // this bucket_entry.\n+            if (info.nRefCount >= ADDRMAN_NEW_BUCKETS_PER_ADDRESS) continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572509364",
      "id" : 572509364,
      "line" : 543,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjUwOTM2NA==",
      "original_commit_id" : "a5c9b04959f443372400f9a736c6eaf5502284a1",
      "original_line" : 541,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 113,
      "pull_request_review_id" : 585955142,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-09T02:43:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572509364",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572513322"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572513322"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In the format above aren't lines 340-342 an encoding of `vvNew`? If so, why remove this comment?",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-02-09T02:02:44Z",
      "diff_hunk" : "@@ -335,23 +335,20 @@ friend class CAddrManTest;\n      * * nNew\n      * * nTried\n      * * number of \"new\" buckets XOR 2**30\n-     * * all nNew addrinfos in vvNew\n-     * * all nTried addrinfos in vvTried\n-     * * for each bucket:\n+     * * all new addresses (total count: nNew)\n+     * * all tried addresses (total count: nTried)\n+     * * for each new bucket:\n      *   * number of elements\n-     *   * for each element: index\n+     *   * for each element: index in the serialized \"all new addresses\"\n      * * asmap checksum\n      *\n      * 2**30 is xorred with the number of buckets to make addrman deserializer v0 detect it\n      * as incompatible. This is necessary because it did not check the version number on\n      * deserialization.\n      *\n-     * Notice that vvTried, mapAddr and vVector are never encoded explicitly;\n+     * vvNew, vvTried, mapInfo, mapAddr and vRandom are never encoded explicitly;\n      * they are instead reconstructed from the other information.\n      *\n-     * vvNew is serialized, but only used if ADDRMAN_NEW_BUCKET_COUNT and the asmap checksum",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572513322",
      "id" : 572513322,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjUxMzMyMg==",
      "original_commit_id" : "436292367c1d737cf73bd985293539500d1206f5",
      "original_line" : 352,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 586080477,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-09T02:23:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572513322",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/856960?v=4",
         "events_url" : "https://api.github.com/users/dhruv/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dhruv/followers",
         "following_url" : "https://api.github.com/users/dhruv/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dhruv/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dhruv",
         "id" : 856960,
         "login" : "dhruv",
         "node_id" : "MDQ6VXNlcjg1Njk2MA==",
         "organizations_url" : "https://api.github.com/users/dhruv/orgs",
         "received_events_url" : "https://api.github.com/users/dhruv/received_events",
         "repos_url" : "https://api.github.com/users/dhruv/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dhruv/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dhruv"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572518900"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572518900"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[addrman] Don't rebucket new table entries unnecessarily\" (a5c9b04959f443372400f9a736c6eaf5502284a1)\r\n\r\nJust some notes to make sure I'm following this correctly.\r\n\r\n- The `restore_bucketing` change here is aesthetic and the only actual change this line is dropping the `format >= Format::V2_ASMAP` condition. \r\n- The effect of dropping `format` condition is this will now keep existing bucket positions instead of rebucketing when an old format is loaded and there is no asmap. (\"Only rebucket if\" in commit description means \"Use existing bucket positions if\")\r\n- In the case where an old format is loaded an there is an asmap, this logic isn't triggered because the `serialized_asmap_checksum == supplied_asmap_checksum` condition is false.\r\n- Maybe could be a unit test checking old format number + no asmap uses  existing bucket positions",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-02-09T02:19:25Z",
      "diff_hunk" : "@@ -525,19 +527,26 @@ friend class CAddrManTest;\n         if (format >= Format::V2_ASMAP) {\n             s >> serialized_asmap_checksum;\n         }\n+        const bool restore_bucketing{nUBuckets == ADDRMAN_NEW_BUCKET_COUNT &&\n+                                     serialized_asmap_checksum == supplied_asmap_checksum};\n \n         for (auto bucket_entry : bucket_entries) {\n             int bucket{bucket_entry.first};\n             const int entry_index{bucket_entry.second};\n             CAddrInfo& info = mapInfo[entry_index];\n+\n+            // The entry shouldn't appear in more than\n+            // ADDRMAN_NEW_BUCKETS_PER_ADDRESS. If it has already, just skip\n+            // this bucket_entry.\n+            if (info.nRefCount >= ADDRMAN_NEW_BUCKETS_PER_ADDRESS) continue;\n+\n             int nUBucketPos = info.GetBucketPosition(nKey, true, bucket);\n-            if (format >= Format::V2_ASMAP && nUBuckets == ADDRMAN_NEW_BUCKET_COUNT && vvNew[bucket][nUBucketPos] == -1 &&\n-                info.nRefCount < ADDRMAN_NEW_BUCKETS_PER_ADDRESS && serialized_asmap_checksum == supplied_asmap_checksum) {\n+            if (restore_bucketing && vvNew[bucket][nUBucketPos] == -1) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572518900",
      "id" : 572518900,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjUxODkwMA==",
      "original_commit_id" : "a5c9b04959f443372400f9a736c6eaf5502284a1",
      "original_line" : 544,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 585955142,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-09T02:43:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572518900",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572736572"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572736572"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think `bucket_entries.size() >= nNew`, let me use an example:\r\n\r\n```\r\nmapInfo[id=3] = 1.1.1.1\r\n// for the example, I pick up some arbitrary indexes in vvNew\r\nvvNew[2][5] = id=3\r\nvvNew[4][9] = id=3\r\nnNew = 1\r\n```\r\n\r\nThis would be serialized on disk as:\r\n\r\n```\r\n1 (nNew)\r\n0 (nTried)\r\n1024 (new_bucket_count)\r\n1.1.1.1 (list of new addresses) (*)\r\n(zero tried addresses)\r\n0 (number of elements in vvNew[0])\r\n0 (number of elements in vvNew[1])\r\n1 (number of elements in vvNew[2])\r\n0 (the index in (*) of the first non empty element in vvNew[2])\r\n0 (number of elements in vvNew[3])\r\n1 (number of elements in vvNew[4])\r\n0 (the index in (*) of the first non empty element in vvNew[4])\r\n0 (number of elements in vvNew[5])\r\n...\r\n0 (number of elements in vvNew[1023])\r\n```\r\n\r\nDuring unserialization, in the new code from this PR, this will result in:\r\n\r\n```\r\nbucket_entries[0] = (bucket = 2, index in (*) = 0)\r\nbucket_entries[1] = (bucket = 4, index in (*) = 0)\r\n```\r\n\r\nSo, `bucket_entries.size() = 2` while `nNew = 1`.\r\n",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-02-09T09:46:33Z",
      "diff_hunk" : "@@ -523,9 +525,10 @@ friend class CAddrManTest;\n             s >> serialized_asmap_version;\n         }\n \n-        for (int n = 0; n < nNew; n++) {\n-            CAddrInfo &info = mapInfo[n];\n-            int bucket = entryToBucket[n];\n+        for (auto bucket_entry : bucket_entries) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572736572",
      "id" : 572736572,
      "in_reply_to_id" : 572506601,
      "line" : 535,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjczNjU3Mg==",
      "original_commit_id" : "b4c5fda417dd9ff8bf9fe24a87d384a649e3730d",
      "original_line" : 528,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 105,
      "pull_request_review_id" : 586355506,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-09T09:46:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572736572",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572739225"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572739225"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "That variable `entry_index` describes the index of the address in the disk-only list of new addresses (marked as `(*)` in [the comment above](https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572736572)).\r\n\r\nI think that should not be confused with the in-memory-only \"id\" and `entry_index` describes it well.",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-02-09T09:50:12Z",
      "diff_hunk" : "@@ -504,14 +504,14 @@ friend class CAddrManTest;\n         // so we store all bucket-entry_index pairs to iterate through later.\n         std::vector<std::pair<int, int>> bucket_entries;\n \n-        for (int bucket = 0; bucket < nUBuckets; bucket++) {\n-            int nSize = 0;\n-            s >> nSize;\n-            for (int n = 0; n < nSize; n++) {\n-                int nIndex = 0;\n-                s >> nIndex;\n-                if (nIndex >= 0 && nIndex < nNew) {\n-                    bucket_entries.emplace_back(bucket, nIndex);\n+        for (int bucket = 0; bucket < nUBuckets; ++bucket) {\n+            int num_entries{0};\n+            s >> num_entries;\n+            for (int n = 0; n < num_entries; ++n) {\n+                int entry_index{0};\n+                s >> entry_index;\n+                if (entry_index >= 0 && entry_index < nNew) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572739225",
      "id" : 572739225,
      "in_reply_to_id" : 572507304,
      "line" : 511,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjczOTIyNQ==",
      "original_commit_id" : "009b8e0fdf3bfb11668edacced5d8b70726d5d0e",
      "original_line" : 513,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 71,
      "pull_request_review_id" : 586358821,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-09T09:50:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572739225",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572742180"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572742180"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "No, because the memory-only `id` may not equal to the disk-only `index in the serialized \"all new addresses\"`.",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-02-09T09:54:11Z",
      "diff_hunk" : "@@ -335,23 +335,20 @@ friend class CAddrManTest;\n      * * nNew\n      * * nTried\n      * * number of \"new\" buckets XOR 2**30\n-     * * all nNew addrinfos in vvNew\n-     * * all nTried addrinfos in vvTried\n-     * * for each bucket:\n+     * * all new addresses (total count: nNew)\n+     * * all tried addresses (total count: nTried)\n+     * * for each new bucket:\n      *   * number of elements\n-     *   * for each element: index\n+     *   * for each element: index in the serialized \"all new addresses\"\n      * * asmap checksum\n      *\n      * 2**30 is xorred with the number of buckets to make addrman deserializer v0 detect it\n      * as incompatible. This is necessary because it did not check the version number on\n      * deserialization.\n      *\n-     * Notice that vvTried, mapAddr and vVector are never encoded explicitly;\n+     * vvNew, vvTried, mapInfo, mapAddr and vRandom are never encoded explicitly;\n      * they are instead reconstructed from the other information.\n      *\n-     * vvNew is serialized, but only used if ADDRMAN_NEW_BUCKET_COUNT and the asmap checksum",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572742180",
      "id" : 572742180,
      "in_reply_to_id" : 572513322,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Mjc0MjE4MA==",
      "original_commit_id" : "436292367c1d737cf73bd985293539500d1206f5",
      "original_line" : 352,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 586362464,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-09T09:54:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572742180",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572747754"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572747754"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This was part of the bug that this PR fixes. nNew is the total number of new addrs. Each new addr can appear in more than one new bucket, so the number of entries in bucket_entries could be higher than nNew. The old code was potentially throwing away these additional placements.",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-02-09T10:01:46Z",
      "diff_hunk" : "@@ -523,9 +525,10 @@ friend class CAddrManTest;\n             s >> serialized_asmap_version;\n         }\n \n-        for (int n = 0; n < nNew; n++) {\n-            CAddrInfo &info = mapInfo[n];\n-            int bucket = entryToBucket[n];\n+        for (auto bucket_entry : bucket_entries) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572747754",
      "id" : 572747754,
      "in_reply_to_id" : 572506601,
      "line" : 535,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Mjc0Nzc1NA==",
      "original_commit_id" : "b4c5fda417dd9ff8bf9fe24a87d384a649e3730d",
      "original_line" : 528,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 105,
      "pull_request_review_id" : 586369416,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-09T10:01:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572747754",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572749636"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572749636"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think that's a reasonable suggestion, but not worth invalidating the existing ACKs.",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-02-09T10:04:33Z",
      "diff_hunk" : "@@ -504,14 +504,14 @@ friend class CAddrManTest;\n         // so we store all bucket-entry_index pairs to iterate through later.\n         std::vector<std::pair<int, int>> bucket_entries;\n \n-        for (int bucket = 0; bucket < nUBuckets; bucket++) {\n-            int nSize = 0;\n-            s >> nSize;\n-            for (int n = 0; n < nSize; n++) {\n-                int nIndex = 0;\n-                s >> nIndex;\n-                if (nIndex >= 0 && nIndex < nNew) {\n-                    bucket_entries.emplace_back(bucket, nIndex);\n+        for (int bucket = 0; bucket < nUBuckets; ++bucket) {\n+            int num_entries{0};\n+            s >> num_entries;\n+            for (int n = 0; n < num_entries; ++n) {\n+                int entry_index{0};\n+                s >> entry_index;\n+                if (entry_index >= 0 && entry_index < nNew) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572749636",
      "id" : 572749636,
      "in_reply_to_id" : 572507304,
      "line" : 511,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Mjc0OTYzNg==",
      "original_commit_id" : "009b8e0fdf3bfb11668edacced5d8b70726d5d0e",
      "original_line" : 513,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 71,
      "pull_request_review_id" : 586371926,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-09T10:04:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572749636",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572750454"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572750454"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> (nit) could this is a scripted-diff?\r\n\r\nScripted diffs are useful when there are many occurrences of a string across multiple files. This string is used in 7 places, so is easy enough to review by eye. ",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-02-09T10:05:45Z",
      "diff_hunk" : "@@ -413,13 +414,13 @@ friend class CAddrManTest;\n                 }\n             }\n         }\n-        // Store asmap version after bucket entries so that it\n+        // Store asmap checksum after bucket entries so that it\n         // can be ignored by older clients for backward compatibility.\n-        uint256 asmap_version;\n+        uint256 asmap_checksum;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572750454",
      "id" : 572750454,
      "in_reply_to_id" : 572507981,
      "line" : 416,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Mjc1MDQ1NA==",
      "original_commit_id" : "8062d928ce5c495c1b6ecd18e4b30c12da822d90",
      "original_line" : 419,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 37,
      "pull_request_review_id" : 586372983,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-09T10:05:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572750454",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572751281"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572751281"
         }
      },
      "author_association" : "MEMBER",
      "body" : "See the line above. vvNew isn't encoded explicitly but is reconstructed.",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-02-09T10:06:56Z",
      "diff_hunk" : "@@ -335,23 +335,20 @@ friend class CAddrManTest;\n      * * nNew\n      * * nTried\n      * * number of \"new\" buckets XOR 2**30\n-     * * all nNew addrinfos in vvNew\n-     * * all nTried addrinfos in vvTried\n-     * * for each bucket:\n+     * * all new addresses (total count: nNew)\n+     * * all tried addresses (total count: nTried)\n+     * * for each new bucket:\n      *   * number of elements\n-     *   * for each element: index\n+     *   * for each element: index in the serialized \"all new addresses\"\n      * * asmap checksum\n      *\n      * 2**30 is xorred with the number of buckets to make addrman deserializer v0 detect it\n      * as incompatible. This is necessary because it did not check the version number on\n      * deserialization.\n      *\n-     * Notice that vvTried, mapAddr and vVector are never encoded explicitly;\n+     * vvNew, vvTried, mapInfo, mapAddr and vRandom are never encoded explicitly;\n      * they are instead reconstructed from the other information.\n      *\n-     * vvNew is serialized, but only used if ADDRMAN_NEW_BUCKET_COUNT and the asmap checksum",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572751281",
      "id" : 572751281,
      "in_reply_to_id" : 572513322,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Mjc1MTI4MQ==",
      "original_commit_id" : "436292367c1d737cf73bd985293539500d1206f5",
      "original_line" : 352,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 586374053,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-09T10:06:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572751281",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572751661"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572751661"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think that vector could be avoided only if we could seek into the stream. Then we could change the current:\r\n```\r\nread new buckets\r\nread asmap checksum\r\nprocess the new buckets that were read, depending on the asmap checksum\r\n```\r\nto\r\n```\r\nseek forward and read the asmap checksum (last 32 bytes)\r\nseek back and read+process the new bucketing data, depending on the asmap checksum\r\n```",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-02-09T10:07:28Z",
      "diff_hunk" : "@@ -500,7 +500,9 @@ friend class CAddrManTest;\n         nTried -= nLost;\n \n         // Store positions in the new table buckets to apply later (if possible).\n-        std::map<int, int> entryToBucket; // Represents which entry belonged to which bucket when serializing\n+        // An entry may appear in up to ADDRMAN_NEW_BUCKETS_PER_ADDRESS buckets,\n+        // so we store all bucket-entry_index pairs to iterate through later.\n+        std::vector<std::pair<int, int>> bucket_entries;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572751661",
      "id" : 572751661,
      "in_reply_to_id" : 572401734,
      "line" : 503,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Mjc1MTY2MQ==",
      "original_commit_id" : "b4c5fda417dd9ff8bf9fe24a87d384a649e3730d",
      "original_line" : 505,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 63,
      "pull_request_review_id" : 586374536,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-09T10:07:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572751661",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572753348"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572753348"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We only know how we're going to use the vector after we've deserialized the asmap_checksum field, so I don't think we can get rid of it.",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-02-09T10:09:47Z",
      "diff_hunk" : "@@ -500,7 +500,9 @@ friend class CAddrManTest;\n         nTried -= nLost;\n \n         // Store positions in the new table buckets to apply later (if possible).\n-        std::map<int, int> entryToBucket; // Represents which entry belonged to which bucket when serializing\n+        // An entry may appear in up to ADDRMAN_NEW_BUCKETS_PER_ADDRESS buckets,\n+        // so we store all bucket-entry_index pairs to iterate through later.\n+        std::vector<std::pair<int, int>> bucket_entries;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572753348",
      "id" : 572753348,
      "in_reply_to_id" : 572401734,
      "line" : 503,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Mjc1MzM0OA==",
      "original_commit_id" : "b4c5fda417dd9ff8bf9fe24a87d384a649e3730d",
      "original_line" : 505,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 63,
      "pull_request_review_id" : 586376587,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-09T10:09:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572753348",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572753489"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572753489"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "A test is in the baking at https://github.com/jnewbery/bitcoin/pull/18.",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-02-09T10:09:58Z",
      "diff_hunk" : "@@ -509,7 +511,7 @@ friend class CAddrManTest;\n                 int nIndex = 0;\n                 s >> nIndex;\n                 if (nIndex >= 0 && nIndex < nNew) {\n-                    entryToBucket[nIndex] = bucket;\n+                    bucket_entries.emplace_back(bucket, nIndex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572753489",
      "id" : 572753489,
      "in_reply_to_id" : 572410044,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Mjc1MzQ4OQ==",
      "original_commit_id" : "b4c5fda417dd9ff8bf9fe24a87d384a649e3730d",
      "original_line" : 514,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 586376753,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-09T10:09:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572753489",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572753969"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572753969"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I definitely agree. @vasild has a test here: https://github.com/jnewbery/bitcoin/pull/18 which can be added after this PR.",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-02-09T10:10:40Z",
      "diff_hunk" : "@@ -509,7 +511,7 @@ friend class CAddrManTest;\n                 int nIndex = 0;\n                 s >> nIndex;\n                 if (nIndex >= 0 && nIndex < nNew) {\n-                    entryToBucket[nIndex] = bucket;\n+                    bucket_entries.emplace_back(bucket, nIndex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572753969",
      "id" : 572753969,
      "in_reply_to_id" : 572410044,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Mjc1Mzk2OQ==",
      "original_commit_id" : "b4c5fda417dd9ff8bf9fe24a87d384a649e3730d",
      "original_line" : 514,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 586377353,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-09T10:10:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572753969",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572756630"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572756630"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'll expand this comment in a follow-up.",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-02-09T10:14:29Z",
      "diff_hunk" : "@@ -525,19 +527,26 @@ friend class CAddrManTest;\n         if (format >= Format::V2_ASMAP) {\n             s >> serialized_asmap_checksum;\n         }\n+        const bool restore_bucketing{nUBuckets == ADDRMAN_NEW_BUCKET_COUNT &&\n+                                     serialized_asmap_checksum == supplied_asmap_checksum};\n \n         for (auto bucket_entry : bucket_entries) {\n             int bucket{bucket_entry.first};\n             const int entry_index{bucket_entry.second};\n             CAddrInfo& info = mapInfo[entry_index];\n+\n+            // The entry shouldn't appear in more than\n+            // ADDRMAN_NEW_BUCKETS_PER_ADDRESS. If it has already, just skip\n+            // this bucket_entry.\n+            if (info.nRefCount >= ADDRMAN_NEW_BUCKETS_PER_ADDRESS) continue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572756630",
      "id" : 572756630,
      "in_reply_to_id" : 572509364,
      "line" : 543,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Mjc1NjYzMA==",
      "original_commit_id" : "a5c9b04959f443372400f9a736c6eaf5502284a1",
      "original_line" : 541,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : 113,
      "pull_request_review_id" : 586381002,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-09T10:14:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572756630",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572763470"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572763470"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> The restore_bucketing change here is aesthetic and the only actual change this line is dropping the format >= Format::V2_ASMAP condition.\r\n\r\nRight, this condition doesn't change during loop iterations, so it's clearer to move it out of the loop, mark it const, and only do a conditional check inside the loop on what can change over iterations.\r\n\r\n> The effect of dropping format condition is this will now keep existing bucket positions instead of rebucketing when an old format is loaded and there is no asmap. (\"Only rebucket if\" in commit description means \"Use existing bucket positions if\")\r\n\r\nThat's right. If the file format is old (no asmap), and we don't have an asmap, then we gain nothing by dropping new bucket positions.\r\n\r\n> In the case where an old format is loaded an there is an asmap, this logic isn't triggered because the serialized_asmap_checksum == supplied_asmap_checksum condition is false.\r\n\r\nRight.\r\n\r\n> Maybe could be a unit test checking old format number + no asmap uses existing bucket positions\r\n\r\nPerhaps. It's a bit difficult to test because we can't easily serialize addrman in the old format.",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-02-09T10:23:57Z",
      "diff_hunk" : "@@ -525,19 +527,26 @@ friend class CAddrManTest;\n         if (format >= Format::V2_ASMAP) {\n             s >> serialized_asmap_checksum;\n         }\n+        const bool restore_bucketing{nUBuckets == ADDRMAN_NEW_BUCKET_COUNT &&\n+                                     serialized_asmap_checksum == supplied_asmap_checksum};\n \n         for (auto bucket_entry : bucket_entries) {\n             int bucket{bucket_entry.first};\n             const int entry_index{bucket_entry.second};\n             CAddrInfo& info = mapInfo[entry_index];\n+\n+            // The entry shouldn't appear in more than\n+            // ADDRMAN_NEW_BUCKETS_PER_ADDRESS. If it has already, just skip\n+            // this bucket_entry.\n+            if (info.nRefCount >= ADDRMAN_NEW_BUCKETS_PER_ADDRESS) continue;\n+\n             int nUBucketPos = info.GetBucketPosition(nKey, true, bucket);\n-            if (format >= Format::V2_ASMAP && nUBuckets == ADDRMAN_NEW_BUCKET_COUNT && vvNew[bucket][nUBucketPos] == -1 &&\n-                info.nRefCount < ADDRMAN_NEW_BUCKETS_PER_ADDRESS && serialized_asmap_checksum == supplied_asmap_checksum) {\n+            if (restore_bucketing && vvNew[bucket][nUBucketPos] == -1) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572763470",
      "id" : 572763470,
      "in_reply_to_id" : 572518900,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Mjc2MzQ3MA==",
      "original_commit_id" : "a5c9b04959f443372400f9a736c6eaf5502284a1",
      "original_line" : 544,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 586389537,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-09T10:23:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572763470",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks @dhruv and @ryanofsky for the reviews. I think this is ready for merge now, and the remaining review comments can be done in follow-ups:\r\n\r\n- [ ] Add test (https://github.com/bitcoin/bitcoin/pull/20557#issuecomment-737890278, also see https://github.com/jnewbery/bitcoin/pull/18)\r\n- [ ] Use structured bindings to iterate bucket_entries (https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572398580)\r\n- [ ] Expand comment about info.nRefCount >= ADDRMAN_NEW_BUCKETS_PER_ADDRESS (https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572509364)",
      "created_at" : "2021-02-09T10:24:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#issuecomment-775832831",
      "id" : 775832831,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20557",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NTgzMjgzMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-09T10:24:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/775832831",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572763827"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572763827"
         }
      },
      "author_association" : "MEMBER",
      "body" : ":heart: structured bindings. Good suggestion. I'll do in a follow-up.",
      "commit_id" : "4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-02-09T10:24:31Z",
      "diff_hunk" : "@@ -523,9 +525,10 @@ friend class CAddrManTest;\n             s >> serialized_asmap_version;\n         }\n \n-        for (int n = 0; n < nNew; n++) {\n-            CAddrInfo &info = mapInfo[n];\n-            int bucket = entryToBucket[n];\n+        for (auto bucket_entry : bucket_entries) {\n+            int bucket{bucket_entry.first};\n+            const int n{bucket_entry.second};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#discussion_r572763827",
      "id" : 572763827,
      "in_reply_to_id" : 572398580,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Mjc2MzgyNw==",
      "original_commit_id" : "b4c5fda417dd9ff8bf9fe24a87d384a649e3730d",
      "original_line" : 530,
      "original_position" : 29,
      "original_start_line" : 528,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 586390018,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20557",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-02-09T10:24:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572763827",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review ACK 4676a4fb5be0f6ef0b3f71c1f4361c20f7cb0e0b",
      "created_at" : "2021-02-09T11:36:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20557#issuecomment-775875390",
      "id" : 775875390,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20557",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NTg3NTM5MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-09T11:36:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/775875390",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
