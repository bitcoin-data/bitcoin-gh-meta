[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This has low impact because, while in theory some disk contents could cause us to deserialize inconsistently, we never create such disk contents. `CAddress` would serialize as either one of:\r\n* a version that contains `ADDRV2_FORMAT`, `nServices` in CompactSize, the address in addrv2 format; or\r\n* a version that does not contain `ADDRV2_FORMAT`, `nServices` in 8 bytes, the address in addrv1 format\r\n\r\n[Spotted](http://www.erisian.com.au/bitcoin-core-dev/log-2020-11-25.html#l-426) by @sipa.",
      "created_at" : "2020-11-26T15:03:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20509#issuecomment-734346637",
      "id" : 734346637,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20509",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNDM0NjYzNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-26T15:03:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/734346637",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'd very much have preferred this approach, and just deprecated the use of the CAddress serialized version numbers, but I fear that #20511 leaves us little choice to go the other way (and make everything use the stored version): I've opened #20516 to do so.",
      "created_at" : "2020-11-27T01:45:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20509#issuecomment-734530222",
      "id" : 734530222,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20509",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNDUzMDIyMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-27T03:13:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/734530222",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #20516 (Well-defined CAddress disk serialization, and addrv2 anchors.dat by sipa)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-11-27T02:30:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20509#issuecomment-734557643",
      "id" : 734557643,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20509",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNDU1NzY0Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-25T13:17:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/734557643",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This looks wrong? If the disk has a non-addrv2 format, we shouldn't try to deserialise it as such...",
      "created_at" : "2020-11-30T17:49:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20509#issuecomment-735940269",
      "id" : 735940269,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20509",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNTk0MDI2OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-30T17:49:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/735940269",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@luke-jr well, the assumption is that the version is set properly in the stream by the caller (this is the case in the current `master`). There is this inconsistency in `CAddress` deserialization:\r\n\r\n```cpp\r\n    SERIALIZE_METHODS(CAddress, obj)\r\n    {\r\n...\r\n        int nVersion = s.GetVersion();\r\n        if (s.GetType() & SER_DISK) {\r\n            READWRITE(nVersion); // Saves the disk contents into nVersion\r\n        }\r\n...\r\n        if (nVersion & ADDRV2_FORMAT) { // Uses nVersion (== disk contents) [1]\r\n...\r\n        }\r\n        READWRITEAS(CService, obj); // Uses s.GetVersion() [2]\r\n    }\r\n```\r\n\r\n[1] and [2] should use the same variable. This PR changes [1] to use `s.GetVersion()`.\r\n\r\nIt would also be possible to change [2] to use the \"disk contents\":\r\n\r\n```diff\r\n+        const int stream_version_orig = s.GetVersion();\r\n+        SER_READ(obj, if (s.GetType() & SER_DISK) { s.SetVersion(nVersion); });\r\n         READWRITEAS(CService, obj);\r\n+        SER_READ(obj, if (s.GetType() & SER_DISK) { s.SetVersion(stream_version_orig); });\r\n     }\r\n```\r\n\r\nBut then one could ask a counter question to yours: \"If the _stream_ has a non-addrv2 format, we shouldn't try to deserialise it as such... (in [2])\".\r\n\r\nMaybe compare the stream format with disk contents and if they don't both have ADDRV2_FORMAT set (or not set), then throw?\r\n\r\nIf https://github.com/bitcoin/bitcoin/pull/20516 gets merged, then this PR would be obsolete and can be closed.",
      "created_at" : "2020-12-01T13:34:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20509#issuecomment-736554445",
      "id" : 736554445,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20509",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNjU1NDQ0NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-01T13:34:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/736554445",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-06-17T17:46:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20509#issuecomment-863437503",
      "id" : 863437503,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20509",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MzQzNzUwMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-17T17:46:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/863437503",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Following the merge of #20516, maybe this PR can be closed IIUC.",
      "created_at" : "2021-06-17T17:57:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20509#issuecomment-863444473",
      "id" : 863444473,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20509",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MzQ0NDQ3Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-17T17:57:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/863444473",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@vasild Closing for now",
      "created_at" : "2021-06-21T09:57:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20509#issuecomment-864902141",
      "id" : 864902141,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20509",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NDkwMjE0MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-21T09:57:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/864902141",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
