[
   {
      "author_association" : "MEMBER",
      "body" : "The bug was found by @jnewbery [here](https://github.com/bitcoin/bitcoin/pull/16702#discussion_r515608294).\r\n\r\nThis probably should be backported to 0.20 and 0.21.\r\n\r\ncc @vasild ",
      "created_at" : "2020-12-01T08:23:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20539#issuecomment-736306028",
      "id" : 736306028,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20539",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNjMwNjAyOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-01T08:23:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/736306028",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "To be clear, the issue we're solving here happens only *once* when a node updates from <0.20 to 0.20+.\r\nAfter that, even if asmap was not supplied, peers.dat will be stored on disk in Format::V2_ASMAP,\r\nand next time a node restarted, the check won't be triggered. (even before this PR)",
      "created_at" : "2020-12-01T08:26:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20539#issuecomment-736307658",
      "id" : 736307658,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20539",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNjMwNzY1OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-01T08:27:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/736307658",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.",
      "created_at" : "2020-12-01T09:36:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20539#issuecomment-736348790",
      "id" : 736348790,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20539",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNjM0ODc5MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-01T16:16:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/736348790",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20539#discussion_r533430513"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20539"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533430513"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this would be more readable as:\r\n```cpp\r\nif (asmap_is_same && constants_are_same && assignment_is_same) {\r\n```\r\n(and of course variables renamed and re-assigned)",
      "commit_id" : "0288ed8dbf36602156e5d9c57ad3ee529c75a21a",
      "created_at" : "2020-12-01T14:04:23Z",
      "diff_hunk" : "@@ -527,10 +527,25 @@ friend class CAddrManTest;\n             CAddrInfo &info = mapInfo[n];\n             int bucket = entryToBucket[n];\n             int nUBucketPos = info.GetBucketPosition(nKey, true, bucket);\n-            if (((format >= Format::V2_ASMAP && serialized_asmap_version == supplied_asmap_version) ||\n-                (format < Format::V2_ASMAP && m_asmap.size() == 0)) &&\n-                nUBuckets == ADDRMAN_NEW_BUCKET_COUNT && vvNew[bucket][nUBucketPos] == -1 &&\n-                info.nRefCount < ADDRMAN_NEW_BUCKETS_PER_ADDRESS && serialized_asmap_version == supplied_asmap_version) {\n+\n+            // We already checked that the file format is not \"too new\" and we can parse it (see lowest_compatible above).\n+            // Here, check that the file is compatible by other means:\n+            // - constants haven't been changed incompatibly\n+            // - asmap has not changed\n+            // - bucket/position assignment hasn't been changed incompatibly\n+            // If it's incompatible, reassign buckets/positions.\n+\n+            // asmap has changed in two cases:\n+            // - either it wasn't supported by the addr file, but now asmap is supplied;\n+            // - or it was supported, but we have a different asmap now (the lack of asmap counts as well)\n+            const bool asmap_was_supported = format >= Format::V2_ASMAP;\n+            const bool asmap_changed = (!asmap_was_supported && m_asmap.size() != 0) ||\n+                (asmap_was_supported && serialized_asmap_version != supplied_asmap_version);\n+\n+            const bool constants_changed_incompatibly = nUBuckets != ADDRMAN_NEW_BUCKET_COUNT || info.nRefCount >= ADDRMAN_NEW_BUCKETS_PER_ADDRESS;\n+            const bool assignment_changed = vvNew[bucket][nUBucketPos] != -1;\n+\n+            if (!asmap_changed && !constants_changed_incompatibly && !assignment_changed) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20539#discussion_r533430513",
      "id" : 533430513,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQzMDUxMw==",
      "original_commit_id" : "58dfe2b090fb850ff3d67d8ab56468bc55a3d196",
      "original_line" : 548,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 541923861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20539",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-02T08:43:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533430513",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20539#discussion_r533445562"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20539"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533445562"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```\r\nI think the second commit is not an equivalent change (it is behavioral change):\r\n\r\nasmap_was_supported == format >= Format::V2_ASMAP;\r\nasmap_changed ==\r\n    (!asmap_was_supported && m_asmap.size() != 0) ||\r\n    (asmap_was_supported && serialized_asmap_version != supplied_asmap_version);\r\n\r\nis equivalent to\r\n\r\nasmap_changed ==\r\n    (!(format >= Format::V2_ASMAP) && m_asmap.size() != 0) ||\r\n    (format >= Format::V2_ASMAP && serialized_asmap_version != supplied_asmap_version);\r\n\r\nis equivalent to\r\n\r\nasmap_changed ==\r\n    (format < Format::V2_ASMAP && m_asmap.size() != 0) ||\r\n    (format >= Format::V2_ASMAP && serialized_asmap_version != supplied_asmap_version);\r\n\r\nis equivalent to\r\n\r\n!asmap_changed ==\r\n    !(format < Format::V2_ASMAP && m_asmap.size() != 0) &&\r\n    !(format >= Format::V2_ASMAP && serialized_asmap_version != supplied_asmap_version);\r\n\r\nis equivalent to\r\n\r\n!asmap_changed ==\r\n    (format >= Format::V2_ASMAP || m_asmap.size() == 0) &&\r\n    (format < Format::V2_ASMAP || serialized_asmap_version == supplied_asmap_version);\r\n\r\nbut in the \"if\", !asmap_changed replaces not the above but something else:\r\n\r\n(format >= Format::V2_ASMAP && serialized_asmap_version == supplied_asmap_version) ||\r\n(format < Format::V2_ASMAP && m_asmap.size() == 0)\r\n```",
      "commit_id" : "0288ed8dbf36602156e5d9c57ad3ee529c75a21a",
      "created_at" : "2020-12-01T14:24:58Z",
      "diff_hunk" : "@@ -527,10 +527,25 @@ friend class CAddrManTest;\n             CAddrInfo &info = mapInfo[n];\n             int bucket = entryToBucket[n];\n             int nUBucketPos = info.GetBucketPosition(nKey, true, bucket);\n-            if (((format >= Format::V2_ASMAP && serialized_asmap_version == supplied_asmap_version) ||\n-                (format < Format::V2_ASMAP && m_asmap.size() == 0)) &&\n-                nUBuckets == ADDRMAN_NEW_BUCKET_COUNT && vvNew[bucket][nUBucketPos] == -1 &&\n-                info.nRefCount < ADDRMAN_NEW_BUCKETS_PER_ADDRESS && serialized_asmap_version == supplied_asmap_version) {\n+\n+            // We already checked that the file format is not \"too new\" and we can parse it (see lowest_compatible above).\n+            // Here, check that the file is compatible by other means:\n+            // - constants haven't been changed incompatibly\n+            // - asmap has not changed\n+            // - bucket/position assignment hasn't been changed incompatibly\n+            // If it's incompatible, reassign buckets/positions.\n+\n+            // asmap has changed in two cases:\n+            // - either it wasn't supported by the addr file, but now asmap is supplied;\n+            // - or it was supported, but we have a different asmap now (the lack of asmap counts as well)\n+            const bool asmap_was_supported = format >= Format::V2_ASMAP;\n+            const bool asmap_changed = (!asmap_was_supported && m_asmap.size() != 0) ||\n+                (asmap_was_supported && serialized_asmap_version != supplied_asmap_version);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20539#discussion_r533445562",
      "id" : 533445562,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ0NTU2Mg==",
      "original_commit_id" : "58dfe2b090fb850ff3d67d8ab56468bc55a3d196",
      "original_line" : 543,
      "original_position" : 21,
      "original_start_line" : 541,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 541923861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20539",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-12-02T08:43:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533445562",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20539#discussion_r533448739"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20539"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533448739"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is introduced in the first commit:\r\n\r\n```\r\n(format >= Format::V2_ASMAP && serialized_asmap_version == supplied_asmap_version) ||\r\n(format < Format::V2_ASMAP && m_asmap.size() == 0)\r\n```\r\n\r\nIs it not equivalent to just `serialized_asmap_version == supplied_asmap_version`? After all, if the hash of the supplied and the serialized version is the same, then asmap did not change.",
      "commit_id" : "0288ed8dbf36602156e5d9c57ad3ee529c75a21a",
      "created_at" : "2020-12-01T14:29:08Z",
      "diff_hunk" : "@@ -527,10 +527,25 @@ friend class CAddrManTest;\n             CAddrInfo &info = mapInfo[n];\n             int bucket = entryToBucket[n];\n             int nUBucketPos = info.GetBucketPosition(nKey, true, bucket);\n-            if (((format >= Format::V2_ASMAP && serialized_asmap_version == supplied_asmap_version) ||\n-                (format < Format::V2_ASMAP && m_asmap.size() == 0)) &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20539#discussion_r533448739",
      "id" : 533448739,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ0ODczOQ==",
      "original_commit_id" : "58dfe2b090fb850ff3d67d8ab56468bc55a3d196",
      "original_line" : 531,
      "original_position" : 5,
      "original_start_line" : 530,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 541923861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20539",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : "LEFT",
      "updated_at" : "2020-12-02T08:43:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533448739",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20539#discussion_r533551450"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20539"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533551450"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\"Same\" is not quite true... For example, if \"ADDRMAN_NEW_BUCKETS_PER_ADDRESS\" was increased, we should ignore it here, although technically it changed :)",
      "commit_id" : "0288ed8dbf36602156e5d9c57ad3ee529c75a21a",
      "created_at" : "2020-12-01T16:31:53Z",
      "diff_hunk" : "@@ -527,10 +527,25 @@ friend class CAddrManTest;\n             CAddrInfo &info = mapInfo[n];\n             int bucket = entryToBucket[n];\n             int nUBucketPos = info.GetBucketPosition(nKey, true, bucket);\n-            if (((format >= Format::V2_ASMAP && serialized_asmap_version == supplied_asmap_version) ||\n-                (format < Format::V2_ASMAP && m_asmap.size() == 0)) &&\n-                nUBuckets == ADDRMAN_NEW_BUCKET_COUNT && vvNew[bucket][nUBucketPos] == -1 &&\n-                info.nRefCount < ADDRMAN_NEW_BUCKETS_PER_ADDRESS && serialized_asmap_version == supplied_asmap_version) {\n+\n+            // We already checked that the file format is not \"too new\" and we can parse it (see lowest_compatible above).\n+            // Here, check that the file is compatible by other means:\n+            // - constants haven't been changed incompatibly\n+            // - asmap has not changed\n+            // - bucket/position assignment hasn't been changed incompatibly\n+            // If it's incompatible, reassign buckets/positions.\n+\n+            // asmap has changed in two cases:\n+            // - either it wasn't supported by the addr file, but now asmap is supplied;\n+            // - or it was supported, but we have a different asmap now (the lack of asmap counts as well)\n+            const bool asmap_was_supported = format >= Format::V2_ASMAP;\n+            const bool asmap_changed = (!asmap_was_supported && m_asmap.size() != 0) ||\n+                (asmap_was_supported && serialized_asmap_version != supplied_asmap_version);\n+\n+            const bool constants_changed_incompatibly = nUBuckets != ADDRMAN_NEW_BUCKET_COUNT || info.nRefCount >= ADDRMAN_NEW_BUCKETS_PER_ADDRESS;\n+            const bool assignment_changed = vvNew[bucket][nUBucketPos] != -1;\n+\n+            if (!asmap_changed && !constants_changed_incompatibly && !assignment_changed) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20539#discussion_r533551450",
      "id" : 533551450,
      "in_reply_to_id" : 533430513,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU1MTQ1MA==",
      "original_commit_id" : "58dfe2b090fb850ff3d67d8ab56468bc55a3d196",
      "original_line" : 548,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 542081255,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20539",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-12-02T08:43:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533551450",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20539#discussion_r533975122"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20539"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533975122"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Well, I think they are actually equal, assuming that both can be simplified to `serialized_asmap_version == supplied_asmap_version` in our case :)",
      "commit_id" : "0288ed8dbf36602156e5d9c57ad3ee529c75a21a",
      "created_at" : "2020-12-02T08:22:39Z",
      "diff_hunk" : "@@ -527,10 +527,25 @@ friend class CAddrManTest;\n             CAddrInfo &info = mapInfo[n];\n             int bucket = entryToBucket[n];\n             int nUBucketPos = info.GetBucketPosition(nKey, true, bucket);\n-            if (((format >= Format::V2_ASMAP && serialized_asmap_version == supplied_asmap_version) ||\n-                (format < Format::V2_ASMAP && m_asmap.size() == 0)) &&\n-                nUBuckets == ADDRMAN_NEW_BUCKET_COUNT && vvNew[bucket][nUBucketPos] == -1 &&\n-                info.nRefCount < ADDRMAN_NEW_BUCKETS_PER_ADDRESS && serialized_asmap_version == supplied_asmap_version) {\n+\n+            // We already checked that the file format is not \"too new\" and we can parse it (see lowest_compatible above).\n+            // Here, check that the file is compatible by other means:\n+            // - constants haven't been changed incompatibly\n+            // - asmap has not changed\n+            // - bucket/position assignment hasn't been changed incompatibly\n+            // If it's incompatible, reassign buckets/positions.\n+\n+            // asmap has changed in two cases:\n+            // - either it wasn't supported by the addr file, but now asmap is supplied;\n+            // - or it was supported, but we have a different asmap now (the lack of asmap counts as well)\n+            const bool asmap_was_supported = format >= Format::V2_ASMAP;\n+            const bool asmap_changed = (!asmap_was_supported && m_asmap.size() != 0) ||\n+                (asmap_was_supported && serialized_asmap_version != supplied_asmap_version);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20539#discussion_r533975122",
      "id" : 533975122,
      "in_reply_to_id" : 533445562,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk3NTEyMg==",
      "original_commit_id" : "58dfe2b090fb850ff3d67d8ab56468bc55a3d196",
      "original_line" : 543,
      "original_position" : 21,
      "original_start_line" : 541,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 542590791,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20539",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-12-02T08:43:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533975122",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20539#discussion_r533975311"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20539"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533975311"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Anyway, this part will be no relevant when I simplify the first commit.",
      "commit_id" : "0288ed8dbf36602156e5d9c57ad3ee529c75a21a",
      "created_at" : "2020-12-02T08:22:59Z",
      "diff_hunk" : "@@ -527,10 +527,25 @@ friend class CAddrManTest;\n             CAddrInfo &info = mapInfo[n];\n             int bucket = entryToBucket[n];\n             int nUBucketPos = info.GetBucketPosition(nKey, true, bucket);\n-            if (((format >= Format::V2_ASMAP && serialized_asmap_version == supplied_asmap_version) ||\n-                (format < Format::V2_ASMAP && m_asmap.size() == 0)) &&\n-                nUBuckets == ADDRMAN_NEW_BUCKET_COUNT && vvNew[bucket][nUBucketPos] == -1 &&\n-                info.nRefCount < ADDRMAN_NEW_BUCKETS_PER_ADDRESS && serialized_asmap_version == supplied_asmap_version) {\n+\n+            // We already checked that the file format is not \"too new\" and we can parse it (see lowest_compatible above).\n+            // Here, check that the file is compatible by other means:\n+            // - constants haven't been changed incompatibly\n+            // - asmap has not changed\n+            // - bucket/position assignment hasn't been changed incompatibly\n+            // If it's incompatible, reassign buckets/positions.\n+\n+            // asmap has changed in two cases:\n+            // - either it wasn't supported by the addr file, but now asmap is supplied;\n+            // - or it was supported, but we have a different asmap now (the lack of asmap counts as well)\n+            const bool asmap_was_supported = format >= Format::V2_ASMAP;\n+            const bool asmap_changed = (!asmap_was_supported && m_asmap.size() != 0) ||\n+                (asmap_was_supported && serialized_asmap_version != supplied_asmap_version);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20539#discussion_r533975311",
      "id" : 533975311,
      "in_reply_to_id" : 533445562,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk3NTMxMQ==",
      "original_commit_id" : "58dfe2b090fb850ff3d67d8ab56468bc55a3d196",
      "original_line" : 543,
      "original_position" : 21,
      "original_start_line" : 541,
      "path" : "src/addrman.h",
      "position" : null,
      "pull_request_review_id" : 542591042,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20539",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-12-02T08:43:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/533975311",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20539#discussion_r534013241"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20539"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534013241"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I still think these assignments should happen outside the loop, since they're constant and don't depend on the loop variable. See https://github.com/bitcoin/bitcoin/pull/16702#discussion_r515608294.",
      "commit_id" : "0288ed8dbf36602156e5d9c57ad3ee529c75a21a",
      "created_at" : "2020-12-02T09:23:15Z",
      "diff_hunk" : "@@ -527,8 +527,23 @@ friend class CAddrManTest;\n             CAddrInfo &info = mapInfo[n];\n             int bucket = entryToBucket[n];\n             int nUBucketPos = info.GetBucketPosition(nKey, true, bucket);\n-            if (format >= Format::V2_ASMAP && nUBuckets == ADDRMAN_NEW_BUCKET_COUNT && vvNew[bucket][nUBucketPos] == -1 &&\n-                info.nRefCount < ADDRMAN_NEW_BUCKETS_PER_ADDRESS && serialized_asmap_version == supplied_asmap_version) {\n+\n+            // We already checked that the file format is not \"too new\" and we can parse it (see lowest_compatible above).\n+            // Here, check that the file is compatible by other means:\n+            // - constants haven't been changed incompatibly\n+            // - asmap has not changed\n+            // - bucket/position assignment hasn't been changed incompatibly\n+            // If it's incompatible, reassign buckets/positions.\n+\n+            // asmap has changed in two cases:\n+            // - either it wasn't supported by the addr file, but now asmap is supplied;\n+            // - or it was supported, but we have a different asmap now (the lack of asmap counts as well)\n+            const bool asmap_is_same = serialized_asmap_version == supplied_asmap_version;\n+\n+            const bool constants_are_compatible = nUBuckets == ADDRMAN_NEW_BUCKET_COUNT && info.nRefCount < ADDRMAN_NEW_BUCKETS_PER_ADDRESS;\n+            const bool assignment_is_compatible = vvNew[bucket][nUBucketPos] == -1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20539#discussion_r534013241",
      "id" : 534013241,
      "line" : 544,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxMzI0MQ==",
      "original_commit_id" : "0288ed8dbf36602156e5d9c57ad3ee529c75a21a",
      "original_line" : 544,
      "original_position" : 20,
      "original_start_line" : 538,
      "path" : "src/addrman.h",
      "position" : 20,
      "pull_request_review_id" : 542639106,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20539",
      "side" : "RIGHT",
      "start_line" : 538,
      "start_side" : "RIGHT",
      "updated_at" : "2020-12-02T09:23:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534013241",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20539#discussion_r534014630"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20539"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534014630"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah, some of them. I'll move them out.",
      "commit_id" : "0288ed8dbf36602156e5d9c57ad3ee529c75a21a",
      "created_at" : "2020-12-02T09:25:09Z",
      "diff_hunk" : "@@ -527,8 +527,23 @@ friend class CAddrManTest;\n             CAddrInfo &info = mapInfo[n];\n             int bucket = entryToBucket[n];\n             int nUBucketPos = info.GetBucketPosition(nKey, true, bucket);\n-            if (format >= Format::V2_ASMAP && nUBuckets == ADDRMAN_NEW_BUCKET_COUNT && vvNew[bucket][nUBucketPos] == -1 &&\n-                info.nRefCount < ADDRMAN_NEW_BUCKETS_PER_ADDRESS && serialized_asmap_version == supplied_asmap_version) {\n+\n+            // We already checked that the file format is not \"too new\" and we can parse it (see lowest_compatible above).\n+            // Here, check that the file is compatible by other means:\n+            // - constants haven't been changed incompatibly\n+            // - asmap has not changed\n+            // - bucket/position assignment hasn't been changed incompatibly\n+            // If it's incompatible, reassign buckets/positions.\n+\n+            // asmap has changed in two cases:\n+            // - either it wasn't supported by the addr file, but now asmap is supplied;\n+            // - or it was supported, but we have a different asmap now (the lack of asmap counts as well)\n+            const bool asmap_is_same = serialized_asmap_version == supplied_asmap_version;\n+\n+            const bool constants_are_compatible = nUBuckets == ADDRMAN_NEW_BUCKET_COUNT && info.nRefCount < ADDRMAN_NEW_BUCKETS_PER_ADDRESS;\n+            const bool assignment_is_compatible = vvNew[bucket][nUBucketPos] == -1;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20539#discussion_r534014630",
      "id" : 534014630,
      "in_reply_to_id" : 534013241,
      "line" : 544,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxNDYzMA==",
      "original_commit_id" : "0288ed8dbf36602156e5d9c57ad3ee529c75a21a",
      "original_line" : 544,
      "original_position" : 20,
      "original_start_line" : 538,
      "path" : "src/addrman.h",
      "position" : 20,
      "pull_request_review_id" : 542640793,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20539",
      "side" : "RIGHT",
      "start_line" : 538,
      "start_side" : "RIGHT",
      "updated_at" : "2020-12-02T09:25:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/534014630",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "#20557 fixes this issue and a couple of other bugs in addrman unserialization. I suggest we close this PR in favour of that one.",
      "created_at" : "2020-12-03T11:40:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20539#issuecomment-737888850",
      "id" : 737888850,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20539",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNzg4ODg1MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-03T11:40:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/737888850",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
