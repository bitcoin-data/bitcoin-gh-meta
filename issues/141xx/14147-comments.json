[
   {
      "author_association" : "MEMBER",
      "body" : "utACK.   Aside, this was much more easily reviewed with ?w=1",
      "created_at" : "2018-09-04T17:01:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#issuecomment-418443550",
      "id" : 418443550,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14147",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQxODQ0MzU1MA==",
      "updated_at" : "2018-09-04T17:01:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/418443550",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Tagged with \"Refactor\", as this is supposed to not change behavior?",
      "created_at" : "2018-09-04T18:24:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#issuecomment-418469773",
      "id" : 418469773,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14147",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQxODQ2OTc3Mw==",
      "updated_at" : "2018-09-04T18:24:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/418469773",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@MarcoFalke The only change to the logic is grouping the InactivityChecks in a single function outside of the reference counting guards, that logic sets fDisconnect flags, which wont do anything until the next loop in the thread anyways.",
      "created_at" : "2018-09-04T19:31:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#issuecomment-418490058",
      "id" : 418490058,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14147",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQxODQ5MDA1OA==",
      "updated_at" : "2018-09-04T19:31:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/418490058",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/620611?v=4",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "node_id" : "MDQ6VXNlcjYyMDYxMQ==",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215659807"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215659807"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This assignment is redundant, right? :-)",
      "commit_id" : "672543085ac4973f034ad30f897230581a2af8d2",
      "created_at" : "2018-09-06T15:00:05Z",
      "diff_hunk" : "@@ -1153,82 +1153,124 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     }\n }\n \n-void CConnman::ThreadSocketHandler()\n-{\n-    unsigned int nPrevNodeCount = 0;\n-    while (!interruptNet)\n+void CConnman::DisconnectNodes() {\n+    size_t nPrevNodeCount, vNodesSize;\n     {\n-        //\n-        // Disconnect nodes\n-        //\n-        {\n-            LOCK(cs_vNodes);\n+        LOCK(cs_vNodes);\n \n-            if (!fNetworkActive) {\n-                // Disconnect any connected nodes\n-                for (CNode* pnode : vNodes) {\n-                    if (!pnode->fDisconnect) {\n-                        LogPrint(BCLog::NET, \"Network not active, dropping peer=%d\\n\", pnode->GetId());\n-                        pnode->fDisconnect = true;\n-                    }\n+        nPrevNodeCount = vNodes.size();\n+\n+        if (!fNetworkActive) {\n+            // Disconnect any connected nodes\n+            for (CNode* pnode : vNodes) {\n+                if (!pnode->fDisconnect) {\n+                    LogPrint(BCLog::NET, \"Network not active, dropping peer=%d\\n\", pnode->GetId());\n+                    pnode->fDisconnect = true;\n                 }\n             }\n+        }\n \n-            // Disconnect unused nodes\n-            std::vector<CNode*> vNodesCopy = vNodes;\n-            for (CNode* pnode : vNodesCopy)\n+        // Disconnect unused nodes\n+        std::vector<CNode*> vNodesCopy = vNodes;\n+        for (CNode* pnode : vNodesCopy)\n+        {\n+            if (pnode->fDisconnect)\n             {\n-                if (pnode->fDisconnect)\n-                {\n-                    // remove from vNodes\n-                    vNodes.erase(remove(vNodes.begin(), vNodes.end(), pnode), vNodes.end());\n+                // remove from vNodes\n+                vNodes.erase(remove(vNodes.begin(), vNodes.end(), pnode), vNodes.end());\n \n-                    // release outbound grant (if any)\n-                    pnode->grantOutbound.Release();\n+                // release outbound grant (if any)\n+                pnode->grantOutbound.Release();\n \n-                    // close socket and cleanup\n-                    pnode->CloseSocketDisconnect();\n+                // close socket and cleanup\n+                pnode->CloseSocketDisconnect();\n \n-                    // hold in disconnected pool until all refs are released\n-                    pnode->Release();\n-                    vNodesDisconnected.push_back(pnode);\n-                }\n+                // hold in disconnected pool until all refs are released\n+                pnode->Release();\n+                vNodesDisconnected.push_back(pnode);\n             }\n         }\n+\n+        vNodesSize = vNodes.size();\n+    }\n+    {\n+        // Delete disconnected nodes\n+        std::list<CNode*> vNodesDisconnectedCopy = vNodesDisconnected;\n+        for (CNode* pnode : vNodesDisconnectedCopy)\n         {\n-            // Delete disconnected nodes\n-            std::list<CNode*> vNodesDisconnectedCopy = vNodesDisconnected;\n-            for (CNode* pnode : vNodesDisconnectedCopy)\n-            {\n-                // wait until threads are done using it\n-                if (pnode->GetRefCount() <= 0) {\n-                    bool fDelete = false;\n-                    {\n-                        TRY_LOCK(pnode->cs_inventory, lockInv);\n-                        if (lockInv) {\n-                            TRY_LOCK(pnode->cs_vSend, lockSend);\n-                            if (lockSend) {\n-                                fDelete = true;\n-                            }\n+            // wait until threads are done using it\n+            if (pnode->GetRefCount() <= 0) {\n+                bool fDelete = false;\n+                {\n+                    TRY_LOCK(pnode->cs_inventory, lockInv);\n+                    if (lockInv) {\n+                        TRY_LOCK(pnode->cs_vSend, lockSend);\n+                        if (lockSend) {\n+                            fDelete = true;\n                         }\n                     }\n-                    if (fDelete) {\n-                        vNodesDisconnected.remove(pnode);\n-                        DeleteNode(pnode);\n-                    }\n+                }\n+                if (fDelete) {\n+                    vNodesDisconnected.remove(pnode);\n+                    DeleteNode(pnode);\n                 }\n             }\n         }\n-        size_t vNodesSize;\n-        {\n-            LOCK(cs_vNodes);\n-            vNodesSize = vNodes.size();\n-        }\n-        if(vNodesSize != nPrevNodeCount) {\n-            nPrevNodeCount = vNodesSize;\n-            if(clientInterface)\n-                clientInterface->NotifyNumConnectionsChanged(vNodesSize);\n+    }\n+    if(vNodesSize != nPrevNodeCount) {\n+        nPrevNodeCount = vNodesSize;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215659807",
      "id" : 215659807,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTY1OTgwNw==",
      "original_commit_id" : "431cbca5ed5e18785568533f7b0a5f49ba195f5d",
      "original_position" : 127,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 152974422,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147",
      "updated_at" : "2018-09-16T02:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215659807",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215692998"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215692998"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It is indeed.",
      "commit_id" : "672543085ac4973f034ad30f897230581a2af8d2",
      "created_at" : "2018-09-06T16:28:53Z",
      "diff_hunk" : "@@ -1153,82 +1153,124 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     }\n }\n \n-void CConnman::ThreadSocketHandler()\n-{\n-    unsigned int nPrevNodeCount = 0;\n-    while (!interruptNet)\n+void CConnman::DisconnectNodes() {\n+    size_t nPrevNodeCount, vNodesSize;\n     {\n-        //\n-        // Disconnect nodes\n-        //\n-        {\n-            LOCK(cs_vNodes);\n+        LOCK(cs_vNodes);\n \n-            if (!fNetworkActive) {\n-                // Disconnect any connected nodes\n-                for (CNode* pnode : vNodes) {\n-                    if (!pnode->fDisconnect) {\n-                        LogPrint(BCLog::NET, \"Network not active, dropping peer=%d\\n\", pnode->GetId());\n-                        pnode->fDisconnect = true;\n-                    }\n+        nPrevNodeCount = vNodes.size();\n+\n+        if (!fNetworkActive) {\n+            // Disconnect any connected nodes\n+            for (CNode* pnode : vNodes) {\n+                if (!pnode->fDisconnect) {\n+                    LogPrint(BCLog::NET, \"Network not active, dropping peer=%d\\n\", pnode->GetId());\n+                    pnode->fDisconnect = true;\n                 }\n             }\n+        }\n \n-            // Disconnect unused nodes\n-            std::vector<CNode*> vNodesCopy = vNodes;\n-            for (CNode* pnode : vNodesCopy)\n+        // Disconnect unused nodes\n+        std::vector<CNode*> vNodesCopy = vNodes;\n+        for (CNode* pnode : vNodesCopy)\n+        {\n+            if (pnode->fDisconnect)\n             {\n-                if (pnode->fDisconnect)\n-                {\n-                    // remove from vNodes\n-                    vNodes.erase(remove(vNodes.begin(), vNodes.end(), pnode), vNodes.end());\n+                // remove from vNodes\n+                vNodes.erase(remove(vNodes.begin(), vNodes.end(), pnode), vNodes.end());\n \n-                    // release outbound grant (if any)\n-                    pnode->grantOutbound.Release();\n+                // release outbound grant (if any)\n+                pnode->grantOutbound.Release();\n \n-                    // close socket and cleanup\n-                    pnode->CloseSocketDisconnect();\n+                // close socket and cleanup\n+                pnode->CloseSocketDisconnect();\n \n-                    // hold in disconnected pool until all refs are released\n-                    pnode->Release();\n-                    vNodesDisconnected.push_back(pnode);\n-                }\n+                // hold in disconnected pool until all refs are released\n+                pnode->Release();\n+                vNodesDisconnected.push_back(pnode);\n             }\n         }\n+\n+        vNodesSize = vNodes.size();\n+    }\n+    {\n+        // Delete disconnected nodes\n+        std::list<CNode*> vNodesDisconnectedCopy = vNodesDisconnected;\n+        for (CNode* pnode : vNodesDisconnectedCopy)\n         {\n-            // Delete disconnected nodes\n-            std::list<CNode*> vNodesDisconnectedCopy = vNodesDisconnected;\n-            for (CNode* pnode : vNodesDisconnectedCopy)\n-            {\n-                // wait until threads are done using it\n-                if (pnode->GetRefCount() <= 0) {\n-                    bool fDelete = false;\n-                    {\n-                        TRY_LOCK(pnode->cs_inventory, lockInv);\n-                        if (lockInv) {\n-                            TRY_LOCK(pnode->cs_vSend, lockSend);\n-                            if (lockSend) {\n-                                fDelete = true;\n-                            }\n+            // wait until threads are done using it\n+            if (pnode->GetRefCount() <= 0) {\n+                bool fDelete = false;\n+                {\n+                    TRY_LOCK(pnode->cs_inventory, lockInv);\n+                    if (lockInv) {\n+                        TRY_LOCK(pnode->cs_vSend, lockSend);\n+                        if (lockSend) {\n+                            fDelete = true;\n                         }\n                     }\n-                    if (fDelete) {\n-                        vNodesDisconnected.remove(pnode);\n-                        DeleteNode(pnode);\n-                    }\n+                }\n+                if (fDelete) {\n+                    vNodesDisconnected.remove(pnode);\n+                    DeleteNode(pnode);\n                 }\n             }\n         }\n-        size_t vNodesSize;\n-        {\n-            LOCK(cs_vNodes);\n-            vNodesSize = vNodes.size();\n-        }\n-        if(vNodesSize != nPrevNodeCount) {\n-            nPrevNodeCount = vNodesSize;\n-            if(clientInterface)\n-                clientInterface->NotifyNumConnectionsChanged(vNodesSize);\n+    }\n+    if(vNodesSize != nPrevNodeCount) {\n+        nPrevNodeCount = vNodesSize;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215692998",
      "id" : 215692998,
      "in_reply_to_id" : 215659807,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTY5Mjk5OA==",
      "original_commit_id" : "431cbca5ed5e18785568533f7b0a5f49ba195f5d",
      "original_position" : 127,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 153015840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147",
      "updated_at" : "2018-09-16T02:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215692998",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/620611?v=4",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "node_id" : "MDQ6VXNlcjYyMDYxMQ==",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-utACK",
      "created_at" : "2018-09-06T19:08:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#issuecomment-419208185",
      "id" : 419208185,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14147",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQxOTIwODE4NQ==",
      "updated_at" : "2018-09-06T19:08:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/419208185",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215761757"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215761757"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Commit \"Improve lock handling in DisconnectNodes.\"\r\n\r\nIs it worth preventing notifying the same connection count?",
      "commit_id" : "672543085ac4973f034ad30f897230581a2af8d2",
      "created_at" : "2018-09-06T20:12:27Z",
      "diff_hunk" : "@@ -1215,14 +1217,8 @@ void CConnman::DisconnectNodes() {\n             }\n         }\n     }\n-    {\n-        LOCK(cs_vNodes);\n-        vNodesSize = vNodes.size();\n-    }\n-    if(vNodesSize != nPrevNodeCount) {\n-        nPrevNodeCount = vNodesSize;\n-        if(clientInterface)\n-            clientInterface->NotifyNumConnectionsChanged(vNodesSize);\n+    if(clientInterface && vNodesSize != nPrevNodeCount) {\n+        clientInterface->NotifyNumConnectionsChanged(vNodesSize);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215761757",
      "id" : 215761757,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTc2MTc1Nw==",
      "original_commit_id" : "d95e66e939c7fa6c4fb7965f6b6531d2fff4f53c",
      "original_position" : 22,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 153100971,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147",
      "updated_at" : "2018-09-16T02:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215761757",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215761914"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215761914"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Commit \"Improve lock handling in DisconnectNodes.\"\r\n\r\nnit, space after `if`.",
      "commit_id" : "672543085ac4973f034ad30f897230581a2af8d2",
      "created_at" : "2018-09-06T20:12:58Z",
      "diff_hunk" : "@@ -1215,14 +1217,8 @@ void CConnman::DisconnectNodes() {\n             }\n         }\n     }\n-    {\n-        LOCK(cs_vNodes);\n-        vNodesSize = vNodes.size();\n-    }\n-    if(vNodesSize != nPrevNodeCount) {\n-        nPrevNodeCount = vNodesSize;\n-        if(clientInterface)\n-            clientInterface->NotifyNumConnectionsChanged(vNodesSize);\n+    if(clientInterface && vNodesSize != nPrevNodeCount) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215761914",
      "id" : 215761914,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTc2MTkxNA==",
      "original_commit_id" : "d95e66e939c7fa6c4fb7965f6b6531d2fff4f53c",
      "original_position" : 21,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 153100971,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147",
      "updated_at" : "2018-09-16T02:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215761914",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215763725"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215763725"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Commit \"Move InactivityChecks logic to private method.\"\r\n\r\nJust noting that with this change `InactivityCheck` is now called with `cs_vNodes` locked.",
      "commit_id" : "672543085ac4973f034ad30f897230581a2af8d2",
      "created_at" : "2018-09-06T20:19:38Z",
      "diff_hunk" : "@@ -1222,6 +1222,13 @@ void CConnman::DisconnectNodes() {\n     }\n }\n \n+void CConnman::InactivityChecks() {\n+    LOCK(cs_vNodes);\n+    for (CNode* pnode : vNodes) {\n+        InactivityCheck(pnode);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215763725",
      "id" : 215763725,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTc2MzcyNQ==",
      "original_commit_id" : "1518622660ea7ddaa08e0020e88b0d9469d4f4b5",
      "original_position" : 7,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 153100971,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147",
      "updated_at" : "2018-09-16T02:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215763725",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215764671"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215764671"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Commit \"Merge InactivityCheck into InactivityChecks.\"\r\n\r\nCould remove this block?",
      "commit_id" : "672543085ac4973f034ad30f897230581a2af8d2",
      "created_at" : "2018-09-06T20:22:55Z",
      "diff_hunk" : "@@ -1223,41 +1223,40 @@ void CConnman::DisconnectNodes() {\n }\n \n void CConnman::InactivityChecks() {\n-    LOCK(cs_vNodes);\n-    for (CNode* pnode : vNodes) {\n-        InactivityCheck(pnode);\n-    }\n-}\n-\n-void CConnman::InactivityCheck(CNode *pnode) {\n     int64_t nMicroTime = GetTimeMicros();\n     int64_t nTime = nMicroTime / 1000000;\n-    if (nTime - pnode->nTimeConnected > 60)\n+\n     {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215764671",
      "id" : 215764671,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTc2NDY3MQ==",
      "original_commit_id" : "2c325bd625a36ba2021355a7c65edf06427bdc2e",
      "original_position" : 15,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 153100971,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147",
      "updated_at" : "2018-09-16T02:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215764671",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215764901"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215764901"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Commit \"Merge InactivityCheck into InactivityChecks.\"\r\n\r\nShould be after `LOCK(cs_vNodes)`?",
      "commit_id" : "672543085ac4973f034ad30f897230581a2af8d2",
      "created_at" : "2018-09-06T20:23:41Z",
      "diff_hunk" : "@@ -1223,41 +1223,40 @@ void CConnman::DisconnectNodes() {\n }\n \n void CConnman::InactivityChecks() {\n-    LOCK(cs_vNodes);\n-    for (CNode* pnode : vNodes) {\n-        InactivityCheck(pnode);\n-    }\n-}\n-\n-void CConnman::InactivityCheck(CNode *pnode) {\n     int64_t nMicroTime = GetTimeMicros();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215764901",
      "id" : 215764901,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTc2NDkwMQ==",
      "original_commit_id" : "2c325bd625a36ba2021355a7c65edf06427bdc2e",
      "original_position" : 11,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 153100971,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147",
      "updated_at" : "2018-09-16T02:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215764901",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215808871"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215808871"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes, it triggers a notification that updates the GUI and would happen every 50ms.",
      "commit_id" : "672543085ac4973f034ad30f897230581a2af8d2",
      "created_at" : "2018-09-06T23:36:43Z",
      "diff_hunk" : "@@ -1215,14 +1217,8 @@ void CConnman::DisconnectNodes() {\n             }\n         }\n     }\n-    {\n-        LOCK(cs_vNodes);\n-        vNodesSize = vNodes.size();\n-    }\n-    if(vNodesSize != nPrevNodeCount) {\n-        nPrevNodeCount = vNodesSize;\n-        if(clientInterface)\n-            clientInterface->NotifyNumConnectionsChanged(vNodesSize);\n+    if(clientInterface && vNodesSize != nPrevNodeCount) {\n+        clientInterface->NotifyNumConnectionsChanged(vNodesSize);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215808871",
      "id" : 215808871,
      "in_reply_to_id" : 215761757,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTgwODg3MQ==",
      "original_commit_id" : "d95e66e939c7fa6c4fb7965f6b6531d2fff4f53c",
      "original_position" : 22,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 153159919,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147",
      "updated_at" : "2018-09-16T02:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215808871",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/620611?v=4",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "node_id" : "MDQ6VXNlcjYyMDYxMQ==",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215809842"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215809842"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "fixed",
      "commit_id" : "672543085ac4973f034ad30f897230581a2af8d2",
      "created_at" : "2018-09-06T23:43:28Z",
      "diff_hunk" : "@@ -1215,14 +1217,8 @@ void CConnman::DisconnectNodes() {\n             }\n         }\n     }\n-    {\n-        LOCK(cs_vNodes);\n-        vNodesSize = vNodes.size();\n-    }\n-    if(vNodesSize != nPrevNodeCount) {\n-        nPrevNodeCount = vNodesSize;\n-        if(clientInterface)\n-            clientInterface->NotifyNumConnectionsChanged(vNodesSize);\n+    if(clientInterface && vNodesSize != nPrevNodeCount) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215809842",
      "id" : 215809842,
      "in_reply_to_id" : 215761914,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTgwOTg0Mg==",
      "original_commit_id" : "d95e66e939c7fa6c4fb7965f6b6531d2fff4f53c",
      "original_position" : 21,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 153161117,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147",
      "updated_at" : "2018-09-16T02:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215809842",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/620611?v=4",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "node_id" : "MDQ6VXNlcjYyMDYxMQ==",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215810002"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215810002"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The reasoning here is that the contents of InactivityCheck are virtually instant.\r\n\r\nIf this causes any issues in the future it can be trivially switched back to using reference counting.",
      "commit_id" : "672543085ac4973f034ad30f897230581a2af8d2",
      "created_at" : "2018-09-06T23:44:43Z",
      "diff_hunk" : "@@ -1222,6 +1222,13 @@ void CConnman::DisconnectNodes() {\n     }\n }\n \n+void CConnman::InactivityChecks() {\n+    LOCK(cs_vNodes);\n+    for (CNode* pnode : vNodes) {\n+        InactivityCheck(pnode);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215810002",
      "id" : 215810002,
      "in_reply_to_id" : 215763725,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTgxMDAwMg==",
      "original_commit_id" : "1518622660ea7ddaa08e0020e88b0d9469d4f4b5",
      "original_position" : 7,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 153161312,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147",
      "updated_at" : "2018-09-16T02:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215810002",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/620611?v=4",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "node_id" : "MDQ6VXNlcjYyMDYxMQ==",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215811565"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215811565"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not sure what you mean here",
      "commit_id" : "672543085ac4973f034ad30f897230581a2af8d2",
      "created_at" : "2018-09-06T23:55:23Z",
      "diff_hunk" : "@@ -1223,41 +1223,40 @@ void CConnman::DisconnectNodes() {\n }\n \n void CConnman::InactivityChecks() {\n-    LOCK(cs_vNodes);\n-    for (CNode* pnode : vNodes) {\n-        InactivityCheck(pnode);\n-    }\n-}\n-\n-void CConnman::InactivityCheck(CNode *pnode) {\n     int64_t nMicroTime = GetTimeMicros();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215811565",
      "id" : 215811565,
      "in_reply_to_id" : 215764901,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTgxMTU2NQ==",
      "original_commit_id" : "2c325bd625a36ba2021355a7c65edf06427bdc2e",
      "original_position" : 11,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 153163186,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147",
      "updated_at" : "2018-09-16T02:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215811565",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/620611?v=4",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "node_id" : "MDQ6VXNlcjYyMDYxMQ==",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215811574"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215811574"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not sure what you mean here",
      "commit_id" : "672543085ac4973f034ad30f897230581a2af8d2",
      "created_at" : "2018-09-06T23:55:26Z",
      "diff_hunk" : "@@ -1223,41 +1223,40 @@ void CConnman::DisconnectNodes() {\n }\n \n void CConnman::InactivityChecks() {\n-    LOCK(cs_vNodes);\n-    for (CNode* pnode : vNodes) {\n-        InactivityCheck(pnode);\n-    }\n-}\n-\n-void CConnman::InactivityCheck(CNode *pnode) {\n     int64_t nMicroTime = GetTimeMicros();\n     int64_t nTime = nMicroTime / 1000000;\n-    if (nTime - pnode->nTimeConnected > 60)\n+\n     {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215811574",
      "id" : 215811574,
      "in_reply_to_id" : 215764671,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTgxMTU3NA==",
      "original_commit_id" : "2c325bd625a36ba2021355a7c65edf06427bdc2e",
      "original_position" : 15,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 153163195,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147",
      "updated_at" : "2018-09-16T02:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215811574",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/620611?v=4",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "node_id" : "MDQ6VXNlcjYyMDYxMQ==",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215813009"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215813009"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Move the call `GetTimeMicros` after the lock?",
      "commit_id" : "672543085ac4973f034ad30f897230581a2af8d2",
      "created_at" : "2018-09-07T00:05:37Z",
      "diff_hunk" : "@@ -1223,41 +1223,40 @@ void CConnman::DisconnectNodes() {\n }\n \n void CConnman::InactivityChecks() {\n-    LOCK(cs_vNodes);\n-    for (CNode* pnode : vNodes) {\n-        InactivityCheck(pnode);\n-    }\n-}\n-\n-void CConnman::InactivityCheck(CNode *pnode) {\n     int64_t nMicroTime = GetTimeMicros();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215813009",
      "id" : 215813009,
      "in_reply_to_id" : 215764901,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTgxMzAwOQ==",
      "original_commit_id" : "2c325bd625a36ba2021355a7c65edf06427bdc2e",
      "original_position" : 11,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 153164899,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147",
      "updated_at" : "2018-09-16T02:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215813009",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215813582"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215813582"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I mean like this:\r\n```cpp\r\nvoid CConnman::InactivityChecks() {\r\n    LOCK(cs_vNodes);\r\n    int64_t nMicroTime = GetTimeMicros();\r\n    int64_t nTime = nMicroTime / 1000000;\r\n    for (CNode* pnode : vNodes) {\r\n        if (nTime - pnode->nTimeConnected > 60)\r\n        ...\r\n```",
      "commit_id" : "672543085ac4973f034ad30f897230581a2af8d2",
      "created_at" : "2018-09-07T00:10:16Z",
      "diff_hunk" : "@@ -1223,41 +1223,40 @@ void CConnman::DisconnectNodes() {\n }\n \n void CConnman::InactivityChecks() {\n-    LOCK(cs_vNodes);\n-    for (CNode* pnode : vNodes) {\n-        InactivityCheck(pnode);\n-    }\n-}\n-\n-void CConnman::InactivityCheck(CNode *pnode) {\n     int64_t nMicroTime = GetTimeMicros();\n     int64_t nTime = nMicroTime / 1000000;\n-    if (nTime - pnode->nTimeConnected > 60)\n+\n     {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215813582",
      "id" : 215813582,
      "in_reply_to_id" : 215764671,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTgxMzU4Mg==",
      "original_commit_id" : "2c325bd625a36ba2021355a7c65edf06427bdc2e",
      "original_position" : 15,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 153165622,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147",
      "updated_at" : "2018-09-16T02:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215813582",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215816329"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215816329"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah I see",
      "commit_id" : "672543085ac4973f034ad30f897230581a2af8d2",
      "created_at" : "2018-09-07T00:30:26Z",
      "diff_hunk" : "@@ -1223,41 +1223,40 @@ void CConnman::DisconnectNodes() {\n }\n \n void CConnman::InactivityChecks() {\n-    LOCK(cs_vNodes);\n-    for (CNode* pnode : vNodes) {\n-        InactivityCheck(pnode);\n-    }\n-}\n-\n-void CConnman::InactivityCheck(CNode *pnode) {\n     int64_t nMicroTime = GetTimeMicros();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215816329",
      "id" : 215816329,
      "in_reply_to_id" : 215764901,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTgxNjMyOQ==",
      "original_commit_id" : "2c325bd625a36ba2021355a7c65edf06427bdc2e",
      "original_position" : 11,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 153168801,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147",
      "updated_at" : "2018-09-16T02:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215816329",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/620611?v=4",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "node_id" : "MDQ6VXNlcjYyMDYxMQ==",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215819477"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215819477"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "yeah good point, the lock could take a while",
      "commit_id" : "672543085ac4973f034ad30f897230581a2af8d2",
      "created_at" : "2018-09-07T00:57:20Z",
      "diff_hunk" : "@@ -1223,41 +1223,40 @@ void CConnman::DisconnectNodes() {\n }\n \n void CConnman::InactivityChecks() {\n-    LOCK(cs_vNodes);\n-    for (CNode* pnode : vNodes) {\n-        InactivityCheck(pnode);\n-    }\n-}\n-\n-void CConnman::InactivityCheck(CNode *pnode) {\n     int64_t nMicroTime = GetTimeMicros();\n     int64_t nTime = nMicroTime / 1000000;\n-    if (nTime - pnode->nTimeConnected > 60)\n+\n     {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r215819477",
      "id" : 215819477,
      "in_reply_to_id" : 215764671,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNTgxOTQ3Nw==",
      "original_commit_id" : "2c325bd625a36ba2021355a7c65edf06427bdc2e",
      "original_position" : 15,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 153172563,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147",
      "updated_at" : "2018-09-16T02:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/215819477",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/620611?v=4",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "node_id" : "MDQ6VXNlcjYyMDYxMQ==",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I don't believe this is correct. `NotifyNumConnectionsChanged` will now only be called when nodes are disconnected, and no longer when nodes are connected. Also moving the notify into the `DisconnectNodes` member function is confusing. I'd prefer to move it into a `static void NotifyNodeCount(CConman* cm, unsigned& prev_node_count) {...}`. Note the `static`, to prevent having it to put into the header file and bloat it unnecessarily. (Imo you could do this as well for the other functions)\r\n\r\nLet me know if I am mistaken in some way.\r\n\r\nAlso, it would help to see the code that builds on top of this refactor. This way it is easier to see why the refactor is required and why it was done in exactly this way.",
      "created_at" : "2018-09-07T17:40:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#issuecomment-419513882",
      "id" : 419513882,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14147",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQxOTUxMzg4Mg==",
      "updated_at" : "2018-09-07T17:40:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/419513882",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r216036912"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/216036912"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit e92a917117 Reduce calls to GetMicroTime in InactivityCheck.\r\n\r\nnewly introduced variables should always be `snake_case`, e.g. `time_micro = ...` .",
      "commit_id" : "672543085ac4973f034ad30f897230581a2af8d2",
      "created_at" : "2018-09-07T17:46:10Z",
      "diff_hunk" : "@@ -1153,82 +1153,123 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     }\n }\n \n-void CConnman::ThreadSocketHandler()\n-{\n-    unsigned int nPrevNodeCount = 0;\n-    while (!interruptNet)\n+void CConnman::DisconnectNodes() {\n+    size_t nPrevNodeCount, vNodesSize;\n     {\n-        //\n-        // Disconnect nodes\n-        //\n-        {\n-            LOCK(cs_vNodes);\n+        LOCK(cs_vNodes);\n \n-            if (!fNetworkActive) {\n-                // Disconnect any connected nodes\n-                for (CNode* pnode : vNodes) {\n-                    if (!pnode->fDisconnect) {\n-                        LogPrint(BCLog::NET, \"Network not active, dropping peer=%d\\n\", pnode->GetId());\n-                        pnode->fDisconnect = true;\n-                    }\n+        nPrevNodeCount = vNodes.size();\n+\n+        if (!fNetworkActive) {\n+            // Disconnect any connected nodes\n+            for (CNode* pnode : vNodes) {\n+                if (!pnode->fDisconnect) {\n+                    LogPrint(BCLog::NET, \"Network not active, dropping peer=%d\\n\", pnode->GetId());\n+                    pnode->fDisconnect = true;\n                 }\n             }\n+        }\n \n-            // Disconnect unused nodes\n-            std::vector<CNode*> vNodesCopy = vNodes;\n-            for (CNode* pnode : vNodesCopy)\n+        // Disconnect unused nodes\n+        std::vector<CNode*> vNodesCopy = vNodes;\n+        for (CNode* pnode : vNodesCopy)\n+        {\n+            if (pnode->fDisconnect)\n             {\n-                if (pnode->fDisconnect)\n-                {\n-                    // remove from vNodes\n-                    vNodes.erase(remove(vNodes.begin(), vNodes.end(), pnode), vNodes.end());\n+                // remove from vNodes\n+                vNodes.erase(remove(vNodes.begin(), vNodes.end(), pnode), vNodes.end());\n \n-                    // release outbound grant (if any)\n-                    pnode->grantOutbound.Release();\n+                // release outbound grant (if any)\n+                pnode->grantOutbound.Release();\n \n-                    // close socket and cleanup\n-                    pnode->CloseSocketDisconnect();\n+                // close socket and cleanup\n+                pnode->CloseSocketDisconnect();\n \n-                    // hold in disconnected pool until all refs are released\n-                    pnode->Release();\n-                    vNodesDisconnected.push_back(pnode);\n-                }\n+                // hold in disconnected pool until all refs are released\n+                pnode->Release();\n+                vNodesDisconnected.push_back(pnode);\n             }\n         }\n+\n+        vNodesSize = vNodes.size();\n+    }\n+    {\n+        // Delete disconnected nodes\n+        std::list<CNode*> vNodesDisconnectedCopy = vNodesDisconnected;\n+        for (CNode* pnode : vNodesDisconnectedCopy)\n         {\n-            // Delete disconnected nodes\n-            std::list<CNode*> vNodesDisconnectedCopy = vNodesDisconnected;\n-            for (CNode* pnode : vNodesDisconnectedCopy)\n-            {\n-                // wait until threads are done using it\n-                if (pnode->GetRefCount() <= 0) {\n-                    bool fDelete = false;\n-                    {\n-                        TRY_LOCK(pnode->cs_inventory, lockInv);\n-                        if (lockInv) {\n-                            TRY_LOCK(pnode->cs_vSend, lockSend);\n-                            if (lockSend) {\n-                                fDelete = true;\n-                            }\n+            // wait until threads are done using it\n+            if (pnode->GetRefCount() <= 0) {\n+                bool fDelete = false;\n+                {\n+                    TRY_LOCK(pnode->cs_inventory, lockInv);\n+                    if (lockInv) {\n+                        TRY_LOCK(pnode->cs_vSend, lockSend);\n+                        if (lockSend) {\n+                            fDelete = true;\n                         }\n                     }\n-                    if (fDelete) {\n-                        vNodesDisconnected.remove(pnode);\n-                        DeleteNode(pnode);\n-                    }\n+                }\n+                if (fDelete) {\n+                    vNodesDisconnected.remove(pnode);\n+                    DeleteNode(pnode);\n                 }\n             }\n         }\n-        size_t vNodesSize;\n-        {\n-            LOCK(cs_vNodes);\n-            vNodesSize = vNodes.size();\n-        }\n-        if(vNodesSize != nPrevNodeCount) {\n-            nPrevNodeCount = vNodesSize;\n-            if(clientInterface)\n-                clientInterface->NotifyNumConnectionsChanged(vNodesSize);\n+    }\n+    if (clientInterface && vNodesSize != nPrevNodeCount) {\n+        clientInterface->NotifyNumConnectionsChanged(vNodesSize);\n+    }\n+}\n+\n+void CConnman::InactivityChecks() {\n+    int64_t nMicroTime, nTime;\n+\n+    {\n+        LOCK(cs_vNodes);\n+        nMicroTime = GetTimeMicros();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r216036912",
      "id" : 216036912,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNjAzNjkxMg==",
      "original_commit_id" : "718843aed5e60e42ebbe822457511b4fbbf318eb",
      "original_position" : 136,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 153440676,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147",
      "updated_at" : "2018-09-16T02:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/216036912",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r216424621"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/216424621"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Move DisconnectNodes logic to private method.\" (7c203fb5ab2558cd6e306d85a62c8bbe159a7c02)\r\n\r\nShould delete this comment I think. It just takes up space and conveys no information.",
      "commit_id" : "672543085ac4973f034ad30f897230581a2af8d2",
      "created_at" : "2018-09-10T18:21:28Z",
      "diff_hunk" : "@@ -1153,82 +1153,86 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     }\n }\n \n-void CConnman::ThreadSocketHandler()\n-{\n-    unsigned int nPrevNodeCount = 0;\n-    while (!interruptNet)\n+void CConnman::DisconnectNodes(unsigned int &nPrevNodeCount) {\n     {\n-        //\n-        // Disconnect nodes\n-        //\n-        {\n-            LOCK(cs_vNodes);\n+        LOCK(cs_vNodes);\n \n-            if (!fNetworkActive) {\n-                // Disconnect any connected nodes\n-                for (CNode* pnode : vNodes) {\n-                    if (!pnode->fDisconnect) {\n-                        LogPrint(BCLog::NET, \"Network not active, dropping peer=%d\\n\", pnode->GetId());\n-                        pnode->fDisconnect = true;\n-                    }\n+        if (!fNetworkActive) {\n+            // Disconnect any connected nodes\n+            for (CNode* pnode : vNodes) {\n+                if (!pnode->fDisconnect) {\n+                    LogPrint(BCLog::NET, \"Network not active, dropping peer=%d\\n\", pnode->GetId());\n+                    pnode->fDisconnect = true;\n                 }\n             }\n+        }\n \n-            // Disconnect unused nodes\n-            std::vector<CNode*> vNodesCopy = vNodes;\n-            for (CNode* pnode : vNodesCopy)\n+        // Disconnect unused nodes\n+        std::vector<CNode*> vNodesCopy = vNodes;\n+        for (CNode* pnode : vNodesCopy)\n+        {\n+            if (pnode->fDisconnect)\n             {\n-                if (pnode->fDisconnect)\n-                {\n-                    // remove from vNodes\n-                    vNodes.erase(remove(vNodes.begin(), vNodes.end(), pnode), vNodes.end());\n+                // remove from vNodes\n+                vNodes.erase(remove(vNodes.begin(), vNodes.end(), pnode), vNodes.end());\n \n-                    // release outbound grant (if any)\n-                    pnode->grantOutbound.Release();\n+                // release outbound grant (if any)\n+                pnode->grantOutbound.Release();\n \n-                    // close socket and cleanup\n-                    pnode->CloseSocketDisconnect();\n+                // close socket and cleanup\n+                pnode->CloseSocketDisconnect();\n \n-                    // hold in disconnected pool until all refs are released\n-                    pnode->Release();\n-                    vNodesDisconnected.push_back(pnode);\n-                }\n+                // hold in disconnected pool until all refs are released\n+                pnode->Release();\n+                vNodesDisconnected.push_back(pnode);\n             }\n         }\n+    }\n+    {\n+        // Delete disconnected nodes\n+        std::list<CNode*> vNodesDisconnectedCopy = vNodesDisconnected;\n+        for (CNode* pnode : vNodesDisconnectedCopy)\n         {\n-            // Delete disconnected nodes\n-            std::list<CNode*> vNodesDisconnectedCopy = vNodesDisconnected;\n-            for (CNode* pnode : vNodesDisconnectedCopy)\n-            {\n-                // wait until threads are done using it\n-                if (pnode->GetRefCount() <= 0) {\n-                    bool fDelete = false;\n-                    {\n-                        TRY_LOCK(pnode->cs_inventory, lockInv);\n-                        if (lockInv) {\n-                            TRY_LOCK(pnode->cs_vSend, lockSend);\n-                            if (lockSend) {\n-                                fDelete = true;\n-                            }\n+            // wait until threads are done using it\n+            if (pnode->GetRefCount() <= 0) {\n+                bool fDelete = false;\n+                {\n+                    TRY_LOCK(pnode->cs_inventory, lockInv);\n+                    if (lockInv) {\n+                        TRY_LOCK(pnode->cs_vSend, lockSend);\n+                        if (lockSend) {\n+                            fDelete = true;\n                         }\n                     }\n-                    if (fDelete) {\n-                        vNodesDisconnected.remove(pnode);\n-                        DeleteNode(pnode);\n-                    }\n+                }\n+                if (fDelete) {\n+                    vNodesDisconnected.remove(pnode);\n+                    DeleteNode(pnode);\n                 }\n             }\n         }\n-        size_t vNodesSize;\n-        {\n-            LOCK(cs_vNodes);\n-            vNodesSize = vNodes.size();\n-        }\n-        if(vNodesSize != nPrevNodeCount) {\n-            nPrevNodeCount = vNodesSize;\n-            if(clientInterface)\n-                clientInterface->NotifyNumConnectionsChanged(vNodesSize);\n-        }\n+    }\n+    size_t vNodesSize;\n+    {\n+        LOCK(cs_vNodes);\n+        vNodesSize = vNodes.size();\n+    }\n+    if(vNodesSize != nPrevNodeCount) {\n+        nPrevNodeCount = vNodesSize;\n+        if(clientInterface)\n+            clientInterface->NotifyNumConnectionsChanged(vNodesSize);\n+    }\n+}\n+\n+void CConnman::ThreadSocketHandler()\n+{\n+    unsigned int nPrevNodeCount = 0;\n+    while (!interruptNet)\n+    {\n+        //\n+        // Disconnect nodes",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r216424621",
      "id" : 216424621,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNjQyNDYyMQ==",
      "original_commit_id" : "7c203fb5ab2558cd6e306d85a62c8bbe159a7c02",
      "original_position" : 140,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 153902163,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147",
      "updated_at" : "2018-09-16T02:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/216424621",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r216425454"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/216425454"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Move DisconnectNodes logic to private method.\" (7c203fb5ab2558cd6e306d85a62c8bbe159a7c02)\r\n\r\nOpening brace should go on next line.",
      "commit_id" : "672543085ac4973f034ad30f897230581a2af8d2",
      "created_at" : "2018-09-10T18:23:58Z",
      "diff_hunk" : "@@ -1153,82 +1153,86 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     }\n }\n \n-void CConnman::ThreadSocketHandler()\n-{\n-    unsigned int nPrevNodeCount = 0;\n-    while (!interruptNet)\n+void CConnman::DisconnectNodes(unsigned int &nPrevNodeCount) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r216425454",
      "id" : 216425454,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNjQyNTQ1NA==",
      "original_commit_id" : "7c203fb5ab2558cd6e306d85a62c8bbe159a7c02",
      "original_position" : 8,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 153902163,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147",
      "updated_at" : "2018-09-16T02:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/216425454",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r216428783"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/216428783"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Improve lock handling in DisconnectNodes.\" (57bd308a09556960e8fab1cd44f61ef519058a59)\r\n\r\nI would combine this commit with the previous commit \"Remove nPrevNodeCount parameter\" because changes in that commit like moving the `vNodesSize` declaration further away from its assignment, and updating the `nPrevNodeCount` value before throwing it away really don't make sense standalone.",
      "commit_id" : "672543085ac4973f034ad30f897230581a2af8d2",
      "created_at" : "2018-09-10T18:34:34Z",
      "diff_hunk" : "@@ -1190,6 +1190,8 @@ void CConnman::DisconnectNodes() {\n                 vNodesDisconnected.push_back(pnode);\n             }\n         }\n+\n+        vNodesSize = vNodes.size();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r216428783",
      "id" : 216428783,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNjQyODc4Mw==",
      "original_commit_id" : "57bd308a09556960e8fab1cd44f61ef519058a59",
      "original_position" : 5,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 153902163,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147",
      "updated_at" : "2018-09-16T02:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/216428783",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@MarcoFalke you're definitely right, that is a bug\r\n\r\ni'm not so sure about making these static functions though, they extensively use CConnman variables and are only called by CConnman methods",
      "created_at" : "2018-09-10T20:17:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#issuecomment-420045849",
      "id" : 420045849,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14147",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyMDA0NTg0OQ==",
      "updated_at" : "2018-09-10T20:17:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/420045849",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/620611?v=4",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "node_id" : "MDQ6VXNlcjYyMDYxMQ==",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Yeah, feel free to ignore my comment about the static vs private",
      "created_at" : "2018-09-11T19:10:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#issuecomment-420387987",
      "id" : 420387987,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14147",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyMDM4Nzk4Nw==",
      "updated_at" : "2018-09-11T19:10:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/420387987",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@MarcoFalke ok fixed that issue and the variable naming",
      "created_at" : "2018-09-11T19:15:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#issuecomment-420389405",
      "id" : 420389405,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14147",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyMDM4OTQwNQ==",
      "updated_at" : "2018-09-11T19:15:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/420389405",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/620611?v=4",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "node_id" : "MDQ6VXNlcjYyMDYxMQ==",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 8491dfbadceb8052f852ebf0020a622194db525f",
      "created_at" : "2018-09-11T19:36:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#issuecomment-420396925",
      "id" : 420396925,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14147",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyMDM5NjkyNQ==",
      "updated_at" : "2018-09-11T19:36:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/420396925",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->Note to reviewers: This pull request conflicts with the following ones:\n\n* #14335 (net: refactor: cleanup ThreadSocketHandler by pstratem)\n* #14221 (wip: net: Implement poll by pstratem)\n* #14046 (net: Refactor message parsing (CNetMessage), adds flexibility by jonasschnelli)\n* #14032 (Add p2p layer encryption with ECDH/ChaCha20Poly1305 by jonasschnelli)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2018-09-12T20:52:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#issuecomment-420793745",
      "id" : 420793745,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14147",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQyMDc5Mzc0NQ==",
      "updated_at" : "2018-09-26T22:59:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/420793745",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r217818099"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/217818099"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Move DisconnectNodes logic to private method.\" (2d5c345507208d215c0621180305a9f1d363012a)\r\n\r\nIt seems like moving `NotifyNumConnectionsChanged` call from right after the disconnect to later in the loop below after the select call changes behavior. So instead of ui being updated immediately after a disconnection, it will only be updated after a disconnect followed by a receive on another socket? Is this correct / intentional / good?\r\n\r\n",
      "commit_id" : "672543085ac4973f034ad30f897230581a2af8d2",
      "created_at" : "2018-09-14T19:24:20Z",
      "diff_hunk" : "@@ -1153,82 +1153,74 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     }\n }\n \n-void CConnman::ThreadSocketHandler()\n+void CConnman::DisconnectNodes()\n {\n-    unsigned int nPrevNodeCount = 0;\n-    while (!interruptNet)\n     {\n-        //\n-        // Disconnect nodes\n-        //\n-        {\n-            LOCK(cs_vNodes);\n+        LOCK(cs_vNodes);\n \n-            if (!fNetworkActive) {\n-                // Disconnect any connected nodes\n-                for (CNode* pnode : vNodes) {\n-                    if (!pnode->fDisconnect) {\n-                        LogPrint(BCLog::NET, \"Network not active, dropping peer=%d\\n\", pnode->GetId());\n-                        pnode->fDisconnect = true;\n-                    }\n+        if (!fNetworkActive) {\n+            // Disconnect any connected nodes\n+            for (CNode* pnode : vNodes) {\n+                if (!pnode->fDisconnect) {\n+                    LogPrint(BCLog::NET, \"Network not active, dropping peer=%d\\n\", pnode->GetId());\n+                    pnode->fDisconnect = true;\n                 }\n             }\n+        }\n \n-            // Disconnect unused nodes\n-            std::vector<CNode*> vNodesCopy = vNodes;\n-            for (CNode* pnode : vNodesCopy)\n+        // Disconnect unused nodes\n+        std::vector<CNode*> vNodesCopy = vNodes;\n+        for (CNode* pnode : vNodesCopy)\n+        {\n+            if (pnode->fDisconnect)\n             {\n-                if (pnode->fDisconnect)\n-                {\n-                    // remove from vNodes\n-                    vNodes.erase(remove(vNodes.begin(), vNodes.end(), pnode), vNodes.end());\n+                // remove from vNodes\n+                vNodes.erase(remove(vNodes.begin(), vNodes.end(), pnode), vNodes.end());\n \n-                    // release outbound grant (if any)\n-                    pnode->grantOutbound.Release();\n+                // release outbound grant (if any)\n+                pnode->grantOutbound.Release();\n \n-                    // close socket and cleanup\n-                    pnode->CloseSocketDisconnect();\n+                // close socket and cleanup\n+                pnode->CloseSocketDisconnect();\n \n-                    // hold in disconnected pool until all refs are released\n-                    pnode->Release();\n-                    vNodesDisconnected.push_back(pnode);\n-                }\n+                // hold in disconnected pool until all refs are released\n+                pnode->Release();\n+                vNodesDisconnected.push_back(pnode);\n             }\n         }\n+    }\n+    {\n+        // Delete disconnected nodes\n+        std::list<CNode*> vNodesDisconnectedCopy = vNodesDisconnected;\n+        for (CNode* pnode : vNodesDisconnectedCopy)\n         {\n-            // Delete disconnected nodes\n-            std::list<CNode*> vNodesDisconnectedCopy = vNodesDisconnected;\n-            for (CNode* pnode : vNodesDisconnectedCopy)\n-            {\n-                // wait until threads are done using it\n-                if (pnode->GetRefCount() <= 0) {\n-                    bool fDelete = false;\n-                    {\n-                        TRY_LOCK(pnode->cs_inventory, lockInv);\n-                        if (lockInv) {\n-                            TRY_LOCK(pnode->cs_vSend, lockSend);\n-                            if (lockSend) {\n-                                fDelete = true;\n-                            }\n+            // wait until threads are done using it\n+            if (pnode->GetRefCount() <= 0) {\n+                bool fDelete = false;\n+                {\n+                    TRY_LOCK(pnode->cs_inventory, lockInv);\n+                    if (lockInv) {\n+                        TRY_LOCK(pnode->cs_vSend, lockSend);\n+                        if (lockSend) {\n+                            fDelete = true;\n                         }\n                     }\n-                    if (fDelete) {\n-                        vNodesDisconnected.remove(pnode);\n-                        DeleteNode(pnode);\n-                    }\n+                }\n+                if (fDelete) {\n+                    vNodesDisconnected.remove(pnode);\n+                    DeleteNode(pnode);\n                 }\n             }\n         }\n-        size_t vNodesSize;\n-        {\n-            LOCK(cs_vNodes);\n-            vNodesSize = vNodes.size();\n-        }\n-        if(vNodesSize != nPrevNodeCount) {\n-            nPrevNodeCount = vNodesSize;\n-            if(clientInterface)\n-                clientInterface->NotifyNumConnectionsChanged(vNodesSize);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r217818099",
      "id" : 217818099,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNzgxODA5OQ==",
      "original_commit_id" : "2d5c345507208d215c0621180305a9f1d363012a",
      "original_position" : 119,
      "path" : "src/net.cpp",
      "position" : 119,
      "pull_request_review_id" : 155630570,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147",
      "updated_at" : "2018-09-16T02:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/217818099",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r217824156"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/217824156"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Move NotifyNumConnectionsChanged logic to private method.\" (e817ce3090fa71c61170216090685ee142d0f1d5)\r\n\r\nIt would be nice if you combined this commit with commit \"Move DisconnectNodes logic to private method\" (2d5c345507208d215c0621180305a9f1d363012a), or moved this commit before it, so this block of code only moves once instead of twice inside the same PR.",
      "commit_id" : "672543085ac4973f034ad30f897230581a2af8d2",
      "created_at" : "2018-09-14T19:50:03Z",
      "diff_hunk" : "@@ -1255,9 +1255,22 @@ void CConnman::InactivityChecks()\n     }\n }\n \n+void CConnman::NotifyNumConnectionsChanged()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r217824156",
      "id" : 217824156,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNzgyNDE1Ng==",
      "original_commit_id" : "e817ce3090fa71c61170216090685ee142d0f1d5",
      "original_position" : 4,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 155630570,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147",
      "updated_at" : "2018-09-16T02:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/217824156",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r217825678"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/217825678"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"Run InactivityChecks before other socket handling logic.\" (8491dfbadceb8052f852ebf0020a622194db525f)\r\n\r\nIt seems like this commit should have no effect, but if it has no effect, then it's not clear why it would be desirable? I think it would be helpful if the commit messages in this PR said explicitly whether the commit is or isn't intending to change behavior.",
      "commit_id" : "672543085ac4973f034ad30f897230581a2af8d2",
      "created_at" : "2018-09-14T19:55:52Z",
      "diff_hunk" : "@@ -1260,6 +1260,7 @@ void CConnman::ThreadSocketHandler()\n     unsigned int nPrevNodeCount = 0;\n     while (!interruptNet)\n     {\n+        InactivityChecks();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r217825678",
      "id" : 217825678,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNzgyNTY3OA==",
      "original_commit_id" : "8491dfbadceb8052f852ebf0020a622194db525f",
      "original_position" : 4,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 155630570,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147",
      "updated_at" : "2018-09-16T02:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/217825678",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r217844021"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/217844021"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Select timeout is 50ms, doesn't seem to particularly matter.",
      "commit_id" : "672543085ac4973f034ad30f897230581a2af8d2",
      "created_at" : "2018-09-14T21:13:15Z",
      "diff_hunk" : "@@ -1153,82 +1153,74 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     }\n }\n \n-void CConnman::ThreadSocketHandler()\n+void CConnman::DisconnectNodes()\n {\n-    unsigned int nPrevNodeCount = 0;\n-    while (!interruptNet)\n     {\n-        //\n-        // Disconnect nodes\n-        //\n-        {\n-            LOCK(cs_vNodes);\n+        LOCK(cs_vNodes);\n \n-            if (!fNetworkActive) {\n-                // Disconnect any connected nodes\n-                for (CNode* pnode : vNodes) {\n-                    if (!pnode->fDisconnect) {\n-                        LogPrint(BCLog::NET, \"Network not active, dropping peer=%d\\n\", pnode->GetId());\n-                        pnode->fDisconnect = true;\n-                    }\n+        if (!fNetworkActive) {\n+            // Disconnect any connected nodes\n+            for (CNode* pnode : vNodes) {\n+                if (!pnode->fDisconnect) {\n+                    LogPrint(BCLog::NET, \"Network not active, dropping peer=%d\\n\", pnode->GetId());\n+                    pnode->fDisconnect = true;\n                 }\n             }\n+        }\n \n-            // Disconnect unused nodes\n-            std::vector<CNode*> vNodesCopy = vNodes;\n-            for (CNode* pnode : vNodesCopy)\n+        // Disconnect unused nodes\n+        std::vector<CNode*> vNodesCopy = vNodes;\n+        for (CNode* pnode : vNodesCopy)\n+        {\n+            if (pnode->fDisconnect)\n             {\n-                if (pnode->fDisconnect)\n-                {\n-                    // remove from vNodes\n-                    vNodes.erase(remove(vNodes.begin(), vNodes.end(), pnode), vNodes.end());\n+                // remove from vNodes\n+                vNodes.erase(remove(vNodes.begin(), vNodes.end(), pnode), vNodes.end());\n \n-                    // release outbound grant (if any)\n-                    pnode->grantOutbound.Release();\n+                // release outbound grant (if any)\n+                pnode->grantOutbound.Release();\n \n-                    // close socket and cleanup\n-                    pnode->CloseSocketDisconnect();\n+                // close socket and cleanup\n+                pnode->CloseSocketDisconnect();\n \n-                    // hold in disconnected pool until all refs are released\n-                    pnode->Release();\n-                    vNodesDisconnected.push_back(pnode);\n-                }\n+                // hold in disconnected pool until all refs are released\n+                pnode->Release();\n+                vNodesDisconnected.push_back(pnode);\n             }\n         }\n+    }\n+    {\n+        // Delete disconnected nodes\n+        std::list<CNode*> vNodesDisconnectedCopy = vNodesDisconnected;\n+        for (CNode* pnode : vNodesDisconnectedCopy)\n         {\n-            // Delete disconnected nodes\n-            std::list<CNode*> vNodesDisconnectedCopy = vNodesDisconnected;\n-            for (CNode* pnode : vNodesDisconnectedCopy)\n-            {\n-                // wait until threads are done using it\n-                if (pnode->GetRefCount() <= 0) {\n-                    bool fDelete = false;\n-                    {\n-                        TRY_LOCK(pnode->cs_inventory, lockInv);\n-                        if (lockInv) {\n-                            TRY_LOCK(pnode->cs_vSend, lockSend);\n-                            if (lockSend) {\n-                                fDelete = true;\n-                            }\n+            // wait until threads are done using it\n+            if (pnode->GetRefCount() <= 0) {\n+                bool fDelete = false;\n+                {\n+                    TRY_LOCK(pnode->cs_inventory, lockInv);\n+                    if (lockInv) {\n+                        TRY_LOCK(pnode->cs_vSend, lockSend);\n+                        if (lockSend) {\n+                            fDelete = true;\n                         }\n                     }\n-                    if (fDelete) {\n-                        vNodesDisconnected.remove(pnode);\n-                        DeleteNode(pnode);\n-                    }\n+                }\n+                if (fDelete) {\n+                    vNodesDisconnected.remove(pnode);\n+                    DeleteNode(pnode);\n                 }\n             }\n         }\n-        size_t vNodesSize;\n-        {\n-            LOCK(cs_vNodes);\n-            vNodesSize = vNodes.size();\n-        }\n-        if(vNodesSize != nPrevNodeCount) {\n-            nPrevNodeCount = vNodesSize;\n-            if(clientInterface)\n-                clientInterface->NotifyNumConnectionsChanged(vNodesSize);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r217844021",
      "id" : 217844021,
      "in_reply_to_id" : 217818099,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNzg0NDAyMQ==",
      "original_commit_id" : "2d5c345507208d215c0621180305a9f1d363012a",
      "original_position" : 119,
      "path" : "src/net.cpp",
      "position" : 119,
      "pull_request_review_id" : 155664178,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147",
      "updated_at" : "2018-09-16T02:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/217844021",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/620611?v=4",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "node_id" : "MDQ6VXNlcjYyMDYxMQ==",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r217844216"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/217844216"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Can certainly change it back though, it really shouldn't matter.",
      "commit_id" : "672543085ac4973f034ad30f897230581a2af8d2",
      "created_at" : "2018-09-14T21:14:09Z",
      "diff_hunk" : "@@ -1153,82 +1153,74 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     }\n }\n \n-void CConnman::ThreadSocketHandler()\n+void CConnman::DisconnectNodes()\n {\n-    unsigned int nPrevNodeCount = 0;\n-    while (!interruptNet)\n     {\n-        //\n-        // Disconnect nodes\n-        //\n-        {\n-            LOCK(cs_vNodes);\n+        LOCK(cs_vNodes);\n \n-            if (!fNetworkActive) {\n-                // Disconnect any connected nodes\n-                for (CNode* pnode : vNodes) {\n-                    if (!pnode->fDisconnect) {\n-                        LogPrint(BCLog::NET, \"Network not active, dropping peer=%d\\n\", pnode->GetId());\n-                        pnode->fDisconnect = true;\n-                    }\n+        if (!fNetworkActive) {\n+            // Disconnect any connected nodes\n+            for (CNode* pnode : vNodes) {\n+                if (!pnode->fDisconnect) {\n+                    LogPrint(BCLog::NET, \"Network not active, dropping peer=%d\\n\", pnode->GetId());\n+                    pnode->fDisconnect = true;\n                 }\n             }\n+        }\n \n-            // Disconnect unused nodes\n-            std::vector<CNode*> vNodesCopy = vNodes;\n-            for (CNode* pnode : vNodesCopy)\n+        // Disconnect unused nodes\n+        std::vector<CNode*> vNodesCopy = vNodes;\n+        for (CNode* pnode : vNodesCopy)\n+        {\n+            if (pnode->fDisconnect)\n             {\n-                if (pnode->fDisconnect)\n-                {\n-                    // remove from vNodes\n-                    vNodes.erase(remove(vNodes.begin(), vNodes.end(), pnode), vNodes.end());\n+                // remove from vNodes\n+                vNodes.erase(remove(vNodes.begin(), vNodes.end(), pnode), vNodes.end());\n \n-                    // release outbound grant (if any)\n-                    pnode->grantOutbound.Release();\n+                // release outbound grant (if any)\n+                pnode->grantOutbound.Release();\n \n-                    // close socket and cleanup\n-                    pnode->CloseSocketDisconnect();\n+                // close socket and cleanup\n+                pnode->CloseSocketDisconnect();\n \n-                    // hold in disconnected pool until all refs are released\n-                    pnode->Release();\n-                    vNodesDisconnected.push_back(pnode);\n-                }\n+                // hold in disconnected pool until all refs are released\n+                pnode->Release();\n+                vNodesDisconnected.push_back(pnode);\n             }\n         }\n+    }\n+    {\n+        // Delete disconnected nodes\n+        std::list<CNode*> vNodesDisconnectedCopy = vNodesDisconnected;\n+        for (CNode* pnode : vNodesDisconnectedCopy)\n         {\n-            // Delete disconnected nodes\n-            std::list<CNode*> vNodesDisconnectedCopy = vNodesDisconnected;\n-            for (CNode* pnode : vNodesDisconnectedCopy)\n-            {\n-                // wait until threads are done using it\n-                if (pnode->GetRefCount() <= 0) {\n-                    bool fDelete = false;\n-                    {\n-                        TRY_LOCK(pnode->cs_inventory, lockInv);\n-                        if (lockInv) {\n-                            TRY_LOCK(pnode->cs_vSend, lockSend);\n-                            if (lockSend) {\n-                                fDelete = true;\n-                            }\n+            // wait until threads are done using it\n+            if (pnode->GetRefCount() <= 0) {\n+                bool fDelete = false;\n+                {\n+                    TRY_LOCK(pnode->cs_inventory, lockInv);\n+                    if (lockInv) {\n+                        TRY_LOCK(pnode->cs_vSend, lockSend);\n+                        if (lockSend) {\n+                            fDelete = true;\n                         }\n                     }\n-                    if (fDelete) {\n-                        vNodesDisconnected.remove(pnode);\n-                        DeleteNode(pnode);\n-                    }\n+                }\n+                if (fDelete) {\n+                    vNodesDisconnected.remove(pnode);\n+                    DeleteNode(pnode);\n                 }\n             }\n         }\n-        size_t vNodesSize;\n-        {\n-            LOCK(cs_vNodes);\n-            vNodesSize = vNodes.size();\n-        }\n-        if(vNodesSize != nPrevNodeCount) {\n-            nPrevNodeCount = vNodesSize;\n-            if(clientInterface)\n-                clientInterface->NotifyNumConnectionsChanged(vNodesSize);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r217844216",
      "id" : 217844216,
      "in_reply_to_id" : 217818099,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNzg0NDIxNg==",
      "original_commit_id" : "2d5c345507208d215c0621180305a9f1d363012a",
      "original_position" : 119,
      "path" : "src/net.cpp",
      "position" : 119,
      "pull_request_review_id" : 155664434,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147",
      "updated_at" : "2018-09-16T02:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/217844216",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/620611?v=4",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "node_id" : "MDQ6VXNlcjYyMDYxMQ==",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r217900075"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/217900075"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I've restructured the first commit so that the logic isn't moved the first time.",
      "commit_id" : "672543085ac4973f034ad30f897230581a2af8d2",
      "created_at" : "2018-09-16T02:13:23Z",
      "diff_hunk" : "@@ -1255,9 +1255,22 @@ void CConnman::InactivityChecks()\n     }\n }\n \n+void CConnman::NotifyNumConnectionsChanged()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r217900075",
      "id" : 217900075,
      "in_reply_to_id" : 217824156,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNzkwMDA3NQ==",
      "original_commit_id" : "e817ce3090fa71c61170216090685ee142d0f1d5",
      "original_position" : 4,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 155729711,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147",
      "updated_at" : "2018-09-16T02:13:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/217900075",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/620611?v=4",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "node_id" : "MDQ6VXNlcjYyMDYxMQ==",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r217900087"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/217900087"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It doesn't really matter, but running it earlier might allow for marking nodes disconnected before the socket handling logic runs.",
      "commit_id" : "672543085ac4973f034ad30f897230581a2af8d2",
      "created_at" : "2018-09-16T02:14:24Z",
      "diff_hunk" : "@@ -1260,6 +1260,7 @@ void CConnman::ThreadSocketHandler()\n     unsigned int nPrevNodeCount = 0;\n     while (!interruptNet)\n     {\n+        InactivityChecks();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14147#discussion_r217900087",
      "id" : 217900087,
      "in_reply_to_id" : 217825678,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxNzkwMDA4Nw==",
      "original_commit_id" : "8491dfbadceb8052f852ebf0020a622194db525f",
      "original_position" : 4,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 155729727,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/14147",
      "updated_at" : "2018-09-16T02:14:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/217900087",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/620611?v=4",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "node_id" : "MDQ6VXNlcjYyMDYxMQ==",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   }
]
