[
   {
      "author_association" : "MEMBER",
      "body" : "I agree with the concept.  I wish we could announce our own addresses to these peers, but I think doing so results in a topology leak. :(   The reason I'd like this is that if an attacker eclipses a node except for its blocks only links it will eventually eclipse its blocks-only links too through control of the addrman state.",
      "created_at" : "2019-04-05T19:40:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-480398699",
      "id" : 480398699,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MDM5ODY5OQ==",
      "updated_at" : "2019-04-05T19:40:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/480398699",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This approach was motivated by the [TxProbe paper.](https://arxiv.org/pdf/1812.00942.pdf)  Fundamentally, transaction relay is going to leak information about our node's peers (as long as we care about not wasting bandwidth).  Rather than combat transaction-relay based inferences, which I think is a lost cause in the long-run even if there are improvements we can make in the short-term, I figure we can directly address why we care about keeping the graph private.\r\n\r\nSome considerations I had while working on this:\r\n\r\n * Is 2 the right number of blocks-only connections?  From a robustness standpoint, more connections like this are better; however there's a tradeoff with resource utilization.  Two resources that occurred to me to worry about were the memory used by each CNode object (hence the refactor commits that allow the transaction-relay data structures to not be instantiated for the blocks-only peers), and the number of connection slots on the network (I figure going from 8 to 10 is not that bad?).  I also did some simulations to verify that a random graph of 10000 peers would be fully connected if each peer makes 2 outbound connections to random other peers, which I thought was a good justification for 2 being a useful number of outbounds to add.\r\n\r\n * How should addrman interactions work on these blocks-only connections?  My approach attempts to leave addrman unchanged as a result of these connections, neither processing addr messages nor sending any, to avoid leaking information via addr messages that we relay to other peers.  But I have not given a lot of thought to what kind of attacks are possible using addrman, nor what the consequences are to not updating addrman with information from our blocks-only peers.\r\n",
      "created_at" : "2019-04-05T19:41:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-480398802",
      "id" : 480398802,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MDM5ODgwMg==",
      "updated_at" : "2019-04-06T01:06:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/480398802",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I also did some simulations to verify that a random graph of 10000 peers would be fully connected if each peer makes 2 outbound connections to random other peers,\r\n\r\nCan you run these simulations assuming x% of the 10,000 peers are black holes (don't connect the graph), for various values of x%?\r\n\r\n2 might be fine for now, but ultimately I'd like to optimize memory usage for both inbound and outbound blocksonly links, then at least double the inbound connection limit for blocks only links, and make 8 blocks only links.  (I suspect running that simulation assuming reasonable number of black hole peers will show that 2 is not really enough).     ",
      "created_at" : "2019-04-05T19:49:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-480400958",
      "id" : 480400958,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MDQwMDk1OA==",
      "updated_at" : "2019-04-05T19:49:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/480400958",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I figure we can directly address why we care about keeping the graph private\r\n\r\nTo the uninformed p2p reader this reason is?",
      "created_at" : "2019-04-05T20:15:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-480408075",
      "id" : 480408075,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MDQwODA3NQ==",
      "updated_at" : "2019-04-05T20:15:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/480408075",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#16762](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16762.html) (Rust-based Backup over-REST block downloader by TheBlueMatt)\n* [#16702](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16702.html) (p2p: supplying and using asmap to improve IP bucketing in addrman by naumenkogs)\n* [#16698](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16698.html) ([WIP] Mempool: rework rebroadcast logic to improve privacy by amitiuttarwar)\n* [#16682](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16682.html) ([WIP] p2p: Disconnect peer that send us tx INVs when we opted out of tx relay by jnewbery)\n* [#16507](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16507.html) (feefilter: Compute the absolute fee rather than stored rate by instagibbs)\n* [#15502](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15502.html) (Speed up initial connection to p2p network by ajtowns)\n* [#14033](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/14033.html) (p2p: Drop CADDR_TIME_VERSION checks now that MIN_PEER_PROTO_VERSION is greater by Empact)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-04-05T21:12:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-480423675",
      "id" : 480423675,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MDQyMzY3NQ==",
      "updated_at" : "2019-08-30T00:52:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/480423675",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> To the uninformed p2p reader this reason is?\r\n\r\n> (b) Knowledge of the network graph could be used to split a target node or\r\nnodes from the honest network (eg by knowing which peers to attack in order to\r\nachieve a network split).",
      "created_at" : "2019-04-05T21:37:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-480430294",
      "id" : 480430294,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MDQzMDI5NA==",
      "updated_at" : "2019-04-05T21:37:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/480430294",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Can you run these simulations assuming x% of the 10,000 peers are black holes (don't connect the graph), for various values of x%?\r\n\r\nThis table shows my simulation results for various black hole rates, with various values of how many outbound connections we make (k=2 is what I've implemented in this PR).  This is on a 10,000 node graph with no non-listening nodes.  Each table entry shows the success count (where success is defined as \"the subgraph of non-black-hole nodes is connected\") out of 1000 simulations.\r\n\r\n\r\nblack hole rate | k=2 | k=4 | k=6 | k=8\r\n-- | -- | -- | -- | --\r\n0 | 1000 | 1000 | 1000 | 1000\r\n5% | 30 | 998 | 1000 | 1000\r\n10% | 0 | 976 | 1000 | 1000\r\n15% | ÃÂ  | 867 | 999 | 1000\r\n20% | ÃÂ  | 598 | 994 | 1000\r\n25% | ÃÂ  | 229 | 978 | 1000\r\n30% | ÃÂ  | 33 | 928 | 998\r\n35% | ÃÂ  | 2 | 812 | 992\r\n\r\n\r\n> 2 might be fine for now, but ultimately I'd like to optimize memory usage for both inbound and outbound blocksonly links, then at least double the inbound connection limit for blocks only links, and make 8 blocks only links.\r\n\r\nThis is roughly what I have in mind as well.  I think we need a p2p protocol change to allow negotiating blocks-only links (so that the peer on the other side of our connection knows that the inbound peer won't turn transaction relay on later), so I figured we could start small for now.",
      "created_at" : "2019-04-08T14:59:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-480868516",
      "id" : 480868516,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MDg2ODUxNg==",
      "updated_at" : "2019-04-08T14:59:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/480868516",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@sdaftuar Thanks for sharing the results of the analysis! Would you be willing to share the simulation scripts?",
      "created_at" : "2019-04-08T17:32:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-480928635",
      "id" : 480928635,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MDkyODYzNQ==",
      "updated_at" : "2019-04-08T17:32:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/480928635",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@practicalswift My simulation code is unreadable, and also may have bugs, so I'd prefer that anyone interested in this would independently corroborate my results from scratch. ",
      "created_at" : "2019-04-09T11:57:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-481220805",
      "id" : 481220805,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MTIyMDgwNQ==",
      "updated_at" : "2019-04-09T11:57:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/481220805",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> separating block relay from transaction relay;\r\n\r\nThis is indeed a good idea. I also see it as a small step towards peer rotation, I think this suggestion makes it easier to reason about rotation.\r\n\r\nI'm not sure if this is strongly related to the data you provided, but I'm also curious how many nodes have to be attacked (suspended?) to split network in halves etc.",
      "created_at" : "2019-04-10T17:34:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-481787812",
      "id" : 481787812,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MTc4NzgxMg==",
      "updated_at" : "2019-04-10T17:35:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/481787812",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Wouldn't this break all the benefits of compact blocks? (Ignoring that with the current implementation, block relay would likely still occur on the normal connections.)",
      "created_at" : "2019-04-18T18:41:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-484634796",
      "id" : 484634796,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4NDYzNDc5Ng==",
      "updated_at" : "2019-04-18T18:41:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/484634796",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@luke-jr I don't think so.  The idea is that nodes are still expected to do transaction relay with other peers, and my belief is that transaction propagation is good enough that compact block relay works just fine on these blocksonly links.  I believe my testing of this branch confirms that as well, but I'd welcome additional testers to corroborate those results in case I'm overlooking something.",
      "created_at" : "2019-04-18T19:57:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-484666402",
      "id" : 484666402,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4NDY2NjQwMg==",
      "updated_at" : "2019-04-18T19:57:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/484666402",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-05-16T18:05:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-493172934",
      "id" : 493172934,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MzE3MjkzNA==",
      "updated_at" : "2019-05-16T18:05:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/493172934",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK: I like the idea",
      "created_at" : "2019-05-16T19:13:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-493196048",
      "id" : 493196048,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MzE5NjA0OA==",
      "updated_at" : "2019-05-16T19:13:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/493196048",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r285334943"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/285334943"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/15759/commits/c36939ca2ea636dce8047065d88c2e70bd418405\r\n\r\nMove initialization here and drop constructor:\r\n```cpp\r\nCRollingBloomFilter addrKnown GUARDED_BY(cs_addrsend){5000, 0.001};\r\n```\r\n",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-05-18T09:01:18Z",
      "diff_hunk" : "@@ -691,12 +691,18 @@ class CNode\n     uint256 hashContinue;\n     std::atomic<int> nStartingHeight{-1};\n \n-    // flood relay\n-    std::vector<CAddress> vAddrToSend;\n-    CRollingBloomFilter addrKnown;\n-    bool fGetAddr{false};\n-    int64_t nNextAddrSend GUARDED_BY(cs_sendProcessing){0};\n-    int64_t nNextLocalAddrSend GUARDED_BY(cs_sendProcessing){0};\n+    struct AddrRelay {\n+        CCriticalSection cs_addrsend;\n+        std::vector<CAddress> vAddrToSend GUARDED_BY(cs_addrsend);\n+        CRollingBloomFilter addrKnown GUARDED_BY(cs_addrsend);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r285334943",
      "id" : 285334943,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4NTMzNDk0Mw==",
      "original_commit_id" : "c36939ca2ea636dce8047065d88c2e70bd418405",
      "original_position" : 13,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 239190945,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/285334943",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r285335020"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/285335020"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/15759/commits/c36939ca2ea636dce8047065d88c2e70bd418405\r\n\r\nCould explain why the new mutex? This commit isn't just refactor.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-05-18T09:04:33Z",
      "diff_hunk" : "@@ -691,12 +691,18 @@ class CNode\n     uint256 hashContinue;\n     std::atomic<int> nStartingHeight{-1};\n \n-    // flood relay\n-    std::vector<CAddress> vAddrToSend;\n-    CRollingBloomFilter addrKnown;\n-    bool fGetAddr{false};\n-    int64_t nNextAddrSend GUARDED_BY(cs_sendProcessing){0};\n-    int64_t nNextLocalAddrSend GUARDED_BY(cs_sendProcessing){0};\n+    struct AddrRelay {\n+        CCriticalSection cs_addrsend;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r285335020",
      "id" : 285335020,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4NTMzNTAyMA==",
      "original_commit_id" : "c36939ca2ea636dce8047065d88c2e70bd418405",
      "original_position" : 11,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 239190945,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/285335020",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r285335094"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/285335094"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/15759/commits/c36939ca2ea636dce8047065d88c2e70bd418405\r\n\r\nnit, coult early return before the above lock:\r\n```cpp\r\nif (!_addr.IsValid()) return;\r\nLOCK(m_addr_relay.cs_addrsend);\r\nif (!m_addr_relay.addrKnown.contains(_addr.GetKey())) {\r\n```",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-05-18T09:06:31Z",
      "diff_hunk" : "@@ -812,19 +818,21 @@ class CNode\n \n     void AddAddressKnown(const CAddress& _addr)\n     {\n-        addrKnown.insert(_addr.GetKey());\n+        LOCK(m_addr_relay.cs_addrsend);\n+        m_addr_relay.addrKnown.insert(_addr.GetKey());\n     }\n \n     void PushAddress(const CAddress& _addr, FastRandomContext &insecure_rand)\n     {\n+        LOCK(m_addr_relay.cs_addrsend);\n         // Known checking here is only to save space from duplicates.\n         // SendMessages will filter it again for knowns that were added\n         // after addresses were pushed.\n-        if (_addr.IsValid() && !addrKnown.contains(_addr.GetKey())) {\n-            if (vAddrToSend.size() >= MAX_ADDR_TO_SEND) {\n-                vAddrToSend[insecure_rand.randrange(vAddrToSend.size())] = _addr;\n+        if (_addr.IsValid() && !m_addr_relay.addrKnown.contains(_addr.GetKey())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r285335094",
      "id" : 285335094,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4NTMzNTA5NA==",
      "original_commit_id" : "c36939ca2ea636dce8047065d88c2e70bd418405",
      "original_position" : 43,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 239190945,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/285335094",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r285335134"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/285335134"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/15759/commits/c36939ca2ea636dce8047065d88c2e70bd418405\r\n\r\nnit, could add `{ }`",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-05-18T09:07:59Z",
      "diff_hunk" : "@@ -3551,12 +3559,13 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n                     }\n                 }\n             }\n-            pto->vAddrToSend.clear();\n+            pto->m_addr_relay.vAddrToSend.clear();\n             if (!vAddr.empty())\n                 connman->PushMessage(pto, msgMaker.Make(NetMsgType::ADDR, vAddr));\n             // we only send the big addr message once\n-            if (pto->vAddrToSend.capacity() > 40)\n-                pto->vAddrToSend.shrink_to_fit();\n+            if (pto->m_addr_relay.vAddrToSend.capacity() > 40)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r285335134",
      "id" : 285335134,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4NTMzNTEzNA==",
      "original_commit_id" : "c36939ca2ea636dce8047065d88c2e70bd418405",
      "original_position" : 95,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 239190945,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/285335134",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r285335336"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/285335336"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/15759/commits/5e6e12ef04b640d32d0341a3a1874fde46b0f95e\r\n\r\nInitialize here\r\n```cpp\r\nCRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_tx_inventory){50000, 0.000001};\r\n```\r\nAnd can drop `.reset()` call, `CRollingBloomFilter` constructor already calls it.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-05-18T09:15:07Z",
      "diff_hunk" : "@@ -704,24 +697,44 @@ class CNode\n \n     AddrRelay m_addr_relay;\n \n-    // inventory based relay\n-    CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_inventory);\n-    // Set of transaction ids we still have to announce.\n-    // They are sorted by the mempool before relay, so the order is not important.\n-    std::set<uint256> setInventoryTxToSend;\n     // List of block ids we still have announce.\n     // There is no final sorting before sending, as they are always sent immediately\n     // and in the order requested.\n     std::vector<uint256> vInventoryBlockToSend GUARDED_BY(cs_inventory);\n     CCriticalSection cs_inventory;\n-    int64_t nNextInvSend{0};\n+\n+    struct TxRelay {\n+        mutable CCriticalSection cs_filter;\n+        // We use fRelayTxes for two purposes -\n+        // a) it allows us to not relay tx invs before receiving the peer's version message\n+        // b) the peer may tell us in its version message that we should not relay tx invs\n+        //    unless it loads a bloom filter.\n+        bool fRelayTxes GUARDED_BY(cs_filter){false};\n+        std::unique_ptr<CBloomFilter> pfilter PT_GUARDED_BY(cs_filter);\n+\n+        mutable CCriticalSection cs_tx_inventory;\n+        CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_tx_inventory);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r285335336",
      "id" : 285335336,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4NTMzNTMzNg==",
      "original_commit_id" : "5e6e12ef04b640d32d0341a3a1874fde46b0f95e",
      "original_position" : 42,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 239190945,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/285335336",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.\r\nI'm still trying to understand this more detailed: does that mean that with 2 block-only connection and an assumed 5% black-hole-nodes rate, we only have a 3% chance to succeed? Since we relay, I guess there is no chance we could identify (and thus disconnect) black-hole peers?",
      "created_at" : "2019-05-18T10:12:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-493665389",
      "id" : 493665389,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MzY2NTM4OQ==",
      "updated_at" : "2019-05-18T10:12:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/493665389",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r287884765"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/287884765"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: `m_addr_relay_peer` could be private",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-05-27T21:33:09Z",
      "diff_hunk" : "@@ -691,32 +689,60 @@ class CNode\n     uint256 hashContinue;\n     std::atomic<int> nStartingHeight{-1};\n \n-    // flood relay\n-    std::vector<CAddress> vAddrToSend;\n-    CRollingBloomFilter addrKnown;\n-    bool fGetAddr{false};\n-    std::set<uint256> setKnown;\n-    int64_t nNextAddrSend GUARDED_BY(cs_sendProcessing){0};\n-    int64_t nNextLocalAddrSend GUARDED_BY(cs_sendProcessing){0};\n-\n-    // inventory based relay\n-    CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_inventory);\n-    // Set of transaction ids we still have to announce.\n-    // They are sorted by the mempool before relay, so the order is not important.\n-    std::set<uint256> setInventoryTxToSend;\n+    struct AddrRelay {\n+        CCriticalSection cs_addrsend;\n+        std::vector<CAddress> vAddrToSend GUARDED_BY(cs_addrsend);\n+        CRollingBloomFilter addrKnown GUARDED_BY(cs_addrsend);\n+        bool fGetAddr GUARDED_BY(cs_addrsend){false};\n+        int64_t nNextAddrSend GUARDED_BY(cs_addrsend){0};\n+        int64_t nNextLocalAddrSend GUARDED_BY(cs_addrsend){0};\n+\n+        AddrRelay() : addrKnown(5000, 0.001) {}\n+    };\n+\n+    AddrRelay m_addr_relay;\n+    const bool m_addr_relay_peer;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r287884765",
      "id" : 287884765,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4Nzg4NDc2NQ==",
      "original_commit_id" : "1b90f9cafb575da27bdfa5c61c254e34ad018a20",
      "original_position" : 96,
      "path" : "src/net.h",
      "position" : 123,
      "pull_request_review_id" : 242393097,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/287884765",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r287885999"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/287885999"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```\r\nnet.cpp:2643:9: error: âfRelayTxesâ was not declared in this scope\r\n     if (fRelayTxes && !blocks_only) {\r\n         ^~~~~~~~~~\r\n```\r\nhttps://travis-ci.org/bitcoin/bitcoin/jobs/533781128",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-05-27T21:44:52Z",
      "diff_hunk" : "@@ -2628,8 +2640,10 @@ CNode::CNode(NodeId idIn, ServiceFlags nLocalServicesIn, int nMyStartingHeightIn\n     hSocket = hSocketIn;\n     addrName = addrNameIn == \"\" ? addr.ToStringIPPort() : addrNameIn;\n     hashContinue = uint256();\n-    filterInventoryKnown.reset();\n-    pfilter = MakeUnique<CBloomFilter>();\n+    if (fRelayTxes && !blocks_only) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r287885999",
      "id" : 287885999,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4Nzg4NTk5OQ==",
      "original_commit_id" : "1b90f9cafb575da27bdfa5c61c254e34ad018a20",
      "original_position" : 171,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 242394452,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/287885999",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r288240263"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/288240263"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> And can drop `.reset()` call, `CRollingBloomFilter` constructor already calls it.\r\n\r\nPermalink for convenience: https://github.com/bitcoin/bitcoin/blob/fdc951ad040a9117bc79f12086ce874b4c2aa55a/src/bloom.cpp#L206-L231",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-05-28T18:22:20Z",
      "diff_hunk" : "@@ -704,24 +697,44 @@ class CNode\n \n     AddrRelay m_addr_relay;\n \n-    // inventory based relay\n-    CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_inventory);\n-    // Set of transaction ids we still have to announce.\n-    // They are sorted by the mempool before relay, so the order is not important.\n-    std::set<uint256> setInventoryTxToSend;\n     // List of block ids we still have announce.\n     // There is no final sorting before sending, as they are always sent immediately\n     // and in the order requested.\n     std::vector<uint256> vInventoryBlockToSend GUARDED_BY(cs_inventory);\n     CCriticalSection cs_inventory;\n-    int64_t nNextInvSend{0};\n+\n+    struct TxRelay {\n+        mutable CCriticalSection cs_filter;\n+        // We use fRelayTxes for two purposes -\n+        // a) it allows us to not relay tx invs before receiving the peer's version message\n+        // b) the peer may tell us in its version message that we should not relay tx invs\n+        //    unless it loads a bloom filter.\n+        bool fRelayTxes GUARDED_BY(cs_filter){false};\n+        std::unique_ptr<CBloomFilter> pfilter PT_GUARDED_BY(cs_filter);\n+\n+        mutable CCriticalSection cs_tx_inventory;\n+        CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_tx_inventory);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r288240263",
      "id" : 288240263,
      "in_reply_to_id" : 285335336,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4ODI0MDI2Mw==",
      "original_commit_id" : "5e6e12ef04b640d32d0341a3a1874fde46b0f95e",
      "original_position" : 42,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 242843638,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/288240263",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r288243856"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/288243856"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nit: Would it be appropriate to rename this to `cs_block_inventory` for clarity?",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-05-28T18:30:51Z",
      "diff_hunk" : "@@ -704,24 +697,44 @@ class CNode\n \n     AddrRelay m_addr_relay;\n \n-    // inventory based relay\n-    CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_inventory);\n-    // Set of transaction ids we still have to announce.\n-    // They are sorted by the mempool before relay, so the order is not important.\n-    std::set<uint256> setInventoryTxToSend;\n     // List of block ids we still have announce.\n     // There is no final sorting before sending, as they are always sent immediately\n     // and in the order requested.\n     std::vector<uint256> vInventoryBlockToSend GUARDED_BY(cs_inventory);\n     CCriticalSection cs_inventory;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r288243856",
      "id" : 288243856,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4ODI0Mzg1Ng==",
      "original_commit_id" : "5e6e12ef04b640d32d0341a3a1874fde46b0f95e",
      "original_position" : 29,
      "path" : "src/net.h",
      "position" : 130,
      "pull_request_review_id" : 242848130,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/288243856",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r288259621"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/288259621"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Perhaps this is a C++ quirk I'm not aware of, but I think that `CNode`'s  `fRelayTxes` was moved into `TxRelay` here: https://github.com/bitcoin/bitcoin/pull/15759/commits/5e6e12ef04b640d32d0341a3a1874fde46b0f95e#diff-1a8b9d1ad0a6fda5e751286c73102fc2R712. Perhaps this commit can be dropped as it seems like `blocks_only` does the same thing in the next commit: https://github.com/bitcoin/bitcoin/pull/15759/commits/d7991eb708589203b854aed19222864bca02c9dc#diff-9a82240fe7dfe86564178691cc57f2f1R2639\r\n\r\nRelated: https://github.com/bitcoin/bitcoin/pull/15759/commits/d7991eb708589203b854aed19222864bca02c9dc#r287885999",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-05-28T19:11:45Z",
      "diff_hunk" : "@@ -2632,8 +2632,10 @@ CNode::CNode(NodeId idIn, ServiceFlags nLocalServicesIn, int nMyStartingHeightIn\n     hSocket = hSocketIn;\n     addrName = addrNameIn == \"\" ? addr.ToStringIPPort() : addrNameIn;\n     hashContinue = uint256();\n-    m_tx_relay = MakeUnique<TxRelay>();\n-    m_tx_relay->pfilter = MakeUnique<CBloomFilter>();\n+    if (fRelayTxes) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r288259621",
      "id" : 288259621,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4ODI1OTYyMQ==",
      "original_commit_id" : "7f2ce0a4c5054f8a4061f34968c5928f1f0bbde6",
      "original_position" : 6,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 242848130,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/288259621",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r288270228"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/288270228"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Trying to understand the logic here...\r\n\r\nAccording to the commit description, `bitcoind` will make 2 additional outbound connections, but with this logic, if `connOptions.nMaxOutbound <= 6` then there will be no additional outbound connections: https://www.wolframalpha.com/input/?i=min(2,+max(x-6,+0))\r\n\r\nFrom elsewhere in this commit, it seems like we consider the accounting for `nMaxOutboundBlocksOnly` as separate from that of `nMaxOutbound`, so perhaps just\r\n```\r\n connOptions.nMaxOutboundBlocksOnly = MAX_BLOCKS_ONLY_CONNECTIONS;\r\n```\r\nwould do?",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-05-28T19:40:44Z",
      "diff_hunk" : "@@ -1777,6 +1777,7 @@ bool AppInitMain(InitInterfaces& interfaces)\n     connOptions.nLocalServices = nLocalServices;\n     connOptions.nMaxConnections = nMaxConnections;\n     connOptions.nMaxOutbound = std::min(MAX_OUTBOUND_CONNECTIONS, connOptions.nMaxConnections);\n+    connOptions.nMaxOutboundBlocksOnly = std::min(MAX_BLOCKS_ONLY_CONNECTIONS, std::max(connOptions.nMaxOutbound-6, 0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r288270228",
      "id" : 288270228,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4ODI3MDIyOA==",
      "original_commit_id" : "d7991eb708589203b854aed19222864bca02c9dc",
      "original_position" : 4,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 242848130,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/288270228",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r288281529"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/288281529"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nit: Perhaps we should add documentation that `m_tx_relay == nullptr` means that the `CNode` is `blocks_only`, and `!pnode->fInbound && (pnode->m_tx_relay == nullptr)` is how we check if a `CNode` is outbound-blocks-only or not.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-05-28T20:11:22Z",
      "diff_hunk" : "@@ -704,24 +697,44 @@ class CNode\n \n     AddrRelay m_addr_relay;\n \n-    // inventory based relay\n-    CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_inventory);\n-    // Set of transaction ids we still have to announce.\n-    // They are sorted by the mempool before relay, so the order is not important.\n-    std::set<uint256> setInventoryTxToSend;\n     // List of block ids we still have announce.\n     // There is no final sorting before sending, as they are always sent immediately\n     // and in the order requested.\n     std::vector<uint256> vInventoryBlockToSend GUARDED_BY(cs_inventory);\n     CCriticalSection cs_inventory;\n-    int64_t nNextInvSend{0};\n+\n+    struct TxRelay {\n+        mutable CCriticalSection cs_filter;\n+        // We use fRelayTxes for two purposes -\n+        // a) it allows us to not relay tx invs before receiving the peer's version message\n+        // b) the peer may tell us in its version message that we should not relay tx invs\n+        //    unless it loads a bloom filter.\n+        bool fRelayTxes GUARDED_BY(cs_filter){false};\n+        std::unique_ptr<CBloomFilter> pfilter PT_GUARDED_BY(cs_filter);\n+\n+        mutable CCriticalSection cs_tx_inventory;\n+        CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_tx_inventory);\n+        // Set of transaction ids we still have to announce.\n+        // They are sorted by the mempool before relay, so the order is not important.\n+        std::set<uint256> setInventoryTxToSend;\n+        // Used for BIP35 mempool sending\n+        bool fSendMempool GUARDED_BY(cs_tx_inventory){false};\n+        // Last time a \"MEMPOOL\" request was serviced.\n+        std::atomic<int64_t> timeLastMempoolReq{0};\n+        int64_t nNextInvSend{0};\n+\n+        CCriticalSection cs_feeFilter;\n+        // Minimum fee rate with which to filter inv's to this node\n+        CAmount minFeeFilter GUARDED_BY(cs_feeFilter){0};\n+        CAmount lastSentFeeFilter{0};\n+        int64_t nextSendTimeFeeFilter{0};\n+\n+        TxRelay() : filterInventoryKnown(50000, 0.000001) { filterInventoryKnown.reset(); }\n+    };\n+\n+    TxRelay m_tx_relay;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r288281529",
      "id" : 288281529,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4ODI4MTUyOQ==",
      "original_commit_id" : "5e6e12ef04b640d32d0341a3a1874fde46b0f95e",
      "original_position" : 61,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 242848130,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/288281529",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r288284902"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/288284902"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nit: Perhaps this is a good opportunity to rename `nMaxOutbound` to something more precise... As it's easy to think that:\r\n\r\n1. `nMaxOutbound` bounds `nOutbound` in `CConnman::ThreadOpenConnections(const std::vector<std::string>)`\r\n1.  `nMaxOutbound` includes `nMaxOutboundBlocksOnly` added below\r\n\r\nBoth of which are untrue as far as I can tell.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-05-28T20:20:08Z",
      "diff_hunk" : "@@ -1777,6 +1777,7 @@ bool AppInitMain(InitInterfaces& interfaces)\n     connOptions.nLocalServices = nLocalServices;\n     connOptions.nMaxConnections = nMaxConnections;\n     connOptions.nMaxOutbound = std::min(MAX_OUTBOUND_CONNECTIONS, connOptions.nMaxConnections);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r288284902",
      "id" : 288284902,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4ODI4NDkwMg==",
      "original_commit_id" : "d7991eb708589203b854aed19222864bca02c9dc",
      "original_position" : 3,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 242848130,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/288284902",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r290017411"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/290017411"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This `- 6` is a little confusing and requires that you look up the default value of `connOptions.nMaxOutbound` to understand what this is doing. Also echoing @dongcarl comments that this doesn't work well when `connOptions.nMaxOutbound <= 6`.\r\n\r\n\r\nGiven that this fails for particular values and you only want 2 block only outbound why not change this to:\r\n\r\n```\r\nconnOptions.nMaxOutboundBlocksOnly = MAX_BLOCKS_ONLY_CONNECTIONS\r\n```",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-06-03T20:14:45Z",
      "diff_hunk" : "@@ -1777,6 +1777,7 @@ bool AppInitMain(InitInterfaces& interfaces)\n     connOptions.nLocalServices = nLocalServices;\n     connOptions.nMaxConnections = nMaxConnections;\n     connOptions.nMaxOutbound = std::min(MAX_OUTBOUND_CONNECTIONS, connOptions.nMaxConnections);\n+    connOptions.nMaxOutboundBlocksOnly = std::min(MAX_BLOCKS_ONLY_CONNECTIONS, std::max(connOptions.nMaxOutbound-6, 0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r290017411",
      "id" : 290017411,
      "in_reply_to_id" : 288270228,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MDAxNzQxMQ==",
      "original_commit_id" : "d7991eb708589203b854aed19222864bca02c9dc",
      "original_position" : 4,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 245100437,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/290017411",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/274814?v=4",
         "events_url" : "https://api.github.com/users/EthanHeilman/events{/privacy}",
         "followers_url" : "https://api.github.com/users/EthanHeilman/followers",
         "following_url" : "https://api.github.com/users/EthanHeilman/following{/other_user}",
         "gists_url" : "https://api.github.com/users/EthanHeilman/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/EthanHeilman",
         "id" : 274814,
         "login" : "EthanHeilman",
         "node_id" : "MDQ6VXNlcjI3NDgxNA==",
         "organizations_url" : "https://api.github.com/users/EthanHeilman/orgs",
         "received_events_url" : "https://api.github.com/users/EthanHeilman/received_events",
         "repos_url" : "https://api.github.com/users/EthanHeilman/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/EthanHeilman/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/EthanHeilman/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/EthanHeilman"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r290656339"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/290656339"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think one issue is that I wasn't sure how to do the `GUARDED_BY` annotations with a variable that didn't live in the class.  But also I thought it might make sense to explicitly lock things in this class with its own mutex, as that seems like a clearer design for making this code modular. \r\n\r\nThe reason I included this refactor commit at all was in preparation for being able to optionally not instantiate this data structure, if there was concern about minimizing resource utilization as much as possible for these additional `blocksonly` connections.  Since I ended up not doing that (I believe I concluded that it probably wasn't all that much additional memory?), I could also drop this commit instead.  ",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-06-05T09:37:08Z",
      "diff_hunk" : "@@ -691,12 +691,18 @@ class CNode\n     uint256 hashContinue;\n     std::atomic<int> nStartingHeight{-1};\n \n-    // flood relay\n-    std::vector<CAddress> vAddrToSend;\n-    CRollingBloomFilter addrKnown;\n-    bool fGetAddr{false};\n-    int64_t nNextAddrSend GUARDED_BY(cs_sendProcessing){0};\n-    int64_t nNextLocalAddrSend GUARDED_BY(cs_sendProcessing){0};\n+    struct AddrRelay {\n+        CCriticalSection cs_addrsend;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r290656339",
      "id" : 290656339,
      "in_reply_to_id" : 285335020,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MDY1NjMzOQ==",
      "original_commit_id" : "c36939ca2ea636dce8047065d88c2e70bd418405",
      "original_position" : 11,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 245901643,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/290656339",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r290741464"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/290741464"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps the accounting logic should be improved to be clearer, but I believe the behavior here is at least (roughly) correct. The way this works is that if a user sets `-maxconnections` very low, that will be a hard limit on the number of inbound, outbound and outbound-blocks-only connections.  Before this PR, it would take the user setting their max connections value to less than 8 to change the number of outbound connections we make (we first reduce all the inbound we take and only then reduce the outbound).\r\n\r\nThis PR adds new blocks-only connections and preferences those connections over regular outbound connections (whenever we make an outbound connection, we check to see if we are below our blocks-only target, and if so we initiate the connection as blocks-only).  As a result, I thought it didn't make sense to have any blocks-only links if we have too few regular outbound connections, because I don't think it makes sense to have blocks-only links at the expense of transaction relay.\r\n\r\nIn particular, the problem with the suggestion of just setting nMaxOutboundBlocksOnly to 2 is that if the user passes `-maxconnections=2`, then they'll only have 2 blocksonly peers and won't receive any transactions.\r\n\r\nSo I believe the way I implemented things here is that we try to reserve 6 connections as regular outbound, and then if we add additional connections we will have those be blocks-only until we get to 2, and then any further connections are regular outbounds up to 8, and then finally any additional ones are used for feelers and inbounds.\r\n\r\nOf course we could change this to be more conservative and only allocate blocks-only connections if we have all 8 regular outbounds.  However I don't think we should be less conservative and risk having fewer regular outbounds.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-06-05T13:37:37Z",
      "diff_hunk" : "@@ -1777,6 +1777,7 @@ bool AppInitMain(InitInterfaces& interfaces)\n     connOptions.nLocalServices = nLocalServices;\n     connOptions.nMaxConnections = nMaxConnections;\n     connOptions.nMaxOutbound = std::min(MAX_OUTBOUND_CONNECTIONS, connOptions.nMaxConnections);\n+    connOptions.nMaxOutboundBlocksOnly = std::min(MAX_BLOCKS_ONLY_CONNECTIONS, std::max(connOptions.nMaxOutbound-6, 0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r290741464",
      "id" : 290741464,
      "in_reply_to_id" : 288270228,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MDc0MTQ2NA==",
      "original_commit_id" : "d7991eb708589203b854aed19222864bca02c9dc",
      "original_position" : 4,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 246010467,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/290741464",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r290790171"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/290790171"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, fixed.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-06-05T15:09:07Z",
      "diff_hunk" : "@@ -691,12 +691,18 @@ class CNode\n     uint256 hashContinue;\n     std::atomic<int> nStartingHeight{-1};\n \n-    // flood relay\n-    std::vector<CAddress> vAddrToSend;\n-    CRollingBloomFilter addrKnown;\n-    bool fGetAddr{false};\n-    int64_t nNextAddrSend GUARDED_BY(cs_sendProcessing){0};\n-    int64_t nNextLocalAddrSend GUARDED_BY(cs_sendProcessing){0};\n+    struct AddrRelay {\n+        CCriticalSection cs_addrsend;\n+        std::vector<CAddress> vAddrToSend GUARDED_BY(cs_addrsend);\n+        CRollingBloomFilter addrKnown GUARDED_BY(cs_addrsend);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r290790171",
      "id" : 290790171,
      "in_reply_to_id" : 285334943,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MDc5MDE3MQ==",
      "original_commit_id" : "c36939ca2ea636dce8047065d88c2e70bd418405",
      "original_position" : 13,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 246072333,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/290790171",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r290790487"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/290790487"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-06-05T15:09:42Z",
      "diff_hunk" : "@@ -812,19 +818,21 @@ class CNode\n \n     void AddAddressKnown(const CAddress& _addr)\n     {\n-        addrKnown.insert(_addr.GetKey());\n+        LOCK(m_addr_relay.cs_addrsend);\n+        m_addr_relay.addrKnown.insert(_addr.GetKey());\n     }\n \n     void PushAddress(const CAddress& _addr, FastRandomContext &insecure_rand)\n     {\n+        LOCK(m_addr_relay.cs_addrsend);\n         // Known checking here is only to save space from duplicates.\n         // SendMessages will filter it again for knowns that were added\n         // after addresses were pushed.\n-        if (_addr.IsValid() && !addrKnown.contains(_addr.GetKey())) {\n-            if (vAddrToSend.size() >= MAX_ADDR_TO_SEND) {\n-                vAddrToSend[insecure_rand.randrange(vAddrToSend.size())] = _addr;\n+        if (_addr.IsValid() && !m_addr_relay.addrKnown.contains(_addr.GetKey())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r290790487",
      "id" : 290790487,
      "in_reply_to_id" : 285335094,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MDc5MDQ4Nw==",
      "original_commit_id" : "c36939ca2ea636dce8047065d88c2e70bd418405",
      "original_position" : 43,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 246072700,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/290790487",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r290790630"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/290790630"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-06-05T15:09:59Z",
      "diff_hunk" : "@@ -3551,12 +3559,13 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n                     }\n                 }\n             }\n-            pto->vAddrToSend.clear();\n+            pto->m_addr_relay.vAddrToSend.clear();\n             if (!vAddr.empty())\n                 connman->PushMessage(pto, msgMaker.Make(NetMsgType::ADDR, vAddr));\n             // we only send the big addr message once\n-            if (pto->vAddrToSend.capacity() > 40)\n-                pto->vAddrToSend.shrink_to_fit();\n+            if (pto->m_addr_relay.vAddrToSend.capacity() > 40)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r290790630",
      "id" : 290790630,
      "in_reply_to_id" : 285335134,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MDc5MDYzMA==",
      "original_commit_id" : "c36939ca2ea636dce8047065d88c2e70bd418405",
      "original_position" : 95,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 246072904,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/290790630",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r290791077"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/290791077"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, done.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-06-05T15:10:45Z",
      "diff_hunk" : "@@ -704,24 +697,44 @@ class CNode\n \n     AddrRelay m_addr_relay;\n \n-    // inventory based relay\n-    CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_inventory);\n-    // Set of transaction ids we still have to announce.\n-    // They are sorted by the mempool before relay, so the order is not important.\n-    std::set<uint256> setInventoryTxToSend;\n     // List of block ids we still have announce.\n     // There is no final sorting before sending, as they are always sent immediately\n     // and in the order requested.\n     std::vector<uint256> vInventoryBlockToSend GUARDED_BY(cs_inventory);\n     CCriticalSection cs_inventory;\n-    int64_t nNextInvSend{0};\n+\n+    struct TxRelay {\n+        mutable CCriticalSection cs_filter;\n+        // We use fRelayTxes for two purposes -\n+        // a) it allows us to not relay tx invs before receiving the peer's version message\n+        // b) the peer may tell us in its version message that we should not relay tx invs\n+        //    unless it loads a bloom filter.\n+        bool fRelayTxes GUARDED_BY(cs_filter){false};\n+        std::unique_ptr<CBloomFilter> pfilter PT_GUARDED_BY(cs_filter);\n+\n+        mutable CCriticalSection cs_tx_inventory;\n+        CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_tx_inventory);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r290791077",
      "id" : 290791077,
      "in_reply_to_id" : 285335336,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MDc5MTA3Nw==",
      "original_commit_id" : "5e6e12ef04b640d32d0341a3a1874fde46b0f95e",
      "original_position" : 42,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 246073445,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/290791077",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r290791177"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/290791177"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Meh, going to leave this as-is.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-06-05T15:10:53Z",
      "diff_hunk" : "@@ -691,32 +689,60 @@ class CNode\n     uint256 hashContinue;\n     std::atomic<int> nStartingHeight{-1};\n \n-    // flood relay\n-    std::vector<CAddress> vAddrToSend;\n-    CRollingBloomFilter addrKnown;\n-    bool fGetAddr{false};\n-    std::set<uint256> setKnown;\n-    int64_t nNextAddrSend GUARDED_BY(cs_sendProcessing){0};\n-    int64_t nNextLocalAddrSend GUARDED_BY(cs_sendProcessing){0};\n-\n-    // inventory based relay\n-    CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_inventory);\n-    // Set of transaction ids we still have to announce.\n-    // They are sorted by the mempool before relay, so the order is not important.\n-    std::set<uint256> setInventoryTxToSend;\n+    struct AddrRelay {\n+        CCriticalSection cs_addrsend;\n+        std::vector<CAddress> vAddrToSend GUARDED_BY(cs_addrsend);\n+        CRollingBloomFilter addrKnown GUARDED_BY(cs_addrsend);\n+        bool fGetAddr GUARDED_BY(cs_addrsend){false};\n+        int64_t nNextAddrSend GUARDED_BY(cs_addrsend){0};\n+        int64_t nNextLocalAddrSend GUARDED_BY(cs_addrsend){0};\n+\n+        AddrRelay() : addrKnown(5000, 0.001) {}\n+    };\n+\n+    AddrRelay m_addr_relay;\n+    const bool m_addr_relay_peer;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r290791177",
      "id" : 290791177,
      "in_reply_to_id" : 287884765,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MDc5MTE3Nw==",
      "original_commit_id" : "1b90f9cafb575da27bdfa5c61c254e34ad018a20",
      "original_position" : 96,
      "path" : "src/net.h",
      "position" : 123,
      "pull_request_review_id" : 246073557,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/290791177",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r290791242"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/290791242"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, fixed now.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-06-05T15:10:59Z",
      "diff_hunk" : "@@ -2628,8 +2640,10 @@ CNode::CNode(NodeId idIn, ServiceFlags nLocalServicesIn, int nMyStartingHeightIn\n     hSocket = hSocketIn;\n     addrName = addrNameIn == \"\" ? addr.ToStringIPPort() : addrNameIn;\n     hashContinue = uint256();\n-    filterInventoryKnown.reset();\n-    pfilter = MakeUnique<CBloomFilter>();\n+    if (fRelayTxes && !blocks_only) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r290791242",
      "id" : 290791242,
      "in_reply_to_id" : 287885999,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MDc5MTI0Mg==",
      "original_commit_id" : "1b90f9cafb575da27bdfa5c61c254e34ad018a20",
      "original_position" : 171,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 246073635,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/290791242",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r290791378"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/290791378"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I suppose but I'm going to leave this for now, this diff is already getting big.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-06-05T15:11:15Z",
      "diff_hunk" : "@@ -704,24 +697,44 @@ class CNode\n \n     AddrRelay m_addr_relay;\n \n-    // inventory based relay\n-    CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_inventory);\n-    // Set of transaction ids we still have to announce.\n-    // They are sorted by the mempool before relay, so the order is not important.\n-    std::set<uint256> setInventoryTxToSend;\n     // List of block ids we still have announce.\n     // There is no final sorting before sending, as they are always sent immediately\n     // and in the order requested.\n     std::vector<uint256> vInventoryBlockToSend GUARDED_BY(cs_inventory);\n     CCriticalSection cs_inventory;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r290791378",
      "id" : 290791378,
      "in_reply_to_id" : 288243856,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MDc5MTM3OA==",
      "original_commit_id" : "5e6e12ef04b640d32d0341a3a1874fde46b0f95e",
      "original_position" : 29,
      "path" : "src/net.h",
      "position" : 130,
      "pull_request_review_id" : 246073829,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/290791378",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r290792809"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/290792809"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This was just a mistake when I rebased after the global `fRelayTxes` got renamed.  Fixed now -- I actually ended up dropping the commit where I made `-blocksonly` mode run without the transaction relay data structures.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-06-05T15:13:49Z",
      "diff_hunk" : "@@ -2632,8 +2632,10 @@ CNode::CNode(NodeId idIn, ServiceFlags nLocalServicesIn, int nMyStartingHeightIn\n     hSocket = hSocketIn;\n     addrName = addrNameIn == \"\" ? addr.ToStringIPPort() : addrNameIn;\n     hashContinue = uint256();\n-    m_tx_relay = MakeUnique<TxRelay>();\n-    m_tx_relay->pfilter = MakeUnique<CBloomFilter>();\n+    if (fRelayTxes) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r290792809",
      "id" : 290792809,
      "in_reply_to_id" : 288259621,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MDc5MjgwOQ==",
      "original_commit_id" : "7f2ce0a4c5054f8a4061f34968c5928f1f0bbde6",
      "original_position" : 6,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 246075628,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/290792809",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r290793432"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/290793432"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added a comment explaining the `== nullptr`.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-06-05T15:15:02Z",
      "diff_hunk" : "@@ -704,24 +697,44 @@ class CNode\n \n     AddrRelay m_addr_relay;\n \n-    // inventory based relay\n-    CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_inventory);\n-    // Set of transaction ids we still have to announce.\n-    // They are sorted by the mempool before relay, so the order is not important.\n-    std::set<uint256> setInventoryTxToSend;\n     // List of block ids we still have announce.\n     // There is no final sorting before sending, as they are always sent immediately\n     // and in the order requested.\n     std::vector<uint256> vInventoryBlockToSend GUARDED_BY(cs_inventory);\n     CCriticalSection cs_inventory;\n-    int64_t nNextInvSend{0};\n+\n+    struct TxRelay {\n+        mutable CCriticalSection cs_filter;\n+        // We use fRelayTxes for two purposes -\n+        // a) it allows us to not relay tx invs before receiving the peer's version message\n+        // b) the peer may tell us in its version message that we should not relay tx invs\n+        //    unless it loads a bloom filter.\n+        bool fRelayTxes GUARDED_BY(cs_filter){false};\n+        std::unique_ptr<CBloomFilter> pfilter PT_GUARDED_BY(cs_filter);\n+\n+        mutable CCriticalSection cs_tx_inventory;\n+        CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_tx_inventory);\n+        // Set of transaction ids we still have to announce.\n+        // They are sorted by the mempool before relay, so the order is not important.\n+        std::set<uint256> setInventoryTxToSend;\n+        // Used for BIP35 mempool sending\n+        bool fSendMempool GUARDED_BY(cs_tx_inventory){false};\n+        // Last time a \"MEMPOOL\" request was serviced.\n+        std::atomic<int64_t> timeLastMempoolReq{0};\n+        int64_t nNextInvSend{0};\n+\n+        CCriticalSection cs_feeFilter;\n+        // Minimum fee rate with which to filter inv's to this node\n+        CAmount minFeeFilter GUARDED_BY(cs_feeFilter){0};\n+        CAmount lastSentFeeFilter{0};\n+        int64_t nextSendTimeFeeFilter{0};\n+\n+        TxRelay() : filterInventoryKnown(50000, 0.000001) { filterInventoryKnown.reset(); }\n+    };\n+\n+    TxRelay m_tx_relay;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r290793432",
      "id" : 290793432,
      "in_reply_to_id" : 288281529,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MDc5MzQzMg==",
      "original_commit_id" : "5e6e12ef04b640d32d0341a3a1874fde46b0f95e",
      "original_position" : 61,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 246076453,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/290793432",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased and addressed review comments.",
      "created_at" : "2019-06-05T15:15:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-499127658",
      "id" : 499127658,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5OTEyNzY1OA==",
      "updated_at" : "2019-06-05T15:15:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/499127658",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r292468475"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292468475"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks for the explanation, I'll review again with that in mind.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-06-11T13:55:49Z",
      "diff_hunk" : "@@ -691,12 +691,18 @@ class CNode\n     uint256 hashContinue;\n     std::atomic<int> nStartingHeight{-1};\n \n-    // flood relay\n-    std::vector<CAddress> vAddrToSend;\n-    CRollingBloomFilter addrKnown;\n-    bool fGetAddr{false};\n-    int64_t nNextAddrSend GUARDED_BY(cs_sendProcessing){0};\n-    int64_t nNextLocalAddrSend GUARDED_BY(cs_sendProcessing){0};\n+    struct AddrRelay {\n+        CCriticalSection cs_addrsend;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r292468475",
      "id" : 292468475,
      "in_reply_to_id" : 285335020,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MjQ2ODQ3NQ==",
      "original_commit_id" : "c36939ca2ea636dce8047065d88c2e70bd418405",
      "original_position" : 11,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 248193047,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292468475",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I'm still trying to understand this more detailed: does that mean that with 2 block-only connection and an assumed 5% black-hole-nodes rate, we only have a 3% chance to succeed? Since we relay, I guess there is no chance we could identify (and thus disconnect) black-hole peers?\r\n\r\n@jonasschnelli With 2 blocks-only connections, and if we assume 5% of nodes are useless black holes, then my simulation suggests we have a 3% chance of the network graph being connected by _only_ the blocks-only connections.  For additional robustness, we will want to add more blocks-only connections in the future -- but for resource utilization reasons I don't want to do that until we add better support at the p2p protocol layer for establishing these connections.\r\n\r\nNote that we are still going to relay blocks on the existing 8 outbound connections, so this PR is purely additive robustness, at the cost of a little more resource utilization.  We now will have 10 outbound peers, rather than 8, which are able to provide blocks to us.  (We just aren't going to do tx relay on the two additional connections.)\r\n\r\nOne issue I'd like to flag for reviewers is how these new blocksonly peers interact with outbound peer disconnection (introduced in #11560 and #11490).  I believe I've implemented this so that the new blocksonly peers will not be subject to other forms of disconnection, because non-tx-relay outbounds are excluded from being outbound disconnection candidates.  However, it's worth verifying the implementation is correct and worth thinking about whether this behavior is the best choice.\r\n",
      "created_at" : "2019-06-11T19:58:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-500999863",
      "id" : 500999863,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwMDk5OTg2Mw==",
      "updated_at" : "2019-06-11T19:58:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/500999863",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I think that this should be correct code in case someone wants to set it up to tabulate against Suhas's simulation.\r\n\r\nEdit: I've rewritten it to be much much better. Scipy is so cool!\r\n```python\r\n import random\r\n import copy\r\n import scipy\r\n import scipy.sparse\r\n import scipy.linalg\r\n import numpy as np\r\n \r\n N = 1000\r\n def biased_coin(bias):\r\n     return random.random() <= bias\r\n def make_graph(n_outbound, p_blackhole, n_total = N):\r\n     graph = np.zeros((n_total, n_total))\r\n     for i in range(n_total):\r\n         if not biased_coin(p_blackhole):\r\n             for j in range(n_outbound):\r\n                 graph[i][j] = 1\r\n             # rejection sample no self-edges\r\n             while True:\r\n                 np.random.shuffle(graph[i])\r\n                 if not graph[i][i]:\r\n                     break\r\n     return graph\r\n \r\ndef is_connected(graph):\r\n      return scipy.sparse.csgraph.connected_components(graph, directed=True, return_labels=False) == 1\r\n\r\n print(sum(is_connected(make_graph(8, 0.05, 1000)) for x in range(100)))\r\n```\r\n\r\nMy results were, for 100 samples, 92. This suggests Suhas's simulation was not correct.\r\n\r\nedit: Nevermind, Suhas's simulation was on n=10,000. will re-run",
      "created_at" : "2019-06-11T21:07:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-501023367",
      "id" : 501023367,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwMTAyMzM2Nw==",
      "updated_at" : "2019-06-11T21:48:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/501023367",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Improved the code for the above sim, in case anyone's following by email-only.",
      "created_at" : "2019-06-11T21:53:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-501037514",
      "id" : 501037514,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwMTAzNzUxNA==",
      "updated_at" : "2019-06-11T21:53:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/501037514",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Deep apologies for the noise; I missed Suhas's earlier note about the connectivity of the _non black hole nodes_, not the total connectivity. The below should work for that.\r\n\r\n```python\r\nimport random\r\n import copy\r\n import scipy\r\n import scipy.sparse\r\n import scipy.linalg\r\n import numpy as np\r\n \r\n N = 1000\r\n def biased_coin(bias):\r\n     return random.random() <= bias\r\n def make_graph(n_outbound, p_blackhole, n_total = N):\r\n     graph = np.zeros((n_total, n_total))\r\n     count = 0\r\n     for i in range(n_total):\r\n         if not biased_coin(p_blackhole):\r\n             count += 1\r\n             for j in range(n_outbound):\r\n                 graph[i][j] = 1\r\n             # rejection sample no self-edges\r\n             while True:\r\n                 np.random.shuffle(graph[i])\r\n                 if not graph[i][i]:\r\n                     break\r\n     return (graph,count)\r\n \r\n def is_connected(graph, count):\r\n     first_non_blackhole = None\r\n     for (i,row) in enumerate(graph):\r\n         if any(r != 0 for r in row):\r\n             first_non_blackhole = i\r\n             break\r\n     if first_non_blackhole is None:\r\n         return False\r\n     n, labels = scipy.sparse.csgraph.connected_components(graph, directed=True, return_labels=True)\r\n     label = labels[first_non_blackhole]\r\n     size = sum(l == label  for l in labels)\r\n     return size >= count\r\n \r\n \r\n \r\n print(sum(is_connected(*make_graph(8,0.05,10000)) for _ in range(10)))\r\n```",
      "created_at" : "2019-06-11T22:16:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-501043818",
      "id" : 501043818,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwMTA0MzgxOA==",
      "updated_at" : "2019-06-11T22:30:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/501043818",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r292686307"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292686307"
         }
      },
      "author_association" : "MEMBER",
      "body" : "bacfdab\r\n\r\nnit, could fix indentation and keep braces?",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-06-11T22:34:52Z",
      "diff_hunk" : "@@ -3551,33 +3551,32 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n         // Message: addr\n         //\n         if (pto->IsAddrRelayPeer()) {\n-        LOCK(pto->m_addr_relay.cs_addrsend);\n-        if (pto->m_addr_relay.nNextAddrSend < nNow) {\n-            pto->m_addr_relay.nNextAddrSend = PoissonNextSend(nNow, AVG_ADDRESS_BROADCAST_INTERVAL);\n-            std::vector<CAddress> vAddr;\n-            vAddr.reserve(pto->m_addr_relay.vAddrToSend.size());\n-            for (const CAddress& addr : pto->m_addr_relay.vAddrToSend)\n-            {\n-                if (!pto->m_addr_relay.addrKnown.contains(addr.GetKey()))\n+            LOCK(pto->m_addr_relay.cs_addrsend);\n+            if (pto->m_addr_relay.nNextAddrSend < nNow) {\n+                pto->m_addr_relay.nNextAddrSend = PoissonNextSend(nNow, AVG_ADDRESS_BROADCAST_INTERVAL);\n+                std::vector<CAddress> vAddr;\n+                vAddr.reserve(pto->m_addr_relay.vAddrToSend.size());\n+                for (const CAddress& addr : pto->m_addr_relay.vAddrToSend)\n                 {\n-                    pto->m_addr_relay.addrKnown.insert(addr.GetKey());\n-                    vAddr.push_back(addr);\n-                    // receiver rejects addr messages larger than 1000\n-                    if (vAddr.size() >= 1000)\n+                    if (!pto->m_addr_relay.addrKnown.contains(addr.GetKey()))\n                     {\n-                        connman->PushMessage(pto, msgMaker.Make(NetMsgType::ADDR, vAddr));\n-                        vAddr.clear();\n+                        pto->m_addr_relay.addrKnown.insert(addr.GetKey());\n+                        vAddr.push_back(addr);\n+                        // receiver rejects addr messages larger than 1000\n+                        if (vAddr.size() >= 1000)\n+                        {\n+                            connman->PushMessage(pto, msgMaker.Make(NetMsgType::ADDR, vAddr));\n+                            vAddr.clear();\n+                        }\n                     }\n                 }\n+                pto->m_addr_relay.vAddrToSend.clear();\n+                if (!vAddr.empty())\n+                    connman->PushMessage(pto, msgMaker.Make(NetMsgType::ADDR, vAddr));\n+                // we only send the big addr message once\n+                if (pto->m_addr_relay.vAddrToSend.capacity() > 40)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r292686307",
      "id" : 292686307,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MjY4NjMwNw==",
      "original_commit_id" : "bacfdab463970c93497624a4dfa0ad8f0b9c3b29",
      "original_position" : 41,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 248471479,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292686307",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "The earlier versions have some issues with the scipy connected_components API (their documentation of the definition of 'weak' connected was incorrect, since been patched)\r\n\r\nAfter some back and forth offline with @sdaftuar, we're on the same page that the below simulation should be an accurate model for the scenario. Suhas and I have spot checked it (with 100 samples) for a few of the k, p, N=10000 and verified it confirms Suhas's earlier results (I checked k = 2, p = 0.05 and k = 4, p = 0.2).\r\n\r\n```python\r\nimport scipy\r\nimport scipy.sparse\r\nimport numpy as np\r\nfrom matplotlib import pyplot as plt\r\n\r\ndef make_graph(n_outbound, p_blackhole, n_total):\r\n    assert(n_outbound < n_total)\r\n    # Flip n coins, with P(honest_peer[i] == True) = 1-p_blackhole\r\n    honest_peer = np.random.random(n_total) >= p_blackhole\r\n    graph = np.zeros((n_total, n_total), dtype=bool)\r\n    for i in range(n_total):\r\n        if not honest_peer[i]:\r\n            continue\r\n        # set n_outbound peers connected\r\n        for j in range(n_outbound):\r\n            graph[i][j] = True\r\n        # shuffle the peers\r\n        np.random.shuffle(graph[i])\r\n        # rejection sample so no self-edges exist\r\n        while graph[i][i]:\r\n            np.random.shuffle(graph[i])\r\n        # Prune all connections to hole nodes for analysis\r\n        for j in range(n_total):\r\n            if graph[i][j] and not honest_peer[j]:\r\n                graph[i][j] = False\r\n    return (graph, honest_peer)\r\n\r\ndef is_connected(graph, honest_peer):\r\n    try:\r\n        first_non_blackhole = np.argwhere(honest_peer)[0][0]\r\n    except IndexError:\r\n        # No Honest Peers\r\n        return False\r\n    # We use weak connections to imply transitivity of links\r\n    n, labels = scipy.sparse.csgraph.connected_components(graph, directed=True, return_labels=True, connection=\"weak\")\r\n\r\n    # Check that all honest peers are connected\r\n    label = labels[first_non_blackhole]\r\n    component_count = np.sum(np.logical_and((label == labels), honest_peer))\r\n    honest_count = np.sum(honest_peer)\r\n    return component_count == honest_count\r\n\r\n\r\n# Draws the nodes on a circle and the edges between them\r\ndef draw_graph(g, honest_peer):\r\n    n = len(g)\r\n    # Add one extra point and then remove it to not overlap\r\n    y = np.sin(np.linspace(0, 2*3.1415, n+1))[:n]\r\n    x = np.cos(np.linspace(0, 2*3.1415, n+1))[:n]\r\n\r\n    # Plot arrows\r\n    for i, col in enumerate(g):\r\n        for j, connected in enumerate(col):\r\n            if connected == 1:\r\n                plt.arrow(x[i], y[i], x[j]-x[i], y[j]-y[i], head_width= 0.0025)\r\n    # Plot blackholes\r\n    x_black = [x[j] for j in range(n) if not honest_peer[j]]\r\n    y_black = [y[j] for j in range(n) if not honest_peer[j]]\r\n    plt.scatter(x_black,y_black, color='b')\r\n    # Plot Honest Peers\r\n    x_red = [x[j] for j in range(n) if  honest_peer[j]]\r\n    y_red = [y[j] for j in range(n) if  honest_peer[j]]\r\n    plt.scatter(x_red,y_red, color='r')\r\n    plt.show()\r\n\r\ndef sim(x):\r\n    # We must reseed for each fork...\r\n    scipy.random.seed()\r\n    return is_connected(*make_graph(2, 0.05, 10000))\r\nif __name__ == \"__main__\":\r\n    from multiprocessing import Pool\r\n    p = Pool(16)\r\n    r = p.map(sim, range(100))\r\n    print(sum(r))\r\n```\r\n\r\nWe can keep this code around as reference because it's useful to simulate other networks. I also added some code to visualize (small!) networks (~100 nodes looks fine for me), which is useful to visually inspect some low N examples. The models can also be simulated in parallel to speed things up, just adjust the number of cores for your system.",
      "created_at" : "2019-06-18T04:32:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-502942775",
      "id" : 502942775,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwMjk0Mjc3NQ==",
      "updated_at" : "2019-06-18T04:32:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/502942775",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I ran the sim with 16 samples per param group. With a small sample size, there's some variance/loss of precision, but it seems in line. results below:\r\n\r\n```\r\nk = 2, p = 0%, 100%\r\nk = 2, p = 5%, 0%\r\nk = 4, p = 0%, 100%\r\nk = 4, p = 5%, 100%\r\nk = 4, p = 10%, 100%\r\nk = 4, p = 15%, 93%\r\nk = 4, p = 20%, 37%\r\nk = 4, p = 25%, 37%\r\nk = 4, p = 30%, 6%\r\nk = 4, p = 35%, 0%\r\nk = 6, p = 0%, 100%\r\nk = 6, p = 5%, 100%\r\nk = 6, p = 10%, 100%\r\nk = 6, p = 15%, 100%\r\nk = 6, p = 20%, 100%\r\nk = 6, p = 25%, 93%\r\nk = 6, p = 30%, 68%\r\nk = 6, p = 35%, 93%\r\nk = 8, p = 0%, 100%\r\nk = 8, p = 5%, 100%\r\nk = 8, p = 10%, 100%\r\nk = 8, p = 15%, 100%\r\nk = 8, p = 20%, 100%\r\nk = 8, p = 25%, 100%\r\nk = 8, p = 30%, 100%\r\nk = 8, p = 35%, 100%\r\n```\r\nif you care to run it yourself, with a full 1000 samples:\r\n```python\r\n def sim(k,p):\r\n     # We must reseed for each fork...\r\n     scipy.random.seed()\r\n     return is_connected(*make_graph(k, p, 10000))\r\n if __name__ == \"__main__\":\r\n     from multiprocessing import Pool\r\n     pool = Pool(16)\r\n     for y in range(1,5):\r\n         for x in range(8):\r\n             p = x*0.05\r\n             k = y*2\r\n             r = pool.starmap(sim, [(k,p)]*(1000))\r\n             connected = 100.0*sum(r)/(1000.0)\r\n             print(\"k = %d, p = %d%%, %d%%\"%(k, p*100, connected))\r\n             if connected == 0:\r\n                 break\r\n```",
      "created_at" : "2019-06-18T05:11:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-502949672",
      "id" : 502949672,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwMjk0OTY3Mg==",
      "updated_at" : "2019-06-18T05:11:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/502949672",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I believe there is a bug in this PR relating to address relay -- I will investigate further and update.",
      "created_at" : "2019-07-05T16:52:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-508814752",
      "id" : 508814752,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwODgxNDc1Mg==",
      "updated_at" : "2019-07-05T16:52:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/508814752",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Pushed a fixup for an address relay issue I spotted (to be squashed).",
      "created_at" : "2019-07-05T20:37:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-508857493",
      "id" : 508857493,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwODg1NzQ5Mw==",
      "updated_at" : "2019-07-05T20:37:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/508857493",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Hit a potential deadlock on this branch during IBD close to tip: \r\n\r\n```\r\n2019-07-08T18:58:46Z UpdateTip: new best=0000000000000000001ec53a5934fa44779d8ab375605cc80fc1f2eb96c76ce8 height=5806\r\n89 version=0x20000000 log2_work=90.738975 tx=424259718 date='2019-06-14T12:56:31Z' progress=0.982123 cache=214.6MiB(1\r\n639768txo)\r\n...\r\n2019-07-08T18:58:58Z sending getdata (37 bytes) peer=9\r\n2019-07-08T18:58:58Z received: inv (37 bytes) peer=10\r\n2019-07-08T18:58:58Z got inv: tx 8290f778e9061a73ae752756aa6982d57d47ffae1317f2feea638c343e4c22d0  new peer=10\r\n2019-07-08T18:58:58Z received: block (1033841 bytes) peer=11\r\n2019-07-08T18:58:58Z received block 000000000000000000041665748801ac08d492429c1ce68778cc58d5d6f575a2 peer=11\r\n2019-07-08T18:58:58Z Requesting block 00000000000000000016c31a145239b8f7acadc11d0b583155a3f31dd6fdde45 (581015) peer=11\r\n2019-07-08T18:58:58Z sending getdata (37 bytes) peer=11\r\n2019-07-08T18:58:58Z received: block (1298943 bytes) peer=12\r\n2019-07-08T18:58:58Z received block 0000000000000000001b2d966e013d6d7dd015702ccf818241a7d626e544c68a peer=12\r\n2019-07-08T18:58:58Z Requesting block 00000000000000000005299461d084e73c72072c23d1372b2c0019d175e2378c (581016) peer=12\r\n2019-07-08T18:58:58Z sending getdata (37 bytes) peer=12\r\n2019-07-08T18:58:58Z received: block (1108360 bytes) peer=0\r\n2019-07-08T18:58:58Z received block 0000000000000000001c3b6640c035a3e8a90162dc71cadf2ca71358c5638778 peer=0\r\n2019-07-08T18:58:59Z Requesting block 0000000000000000001dee2f0e23f87b0826506ed41e88bfb01ab7f82e95daa8 (581017) peer=0\r\n2019-07-08T18:58:59Z sending getdata (37 bytes) peer=0\r\n2019-07-08T18:58:59Z received: block (1256520 bytes) peer=1\r\n2019-07-08T18:58:59Z received block 0000000000000000000ba8d577ae11329b271bf89616afa1203654a411003309 peer=1\r\n2019-07-08T18:58:59Z Requesting block 0000000000000000001c404446e1d35457832e18f7fed03daf06a2e3695df8f8 (581018) peer=1\r\n2019-07-08T18:58:59Z sending getdata (37 bytes) peer=1\r\n2019-07-08T18:58:59Z received: addr (31 bytes) peer=3\r\n2019-07-08T18:58:59Z POTENTIAL DEADLOCK DETECTED\r\n2019-07-08T18:58:59Z Previous lock order was:\r\n2019-07-08T18:58:59Z  pfrom->m_addr_relay.cs_addrsend net_processing.cpp:2124 (in thread msghand)\r\n2019-07-08T18:58:59Z  (1) cs_vNodes ./net.h:227 (in thread msghand)\r\n2019-07-08T18:58:59Z  (2) m_addr_relay.cs_addrsend ./net.h:841 (in thread msghand)\r\n2019-07-08T18:58:59Z Current lock order is:\r\n2019-07-08T18:58:59Z  (2) pfrom->m_addr_relay.cs_addrsend net_processing.cpp:2124 (in thread msghand)\r\n2019-07-08T18:58:59Z  (1) cs_vNodes ./net.h:227 (in thread msghand)\r\nAssertion failed: detected inconsistent lock order at sync.cpp:121, details in debug log.\r\n```",
      "created_at" : "2019-07-08T19:02:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-509351372",
      "id" : 509351372,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwOTM1MTM3Mg==",
      "updated_at" : "2019-07-08T19:02:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/509351372",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jamesob Thanks for catching that!  The addr relay refactor introduced that \"potential deadlock\"; while it's straightforward to fix, I decided to just drop that refactor since I ended up not using it anyway.\r\n\r\nI've updated the PR accordingly (the previous version of this branch is [15759.1](https://github.com/sdaftuar/bitcoin/commits/15759.1)).",
      "created_at" : "2019-07-09T15:50:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-509699243",
      "id" : 509699243,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwOTY5OTI0Mw==",
      "updated_at" : "2019-07-09T15:50:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/509699243",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r301732188"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301732188"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This logic as written will mean the first two connections we open are blocks-only... would this be a problem if for some reason we only had two reachable peers? I.e. would it make any sense to delay creating blocks-only connections until we've already made, say, 2 regular connections? Probably not, but figured it was worth checking.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-07-09T18:29:25Z",
      "diff_hunk" : "@@ -1822,7 +1826,7 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n                 LogPrint(BCLog::NET, \"Making feeler connection to %s\\n\", addrConnect.ToString());\n             }\n \n-            OpenNetworkConnection(addrConnect, (int)setConnected.size() >= std::min(nMaxConnections - 1, 2), &grant, nullptr, false, fFeeler);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r301732188",
      "id" : 301732188,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMTczMjE4OA==",
      "original_commit_id" : "c987790152df24b217249a3b8a3d2b58bbcd11b7",
      "original_position" : 67,
      "path" : "src/net.cpp",
      "position" : 122,
      "pull_request_review_id" : 259646249,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/301732188",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r302245755"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302245755"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think just do std::min(MAX_BLOCKS_ONLY_CONNECTIONS, std::max(connOptions.nMaxConnections - MAX_OUTBOUND_CONNECTIONS, 0)).",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-07-10T19:58:54Z",
      "diff_hunk" : "@@ -1777,6 +1777,7 @@ bool AppInitMain(InitInterfaces& interfaces)\n     connOptions.nLocalServices = nLocalServices;\n     connOptions.nMaxConnections = nMaxConnections;\n     connOptions.nMaxOutbound = std::min(MAX_OUTBOUND_CONNECTIONS, connOptions.nMaxConnections);\n+    connOptions.nMaxOutboundBlocksOnly = std::min(MAX_BLOCKS_ONLY_CONNECTIONS, std::max(connOptions.nMaxOutbound-6, 0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r302245755",
      "id" : 302245755,
      "in_reply_to_id" : 288270228,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMjI0NTc1NQ==",
      "original_commit_id" : "d7991eb708589203b854aed19222864bca02c9dc",
      "original_position" : 4,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 260323249,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302245755",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r302248707"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302248707"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Can you move this into CNodeState? They never belonged in CNode and the only reason they're still there is because its not been worth doing a free-standing PR to do it, but since you're moving them, might as well merge it all with TxDownloadState anyway.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-07-10T20:06:50Z",
      "diff_hunk" : "@@ -695,28 +693,50 @@ class CNode\n     std::vector<CAddress> vAddrToSend;\n     CRollingBloomFilter addrKnown;\n     bool fGetAddr{false};\n-    std::set<uint256> setKnown;\n     int64_t nNextAddrSend GUARDED_BY(cs_sendProcessing){0};\n     int64_t nNextLocalAddrSend GUARDED_BY(cs_sendProcessing){0};\n \n-    // inventory based relay\n-    CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_inventory);\n-    // Set of transaction ids we still have to announce.\n-    // They are sorted by the mempool before relay, so the order is not important.\n-    std::set<uint256> setInventoryTxToSend;\n+    const bool m_addr_relay_peer;\n+    bool IsAddrRelayPeer() const { return m_addr_relay_peer; }\n+\n     // List of block ids we still have announce.\n     // There is no final sorting before sending, as they are always sent immediately\n     // and in the order requested.\n     std::vector<uint256> vInventoryBlockToSend GUARDED_BY(cs_inventory);\n     CCriticalSection cs_inventory;\n-    int64_t nNextInvSend{0};\n+\n+    struct TxRelay {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r302248707",
      "id" : 302248707,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMjI0ODcwNw==",
      "original_commit_id" : "32d8ac4ce6c2e594e464fec43045bc5b09384bfe",
      "original_position" : 90,
      "path" : "src/net.h",
      "position" : 133,
      "pull_request_review_id" : 260327078,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302248707",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I measured (see [source code](https://github.com/naumenkogs/bitcoin_network_analysis/tree/master/propagation_cmpct_blocks)) how extra blocksonly links affect [compact blocks relay](https://github.com/bitcoin/bips/blob/master/bip-0152.mediawiki) latency.  \r\nLow block relay latency is important to reduce orphan rates and, thus, increase the security of the network.\r\nJust to remind, compact block relay latency can be measured in RTTs. \r\n\r\nIf a connected peer has all transactions from the block exccept coinbase tx (current strategy), it would receive a compact block in 0.5 RTT.\r\nIf a connected peer misses at least one transaction from the block, it would take 1.5 RTT.\r\n\r\nSo, increasing the number of block relaying links might speed up compact block relay. But how much?\r\nI measured compact block relay RTT **between 2 random private nodes** in a Bitcoin-like network with pre-relayed transactions (via [Erlay or BTCFlood](https://arxiv.org/abs/1905.10518)).\r\n\r\n|                        | Best case (empty block) | Erlay tx relay  | BTCFlood tx relay |\r\n|------------------------|----------|---------|-----|\r\n| 8 + 0 links | 1.86 RTT | 1.9 RTT  | 2.06 RTT |\r\n| 8 + 2 links | 1.8 RTT  | 1.82 RTT | 2.0 RTT |\r\n| 8 + 8 links | 1.71 RTT  | 1.71 RTT | 1.91 RTT |\r\n\r\nIt seems like we can reduce compact block relay latency by 7% with 8 extra blocks-only links.\r\nIt's hard to tell how it translates into orphan rate, but seems not significant to me.\r\n",
      "created_at" : "2019-07-11T17:57:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-510589579",
      "id" : 510589579,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxMDU4OTU3OQ==",
      "updated_at" : "2019-07-11T17:58:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/510589579",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r302968525"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302968525"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That turns out to be more invasive than I realized when we discussed offline -- fRelayTxes and the bloom filter are used in net.cpp, particularly for the inbound peer eviction logic, so refactoring to allow that to live in net_processing would be more complicated than I think makes sense for this PR.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-07-12T12:54:51Z",
      "diff_hunk" : "@@ -695,28 +693,50 @@ class CNode\n     std::vector<CAddress> vAddrToSend;\n     CRollingBloomFilter addrKnown;\n     bool fGetAddr{false};\n-    std::set<uint256> setKnown;\n     int64_t nNextAddrSend GUARDED_BY(cs_sendProcessing){0};\n     int64_t nNextLocalAddrSend GUARDED_BY(cs_sendProcessing){0};\n \n-    // inventory based relay\n-    CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_inventory);\n-    // Set of transaction ids we still have to announce.\n-    // They are sorted by the mempool before relay, so the order is not important.\n-    std::set<uint256> setInventoryTxToSend;\n+    const bool m_addr_relay_peer;\n+    bool IsAddrRelayPeer() const { return m_addr_relay_peer; }\n+\n     // List of block ids we still have announce.\n     // There is no final sorting before sending, as they are always sent immediately\n     // and in the order requested.\n     std::vector<uint256> vInventoryBlockToSend GUARDED_BY(cs_inventory);\n     CCriticalSection cs_inventory;\n-    int64_t nNextInvSend{0};\n+\n+    struct TxRelay {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r302968525",
      "id" : 302968525,
      "in_reply_to_id" : 302248707,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMjk2ODUyNQ==",
      "original_commit_id" : "32d8ac4ce6c2e594e464fec43045bc5b09384bfe",
      "original_position" : 90,
      "path" : "src/net.h",
      "position" : 133,
      "pull_request_review_id" : 261239266,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302968525",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r302969781"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302969781"
         }
      },
      "author_association" : "MEMBER",
      "body" : "My intuition is that we have bigger problems than not receiving transactions if we're trying to connect to 8 peers but can only make 2 connections, so this isn't a big deal -- happy to reconsider if others disagree.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-07-12T12:58:03Z",
      "diff_hunk" : "@@ -1822,7 +1826,7 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n                 LogPrint(BCLog::NET, \"Making feeler connection to %s\\n\", addrConnect.ToString());\n             }\n \n-            OpenNetworkConnection(addrConnect, (int)setConnected.size() >= std::min(nMaxConnections - 1, 2), &grant, nullptr, false, fFeeler);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r302969781",
      "id" : 302969781,
      "in_reply_to_id" : 301732188,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMjk2OTc4MQ==",
      "original_commit_id" : "c987790152df24b217249a3b8a3d2b58bbcd11b7",
      "original_position" : 67,
      "path" : "src/net.cpp",
      "position" : 122,
      "pull_request_review_id" : 261240868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/302969781",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r303010972"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303010972"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@TheBlueMatt  I pushed a commit that changes the behavior so that the first 8 outbounds are reserved to be regular full-relay peers, and only then do we allocate up to 2 blocksonly peers.\r\n",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-07-12T14:36:57Z",
      "diff_hunk" : "@@ -1777,6 +1777,7 @@ bool AppInitMain(InitInterfaces& interfaces)\n     connOptions.nLocalServices = nLocalServices;\n     connOptions.nMaxConnections = nMaxConnections;\n     connOptions.nMaxOutbound = std::min(MAX_OUTBOUND_CONNECTIONS, connOptions.nMaxConnections);\n+    connOptions.nMaxOutboundBlocksOnly = std::min(MAX_BLOCKS_ONLY_CONNECTIONS, std::max(connOptions.nMaxOutbound-6, 0));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r303010972",
      "id" : 303010972,
      "in_reply_to_id" : 288270228,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwMzAxMDk3Mg==",
      "original_commit_id" : "d7991eb708589203b854aed19222864bca02c9dc",
      "original_position" : 4,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 261296410,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/303010972",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK https://github.com/bitcoin/bitcoin/pull/15759/commits/c73ff2cfa5e5532f908bfdd454efc02e4356f37a (modulo squashing the last commit into c987790152)\r\n\r\nI'm excited for this change. Adding blocks-only connections gives us a lot of resiliency for very little added complexity, and opens the door to safely doing more sophisticated peer management of our regular outbounds. Hopefully we can soon bump up the number of blocks-only connections we make (over the regular 8 outbounds) after we make the marginal memory burden per blocks-only connection low (some `CNodeState` tweaks?).\r\n\r\n### Review notes\r\n```\r\n- [x] e101770e19 Remove unused variable\r\n\r\n- [x] 3742ffd1c2 [refactor] Move tx relay state to separate structure\r\n\r\n  Lock splitting happens (cs_inventory -> {cs_inventory,cs_tx_inventory}\r\n\r\n- [x] 1794eef544 [refactor] Change tx_relay structure to be unique_ptr\r\n\r\n  Super easy to review.\r\n\r\n- [x] 196913ae33 Check that tx_relay is initialized before access\r\n\r\n  Grep'd for all usages of m_tx_relay, checked that they were guarded by\r\n  conditional.\r\n\r\n  Most easily reviewed with `-w`.\r\n\r\n- [x] c72414f65c Add comment explaining intended use of m_tx_relay\r\n\r\n- [x] c987790152 Add 2 outbound blocks-only connections\r\n\r\n  Long lines are hard to review on Github, but that's an out-of-scope nit.\r\n\r\n- [x] 32d8ac4ce6 Don't relay addr messages to block-relay-only peers\r\n\r\n- [x] c73ff2cfa5 fixup! Add 2 outbound blocks-only connections\r\n\r\n  Needs fixup into c987790152.\r\n```\r\n\r\n### Testing\r\nBuilt locally, ran with [getpeerinfo RPC patch](https://gist.github.com/jamesob/b68f11b33a8506ddc6d0a126510486e0) to observe that my first two outgoing connections (out of a total of ten) were blocks-only. Successfully synced to network tip. \r\n\r\nVerified that starting up with `-maxconnections=4` makes no blocks-only connections.\r\n",
      "created_at" : "2019-07-23T18:41:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-514333505",
      "id" : 514333505,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNDMzMzUwNQ==",
      "updated_at" : "2019-07-23T18:41:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/514333505",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jamesob Thanks for reviewing, I've gone ahead and squashed the fixup commit into place.",
      "created_at" : "2019-07-24T13:52:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-514641446",
      "id" : 514641446,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNDY0MTQ0Ng==",
      "updated_at" : "2019-07-24T13:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/514641446",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "reACK https://github.com/bitcoin/bitcoin/pull/15759/commits/085f5b2805f5a202f7d553f9914c94c634c8092c based on [an identical comparison](https://github.com/bitcoin/bitcoin/compare/c73ff2cfa5e5532f908bfdd454efc02e4356f37a..085f5b2805f5a202f7d553f9914c94c634c8092c)",
      "created_at" : "2019-07-24T21:57:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-514814980",
      "id" : 514814980,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNDgxNDk4MA==",
      "updated_at" : "2019-07-24T21:57:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/514814980",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r308479555"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308479555"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Bumping this. It seems the code changes would be slightly simpler if `nMaxOutbound` referred to the total of all outbound connections (including the blocksonly ones). That would also make it easier to reason whether no places where `nMaxOutbound` needed to be replaced with `nMaxOutbound + nMaxOutboundBlocksOnly` were forgotten.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-07-29T23:35:04Z",
      "diff_hunk" : "@@ -1777,6 +1777,7 @@ bool AppInitMain(InitInterfaces& interfaces)\n     connOptions.nLocalServices = nLocalServices;\n     connOptions.nMaxConnections = nMaxConnections;\n     connOptions.nMaxOutbound = std::min(MAX_OUTBOUND_CONNECTIONS, connOptions.nMaxConnections);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r308479555",
      "id" : 308479555,
      "in_reply_to_id" : 288284902,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwODQ3OTU1NQ==",
      "original_commit_id" : "d7991eb708589203b854aed19222864bca02c9dc",
      "original_position" : 3,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 268092399,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308479555",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r308479919"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308479919"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Nit: this initialization of the `TxRelay::pfilter` field probably belongs better in the `TxRelay` constructor.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-07-29T23:36:51Z",
      "diff_hunk" : "@@ -2633,8 +2637,10 @@ CNode::CNode(NodeId idIn, ServiceFlags nLocalServicesIn, int nMyStartingHeightIn\n     hSocket = hSocketIn;\n     addrName = addrNameIn == \"\" ? addr.ToStringIPPort() : addrNameIn;\n     hashContinue = uint256();\n-    m_tx_relay = MakeUnique<TxRelay>();\n-    m_tx_relay->pfilter = MakeUnique<CBloomFilter>();\n+    if (!blocks_only) {\n+        m_tx_relay = MakeUnique<TxRelay>();\n+        m_tx_relay->pfilter = MakeUnique<CBloomFilter>();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r308479919",
      "id" : 308479919,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwODQ3OTkxOQ==",
      "original_commit_id" : "64024a0fd1e654e76a56d39abb173569b7e328c3",
      "original_position" : 116,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 268092399,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/308479919",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r309294845"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/309294845"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Your point appears to be underscored by the fact that I did overlook at least one place where nMaxOutbound needed to be replaced by the sum.  I'll try to improve this as you both suggest.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-07-31T15:44:32Z",
      "diff_hunk" : "@@ -1777,6 +1777,7 @@ bool AppInitMain(InitInterfaces& interfaces)\n     connOptions.nLocalServices = nLocalServices;\n     connOptions.nMaxConnections = nMaxConnections;\n     connOptions.nMaxOutbound = std::min(MAX_OUTBOUND_CONNECTIONS, connOptions.nMaxConnections);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r309294845",
      "id" : 309294845,
      "in_reply_to_id" : 288284902,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwOTI5NDg0NQ==",
      "original_commit_id" : "d7991eb708589203b854aed19222864bca02c9dc",
      "original_position" : 3,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 269107498,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/309294845",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r309779461"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/309779461"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed now.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-01T16:08:26Z",
      "diff_hunk" : "@@ -1777,6 +1777,7 @@ bool AppInitMain(InitInterfaces& interfaces)\n     connOptions.nLocalServices = nLocalServices;\n     connOptions.nMaxConnections = nMaxConnections;\n     connOptions.nMaxOutbound = std::min(MAX_OUTBOUND_CONNECTIONS, connOptions.nMaxConnections);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r309779461",
      "id" : 309779461,
      "in_reply_to_id" : 288284902,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwOTc3OTQ2MQ==",
      "original_commit_id" : "d7991eb708589203b854aed19222864bca02c9dc",
      "original_position" : 3,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 269726536,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/309779461",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r309779570"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/309779570"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-01T16:08:41Z",
      "diff_hunk" : "@@ -2633,8 +2637,10 @@ CNode::CNode(NodeId idIn, ServiceFlags nLocalServicesIn, int nMyStartingHeightIn\n     hSocket = hSocketIn;\n     addrName = addrNameIn == \"\" ? addr.ToStringIPPort() : addrNameIn;\n     hashContinue = uint256();\n-    m_tx_relay = MakeUnique<TxRelay>();\n-    m_tx_relay->pfilter = MakeUnique<CBloomFilter>();\n+    if (!blocks_only) {\n+        m_tx_relay = MakeUnique<TxRelay>();\n+        m_tx_relay->pfilter = MakeUnique<CBloomFilter>();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r309779570",
      "id" : 309779570,
      "in_reply_to_id" : 308479919,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMwOTc3OTU3MA==",
      "original_commit_id" : "64024a0fd1e654e76a56d39abb173569b7e328c3",
      "original_position" : 116,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 269726693,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/309779570",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated this PR to incorporate feedback from @sipa / @dongcarl.  Previous version is [15759.2](https://github.com/sdaftuar/bitcoin/commits/15759.2)",
      "created_at" : "2019-08-01T16:42:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-517366803",
      "id" : 517366803,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNzM2NjgwMw==",
      "updated_at" : "2019-08-01T16:42:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/517366803",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r310366284"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/310366284"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: could take opportunity to comment all members",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-04T00:25:23Z",
      "diff_hunk" : "@@ -698,24 +691,43 @@ class CNode\n     int64_t nNextAddrSend GUARDED_BY(cs_sendProcessing){0};\n     int64_t nNextLocalAddrSend GUARDED_BY(cs_sendProcessing){0};\n \n-    // inventory based relay\n-    CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_inventory);\n-    // Set of transaction ids we still have to announce.\n-    // They are sorted by the mempool before relay, so the order is not important.\n-    std::set<uint256> setInventoryTxToSend;\n     // List of block ids we still have announce.\n     // There is no final sorting before sending, as they are always sent immediately\n     // and in the order requested.\n     std::vector<uint256> vInventoryBlockToSend GUARDED_BY(cs_inventory);\n     CCriticalSection cs_inventory;\n-    int64_t nNextInvSend{0};\n+\n+    struct TxRelay {\n+        TxRelay() { pfilter = MakeUnique<CBloomFilter>(); }\n+        mutable CCriticalSection cs_filter;\n+        // We use fRelayTxes for two purposes -\n+        // a) it allows us to not relay tx invs before receiving the peer's version message\n+        // b) the peer may tell us in its version message that we should not relay tx invs\n+        //    unless it loads a bloom filter.\n+        bool fRelayTxes GUARDED_BY(cs_filter){false};\n+        std::unique_ptr<CBloomFilter> pfilter PT_GUARDED_BY(cs_filter);\n+\n+        mutable CCriticalSection cs_tx_inventory;\n+        CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_tx_inventory){50000, 0.000001};\n+        // Set of transaction ids we still have to announce.\n+        // They are sorted by the mempool before relay, so the order is not important.\n+        std::set<uint256> setInventoryTxToSend;\n+        // Used for BIP35 mempool sending\n+        bool fSendMempool GUARDED_BY(cs_tx_inventory){false};\n+        // Last time a \"MEMPOOL\" request was serviced.\n+        std::atomic<int64_t> timeLastMempoolReq{0};\n+        int64_t nNextInvSend{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r310366284",
      "id" : 310366284,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMDM2NjI4NA==",
      "original_commit_id" : "3ffdaaba3759e7d4c5d857e24245eaf47b123246",
      "original_position" : 51,
      "path" : "src/net.h",
      "position" : 152,
      "pull_request_review_id" : 270476502,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/310366284",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r310366329"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/310366329"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Isn't a boolean a better practice than a nullptr ? Do we prefer to have a node crashing because of non-initialized acces or a topology leak because of a boolean in wrong state ?",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-04T00:28:25Z",
      "diff_hunk" : "@@ -725,6 +725,7 @@ class CNode\n         int64_t nextSendTimeFeeFilter{0};\n     };\n \n+    // m_tx_relay == nullptr if we're not relaying transactions with this peer",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r310366329",
      "id" : 310366329,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMDM2NjMyOQ==",
      "original_commit_id" : "c496ae11cf96bf37dc6e650e6d35c4b635df720e",
      "original_position" : 4,
      "path" : "src/net.h",
      "position" : 161,
      "pull_request_review_id" : 270476502,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/310366329",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r310366358"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/310366358"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: comment is a bit misleading and without context lets suggest we have already transaction-only peers, isn't full-relay peers a better wording ?",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-04T00:30:09Z",
      "diff_hunk" : "@@ -743,11 +743,11 @@ void UpdateLastBlockAnnounceTime(NodeId node, int64_t time_in_seconds)\n     if (state) state->m_last_block_announcement = time_in_seconds;\n }\n \n-// Returns true for outbound peers, excluding manual connections, feelers, and\n-// one-shots\n+// Returns true for outbound transaction-relay peers, excluding manual",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r310366358",
      "id" : 310366358,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMDM2NjM1OA==",
      "original_commit_id" : "76f1ffdfc0d0f083e7ae105212ca6622197f8f4c",
      "original_position" : 15,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 270476502,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/310366358",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> what's the state of art of network topology inference based only on blocks\r\n\r\nNot much. There is [map-z](https://arxiv.org/pdf/1907.09755.pdf) paper which infers topology in Zcash, but it's a lot simplier than Bitcoin, because they have smaller network, blocks are processed longer, a significant portion of nodes produce blocks, etc. I'm trying to see how easy it would be to use something similar in Bitcoin at the moment, but I tend to agree it's difficult now (especially with Fibre and Compact Blocks).",
      "created_at" : "2019-08-04T03:57:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-517971718",
      "id" : 517971718,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNzk3MTcxOA==",
      "updated_at" : "2019-08-04T03:57:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/517971718",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Ping @sr-gi, perhaps you know of ways for topology inference based on block relay?",
      "created_at" : "2019-08-04T04:30:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-517972854",
      "id" : 517972854,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxNzk3Mjg1NA==",
      "updated_at" : "2019-08-04T04:30:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/517972854",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> Ping @sr-gi, perhaps you know of ways for topology inference based on block relay?\r\n\r\nNot really. We focused on tx relay since the difference in handling normal / orphan transaction could leak useful information. That is not the case for blocks AFAIK. I've had no chance to check map-z yet, but I'll do and see if I can think of something. ",
      "created_at" : "2019-08-06T10:19:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-518608887",
      "id" : 518608887,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUxODYwODg4Nw==",
      "updated_at" : "2019-08-06T13:11:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/518608887",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r312945124"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312945124"
         }
      },
      "author_association" : "MEMBER",
      "body" : "note to other reviewers: It is fine to not take a lock here because `timeLastMempoolReq` is atomic",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-12T14:12:25Z",
      "diff_hunk" : "@@ -1519,11 +1519,11 @@ void static ProcessGetData(CNode* pfrom, const CChainParams& chainparams, CConnm\n             if (mi != mapRelay.end()) {\n                 connman->PushMessage(pfrom, msgMaker.Make(nSendFlags, NetMsgType::TX, *mi->second));\n                 push = true;\n-            } else if (pfrom->timeLastMempoolReq) {\n+            } else if (pfrom->m_tx_relay.timeLastMempoolReq) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r312945124",
      "id" : 312945124,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMjk0NTEyNA==",
      "original_commit_id" : "3ffdaaba3759e7d4c5d857e24245eaf47b123246",
      "original_position" : 19,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 229274187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312945124",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r312954868"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312954868"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> @ariard Isn't a boolean a better practice than a nullptr ? Do we prefer to have a node crashing because of non-initialized acces or a topology leak because of a boolean in wrong state ?\r\n\r\nI think the goal here is to not to construct the tx relay object if we don't want to use it. With a boolean that wouldn't be possible. However, it is possible with a pointer or an optional.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-12T14:30:42Z",
      "diff_hunk" : "@@ -725,6 +725,7 @@ class CNode\n         int64_t nextSendTimeFeeFilter{0};\n     };\n \n+    // m_tx_relay == nullptr if we're not relaying transactions with this peer",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r312954868",
      "id" : 312954868,
      "in_reply_to_id" : 310366329,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMjk1NDg2OA==",
      "original_commit_id" : "c496ae11cf96bf37dc6e650e6d35c4b635df720e",
      "original_position" : 4,
      "path" : "src/net.h",
      "position" : 161,
      "pull_request_review_id" : 229274187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312954868",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r312976322"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312976322"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Would be nice to add a comment here to explain that this will effectively treat MSG_TX and MSG_WITNESS_TX as \"unknown\" types, thus blocking the queue, thus starving this peer completely and making it a zombie.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-12T15:11:54Z",
      "diff_hunk" : "@@ -1499,7 +1499,7 @@ void static ProcessGetData(CNode* pfrom, const CChainParams& chainparams, CConnm\n     std::deque<CInv>::iterator it = pfrom->vRecvGetData.begin();\n     std::vector<CInv> vNotFound;\n     const CNetMsgMaker msgMaker(pfrom->GetSendVersion());\n-    {\n+    if (pfrom->m_tx_relay != nullptr) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r312976322",
      "id" : 312976322,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMjk3NjMyMg==",
      "original_commit_id" : "7e6f3738e0b76570abf2efad78b8380855738f3f",
      "original_position" : 14,
      "path" : "src/net_processing.cpp",
      "position" : 62,
      "pull_request_review_id" : 229274187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/312976322",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r313417866"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/313417866"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Leaving this alone for now, since I think these are relatively self-commented anyway, but also when I looked at this again it seems like another improvement here would be to conform all these variables to the style guide as well, which I'd prefer to not do in this PR at this point.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-13T14:09:59Z",
      "diff_hunk" : "@@ -698,24 +691,43 @@ class CNode\n     int64_t nNextAddrSend GUARDED_BY(cs_sendProcessing){0};\n     int64_t nNextLocalAddrSend GUARDED_BY(cs_sendProcessing){0};\n \n-    // inventory based relay\n-    CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_inventory);\n-    // Set of transaction ids we still have to announce.\n-    // They are sorted by the mempool before relay, so the order is not important.\n-    std::set<uint256> setInventoryTxToSend;\n     // List of block ids we still have announce.\n     // There is no final sorting before sending, as they are always sent immediately\n     // and in the order requested.\n     std::vector<uint256> vInventoryBlockToSend GUARDED_BY(cs_inventory);\n     CCriticalSection cs_inventory;\n-    int64_t nNextInvSend{0};\n+\n+    struct TxRelay {\n+        TxRelay() { pfilter = MakeUnique<CBloomFilter>(); }\n+        mutable CCriticalSection cs_filter;\n+        // We use fRelayTxes for two purposes -\n+        // a) it allows us to not relay tx invs before receiving the peer's version message\n+        // b) the peer may tell us in its version message that we should not relay tx invs\n+        //    unless it loads a bloom filter.\n+        bool fRelayTxes GUARDED_BY(cs_filter){false};\n+        std::unique_ptr<CBloomFilter> pfilter PT_GUARDED_BY(cs_filter);\n+\n+        mutable CCriticalSection cs_tx_inventory;\n+        CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_tx_inventory){50000, 0.000001};\n+        // Set of transaction ids we still have to announce.\n+        // They are sorted by the mempool before relay, so the order is not important.\n+        std::set<uint256> setInventoryTxToSend;\n+        // Used for BIP35 mempool sending\n+        bool fSendMempool GUARDED_BY(cs_tx_inventory){false};\n+        // Last time a \"MEMPOOL\" request was serviced.\n+        std::atomic<int64_t> timeLastMempoolReq{0};\n+        int64_t nNextInvSend{0};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r313417866",
      "id" : 313417866,
      "in_reply_to_id" : 310366284,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMzQxNzg2Ng==",
      "original_commit_id" : "3ffdaaba3759e7d4c5d857e24245eaf47b123246",
      "original_position" : 51,
      "path" : "src/net.h",
      "position" : 152,
      "pull_request_review_id" : 274310091,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/313417866",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r313418010"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/313418010"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Addressed in latest commit.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-13T14:10:15Z",
      "diff_hunk" : "@@ -743,11 +743,11 @@ void UpdateLastBlockAnnounceTime(NodeId node, int64_t time_in_seconds)\n     if (state) state->m_last_block_announcement = time_in_seconds;\n }\n \n-// Returns true for outbound peers, excluding manual connections, feelers, and\n-// one-shots\n+// Returns true for outbound transaction-relay peers, excluding manual",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r313418010",
      "id" : 313418010,
      "in_reply_to_id" : 310366358,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMzQxODAxMA==",
      "original_commit_id" : "76f1ffdfc0d0f083e7ae105212ca6622197f8f4c",
      "original_position" : 15,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 274310267,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/313418010",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r313418105"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/313418105"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Addressed in latest commit.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-13T14:10:27Z",
      "diff_hunk" : "@@ -1499,7 +1499,7 @@ void static ProcessGetData(CNode* pfrom, const CChainParams& chainparams, CConnm\n     std::deque<CInv>::iterator it = pfrom->vRecvGetData.begin();\n     std::vector<CInv> vNotFound;\n     const CNetMsgMaker msgMaker(pfrom->GetSendVersion());\n-    {\n+    if (pfrom->m_tx_relay != nullptr) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r313418105",
      "id" : 313418105,
      "in_reply_to_id" : 312976322,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMzQxODEwNQ==",
      "original_commit_id" : "7e6f3738e0b76570abf2efad78b8380855738f3f",
      "original_position" : 14,
      "path" : "src/net_processing.cpp",
      "position" : 62,
      "pull_request_review_id" : 274310422,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/313418105",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated to address some comment nits from @MarcoFalke and @ariard.",
      "created_at" : "2019-08-13T14:11:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-520851451",
      "id" : 520851451,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyMDg1MTQ1MQ==",
      "updated_at" : "2019-08-13T14:11:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/520851451",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-ACK 08478f1409c65335a28dcf796f8e87a43d1b7040 (only change is adding a commit to clarify documentation)\r\n\r\n<details><summary>Show signature and timestamp</summary>\r\n\r\nSignature:\r\n\r\n```\r\n-----BEGIN PGP SIGNED MESSAGE-----\r\nHash: SHA512\r\n\r\nre-ACK 08478f1409c65335a28dcf796f8e87a43d1b7040 (only change is adding a commit to clarify documentation)\r\n-----BEGIN PGP SIGNATURE-----\r\n\r\niQGzBAEBCgAdFiEE+rVPoUahrI9sLGYTzit1aX5ppUgFAlwqrYAACgkQzit1aX5p\r\npUiQCAwAuhyBP+uOlfgbfa2sDwacm+CIVhPYIlXf06rqaW3j/aepwC2hsAQmV7bZ\r\nUJ+jIJEniX7VMKjRU9v8bEc7BN3cUFaQVrWSPdVUslZGxKmP1TY7PaCzoBSabHhs\r\nhY2ep0HpWGjaSSf32F+OsqX0qEP/+Pe65tAydZjzqQPMNz5pMgkfedFEHOpJF2vW\r\nbUAlQR7f1/1l/aJNmuF9to+GqP7iQGzf30EMSWI6YYPWtk2jUlTalBRd8SLZsE5e\r\nlkaamFWjVfTK7IgfhI7y5wg5/CwhdZWCOQpkycEu5moNhyUqCIBmi6IAqSDSn6iU\r\nDOLw7mZ29TU8Y92YebfYu+kkSJ93ZKNElSm7JlCDIfu+zKWYeGjQjDhFh6aNjN3J\r\nexjBXG0EI+uyiF/8DpjvgletvHkCqHEHPMexisH0Ly6T8PnHEblOFqIgTviwEKfU\r\n8yAgIcdiVzYnHYCvFUrncFSPowh0rdJyhx07pLcaaHOKNLWSqDH+q330vz/a1nQX\r\nMab5hYsv\r\n=DLTl\r\n-----END PGP SIGNATURE-----\r\n```\r\n\r\n[Timestamp of file with hash `52bbf433e2ba99292fc1ad0a59de737cfa33cafaa42dd8ee010da3bd41aa1df1  -`](https://opentimestamps.org/info/?004f70656e54696d657374616d7073000050726f6f6600bf89e2e884e89294010852bbf433e2ba99292fc1ad0a59de737cfa33cafaa42dd8ee010da3bd41aa1df1f0106ced9b5817d182c207cf5f3725c8385a08fff0100c6034a7a92982aa2346a5b138a1603b08f1045d52c6eff008678aa40ac5ebbe9f0083dfe30d2ef90c8e232268747470733a2f2f6274632e63616c656e6461722e636174616c6c6178792e636f6dfff010240b3828938e49b7950e9f01c50fab3808f1201e49a27e6d4f0059b605df57741f6b13ba19aef6caa7db84687e3e88c367f51908f1045d52c6eff0083679183627f759f80083dfe30d2ef90c8e2e2d68747470733a2f2f616c6963652e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267fff0106b3eef18345768d9d38a3a3f4198229a08f12043b0c565279f2699a77ffc2dfd3906195b2471d9937e059b9ae10d735e028eba08f1045d52c6eff00824fc011e56ec46690083dfe30d2ef90c8e292868747470733a2f2f66696e6e65792e63616c656e6461722e657465726e69747977616c6c2e636f6df010ce58cf4edb205098eab1e3ed4dbf571e08f020e868f60b51ff63beeffcfa466c9c4694ffc1b1bd086f8f2ab020327ec434cfa708f1045d52c6eff0080a07bc09b4d071810083dfe30d2ef90c8e2c2b68747470733a2f2f626f622e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267)\r\n\r\n</details>\r\n",
      "created_at" : "2019-08-13T14:19:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-520854980",
      "id" : 520854980,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyMDg1NDk4MA==",
      "updated_at" : "2019-08-13T14:19:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/520854980",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think there are a bunch of \"doc-level\" cleanups that should come afterwards. Like release notes, rpc changes, functional tests, whatnot... I think it is best to leave them for later.",
      "created_at" : "2019-08-13T17:50:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-520937901",
      "id" : 520937901,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyMDkzNzkwMQ==",
      "updated_at" : "2019-08-13T17:50:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/520937901",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think it would be great to know whether this meaningfully improves our defenses against topology inference, but it also seems like something we will only know definitively if someone publishes a successful attack (I doubt we'll get any proofs anytime soon that no attacks are possible!).\r\n\r\nSo while I think it's good to give reviewers some time to see if anyone can come up with an attack against this approach, it also seems to me that we'll get more information about this after code is deployed.  And adding additional outbound peers should make the network more robust to partition attacks.  So even if topology inference is still possible, this PR should only be making our code strictly better, from a security standpoint.\r\n\r\nFrom a performance standpoint, this PR does increase the resource usage for these additional connections, but if that is sufficiently small (as I believe it would be, in this patch) I think we would not regret it.\r\n\r\n(Also, if it turns out that approaches like the one described in the Map-Z paper work on the bitcoin network to infer these blocks-only links, then I suspect it should still be relatively straightforward to neutralize that kind of approach by, say, intentionally delaying block relay on these links so that in the absence of an attack on the rest of a node's peers, these would not be inferable.  I think we can discuss these kinds of hypothetical mitigations once an attack becomes apparent.)",
      "created_at" : "2019-08-13T19:48:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-520981648",
      "id" : 520981648,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyMDk4MTY0OA==",
      "updated_at" : "2019-08-13T20:22:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/520981648",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r313588220"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/313588220"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm, should you add an else branch here and disconnect them if we opened a blocksonly connection to some peer that asked for filtering?",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-13T20:06:30Z",
      "diff_hunk" : "@@ -3091,12 +3100,12 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n             LOCK(cs_main);\n             Misbehaving(pfrom->GetId(), 100);\n         }\n-        else\n+        else if (pfrom->m_tx_relay != nullptr)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r313588220",
      "id" : 313588220,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMzU4ODIyMA==",
      "original_commit_id" : "aff2a198276f1659a096403cf17e919a103f806b",
      "original_position" : 133,
      "path" : "src/net_processing.cpp",
      "position" : 204,
      "pull_request_review_id" : 274524887,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/313588220",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> If the resource usage for these additional connections is sufficiently small (as I believe it would be, in this patch) I think we would not regret it.\r\n\r\nI agree with this. Phrased differently, blocks-only connections offer a strict subset of the information that standard connections do. Given that, I don't see how these two additional connections could enable any new attacks, since these additional links don't offer any additional information to would-be attackers.\r\n\r\nWhat these connections *do* offer is increased connectedness in terms of block relay. So I think that even though we lack conclusive proof that these connections don't enable some kind of attack, we have enough of an argument that they probably don't. Netting that against the certainty that this change makes partitionability less of a concern (which is a much more severe risk than, say, topology inference) makes the low, maybe-nonexistent risk seem well worth it.\r\n\r\nSo this change seems like an uncontroversial win to me. I think we should merge it soon.",
      "created_at" : "2019-08-13T20:26:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-520995708",
      "id" : 520995708,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyMDk5NTcwOA==",
      "updated_at" : "2019-08-13T20:26:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/520995708",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r313598108"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/313598108"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I mean I dont think its all that critical, but I do think I'd prefer if it were non-blocks-only first. Specifically, if you have a rather-stale addrman, you'd like to use your first few peers to exchange addresses so speed up getting further connections (instead of being stuck spinning).",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-13T20:30:46Z",
      "diff_hunk" : "@@ -1822,7 +1826,7 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n                 LogPrint(BCLog::NET, \"Making feeler connection to %s\\n\", addrConnect.ToString());\n             }\n \n-            OpenNetworkConnection(addrConnect, (int)setConnected.size() >= std::min(nMaxConnections - 1, 2), &grant, nullptr, false, fFeeler);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r313598108",
      "id" : 313598108,
      "in_reply_to_id" : 301732188,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxMzU5ODEwOA==",
      "original_commit_id" : "c987790152df24b217249a3b8a3d2b58bbcd11b7",
      "original_position" : 67,
      "path" : "src/net.cpp",
      "position" : 122,
      "pull_request_review_id" : 274524887,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/313598108",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I don't see how these two additional connections could enable any new attacks, since these additional links don't offer any additional information to would-be attackers.\r\n\r\nGiven correct implementation, of course!",
      "created_at" : "2019-08-13T20:50:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-521003889",
      "id" : 521003889,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyMTAwMzg4OQ==",
      "updated_at" : "2019-08-13T20:50:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/521003889",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2019-08-14T16:20:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-521316221",
      "id" : 521316221,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyMTMxNjIyMQ==",
      "updated_at" : "2019-08-14T16:20:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/521316221",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r314014747"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/314014747"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Sorry for the noise on this one, I thought about it after the fact, maybe the ideal would be to have special classes CBlockNode/CTxNode but would need different code paths so that's for future works.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-14T18:15:28Z",
      "diff_hunk" : "@@ -725,6 +725,7 @@ class CNode\n         int64_t nextSendTimeFeeFilter{0};\n     };\n \n+    // m_tx_relay == nullptr if we're not relaying transactions with this peer",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r314014747",
      "id" : 314014747,
      "in_reply_to_id" : 310366329,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNDAxNDc0Nw==",
      "original_commit_id" : "c496ae11cf96bf37dc6e650e6d35c4b635df720e",
      "original_position" : 4,
      "path" : "src/net.h",
      "position" : 161,
      "pull_request_review_id" : 275063428,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/314014747",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r314020286"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/314020286"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed in the latest version.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-14T18:28:02Z",
      "diff_hunk" : "@@ -1822,7 +1826,7 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n                 LogPrint(BCLog::NET, \"Making feeler connection to %s\\n\", addrConnect.ToString());\n             }\n \n-            OpenNetworkConnection(addrConnect, (int)setConnected.size() >= std::min(nMaxConnections - 1, 2), &grant, nullptr, false, fFeeler);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r314020286",
      "id" : 314020286,
      "in_reply_to_id" : 301732188,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNDAyMDI4Ng==",
      "original_commit_id" : "c987790152df24b217249a3b8a3d2b58bbcd11b7",
      "original_position" : 67,
      "path" : "src/net.cpp",
      "position" : 122,
      "pull_request_review_id" : 275070442,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/314020286",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I pushed changes to address feedback from @thebluematt and @jamesob so that we now connect to full relay peers before blocks-only ones.\r\n\r\nI also improved the logging of new outbound connections so that we also output whether it's a blocksonly peer or feeler peer.\r\n\r\n",
      "created_at" : "2019-08-14T18:29:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-521363669",
      "id" : 521363669,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyMTM2MzY2OQ==",
      "updated_at" : "2019-08-14T18:29:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/521363669",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "utACK 6962113",
      "created_at" : "2019-08-15T14:53:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-521670402",
      "id" : 521670402,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyMTY3MDQwMg==",
      "updated_at" : "2019-08-15T14:53:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/521670402",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r314371544"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/314371544"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(https://github.com/bitcoin/bitcoin/pull/15759/commits/4e6a635f4ea3c1a6a026877e561e7671ac00b449)\r\n\r\nOnly if you have to rebase for other reasons: might wanna use the current naming convention for these. ",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-15T15:41:46Z",
      "diff_hunk" : "@@ -1722,7 +1722,8 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n         CAddress addrConnect;\n \n         // Only connect out to one peer per network group (/16 for IPv4).\n-        int nOutbound = 0;\n+        int nOutboundFullRelay = 0;\n+        int nOutboundBlocksOnly = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r314371544",
      "id" : 314371544,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNDM3MTU0NA==",
      "original_commit_id" : "4e6a635f4ea3c1a6a026877e561e7671ac00b449",
      "original_position" : 42,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 275508570,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/314371544",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r314380402"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/314380402"
         }
      },
      "author_association" : "MEMBER",
      "body" : "These long lines are tough to review in Github.\r\n\r\n![Selection_132](https://user-images.githubusercontent.com/73197/63108092-17dc9180-bf54-11e9-8b67-d28706c096c6.png)\r\n(fullscreen)\r\n\r\nObviously not worth addressing unless revisiting for other reasons.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-15T15:59:39Z",
      "diff_hunk" : "@@ -1827,7 +1832,14 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n                 LogPrint(BCLog::NET, \"Making feeler connection to %s\\n\", addrConnect.ToString());\n             }\n \n-            OpenNetworkConnection(addrConnect, (int)setConnected.size() >= std::min(nMaxConnections - 1, 2), &grant, nullptr, false, fFeeler);\n+            // Open this connection as blocks-only if we're already at our\n+            // full-relay capacity, but not yet at our blocks-only peer limit.\n+            // (It should not be possible for fFeeler to be set if we're not\n+            // also at our blocks-only peer limit, but check against that as\n+            // well for sanity.)\n+            bool blocks_only = nOutboundBlocksOnly < m_max_outbound_blocks_only && !fFeeler && nOutboundFullRelay >= m_max_outbound_full_relay;\n+\n+            OpenNetworkConnection(addrConnect, (int)setConnected.size() >= std::min(nMaxConnections - 1, 2), &grant, nullptr, false, fFeeler, false, blocks_only);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r314380402",
      "id" : 314380402,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNDM4MDQwMg==",
      "original_commit_id" : "4e6a635f4ea3c1a6a026877e561e7671ac00b449",
      "original_position" : 80,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 275508570,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/314380402",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r314786257"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/314786257"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I believe we'll stop processing _all_ messages in this case (since `ProcessMessages()` will exit early if the `vRecvGetData` vector is non-empty after `ProcessGetData()` was called)",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-16T16:02:16Z",
      "diff_hunk" : "@@ -1512,7 +1512,12 @@ void static ProcessGetData(CNode* pfrom, const CChainParams& chainparams, CConnm\n     std::deque<CInv>::iterator it = pfrom->vRecvGetData.begin();\n     std::vector<CInv> vNotFound;\n     const CNetMsgMaker msgMaker(pfrom->GetSendVersion());\n-    {\n+\n+    // Note that if we receive a getdata for a MSG_TX or MSG_WITNESS_TX from a\n+    // blocks-only outbound peer, we will stop processing further getdata",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r314786257",
      "id" : 314786257,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNDc4NjI1Nw==",
      "original_commit_id" : "69621136f51c547e22bf6a095cbcd2edabb195f5",
      "original_position" : 56,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 276035509,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/314786257",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r314805306"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/314805306"
         }
      },
      "author_association" : "MEMBER",
      "body" : "micronit: change this to early-exit like in the `NetMsgType::FILTERCLEAR` block (otherwise there will be a meaningless log when a FEEFILTER is received from a blocks-only peer).",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-16T16:56:02Z",
      "diff_hunk" : "@@ -3157,21 +3173,24 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     }\n \n     if (strCommand == NetMsgType::FILTERCLEAR) {\n-        LOCK(pfrom->cs_filter);\n+        if (pfrom->m_tx_relay == nullptr) {\n+            return true;\n+        }\n+        LOCK(pfrom->m_tx_relay->cs_filter);\n         if (pfrom->GetLocalServices() & NODE_BLOOM) {\n-            pfrom->pfilter.reset(new CBloomFilter());\n+            pfrom->m_tx_relay->pfilter.reset(new CBloomFilter());\n         }\n-        pfrom->fRelayTxes = true;\n+        pfrom->m_tx_relay->fRelayTxes = true;\n         return true;\n     }\n \n     if (strCommand == NetMsgType::FEEFILTER) {\n         CAmount newFeeFilter = 0;\n         vRecv >> newFeeFilter;\n         if (MoneyRange(newFeeFilter)) {\n-            {\n-                LOCK(pfrom->cs_feeFilter);\n-                pfrom->minFeeFilter = newFeeFilter;\n+            if (pfrom->m_tx_relay != nullptr) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r314805306",
      "id" : 314805306,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNDgwNTMwNg==",
      "original_commit_id" : "69621136f51c547e22bf6a095cbcd2edabb195f5",
      "original_position" : 206,
      "path" : "src/net_processing.cpp",
      "position" : 257,
      "pull_request_review_id" : 276035509,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/314805306",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r314835905"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/314835905"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree. It'd also be nice to comment the `nullptr`/`false` args.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-16T18:18:27Z",
      "diff_hunk" : "@@ -1827,7 +1832,14 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n                 LogPrint(BCLog::NET, \"Making feeler connection to %s\\n\", addrConnect.ToString());\n             }\n \n-            OpenNetworkConnection(addrConnect, (int)setConnected.size() >= std::min(nMaxConnections - 1, 2), &grant, nullptr, false, fFeeler);\n+            // Open this connection as blocks-only if we're already at our\n+            // full-relay capacity, but not yet at our blocks-only peer limit.\n+            // (It should not be possible for fFeeler to be set if we're not\n+            // also at our blocks-only peer limit, but check against that as\n+            // well for sanity.)\n+            bool blocks_only = nOutboundBlocksOnly < m_max_outbound_blocks_only && !fFeeler && nOutboundFullRelay >= m_max_outbound_full_relay;\n+\n+            OpenNetworkConnection(addrConnect, (int)setConnected.size() >= std::min(nMaxConnections - 1, 2), &grant, nullptr, false, fFeeler, false, blocks_only);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r314835905",
      "id" : 314835905,
      "in_reply_to_id" : 314380402,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNDgzNTkwNQ==",
      "original_commit_id" : "4e6a635f4ea3c1a6a026877e561e7671ac00b449",
      "original_position" : 80,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 276035509,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/314835905",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r314860750"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/314860750"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think this branch is necessary (or can ever be hit). `IsAddrRelayPeer()` can only be false for `blocks_only` peers, which are outbound connections, and so will be caught by the `if (!pfrom->fInbound)` branch above.\r\n\r\nThere's no harm in this being here, but I think it's dead code.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-16T19:28:35Z",
      "diff_hunk" : "@@ -2989,6 +2999,10 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n             LogPrint(BCLog::NET, \"Ignoring \\\"getaddr\\\" from outbound connection. peer=%d\\n\", pfrom->GetId());\n             return true;\n         }\n+        if (!pfrom->IsAddrRelayPeer()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r314860750",
      "id" : 314860750,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNDg2MDc1MA==",
      "original_commit_id" : "69621136f51c547e22bf6a095cbcd2edabb195f5",
      "original_position" : 128,
      "path" : "src/net_processing.cpp",
      "position" : 179,
      "pull_request_review_id" : 276035509,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/314860750",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r315529341"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315529341"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "As far as I can see, this prevents blocks only connections from being disconnected during IBD if their header set has less than `nMinimumChainWork` (in `net_processing:ProcessHeadersMessage()`). It also prevents blocks only nodes from getting evicted in `PeerLogicValidation::ConsiderEviction()` if they're not keeping up with the blocks we see. Not sure that makes sense?",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-20T06:49:54Z",
      "diff_hunk" : "@@ -756,11 +756,11 @@ void UpdateLastBlockAnnounceTime(NodeId node, int64_t time_in_seconds)\n     if (state) state->m_last_block_announcement = time_in_seconds;\n }\n \n-// Returns true for outbound peers, excluding manual connections, feelers, and\n-// one-shots\n+// Returns true for outbound full-relay peers, excluding manual\n+// connections, feelers, one-shots, and blocks-only connections\n static bool IsOutboundDisconnectionCandidate(const CNode *node)\n {\n-    return !(node->fInbound || node->m_manual_connection || node->fFeeler || node->fOneShot);\n+    return !(node->fInbound || node->m_manual_connection || node->fFeeler || node->fOneShot || node->m_tx_relay == nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r315529341",
      "id" : 315529341,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNTUyOTM0MQ==",
      "original_commit_id" : "69621136f51c547e22bf6a095cbcd2edabb195f5",
      "original_position" : 20,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 276960566,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315529341",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r315545544"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315545544"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think it makes sense to keep this as belt-and-suspenders -- it's not that clear that `fInbound` will always be false whenever `m_addr_relay_peer` is false. Might make sense to have this test before the `!fInbound` test though, so that it is at least exercised?",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-20T07:38:07Z",
      "diff_hunk" : "@@ -2989,6 +2999,10 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n             LogPrint(BCLog::NET, \"Ignoring \\\"getaddr\\\" from outbound connection. peer=%d\\n\", pfrom->GetId());\n             return true;\n         }\n+        if (!pfrom->IsAddrRelayPeer()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r315545544",
      "id" : 315545544,
      "in_reply_to_id" : 314860750,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNTU0NTU0NA==",
      "original_commit_id" : "69621136f51c547e22bf6a095cbcd2edabb195f5",
      "original_position" : 128,
      "path" : "src/net_processing.cpp",
      "position" : 179,
      "pull_request_review_id" : 276960566,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315545544",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r315587687"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315587687"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think `pfilter` can ever be null, so most of the `if (...->pfilter)` tests seem redundant. It's only ever changed by either: `pfilter.reset(new CBloomFilter(filter))` or `pfilter.reset(new CBloomFilter())`, which I think could be simplified to `*pfilter = filter` and `*pfilter = CBloomFilter()`, or, at that point, just having a CBloomFilter as a member directly.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-20T09:17:11Z",
      "diff_hunk" : "@@ -703,28 +703,51 @@ class CNode\n     std::vector<CAddress> vAddrToSend;\n     CRollingBloomFilter addrKnown;\n     bool fGetAddr{false};\n-    std::set<uint256> setKnown;\n     int64_t nNextAddrSend GUARDED_BY(cs_sendProcessing){0};\n     int64_t nNextLocalAddrSend GUARDED_BY(cs_sendProcessing){0};\n \n-    // inventory based relay\n-    CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_inventory);\n-    // Set of transaction ids we still have to announce.\n-    // They are sorted by the mempool before relay, so the order is not important.\n-    std::set<uint256> setInventoryTxToSend;\n+    const bool m_addr_relay_peer;\n+    bool IsAddrRelayPeer() const { return m_addr_relay_peer; }\n+\n     // List of block ids we still have announce.\n     // There is no final sorting before sending, as they are always sent immediately\n     // and in the order requested.\n     std::vector<uint256> vInventoryBlockToSend GUARDED_BY(cs_inventory);\n     CCriticalSection cs_inventory;\n-    int64_t nNextInvSend{0};\n+\n+    struct TxRelay {\n+        TxRelay() { pfilter = MakeUnique<CBloomFilter>(); }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r315587687",
      "id" : 315587687,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNTU4NzY4Nw==",
      "original_commit_id" : "69621136f51c547e22bf6a095cbcd2edabb195f5",
      "original_position" : 128,
      "path" : "src/net.h",
      "position" : 134,
      "pull_request_review_id" : 276960566,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315587687",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r315589541"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315589541"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this should be both `PT_GUARDED_BY(cs_filter)` and `GUARDED_BY(cs_filter)` -- you shouldn't be (and aren't) resetting the pointer without holding the lock, since that would destroy the underlying data that some other thread might have held the lock and be accessing it.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-20T09:21:26Z",
      "diff_hunk" : "@@ -703,28 +703,51 @@ class CNode\n     std::vector<CAddress> vAddrToSend;\n     CRollingBloomFilter addrKnown;\n     bool fGetAddr{false};\n-    std::set<uint256> setKnown;\n     int64_t nNextAddrSend GUARDED_BY(cs_sendProcessing){0};\n     int64_t nNextLocalAddrSend GUARDED_BY(cs_sendProcessing){0};\n \n-    // inventory based relay\n-    CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_inventory);\n-    // Set of transaction ids we still have to announce.\n-    // They are sorted by the mempool before relay, so the order is not important.\n-    std::set<uint256> setInventoryTxToSend;\n+    const bool m_addr_relay_peer;\n+    bool IsAddrRelayPeer() const { return m_addr_relay_peer; }\n+\n     // List of block ids we still have announce.\n     // There is no final sorting before sending, as they are always sent immediately\n     // and in the order requested.\n     std::vector<uint256> vInventoryBlockToSend GUARDED_BY(cs_inventory);\n     CCriticalSection cs_inventory;\n-    int64_t nNextInvSend{0};\n+\n+    struct TxRelay {\n+        TxRelay() { pfilter = MakeUnique<CBloomFilter>(); }\n+        mutable CCriticalSection cs_filter;\n+        // We use fRelayTxes for two purposes -\n+        // a) it allows us to not relay tx invs before receiving the peer's version message\n+        // b) the peer may tell us in its version message that we should not relay tx invs\n+        //    unless it loads a bloom filter.\n+        bool fRelayTxes GUARDED_BY(cs_filter){false};\n+        std::unique_ptr<CBloomFilter> pfilter PT_GUARDED_BY(cs_filter);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r315589541",
      "id" : 315589541,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNTU4OTU0MQ==",
      "original_commit_id" : "69621136f51c547e22bf6a095cbcd2edabb195f5",
      "original_position" : 135,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 276960566,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315589541",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r315590970"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315590970"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I could see `bool IsBlocksOnly() const { return !m_tx_relay; }` being a bit easier to follow, but otherwise thing the way it is is fine. `unique_ptr` saves memory compared to `boost::optional` so seems the right choice between those two.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-20T09:24:41Z",
      "diff_hunk" : "@@ -725,6 +725,7 @@ class CNode\n         int64_t nextSendTimeFeeFilter{0};\n     };\n \n+    // m_tx_relay == nullptr if we're not relaying transactions with this peer",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r315590970",
      "id" : 315590970,
      "in_reply_to_id" : 310366329,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNTU5MDk3MA==",
      "original_commit_id" : "c496ae11cf96bf37dc6e650e6d35c4b635df720e",
      "original_position" : 4,
      "path" : "src/net.h",
      "position" : 161,
      "pull_request_review_id" : 276960566,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315590970",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r315608535"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315608535"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Would be nice to have the same behaviour for all the invalid-on-blocksonly-connections messages; whether ignoring it, logging it, or an immediate disconnect...",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-20T10:05:15Z",
      "diff_hunk" : "@@ -3091,12 +3100,12 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n             LOCK(cs_main);\n             Misbehaving(pfrom->GetId(), 100);\n         }\n-        else\n+        else if (pfrom->m_tx_relay != nullptr)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r315608535",
      "id" : 315608535,
      "in_reply_to_id" : 313588220,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNTYwODUzNQ==",
      "original_commit_id" : "aff2a198276f1659a096403cf17e919a103f806b",
      "original_position" : 133,
      "path" : "src/net_processing.cpp",
      "position" : 204,
      "pull_request_review_id" : 276960566,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315608535",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ajtowns \r\n\r\n> This doesn't actually seem to work right? I'm seeing:\r\n> \r\n> ```\r\n> 2019-08-20T12:06:01Z receive version message: /Satoshi:0.18.0/: version 70015, b\r\n> locks=590955, us=XXX, peer=11\r\n> 2019-08-20T12:06:01Z New outbound peer connected: version: 70015, blocks=590955, blocks-only=true, feeler=false, peer=11\r\n> \r\n> 2019-08-20T12:06:04Z got inv: tx 9c42701fa9e819f9a858c0805058de2bd53a20e4f82f2a7539a3521dbb659ed8  have peer=11\r\n> 2019-08-20T12:06:04Z got inv: tx 21a2a8e8940b0a066ad061afabcf6ce47e2e09d59620a0138e83b308cfb20dca  new peer=11\r\n> \r\n> 2019-08-20T12:06:04Z Requesting witness-tx 21a2a8e8940b0a066ad061afabcf6ce47e2e09d59620a0138e83b308cfb20dca peer=11\r\n> ```\r\n> \r\n> I guess `bool fBlocksOnly = !g_relay_txes` in `ProcessMessage()` should have an `|| !pfrom->m_tx_relay` ? Possibly the same thing in the `strCommand == NetMsgType::TX` block?\r\n\r\nThanks, that is a good catch -- the intention was for peers violating blocks-only mode to be disconnected, as you suggest.  I'll push a fix.  **EDIT**: Actually, it appears that we do not disconnect peers from sending us tx inv's if we're running in -blocksonly mode, as I thought we did.  I think we should, as the whole point is to reduce bandwidth in -blocksonly mode, but this will be a behavior change.\r\n\r\nAs an aside, I think I've occasionally seen this behavior from other peers myself where blocks-only connections still result in our peer sending us inv's.  I have never been able to reproduce with Bitcoin Core, but it does make me wonder if there might be some kind of rare bug where the blocks-only field is somehow ignored?",
      "created_at" : "2019-08-20T12:35:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-522993706",
      "id" : 522993706,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyMjk5MzcwNg==",
      "updated_at" : "2019-08-20T12:41:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/522993706",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r315673131"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315673131"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah this was the question I raised above -- we currently protect 4 of our outbound peers from this logic anyway.  So this PR changes that to 6 and always includes these blocks-only peers.  Protecting some peers at all from this logic is just belt-and-suspenders prevention of some kind of cascading failure, so it's not clear to me how to think about changing the logic, whether I should include these blocks-only peers in the protected set or not?\r\n\r\nOne advantage to protecting them is that it simplifies the reasoning over how to connect to a new peer when connecting to an extra outbound peer if the tip hasn't advanced in a while -- right now, we always connect as a full-relay peer, and then we evict one of our full-relay peers.  If we don't protect the blocks-only peers, this logic will be more annoying to write.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-20T12:58:57Z",
      "diff_hunk" : "@@ -756,11 +756,11 @@ void UpdateLastBlockAnnounceTime(NodeId node, int64_t time_in_seconds)\n     if (state) state->m_last_block_announcement = time_in_seconds;\n }\n \n-// Returns true for outbound peers, excluding manual connections, feelers, and\n-// one-shots\n+// Returns true for outbound full-relay peers, excluding manual\n+// connections, feelers, one-shots, and blocks-only connections\n static bool IsOutboundDisconnectionCandidate(const CNode *node)\n {\n-    return !(node->fInbound || node->m_manual_connection || node->fFeeler || node->fOneShot);\n+    return !(node->fInbound || node->m_manual_connection || node->fFeeler || node->fOneShot || node->m_tx_relay == nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r315673131",
      "id" : 315673131,
      "in_reply_to_id" : 315529341,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNTY3MzEzMQ==",
      "original_commit_id" : "69621136f51c547e22bf6a095cbcd2edabb195f5",
      "original_position" : 20,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 277145674,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315673131",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r315674163"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315674163"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I concluded this as well, but figured I'd save that simplification for a later PR to avoid complicating the reasoning here.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-20T13:01:03Z",
      "diff_hunk" : "@@ -703,28 +703,51 @@ class CNode\n     std::vector<CAddress> vAddrToSend;\n     CRollingBloomFilter addrKnown;\n     bool fGetAddr{false};\n-    std::set<uint256> setKnown;\n     int64_t nNextAddrSend GUARDED_BY(cs_sendProcessing){0};\n     int64_t nNextLocalAddrSend GUARDED_BY(cs_sendProcessing){0};\n \n-    // inventory based relay\n-    CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_inventory);\n-    // Set of transaction ids we still have to announce.\n-    // They are sorted by the mempool before relay, so the order is not important.\n-    std::set<uint256> setInventoryTxToSend;\n+    const bool m_addr_relay_peer;\n+    bool IsAddrRelayPeer() const { return m_addr_relay_peer; }\n+\n     // List of block ids we still have announce.\n     // There is no final sorting before sending, as they are always sent immediately\n     // and in the order requested.\n     std::vector<uint256> vInventoryBlockToSend GUARDED_BY(cs_inventory);\n     CCriticalSection cs_inventory;\n-    int64_t nNextInvSend{0};\n+\n+    struct TxRelay {\n+        TxRelay() { pfilter = MakeUnique<CBloomFilter>(); }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r315674163",
      "id" : 315674163,
      "in_reply_to_id" : 315587687,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNTY3NDE2Mw==",
      "original_commit_id" : "69621136f51c547e22bf6a095cbcd2edabb195f5",
      "original_position" : 128,
      "path" : "src/net.h",
      "position" : 134,
      "pull_request_review_id" : 277146966,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315674163",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r316360827"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/316360827"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Seems reasonable. Perhaps also add a comment explaining that all blocks_only peers are outbound, so this check is currently redundant.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-21T19:22:20Z",
      "diff_hunk" : "@@ -2989,6 +2999,10 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n             LogPrint(BCLog::NET, \"Ignoring \\\"getaddr\\\" from outbound connection. peer=%d\\n\", pfrom->GetId());\n             return true;\n         }\n+        if (!pfrom->IsAddrRelayPeer()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r316360827",
      "id" : 316360827,
      "in_reply_to_id" : 314860750,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNjM2MDgyNw==",
      "original_commit_id" : "69621136f51c547e22bf6a095cbcd2edabb195f5",
      "original_position" : 128,
      "path" : "src/net_processing.cpp",
      "position" : 179,
      "pull_request_review_id" : 278019996,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/316360827",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Ignoring the inv's (so we don't send getdata and don't receive the tx back) is already a bandwidth saving, and prevents revealing the topology, so maybe just maintain that behaviour for this PR, rather than dropping the connection?\r\n\r\nI think dropping the connection does make sense though. Seems more likely that the observed misbehaviour in the wild is just due to spy nodes not having implemented blocks-only connections, than an obscure bug in bitcoin 0.18 to me. Not that it couldn't be both, of course!",
      "created_at" : "2019-08-22T03:37:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-523733587",
      "id" : 523733587,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyMzczMzU4Nw==",
      "updated_at" : "2019-08-22T03:37:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/523733587",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r316492044"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/316492044"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Yeah this was the question I raised above\r\n\r\n([Link](https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-500999863) for anyone playing along at home)\r\n\r\nHmm, `m_protect` only applies to `ConsiderEviction` not the `nMinimumChainWork` check, if I'm reading this right, so this makes blocks only peers more protected from eviction than the normal protected outbound peers?\r\n\r\nMaybe adding `if (::g_relay_txes && pto->m_tx_relay == nulltr) return;` after the `m_protect` check in `EvictExtraOutboundPeers` would work as an alternative to changing `IsOutboundDisconnectionCandidate`?\r\n\r\n(Actually, I think we have to retain `pto->m_tx_relay != nullptr` for the initial 8 outbounds even when `g_relay_txes == false` or the way we count normal outbounds vs the extra blocks only ones will be wrong, so the `g_relay_txes` test above is redundant)",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-22T04:27:16Z",
      "diff_hunk" : "@@ -756,11 +756,11 @@ void UpdateLastBlockAnnounceTime(NodeId node, int64_t time_in_seconds)\n     if (state) state->m_last_block_announcement = time_in_seconds;\n }\n \n-// Returns true for outbound peers, excluding manual connections, feelers, and\n-// one-shots\n+// Returns true for outbound full-relay peers, excluding manual\n+// connections, feelers, one-shots, and blocks-only connections\n static bool IsOutboundDisconnectionCandidate(const CNode *node)\n {\n-    return !(node->fInbound || node->m_manual_connection || node->fFeeler || node->fOneShot);\n+    return !(node->fInbound || node->m_manual_connection || node->fFeeler || node->fOneShot || node->m_tx_relay == nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r316492044",
      "id" : 316492044,
      "in_reply_to_id" : 315529341,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNjQ5MjA0NA==",
      "original_commit_id" : "69621136f51c547e22bf6a095cbcd2edabb195f5",
      "original_position" : 20,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 278185130,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/316492044",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r318337804"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/318337804"
         }
      },
      "author_association" : "NONE",
      "body" : "Can the constructor's initializer list be used here for member initialization?",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-27T23:28:15Z",
      "diff_hunk" : "@@ -706,24 +699,43 @@ class CNode\n     int64_t nNextAddrSend GUARDED_BY(cs_sendProcessing){0};\n     int64_t nNextLocalAddrSend GUARDED_BY(cs_sendProcessing){0};\n \n-    // inventory based relay\n-    CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_inventory);\n-    // Set of transaction ids we still have to announce.\n-    // They are sorted by the mempool before relay, so the order is not important.\n-    std::set<uint256> setInventoryTxToSend;\n     // List of block ids we still have announce.\n     // There is no final sorting before sending, as they are always sent immediately\n     // and in the order requested.\n     std::vector<uint256> vInventoryBlockToSend GUARDED_BY(cs_inventory);\n     CCriticalSection cs_inventory;\n-    int64_t nNextInvSend{0};\n+\n+    struct TxRelay {\n+        TxRelay() { pfilter = MakeUnique<CBloomFilter>(); }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r318337804",
      "id" : 318337804,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxODMzNzgwNA==",
      "original_commit_id" : "8fb2d9f10cd1c4498a2e1c6813f17253735fd255",
      "original_position" : 33,
      "path" : "src/net.h",
      "position" : 134,
      "pull_request_review_id" : 280523044,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/318337804",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4015903?v=4",
         "events_url" : "https://api.github.com/users/jkczyz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jkczyz/followers",
         "following_url" : "https://api.github.com/users/jkczyz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jkczyz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jkczyz",
         "id" : 4015903,
         "login" : "jkczyz",
         "node_id" : "MDQ6VXNlcjQwMTU5MDM=",
         "organizations_url" : "https://api.github.com/users/jkczyz/orgs",
         "received_events_url" : "https://api.github.com/users/jkczyz/received_events",
         "repos_url" : "https://api.github.com/users/jkczyz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jkczyz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jkczyz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jkczyz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r318345109"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/318345109"
         }
      },
      "author_association" : "NONE",
      "body" : "Likewise, can this be initialized in the above initializer list? It's unclear to me why this and the above members are not initialized there like the other members.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-28T00:03:41Z",
      "diff_hunk" : "@@ -2633,6 +2633,7 @@ CNode::CNode(NodeId idIn, ServiceFlags nLocalServicesIn, int nMyStartingHeightIn\n     hSocket = hSocketIn;\n     addrName = addrNameIn == \"\" ? addr.ToStringIPPort() : addrNameIn;\n     hashContinue = uint256();\n+    m_tx_relay = MakeUnique<TxRelay>();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r318345109",
      "id" : 318345109,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxODM0NTEwOQ==",
      "original_commit_id" : "4914f153b566b74bc497136627a6f90017379d05",
      "original_position" : 40,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 280523044,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/318345109",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4015903?v=4",
         "events_url" : "https://api.github.com/users/jkczyz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jkczyz/followers",
         "following_url" : "https://api.github.com/users/jkczyz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jkczyz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jkczyz",
         "id" : 4015903,
         "login" : "jkczyz",
         "node_id" : "MDQ6VXNlcjQwMTU5MDM=",
         "organizations_url" : "https://api.github.com/users/jkczyz/orgs",
         "received_events_url" : "https://api.github.com/users/jkczyz/received_events",
         "repos_url" : "https://api.github.com/users/jkczyz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jkczyz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jkczyz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jkczyz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r318346641"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/318346641"
         }
      },
      "author_association" : "NONE",
      "body" : "Consider naming `peer_has_bloom_filter` or something similarly readable corresponding to the member `fBloomFilter`.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-28T00:12:24Z",
      "diff_hunk" : "@@ -818,11 +818,17 @@ bool CConnman::AttemptToEvictConnection()\n                 continue;\n             if (node->fDisconnect)\n                 continue;\n-            LOCK(node->m_tx_relay->cs_filter);\n+            bool peer_relay_txes = false;\n+            bool peer_filter_not_null = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r318346641",
      "id" : 318346641,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxODM0NjY0MQ==",
      "original_commit_id" : "90ef0a6ef46a5321f3178cafd62446d090257a2e",
      "original_position" : 24,
      "path" : "src/net.cpp",
      "position" : 54,
      "pull_request_review_id" : 280523044,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/318346641",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4015903?v=4",
         "events_url" : "https://api.github.com/users/jkczyz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jkczyz/followers",
         "following_url" : "https://api.github.com/users/jkczyz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jkczyz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jkczyz",
         "id" : 4015903,
         "login" : "jkczyz",
         "node_id" : "MDQ6VXNlcjQwMTU5MDM=",
         "organizations_url" : "https://api.github.com/users/jkczyz/orgs",
         "received_events_url" : "https://api.github.com/users/jkczyz/received_events",
         "repos_url" : "https://api.github.com/users/jkczyz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jkczyz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jkczyz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jkczyz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r318658832"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/318658832"
         }
      },
      "author_association" : "NONE",
      "body" : "Agreed here regarding `IsBlocksOnly`. Would also make future updates simpler given the number of times the check is performed.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-28T15:50:12Z",
      "diff_hunk" : "@@ -725,6 +725,7 @@ class CNode\n         int64_t nextSendTimeFeeFilter{0};\n     };\n \n+    // m_tx_relay == nullptr if we're not relaying transactions with this peer",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r318658832",
      "id" : 318658832,
      "in_reply_to_id" : 310366329,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxODY1ODgzMg==",
      "original_commit_id" : "c496ae11cf96bf37dc6e650e6d35c4b635df720e",
      "original_position" : 4,
      "path" : "src/net.h",
      "position" : 161,
      "pull_request_review_id" : 280523044,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/318658832",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4015903?v=4",
         "events_url" : "https://api.github.com/users/jkczyz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jkczyz/followers",
         "following_url" : "https://api.github.com/users/jkczyz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jkczyz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jkczyz",
         "id" : 4015903,
         "login" : "jkczyz",
         "node_id" : "MDQ6VXNlcjQwMTU5MDM=",
         "organizations_url" : "https://api.github.com/users/jkczyz/orgs",
         "received_events_url" : "https://api.github.com/users/jkczyz/received_events",
         "repos_url" : "https://api.github.com/users/jkczyz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jkczyz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jkczyz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jkczyz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r318664698"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/318664698"
         }
      },
      "author_association" : "NONE",
      "body" : "This may be a sign that the interface for `OpenNetworkConnection` needs to be rethought, given the way booleans are piped through different functions. Though this is probably outside the scope of the PR.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-28T16:01:40Z",
      "diff_hunk" : "@@ -1827,7 +1832,14 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n                 LogPrint(BCLog::NET, \"Making feeler connection to %s\\n\", addrConnect.ToString());\n             }\n \n-            OpenNetworkConnection(addrConnect, (int)setConnected.size() >= std::min(nMaxConnections - 1, 2), &grant, nullptr, false, fFeeler);\n+            // Open this connection as blocks-only if we're already at our\n+            // full-relay capacity, but not yet at our blocks-only peer limit.\n+            // (It should not be possible for fFeeler to be set if we're not\n+            // also at our blocks-only peer limit, but check against that as\n+            // well for sanity.)\n+            bool blocks_only = nOutboundBlocksOnly < m_max_outbound_blocks_only && !fFeeler && nOutboundFullRelay >= m_max_outbound_full_relay;\n+\n+            OpenNetworkConnection(addrConnect, (int)setConnected.size() >= std::min(nMaxConnections - 1, 2), &grant, nullptr, false, fFeeler, false, blocks_only);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r318664698",
      "id" : 318664698,
      "in_reply_to_id" : 314380402,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxODY2NDY5OA==",
      "original_commit_id" : "4e6a635f4ea3c1a6a026877e561e7671ac00b449",
      "original_position" : 80,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 280523044,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/318664698",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4015903?v=4",
         "events_url" : "https://api.github.com/users/jkczyz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jkczyz/followers",
         "following_url" : "https://api.github.com/users/jkczyz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jkczyz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jkczyz",
         "id" : 4015903,
         "login" : "jkczyz",
         "node_id" : "MDQ6VXNlcjQwMTU5MDM=",
         "organizations_url" : "https://api.github.com/users/jkczyz/orgs",
         "received_events_url" : "https://api.github.com/users/jkczyz/received_events",
         "repos_url" : "https://api.github.com/users/jkczyz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jkczyz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jkczyz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jkczyz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r318784136"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/318784136"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Seems like a style preference -- I don't see any harm the way I've written it, so will leave as-is.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-28T20:46:06Z",
      "diff_hunk" : "@@ -706,24 +699,43 @@ class CNode\n     int64_t nNextAddrSend GUARDED_BY(cs_sendProcessing){0};\n     int64_t nNextLocalAddrSend GUARDED_BY(cs_sendProcessing){0};\n \n-    // inventory based relay\n-    CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_inventory);\n-    // Set of transaction ids we still have to announce.\n-    // They are sorted by the mempool before relay, so the order is not important.\n-    std::set<uint256> setInventoryTxToSend;\n     // List of block ids we still have announce.\n     // There is no final sorting before sending, as they are always sent immediately\n     // and in the order requested.\n     std::vector<uint256> vInventoryBlockToSend GUARDED_BY(cs_inventory);\n     CCriticalSection cs_inventory;\n-    int64_t nNextInvSend{0};\n+\n+    struct TxRelay {\n+        TxRelay() { pfilter = MakeUnique<CBloomFilter>(); }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r318784136",
      "id" : 318784136,
      "in_reply_to_id" : 318337804,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxODc4NDEzNg==",
      "original_commit_id" : "8fb2d9f10cd1c4498a2e1c6813f17253735fd255",
      "original_position" : 33,
      "path" : "src/net.h",
      "position" : 134,
      "pull_request_review_id" : 281092623,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/318784136",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r318784700"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/318784700"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is in preparation for eventually not initializing this, in some cases.  Again I think this is a code-style preference and there's nothing wrong with this (intermediate) commit, so will leave as-is.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-28T20:47:29Z",
      "diff_hunk" : "@@ -2633,6 +2633,7 @@ CNode::CNode(NodeId idIn, ServiceFlags nLocalServicesIn, int nMyStartingHeightIn\n     hSocket = hSocketIn;\n     addrName = addrNameIn == \"\" ? addr.ToStringIPPort() : addrNameIn;\n     hashContinue = uint256();\n+    m_tx_relay = MakeUnique<TxRelay>();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r318784700",
      "id" : 318784700,
      "in_reply_to_id" : 318345109,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxODc4NDcwMA==",
      "original_commit_id" : "4914f153b566b74bc497136627a6f90017379d05",
      "original_position" : 40,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 281092623,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/318784700",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r318786166"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/318786166"
         }
      },
      "author_association" : "MEMBER",
      "body" : "IMO an explicit nullptr check in the places in the code where we're about to dereference makes more sense than only using an `IsBlocksOnly()` function, where it's less clear to the reader whether a null-dereference could happen.  This happens in a lot of places, so I plan to leave many of the `== nullptr` checks.\r\n\r\nThere are a couple places in the code where we logically only care whether the peer is a block-relay-only peer, where something like this might be nice; but given the other usages of the `nullptr` comparisons, I'd prefer to not have two ways to check for this condition, so will leave as-is.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-28T20:51:10Z",
      "diff_hunk" : "@@ -725,6 +725,7 @@ class CNode\n         int64_t nextSendTimeFeeFilter{0};\n     };\n \n+    // m_tx_relay == nullptr if we're not relaying transactions with this peer",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r318786166",
      "id" : 318786166,
      "in_reply_to_id" : 310366329,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxODc4NjE2Ng==",
      "original_commit_id" : "c496ae11cf96bf37dc6e650e6d35c4b635df720e",
      "original_position" : 4,
      "path" : "src/net.h",
      "position" : 161,
      "pull_request_review_id" : 281092623,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/318786166",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r318801572"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/318801572"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-28T21:30:02Z",
      "diff_hunk" : "@@ -703,28 +703,51 @@ class CNode\n     std::vector<CAddress> vAddrToSend;\n     CRollingBloomFilter addrKnown;\n     bool fGetAddr{false};\n-    std::set<uint256> setKnown;\n     int64_t nNextAddrSend GUARDED_BY(cs_sendProcessing){0};\n     int64_t nNextLocalAddrSend GUARDED_BY(cs_sendProcessing){0};\n \n-    // inventory based relay\n-    CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_inventory);\n-    // Set of transaction ids we still have to announce.\n-    // They are sorted by the mempool before relay, so the order is not important.\n-    std::set<uint256> setInventoryTxToSend;\n+    const bool m_addr_relay_peer;\n+    bool IsAddrRelayPeer() const { return m_addr_relay_peer; }\n+\n     // List of block ids we still have announce.\n     // There is no final sorting before sending, as they are always sent immediately\n     // and in the order requested.\n     std::vector<uint256> vInventoryBlockToSend GUARDED_BY(cs_inventory);\n     CCriticalSection cs_inventory;\n-    int64_t nNextInvSend{0};\n+\n+    struct TxRelay {\n+        TxRelay() { pfilter = MakeUnique<CBloomFilter>(); }\n+        mutable CCriticalSection cs_filter;\n+        // We use fRelayTxes for two purposes -\n+        // a) it allows us to not relay tx invs before receiving the peer's version message\n+        // b) the peer may tell us in its version message that we should not relay tx invs\n+        //    unless it loads a bloom filter.\n+        bool fRelayTxes GUARDED_BY(cs_filter){false};\n+        std::unique_ptr<CBloomFilter> pfilter PT_GUARDED_BY(cs_filter);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r318801572",
      "id" : 318801572,
      "in_reply_to_id" : 315589541,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxODgwMTU3Mg==",
      "original_commit_id" : "69621136f51c547e22bf6a095cbcd2edabb195f5",
      "original_position" : 135,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 281114406,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/318801572",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r318801763"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/318801763"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this is better now.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-28T21:30:37Z",
      "diff_hunk" : "@@ -756,11 +756,11 @@ void UpdateLastBlockAnnounceTime(NodeId node, int64_t time_in_seconds)\n     if (state) state->m_last_block_announcement = time_in_seconds;\n }\n \n-// Returns true for outbound peers, excluding manual connections, feelers, and\n-// one-shots\n+// Returns true for outbound full-relay peers, excluding manual\n+// connections, feelers, one-shots, and blocks-only connections\n static bool IsOutboundDisconnectionCandidate(const CNode *node)\n {\n-    return !(node->fInbound || node->m_manual_connection || node->fFeeler || node->fOneShot);\n+    return !(node->fInbound || node->m_manual_connection || node->fFeeler || node->fOneShot || node->m_tx_relay == nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r318801763",
      "id" : 318801763,
      "in_reply_to_id" : 315529341,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxODgwMTc2Mw==",
      "original_commit_id" : "69621136f51c547e22bf6a095cbcd2edabb195f5",
      "original_position" : 20,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 281114668,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/318801763",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r318801988"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/318801988"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Improving this was below my bar for necessary changes with my last rework, so I have not addressed this (and may not).",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-28T21:31:21Z",
      "diff_hunk" : "@@ -2989,6 +2999,10 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n             LogPrint(BCLog::NET, \"Ignoring \\\"getaddr\\\" from outbound connection. peer=%d\\n\", pfrom->GetId());\n             return true;\n         }\n+        if (!pfrom->IsAddrRelayPeer()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r318801988",
      "id" : 318801988,
      "in_reply_to_id" : 314860750,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxODgwMTk4OA==",
      "original_commit_id" : "69621136f51c547e22bf6a095cbcd2edabb195f5",
      "original_position" : 128,
      "path" : "src/net_processing.cpp",
      "position" : 179,
      "pull_request_review_id" : 281114976,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/318801988",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Added a commit where we go ahead and disconnect such peers\r\n\r\nNeed to update p2p_blocksonly test to match this behaviour change I think",
      "created_at" : "2019-08-29T01:05:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-525979364",
      "id" : 525979364,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNTk3OTM2NA==",
      "updated_at" : "2019-08-29T01:05:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/525979364",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r319145866"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/319145866"
         }
      },
      "author_association" : "NONE",
      "body" : "FWIW, `pfilter` is initialized first then reset here whereas when using the initializer list syntax it is simply initialized to the value you give it. Using the initializer syntax is considered safer as there is no risk of accessing an uninitialized member. Additionally, it allows you to make members `const` where appropriate.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-08-29T15:51:45Z",
      "diff_hunk" : "@@ -706,24 +699,43 @@ class CNode\n     int64_t nNextAddrSend GUARDED_BY(cs_sendProcessing){0};\n     int64_t nNextLocalAddrSend GUARDED_BY(cs_sendProcessing){0};\n \n-    // inventory based relay\n-    CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_inventory);\n-    // Set of transaction ids we still have to announce.\n-    // They are sorted by the mempool before relay, so the order is not important.\n-    std::set<uint256> setInventoryTxToSend;\n     // List of block ids we still have announce.\n     // There is no final sorting before sending, as they are always sent immediately\n     // and in the order requested.\n     std::vector<uint256> vInventoryBlockToSend GUARDED_BY(cs_inventory);\n     CCriticalSection cs_inventory;\n-    int64_t nNextInvSend{0};\n+\n+    struct TxRelay {\n+        TxRelay() { pfilter = MakeUnique<CBloomFilter>(); }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r319145866",
      "id" : 319145866,
      "in_reply_to_id" : 318337804,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxOTE0NTg2Ng==",
      "original_commit_id" : "8fb2d9f10cd1c4498a2e1c6813f17253735fd255",
      "original_position" : 33,
      "path" : "src/net.h",
      "position" : 134,
      "pull_request_review_id" : 281557816,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/319145866",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4015903?v=4",
         "events_url" : "https://api.github.com/users/jkczyz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jkczyz/followers",
         "following_url" : "https://api.github.com/users/jkczyz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jkczyz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jkczyz",
         "id" : 4015903,
         "login" : "jkczyz",
         "node_id" : "MDQ6VXNlcjQwMTU5MDM=",
         "organizations_url" : "https://api.github.com/users/jkczyz/orgs",
         "received_events_url" : "https://api.github.com/users/jkczyz/received_events",
         "repos_url" : "https://api.github.com/users/jkczyz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jkczyz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jkczyz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jkczyz"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Fixed the `p2p_blocksonly.py` test to match the new behavior.",
      "created_at" : "2019-08-29T18:45:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-526312873",
      "id" : 526312873,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNjMxMjg3Mw==",
      "updated_at" : "2019-08-29T18:45:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/526312873",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : ">     * I don't fully understand the reasoning behind the _Don't relay addr messages to block-relay-only peers_.\r\n\r\nI think I get this now.\r\n\r\nI think the logic is that tx relay will allow an attacker to identify our tx relay peers, attack them, and eventually control all our tx relay connections; but if that happens we'll still relay blocks via our block relay connections. What we don't want is for the addr messages to potentially reveal which nodes we've selected for block relay to the attacker who by now controls all our other peers.\r\n\r\nHowever an attacker that's connected to a large proportion of the entire network can identify your peers (or near-peers) by sending tainted addresses to you -- you then tell them to your peers and those peers then report back to the attacker identifying themselves. The patch here stops you from reporting tainted addresses from your blocks only peer (you ignore ADDR messages from them and won't send a GETADDR message), and stops you sending potentially tainted addresses to your blocks only peers (you don't choose them as the best peer in RelayAddress and even if you did you won't send addr messages to them in SendMessages).\r\n\r\nI think this might degrade addr connectivity a little bit though -- RelayAddress won't choose your block-relay outbound connection, but it might choose an inbound peer that thinks of you as a block-relay connection, so will drop your messages into the void. If this change is widely deployed, this will be 20% of your inbound connections (or more if we eventually go from 8+2 to 8+8 or similar), so could be significant. I think since we AdvertiseLocal regularly to our non-block-relay peers, we could just set a flag on the peer if we've ever seen an ADDR message from them, and only choose nodes with that flag in RelayAddress?",
      "created_at" : "2019-09-02T05:59:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-527012757",
      "id" : 527012757,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNzAxMjc1Nw==",
      "updated_at" : "2019-09-02T05:59:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/527012757",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r319816662"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/319816662"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This doesn't match the `fBlocksOnly` test for `::INV` -- if it did it would be:\r\n\r\n```\r\n((!g_relay_txes || pfrom->m_tx_relay == nullptr) && !pfrom->HasPermission(PF_RELAY))\r\n```\r\n\r\nI think the logic here is probably better, though maybe there should be a check to prevent choosing a node for blocks-relay if it would have PF_RELAY perms?",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-09-02T06:12:38Z",
      "diff_hunk" : "@@ -2470,9 +2485,11 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     if (strCommand == NetMsgType::TX) {\n         // Stop processing the transaction early if\n         // We are in blocks only mode and peer is either not whitelisted or whitelistrelay is off\n-        if (!g_relay_txes && !pfrom->HasPermission(PF_RELAY))\n+        // or if this peer is supposed to be a block-relay-only peer\n+        if ((!g_relay_txes && !pfrom->HasPermission(PF_RELAY)) || (pfrom->m_tx_relay == nullptr))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r319816662",
      "id" : 319816662,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxOTgxNjY2Mg==",
      "original_commit_id" : "b21b291075fd65b46a252333d88d3ddffbfe5435",
      "original_position" : 168,
      "path" : "src/net_processing.cpp",
      "position" : 168,
      "pull_request_review_id" : 282414512,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/319816662",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I think this might degrade addr connectivity a little bit though -- RelayAddress won't choose your block-relay outbound connection, but it might choose an inbound peer that thinks of you as a block-relay connection, so will drop your messages into the void. If this change is widely deployed, this will be 20% of your inbound connections (or more if we eventually go from 8+2 to 8+8 or similar), so could be significant. I think since we AdvertiseLocal regularly to our non-block-relay peers, we could just set a flag on the peer if we've ever seen an ADDR message from them, and only choose nodes with that flag in RelayAddress?\r\n\r\nI think the addr relay logic may need an overhaul, but I think the change made here is minor -- as I understand it, since we relay addr messages by choosing among all our inbounds as potential next hops, there's likely already a black-hole problem where light clients, spy nodes, adversaries, etc may be receiving addr messages and not propagating them further.\r\n\r\nSo adding 2 extra inbounds that don't participate in addr propagation should be a relatively minor effect. I just checked one of my listening nodes running a recent release of Bitcoin Core, and observed that out of 46 total connections, 18 have never sent me an addr message, and 24 have never sent me a getaddr message.  I would surmise that at least those 18-24 peers do not participate in addr relay (and possibly more)...  So I think the 20% estimate of addr-relay-degradation due to this PR is a large overestimate.\r\n\r\nI do think your suggestion is likely to be some kind of an improvement (at least in the non-adversarial case) but I'd prefer to defer addr-relay improvements to a future PR.",
      "created_at" : "2019-09-03T13:59:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-527470881",
      "id" : 527470881,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyNzQ3MDg4MQ==",
      "updated_at" : "2019-09-03T13:59:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/527470881",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r320294514"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/320294514"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I believe it's impossible for an outbound peer to be whitelisted and have PF_RELAY permissions, so these are the same...",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-09-03T14:12:40Z",
      "diff_hunk" : "@@ -2470,9 +2485,11 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     if (strCommand == NetMsgType::TX) {\n         // Stop processing the transaction early if\n         // We are in blocks only mode and peer is either not whitelisted or whitelistrelay is off\n-        if (!g_relay_txes && !pfrom->HasPermission(PF_RELAY))\n+        // or if this peer is supposed to be a block-relay-only peer\n+        if ((!g_relay_txes && !pfrom->HasPermission(PF_RELAY)) || (pfrom->m_tx_relay == nullptr))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r320294514",
      "id" : 320294514,
      "in_reply_to_id" : 319816662,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyMDI5NDUxNA==",
      "original_commit_id" : "b21b291075fd65b46a252333d88d3ddffbfe5435",
      "original_position" : 168,
      "path" : "src/net_processing.cpp",
      "position" : 168,
      "pull_request_review_id" : 283024314,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/320294514",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r320300339"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/320300339"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think you're right; `HasPermission()` checks `m_permissionFlags` and the only way m_permissionFlags is anything but PF_NONE is via `AcceptConnection()`, so inbound only.",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-09-03T14:23:18Z",
      "diff_hunk" : "@@ -2470,9 +2485,11 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     if (strCommand == NetMsgType::TX) {\n         // Stop processing the transaction early if\n         // We are in blocks only mode and peer is either not whitelisted or whitelistrelay is off\n-        if (!g_relay_txes && !pfrom->HasPermission(PF_RELAY))\n+        // or if this peer is supposed to be a block-relay-only peer\n+        if ((!g_relay_txes && !pfrom->HasPermission(PF_RELAY)) || (pfrom->m_tx_relay == nullptr))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r320300339",
      "id" : 320300339,
      "in_reply_to_id" : 319816662,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyMDMwMDMzOQ==",
      "original_commit_id" : "b21b291075fd65b46a252333d88d3ddffbfe5435",
      "original_position" : 168,
      "path" : "src/net_processing.cpp",
      "position" : 168,
      "pull_request_review_id" : 283032051,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T18:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/320300339",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r320939154"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/320939154"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Note that this comment is incomplete, we'll stop processing *all* messages from this peer (including pongs, so we'll eventually disconnect them as well).",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-09-04T19:39:09Z",
      "diff_hunk" : "@@ -1512,6 +1512,11 @@ void static ProcessGetData(CNode* pfrom, const CChainParams& chainparams, CConnm\n     std::deque<CInv>::iterator it = pfrom->vRecvGetData.begin();\n     std::vector<CInv> vNotFound;\n     const CNetMsgMaker msgMaker(pfrom->GetSendVersion());\n+\n+    // Note that if we receive a getdata for a MSG_TX or MSG_WITNESS_TX from a\n+    // block-relay-only outbound peer, we will stop processing further getdata\n+    // messages from this peer (likely resulting in our peer eventually",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r320939154",
      "id" : 320939154,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyMDkzOTE1NA==",
      "original_commit_id" : "937eba91e1550bc3038dc541c236ac83e0a0e6d5",
      "original_position" : 7,
      "path" : "src/net_processing.cpp",
      "position" : 60,
      "pull_request_review_id" : 283849015,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T19:40:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/320939154",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "node_id" : "MDQ6VXNlcjY0OTI0Ng==",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r321001281"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/321001281"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree that we should update this comment (see https://github.com/bitcoin/bitcoin/pull/15759#discussion_r314786257)",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-09-04T22:25:07Z",
      "diff_hunk" : "@@ -1512,6 +1512,11 @@ void static ProcessGetData(CNode* pfrom, const CChainParams& chainparams, CConnm\n     std::deque<CInv>::iterator it = pfrom->vRecvGetData.begin();\n     std::vector<CInv> vNotFound;\n     const CNetMsgMaker msgMaker(pfrom->GetSendVersion());\n+\n+    // Note that if we receive a getdata for a MSG_TX or MSG_WITNESS_TX from a\n+    // block-relay-only outbound peer, we will stop processing further getdata\n+    // messages from this peer (likely resulting in our peer eventually",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r321001281",
      "id" : 321001281,
      "in_reply_to_id" : 320939154,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyMTAwMTI4MQ==",
      "original_commit_id" : "937eba91e1550bc3038dc541c236ac83e0a0e6d5",
      "original_position" : 7,
      "path" : "src/net_processing.cpp",
      "position" : 60,
      "pull_request_review_id" : 283928695,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-04T22:25:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/321001281",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r321895128"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/321895128"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Way easier to reason about than the first iteration of this change. :+1: ",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-09-06T20:18:45Z",
      "diff_hunk" : "@@ -1753,7 +1753,8 @@ bool AppInitMain(InitInterfaces& interfaces)\n     CConnman::Options connOptions;\n     connOptions.nLocalServices = nLocalServices;\n     connOptions.nMaxConnections = nMaxConnections;\n-    connOptions.nMaxOutbound = std::min(MAX_OUTBOUND_CONNECTIONS, connOptions.nMaxConnections);\n+    connOptions.m_max_outbound_full_relay = std::min(MAX_OUTBOUND_FULL_RELAY_CONNECTIONS, connOptions.nMaxConnections);\n+    connOptions.m_max_outbound_block_relay = std::min(MAX_BLOCKS_ONLY_CONNECTIONS, connOptions.nMaxConnections-connOptions.m_max_outbound_full_relay);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r321895128",
      "id" : 321895128,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMyMTg5NTEyOA==",
      "original_commit_id" : "3a5e885306ea954d7eccdc11502e91a51dab8ec6",
      "original_position" : 6,
      "path" : "src/init.cpp",
      "position" : 6,
      "pull_request_review_id" : 285079433,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "updated_at" : "2019-09-06T20:52:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/321895128",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2019-09-06T22:07:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-529030268",
      "id" : 529030268,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyOTAzMDI2OA==",
      "updated_at" : "2019-09-06T22:07:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/529030268",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK 0ba08020c9791f7caf5986ad6490c16a2b66cd83 -- code review, ran tests. ran it on mainnet for a couple of days with MAX_BLOCKS_ONLY_CONNECTIONS upped from 2 to 16 and didn't observe any unexpected behaviour: it disconnected a couple of peers that tried sending inv's, and it successfully did compact block relay with some block relay peers.",
      "created_at" : "2019-09-07T09:21:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-529090355",
      "id" : 529090355,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUyOTA5MDM1NQ==",
      "updated_at" : "2019-09-07T09:21:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/529090355",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Still needs release notes at https://github.com/bitcoin-core/bitcoin-devwiki/wiki/0.19.0-Release-Notes-Draft#p2p-changes",
      "created_at" : "2019-10-04T14:21:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-538418009",
      "id" : 538418009,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzODQxODAwOQ==",
      "updated_at" : "2019-10-04T14:21:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/538418009",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Maybe just copy-paste the section from the optech newsletter?",
      "created_at" : "2019-10-04T14:22:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-538418222",
      "id" : 538418222,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzODQxODIyMg==",
      "updated_at" : "2019-10-04T14:22:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/538418222",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@MarcoFalke I added a little text to that wiki page referencing this PR.",
      "created_at" : "2019-10-04T14:37:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-538424221",
      "id" : 538424221,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15759",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUzODQyNDIyMQ==",
      "updated_at" : "2019-10-04T14:37:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/538424221",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r838256965"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/838256965"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done in #21160",
      "commit_id" : "0ba08020c9791f7caf5986ad6490c16a2b66cd83",
      "created_at" : "2022-03-30T08:24:56Z",
      "diff_hunk" : "@@ -695,28 +693,50 @@ class CNode\n     std::vector<CAddress> vAddrToSend;\n     CRollingBloomFilter addrKnown;\n     bool fGetAddr{false};\n-    std::set<uint256> setKnown;\n     int64_t nNextAddrSend GUARDED_BY(cs_sendProcessing){0};\n     int64_t nNextLocalAddrSend GUARDED_BY(cs_sendProcessing){0};\n \n-    // inventory based relay\n-    CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_inventory);\n-    // Set of transaction ids we still have to announce.\n-    // They are sorted by the mempool before relay, so the order is not important.\n-    std::set<uint256> setInventoryTxToSend;\n+    const bool m_addr_relay_peer;\n+    bool IsAddrRelayPeer() const { return m_addr_relay_peer; }\n+\n     // List of block ids we still have announce.\n     // There is no final sorting before sending, as they are always sent immediately\n     // and in the order requested.\n     std::vector<uint256> vInventoryBlockToSend GUARDED_BY(cs_inventory);\n     CCriticalSection cs_inventory;\n-    int64_t nNextInvSend{0};\n+\n+    struct TxRelay {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15759#discussion_r838256965",
      "id" : 838256965,
      "in_reply_to_id" : 302248707,
      "line" : 724,
      "node_id" : "PRRC_kwDOABII584x9slF",
      "original_commit_id" : "32d8ac4ce6c2e594e464fec43045bc5b09384bfe",
      "original_line" : 724,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 133,
      "pull_request_review_id" : 925717325,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15759",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/838256965/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-30T08:24:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/838256965",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
