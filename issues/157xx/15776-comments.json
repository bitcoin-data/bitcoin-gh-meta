[
   {
      "author_association" : "MEMBER",
      "body" : "That seems like a potentially very bad bug.  However at first glance I don't see how `fPauseSend` could be implicated as a trigger; I don't believe we ever drop requests on the floor if the send buffer fills up, we just wait until the buffer drains and then continue as before. \r\n\r\nActually, I realize now that one way this could maybe trigger is if our peer sends a NOTFOUND in response to a getdata, I don't think we would reduce the in flight count (I think this is fixed in #15505 but this seems like a bug in 0.18).  So over time, as NOTFOUND's pile up, the in-flight queue would get full and we'd stop requesting transactions.  So we should definitely take some kind of fix for this, yikes.",
      "created_at" : "2019-04-09T12:36:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15776#issuecomment-481233023",
      "id" : 481233023,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15776",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MTIzMzAyMw==",
      "updated_at" : "2019-04-09T12:36:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/481233023",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#15505](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15505.html) ([p2p] Request NOTFOUND transactions immediately from other outbound peers, when possible by sdaftuar)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2019-04-09T12:45:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15776#issuecomment-481235677",
      "id" : 481235677,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15776",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MTIzNTY3Nw==",
      "updated_at" : "2019-04-09T12:45:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/481235677",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "We should perhaps disconnect a peer that is consistently getdata DOSing us...   If all your peers do that (for whatever reason) you're not going to gain txn, regardless of what happens with this.  So this fix only helps the case where a peer is randomly responding to some getdatas.\r\n\r\nThe fact that we'd stop asking for data from peers if they were not responding wasn't lost on me in the original changes, but this seemed like a good thing (I can't caught the notfound interaction, either through just missing it or due to havign 15505 on the brain).",
      "created_at" : "2019-04-09T18:16:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15776#issuecomment-481371247",
      "id" : 481371247,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15776",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MTM3MTI0Nw==",
      "updated_at" : "2019-04-09T18:16:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/481371247",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think we should do two things:\r\n(a) Fix the bug in NOTFOUND processing -- if a peer sends a NOTFOUND for a transaction, we should remove it from the in-flight map for that peer.  I think we should definitely do this and backport to 0.18.\r\n\r\n(b) As a safeguard, we should also do something if a peer's in-flight count hits the max so that we're not downloading new transactions from them.  I think there are two responses that make sense to me: either we eventually disconnect them, or we expire the in-flight entry and make room for a new request.  For 0.18,  I think expiry makes more sense, as it's more robust to other bugs that may be lurking in this new code.  Eventually, I think disconnection is where I expect things to go in the long-run (which is what we do for block getdata's that are dropped by the peer).\r\n\r\nAlso, I think I spotted another bug in this code related to emptying out the tx_in_flight set -- if a different peer serves us a transaction that we requested from another, then the entry doesn't get removed (upon receiving a TX message, we only erase from the delivering peer's in_flight set).  So a \"DoS\"er that helpfully blasted us with transactions would be able to blind us to transactions from our other peers.  The expiry solution would mitigate this, which is a point in its favor for merging into 0.18, but we should fix this too I think if we can do so easily.",
      "created_at" : "2019-04-09T18:19:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15776#issuecomment-481372232",
      "id" : 481372232,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15776",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MTM3MjIzMg==",
      "updated_at" : "2019-04-09T18:19:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/481372232",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> at first glance I don't see how `fPauseSend` could be implicated as a trigger\r\n\r\nYep, I think you're right.\r\n\r\n> Actually, I realize now that one way this could maybe trigger is if our peer sends a NOTFOUND in response to a getdata, I don't think we would reduce the in flight count\r\n\r\nRight; I think a plausible scenario is \"INV tx1, GETDATA tx1, TX tx1, oh I'm missing a parent for tx1, GETDATA tx1p, nope that's over 15m old and you're not doing MEMPOOL bloom filters, so NOTFOUND\" -- and I can duplicate that behaviour with real (regtest) nodes, too. Seems like it should mostly only happen in real life if you've just reconnected to the network after some time offline, and there's a reasonable backlog in the mempool (as otherwise parents that are older than 15m are probably already in a block)\r\n\r\nUpdated the PR to remove tx's from notfound messages from the inflight set and to disconnect (and log) any outbound peers whose inflight queue gets full despite that. Has test cases for for both scenarios.",
      "created_at" : "2019-04-10T10:17:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15776#issuecomment-481631275",
      "id" : 481631275,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15776",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MTYzMTI3NQ==",
      "updated_at" : "2019-04-10T10:17:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/481631275",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Also, I think I spotted another bug in this code related to emptying out the tx_in_flight set -- if a different peer serves us a transaction that we requested from another, then the entry doesn't get removed (upon receiving a TX message, we only erase from the delivering peer's in_flight set).\r\n\r\nMaybe I'm missing something, but I think this should be okay -- if it's added to in_flight then we've sent a GETDATA to that peer, and whether or not any other peer sends a TX message, that peer should send a TX or NOTFOUND message, at which point the entry's unconditionally removed from in_flight as on of the very first steps...",
      "created_at" : "2019-04-10T10:23:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15776#issuecomment-481633221",
      "id" : 481633221,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15776",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MTYzMzIyMQ==",
      "updated_at" : "2019-04-10T10:23:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/481633221",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15776#discussion_r274521787"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15776"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274521787"
         }
      },
      "author_association" : "MEMBER",
      "body" : "do these need to be added to the help text?",
      "commit_id" : "595b0402a5f89bda3b9a7805ee0ac285ec7fe579",
      "created_at" : "2019-04-11T16:52:36Z",
      "diff_hunk" : "@@ -178,6 +178,8 @@ static UniValue getpeerinfo(const JSONRPCRequest& request)\n             obj.pushKV(\"banscore\", statestats.nMisbehavior);\n             obj.pushKV(\"synced_headers\", statestats.nSyncHeight);\n             obj.pushKV(\"synced_blocks\", statestats.nCommonHeight);\n+            obj.pushKV(\"tx_inflight\", statestats.nTxInFlight);\n+            obj.pushKV(\"tx_process\", statestats.nTxProcess);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15776#discussion_r274521787",
      "id" : 274521787,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NDUyMTc4Nw==",
      "original_commit_id" : "12df73f5e362a59dd24db66f8001980c8d8a4667",
      "original_position" : 5,
      "path" : "src/rpc/net.cpp",
      "position" : 14,
      "pull_request_review_id" : 225658988,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15776",
      "updated_at" : "2019-04-17T05:14:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274521787",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/4360349?v=4",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "node_id" : "MDQ6VXNlcjQzNjAzNDk=",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think it's okay-- even preferable-- to not remove the tx when we get the tx from another peer. We should either get the tx or a not found or we should eventually stop requesting tx from that peer (e.g. because we disconnected them...)",
      "created_at" : "2019-04-11T19:05:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15776#issuecomment-482255437",
      "id" : 482255437,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15776",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MjI1NTQzNw==",
      "updated_at" : "2019-04-11T19:05:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/482255437",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15776#discussion_r274599063"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15776"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274599063"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit 392cf539756e2af6df5684c3444df626b446754f\r\n\r\nWhat is this adding? We generally don't add commented out code without rationale ",
      "commit_id" : "595b0402a5f89bda3b9a7805ee0ac285ec7fe579",
      "created_at" : "2019-04-11T19:07:30Z",
      "diff_hunk" : "@@ -3114,8 +3118,33 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     }\n \n     if (strCommand == NetMsgType::NOTFOUND) {\n-        // We do not care about the NOTFOUND message, but logging an Unknown Command\n-        // message would be undesirable as we transmit it ourselves.\n+        // NOTFOUND means we can clear the entry from the tx_in_flight/announced set\n+        std::vector<CInv> vInv;\n+        vRecv >> vInv;\n+        //if (vInv.size() > MAX_INV_SZ)\n+        //{\n+        //    LOCK(cs_main);\n+        //    Misbehaving(pfrom->GetId(), 20, strprintf(\"message notfound size() = %u\", vInv.size()));\n+        //    return false;\n+        //}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15776#discussion_r274599063",
      "id" : 274599063,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NDU5OTA2Mw==",
      "original_commit_id" : "12df73f5e362a59dd24db66f8001980c8d8a4667",
      "original_position" : 32,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 225733885,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15776",
      "updated_at" : "2019-04-17T05:14:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274599063",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15776#discussion_r274764846"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15776"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274764846"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Replaced with actual comment",
      "commit_id" : "595b0402a5f89bda3b9a7805ee0ac285ec7fe579",
      "created_at" : "2019-04-12T05:37:15Z",
      "diff_hunk" : "@@ -3114,8 +3118,33 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     }\n \n     if (strCommand == NetMsgType::NOTFOUND) {\n-        // We do not care about the NOTFOUND message, but logging an Unknown Command\n-        // message would be undesirable as we transmit it ourselves.\n+        // NOTFOUND means we can clear the entry from the tx_in_flight/announced set\n+        std::vector<CInv> vInv;\n+        vRecv >> vInv;\n+        //if (vInv.size() > MAX_INV_SZ)\n+        //{\n+        //    LOCK(cs_main);\n+        //    Misbehaving(pfrom->GetId(), 20, strprintf(\"message notfound size() = %u\", vInv.size()));\n+        //    return false;\n+        //}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15776#discussion_r274764846",
      "id" : 274764846,
      "in_reply_to_id" : 274599063,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NDc2NDg0Ng==",
      "original_commit_id" : "12df73f5e362a59dd24db66f8001980c8d8a4667",
      "original_position" : 32,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 225902817,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15776",
      "updated_at" : "2019-04-17T05:14:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274764846",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15776#discussion_r274765126"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15776"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274765126"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "are they even worth keeping? i mostly added them for debugging, and i am using them in one of the test cases, but they're pretty obscure info.",
      "commit_id" : "595b0402a5f89bda3b9a7805ee0ac285ec7fe579",
      "created_at" : "2019-04-12T05:39:16Z",
      "diff_hunk" : "@@ -178,6 +178,8 @@ static UniValue getpeerinfo(const JSONRPCRequest& request)\n             obj.pushKV(\"banscore\", statestats.nMisbehavior);\n             obj.pushKV(\"synced_headers\", statestats.nSyncHeight);\n             obj.pushKV(\"synced_blocks\", statestats.nCommonHeight);\n+            obj.pushKV(\"tx_inflight\", statestats.nTxInFlight);\n+            obj.pushKV(\"tx_process\", statestats.nTxProcess);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15776#discussion_r274765126",
      "id" : 274765126,
      "in_reply_to_id" : 274521787,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NDc2NTEyNg==",
      "original_commit_id" : "12df73f5e362a59dd24db66f8001980c8d8a4667",
      "original_position" : 5,
      "path" : "src/rpc/net.cpp",
      "position" : 14,
      "pull_request_review_id" : 225903164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15776",
      "updated_at" : "2019-04-17T05:14:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274765126",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15776#discussion_r274784284"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15776"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274784284"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "added help text anyway",
      "commit_id" : "595b0402a5f89bda3b9a7805ee0ac285ec7fe579",
      "created_at" : "2019-04-12T07:14:10Z",
      "diff_hunk" : "@@ -178,6 +178,8 @@ static UniValue getpeerinfo(const JSONRPCRequest& request)\n             obj.pushKV(\"banscore\", statestats.nMisbehavior);\n             obj.pushKV(\"synced_headers\", statestats.nSyncHeight);\n             obj.pushKV(\"synced_blocks\", statestats.nCommonHeight);\n+            obj.pushKV(\"tx_inflight\", statestats.nTxInFlight);\n+            obj.pushKV(\"tx_process\", statestats.nTxProcess);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15776#discussion_r274784284",
      "id" : 274784284,
      "in_reply_to_id" : 274521787,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NDc4NDI4NA==",
      "original_commit_id" : "12df73f5e362a59dd24db66f8001980c8d8a4667",
      "original_position" : 5,
      "path" : "src/rpc/net.cpp",
      "position" : 14,
      "pull_request_review_id" : 225926411,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15776",
      "updated_at" : "2019-04-17T05:14:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/274784284",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Not sure if it is related but today I found Ã¢ÂÂ for the second time Ã¢ÂÂ that my test 0.18.0RC3 node has a \"stuck\" mempool (size of 6 or so)",
      "created_at" : "2019-04-15T10:58:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15776#issuecomment-483205471",
      "id" : 483205471,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15776",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MzIwNTQ3MQ==",
      "updated_at" : "2019-04-15T10:58:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/483205471",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Just looked at the `debug.log` and my node gets a lot of invs (but no getdata response) and mempool won't increase.",
      "created_at" : "2019-04-15T11:00:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15776#issuecomment-483206122",
      "id" : 483206122,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15776",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MzIwNjEyMg==",
      "updated_at" : "2019-04-15T11:00:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/483206122",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "After an `addnode`, I could see `getdata`'s and a growing mempool",
      "created_at" : "2019-04-15T11:02:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15776#issuecomment-483206580",
      "id" : 483206580,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15776",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MzIwNjU4MA==",
      "updated_at" : "2019-04-15T11:02:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/483206580",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15776#discussion_r275450761"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15776"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/275450761"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Could you explain what's going on here? Why we're logging only the first notfound INV?",
      "commit_id" : "595b0402a5f89bda3b9a7805ee0ac285ec7fe579",
      "created_at" : "2019-04-15T16:47:19Z",
      "diff_hunk" : "@@ -3114,8 +3118,28 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     }\n \n     if (strCommand == NetMsgType::NOTFOUND) {\n-        // We do not care about the NOTFOUND message, but logging an Unknown Command\n-        // message would be undesirable as we transmit it ourselves.\n+        // NOTFOUND means we can clear the entry from the tx_in_flight/announced set\n+        std::vector<CInv> vInv;\n+        vRecv >> vInv;\n+        // note: we don't enforce a limit on number of inv's in a notfound\n+\n+        LogPrint(BCLog::NET, \"received notfound (%u invsz) peer=%d\\n\", vInv.size(), pfrom->GetId());\n+\n+        if (vInv.size() > 0) {\n+            LogPrint(BCLog::NET, \"received notfound for: %s peer=%d\\n\", vInv[0].ToString(), pfrom->GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15776#discussion_r275450761",
      "id" : 275450761,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NTQ1MDc2MQ==",
      "original_commit_id" : "599e5db90732065cff6a828790991826212b1853",
      "original_position" : 32,
      "path" : "src/net_processing.cpp",
      "position" : 46,
      "pull_request_review_id" : 226761606,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15776",
      "updated_at" : "2019-04-17T05:14:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/275450761",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15776#discussion_r275622904"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15776"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/275622904"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It's doing the same logging as `getdata` which also only logs the first entry. Didn't seem terribly valuable to log every notfound entry seen.",
      "commit_id" : "595b0402a5f89bda3b9a7805ee0ac285ec7fe579",
      "created_at" : "2019-04-16T04:06:50Z",
      "diff_hunk" : "@@ -3114,8 +3118,28 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     }\n \n     if (strCommand == NetMsgType::NOTFOUND) {\n-        // We do not care about the NOTFOUND message, but logging an Unknown Command\n-        // message would be undesirable as we transmit it ourselves.\n+        // NOTFOUND means we can clear the entry from the tx_in_flight/announced set\n+        std::vector<CInv> vInv;\n+        vRecv >> vInv;\n+        // note: we don't enforce a limit on number of inv's in a notfound\n+\n+        LogPrint(BCLog::NET, \"received notfound (%u invsz) peer=%d\\n\", vInv.size(), pfrom->GetId());\n+\n+        if (vInv.size() > 0) {\n+            LogPrint(BCLog::NET, \"received notfound for: %s peer=%d\\n\", vInv[0].ToString(), pfrom->GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15776#discussion_r275622904",
      "id" : 275622904,
      "in_reply_to_id" : 275450761,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NTYyMjkwNA==",
      "original_commit_id" : "599e5db90732065cff6a828790991826212b1853",
      "original_position" : 32,
      "path" : "src/net_processing.cpp",
      "position" : 46,
      "pull_request_review_id" : 226976394,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15776",
      "updated_at" : "2019-04-17T05:14:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/275622904",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Scenario is likely: Alice sends Bob and INV for a new tx, Bob sends GETDATA for the tx, Alice responds with TX, Bob doesn't have the parent so sends GETDATA for the parent, adding it to the tx_in_flight set, Alice replies NOTFOUND due to the parent having expired from the relay set due to being in the mempool for over 15 minutes, so Bob doesn't remove the entry from the tx_in_flight set.\r\n\r\nI added logging for when my node sends a notfound to try and see what the reasons were. It looks like most of the time these are for tx's that aren't even in my mempool at all anymore, though that varies between peers:\r\n\r\n * peer=0 -- 2821 not in mempool, 0 in mempool\r\n * peer=3 -- 1495 not in mempool, 0 in mempool\r\n * peer=1 -- 1092 not in mempool, 0 in mempool\r\n\r\n * peer=5 -- 401 not in mempool, 117 in mempool\r\n * peer=4 -- 308 not in mempool, 0 in mempool\r\n * peer=2 -- 146 not in mempool, 0 in mempool\r\n\r\n * peer=102 -- 73 in mempool, 14 not in mempool\r\n * peer=204 -- 111 in mempool, 3 not in mempool\r\n\r\nFor the ones that are in the mempool, the times are all just >15m as expected (ranging from 902s to 17432s -- almost 5 hours), and the parent explanation seems fine for them.\r\n\r\nNot sure what's causing other nodes to request tx's that aren't in my mempool anymore though. For the couple I've looked at, they seem to have been confirmed in prior blocks, eg:\r\n\r\n    2019-04-16T03:36:38Z got inv: tx 4c5f3fdd242b0f352716fb3bccca810585e726c2f1b435e7fdbcfb8ffc1faa4c  have peer=90\r\n    2019-04-16T03:46:25Z UpdateTip: new best=000000000000000000166ca879430bcbd524b0e3a4b333cf9646a4a4cc03c54f height=571829\r\n    2019-04-16T04:06:43Z UpdateTip: new best=...a417 height=571830 \r\n    2019-04-16T04:12:32Z received getdata for: witness-tx 4c5f3fdd242b0f352716fb3bccca810585e726c2f1b435e7fdbcfb8ffc1faa4c peer=1\r\n    2019-04-16T04:12:32Z will send notfound for: 4c5f3fdd242b0f352716fb3bccca810585e726c2f1b435e7fdbcfb8ffc1faa4c -1s in mempool peer=1\r\n\r\nor\r\n\r\n    2019-04-16T00:45:15Z got inv: tx c062e3b8e43817920b138e1675e6e33fd92c036e9e5de73c5cb2f062423f4f39  new peer=1\r\n    2019-04-16T00:45:15Z Requesting witness-tx c062e3b8e43817920b138e1675e6e33fd92c036e9e5de73c5cb2f062423f4f39 peer=1\r\n    2019-04-16T00:45:17Z got inv: tx c062e3b8e43817920b138e1675e6e33fd92c036e9e5de73c5cb2f062423f4f39  have peer=6\r\n    2019-04-16T00:45:21Z got inv: tx c062e3b8e43817920b138e1675e6e33fd92c036e9e5de73c5cb2f062423f4f39  have peer=5\r\n    2019-04-16T00:51:06Z Requesting block 00000000000000000022a55d495ebbec42ebcf1de23a7b6db3c4fc0361efd044 from  peer=49\r\n    2019-04-16T00:51:06Z UpdateTip: new best=00000000000000000022a55d495ebbec42ebcf1de23a7b6db3c4fc0361efd044 height=571814\r\n    2019-04-16T00:51:06Z received: cmpctblock (20107 bytes) peer=2\r\n    2019-04-16T02:23:15Z received getdata for: witness-tx c062e3b8e43817920b138e1675e6e33fd92c036e9e5de73c5cb2f062423f4f39 peer=2\r\n    2019-04-16T02:23:15Z will send notfound for: c062e3b8e43817920b138e1675e6e33fd92c036e9e5de73c5cb2f062423f4f39 -1s in mempool peer=2\r\n",
      "created_at" : "2019-04-16T05:00:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15776#issuecomment-483511720",
      "id" : 483511720,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15776",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MzUxMTcyMA==",
      "updated_at" : "2019-04-16T05:00:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/483511720",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Could update the comment that says `have to wait around forever. Currently only SPV clients actually care` ?\r\n\r\nAlso, I was wondering if this could be limited to just the bugfix without the RPC changes (and maybe without the tests)? You could still provide the branch with tests to the reviewers to run, but I think review should focus on the bugfix and shouldn't be distracted by RPC changes or tests. No strong opinion though.",
      "created_at" : "2019-04-16T12:11:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15776#issuecomment-483633411",
      "id" : 483633411,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15776",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MzYzMzQxMQ==",
      "updated_at" : "2019-04-16T12:11:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/483633411",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "```\r\n2019-04-16T02:23:15Z received getdata for: witness-tx c062e3b8e43817920b138e1675e6e33fd92c036e9e5de73c5cb2f062423f4f39 peer=2\r\n2019-04-16T02:23:15Z will send notfound for: c062e3b8e43817920b138e1675e6e33fd92c036e9e5de73c5cb2f062423f4f39 -1s in mempool peer=2\r\n```\r\n\r\nI presume you are using self-made logging, since I couldn't find that logprint in the code base?\r\n\r\nAlso, I can't follow how the mempool should influence getdata at all. We are using `mapRelay` to store the transaction pointers and it is populated at the same time the inv gets sent. (Of course a timeout of an entry in `mapRelay` might cause the issue mentioned here, but that shouldn't occur so frequently)",
      "created_at" : "2019-04-16T12:23:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15776#issuecomment-483636933",
      "id" : 483636933,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15776",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MzYzNjkzMw==",
      "updated_at" : "2019-04-16T12:23:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/483636933",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15776#discussion_r275815853"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15776"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/275815853"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This will disconnect both inbound and outbound peers, I think? ",
      "commit_id" : "595b0402a5f89bda3b9a7805ee0ac285ec7fe579",
      "created_at" : "2019-04-16T14:06:59Z",
      "diff_hunk" : "@@ -3341,6 +3365,14 @@ void PeerLogicValidation::ConsiderEviction(CNode *pto, int64_t time_in_seconds)\n             }\n         }\n     }\n+\n+    const auto& tx_download = state.m_tx_download;\n+    if (tx_download.m_tx_in_flight.size() >= MAX_PEER_TX_IN_FLIGHT) {\n+        if (!tx_download.m_tx_process_time.empty() && (tx_download.m_tx_process_time.begin()->first + GETDATA_TX_TIMEOUT) <= time_in_seconds * 1000000) {\n+            LogPrintf(\"Disconnecting outbound peer %d due to tx request backlog (%d inflight, %d queued)\\n\", pto->GetId(), tx_download.m_tx_in_flight.size(), tx_download.m_tx_process_time.size());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15776#discussion_r275815853",
      "id" : 275815853,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NTgxNTg1Mw==",
      "original_commit_id" : "599e5db90732065cff6a828790991826212b1853",
      "original_position" : 57,
      "path" : "src/net_processing.cpp",
      "position" : 72,
      "pull_request_review_id" : 227217590,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15776",
      "updated_at" : "2019-04-17T05:14:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/275815853",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I presume you are using self-made logging, since I couldn't find that logprint in the code base?\r\n\r\nYeah, it's just\r\n\r\n    +                auto txinfo = mempool.info(inv.hash);\r\n    +                LogPrint(BCLog::NET, \"will send notfound for: %s %ds in mempool peer=%d\\n\", inv.hash.ToString(), (txinfo.tx ? GetTime() - txinfo.nTime : -1), pfrom->GetId());\r\n\r\nbefore `vNotFound.push_back(inv);` in `ProcessGetData()`.\r\n \r\n> Also, I can't follow how the mempool should influence getdata at all. We are using `mapRelay` to store the transaction pointers and it is populated at the same time the inv gets sent. (Of course a timeout of an entry in `mapRelay` might cause the issue mentioned here, but that shouldn't occur so frequently)\r\n\r\nYeah -- if it hasn't expired from `mapRelay` it should be fine, I'm trying to understand why a getdata is being sent after expiry from `mapRelay`. Apparently that's almost always when it's also been removed from the mempool.\r\n\r\nAh! I think what's happening is I'm getting a tx A, which spends B and C, and `AcceptToMemoryPool` is noticing I don't have B and setting `fMissingInputs` to true, at which point I'm doing `RequestTx` for both B and C, because `AlreadyHave(C)` returns false for both because they're not in the mempool, and **because B's first two outputs aren't in the UTXO set** it doesn't notice that I have C via the UTXO set. (EDIT to add bolded text)\r\n\r\nSo the cases where I'm sending `getdata` and getting back `notfound` seem to me to be:\r\n\r\n * I'm unnecessarily requesting tx data I already have, because I don't have some other parent of a tx I just received (most of the time)\r\n * My peer isn't forwarding me a parent that's still in the mempool but has expired from `mapRelayTx` (rarely, but non-zero)\r\n",
      "created_at" : "2019-04-17T02:46:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15776#issuecomment-483916240",
      "id" : 483916240,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15776",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4MzkxNjI0MA==",
      "updated_at" : "2019-04-17T07:03:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/483916240",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15776#discussion_r276081689"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15776"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/276081689"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, fixed",
      "commit_id" : "595b0402a5f89bda3b9a7805ee0ac285ec7fe579",
      "created_at" : "2019-04-17T05:14:41Z",
      "diff_hunk" : "@@ -3341,6 +3365,14 @@ void PeerLogicValidation::ConsiderEviction(CNode *pto, int64_t time_in_seconds)\n             }\n         }\n     }\n+\n+    const auto& tx_download = state.m_tx_download;\n+    if (tx_download.m_tx_in_flight.size() >= MAX_PEER_TX_IN_FLIGHT) {\n+        if (!tx_download.m_tx_process_time.empty() && (tx_download.m_tx_process_time.begin()->first + GETDATA_TX_TIMEOUT) <= time_in_seconds * 1000000) {\n+            LogPrintf(\"Disconnecting outbound peer %d due to tx request backlog (%d inflight, %d queued)\\n\", pto->GetId(), tx_download.m_tx_in_flight.size(), tx_download.m_tx_process_time.size());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15776#discussion_r276081689",
      "id" : 276081689,
      "in_reply_to_id" : 275815853,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NjA4MTY4OQ==",
      "original_commit_id" : "599e5db90732065cff6a828790991826212b1853",
      "original_position" : 57,
      "path" : "src/net_processing.cpp",
      "position" : 72,
      "pull_request_review_id" : 227553191,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15776",
      "updated_at" : "2019-04-17T05:14:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/276081689",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Can we go back to the expiry approach?\r\n\r\nI don't see why not. Closing this PR in favour of #15834 . Fixed some issues in the branch anyway so it's still useful for reference.",
      "created_at" : "2019-04-17T05:16:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15776#issuecomment-483940239",
      "id" : 483940239,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15776",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4Mzk0MDIzOQ==",
      "updated_at" : "2019-04-17T05:16:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/483940239",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   }
]
