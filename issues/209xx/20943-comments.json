[
   {
      "author_association" : "NONE",
      "body" : "I think a partial fix for this would be:\r\n\r\n1. Change the return type of SubmitMemoryPoolAndReturn (https://github.com/bitcoin/bitcoin/blob/master/src/wallet/wallet.h#L506) to an enum class TEMPORARY_FAILURE / PERMENANT_FAILURE / SUBMITTED. \r\n2. In the case of PERMENANT_FAILURE, we can delete the transaction from the wallet immediately (https://github.com/bitcoin/bitcoin/blob/master/src/wallet/wallet.cpp#L3182)\r\n\r\nIf that's sounds right, I'd submit a patch for this in the coming days",
      "created_at" : "2021-02-24T20:48:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/20943#issuecomment-785371940",
      "id" : 785371940,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20943",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4NTM3MTk0MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-24T20:48:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/785371940",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6006469?v=4",
         "events_url" : "https://api.github.com/users/fyquah/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fyquah/followers",
         "following_url" : "https://api.github.com/users/fyquah/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fyquah/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fyquah",
         "id" : 6006469,
         "login" : "fyquah",
         "node_id" : "MDQ6VXNlcjYwMDY0Njk=",
         "organizations_url" : "https://api.github.com/users/fyquah/orgs",
         "received_events_url" : "https://api.github.com/users/fyquah/received_events",
         "repos_url" : "https://api.github.com/users/fyquah/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fyquah/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fyquah/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fyquah"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Is this still active and does it affect getwalletinfo/getbalance? We're having a problem where our balance keeps reporting lower and lower over time but if you restart bitcoind it's back to normal. I've only seen it happen like 2-3x before but since the blockchain backed up on Friday it's been worse and worse. Is there any fix without restarting?\r\n\r\nWe do have a fair amount of consolidation TXes from before the blockchain backed up with low fees set so I had kind of thought maybe it's ignoring TXes with too low of a fee rate but saw this issue and it makes sense too.",
      "created_at" : "2021-04-21T20:45:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/20943#issuecomment-824346543",
      "id" : 824346543,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20943",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNDM0NjU0Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-21T20:49:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/824346543",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7625236?v=4",
         "events_url" : "https://api.github.com/users/Crypto2/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Crypto2/followers",
         "following_url" : "https://api.github.com/users/Crypto2/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Crypto2/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Crypto2",
         "id" : 7625236,
         "login" : "Crypto2",
         "node_id" : "MDQ6VXNlcjc2MjUyMzY=",
         "organizations_url" : "https://api.github.com/users/Crypto2/orgs",
         "received_events_url" : "https://api.github.com/users/Crypto2/received_events",
         "repos_url" : "https://api.github.com/users/Crypto2/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Crypto2/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Crypto2/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Crypto2"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "```\r\n2021-01-15T09:26:28Z [default wallet] CommitTransaction(): Transaction cannot be broadcast immediately, mempool min fee not met, 142 < 152\r\n```\r\n\r\nThis error is surfacing from `Prechecks()` checking the fee rate:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/8d12127a9c19cb218d661a88ab9b6871c9d853b9/src/validation.cpp#L847-L850\r\n\r\n@achow101 should it be the case that the wallet can create a transaction, which would fail `ATMP(test_accept=true)` but still result in a balance reduction for the user? My intuition would be that if the created tx was failing ATMP PreChecks that the coins would not appear as debited from the wallet balance, but my understanding of when coins are reserved/used, and balances updated in the wallet is still a bit limited ð ",
      "created_at" : "2023-03-08T14:35:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/20943#issuecomment-1460255465",
      "id" : 1460255465,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20943",
      "node_id" : "IC_kwDOABII585XCbrp",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1460255465/reactions"
      },
      "updated_at" : "2023-03-08T14:35:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1460255465",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> should it be the case that the wallet can create a transaction, which would fail `ATMP(test_accept=true)`\r\n\r\nNo.\r\n\r\n> but still result in a balance reduction for the user?\r\n\r\nYes, ish. It is not a balance reduction per se, we don't track the balance as a number that gets incremented and decremented as transactions are made. Rather the balance is (re)computed by examining all txs and adding up the outputs that belong to the wallet. One of the criteria is that unconfirmed transactions need to be in our mempool to be counted as part of the \"trusted\" balance. A transaction which failed to make it into the mempool will result in the wallet recording that the parent has had all of its outputs spent (so it does not increase the balance), but that the child transaction is not trusted, so change back is not counted. This is intentional as we prefer to err on the side of telling the user that they have less money than they may actually have.\r\n\r\nThe issue with `getbalance` is figuring out what unconfirmed things should be included in the balance as unconfirmed transactions can be in a variety of states and possibilities of being confirmed. `getbalances` (with an s) provides a more complete picture of the balance of the wallet.",
      "created_at" : "2023-03-08T14:56:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/20943#issuecomment-1460286500",
      "id" : 1460286500,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20943",
      "node_id" : "IC_kwDOABII585XCjQk",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1460286500/reactions"
      },
      "updated_at" : "2023-03-08T14:56:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1460286500",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> ...the balance is (re)computed by examining all txs and adding up the outputs that belong to the wallet.\r\n\r\nindeed\r\n\r\n> One of the criteria is that unconfirmed transactions need to be in our mempool to be counted as part of the \"trusted\" balance. A transaction which failed to make it into the mempool will result in the wallet recording that the parent has had all of its outputs spent (so it does not increase the balance), but that the child transaction is not trusted, so change back is not counted. This is intentional as we prefer to err on the side of telling the user that they have less money than they may actually have.\r\n\r\nOK, so this seems like the root cause of the issue here. Although it doesn't explain to me how @decryp2kanon was managing to make a transaction in the GUI (presuming that was how it was made) which failed ATMP checks and triggered this.\r\n\r\nIs there actually any fix to be provided here, or should the guidance simply be to use `getbalances` instead to get the complete picture?",
      "created_at" : "2023-03-09T09:39:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/20943#issuecomment-1461668624",
      "id" : 1461668624,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20943",
      "node_id" : "IC_kwDOABII585XH0sQ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1461668624/reactions"
      },
      "updated_at" : "2023-03-09T09:39:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1461668624",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6606587?v=4",
         "events_url" : "https://api.github.com/users/willcl-ark/events{/privacy}",
         "followers_url" : "https://api.github.com/users/willcl-ark/followers",
         "following_url" : "https://api.github.com/users/willcl-ark/following{/other_user}",
         "gists_url" : "https://api.github.com/users/willcl-ark/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/willcl-ark",
         "id" : 6606587,
         "login" : "willcl-ark",
         "node_id" : "MDQ6VXNlcjY2MDY1ODc=",
         "organizations_url" : "https://api.github.com/users/willcl-ark/orgs",
         "received_events_url" : "https://api.github.com/users/willcl-ark/received_events",
         "repos_url" : "https://api.github.com/users/willcl-ark/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/willcl-ark/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/willcl-ark/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/willcl-ark"
      }
   }
]
