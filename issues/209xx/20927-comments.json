[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #20724 (Cleanup of -debug=net log messages by ajtowns)\n* #20721 (Net: Move ping data to net_processing by jnewbery)\n* #20685 (Add I2P support using I2P SAM by vasild)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-01-13T18:47:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20927#issuecomment-759645495",
      "id" : 759645495,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20927",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1OTY0NTQ5NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-13T18:47:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/759645495",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK: I find the suggested version easier to reason about.\r\n\r\nAlso thanks for switching to `CNode*` to `CNode&`: it makes the currently implicit precondition explicit. As we all know by know: explicit is much better than implicit :)",
      "created_at" : "2021-01-14T11:41:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20927#issuecomment-760144087",
      "id" : 760144087,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20927",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2MDE0NDA4Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-14T11:41:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/760144087",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've updated the commit message on the second commit to give a bit more context about why the change to the return type is an improvement.",
      "created_at" : "2021-01-14T13:01:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20927#issuecomment-760182523",
      "id" : 760182523,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20927",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2MDE4MjUyMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-14T13:01:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/760182523",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @mjdietzx!\r\n\r\n> I didn't find changing the ordering of the if statements to be clearer, but I don't feel strongly about it\r\n\r\nMaybe it's just me, but I find that standardizing all time comparisons to `now <` or `now >` (or in English - \"it is [now] before/after the timeout\") makes it easier to intuitively understand the comparisons. I don't feel strongly and I'm happy to change them back if the other reviewers agree with you.",
      "created_at" : "2021-01-16T10:31:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20927#issuecomment-761540749",
      "id" : 761540749,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20927",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2MTU0MDc0OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-16T10:31:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/761540749",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've pushed a small update to make the `CNode&` argument const now that the function isn't mutating it.",
      "created_at" : "2021-01-19T10:51:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20927#issuecomment-762763554",
      "id" : 762763554,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20927",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2Mjc2MzU1NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-19T10:51:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/762763554",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20927#discussion_r562588090"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20927"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/562588090"
         }
      },
      "author_association" : "MEMBER",
      "body" : "this can be worked around by mocking m_peer_connect_timeout to a high value",
      "commit_id" : "bf100f8170770544fb39ae6802175c564cde532f",
      "created_at" : "2021-01-22T12:06:44Z",
      "diff_hunk" : "@@ -1216,37 +1216,47 @@ void CConnman::NotifyNumConnectionsChanged()\n     }\n }\n \n-void CConnman::InactivityCheck(CNode& node) const\n+bool CConnman::InactivityCheck(const CNode& node) const\n {\n-    int64_t nTime = GetSystemTimeInSeconds();\n-    if (nTime - node.nTimeConnected > m_peer_connect_timeout)\n-    {\n-        if (node.nLastRecv == 0 || node.nLastSend == 0)\n-        {\n-            LogPrint(BCLog::NET, \"socket no message in first %i seconds, %d %d from %d\\n\", m_peer_connect_timeout, node.nLastRecv != 0, node.nLastSend != 0, node.GetId());\n-            node.fDisconnect = true;\n-        }\n-        else if (nTime - node.nLastSend > TIMEOUT_INTERVAL)\n-        {\n-            LogPrintf(\"socket sending timeout: %is\\n\", nTime - node.nLastSend);\n-            node.fDisconnect = true;\n-        }\n-        else if (nTime - node.nLastRecv > TIMEOUT_INTERVAL)\n-        {\n-            LogPrintf(\"socket receive timeout: %is\\n\", nTime - node.nLastRecv);\n-            node.fDisconnect = true;\n-        }\n-        else if (node.nPingNonceSent && node.m_ping_start.load() + std::chrono::seconds{TIMEOUT_INTERVAL} < GetTime<std::chrono::microseconds>())\n-        {\n-            LogPrintf(\"ping timeout: %fs\\n\", 0.000001 * count_microseconds(GetTime<std::chrono::microseconds>() - node.m_ping_start.load()));\n-            node.fDisconnect = true;\n-        }\n-        else if (!node.fSuccessfullyConnected)\n-        {\n-            LogPrint(BCLog::NET, \"version handshake timeout from %d\\n\", node.GetId());\n-            node.fDisconnect = true;\n-        }\n+    // Use non-mockable system time (otherwise these timers will pop when we\n+    // use setmocktime in the tests).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20927#discussion_r562588090",
      "id" : 562588090,
      "line" : 1222,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MjU4ODA5MA==",
      "original_commit_id" : "bf100f8170770544fb39ae6802175c564cde532f",
      "original_line" : 1222,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 36,
      "pull_request_review_id" : 574201264,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20927",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-01-22T12:11:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/562588090",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
