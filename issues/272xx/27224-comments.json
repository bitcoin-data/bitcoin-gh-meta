[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [furszy](https://github.com/bitcoin/bitcoin/pull/27224#pullrequestreview-1384148699), [achow101](https://github.com/bitcoin/bitcoin/pull/27224#issuecomment-1529640566) |\n| Stale ACK | [josibake](https://github.com/bitcoin/bitcoin/pull/27224#pullrequestreview-1360512338) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#bitcoin-core/gui/723](https://github.com/bitcoin-core/gui/pull/723) (Add warnings for non-active addresses in receive tab and address book by pinheadmz)\n* [#27286](https://github.com/bitcoin/bitcoin/pull/27286) (wallet: Keep track of the wallet's own transaction outputs in memory by achow101)\n* [#26836](https://github.com/bitcoin/bitcoin/pull/26836) (wallet: finish addressbook encapsulation by furszy)\n* [#26644](https://github.com/bitcoin/bitcoin/pull/26644) (wallet: bugfix, 'wallet_load_ckey' unit test fails with bdb by furszy)\n* [#25991](https://github.com/bitcoin/bitcoin/pull/25991) (Wallet: Add foreign_outputs metadata to support CoinJoin transactions by luke-jr)\n* [#24914](https://github.com/bitcoin/bitcoin/pull/24914) (wallet: Load database records in a particular order by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-03-07T21:51:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#issuecomment-1458923346",
      "id" : 1458923346,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27224",
      "node_id" : "IC_kwDOABII585W9WdS",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1458923346/reactions"
      },
      "updated_at" : "2023-05-01T12:09:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1458923346",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1129250725"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1129250725"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```\r\n\r\nsrc/wallet/walletdb.cpp:616:58: error: passing result of std::move() as a const reference argument; no move will actually happen [performance-move-const-arg,-warnings-as-errors]\r\n                data.SetReceiveRequest(strKey.substr(2), std::move(strValue));",
      "commit_id" : "6388b30274971f0488214d283f28bfc948995a1b",
      "created_at" : "2023-03-08T10:47:12Z",
      "diff_hunk" : "@@ -609,7 +609,12 @@ ReadKeyValue(CWallet* pwallet, DataStream& ssKey, CDataStream& ssValue,\n             ssKey >> strAddress;\n             ssKey >> strKey;\n             ssValue >> strValue;\n-            pwallet->LoadDestData(DecodeDestination(strAddress), strKey, strValue);\n+            CAddressBookData& data = pwallet->m_address_book[DecodeDestination(strAddress)];\n+            if (strKey.compare(\"used\") == 0) {\n+                data.SetUsed(true);\n+            } else if (strKey.compare(0, 2, \"rr\") == 0) {\n+                data.SetReceiveRequest(strKey.substr(2), std::move(strValue));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1129250725",
      "id" : 1129250725,
      "line" : 616,
      "node_id" : "PRRC_kwDOABII585DTv-l",
      "original_commit_id" : "2a44c4e0c7a20a1e1964ecb25fe148759fbb0e2f",
      "original_line" : 616,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 9,
      "pull_request_review_id" : 1330392187,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1129250725/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-08T10:47:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1129250725",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1129950744"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1129950744"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1129250725\r\n\r\nThanks, fixed now",
      "commit_id" : "6388b30274971f0488214d283f28bfc948995a1b",
      "created_at" : "2023-03-08T19:49:38Z",
      "diff_hunk" : "@@ -609,7 +609,12 @@ ReadKeyValue(CWallet* pwallet, DataStream& ssKey, CDataStream& ssValue,\n             ssKey >> strAddress;\n             ssKey >> strKey;\n             ssValue >> strValue;\n-            pwallet->LoadDestData(DecodeDestination(strAddress), strKey, strValue);\n+            CAddressBookData& data = pwallet->m_address_book[DecodeDestination(strAddress)];\n+            if (strKey.compare(\"used\") == 0) {\n+                data.SetUsed(true);\n+            } else if (strKey.compare(0, 2, \"rr\") == 0) {\n+                data.SetReceiveRequest(strKey.substr(2), std::move(strValue));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1129950744",
      "id" : 1129950744,
      "in_reply_to_id" : 1129250725,
      "line" : 616,
      "node_id" : "PRRC_kwDOABII585DWa4Y",
      "original_commit_id" : "2a44c4e0c7a20a1e1964ecb25fe148759fbb0e2f",
      "original_line" : 616,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 9,
      "pull_request_review_id" : 1331334304,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1129950744/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-08T20:23:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1129950744",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1137453458"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137453458"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I strongly dislike using the empty string to indicate deletion. I think it would be better to have a separate `RemoveReceiveRequest`.",
      "commit_id" : "6388b30274971f0488214d283f28bfc948995a1b",
      "created_at" : "2023-03-15T17:00:23Z",
      "diff_hunk" : "@@ -205,21 +205,29 @@ class CAddressBookData\n {\n private:\n     bool m_change{true};\n+    bool m_used{false};\n     std::string m_label;\n+    std::map<std::string, std::string> m_receive_requests;\n public:\n     std::string purpose;\n \n     CAddressBookData() : purpose(\"unknown\") {}\n \n-    typedef std::map<std::string, std::string> StringMap;\n-    StringMap destdata;\n-\n     bool IsChange() const { return m_change; }\n+    bool IsUsed() const { return m_used; }\n+    void SetUsed(bool used) { m_used = used;}\n     const std::string& GetLabel() const { return m_label; }\n     void SetLabel(const std::string& label) {\n         m_change = false;\n         m_label = label;\n     }\n+    const std::map<std::string, std::string>& GetReceiveRequests() const { return m_receive_requests; }\n+    bool SetReceiveRequest(std::string id, std::string value)\n+    {\n+        if (value.empty()) return m_receive_requests.erase(id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1137453458",
      "id" : 1137453458,
      "line" : 227,
      "node_id" : "PRRC_kwDOABII585DzCmS",
      "original_commit_id" : "6388b30274971f0488214d283f28bfc948995a1b",
      "original_line" : 227,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : 26,
      "pull_request_review_id" : 1341984808,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137453458/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-15T17:03:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137453458",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1137458690"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137458690"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm not convinced that this needs to be a map. Receive requests are only created by the GUI, and the GUI only creates them for a newly retrieved address, so it shouldn't be possible to have multiple receive requests.\r\n\r\nAdditionally, receive requests are identified by an int which is being (un)stringified. This could just be an int to avoid that constant conversion in the GUI.",
      "commit_id" : "6388b30274971f0488214d283f28bfc948995a1b",
      "created_at" : "2023-03-15T17:03:42Z",
      "diff_hunk" : "@@ -205,21 +205,29 @@ class CAddressBookData\n {\n private:\n     bool m_change{true};\n+    bool m_used{false};\n     std::string m_label;\n+    std::map<std::string, std::string> m_receive_requests;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1137458690",
      "id" : 1137458690,
      "line" : 210,
      "node_id" : "PRRC_kwDOABII585DzD4C",
      "original_commit_id" : "6388b30274971f0488214d283f28bfc948995a1b",
      "original_line" : 210,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : 6,
      "pull_request_review_id" : 1341984808,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137458690/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-15T17:03:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137458690",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1137647274"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137647274"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1137647274\r\n\r\n> I strongly dislike using the empty string to indicate deletion. I think it would be better to have a separate `RemoveReceiveRequest`.\r\n\r\nYou are right. This is shitty and I will add a separate method to avoid continuing this pattern.",
      "commit_id" : "6388b30274971f0488214d283f28bfc948995a1b",
      "created_at" : "2023-03-15T19:23:29Z",
      "diff_hunk" : "@@ -205,21 +205,29 @@ class CAddressBookData\n {\n private:\n     bool m_change{true};\n+    bool m_used{false};\n     std::string m_label;\n+    std::map<std::string, std::string> m_receive_requests;\n public:\n     std::string purpose;\n \n     CAddressBookData() : purpose(\"unknown\") {}\n \n-    typedef std::map<std::string, std::string> StringMap;\n-    StringMap destdata;\n-\n     bool IsChange() const { return m_change; }\n+    bool IsUsed() const { return m_used; }\n+    void SetUsed(bool used) { m_used = used;}\n     const std::string& GetLabel() const { return m_label; }\n     void SetLabel(const std::string& label) {\n         m_change = false;\n         m_label = label;\n     }\n+    const std::map<std::string, std::string>& GetReceiveRequests() const { return m_receive_requests; }\n+    bool SetReceiveRequest(std::string id, std::string value)\n+    {\n+        if (value.empty()) return m_receive_requests.erase(id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1137647274",
      "id" : 1137647274,
      "in_reply_to_id" : 1137453458,
      "line" : 227,
      "node_id" : "PRRC_kwDOABII585Dzx6q",
      "original_commit_id" : "6388b30274971f0488214d283f28bfc948995a1b",
      "original_line" : 227,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : 26,
      "pull_request_review_id" : 1342243492,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137647274/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-15T19:23:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137647274",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1137679417"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137679417"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1137458690\r\n\r\n> I'm not convinced that this needs to be a map. Receive requests are only created by the GUI, and the GUI only creates them for a newly retrieved address, so it shouldn't be possible to have multiple receive requests.\r\n> \r\n> Additionally, receive requests are identified by an int which is being (un)stringified. This could just be an int to avoid that constant conversion in the GUI.\r\n\r\nYou could definitely be right about these things, but I need to look into GUI code more to have an opinion. This PR avoids changing any GUI code, and keeps the behavior of `interfaces::Wallet` methods the same as before from the perspective of the GUI.\r\n\r\nIf the definitions or behavior of `interfaces::Wallet` methods should change as you say, I think it would make sense to implement these changes as a separate PR, because making those changes here would not really simplify much (would basically replace `string` with `int` and `find()` with `has_value()`), and would require understanding GUI code to review, unlike the current changes.",
      "commit_id" : "6388b30274971f0488214d283f28bfc948995a1b",
      "created_at" : "2023-03-15T19:35:22Z",
      "diff_hunk" : "@@ -205,21 +205,29 @@ class CAddressBookData\n {\n private:\n     bool m_change{true};\n+    bool m_used{false};\n     std::string m_label;\n+    std::map<std::string, std::string> m_receive_requests;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1137679417",
      "id" : 1137679417,
      "in_reply_to_id" : 1137458690,
      "line" : 210,
      "node_id" : "PRRC_kwDOABII585Dz5w5",
      "original_commit_id" : "6388b30274971f0488214d283f28bfc948995a1b",
      "original_line" : 210,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : 6,
      "pull_request_review_id" : 1342293430,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137679417/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-15T19:35:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1137679417",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1142438454"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1142438454"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: [#27224 (comment)](https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1137458690)\r\n\r\nInstead of extending the PR to modify GUI code, I've kept changes here internal to the wallet and added a note in `setAddressReceiveRequest` about the wallet/gui interface and say how it could be improved in the future.",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-20T17:02:16Z",
      "diff_hunk" : "@@ -205,21 +205,29 @@ class CAddressBookData\n {\n private:\n     bool m_change{true};\n+    bool m_used{false};\n     std::string m_label;\n+    std::map<std::string, std::string> m_receive_requests;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1142438454",
      "id" : 1142438454,
      "in_reply_to_id" : 1137458690,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585EGDo2",
      "original_commit_id" : "6388b30274971f0488214d283f28bfc948995a1b",
      "original_line" : 210,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 1349037350,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1142438454/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-20T17:56:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1142438454",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1142496680"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1142496680"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> re: [#27224 (comment)](https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1137647274)\r\n\r\nThis is done now",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-20T17:52:56Z",
      "diff_hunk" : "@@ -205,21 +205,29 @@ class CAddressBookData\n {\n private:\n     bool m_change{true};\n+    bool m_used{false};\n     std::string m_label;\n+    std::map<std::string, std::string> m_receive_requests;\n public:\n     std::string purpose;\n \n     CAddressBookData() : purpose(\"unknown\") {}\n \n-    typedef std::map<std::string, std::string> StringMap;\n-    StringMap destdata;\n-\n     bool IsChange() const { return m_change; }\n+    bool IsUsed() const { return m_used; }\n+    void SetUsed(bool used) { m_used = used;}\n     const std::string& GetLabel() const { return m_label; }\n     void SetLabel(const std::string& label) {\n         m_change = false;\n         m_label = label;\n     }\n+    const std::map<std::string, std::string>& GetReceiveRequests() const { return m_receive_requests; }\n+    bool SetReceiveRequest(std::string id, std::string value)\n+    {\n+        if (value.empty()) return m_receive_requests.erase(id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1142496680",
      "id" : 1142496680,
      "in_reply_to_id" : 1137453458,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585EGR2o",
      "original_commit_id" : "6388b30274971f0488214d283f28bfc948995a1b",
      "original_line" : 227,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : null,
      "pull_request_review_id" : 1349037350,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1142496680/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-20T17:56:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1142496680",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK fe367f2e4e5fb95546fa26491d43346e0bc11adb",
      "created_at" : "2023-03-23T18:09:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#issuecomment-1481673419",
      "id" : 1481673419,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27224",
      "node_id" : "IC_kwDOABII585YUIrL",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1481673419/reactions"
      },
      "updated_at" : "2023-03-23T18:09:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1481673419",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1149193825"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1149193825"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This line was really confusing for me at first. Perhaps something like this could make it more clear?\r\n\r\n```suggestion\r\n    Dbt prefix_key(prefix.data(), prefix.size()), prefix_value{};\r\n```\r\n",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-27T11:48:07Z",
      "diff_hunk" : "@@ -808,6 +810,22 @@ bool BerkeleyBatch::HasKey(DataStream&& key)\n     return ret == 0;\n }\n \n+bool BerkeleyBatch::ErasePrefix(Span<std::byte> prefix)\n+{\n+    if (!TxnBegin()) return false;\n+    auto cursor = std::make_unique<BerkeleyCursor>(m_database, this);\n+    Dbt prefix_key(prefix.data(), prefix.size()), prefix_value;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1149193825",
      "id" : 1149193825,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Ef05h",
      "original_commit_id" : "fe367f2e4e5fb95546fa26491d43346e0bc11adb",
      "original_line" : 817,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.cpp",
      "position" : null,
      "pull_request_review_id" : 1358939669,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1149193825/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-27T11:50:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1149193825",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7444140?v=4",
         "events_url" : "https://api.github.com/users/josibake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/josibake/followers",
         "following_url" : "https://api.github.com/users/josibake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/josibake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/josibake",
         "id" : 7444140,
         "login" : "josibake",
         "node_id" : "MDQ6VXNlcjc0NDQxNDA=",
         "organizations_url" : "https://api.github.com/users/josibake/orgs",
         "received_events_url" : "https://api.github.com/users/josibake/received_events",
         "repos_url" : "https://api.github.com/users/josibake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/josibake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/josibake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/josibake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1149661885"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1149661885"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1149193825\r\n\r\nThanks, switched to brace initialization like you suggested in many places now. Should be clearer and safer\r\n\r\n",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-27T18:43:41Z",
      "diff_hunk" : "@@ -808,6 +810,22 @@ bool BerkeleyBatch::HasKey(DataStream&& key)\n     return ret == 0;\n }\n \n+bool BerkeleyBatch::ErasePrefix(Span<std::byte> prefix)\n+{\n+    if (!TxnBegin()) return false;\n+    auto cursor = std::make_unique<BerkeleyCursor>(m_database, this);\n+    Dbt prefix_key(prefix.data(), prefix.size()), prefix_value;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1149661885",
      "id" : 1149661885,
      "in_reply_to_id" : 1149193825,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585EhnK9",
      "original_commit_id" : "fe367f2e4e5fb95546fa26491d43346e0bc11adb",
      "original_line" : 817,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.cpp",
      "position" : null,
      "pull_request_review_id" : 1359680913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1149661885/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-27T19:02:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1149661885",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150232826"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150232826"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Perhaps there's some nuance that I'm missing, but it seems strange to have this be `Span<std::byte>` when the rest of the methods take `DataStream&&`. I changed the `ErasePrefix` method to instead take `DataStream&&` as an argument and was able to compile and pass the unit and functional tests. Seems like it would be preferable to match the other methods unless you have a reason to prefer `Span<std::byte>`?",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-28T08:37:40Z",
      "diff_hunk" : "@@ -205,6 +206,7 @@ class BerkeleyBatch : public DatabaseBatch\n     bool WriteKey(DataStream&& key, DataStream&& value, bool overwrite = true) override;\n     bool EraseKey(DataStream&& key) override;\n     bool HasKey(DataStream&& key) override;\n+    bool ErasePrefix(Span<std::byte> prefix) override;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150232826",
      "id" : 1150232826,
      "line" : 209,
      "node_id" : "PRRC_kwDOABII585Ejyj6",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 209,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.h",
      "position" : 17,
      "pull_request_review_id" : 1360512338,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150232826/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-28T08:44:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150232826",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7444140?v=4",
         "events_url" : "https://api.github.com/users/josibake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/josibake/followers",
         "following_url" : "https://api.github.com/users/josibake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/josibake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/josibake",
         "id" : 7444140,
         "login" : "josibake",
         "node_id" : "MDQ6VXNlcjc0NDQxNDA=",
         "organizations_url" : "https://api.github.com/users/josibake/orgs",
         "received_events_url" : "https://api.github.com/users/josibake/received_events",
         "repos_url" : "https://api.github.com/users/josibake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/josibake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/josibake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/josibake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150238393"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150238393"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "as part of changing `ErasePrefix` to accept a `DataStream&&`, I also changed this line:\r\n\r\n```suggestion\r\n    return m_batch->ErasePrefix(DataStream(prefix));\r\n```\r\n\r\nto make this an `rvalue`. there is likely a cleaner way to do this, if you end up going with `DataStream`",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-28T08:41:52Z",
      "diff_hunk" : "@@ -1082,16 +1087,28 @@ void MaybeCompactWalletDB(WalletContext& context)\n     fOneThread = false;\n }\n \n-bool WalletBatch::WriteDestData(const std::string &address, const std::string &key, const std::string &value)\n+bool WalletBatch::WriteAddressPreviouslySpent(const CTxDestination& dest, bool previously_spent)\n+{\n+    auto key{std::make_pair(DBKeys::DESTDATA, std::make_pair(EncodeDestination(dest), std::string(\"used\")))};\n+    return previously_spent ? WriteIC(key, std::string(\"1\")) : EraseIC(key);\n+}\n+\n+bool WalletBatch::WriteAddressReceiveRequest(const CTxDestination& dest, const std::string& id, const std::string& receive_request)\n {\n-    return WriteIC(std::make_pair(DBKeys::DESTDATA, std::make_pair(address, key)), value);\n+    return WriteIC(std::make_pair(DBKeys::DESTDATA, std::make_pair(EncodeDestination(dest), \"rr\" + id)), receive_request);\n }\n \n-bool WalletBatch::EraseDestData(const std::string &address, const std::string &key)\n+bool WalletBatch::EraseAddressReceiveRequest(const CTxDestination& dest, const std::string& id)\n {\n-    return EraseIC(std::make_pair(DBKeys::DESTDATA, std::make_pair(address, key)));\n+    return EraseIC(std::make_pair(DBKeys::DESTDATA, std::make_pair(EncodeDestination(dest), \"rr\" + id)));\n }\n \n+bool WalletBatch::EraseAddressData(const CTxDestination& dest)\n+{\n+    DataStream prefix;\n+    prefix << DBKeys::DESTDATA << EncodeDestination(dest);\n+    return m_batch->ErasePrefix(prefix);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150238393",
      "id" : 1150238393,
      "line" : 1110,
      "node_id" : "PRRC_kwDOABII585Ejz65",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 1110,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 42,
      "pull_request_review_id" : 1360512338,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150238393/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-28T13:17:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150238393",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7444140?v=4",
         "events_url" : "https://api.github.com/users/josibake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/josibake/followers",
         "following_url" : "https://api.github.com/users/josibake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/josibake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/josibake",
         "id" : 7444140,
         "login" : "josibake",
         "node_id" : "MDQ6VXNlcjc0NDQxNDA=",
         "organizations_url" : "https://api.github.com/users/josibake/orgs",
         "received_events_url" : "https://api.github.com/users/josibake/received_events",
         "repos_url" : "https://api.github.com/users/josibake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/josibake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/josibake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/josibake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150513279"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150513279"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: could use structured bindings.\r\n```c++\r\nfor (const auto& [dest, entry] : m_address_book) {\r\n     for (const auto& [id, request] : entry.receive_requests) {\r\n         values.emplace_back(request);\r\n     }\r\n}\r\n```",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-28T12:19:18Z",
      "diff_hunk" : "@@ -2821,65 +2817,46 @@ unsigned int CWallet::ComputeTimeSmart(const CWalletTx& wtx, bool rescanning_old\n \n bool CWallet::SetAddressUsed(WalletBatch& batch, const CTxDestination& dest, bool used)\n {\n-    const std::string key{\"used\"};\n     if (std::get_if<CNoDestination>(&dest))\n         return false;\n \n     if (!used) {\n-        if (auto* data = util::FindKey(m_address_book, dest)) data->destdata.erase(key);\n-        return batch.EraseDestData(EncodeDestination(dest), key);\n+        if (auto* data{util::FindKey(m_address_book, dest)}) data->previously_spent = false;\n+        return batch.WriteAddressPreviouslySpent(dest, false);\n     }\n \n-    const std::string value{\"1\"};\n-    m_address_book[dest].destdata.insert(std::make_pair(key, value));\n-    return batch.WriteDestData(EncodeDestination(dest), key, value);\n-}\n-\n-void CWallet::LoadDestData(const CTxDestination &dest, const std::string &key, const std::string &value)\n-{\n-    m_address_book[dest].destdata.insert(std::make_pair(key, value));\n+    m_address_book[dest].previously_spent = true;\n+    return batch.WriteAddressPreviouslySpent(dest, true);\n }\n \n bool CWallet::IsAddressUsed(const CTxDestination& dest) const\n {\n-    const std::string key{\"used\"};\n-    std::map<CTxDestination, CAddressBookData>::const_iterator i = m_address_book.find(dest);\n-    if(i != m_address_book.end())\n-    {\n-        CAddressBookData::StringMap::const_iterator j = i->second.destdata.find(key);\n-        if(j != i->second.destdata.end())\n-        {\n-            return true;\n-        }\n-    }\n+    if (auto* data{util::FindKey(m_address_book, dest)}) return data->previously_spent;\n     return false;\n }\n \n std::vector<std::string> CWallet::GetAddressReceiveRequests() const\n {\n-    const std::string prefix{\"rr\"};\n     std::vector<std::string> values;\n-    for (const auto& address : m_address_book) {\n-        for (const auto& data : address.second.destdata) {\n-            if (!data.first.compare(0, prefix.size(), prefix)) {\n-                values.emplace_back(data.second);\n-            }\n+    for (const auto& dest : m_address_book) {\n+        for (const auto& request : dest.second.receive_requests) {\n+            values.emplace_back(request.second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150513279",
      "id" : 1150513279,
      "line" : 2843,
      "node_id" : "PRRC_kwDOABII585Ek3B_",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 2843,
      "original_position" : 67,
      "original_start_line" : 2841,
      "path" : "src/wallet/wallet.cpp",
      "position" : 67,
      "pull_request_review_id" : 1360931572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150513279/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2841,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-03-28T13:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150513279",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150523650"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150523650"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No longer the case.\r\nSame for the comment that is above this one.",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-28T12:23:29Z",
      "diff_hunk" : "@@ -2439,11 +2439,7 @@ bool CWallet::DelAddressBook(const CTxDestination& address)\n             return false;\n         }\n         // Delete destdata tuples associated with address",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150523650",
      "id" : 1150523650,
      "line" : 2441,
      "node_id" : "PRRC_kwDOABII585Ek5kC",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 2441,
      "original_position" : 3,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 3,
      "pull_request_review_id" : 1360931572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150523650/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-28T13:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150523650",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150535358"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150535358"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not really for this PR, but.. the `used` arg is never false.\r\n\r\n`SetAddressUsed` is only called from `SetSpentKeyState` which is only called from `AddToWallet`, which provides `used=true`.\r\n\r\nWhich.. means that the address is not reverted to a \"not used\" state if the tx gets abandoned/discarded.\r\n\r\nCould also work on it on a follow-up. Probably after #26836 so changes don't end up conflicting that much.",
      "commit_id" : "d34323544d7283bf46bb154a90b8feca443b103e",
      "created_at" : "2023-03-28T12:32:56Z",
      "diff_hunk" : "@@ -2821,65 +2817,46 @@ unsigned int CWallet::ComputeTimeSmart(const CWalletTx& wtx, bool rescanning_old\n \n bool CWallet::SetAddressUsed(WalletBatch& batch, const CTxDestination& dest, bool used)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150535358",
      "id" : 1150535358,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Ek8a-",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 2818,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1360931572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150535358/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-06T20:13:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150535358",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150538791"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150538791"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This method was removed from the cpp but not from the header.",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-28T12:35:30Z",
      "diff_hunk" : "@@ -2821,65 +2817,46 @@ unsigned int CWallet::ComputeTimeSmart(const CWalletTx& wtx, bool rescanning_old\n \n bool CWallet::SetAddressUsed(WalletBatch& batch, const CTxDestination& dest, bool used)\n {\n-    const std::string key{\"used\"};\n     if (std::get_if<CNoDestination>(&dest))\n         return false;\n \n     if (!used) {\n-        if (auto* data = util::FindKey(m_address_book, dest)) data->destdata.erase(key);\n-        return batch.EraseDestData(EncodeDestination(dest), key);\n+        if (auto* data{util::FindKey(m_address_book, dest)}) data->previously_spent = false;\n+        return batch.WriteAddressPreviouslySpent(dest, false);\n     }\n \n-    const std::string value{\"1\"};\n-    m_address_book[dest].destdata.insert(std::make_pair(key, value));\n-    return batch.WriteDestData(EncodeDestination(dest), key, value);\n-}\n-\n-void CWallet::LoadDestData(const CTxDestination &dest, const std::string &key, const std::string &value)\n-{\n-    m_address_book[dest].destdata.insert(std::make_pair(key, value));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150538791",
      "id" : 1150538791,
      "line" : 2840,
      "node_id" : "PRRC_kwDOABII585Ek9Qn",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 2840,
      "original_position" : 35,
      "original_start_line" : 2838,
      "path" : "src/wallet/wallet.cpp",
      "position" : 35,
      "pull_request_review_id" : 1360931572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150538791/reactions"
      },
      "side" : "LEFT",
      "start_line" : 2838,
      "start_side" : "LEFT",
      "subject_type" : "line",
      "updated_at" : "2023-03-28T13:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150538791",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150541159"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150541159"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Would be good to keep the encapsulation and don't access `m_address_book` from outside of the wallet class (otherwise we are reverting #25337 and, future, #26836). ",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-28T12:37:28Z",
      "diff_hunk" : "@@ -609,7 +609,12 @@ ReadKeyValue(CWallet* pwallet, DataStream& ssKey, CDataStream& ssValue,\n             ssKey >> strAddress;\n             ssKey >> strKey;\n             ssValue >> strValue;\n-            pwallet->LoadDestData(DecodeDestination(strAddress), strKey, strValue);\n+            CAddressBookData& data{pwallet->m_address_book[DecodeDestination(strAddress)]};\n+            if (strKey.compare(\"used\") == 0) {\n+                data.previously_spent = true;\n+            } else if (strKey.compare(0, 2, \"rr\") == 0) {\n+                data.receive_requests[strKey.substr(2)] = std::move(strValue);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150541159",
      "id" : 1150541159,
      "line" : 616,
      "node_id" : "PRRC_kwDOABII585Ek91n",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 616,
      "original_position" : 9,
      "original_start_line" : 612,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 9,
      "pull_request_review_id" : 1360931572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150541159/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 612,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-03-28T13:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150541159",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150567795"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150567795"
         }
      },
      "author_association" : "MEMBER",
      "body" : "this also fixes abdef47f206dec114300b2d852f5c297b03179e3 (from #26644)",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-28T12:55:35Z",
      "diff_hunk" : "@@ -656,12 +656,14 @@ void BerkeleyDatabase::ReloadDbEnv()\n     env->ReloadDbEnv();\n }\n \n-BerkeleyCursor::BerkeleyCursor(BerkeleyDatabase& database)\n+BerkeleyCursor::BerkeleyCursor(BerkeleyDatabase& database, BerkeleyBatch* batch)\n {\n     if (!database.m_db.get()) {\n         throw std::runtime_error(STR_INTERNAL_BUG(\"BerkeleyDatabase does not exist\"));\n     }\n-    int ret = database.m_db->cursor(nullptr, &m_cursor, 0);\n+    // Transaction argument to cursor is only needed when using the cursor to\n+    // write to the database. Read-only cursors do not need a txn pointer.\n+    int ret = database.m_db->cursor(batch ? batch->txn() : nullptr, &m_cursor, 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150567795",
      "id" : 1150567795,
      "line" : 666,
      "node_id" : "PRRC_kwDOABII585ElEVz",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 666,
      "original_position" : 13,
      "original_start_line" : 664,
      "path" : "src/wallet/bdb.cpp",
      "position" : 13,
      "pull_request_review_id" : 1360931572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150567795/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 664,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-03-28T13:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150567795",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150572914"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150572914"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could\r\n```c++\r\nBOOST_CHECK_EQUAL(wallet->LoadWallet(), DBErrors::::LOAD_OK);\r\n```\r\n",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-28T12:59:21Z",
      "diff_hunk" : "@@ -427,19 +427,63 @@ BOOST_AUTO_TEST_CASE(ComputeTimeSmart)\n     BOOST_CHECK_EQUAL(AddTx(*m_node.chainman, m_wallet, 5, 50, 600), 300);\n }\n \n-BOOST_AUTO_TEST_CASE(LoadReceiveRequests)\n+static const DatabaseFormat DATABASE_FORMATS[] = {\n+#ifdef USE_SQLITE\n+    DatabaseFormat::SQLITE,\n+#endif\n+#ifdef USE_BDB\n+    DatabaseFormat::BERKELEY,\n+#endif\n+};\n+\n+void TestLoadWallet(const std::string& name, DatabaseFormat format, std::function<void(std::shared_ptr<CWallet>)> f)\n {\n-    CTxDestination dest = PKHash();\n-    LOCK(m_wallet.cs_wallet);\n-    WalletBatch batch{m_wallet.GetDatabase()};\n-    m_wallet.SetAddressUsed(batch, dest, true);\n-    m_wallet.SetAddressReceiveRequest(batch, dest, \"0\", \"val_rr0\");\n-    m_wallet.SetAddressReceiveRequest(batch, dest, \"1\", \"val_rr1\");\n-\n-    auto values = m_wallet.GetAddressReceiveRequests();\n-    BOOST_CHECK_EQUAL(values.size(), 2U);\n-    BOOST_CHECK_EQUAL(values[0], \"val_rr0\");\n-    BOOST_CHECK_EQUAL(values[1], \"val_rr1\");\n+    node::NodeContext node;\n+    auto chain{interfaces::MakeChain(node)};\n+    DatabaseOptions options;\n+    options.require_format = format;\n+    DatabaseStatus status;\n+    bilingual_str error;\n+    std::vector<bilingual_str> warnings;\n+    auto database{MakeWalletDatabase(name, options, status, error)};\n+    auto wallet{std::make_shared<CWallet>(chain.get(), \"\", std::move(database))};\n+    wallet->LoadWallet();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150572914",
      "id" : 1150572914,
      "line" : 450,
      "node_id" : "PRRC_kwDOABII585ElFly",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 450,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/wallet/test/wallet_tests.cpp",
      "position" : 36,
      "pull_request_review_id" : 1360931572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150572914/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-28T13:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150572914",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150579720"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150579720"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same as above, would be good to not access `m_address_book` directly from outside of the wallet class.\r\nThe map [] operator usage in a random place of the sources could easily screw things up.\r\n\r\nCould change it to\r\n```c++\r\nBOOST_CHECK(!wallet->IsAddressUsed(PKHash()));\r\n```",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-28T13:04:35Z",
      "diff_hunk" : "@@ -427,19 +427,63 @@ BOOST_AUTO_TEST_CASE(ComputeTimeSmart)\n     BOOST_CHECK_EQUAL(AddTx(*m_node.chainman, m_wallet, 5, 50, 600), 300);\n }\n \n-BOOST_AUTO_TEST_CASE(LoadReceiveRequests)\n+static const DatabaseFormat DATABASE_FORMATS[] = {\n+#ifdef USE_SQLITE\n+    DatabaseFormat::SQLITE,\n+#endif\n+#ifdef USE_BDB\n+    DatabaseFormat::BERKELEY,\n+#endif\n+};\n+\n+void TestLoadWallet(const std::string& name, DatabaseFormat format, std::function<void(std::shared_ptr<CWallet>)> f)\n {\n-    CTxDestination dest = PKHash();\n-    LOCK(m_wallet.cs_wallet);\n-    WalletBatch batch{m_wallet.GetDatabase()};\n-    m_wallet.SetAddressUsed(batch, dest, true);\n-    m_wallet.SetAddressReceiveRequest(batch, dest, \"0\", \"val_rr0\");\n-    m_wallet.SetAddressReceiveRequest(batch, dest, \"1\", \"val_rr1\");\n-\n-    auto values = m_wallet.GetAddressReceiveRequests();\n-    BOOST_CHECK_EQUAL(values.size(), 2U);\n-    BOOST_CHECK_EQUAL(values[0], \"val_rr0\");\n-    BOOST_CHECK_EQUAL(values[1], \"val_rr1\");\n+    node::NodeContext node;\n+    auto chain{interfaces::MakeChain(node)};\n+    DatabaseOptions options;\n+    options.require_format = format;\n+    DatabaseStatus status;\n+    bilingual_str error;\n+    std::vector<bilingual_str> warnings;\n+    auto database{MakeWalletDatabase(name, options, status, error)};\n+    auto wallet{std::make_shared<CWallet>(chain.get(), \"\", std::move(database))};\n+    wallet->LoadWallet();\n+    WITH_LOCK(wallet->cs_wallet, f(wallet));\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(LoadReceiveRequests, TestingSetup)\n+{\n+    for (DatabaseFormat format : DATABASE_FORMATS) {\n+        const std::string name{strprintf(\"receive-requests-%i\", format)};\n+        TestLoadWallet(name, format, [](std::shared_ptr<CWallet> wallet) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet) {\n+            BOOST_CHECK(!wallet->m_address_book[PKHash()].previously_spent);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150579720",
      "id" : 1150579720,
      "line" : 459,
      "node_id" : "PRRC_kwDOABII585ElHQI",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 459,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/wallet/test/wallet_tests.cpp",
      "position" : 45,
      "pull_request_review_id" : 1360931572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150579720/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-03-28T13:14:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150579720",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150583313"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150583313"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```c++\r\nBOOST_CHECK(wallet->IsAddressUsed(PKHash()));\r\nBOOST_CHECK(wallet->IsAddressUsed(ScriptHash()));\r\n```",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-28T13:07:18Z",
      "diff_hunk" : "@@ -427,19 +427,63 @@ BOOST_AUTO_TEST_CASE(ComputeTimeSmart)\n     BOOST_CHECK_EQUAL(AddTx(*m_node.chainman, m_wallet, 5, 50, 600), 300);\n }\n \n-BOOST_AUTO_TEST_CASE(LoadReceiveRequests)\n+static const DatabaseFormat DATABASE_FORMATS[] = {\n+#ifdef USE_SQLITE\n+    DatabaseFormat::SQLITE,\n+#endif\n+#ifdef USE_BDB\n+    DatabaseFormat::BERKELEY,\n+#endif\n+};\n+\n+void TestLoadWallet(const std::string& name, DatabaseFormat format, std::function<void(std::shared_ptr<CWallet>)> f)\n {\n-    CTxDestination dest = PKHash();\n-    LOCK(m_wallet.cs_wallet);\n-    WalletBatch batch{m_wallet.GetDatabase()};\n-    m_wallet.SetAddressUsed(batch, dest, true);\n-    m_wallet.SetAddressReceiveRequest(batch, dest, \"0\", \"val_rr0\");\n-    m_wallet.SetAddressReceiveRequest(batch, dest, \"1\", \"val_rr1\");\n-\n-    auto values = m_wallet.GetAddressReceiveRequests();\n-    BOOST_CHECK_EQUAL(values.size(), 2U);\n-    BOOST_CHECK_EQUAL(values[0], \"val_rr0\");\n-    BOOST_CHECK_EQUAL(values[1], \"val_rr1\");\n+    node::NodeContext node;\n+    auto chain{interfaces::MakeChain(node)};\n+    DatabaseOptions options;\n+    options.require_format = format;\n+    DatabaseStatus status;\n+    bilingual_str error;\n+    std::vector<bilingual_str> warnings;\n+    auto database{MakeWalletDatabase(name, options, status, error)};\n+    auto wallet{std::make_shared<CWallet>(chain.get(), \"\", std::move(database))};\n+    wallet->LoadWallet();\n+    WITH_LOCK(wallet->cs_wallet, f(wallet));\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(LoadReceiveRequests, TestingSetup)\n+{\n+    for (DatabaseFormat format : DATABASE_FORMATS) {\n+        const std::string name{strprintf(\"receive-requests-%i\", format)};\n+        TestLoadWallet(name, format, [](std::shared_ptr<CWallet> wallet) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet) {\n+            BOOST_CHECK(!wallet->m_address_book[PKHash()].previously_spent);\n+            WalletBatch batch{wallet->GetDatabase()};\n+            BOOST_CHECK(batch.WriteAddressPreviouslySpent(PKHash(), true));\n+            BOOST_CHECK(batch.WriteAddressPreviouslySpent(ScriptHash(), true));\n+            BOOST_CHECK(wallet->SetAddressReceiveRequest(batch, PKHash(), \"0\", \"val_rr00\"));\n+            BOOST_CHECK(wallet->EraseAddressReceiveRequest(batch, PKHash(), \"0\"));\n+            BOOST_CHECK(wallet->SetAddressReceiveRequest(batch, PKHash(), \"1\", \"val_rr10\"));\n+            BOOST_CHECK(wallet->SetAddressReceiveRequest(batch, PKHash(), \"1\", \"val_rr11\"));\n+            BOOST_CHECK(wallet->SetAddressReceiveRequest(batch, ScriptHash(), \"2\", \"val_rr20\"));\n+        });\n+        TestLoadWallet(name, format, [](std::shared_ptr<CWallet> wallet) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet) {\n+            BOOST_CHECK(wallet->m_address_book[PKHash()].previously_spent);\n+            BOOST_CHECK(wallet->m_address_book[ScriptHash()].previously_spent);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150583313",
      "id" : 1150583313,
      "line" : 471,
      "node_id" : "PRRC_kwDOABII585ElIIR",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 471,
      "original_position" : 57,
      "original_start_line" : 470,
      "path" : "src/wallet/test/wallet_tests.cpp",
      "position" : 57,
      "pull_request_review_id" : 1360931572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150583313/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 470,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-03-28T13:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150583313",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150586523"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150586523"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```c++\r\nBOOST_CHECK(!wallet->IsAddressUsed(PKHash()));\r\nBOOST_CHECK(!wallet->IsAddressUsed(ScriptHash()));\r\n```",
      "commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "created_at" : "2023-03-28T13:09:39Z",
      "diff_hunk" : "@@ -427,19 +427,63 @@ BOOST_AUTO_TEST_CASE(ComputeTimeSmart)\n     BOOST_CHECK_EQUAL(AddTx(*m_node.chainman, m_wallet, 5, 50, 600), 300);\n }\n \n-BOOST_AUTO_TEST_CASE(LoadReceiveRequests)\n+static const DatabaseFormat DATABASE_FORMATS[] = {\n+#ifdef USE_SQLITE\n+    DatabaseFormat::SQLITE,\n+#endif\n+#ifdef USE_BDB\n+    DatabaseFormat::BERKELEY,\n+#endif\n+};\n+\n+void TestLoadWallet(const std::string& name, DatabaseFormat format, std::function<void(std::shared_ptr<CWallet>)> f)\n {\n-    CTxDestination dest = PKHash();\n-    LOCK(m_wallet.cs_wallet);\n-    WalletBatch batch{m_wallet.GetDatabase()};\n-    m_wallet.SetAddressUsed(batch, dest, true);\n-    m_wallet.SetAddressReceiveRequest(batch, dest, \"0\", \"val_rr0\");\n-    m_wallet.SetAddressReceiveRequest(batch, dest, \"1\", \"val_rr1\");\n-\n-    auto values = m_wallet.GetAddressReceiveRequests();\n-    BOOST_CHECK_EQUAL(values.size(), 2U);\n-    BOOST_CHECK_EQUAL(values[0], \"val_rr0\");\n-    BOOST_CHECK_EQUAL(values[1], \"val_rr1\");\n+    node::NodeContext node;\n+    auto chain{interfaces::MakeChain(node)};\n+    DatabaseOptions options;\n+    options.require_format = format;\n+    DatabaseStatus status;\n+    bilingual_str error;\n+    std::vector<bilingual_str> warnings;\n+    auto database{MakeWalletDatabase(name, options, status, error)};\n+    auto wallet{std::make_shared<CWallet>(chain.get(), \"\", std::move(database))};\n+    wallet->LoadWallet();\n+    WITH_LOCK(wallet->cs_wallet, f(wallet));\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(LoadReceiveRequests, TestingSetup)\n+{\n+    for (DatabaseFormat format : DATABASE_FORMATS) {\n+        const std::string name{strprintf(\"receive-requests-%i\", format)};\n+        TestLoadWallet(name, format, [](std::shared_ptr<CWallet> wallet) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet) {\n+            BOOST_CHECK(!wallet->m_address_book[PKHash()].previously_spent);\n+            WalletBatch batch{wallet->GetDatabase()};\n+            BOOST_CHECK(batch.WriteAddressPreviouslySpent(PKHash(), true));\n+            BOOST_CHECK(batch.WriteAddressPreviouslySpent(ScriptHash(), true));\n+            BOOST_CHECK(wallet->SetAddressReceiveRequest(batch, PKHash(), \"0\", \"val_rr00\"));\n+            BOOST_CHECK(wallet->EraseAddressReceiveRequest(batch, PKHash(), \"0\"));\n+            BOOST_CHECK(wallet->SetAddressReceiveRequest(batch, PKHash(), \"1\", \"val_rr10\"));\n+            BOOST_CHECK(wallet->SetAddressReceiveRequest(batch, PKHash(), \"1\", \"val_rr11\"));\n+            BOOST_CHECK(wallet->SetAddressReceiveRequest(batch, ScriptHash(), \"2\", \"val_rr20\"));\n+        });\n+        TestLoadWallet(name, format, [](std::shared_ptr<CWallet> wallet) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet) {\n+            BOOST_CHECK(wallet->m_address_book[PKHash()].previously_spent);\n+            BOOST_CHECK(wallet->m_address_book[ScriptHash()].previously_spent);\n+            auto requests = wallet->GetAddressReceiveRequests();\n+            auto erequests = {\"val_rr11\", \"val_rr20\"};\n+            BOOST_CHECK_EQUAL_COLLECTIONS(requests.begin(), requests.end(), std::begin(erequests), std::end(erequests));\n+            WalletBatch batch{wallet->GetDatabase()};\n+            BOOST_CHECK(batch.WriteAddressPreviouslySpent(PKHash(), false));\n+            BOOST_CHECK(batch.EraseAddressData(ScriptHash()));\n+        });\n+        TestLoadWallet(name, format, [](std::shared_ptr<CWallet> wallet) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet) {\n+            BOOST_CHECK(!wallet->m_address_book[PKHash()].previously_spent);\n+            BOOST_CHECK(!wallet->m_address_book[ScriptHash()].previously_spent);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150586523",
      "id" : 1150586523,
      "line" : 481,
      "node_id" : "PRRC_kwDOABII585ElI6b",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 481,
      "original_position" : 67,
      "original_start_line" : 480,
      "path" : "src/wallet/test/wallet_tests.cpp",
      "position" : 67,
      "pull_request_review_id" : 1360931572,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150586523/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 480,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-03-28T13:13:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1150586523",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@furszy, thanks for the thorough review. I will start implementing your suggestions, but do you think you could help me with your comments about encapsulation like https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150541159?\r\n\r\nThe comments are just a little vague from my perspective so it'd be great if you could provide specific code suggestions and I will apply or implement them. For background, I've been a little detached from the address encapsulation attempt, and personally like m_address_book.find(dest) / m_addressbook[dest] lookups and for loops a little better than calling FindAddress/FindOrInsertAddress/ForAddresses wrapper functions. But I don't have a strong opinion and am happy to use wrappers, I just think you would be better at suggesting with names / parameters since you have been designing the API and know more about the goals.",
      "created_at" : "2023-03-28T14:03:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#issuecomment-1486957262",
      "id" : 1486957262,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27224",
      "node_id" : "IC_kwDOABII585YoSrO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1486957262/reactions"
      },
      "updated_at" : "2023-03-28T14:03:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1486957262",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> @furszy, thanks for the thorough review. I will start implementing your suggestions, but do you think you could help me with your comments about encapsulation like [#27224 (comment)](https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150541159)?\r\n> \r\n> For background, I've been a little detached from the address encapsulation attempt, and personally like m_address_book.find(dest) / m_addressbook[dest] lookups and for loops a little better than calling FindAddress/FindOrInsertAddress/ForAddresses wrapper functions. But I don't have a strong opinion and am happy to use wrappers, I just think you would be better at suggesting with names / parameters since you have been designing the API and know more about the goals.\r\n\r\nYeah ok.\r\n\r\nThe main purpose of address book encapsulation is prevent people from accidentally modifying the âpurposeâ field in an RPC command or the GUI, or from creating a new entry by misusing the map's [] operator. Which it could lead, in the worst-case scenario, to a \"send\" address being relabeled as a \"receive\" address, resulting in a user sending funds to an address they do not own while thinking they do.\r\n\r\nI know that it didnât happen so far but.. itâs a big project and I think that we shouldnât assume that everyone touching the GUI and/or the RPC commands are aware of the internal address book usage (e.g. #25979). Simpler to just forget about this possible issue by letting people access entries through an interface.\r\n\r\nAlso, the encapsulation will let us use another mutex for the address book, so commands like `setlabel`, `getaddressbylabel` etc will be able to run `cs_wallet` free (not such a big feature but it adds value).\r\n\r\n> The comments are just a little vague from my perspective so it'd be great if you could provide specific code suggestions and I will apply or implement them. \r\n\r\nSadly, the cleanest implementation would come after #24914, when we load the wallet in-order, first read the address book entry, then âdest dataâ etc.\r\nWe are currently forced to append new address book entries while we loop over  the âusedâ and ârequestsâ db records because the entry could not exist yet.. which is ugly and adds more boilerplate code.\r\n\r\nAbout the API naming, we still have a mixture of names there.\r\nBut we could continue moving toward the usage of `LoadXXX` prefix for methods that are only relevant for the loading process. We are already using this term for the spkms and other members. Thoughts?.\r\n\r\nThen, in the future, to not allow calling this `LoadXXX` methods from RPC related code, same as we do in the GUI, would be nice to start using the wallet interface there instead of directly access the `CWallet` object (not sure if there are plans for this already).\r\n\r\nBut anyway, future stuff.\r\nHere is the small commit for this https://github.com/furszy/bitcoin-core/commit/2195b1e3288f1019f81fc76c584519bd1d158f59. Check if you like it. Itâs not a big deal.\r\n\r\n--------------\r\n\r\nAnother idea:\r\nOnce we make the address book member private, we could allow direct access only from `LoadWallet` by making a new \"loading\" class that has `CWallet` as friend. This would remove the `LoadXXX` encapsulation boilerplate if that is what makes you doubt about it.",
      "created_at" : "2023-03-28T17:17:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#issuecomment-1487314169",
      "id" : 1487314169,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27224",
      "node_id" : "IC_kwDOABII585Yppz5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 1,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1487314169/reactions"
      },
      "updated_at" : "2023-03-28T19:46:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1487314169",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1158949529"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1158949529"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27224/files#r1150232826\r\n\r\n> you have a reason to prefer `Span<std::byte>`?\r\n\r\nWell it should actually take a span of const bytes, so I fixed this to add const.\r\n\r\nPassing a span makes more sense than passing a datastream because the function just needs a read-only array of bytes, it doesn't need a read/write vector or a stream object or anything more complicated.\r\n\r\nThe other functions are using CDataStream just because they are called by older code which might be counting on them to call memory_cleanse, and would require extra work to convert to spans, though it was tried previously in #19320",
      "commit_id" : "d34323544d7283bf46bb154a90b8feca443b103e",
      "created_at" : "2023-04-05T19:53:18Z",
      "diff_hunk" : "@@ -205,6 +206,7 @@ class BerkeleyBatch : public DatabaseBatch\n     bool WriteKey(DataStream&& key, DataStream&& value, bool overwrite = true) override;\n     bool EraseKey(DataStream&& key) override;\n     bool HasKey(DataStream&& key) override;\n+    bool ErasePrefix(Span<std::byte> prefix) override;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1158949529",
      "id" : 1158949529,
      "in_reply_to_id" : 1150232826,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FFCqZ",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 209,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.h",
      "position" : null,
      "pull_request_review_id" : 1373581514,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1158949529/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-06T20:07:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1158949529",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1159265608"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1159265608"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150572914\r\n\r\n> ```c++\r\n> BOOST_CHECK_EQUAL(wallet->LoadWallet(), DBErrors::::LOAD_OK);\r\n> ```\r\n\r\nThanks, added this check",
      "commit_id" : "d34323544d7283bf46bb154a90b8feca443b103e",
      "created_at" : "2023-04-06T04:18:06Z",
      "diff_hunk" : "@@ -427,19 +427,63 @@ BOOST_AUTO_TEST_CASE(ComputeTimeSmart)\n     BOOST_CHECK_EQUAL(AddTx(*m_node.chainman, m_wallet, 5, 50, 600), 300);\n }\n \n-BOOST_AUTO_TEST_CASE(LoadReceiveRequests)\n+static const DatabaseFormat DATABASE_FORMATS[] = {\n+#ifdef USE_SQLITE\n+    DatabaseFormat::SQLITE,\n+#endif\n+#ifdef USE_BDB\n+    DatabaseFormat::BERKELEY,\n+#endif\n+};\n+\n+void TestLoadWallet(const std::string& name, DatabaseFormat format, std::function<void(std::shared_ptr<CWallet>)> f)\n {\n-    CTxDestination dest = PKHash();\n-    LOCK(m_wallet.cs_wallet);\n-    WalletBatch batch{m_wallet.GetDatabase()};\n-    m_wallet.SetAddressUsed(batch, dest, true);\n-    m_wallet.SetAddressReceiveRequest(batch, dest, \"0\", \"val_rr0\");\n-    m_wallet.SetAddressReceiveRequest(batch, dest, \"1\", \"val_rr1\");\n-\n-    auto values = m_wallet.GetAddressReceiveRequests();\n-    BOOST_CHECK_EQUAL(values.size(), 2U);\n-    BOOST_CHECK_EQUAL(values[0], \"val_rr0\");\n-    BOOST_CHECK_EQUAL(values[1], \"val_rr1\");\n+    node::NodeContext node;\n+    auto chain{interfaces::MakeChain(node)};\n+    DatabaseOptions options;\n+    options.require_format = format;\n+    DatabaseStatus status;\n+    bilingual_str error;\n+    std::vector<bilingual_str> warnings;\n+    auto database{MakeWalletDatabase(name, options, status, error)};\n+    auto wallet{std::make_shared<CWallet>(chain.get(), \"\", std::move(database))};\n+    wallet->LoadWallet();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1159265608",
      "id" : 1159265608,
      "in_reply_to_id" : 1150572914,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FGP1I",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 450,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/wallet/test/wallet_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1373581514,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1159265608/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-06T20:07:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1159265608",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1160133066"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160133066"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150513279\r\n\r\n> nit: could use structured bindings.\r\n\r\nThanks, applied suggestion",
      "commit_id" : "d34323544d7283bf46bb154a90b8feca443b103e",
      "created_at" : "2023-04-06T18:35:00Z",
      "diff_hunk" : "@@ -2821,65 +2817,46 @@ unsigned int CWallet::ComputeTimeSmart(const CWalletTx& wtx, bool rescanning_old\n \n bool CWallet::SetAddressUsed(WalletBatch& batch, const CTxDestination& dest, bool used)\n {\n-    const std::string key{\"used\"};\n     if (std::get_if<CNoDestination>(&dest))\n         return false;\n \n     if (!used) {\n-        if (auto* data = util::FindKey(m_address_book, dest)) data->destdata.erase(key);\n-        return batch.EraseDestData(EncodeDestination(dest), key);\n+        if (auto* data{util::FindKey(m_address_book, dest)}) data->previously_spent = false;\n+        return batch.WriteAddressPreviouslySpent(dest, false);\n     }\n \n-    const std::string value{\"1\"};\n-    m_address_book[dest].destdata.insert(std::make_pair(key, value));\n-    return batch.WriteDestData(EncodeDestination(dest), key, value);\n-}\n-\n-void CWallet::LoadDestData(const CTxDestination &dest, const std::string &key, const std::string &value)\n-{\n-    m_address_book[dest].destdata.insert(std::make_pair(key, value));\n+    m_address_book[dest].previously_spent = true;\n+    return batch.WriteAddressPreviouslySpent(dest, true);\n }\n \n bool CWallet::IsAddressUsed(const CTxDestination& dest) const\n {\n-    const std::string key{\"used\"};\n-    std::map<CTxDestination, CAddressBookData>::const_iterator i = m_address_book.find(dest);\n-    if(i != m_address_book.end())\n-    {\n-        CAddressBookData::StringMap::const_iterator j = i->second.destdata.find(key);\n-        if(j != i->second.destdata.end())\n-        {\n-            return true;\n-        }\n-    }\n+    if (auto* data{util::FindKey(m_address_book, dest)}) return data->previously_spent;\n     return false;\n }\n \n std::vector<std::string> CWallet::GetAddressReceiveRequests() const\n {\n-    const std::string prefix{\"rr\"};\n     std::vector<std::string> values;\n-    for (const auto& address : m_address_book) {\n-        for (const auto& data : address.second.destdata) {\n-            if (!data.first.compare(0, prefix.size(), prefix)) {\n-                values.emplace_back(data.second);\n-            }\n+    for (const auto& dest : m_address_book) {\n+        for (const auto& request : dest.second.receive_requests) {\n+            values.emplace_back(request.second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1160133066",
      "id" : 1160133066,
      "in_reply_to_id" : 1150513279,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FJjnK",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 2843,
      "original_position" : 67,
      "original_start_line" : 2841,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1373581514,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160133066/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-04-06T20:07:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160133066",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1160135250"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160135250"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150541159\r\n\r\n> Would be good to keep the encapsulation and don't access `m_address_book` from outside of the wallet class (otherwise we are reverting #25337 and, future, #26836).\r\n\r\nThanks, applied your change (https://github.com/furszy/bitcoin-core/commit/2195b1e3288f1019f81fc76c584519bd1d158f59)",
      "commit_id" : "d34323544d7283bf46bb154a90b8feca443b103e",
      "created_at" : "2023-04-06T18:37:48Z",
      "diff_hunk" : "@@ -609,7 +609,12 @@ ReadKeyValue(CWallet* pwallet, DataStream& ssKey, CDataStream& ssValue,\n             ssKey >> strAddress;\n             ssKey >> strKey;\n             ssValue >> strValue;\n-            pwallet->LoadDestData(DecodeDestination(strAddress), strKey, strValue);\n+            CAddressBookData& data{pwallet->m_address_book[DecodeDestination(strAddress)]};\n+            if (strKey.compare(\"used\") == 0) {\n+                data.previously_spent = true;\n+            } else if (strKey.compare(0, 2, \"rr\") == 0) {\n+                data.receive_requests[strKey.substr(2)] = std::move(strValue);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1160135250",
      "id" : 1160135250,
      "in_reply_to_id" : 1150541159,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FJkJS",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 616,
      "original_position" : 9,
      "original_start_line" : 612,
      "path" : "src/wallet/walletdb.cpp",
      "position" : null,
      "pull_request_review_id" : 1373581514,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160135250/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-04-06T20:07:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160135250",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1160135564"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160135564"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150238393\r\n\r\n> to make this an `rvalue`. there is likely a cleaner way to do this, if you end up going with `DataStream`\r\n\r\nThanks, responded to earlier comment",
      "commit_id" : "d34323544d7283bf46bb154a90b8feca443b103e",
      "created_at" : "2023-04-06T18:38:10Z",
      "diff_hunk" : "@@ -1082,16 +1087,28 @@ void MaybeCompactWalletDB(WalletContext& context)\n     fOneThread = false;\n }\n \n-bool WalletBatch::WriteDestData(const std::string &address, const std::string &key, const std::string &value)\n+bool WalletBatch::WriteAddressPreviouslySpent(const CTxDestination& dest, bool previously_spent)\n+{\n+    auto key{std::make_pair(DBKeys::DESTDATA, std::make_pair(EncodeDestination(dest), std::string(\"used\")))};\n+    return previously_spent ? WriteIC(key, std::string(\"1\")) : EraseIC(key);\n+}\n+\n+bool WalletBatch::WriteAddressReceiveRequest(const CTxDestination& dest, const std::string& id, const std::string& receive_request)\n {\n-    return WriteIC(std::make_pair(DBKeys::DESTDATA, std::make_pair(address, key)), value);\n+    return WriteIC(std::make_pair(DBKeys::DESTDATA, std::make_pair(EncodeDestination(dest), \"rr\" + id)), receive_request);\n }\n \n-bool WalletBatch::EraseDestData(const std::string &address, const std::string &key)\n+bool WalletBatch::EraseAddressReceiveRequest(const CTxDestination& dest, const std::string& id)\n {\n-    return EraseIC(std::make_pair(DBKeys::DESTDATA, std::make_pair(address, key)));\n+    return EraseIC(std::make_pair(DBKeys::DESTDATA, std::make_pair(EncodeDestination(dest), \"rr\" + id)));\n }\n \n+bool WalletBatch::EraseAddressData(const CTxDestination& dest)\n+{\n+    DataStream prefix;\n+    prefix << DBKeys::DESTDATA << EncodeDestination(dest);\n+    return m_batch->ErasePrefix(prefix);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1160135564",
      "id" : 1160135564,
      "in_reply_to_id" : 1150238393,
      "line" : 1110,
      "node_id" : "PRRC_kwDOABII585FJkOM",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 1110,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/wallet/walletdb.cpp",
      "position" : 42,
      "pull_request_review_id" : 1373581514,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160135564/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-06T20:07:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160135564",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1160137866"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160137866"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150579720\r\n\r\n> ```c++\r\n> BOOST_CHECK(!wallet->IsAddressUsed(PKHash()));\r\n> ```\r\n\r\nThanks applied your suggested change (https://github.com/furszy/bitcoin-core/commit/2195b1e3288f1019f81fc76c584519bd1d158f59)",
      "commit_id" : "d34323544d7283bf46bb154a90b8feca443b103e",
      "created_at" : "2023-04-06T18:40:52Z",
      "diff_hunk" : "@@ -427,19 +427,63 @@ BOOST_AUTO_TEST_CASE(ComputeTimeSmart)\n     BOOST_CHECK_EQUAL(AddTx(*m_node.chainman, m_wallet, 5, 50, 600), 300);\n }\n \n-BOOST_AUTO_TEST_CASE(LoadReceiveRequests)\n+static const DatabaseFormat DATABASE_FORMATS[] = {\n+#ifdef USE_SQLITE\n+    DatabaseFormat::SQLITE,\n+#endif\n+#ifdef USE_BDB\n+    DatabaseFormat::BERKELEY,\n+#endif\n+};\n+\n+void TestLoadWallet(const std::string& name, DatabaseFormat format, std::function<void(std::shared_ptr<CWallet>)> f)\n {\n-    CTxDestination dest = PKHash();\n-    LOCK(m_wallet.cs_wallet);\n-    WalletBatch batch{m_wallet.GetDatabase()};\n-    m_wallet.SetAddressUsed(batch, dest, true);\n-    m_wallet.SetAddressReceiveRequest(batch, dest, \"0\", \"val_rr0\");\n-    m_wallet.SetAddressReceiveRequest(batch, dest, \"1\", \"val_rr1\");\n-\n-    auto values = m_wallet.GetAddressReceiveRequests();\n-    BOOST_CHECK_EQUAL(values.size(), 2U);\n-    BOOST_CHECK_EQUAL(values[0], \"val_rr0\");\n-    BOOST_CHECK_EQUAL(values[1], \"val_rr1\");\n+    node::NodeContext node;\n+    auto chain{interfaces::MakeChain(node)};\n+    DatabaseOptions options;\n+    options.require_format = format;\n+    DatabaseStatus status;\n+    bilingual_str error;\n+    std::vector<bilingual_str> warnings;\n+    auto database{MakeWalletDatabase(name, options, status, error)};\n+    auto wallet{std::make_shared<CWallet>(chain.get(), \"\", std::move(database))};\n+    wallet->LoadWallet();\n+    WITH_LOCK(wallet->cs_wallet, f(wallet));\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(LoadReceiveRequests, TestingSetup)\n+{\n+    for (DatabaseFormat format : DATABASE_FORMATS) {\n+        const std::string name{strprintf(\"receive-requests-%i\", format)};\n+        TestLoadWallet(name, format, [](std::shared_ptr<CWallet> wallet) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet) {\n+            BOOST_CHECK(!wallet->m_address_book[PKHash()].previously_spent);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1160137866",
      "id" : 1160137866,
      "in_reply_to_id" : 1150579720,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FJkyK",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 459,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/wallet/test/wallet_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1373581514,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160137866/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-06T20:07:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160137866",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1160138381"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160138381"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150583313\r\n\r\n> ```c++\r\n> BOOST_CHECK(wallet->IsAddressUsed(PKHash()));\r\n> BOOST_CHECK(wallet->IsAddressUsed(ScriptHash()));\r\n> ```\r\n\r\nThanks applied your suggested change (https://github.com/furszy/bitcoin-core/commit/2195b1e3288f1019f81fc76c584519bd1d158f59)",
      "commit_id" : "d34323544d7283bf46bb154a90b8feca443b103e",
      "created_at" : "2023-04-06T18:41:32Z",
      "diff_hunk" : "@@ -427,19 +427,63 @@ BOOST_AUTO_TEST_CASE(ComputeTimeSmart)\n     BOOST_CHECK_EQUAL(AddTx(*m_node.chainman, m_wallet, 5, 50, 600), 300);\n }\n \n-BOOST_AUTO_TEST_CASE(LoadReceiveRequests)\n+static const DatabaseFormat DATABASE_FORMATS[] = {\n+#ifdef USE_SQLITE\n+    DatabaseFormat::SQLITE,\n+#endif\n+#ifdef USE_BDB\n+    DatabaseFormat::BERKELEY,\n+#endif\n+};\n+\n+void TestLoadWallet(const std::string& name, DatabaseFormat format, std::function<void(std::shared_ptr<CWallet>)> f)\n {\n-    CTxDestination dest = PKHash();\n-    LOCK(m_wallet.cs_wallet);\n-    WalletBatch batch{m_wallet.GetDatabase()};\n-    m_wallet.SetAddressUsed(batch, dest, true);\n-    m_wallet.SetAddressReceiveRequest(batch, dest, \"0\", \"val_rr0\");\n-    m_wallet.SetAddressReceiveRequest(batch, dest, \"1\", \"val_rr1\");\n-\n-    auto values = m_wallet.GetAddressReceiveRequests();\n-    BOOST_CHECK_EQUAL(values.size(), 2U);\n-    BOOST_CHECK_EQUAL(values[0], \"val_rr0\");\n-    BOOST_CHECK_EQUAL(values[1], \"val_rr1\");\n+    node::NodeContext node;\n+    auto chain{interfaces::MakeChain(node)};\n+    DatabaseOptions options;\n+    options.require_format = format;\n+    DatabaseStatus status;\n+    bilingual_str error;\n+    std::vector<bilingual_str> warnings;\n+    auto database{MakeWalletDatabase(name, options, status, error)};\n+    auto wallet{std::make_shared<CWallet>(chain.get(), \"\", std::move(database))};\n+    wallet->LoadWallet();\n+    WITH_LOCK(wallet->cs_wallet, f(wallet));\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(LoadReceiveRequests, TestingSetup)\n+{\n+    for (DatabaseFormat format : DATABASE_FORMATS) {\n+        const std::string name{strprintf(\"receive-requests-%i\", format)};\n+        TestLoadWallet(name, format, [](std::shared_ptr<CWallet> wallet) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet) {\n+            BOOST_CHECK(!wallet->m_address_book[PKHash()].previously_spent);\n+            WalletBatch batch{wallet->GetDatabase()};\n+            BOOST_CHECK(batch.WriteAddressPreviouslySpent(PKHash(), true));\n+            BOOST_CHECK(batch.WriteAddressPreviouslySpent(ScriptHash(), true));\n+            BOOST_CHECK(wallet->SetAddressReceiveRequest(batch, PKHash(), \"0\", \"val_rr00\"));\n+            BOOST_CHECK(wallet->EraseAddressReceiveRequest(batch, PKHash(), \"0\"));\n+            BOOST_CHECK(wallet->SetAddressReceiveRequest(batch, PKHash(), \"1\", \"val_rr10\"));\n+            BOOST_CHECK(wallet->SetAddressReceiveRequest(batch, PKHash(), \"1\", \"val_rr11\"));\n+            BOOST_CHECK(wallet->SetAddressReceiveRequest(batch, ScriptHash(), \"2\", \"val_rr20\"));\n+        });\n+        TestLoadWallet(name, format, [](std::shared_ptr<CWallet> wallet) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet) {\n+            BOOST_CHECK(wallet->m_address_book[PKHash()].previously_spent);\n+            BOOST_CHECK(wallet->m_address_book[ScriptHash()].previously_spent);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1160138381",
      "id" : 1160138381,
      "in_reply_to_id" : 1150583313,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FJk6N",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 471,
      "original_position" : 57,
      "original_start_line" : 470,
      "path" : "src/wallet/test/wallet_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1373581514,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160138381/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-04-06T20:07:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160138381",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1160138608"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160138608"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150586523\r\n\r\n> ```c++\r\n> BOOST_CHECK(!wallet->IsAddressUsed(PKHash()));\r\n> BOOST_CHECK(!wallet->IsAddressUsed(ScriptHash()));\r\n> ```\r\n\r\nThanks applied your suggested change (https://github.com/furszy/bitcoin-core/commit/2195b1e3288f1019f81fc76c584519bd1d158f59)",
      "commit_id" : "d34323544d7283bf46bb154a90b8feca443b103e",
      "created_at" : "2023-04-06T18:41:49Z",
      "diff_hunk" : "@@ -427,19 +427,63 @@ BOOST_AUTO_TEST_CASE(ComputeTimeSmart)\n     BOOST_CHECK_EQUAL(AddTx(*m_node.chainman, m_wallet, 5, 50, 600), 300);\n }\n \n-BOOST_AUTO_TEST_CASE(LoadReceiveRequests)\n+static const DatabaseFormat DATABASE_FORMATS[] = {\n+#ifdef USE_SQLITE\n+    DatabaseFormat::SQLITE,\n+#endif\n+#ifdef USE_BDB\n+    DatabaseFormat::BERKELEY,\n+#endif\n+};\n+\n+void TestLoadWallet(const std::string& name, DatabaseFormat format, std::function<void(std::shared_ptr<CWallet>)> f)\n {\n-    CTxDestination dest = PKHash();\n-    LOCK(m_wallet.cs_wallet);\n-    WalletBatch batch{m_wallet.GetDatabase()};\n-    m_wallet.SetAddressUsed(batch, dest, true);\n-    m_wallet.SetAddressReceiveRequest(batch, dest, \"0\", \"val_rr0\");\n-    m_wallet.SetAddressReceiveRequest(batch, dest, \"1\", \"val_rr1\");\n-\n-    auto values = m_wallet.GetAddressReceiveRequests();\n-    BOOST_CHECK_EQUAL(values.size(), 2U);\n-    BOOST_CHECK_EQUAL(values[0], \"val_rr0\");\n-    BOOST_CHECK_EQUAL(values[1], \"val_rr1\");\n+    node::NodeContext node;\n+    auto chain{interfaces::MakeChain(node)};\n+    DatabaseOptions options;\n+    options.require_format = format;\n+    DatabaseStatus status;\n+    bilingual_str error;\n+    std::vector<bilingual_str> warnings;\n+    auto database{MakeWalletDatabase(name, options, status, error)};\n+    auto wallet{std::make_shared<CWallet>(chain.get(), \"\", std::move(database))};\n+    wallet->LoadWallet();\n+    WITH_LOCK(wallet->cs_wallet, f(wallet));\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(LoadReceiveRequests, TestingSetup)\n+{\n+    for (DatabaseFormat format : DATABASE_FORMATS) {\n+        const std::string name{strprintf(\"receive-requests-%i\", format)};\n+        TestLoadWallet(name, format, [](std::shared_ptr<CWallet> wallet) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet) {\n+            BOOST_CHECK(!wallet->m_address_book[PKHash()].previously_spent);\n+            WalletBatch batch{wallet->GetDatabase()};\n+            BOOST_CHECK(batch.WriteAddressPreviouslySpent(PKHash(), true));\n+            BOOST_CHECK(batch.WriteAddressPreviouslySpent(ScriptHash(), true));\n+            BOOST_CHECK(wallet->SetAddressReceiveRequest(batch, PKHash(), \"0\", \"val_rr00\"));\n+            BOOST_CHECK(wallet->EraseAddressReceiveRequest(batch, PKHash(), \"0\"));\n+            BOOST_CHECK(wallet->SetAddressReceiveRequest(batch, PKHash(), \"1\", \"val_rr10\"));\n+            BOOST_CHECK(wallet->SetAddressReceiveRequest(batch, PKHash(), \"1\", \"val_rr11\"));\n+            BOOST_CHECK(wallet->SetAddressReceiveRequest(batch, ScriptHash(), \"2\", \"val_rr20\"));\n+        });\n+        TestLoadWallet(name, format, [](std::shared_ptr<CWallet> wallet) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet) {\n+            BOOST_CHECK(wallet->m_address_book[PKHash()].previously_spent);\n+            BOOST_CHECK(wallet->m_address_book[ScriptHash()].previously_spent);\n+            auto requests = wallet->GetAddressReceiveRequests();\n+            auto erequests = {\"val_rr11\", \"val_rr20\"};\n+            BOOST_CHECK_EQUAL_COLLECTIONS(requests.begin(), requests.end(), std::begin(erequests), std::end(erequests));\n+            WalletBatch batch{wallet->GetDatabase()};\n+            BOOST_CHECK(batch.WriteAddressPreviouslySpent(PKHash(), false));\n+            BOOST_CHECK(batch.EraseAddressData(ScriptHash()));\n+        });\n+        TestLoadWallet(name, format, [](std::shared_ptr<CWallet> wallet) EXCLUSIVE_LOCKS_REQUIRED(wallet->cs_wallet) {\n+            BOOST_CHECK(!wallet->m_address_book[PKHash()].previously_spent);\n+            BOOST_CHECK(!wallet->m_address_book[ScriptHash()].previously_spent);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1160138608",
      "id" : 1160138608,
      "in_reply_to_id" : 1150586523,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FJk9w",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 481,
      "original_position" : 67,
      "original_start_line" : 480,
      "path" : "src/wallet/test/wallet_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1373581514,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160138608/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-04-06T20:07:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160138608",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1160150468"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160150468"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> No longer the case. Same for the comment that is above this one.\r\n\r\nThanks, I basically just replaced \"destdata\" with \"address data\"  in these comments, but you can let me know if the issue was something else",
      "commit_id" : "d34323544d7283bf46bb154a90b8feca443b103e",
      "created_at" : "2023-04-06T18:56:38Z",
      "diff_hunk" : "@@ -2439,11 +2439,7 @@ bool CWallet::DelAddressBook(const CTxDestination& address)\n             return false;\n         }\n         // Delete destdata tuples associated with address",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1160150468",
      "id" : 1160150468,
      "in_reply_to_id" : 1150523650,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FJn3E",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 2441,
      "original_position" : 3,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1373581514,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160150468/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-06T20:07:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160150468",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1160160932"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160160932"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150535358\r\n\r\nSure, I think it would make sense to clear this flag when a transaction is abandoned. I think this could be a separate issue, and it should be pretty easy to implement anytime IMO",
      "commit_id" : "d34323544d7283bf46bb154a90b8feca443b103e",
      "created_at" : "2023-04-06T19:10:12Z",
      "diff_hunk" : "@@ -2821,65 +2817,46 @@ unsigned int CWallet::ComputeTimeSmart(const CWalletTx& wtx, bool rescanning_old\n \n bool CWallet::SetAddressUsed(WalletBatch& batch, const CTxDestination& dest, bool used)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1160160932",
      "id" : 1160160932,
      "in_reply_to_id" : 1150535358,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FJqak",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 2818,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1373581514,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160160932/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-06T20:07:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160160932",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1160161770"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160161770"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1150538791\r\n\r\n> This method was removed from the cpp but not from the header.\r\n\r\nThanks applied your suggested change (https://github.com/furszy/bitcoin-core/commit/2195b1e3288f1019f81fc76c584519bd1d158f59)",
      "commit_id" : "d34323544d7283bf46bb154a90b8feca443b103e",
      "created_at" : "2023-04-06T19:11:23Z",
      "diff_hunk" : "@@ -2821,65 +2817,46 @@ unsigned int CWallet::ComputeTimeSmart(const CWalletTx& wtx, bool rescanning_old\n \n bool CWallet::SetAddressUsed(WalletBatch& batch, const CTxDestination& dest, bool used)\n {\n-    const std::string key{\"used\"};\n     if (std::get_if<CNoDestination>(&dest))\n         return false;\n \n     if (!used) {\n-        if (auto* data = util::FindKey(m_address_book, dest)) data->destdata.erase(key);\n-        return batch.EraseDestData(EncodeDestination(dest), key);\n+        if (auto* data{util::FindKey(m_address_book, dest)}) data->previously_spent = false;\n+        return batch.WriteAddressPreviouslySpent(dest, false);\n     }\n \n-    const std::string value{\"1\"};\n-    m_address_book[dest].destdata.insert(std::make_pair(key, value));\n-    return batch.WriteDestData(EncodeDestination(dest), key, value);\n-}\n-\n-void CWallet::LoadDestData(const CTxDestination &dest, const std::string &key, const std::string &value)\n-{\n-    m_address_book[dest].destdata.insert(std::make_pair(key, value));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1160161770",
      "id" : 1160161770,
      "in_reply_to_id" : 1150538791,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FJqnq",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 2840,
      "original_position" : 35,
      "original_start_line" : 2838,
      "path" : "src/wallet/wallet.cpp",
      "position" : null,
      "pull_request_review_id" : 1373581514,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160161770/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : "LEFT",
      "subject_type" : "line",
      "updated_at" : "2023-04-06T20:07:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160161770",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1160562186"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160562186"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "gotcha, thanks for the explanation!",
      "commit_id" : "d34323544d7283bf46bb154a90b8feca443b103e",
      "created_at" : "2023-04-07T09:05:37Z",
      "diff_hunk" : "@@ -205,6 +206,7 @@ class BerkeleyBatch : public DatabaseBatch\n     bool WriteKey(DataStream&& key, DataStream&& value, bool overwrite = true) override;\n     bool EraseKey(DataStream&& key) override;\n     bool HasKey(DataStream&& key) override;\n+    bool ErasePrefix(Span<std::byte> prefix) override;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1160562186",
      "id" : 1160562186,
      "in_reply_to_id" : 1150232826,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585FLMYK",
      "original_commit_id" : "0ad6a533b93162ec808de092cbe5edc31a27a390",
      "original_line" : 209,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/wallet/bdb.h",
      "position" : null,
      "pull_request_review_id" : 1376002016,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160562186/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-07T09:05:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1160562186",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7444140?v=4",
         "events_url" : "https://api.github.com/users/josibake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/josibake/followers",
         "following_url" : "https://api.github.com/users/josibake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/josibake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/josibake",
         "id" : 7444140,
         "login" : "josibake",
         "node_id" : "MDQ6VXNlcjc0NDQxNDA=",
         "organizations_url" : "https://api.github.com/users/josibake/orgs",
         "received_events_url" : "https://api.github.com/users/josibake/received_events",
         "repos_url" : "https://api.github.com/users/josibake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/josibake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/josibake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/josibake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased d34323544d7283bf46bb154a90b8feca443b103e -> a5986e82dd2b8f923d60f9e31760ef62b9010105 ([`pr/nodest.19`](https://github.com/ryanofsky/bitcoin/commits/pr/nodest.19) -> [`pr/nodest.20`](https://github.com/ryanofsky/bitcoin/commits/pr/nodest.20), [compare](https://github.com/ryanofsky/bitcoin/compare/pr/nodest.19-rebase..pr/nodest.20)) due to conflict with #27217",
      "created_at" : "2023-04-12T15:48:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#issuecomment-1505513192",
      "id" : 1505513192,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27224",
      "node_id" : "IC_kwDOABII585ZvE7o",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1505513192/reactions"
      },
      "updated_at" : "2023-04-12T15:48:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1505513192",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1165987641"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1165987641"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Would be good to check that the map contains the element prior accessing it. Otherwise the GUI could be adding a new address book entry by mistake.",
      "commit_id" : "a5986e82dd2b8f923d60f9e31760ef62b9010105",
      "created_at" : "2023-04-13T20:19:46Z",
      "diff_hunk" : "@@ -2824,67 +2820,58 @@ unsigned int CWallet::ComputeTimeSmart(const CWalletTx& wtx, bool rescanning_old\n     return nTimeSmart;\n }\n \n-bool CWallet::SetAddressUsed(WalletBatch& batch, const CTxDestination& dest, bool used)\n+bool CWallet::SetAddressPreviouslySpent(WalletBatch& batch, const CTxDestination& dest, bool used)\n {\n-    const std::string key{\"used\"};\n     if (std::get_if<CNoDestination>(&dest))\n         return false;\n \n     if (!used) {\n-        if (auto* data = util::FindKey(m_address_book, dest)) data->destdata.erase(key);\n-        return batch.EraseDestData(EncodeDestination(dest), key);\n+        if (auto* data{util::FindKey(m_address_book, dest)}) data->previously_spent = false;\n+        return batch.WriteAddressPreviouslySpent(dest, false);\n     }\n \n-    const std::string value{\"1\"};\n-    m_address_book[dest].destdata.insert(std::make_pair(key, value));\n-    return batch.WriteDestData(EncodeDestination(dest), key, value);\n+    LoadAddressPreviouslySpent(dest);\n+    return batch.WriteAddressPreviouslySpent(dest, true);\n }\n \n-void CWallet::LoadDestData(const CTxDestination &dest, const std::string &key, const std::string &value)\n+void CWallet::LoadAddressPreviouslySpent(const CTxDestination& dest)\n {\n-    m_address_book[dest].destdata.insert(std::make_pair(key, value));\n+    m_address_book[dest].previously_spent = true;\n }\n \n-bool CWallet::IsAddressUsed(const CTxDestination& dest) const\n+void CWallet::LoadAddressReceiveRequest(const CTxDestination& dest, const std::string& id, const std::string& request)\n {\n-    const std::string key{\"used\"};\n-    std::map<CTxDestination, CAddressBookData>::const_iterator i = m_address_book.find(dest);\n-    if(i != m_address_book.end())\n-    {\n-        CAddressBookData::StringMap::const_iterator j = i->second.destdata.find(key);\n-        if(j != i->second.destdata.end())\n-        {\n-            return true;\n-        }\n-    }\n+    m_address_book[dest].receive_requests[id] = request;\n+}\n+\n+bool CWallet::IsAddressPreviouslySpent(const CTxDestination& dest) const\n+{\n+    if (auto* data{util::FindKey(m_address_book, dest)}) return data->previously_spent;\n     return false;\n }\n \n std::vector<std::string> CWallet::GetAddressReceiveRequests() const\n {\n-    const std::string prefix{\"rr\"};\n     std::vector<std::string> values;\n-    for (const auto& address : m_address_book) {\n-        for (const auto& data : address.second.destdata) {\n-            if (!data.first.compare(0, prefix.size(), prefix)) {\n-                values.emplace_back(data.second);\n-            }\n+    for (const auto& [dest, entry] : m_address_book) {\n+        for (const auto& [id, request] : entry.receive_requests) {\n+            values.emplace_back(request);\n         }\n     }\n     return values;\n }\n \n bool CWallet::SetAddressReceiveRequest(WalletBatch& batch, const CTxDestination& dest, const std::string& id, const std::string& value)\n {\n-    const std::string key{\"rr\" + id}; // \"rr\" prefix = \"receive request\" in destdata\n-    CAddressBookData& data = m_address_book.at(dest);\n-    if (value.empty()) {\n-        if (!batch.EraseDestData(EncodeDestination(dest), key)) return false;\n-        data.destdata.erase(key);\n-    } else {\n-        if (!batch.WriteDestData(EncodeDestination(dest), key, value)) return false;\n-        data.destdata[key] = value;\n-    }\n+    if (!batch.WriteAddressReceiveRequest(dest, id, value)) return false;\n+    m_address_book[dest].receive_requests[id] = value;\n+    return true;\n+}\n+\n+bool CWallet::EraseAddressReceiveRequest(WalletBatch& batch, const CTxDestination& dest, const std::string& id)\n+{\n+    if (!batch.EraseAddressReceiveRequest(dest, id)) return false;\n+    m_address_book[dest].receive_requests.erase(id);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1165987641",
      "id" : 1165987641,
      "line" : 2874,
      "node_id" : "PRRC_kwDOABII585Ff485",
      "original_commit_id" : "a5986e82dd2b8f923d60f9e31760ef62b9010105",
      "original_line" : 2874,
      "original_position" : 157,
      "original_start_line" : 2871,
      "path" : "src/wallet/wallet.cpp",
      "position" : 157,
      "pull_request_review_id" : 1384148699,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1165987641/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2871,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-04-13T20:22:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1165987641",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK a5986e82dd2b8f923d60f9e31760ef62b9010105",
      "created_at" : "2023-05-01T12:09:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#issuecomment-1529640566",
      "id" : 1529640566,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27224",
      "node_id" : "IC_kwDOABII585bLHZ2",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1529640566/reactions"
      },
      "updated_at" : "2023-05-01T12:09:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1529640566",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1181656908"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1181656908"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I was momentarily confused by this because (IIUC) map keys are the `int64_t id` field of `RecentRequestEntry` but actually encoded into `std::string` by a few methods in `RecentRequestsTableModel`. So I'm wondering: Is there a reason we need to keep those IDs as strings? Is it like, at this point, going back to int64 would be a needless refactor?\r\n\r\n\r\n\r\n",
      "commit_id" : "a5986e82dd2b8f923d60f9e31760ef62b9010105",
      "created_at" : "2023-05-01T15:29:22Z",
      "diff_hunk" : "@@ -223,17 +223,22 @@ struct CAddressBookData\n     std::optional<AddressPurpose> purpose;\n \n     /**\n-     * Additional address metadata map that can currently hold two types of keys:\n-     *\n-     *   \"used\" keys with values always set to \"1\" or \"p\" if present. This is set on\n-     *       IsMine addresses that have already been spent from if the\n-     *       avoid_reuse option is enabled\n-     *\n-     *   \"rr##\" keys where ## is a decimal number, with serialized\n-     *       RecentRequestEntry objects as values\n+     * Whether coins with this address have previously been spent. Set when the\n+     * the wallet avoid_reuse option is enabled and this is an IsMine address\n+     * that has already received funds and spent them. This is used during coin\n+     * selection to increase privacy by not creating different transactions\n+     * that spend from the same addresses.\n+     */\n+    bool previously_spent{false};\n+\n+    /**\n+     * Map containing data about previously generated receive requests\n+     * requesting funds to be sent to this address. Only present for IsMine\n+     * addresses. Map keys are decimal numbers uniquely identifying each",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1181656908",
      "id" : 1181656908,
      "line" : 237,
      "node_id" : "PRRC_kwDOABII585GbqdM",
      "original_commit_id" : "a5986e82dd2b8f923d60f9e31760ef62b9010105",
      "original_line" : 237,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : 23,
      "pull_request_review_id" : 1407726864,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1181656908/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-01T15:29:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1181656908",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1181688010"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1181688010"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1181656908\r\n\r\n> So I'm wondering: Is there a reason we need to keep those IDs as strings? Is it like, at this point, going back to int64 would be a needless refactor?\r\n\r\nOnly reason that the [`CAddressBookData::receive_requests`](https://github.com/bitcoin/bitcoin/blob/be0325c6a62505d63bc07320b05e31618ef9bbb1/src/wallet/wallet.h#L232-L239) map containing the requests has string keys and string values is that the [`setAddressReceiveRequest`](https://github.com/bitcoin/bitcoin/blob/be0325c6a62505d63bc07320b05e31618ef9bbb1/src/wallet/interfaces.cpp#L230-L247) API adding the requests takes string keys and string values.\r\n\r\nI think it is best for the map types to match the API types, so wallet code can store the values it is passed without parsing them. But definitely the [`setAddressReceiveRequest`](https://github.com/bitcoin/bitcoin/blob/be0325c6a62505d63bc07320b05e31618ef9bbb1/src/wallet/interfaces.cpp#L230-L247) API could be improved, and there was discussion about this in https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1137458690. Not only could the string keys be replaced by integer keys, but it might be possible to drop the keys and the map entirely if the GUI doesn't need to store multiple requests for a single address. I'm not sure how valuable this refactoring would be, but it should be easier to do now that receive requests are stored separately from other address data.\r\n\r\nEDIT: I was curious what replacing strings with ints would look like so I implemented it in commit 2877c80afd40313760dbe11a86e89e87dbc7f2b8 ([branch](https://github.com/ryanofsky/bitcoin/commits/pr/intrequest)). I think the cleanup probably isn't that valuable standalone, but it might be useful as part of a larger change.",
      "commit_id" : "a5986e82dd2b8f923d60f9e31760ef62b9010105",
      "created_at" : "2023-05-01T16:11:40Z",
      "diff_hunk" : "@@ -223,17 +223,22 @@ struct CAddressBookData\n     std::optional<AddressPurpose> purpose;\n \n     /**\n-     * Additional address metadata map that can currently hold two types of keys:\n-     *\n-     *   \"used\" keys with values always set to \"1\" or \"p\" if present. This is set on\n-     *       IsMine addresses that have already been spent from if the\n-     *       avoid_reuse option is enabled\n-     *\n-     *   \"rr##\" keys where ## is a decimal number, with serialized\n-     *       RecentRequestEntry objects as values\n+     * Whether coins with this address have previously been spent. Set when the\n+     * the wallet avoid_reuse option is enabled and this is an IsMine address\n+     * that has already received funds and spent them. This is used during coin\n+     * selection to increase privacy by not creating different transactions\n+     * that spend from the same addresses.\n+     */\n+    bool previously_spent{false};\n+\n+    /**\n+     * Map containing data about previously generated receive requests\n+     * requesting funds to be sent to this address. Only present for IsMine\n+     * addresses. Map keys are decimal numbers uniquely identifying each",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27224#discussion_r1181688010",
      "id" : 1181688010,
      "in_reply_to_id" : 1181656908,
      "line" : 237,
      "node_id" : "PRRC_kwDOABII585GbyDK",
      "original_commit_id" : "a5986e82dd2b8f923d60f9e31760ef62b9010105",
      "original_line" : 237,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.h",
      "position" : 23,
      "pull_request_review_id" : 1407784008,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27224",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1181688010/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-01T17:17:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1181688010",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
