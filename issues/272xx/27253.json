{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "The issue is that an invalid uri parsed by `evhttp_uri_parse()`(part of the [libevent open-source project]( https://github.com/libevent/libevent.)) which result (NULL/ nullptr) is sent to `evhttp_uri_get_query()` will produce a segmentation fault.\r\n\r\nhttps://github.com/bitcoin-core/gui/blob/86bacd75e76eff207ef8f7bdb897365f5b6e7b6b/src/httpserver.cpp#L673-L676\r\n\r\nIn order to reproduce the issue:\r\n1. Start `bitcoind -rest`.\r\n2. Get a block hash (e.g.: `./src/bitcoin-cli getbestblockhash`).\r\n3. Execute the [blockheaders rest request](https://github.com/bitcoin/bitcoin/blob/master/doc/REST-interface.md) with the block hash obtained previously:\r\n```\r\ncurl \"http://127.0.0.1:18443/rest/headers/2a2bffc6d44acaa65367cf062cb97379dabbe1712beed3c22051d3f4693f201f.json?\"\r\n[{\"hash\":\"2a2bffc6d44acaa65367cf062cb97379dabbe1712beed3c22051d3f4693f201f\",\"confirmations\":1,\"height\":596,\"version\":536870912,\"versionHex\":\"20000000\",\"merkleroot\":\"54f6abb3c13916a7d8fe822616d5de5ecf696260c4e6a17f615d03c2b94a04ff\",\"time\":1678730310,\"mediantime\":1678730310,\"nonce\":1,\"bits\":\"207fffff\",\"difficulty\":4.656542373906925e-10,\"chainwork\":\"00000000000000000000000000000000000000000000000000000000000004aa\",\"nTx\":1,\"previousblockhash\":\"445e653ef01a02c550391ea0a0ec1886a0cd484bbffee46154733215bd6d2e57\"}]\r\n```\r\n4. That should have worked, now just add a percentage symbol at the end (\"**%**\"):\r\n```\r\ncurl \"http://127.0.0.1:18443/rest/headers/2a2bffc6d44acaa65367cf062cb97379dabbe1712beed3c22051d3f4693f201f.json?\"%\r\ncurl: (52) Empty reply from server\r\n```\r\n\r\n- In the bitcoind you will see this line as its last:\r\n\r\n  `Segmentation fault (core dumped)`\r\n\r\nAdded unit & functional tests.\r\n\r\nNote:\r\n\r\nThere's another option to solve this bug which is to use this flag `EVHTTP_URI_NONCONFORMANT`(URIs that violate [RFC 3986](https://www.rfc-editor.org/rfc/rfc3986)) on a different function `evhttp_uri_parse_with_flags` but it kind of hides the issue:\r\n```\r\n    evhttp_uri* uri_parsed{evhttp_uri_parse_with_flags(uri, EVHTTP_URI_NONCONFORMANT)};\r\n    const char* query{evhttp_uri_get_query(uri_parsed)};\r\n```\r\nIt's also similar to do this:\r\n```\r\n    if (!uri_parsed) {\r\n        return std::nullopt;;\r\n    }\r\n```\r\nThis won't respect any param passed to the rest service and it will execute the request without any parms or it will execute it with the defaults if any is defined.",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 1,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27253/comments",
   "created_at" : "2023-03-14T04:22:04Z",
   "draft" : false,
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27253/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/27253",
   "id" : 1622697849,
   "labels" : [],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27253/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "PR_kwDOABII585L9SE4",
   "number" : 27253,
   "performed_via_github_app" : null,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/27253.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27253",
      "merged_at" : null,
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/27253.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27253"
   },
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27253/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "state_reason" : null,
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27253/timeline",
   "title" : "httpserver, rest: fix segmentation fault on evhttp_uri_get_query",
   "updated_at" : "2023-03-14T04:49:19Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27253",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/110166421?v=4",
      "events_url" : "https://api.github.com/users/pablomartin4btc/events{/privacy}",
      "followers_url" : "https://api.github.com/users/pablomartin4btc/followers",
      "following_url" : "https://api.github.com/users/pablomartin4btc/following{/other_user}",
      "gists_url" : "https://api.github.com/users/pablomartin4btc/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/pablomartin4btc",
      "id" : 110166421,
      "login" : "pablomartin4btc",
      "node_id" : "U_kgDOBpEBlQ",
      "organizations_url" : "https://api.github.com/users/pablomartin4btc/orgs",
      "received_events_url" : "https://api.github.com/users/pablomartin4btc/received_events",
      "repos_url" : "https://api.github.com/users/pablomartin4btc/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/pablomartin4btc/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/pablomartin4btc/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/pablomartin4btc"
   }
}
