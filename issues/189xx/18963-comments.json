[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Since this PR touches critical parts of the codebase, I think it deserves a thorough review. I'm going to go through the original PR (#16323) commit by commit and write down my notes here: https://docs.google.com/document/d/1tduRmqcvhdl3FRkmdnj0f3_fknXuIZ57R8zdCGHNt6k/edit?usp=sharing",
      "created_at" : "2020-05-13T18:27:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18963#issuecomment-628167453",
      "id" : 628167453,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18963",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyODE2NzQ1Mw==",
      "updated_at" : "2020-05-13T18:27:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/628167453",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased on newer #17479. `git-bisect`ing the `validationinterface_tests/unregister_all_during_call` says:\r\n\r\n```\r\n194935b1a2968b594a42cb880e30701dd2e2bc7c is the first bad commit\r\n```",
      "created_at" : "2020-05-18T21:49:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18963#issuecomment-630453121",
      "id" : 630453121,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18963",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMDQ1MzEyMQ==",
      "updated_at" : "2020-05-18T21:49:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/630453121",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Rebased on newer #17479. `git-bisect`ing the `validationinterface_tests/unregister_all_during_call` says:\r\n> \r\n> ```\r\n> 194935b1a2968b594a42cb880e30701dd2e2bc7c is the first bad commit\r\n> ```\r\n\r\nTest was relying on the fact that BlockChecked as synchronous and that commit made it asynchronous. You can switch it to a different synchronous method:\r\n\r\n```diff\r\n--- a/src/test/validationinterface_tests.cpp\r\n+++ b/src/test/validationinterface_tests.cpp\r\n@@ -57,15 +57,13 @@ public:\r\n     {\r\n         if (m_on_destroy) m_on_destroy();\r\n     }\r\n-    void BlockChecked(const CBlock& block, const BlockValidationState& state) override\r\n+    void NewPoWValidBlock(const CBlockIndex *pindex, const std::shared_ptr<const CBlock> &block) override\r\n     {\r\n         if (m_on_call) m_on_call();\r\n     }\r\n     static void Call()\r\n     {\r\n-        std::shared_ptr<const CBlock> block = std::make_shared<CBlock>();\r\n-        BlockValidationState state;\r\n-        GetMainSignals().BlockChecked(block, state);\r\n+        GetMainSignals().NewPoWValidBlock(nullptr, std::make_shared<CBlock>());\r\n     }\r\n     std::function<void()> m_on_call;\r\n     std::function<void()> m_on_destroy;\r\n```",
      "created_at" : "2020-05-18T22:35:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18963#issuecomment-630470943",
      "id" : 630470943,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18963",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMDQ3MDk0Mw==",
      "updated_at" : "2020-05-18T22:35:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/630470943",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Now `p2p_unrequested_blocks.py` is failing. `git-bisect` says: \r\n```\r\n1d9f66ea37ac6f22f26013cd57ed75fc04a9481f is the first bad commit\r\n```\r\n-----\r\n\r\nAs noted in the Google Doc:\r\n\r\n> Up to this point, it seems that splitting this commit into:\r\n> \r\n> 1. Changing the call semantics of `ProcessNewBlock`\r\n> 2. Changing the return type to a `std::future`\r\n> \r\n> Might make it easier to review.\r\n\r\nSo I plan to split it up and track it down.",
      "created_at" : "2020-05-18T23:50:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18963#issuecomment-630493441",
      "id" : 630493441,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18963",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMDQ5MzQ0MQ==",
      "updated_at" : "2020-05-18T23:50:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/630493441",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Split up the first commit into:\r\n\r\n1. cb178903b0752de3edfd87f6013c2b4de41b6e13 which changes the call semantics of `ProcessNewBlock` and deals with the fallout of that\r\n2. 7532cf6c56d015e8bae646138d71df825d2684ab which changes the return from a bool to a future of a bool and deals with the fallout of that\r\n3. 2dcdb537b5c1dce60db217238c5e75dae602e755 which contains changes that are non-obvious to me to be correct\r\n\r\n-----\r\n\r\nI also botched the `git-bisect` before (didn't call `make` in a `bash -c`), new output:\r\n```\r\n$ git bisect run bash -c \"make -j50 && python3 test/functional/p2p_unrequested_blocks.py\"\r\n\r\n...\r\n\r\n7c77827558715180594f5881b6d02982504c4fad is the first bad commit\r\ncommit 7c77827558715180594f5881b6d02982504c4fad\r\nAuthor: Matt Corallo <git@bluematt.me>\r\nDate:   Mon Jun 17 13:13:36 2019 -0400\r\n\r\n    Move net_processing's ProcessNewBlock calls to resolve async.\r\n\r\n    Essentially, our goal is to not process anything for the given peer\r\n    until the block finishes processing (emulating the previous behavior)\r\n    without actually blocking the ProcessMessages loops. Obviously, in\r\n    most cases, we'll just go on to the next peer and immediately hit a\r\n    cs_main lock, blocking us anyway, but this we can slowly improve\r\n    that state over time by moving things from CNodeState to CPeerState.\r\n\r\n src/net_processing.cpp | 79 ++++++++++++++++++++++++++++++++++++++++++--------\r\n 1 file changed, 67 insertions(+), 12 deletions(-)\r\nbisect run success\r\n```",
      "created_at" : "2020-05-19T19:37:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18963#issuecomment-631038490",
      "id" : 631038490,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18963",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMTAzODQ5MA==",
      "updated_at" : "2020-05-19T19:37:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/631038490",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Got the unit tests and functional tests to pass!",
      "created_at" : "2020-05-21T22:06:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18963#issuecomment-632370917",
      "id" : 632370917,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18963",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMjM3MDkxNw==",
      "updated_at" : "2020-05-21T22:06:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/632370917",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18963#discussion_r429490419"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18963"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429490419"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think you should define more difference between validation-state and non-validation-state. Right now peer tracking state is spread among multiple class like `CNode` with `TxRelay` or `CNodeState` and now `CPeerState`. We should have a clear idea of _what_ should go _where_, according to which thread uses it. You should also explain how `CPeerState` aims to reduce `cs_main` contention with regards to the new threading model.",
      "commit_id" : "d6b1729e642e05738858772f8d2b334b8360b75e",
      "created_at" : "2020-05-22T23:42:31Z",
      "diff_hunk" : "@@ -237,6 +248,30 @@ namespace {\n } // namespace\n \n namespace {\n+/**\n+ * Maintain state about nodes, protected by our own lock. Historically we put all\n+ * peer tracking state in CNodeState, however this results in significant cs_main\n+ * contention. Thus, new state tracking should go here, and we should eventually\n+ * move most (non-validation-specific) state here.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18963#discussion_r429490419",
      "id" : 429490419,
      "line" : 255,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ5MDQxOQ==",
      "original_commit_id" : "d6b1729e642e05738858772f8d2b334b8360b75e",
      "original_line" : 255,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 36,
      "pull_request_review_id" : 417226161,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18963",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-22T23:54:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429490419",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18963#discussion_r429491029"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18963"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429491029"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is reject here making reference to reject messages ? I think it doesn't make sense anymore post-#15437 and post-#17004. Also you may lay out the expected callback sequence (as we do for `TransactionRemovedFromMempool` in `src/validationinterface.h`). ",
      "commit_id" : "d6b1729e642e05738858772f8d2b334b8360b75e",
      "created_at" : "2020-05-22T23:46:53Z",
      "diff_hunk" : "@@ -237,6 +248,30 @@ namespace {\n } // namespace\n \n namespace {\n+/**\n+ * Maintain state about nodes, protected by our own lock. Historically we put all\n+ * peer tracking state in CNodeState, however this results in significant cs_main\n+ * contention. Thus, new state tracking should go here, and we should eventually\n+ * move most (non-validation-specific) state here.\n+ */\n+struct CPeerState {\n+    //! If this peer generated some headers for us to add, we store the resulting\n+    //! future here and wait for it to complete before we process more data from this\n+    //! peer.\n+    std::future<bool> pending_block_processing;\n+    //! The hash of the block which is pending download.\n+    uint256 pending_block_hash;\n+    //! Once we've finished processing a block from this peer, we must still wait for\n+    //! any related callbacks to fire (to ensure, specifically, that rejects go out",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18963#discussion_r429491029",
      "id" : 429491029,
      "line" : 265,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ5MTAyOQ==",
      "original_commit_id" : "d6b1729e642e05738858772f8d2b334b8360b75e",
      "original_line" : 265,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 46,
      "pull_request_review_id" : 417226161,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18963",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-22T23:54:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429491029",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18963#discussion_r429491095"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18963"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429491095"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Please define more \"housekeeping\".",
      "commit_id" : "d6b1729e642e05738858772f8d2b334b8360b75e",
      "created_at" : "2020-05-22T23:47:32Z",
      "diff_hunk" : "@@ -1973,6 +2047,23 @@ void static ProcessOrphanTx(CConnman* connman, CTxMemPool& mempool, std::set<uin\n     }\n }\n \n+/**\n+ *  A block has been processed. Handle potential peer punishment and housekeeping.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18963#discussion_r429491095",
      "id" : 429491095,
      "line" : 2051,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ5MTA5NQ==",
      "original_commit_id" : "d6b1729e642e05738858772f8d2b334b8360b75e",
      "original_line" : 2051,
      "original_position" : 189,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 189,
      "pull_request_review_id" : 417226161,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18963",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-22T23:54:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429491095",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18963#discussion_r429491238"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18963"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429491238"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm not sure that BIP152 low-bandwidth authorizes invalid header propagation, maybe precise.",
      "commit_id" : "d6b1729e642e05738858772f8d2b334b8360b75e",
      "created_at" : "2020-05-22T23:48:14Z",
      "diff_hunk" : "@@ -3082,30 +3167,22 @@ bool ProcessMessage(CNode* pfrom, const std::string& msg_type, CDataStream& vRec\n                 // updated, etc.\n                 MarkBlockAsReceived(resp.blockhash); // it is now an empty pointer\n                 fBlockRead = true;\n-                // mapBlockSource is used for potentially punishing peers and\n-                // updating which peers send us compact blocks, so the race\n-                // between here and cs_main in ProcessNewBlock is fine.\n-                // BIP 152 permits peers to relay compact blocks after validating\n-                // the header only; we should not punish peers if the block turns\n-                // out to be invalid.\n-                mapBlockSource.emplace(resp.blockhash, std::make_pair(pfrom->GetId(), false));\n             }\n         } // Don't hold cs_main when we call into ProcessNewBlock\n         if (fBlockRead) {\n-            bool fNewBlock = false;\n+            // BIP 152 permits peers to relay compact blocks after validating",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18963#discussion_r429491238",
      "id" : 429491238,
      "line" : 3173,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ5MTIzOA==",
      "original_commit_id" : "d6b1729e642e05738858772f8d2b334b8360b75e",
      "original_line" : 3173,
      "original_position" : 283,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 283,
      "pull_request_review_id" : 417226161,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18963",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-22T23:54:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429491238",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18963#discussion_r429491376"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18963"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429491376"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Please can you comment on what conditional write is laying on.",
      "commit_id" : "d6b1729e642e05738858772f8d2b334b8360b75e",
      "created_at" : "2020-05-22T23:49:32Z",
      "diff_hunk" : "@@ -3729,23 +3729,10 @@ static FlatFilePos SaveBlockToDisk(const CBlock& block, int nHeight, const CChai\n     return blockPos;\n }\n \n-/** Store block on disk. If dbp is non-nullptr, the file is known to already reside on disk */\n-bool CChainState::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, BlockValidationState& state, const CChainParams& chainparams, CBlockIndex** ppindex, bool fRequested, const FlatFilePos* dbp, bool* fNewBlock)\n+bool CChainState::ShouldMaybeWrite(CBlockIndex* pindex, bool fRequested)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18963#discussion_r429491376",
      "id" : 429491376,
      "line" : 3732,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ5MTM3Ng==",
      "original_commit_id" : "d6b1729e642e05738858772f8d2b334b8360b75e",
      "original_line" : 3732,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 15,
      "pull_request_review_id" : 417226161,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18963",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-22T23:54:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429491376",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18963#discussion_r429491503"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18963"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429491503"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You should point where errors are distinguished from invalidity.",
      "commit_id" : "d6b1729e642e05738858772f8d2b334b8360b75e",
      "created_at" : "2020-05-22T23:50:28Z",
      "diff_hunk" : "@@ -3812,39 +3844,135 @@ bool CChainState::AcceptBlock(const std::shared_ptr<const CBlock>& pblock, Block\n     return true;\n }\n \n-bool ProcessNewBlock(const CChainParams& chainparams, const std::shared_ptr<const CBlock> pblock, bool fForceProcessing, bool *fNewBlock)\n+void CChainState::AwaitBlockValidationParked()\n+{\n+    std::unique_lock<RecursiveMutex> lock(m_cs_block_validation_queue);\n+    m_cv_block_validation_parked.wait(lock, [this] { return m_block_validation_parked; });\n+}\n+\n+void CChainState::ProcessBlockValidationQueue()\n+{\n+    while (true) {\n+        std::shared_ptr<const CBlock> pblock;\n+        bool fForceProcessing;\n+        std::promise<bool> result_promise;\n+        {\n+            std::unique_lock<RecursiveMutex> lock(m_cs_block_validation_queue);\n+            if (m_block_validation_queue.empty()) {\n+                m_block_validation_parked = true;\n+                m_cv_block_validation_parked.notify_all();\n+                m_cv_block_validation_queue.wait_for(lock, std::chrono::milliseconds(100));\n+                m_block_validation_parked = false;\n+            }\n+            if (ShutdownRequested())\n+                break;\n+            boost::this_thread::interruption_point();\n+            if (m_block_validation_queue.empty()) {\n+                continue;\n+            }\n+\n+            std::tuple<std::shared_ptr<const CBlock>, bool, std::promise<bool>>& tuple = m_block_validation_queue.front();\n+            pblock = std::move(std::get<0>(tuple));\n+            fForceProcessing = std::get<1>(tuple);\n+            result_promise = std::move(std::get<2>(tuple));\n+            m_block_validation_queue.pop_front();\n+        }\n+\n+        CChainParams chainparams = Params();\n+        {\n+            LOCK(cs_main);\n+\n+            CBlockIndex* pindex = LookupBlockIndex(pblock->GetHash());\n+            assert(pindex);\n+\n+            // Check that we still want this block\n+            if (!ShouldMaybeWrite(pindex, fForceProcessing)) {\n+                result_promise.set_value(false);\n+                continue;\n+            }\n+\n+            // We already verified the block in ProcessNewBlock, so no need to check merkle roots here again\n+\n+            // Header is valid/has work, merkle tree and segwit merkle tree are good...RELAY NOW\n+            // (but if it does not build on our best tip, let the SendMessages loop relay it)\n+            if (!IsInitialBlockDownload() && m_chain.Tip() == pindex->pprev)\n+                GetMainSignals().NewPoWValidBlock(pindex, pblock);\n+\n+            BlockValidationState state;\n+            try {\n+                FlatFilePos blockPos = SaveBlockToDisk(*pblock, pindex->nHeight, chainparams, nullptr);\n+                if (blockPos.IsNull()) {\n+                    error(strprintf(\"%s: Failed to find position to write new block to disk\", __func__).c_str());\n+                    result_promise.set_value(false);\n+                    continue;\n+                }\n+                ReceivedBlockTransactions(*pblock, pindex, blockPos, chainparams.GetConsensus());\n+            } catch (const std::runtime_error& e) {\n+                AbortNode(state, std::string(\"System error: \") + e.what());\n+            }\n+\n+            FlushStateToDisk(chainparams, state, FlushStateMode::NONE);\n+\n+            CheckBlockIndex(chainparams.GetConsensus());\n+\n+            if (state.IsError()) {\n+                result_promise.set_value(false);\n+                continue;\n+            }\n+        }\n+\n+        NotifyHeaderTip();\n+\n+        BlockValidationState state; // Only used to report errors, not invalidity - ignore it",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18963#discussion_r429491503",
      "id" : 429491503,
      "line" : 3926,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTQ5MTUwMw==",
      "original_commit_id" : "d6b1729e642e05738858772f8d2b334b8360b75e",
      "original_line" : 3926,
      "original_position" : 195,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 195,
      "pull_request_review_id" : 417226161,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18963",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-22T23:54:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429491503",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Not planning to work on this anytime soon unfortunately.",
      "created_at" : "2021-04-20T15:45:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18963#issuecomment-823380098",
      "id" : 823380098,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18963",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMzM4MDA5OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-20T15:45:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/823380098",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "![image](https://user-images.githubusercontent.com/1063656/115432151-f68a7900-a1fd-11eb-9a0e-9a29702d40b4.png)\r\n\r\nð \r\n\r\nLet me know if you pick this up again!",
      "created_at" : "2021-04-20T16:30:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18963#issuecomment-823421533",
      "id" : 823421533,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18963",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMzQyMTUzMw==",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 3,
         "rocket" : 0,
         "total_count" : 3,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/823421533/reactions"
      },
      "updated_at" : "2021-04-20T16:30:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/823421533",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "From my research it follows that the \"[Move BlockChecked to a background thread](https://github.com/bitcoin/bitcoin/pull/18963/commits/2ed0b647435b80946f7f000d573ff4b4e274ca70)\" commit fixes a lock-order-inversion in the MessageHandler thread.\r\n\r\nSee https://github.com/bitcoin/bitcoin/issues/19303#issuecomment-1514928912.",
      "created_at" : "2023-05-17T08:07:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18963#issuecomment-1550945493",
      "id" : 1550945493,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18963",
      "node_id" : "IC_kwDOABII585ccYzV",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1550945493/reactions"
      },
      "updated_at" : "2023-05-17T08:07:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1550945493",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   }
]
