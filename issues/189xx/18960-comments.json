[
   {
      "author_association" : "MEMBER",
      "body" : "This takes a different approach from the caching in #16442. I prefer it because it isolates all of the caching logic inside the indexer rather than in net processing. I'll put the other approach up as a different branch for comparison.",
      "created_at" : "2020-05-12T15:06:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-627403715",
      "id" : 627403715,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18960",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyNzQwMzcxNQ==",
      "updated_at" : "2020-05-12T15:06:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/627403715",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r423819184"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423819184"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is there any particular reason for limiting the size of the cache? With this numbers it would be full at block 2000000, i.e. in (2000000-630000)/(6 * 24 * 365) ~ 26 years.",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-12T15:18:56Z",
      "diff_hunk" : "@@ -31,6 +31,8 @@ constexpr char DB_FILTER_POS = 'P';\n constexpr unsigned int MAX_FLTR_FILE_SIZE = 0x1000000; // 16 MiB\n /** The pre-allocation chunk size for fltr?????.dat files */\n constexpr unsigned int FLTR_FILE_CHUNK_SIZE = 0x100000; // 1 MiB\n+/** Maximum size of the cfheaders cache */\n+constexpr size_t CF_HEADERS_CACHE_MAX_SZ{2000};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r423819184",
      "id" : 423819184,
      "line" : 39,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzgxOTE4NA==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 39,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : 9,
      "pull_request_review_id" : 410152048,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-18T16:54:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/423819184",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424002630"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424002630"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I wanted to have some limit so that a bug doesn't turn into a memory exhaustion possibility (since we only ever add to this map, and never remove). I don't think the exact number matters. Presumably in 26 years, anyone who wants to serve compact block filters from a v0.21 Bitcoin Core server will be able to patch their own code.",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-12T20:08:44Z",
      "diff_hunk" : "@@ -31,6 +31,8 @@ constexpr char DB_FILTER_POS = 'P';\n constexpr unsigned int MAX_FLTR_FILE_SIZE = 0x1000000; // 16 MiB\n /** The pre-allocation chunk size for fltr?????.dat files */\n constexpr unsigned int FLTR_FILE_CHUNK_SIZE = 0x100000; // 1 MiB\n+/** Maximum size of the cfheaders cache */\n+constexpr size_t CF_HEADERS_CACHE_MAX_SZ{2000};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424002630",
      "id" : 424002630,
      "in_reply_to_id" : 423819184,
      "line" : 39,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAwMjYzMA==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 39,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : 9,
      "pull_request_review_id" : 410383758,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-18T16:54:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424002630",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18354 (Protect wallet by using shared pointers by bvbfan)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-05-13T07:52:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-627814619",
      "id" : 627814619,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18960",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyNzgxNDYxOQ==",
      "updated_at" : "2020-05-20T20:02:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/627814619",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424364005"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424364005"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I agree that when in doubt, it's better to be overcautious than risking introducing a memory exhaustion bug -- I just wanted to get sure there are no other reasons for the limit that I'm not aware of.",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-13T11:26:57Z",
      "diff_hunk" : "@@ -31,6 +31,8 @@ constexpr char DB_FILTER_POS = 'P';\n constexpr unsigned int MAX_FLTR_FILE_SIZE = 0x1000000; // 16 MiB\n /** The pre-allocation chunk size for fltr?????.dat files */\n constexpr unsigned int FLTR_FILE_CHUNK_SIZE = 0x100000; // 1 MiB\n+/** Maximum size of the cfheaders cache */\n+constexpr size_t CF_HEADERS_CACHE_MAX_SZ{2000};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424364005",
      "id" : 424364005,
      "in_reply_to_id" : 423819184,
      "line" : 39,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM2NDAwNQ==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 39,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : 9,
      "pull_request_review_id" : 410830038,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-18T16:54:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424364005",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm almost ready for ACKing this PR, just have some minor suggestion/discussion points:\r\n- Would it make sense to also only check the cache if we have checkpoints, i.e. a method structure like\r\n```\r\nbool is_checkpoint = (block_index->nHeight % CFCHECKPT_INTERVAL == 0); \r\nif (is_checkpoint)\r\n    // Check the headers cache\r\n\r\n// Regular lookup\r\n\r\nif (is_checkpoint)\r\n    // Add to the headers cache\r\n```\r\n? Of course, the drawback of this approach is that the condition for checking needs to be removed if the cache is ever used for other filter headers than those from the checkpoints. Also not sure if its really worth it from a performance point of view. But in 999 out of 1000 times the lookup in the map could be skipped.\r\n- In the regular case the cache should never get full, considering that this would by plan only happen in the far future (block 2000000, >25 years from now, with the current maximum size constant of 2000). If it gets full however, should we take some action like putting a debug output or even an assert, to get noticed that we either have some memory exhaustion bug or that the maximum size needs to be increased?\r\n- Any idea how to effectively test performance improvements like this? I don't know anything better than just putting some `LogPrintf`s in the cache hit / cache add cases, run the (maybe slightly modified) functional test and analyze the log output to check if it behaves as expected.",
      "created_at" : "2020-05-13T12:10:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-627939760",
      "id" : 627939760,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18960",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyNzkzOTc2MA==",
      "updated_at" : "2020-05-13T12:13:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/627939760",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424406311"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424406311"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    Mutex m_cs_headers_cache;\r\n```\r\n\r\nnit (feel free to ignore). I haven't tested this, but from reading the code, a non-recursive mutex should be sufficient.",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-13T12:43:33Z",
      "diff_hunk" : "@@ -30,6 +33,9 @@ class BlockFilterIndex final : public BaseIndex\n     bool ReadFilterFromDisk(const FlatFilePos& pos, BlockFilter& filter) const;\n     size_t WriteFilterToDisk(FlatFilePos& pos, const BlockFilter& filter);\n \n+    RecursiveMutex m_cs_headers_cache;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424406311",
      "id" : 424406311,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQwNjMxMQ==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 36,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.h",
      "position" : null,
      "pull_request_review_id" : 410883693,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-18T16:54:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424406311",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424507108"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424507108"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is a very minor issue but if we use the hash instead of the height as the key we could end up with headers of orphaned blocks in the cache since they will not be overridden or removed. This could also be the case if `CFCHECKPT_INTERVAL` would ever change. I know the chances for that happening are slim and if it happens we can deal with it then, just wanted to put it there.",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-13T14:59:39Z",
      "diff_hunk" : "@@ -387,13 +389,30 @@ bool BlockFilterIndex::LookupFilter(const CBlockIndex* block_index, BlockFilter&\n     return ReadFilterFromDisk(entry.pos, filter_out);\n }\n \n-bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out) const\n+bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out)\n {\n+    {\n+        // Check the headers cache\n+        LOCK(m_cs_headers_cache);\n+        auto header = m_headers_cache.find(block_index->GetBlockHash());\n+        if (header != m_headers_cache.end()) {\n+            header_out = header->second;\n+            return true;\n+        }\n+    }\n+\n     DBVal entry;\n     if (!LookupOne(*m_db, block_index, entry)) {\n         return false;\n     }\n \n+    if (block_index->nHeight % CFCHECKPT_INTERVAL == 0) {\n+        // Add to the headers cache\n+        LOCK(m_cs_headers_cache);\n+        if (m_headers_cache.size() < CF_HEADERS_CACHE_MAX_SZ) {\n+            m_headers_cache.emplace(block_index->GetBlockHash(), entry.header);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424507108",
      "id" : 424507108,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDUwNzEwOA==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 414,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : null,
      "pull_request_review_id" : 411014712,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-18T16:54:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424507108",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424637193"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424637193"
         }
      },
      "author_association" : "NONE",
      "body" : "The test suite explicitly checks that filters for stale blocks may still be fetched.\r\n\r\nhttps://github.com/jnewbery/bitcoin/blob/2020-05-cfcheckpts-cache/test/functional/p2p_blockfilters.py#L89-L101",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-13T18:14:51Z",
      "diff_hunk" : "@@ -387,13 +389,30 @@ bool BlockFilterIndex::LookupFilter(const CBlockIndex* block_index, BlockFilter&\n     return ReadFilterFromDisk(entry.pos, filter_out);\n }\n \n-bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out) const\n+bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out)\n {\n+    {\n+        // Check the headers cache\n+        LOCK(m_cs_headers_cache);\n+        auto header = m_headers_cache.find(block_index->GetBlockHash());\n+        if (header != m_headers_cache.end()) {\n+            header_out = header->second;\n+            return true;\n+        }\n+    }\n+\n     DBVal entry;\n     if (!LookupOne(*m_db, block_index, entry)) {\n         return false;\n     }\n \n+    if (block_index->nHeight % CFCHECKPT_INTERVAL == 0) {\n+        // Add to the headers cache\n+        LOCK(m_cs_headers_cache);\n+        if (m_headers_cache.size() < CF_HEADERS_CACHE_MAX_SZ) {\n+            m_headers_cache.emplace(block_index->GetBlockHash(), entry.header);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424637193",
      "id" : 424637193,
      "in_reply_to_id" : 424507108,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYzNzE5Mw==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 414,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : null,
      "pull_request_review_id" : 411180373,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-18T16:54:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424637193",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1562417?v=4",
         "events_url" : "https://api.github.com/users/clarkmoody/events{/privacy}",
         "followers_url" : "https://api.github.com/users/clarkmoody/followers",
         "following_url" : "https://api.github.com/users/clarkmoody/following{/other_user}",
         "gists_url" : "https://api.github.com/users/clarkmoody/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/clarkmoody",
         "id" : 1562417,
         "login" : "clarkmoody",
         "node_id" : "MDQ6VXNlcjE1NjI0MTc=",
         "organizations_url" : "https://api.github.com/users/clarkmoody/orgs",
         "received_events_url" : "https://api.github.com/users/clarkmoody/received_events",
         "repos_url" : "https://api.github.com/users/clarkmoody/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/clarkmoody/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/clarkmoody/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/clarkmoody"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424643299"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424643299"
         }
      },
      "author_association" : "MEMBER",
      "body" : "doesn't this statically cap (and freeze forever) the cache after inserting 2000 entries? Wouldn't it make sense to have some sort of invalidation logic? (I can't come up with a good one though)",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-13T18:24:51Z",
      "diff_hunk" : "@@ -387,13 +389,30 @@ bool BlockFilterIndex::LookupFilter(const CBlockIndex* block_index, BlockFilter&\n     return ReadFilterFromDisk(entry.pos, filter_out);\n }\n \n-bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out) const\n+bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out)\n {\n+    {\n+        // Check the headers cache\n+        LOCK(m_cs_headers_cache);\n+        auto header = m_headers_cache.find(block_index->GetBlockHash());\n+        if (header != m_headers_cache.end()) {\n+            header_out = header->second;\n+            return true;\n+        }\n+    }\n+\n     DBVal entry;\n     if (!LookupOne(*m_db, block_index, entry)) {\n         return false;\n     }\n \n+    if (block_index->nHeight % CFCHECKPT_INTERVAL == 0) {\n+        // Add to the headers cache\n+        LOCK(m_cs_headers_cache);\n+        if (m_headers_cache.size() < CF_HEADERS_CACHE_MAX_SZ) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424643299",
      "id" : 424643299,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY0MzI5OQ==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 413,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : null,
      "pull_request_review_id" : 411187904,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-18T16:54:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424643299",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-05-13T18:25:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-628166454",
      "id" : 628166454,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18960",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyODE2NjQ1NA==",
      "updated_at" : "2020-05-13T18:25:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/628166454",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424648190"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424648190"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If someone can mine enough blocks to fill up this cache, we have other problems. I think an adversary needs to mine blocks in the order of the 2000th triangle number to fill this up.\r\n\r\nAnd when this cache is full due to natural reasons (in 20 years), disks will be fast enough that we won't need a cache.",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-13T18:32:45Z",
      "diff_hunk" : "@@ -387,13 +389,30 @@ bool BlockFilterIndex::LookupFilter(const CBlockIndex* block_index, BlockFilter&\n     return ReadFilterFromDisk(entry.pos, filter_out);\n }\n \n-bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out) const\n+bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out)\n {\n+    {\n+        // Check the headers cache\n+        LOCK(m_cs_headers_cache);\n+        auto header = m_headers_cache.find(block_index->GetBlockHash());\n+        if (header != m_headers_cache.end()) {\n+            header_out = header->second;\n+            return true;\n+        }\n+    }\n+\n     DBVal entry;\n     if (!LookupOne(*m_db, block_index, entry)) {\n         return false;\n     }\n \n+    if (block_index->nHeight % CFCHECKPT_INTERVAL == 0) {\n+        // Add to the headers cache\n+        LOCK(m_cs_headers_cache);\n+        if (m_headers_cache.size() < CF_HEADERS_CACHE_MAX_SZ) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424648190",
      "id" : 424648190,
      "in_reply_to_id" : 424643299,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY0ODE5MA==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 413,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : null,
      "pull_request_review_id" : 411193878,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-18T16:54:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424648190",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424648698"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424648698"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe disks are fast enough or smart enough with caching today already, so it might not be needed after all. A benchmark would be nice...",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-13T18:33:41Z",
      "diff_hunk" : "@@ -387,13 +389,30 @@ bool BlockFilterIndex::LookupFilter(const CBlockIndex* block_index, BlockFilter&\n     return ReadFilterFromDisk(entry.pos, filter_out);\n }\n \n-bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out) const\n+bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out)\n {\n+    {\n+        // Check the headers cache\n+        LOCK(m_cs_headers_cache);\n+        auto header = m_headers_cache.find(block_index->GetBlockHash());\n+        if (header != m_headers_cache.end()) {\n+            header_out = header->second;\n+            return true;\n+        }\n+    }\n+\n     DBVal entry;\n     if (!LookupOne(*m_db, block_index, entry)) {\n         return false;\n     }\n \n+    if (block_index->nHeight % CFCHECKPT_INTERVAL == 0) {\n+        // Add to the headers cache\n+        LOCK(m_cs_headers_cache);\n+        if (m_headers_cache.size() < CF_HEADERS_CACHE_MAX_SZ) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424648698",
      "id" : 424648698,
      "in_reply_to_id" : 424643299,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY0ODY5OA==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 413,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : null,
      "pull_request_review_id" : 411194523,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-18T16:54:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424648698",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424651189"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424651189"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oh. You'r right. \r\nI missed the `% CFCHECKPT_INTERVAL == 0`.",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-13T18:38:10Z",
      "diff_hunk" : "@@ -387,13 +389,30 @@ bool BlockFilterIndex::LookupFilter(const CBlockIndex* block_index, BlockFilter&\n     return ReadFilterFromDisk(entry.pos, filter_out);\n }\n \n-bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out) const\n+bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out)\n {\n+    {\n+        // Check the headers cache\n+        LOCK(m_cs_headers_cache);\n+        auto header = m_headers_cache.find(block_index->GetBlockHash());\n+        if (header != m_headers_cache.end()) {\n+            header_out = header->second;\n+            return true;\n+        }\n+    }\n+\n     DBVal entry;\n     if (!LookupOne(*m_db, block_index, entry)) {\n         return false;\n     }\n \n+    if (block_index->nHeight % CFCHECKPT_INTERVAL == 0) {\n+        // Add to the headers cache\n+        LOCK(m_cs_headers_cache);\n+        if (m_headers_cache.size() < CF_HEADERS_CACHE_MAX_SZ) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424651189",
      "id" : 424651189,
      "in_reply_to_id" : 424643299,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY1MTE4OQ==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 413,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : null,
      "pull_request_review_id" : 411197656,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-18T16:54:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424651189",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424680456"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424680456"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> we could end up with headers of orphaned blocks in the cache\r\n\r\nCorrect. If there's a re-org across checkpoint block, then the disconnect block's filter header stays in the cache. That's an explicit design decision, since:\r\n- the cost is very small (32 bytes for header + map overhead so < 100 bytes)\r\n- it's an infrequent event\r\n- it saves on the complexity of having to recalculate the cache on re-orgs (eg compare with https://github.com/bitcoin-core-review-club/bitcoin/commit/af3bddfbdfb7de06d6e63a0a425da483c435521a#diff-eff7adeaec73a769788bb78858815c91R1258)\r\n\r\n> if CFCHECKPT_INTERVAL would ever change\r\n\r\nIn that case, we'd need to change the software, which would involve a stop/start. This is an in-memory cache so gets dropped on shutdown.",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-13T19:29:50Z",
      "diff_hunk" : "@@ -387,13 +389,30 @@ bool BlockFilterIndex::LookupFilter(const CBlockIndex* block_index, BlockFilter&\n     return ReadFilterFromDisk(entry.pos, filter_out);\n }\n \n-bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out) const\n+bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out)\n {\n+    {\n+        // Check the headers cache\n+        LOCK(m_cs_headers_cache);\n+        auto header = m_headers_cache.find(block_index->GetBlockHash());\n+        if (header != m_headers_cache.end()) {\n+            header_out = header->second;\n+            return true;\n+        }\n+    }\n+\n     DBVal entry;\n     if (!LookupOne(*m_db, block_index, entry)) {\n         return false;\n     }\n \n+    if (block_index->nHeight % CFCHECKPT_INTERVAL == 0) {\n+        // Add to the headers cache\n+        LOCK(m_cs_headers_cache);\n+        if (m_headers_cache.size() < CF_HEADERS_CACHE_MAX_SZ) {\n+            m_headers_cache.emplace(block_index->GetBlockHash(), entry.header);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424680456",
      "id" : 424680456,
      "in_reply_to_id" : 424507108,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY4MDQ1Ng==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 414,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : null,
      "pull_request_review_id" : 411234636,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-18T16:54:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424680456",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424680741"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424680741"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agree. I'll change to `Mutex`.",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-13T19:30:23Z",
      "diff_hunk" : "@@ -30,6 +33,9 @@ class BlockFilterIndex final : public BaseIndex\n     bool ReadFilterFromDisk(const FlatFilePos& pos, BlockFilter& filter) const;\n     size_t WriteFilterToDisk(FlatFilePos& pos, const BlockFilter& filter);\n \n+    RecursiveMutex m_cs_headers_cache;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424680741",
      "id" : 424680741,
      "in_reply_to_id" : 424406311,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY4MDc0MQ==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 36,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.h",
      "position" : null,
      "pull_request_review_id" : 411235010,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-18T16:54:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424680741",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424681368"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424681368"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Remind me to change this to 4000 in 2026 :)\r\n\r\nI agree that a benchmark would be nice.",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-13T19:31:36Z",
      "diff_hunk" : "@@ -387,13 +389,30 @@ bool BlockFilterIndex::LookupFilter(const CBlockIndex* block_index, BlockFilter&\n     return ReadFilterFromDisk(entry.pos, filter_out);\n }\n \n-bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out) const\n+bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out)\n {\n+    {\n+        // Check the headers cache\n+        LOCK(m_cs_headers_cache);\n+        auto header = m_headers_cache.find(block_index->GetBlockHash());\n+        if (header != m_headers_cache.end()) {\n+            header_out = header->second;\n+            return true;\n+        }\n+    }\n+\n     DBVal entry;\n     if (!LookupOne(*m_db, block_index, entry)) {\n         return false;\n     }\n \n+    if (block_index->nHeight % CFCHECKPT_INTERVAL == 0) {\n+        // Add to the headers cache\n+        LOCK(m_cs_headers_cache);\n+        if (m_headers_cache.size() < CF_HEADERS_CACHE_MAX_SZ) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424681368",
      "id" : 424681368,
      "in_reply_to_id" : 424643299,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY4MTM2OA==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 413,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : null,
      "pull_request_review_id" : 411235844,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-18T16:54:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424681368",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424682225"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424682225"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```cpp\r\n// TODO change to 4000 in 2026\r\n```\r\n\r\n;)",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-13T19:33:17Z",
      "diff_hunk" : "@@ -387,13 +389,30 @@ bool BlockFilterIndex::LookupFilter(const CBlockIndex* block_index, BlockFilter&\n     return ReadFilterFromDisk(entry.pos, filter_out);\n }\n \n-bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out) const\n+bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out)\n {\n+    {\n+        // Check the headers cache\n+        LOCK(m_cs_headers_cache);\n+        auto header = m_headers_cache.find(block_index->GetBlockHash());\n+        if (header != m_headers_cache.end()) {\n+            header_out = header->second;\n+            return true;\n+        }\n+    }\n+\n     DBVal entry;\n     if (!LookupOne(*m_db, block_index, entry)) {\n         return false;\n     }\n \n+    if (block_index->nHeight % CFCHECKPT_INTERVAL == 0) {\n+        // Add to the headers cache\n+        LOCK(m_cs_headers_cache);\n+        if (m_headers_cache.size() < CF_HEADERS_CACHE_MAX_SZ) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424682225",
      "id" : 424682225,
      "in_reply_to_id" : 424643299,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY4MjIyNQ==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 413,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : null,
      "pull_request_review_id" : 411237025,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-18T16:54:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424682225",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424685028"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424685028"
         }
      },
      "author_association" : "MEMBER",
      "body" : "oops sorry, I meant 2046",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-13T19:38:25Z",
      "diff_hunk" : "@@ -387,13 +389,30 @@ bool BlockFilterIndex::LookupFilter(const CBlockIndex* block_index, BlockFilter&\n     return ReadFilterFromDisk(entry.pos, filter_out);\n }\n \n-bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out) const\n+bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out)\n {\n+    {\n+        // Check the headers cache\n+        LOCK(m_cs_headers_cache);\n+        auto header = m_headers_cache.find(block_index->GetBlockHash());\n+        if (header != m_headers_cache.end()) {\n+            header_out = header->second;\n+            return true;\n+        }\n+    }\n+\n     DBVal entry;\n     if (!LookupOne(*m_db, block_index, entry)) {\n         return false;\n     }\n \n+    if (block_index->nHeight % CFCHECKPT_INTERVAL == 0) {\n+        // Add to the headers cache\n+        LOCK(m_cs_headers_cache);\n+        if (m_headers_cache.size() < CF_HEADERS_CACHE_MAX_SZ) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424685028",
      "id" : 424685028,
      "in_reply_to_id" : 424643299,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY4NTAyOA==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 413,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : null,
      "pull_request_review_id" : 411240539,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-18T16:54:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424685028",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424772712"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424772712"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-13T22:44:08Z",
      "diff_hunk" : "@@ -30,6 +33,9 @@ class BlockFilterIndex final : public BaseIndex\n     bool ReadFilterFromDisk(const FlatFilePos& pos, BlockFilter& filter) const;\n     size_t WriteFilterToDisk(FlatFilePos& pos, const BlockFilter& filter);\n \n+    RecursiveMutex m_cs_headers_cache;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424772712",
      "id" : 424772712,
      "in_reply_to_id" : 424406311,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc3MjcxMg==",
      "original_commit_id" : "6fe202209efe97d2f1f6ede8d679c38aa3fa7429",
      "original_line" : 36,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.h",
      "position" : null,
      "pull_request_review_id" : 411349975,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-18T16:54:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424772712",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@theStack \r\n> Would it make sense to also only check the cache if we have checkpoints, i.e. a method structure like\r\n\r\nDone\r\n\r\n@MarcoFalke \r\n> a non-recursive mutex should be sufficient.\r\n\r\nChanged `RecursiveMutex` -> `Mutex`\r\n\r\nI'm still working on adding a microbench, although it's not clear to me that it'll show any improvement since the disk reads may be cached by the OS for the microbench.",
      "created_at" : "2020-05-13T22:48:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-628285474",
      "id" : 628285474,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18960",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyODI4NTQ3NA==",
      "updated_at" : "2020-05-13T22:48:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/628285474",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424888402"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424888402"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Any reason `std::unordered_map` can't be used? I see that the tree-based `std::map` and `std::set` are used primarily throughout the codebase, but figured it may just be historical. Is there another reason these are preferred?",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-14T06:00:57Z",
      "diff_hunk" : "@@ -30,6 +33,9 @@ class BlockFilterIndex final : public BaseIndex\n     bool ReadFilterFromDisk(const FlatFilePos& pos, BlockFilter& filter) const;\n     size_t WriteFilterToDisk(FlatFilePos& pos, const BlockFilter& filter);\n \n+    Mutex m_cs_headers_cache;\n+    std::map<uint256, uint256> m_headers_cache GUARDED_BY(m_cs_headers_cache);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r424888402",
      "id" : 424888402,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg4ODQwMg==",
      "original_commit_id" : "7ad83ed252914d6d5b8ed81f103aecf052c68fb7",
      "original_line" : 37,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.h",
      "position" : null,
      "pull_request_review_id" : 411485876,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-18T16:54:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424888402",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4015903?v=4",
         "events_url" : "https://api.github.com/users/jkczyz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jkczyz/followers",
         "following_url" : "https://api.github.com/users/jkczyz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jkczyz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jkczyz",
         "id" : 4015903,
         "login" : "jkczyz",
         "node_id" : "MDQ6VXNlcjQwMTU5MDM=",
         "organizations_url" : "https://api.github.com/users/jkczyz/orgs",
         "received_events_url" : "https://api.github.com/users/jkczyz/received_events",
         "repos_url" : "https://api.github.com/users/jkczyz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jkczyz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jkczyz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jkczyz"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Using jnewbery's nice [node-shell module](https://github.com/jnewbery/bitcoin/tree/node-shell) (a modification of test-shell that allows to connect with the functional test framework to a running full-node) I crafted up a quick and dirty [test-script](https://github.com/theStack/bitcoin/blob/pr18960_test/test/functional/p2p_18960.py) (see branch https://github.com/theStack/bitcoin/tree/pr18960_test) that sends `getcfcheckpt` requests with the stop-hash of the halving block 630000 and measures the processing time.\r\n\r\nFreshly started bitcoind from master branch (w/o checkpoint headers cache implementation), after mempool imports are done:\r\n```\r\ngetcfcheckpt request processing times\r\n=====================================\r\n-> first:     53.75ms\r\n-> following: 50.70ms (average)\r\n=====================================\r\n```\r\n\r\nFreshly started bitcoind from PR branch (with checkpoint headers cache implementation), after mempool imports are done:\r\n```\r\ngetcfcheckpt request processing times\r\n=====================================\r\n-> first:     50.92ms\r\n-> following: 50.80ms (average)\r\n=====================================\r\n```\r\nThere doesn't seem to be a noticable difference. I don't know if my methodology is flawed though. Maybe all the processing around is taking so much more time that the actual part of fetching the header (from the cache or from disk) is neglectible. If anyone has an idea how to improve the benchmark script, happy to hear suggestions!\r\n\r\n// EDIT: As jnewbery found out in the course of today's PR review club meeting, there is a good explanation on why the values are always close to 50ms:\r\n```\r\n19:36 < jnewbery> There are 100ms sleeps in the messagehandler thread between looping through all peers:\r\n                  https://github.com/jnewbery/bitcoin/blob/7ad83ed252914d6d5b8ed81f103aecf052c68fb7/src/net.cpp#L2061\r\n19:37 < jnewbery> on a non-busy node, 50ms is the average time you have to wait for the message handler thread to wake up\r\n```",
      "created_at" : "2020-05-14T16:56:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-628761578",
      "id" : 628761578,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18960",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyODc2MTU3OA==",
      "updated_at" : "2020-05-14T18:18:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/628761578",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Approach ACK",
      "created_at" : "2020-05-14T18:36:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-628815890",
      "id" : 628815890,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18960",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyODgxNTg5MA==",
      "updated_at" : "2020-05-14T18:36:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/628815890",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/16323900?v=4",
         "events_url" : "https://api.github.com/users/michaelfolkson/events{/privacy}",
         "followers_url" : "https://api.github.com/users/michaelfolkson/followers",
         "following_url" : "https://api.github.com/users/michaelfolkson/following{/other_user}",
         "gists_url" : "https://api.github.com/users/michaelfolkson/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/michaelfolkson",
         "id" : 16323900,
         "login" : "michaelfolkson",
         "node_id" : "MDQ6VXNlcjE2MzIzOTAw",
         "organizations_url" : "https://api.github.com/users/michaelfolkson/orgs",
         "received_events_url" : "https://api.github.com/users/michaelfolkson/received_events",
         "repos_url" : "https://api.github.com/users/michaelfolkson/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/michaelfolkson/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/michaelfolkson/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/michaelfolkson"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@theStack I believe in between the requests you can drop the cache to simulate eviction (which may occasionally happen during normal operation). See https://unix.stackexchange.com/questions/17936/setting-proc-sys-vm-drop-caches-to-clear-cache",
      "created_at" : "2020-05-14T22:26:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-628918187",
      "id" : 628918187,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18960",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyODkxODE4Nw==",
      "updated_at" : "2020-05-14T22:26:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/628918187",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@narula suggested in today's PR Review Club meeting that it'd be less cognitive overhead to simply take the `m_cs_headers_cache` for the entirety of the `LookupFilterHeader()` function, rather than taking, releasing and taking it again. That seem like a reasonable request to me. We can't ever block important work with this lock, so holding it a bit longer than strictly necessary is not an issue.",
      "created_at" : "2020-05-15T01:36:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-628974368",
      "id" : 628974368,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18960",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyODk3NDM2OA==",
      "updated_at" : "2020-05-15T01:36:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/628974368",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@theStack - thank you for doing some benching of this. Your approach inspired me to do something similar myself, using debug logs to find the exact time to construct a cfcheckpt response. I've added a [`debug_log_delta` context wrapper](https://github.com/jnewbery/bitcoin/commit/99ea8d5b228c3c5ddec5de76bbf830c666738485#diff-86294e5ae5283eebdd9f98d79007a0e1R386) to the node_shell, which allows me to provide two debug log messages, then do actions on the node and extract the time delta between those two logs. I applied that patch to:\r\n\r\n- without a cache\r\n- with this cache\r\n- with @narula's suggestion of taking the lock only once (I was interested to see if there were any performance differences).\r\n\r\nAnd then ran the following node-shell script:\r\n\r\n```\r\nREPO_PATH=\"<path_to_repo>\"\r\nDATADIR_PATH=\"<path_to_datadir>\"\r\nimport sys\r\nsys.path.insert(0, f\"{REPO_PATH}/test/functional\")\r\nfrom test_framework.node_shell import NodeShell\r\ntest = NodeShell()\r\ntest.setup(datadir=DATADIR_PATH)\r\n# <test_framework.node_shell.NodeShell.__TestShell object at 0x7f7704820490>\r\nnode = test.nodes[0]\r\nbb = node.getbestblockhash()\r\nfrom test_framework.messages import FILTER_TYPE_BASIC, msg_getcfcheckpt\r\nrequest = msg_getcfcheckpt(filter_type=FILTER_TYPE_BASIC, stop_hash=int(bb, 16))\r\nfor i in range(15):\r\n    with node.debug_log_delta(\"getcfcheckpt request received\", \"cfcheckpt response constructed\"):\r\n        node.p2ps[0].send_and_ping(request)\r\ntest.shutdown()\r\n```\r\n\r\n### [no cache](https://github.com/jnewbery/bitcoin/tree/2020-05-nocfcheckpts-cache-debug)\r\n\r\n```\r\ngetcfcheckpt request received to cfcheckpt response constructed: 7.824ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 7.054ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 7.021ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 7.303ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 7.355ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 7.26ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 7.169ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 7.166ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 7.194ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 8.574ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 7.119ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 7.156ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 4.153ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 8.162ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 6.485ms\r\n```\r\n\r\nThere does seem to be a very slight performance improvement after the first request. Maybe around 5-10% from the mean, but variance is quite high, so it might be noise.\r\n\r\n### [cache (taking locks twice)](https://github.com/jnewbery/bitcoin/tree/2020-05-cfcheckpts-cache-debug)\r\n\r\n```\r\ngetcfcheckpt request received to cfcheckpt response constructed: 12.2ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 2.855ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 2.992ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 2.869ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.141ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.692ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.452ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 2.916ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.413ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.648ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.816ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.84ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.812ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.869ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.445ms\r\n```\r\n\r\nThe initial request is slower (presumably because the cache needs to be warmed), but subsequent requests are on average >50% faster than with no cache.\r\n\r\n### [cache (taking lock once)](https://github.com/jnewbery/bitcoin/tree/2020-05-cfcheckpts-onelock-cache-debug)\r\n\r\n```\r\ngetcfcheckpt request received to cfcheckpt response constructed: 11.785ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.35ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.19ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.475ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.175ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.345ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.274ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.161ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.259ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.217ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.238ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.253ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.33ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.32ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.36ms\r\n```\r\n\r\nThe first request is slightly faster than when taking locks twice (although that might be noise). Subsequent requests are the same speed as the 'taking locks twice' branch, which is what we'd expect because locks are only taken once in that branch if the header is found in the cache.\r\n\r\n@MarcoFalke - I think these full node manual benches are more meaningful than microbenches, so I'm not planning to add any automated benches to `/src/bench`.",
      "created_at" : "2020-05-15T01:56:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-628980196",
      "id" : 628980196,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18960",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyODk4MDE5Ng==",
      "updated_at" : "2020-05-15T01:56:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/628980196",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r425526443"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/425526443"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I expect mostly laziness. With an `unordered_map`, you need to provide a hash function. In this case, it's easy. The data is all hash digests from block chain data, so I can just take the first 8 bytes from the uint256 filter header.\r\n\r\nI'll make that change tomorrow.",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-15T02:07:31Z",
      "diff_hunk" : "@@ -30,6 +33,9 @@ class BlockFilterIndex final : public BaseIndex\n     bool ReadFilterFromDisk(const FlatFilePos& pos, BlockFilter& filter) const;\n     size_t WriteFilterToDisk(FlatFilePos& pos, const BlockFilter& filter);\n \n+    Mutex m_cs_headers_cache;\n+    std::map<uint256, uint256> m_headers_cache GUARDED_BY(m_cs_headers_cache);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r425526443",
      "id" : 425526443,
      "in_reply_to_id" : 424888402,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTUyNjQ0Mw==",
      "original_commit_id" : "7ad83ed252914d6d5b8ed81f103aecf052c68fb7",
      "original_line" : 37,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.h",
      "position" : null,
      "pull_request_review_id" : 412300367,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-18T16:54:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/425526443",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> @narula suggested in today's PR Review Club meeting that it'd be less cognitive overhead to simply take the m_cs_headers_cache for the entirety of the LookupFilterHeader() function, rather than taking, releasing and taking it again.\r\n\r\nI'll make this change tomorrow.",
      "created_at" : "2020-05-15T02:08:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-628983530",
      "id" : 628983530,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18960",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyODk4MzUzMA==",
      "updated_at" : "2020-05-15T02:08:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/628983530",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r425708660"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/425708660"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Just as a reminder: There is no free lunch and unordered_map comes with a size penalty",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-15T10:23:09Z",
      "diff_hunk" : "@@ -30,6 +33,9 @@ class BlockFilterIndex final : public BaseIndex\n     bool ReadFilterFromDisk(const FlatFilePos& pos, BlockFilter& filter) const;\n     size_t WriteFilterToDisk(FlatFilePos& pos, const BlockFilter& filter);\n \n+    Mutex m_cs_headers_cache;\n+    std::map<uint256, uint256> m_headers_cache GUARDED_BY(m_cs_headers_cache);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r425708660",
      "id" : 425708660,
      "in_reply_to_id" : 424888402,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTcwODY2MA==",
      "original_commit_id" : "7ad83ed252914d6d5b8ed81f103aecf052c68fb7",
      "original_line" : 37,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.h",
      "position" : null,
      "pull_request_review_id" : 412526565,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-18T16:54:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/425708660",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "In yesterday's [review club meeting on this PR](https://bitcoincore.reviews/18960.html), it was suggested to put LogPrintf() directly into the network processing code parts to measure the execution time of getcfcheckpt requests. (My previous approach of [measuring the request response time from the test framework](https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-628761578) was not precise enough, as the time also included python overhead and the time for the message handler to wake up.) I did some testing with this refined approach and can roughly confirm the [results from jnewbery](https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-628980196) (see commit https://github.com/theStack/bitcoin/commit/48cff1bb4d27ef0040b18a860a3c897752e3c296):\r\n\r\n*without cache*:\r\n```\r\n2020-05-14T20:15:11Z getcfcheckpt processing took 10247us\r\n2020-05-14T20:15:11Z getcfcheckpt processing took 6105us\r\n2020-05-14T20:15:11Z getcfcheckpt processing took 6437us\r\n2020-05-14T20:15:11Z getcfcheckpt processing took 5330us\r\n2020-05-14T20:15:11Z getcfcheckpt processing took 6964us\r\n2020-05-14T20:15:11Z getcfcheckpt processing took 5523us\r\n2020-05-14T20:15:12Z getcfcheckpt processing took 5413us\r\n2020-05-14T20:15:12Z getcfcheckpt processing took 5843us\r\n2020-05-14T20:15:12Z getcfcheckpt processing took 7060us\r\n2020-05-14T20:15:12Z getcfcheckpt processing took 6165us\r\n...\r\n```\r\n*with cache*:\r\n```\r\n2020-05-14T20:21:26Z getcfcheckpt processing took 9801us\r\n2020-05-14T20:21:26Z getcfcheckpt processing took 2619us\r\n2020-05-14T20:21:26Z getcfcheckpt processing took 3338us\r\n2020-05-14T20:21:26Z getcfcheckpt processing took 2446us\r\n2020-05-14T20:21:26Z getcfcheckpt processing took 2560us\r\n2020-05-14T20:21:27Z getcfcheckpt processing took 2331us\r\n2020-05-14T20:21:27Z getcfcheckpt processing took 2703us\r\n2020-05-14T20:21:27Z getcfcheckpt processing took 2614us\r\n2020-05-14T20:21:27Z getcfcheckpt processing took 2598us\r\n2020-05-14T20:21:27Z getcfcheckpt processing took 2444us\r\n...\r\n```\r\nOne can see that there's a speedup of at least 2x with the cache.\r\n\r\nNote that my approach to get these numbers was slightly different, as I directly measured the time in bitcoind via `GetTimeMicros()` (commit https://github.com/theStack/bitcoin/commit/49f5f3d5444ed6c872dd41be910e2149308b35e7):\r\n```diff\r\ndiff --git a/src/net_processing.cpp b/src/net_processing.cpp\r\nindex 1df1fab..6e620d9 100644\r\n--- a/src/net_processing.cpp\r\n+++ b/src/net_processing.cpp\r\n@@ -3380,7 +3380,10 @@ bool ProcessMessage(CNode* pfrom, const std::string& msg_type, CDataStream& vRec\r\n     }\r\n\r\n     if (msg_type == NetMsgType::GETCFCHECKPT) {\r\n+        int64_t start_time = GetTimeMicros();\r\n         ProcessGetCFCheckPt(pfrom, vRecv, chainparams, connman);\r\n+        int64_t processing_duration = GetTimeMicros() - start_time;\r\n+        LogPrintf(\"getcfcheckpt processing took %lldus\\n\", processing_duration);\r\n         return true;\r\n     }\r\n```\r\n\r\nbut the idea is the same.\r\n\r\nNow I'm very curious if the change from `std::map` to `std::unordered_map` shows a noticable difference in performance.\r\n\r\n@MarcoFalke: Nice idea to drop the cache between the requests. Unfortunately, on my current development box I don't have the permissions (root rights) to do this :/ if anyone having the possibility, the results would be very interesting.",
      "created_at" : "2020-05-15T10:37:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-629163428",
      "id" : 629163428,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18960",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyOTE2MzQyOA==",
      "updated_at" : "2020-05-15T10:40:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/629163428",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r425907876"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/425907876"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've reimplemented this as an unordered_map",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-15T16:17:09Z",
      "diff_hunk" : "@@ -30,6 +33,9 @@ class BlockFilterIndex final : public BaseIndex\n     bool ReadFilterFromDisk(const FlatFilePos& pos, BlockFilter& filter) const;\n     size_t WriteFilterToDisk(FlatFilePos& pos, const BlockFilter& filter);\n \n+    Mutex m_cs_headers_cache;\n+    std::map<uint256, uint256> m_headers_cache GUARDED_BY(m_cs_headers_cache);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r425907876",
      "id" : 425907876,
      "in_reply_to_id" : 424888402,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTkwNzg3Ng==",
      "original_commit_id" : "7ad83ed252914d6d5b8ed81f103aecf052c68fb7",
      "original_line" : 37,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.h",
      "position" : null,
      "pull_request_review_id" : 412787017,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-18T16:54:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/425907876",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> it'd be less cognitive overhead to simply take the m_cs_headers_cache for the entirety of the LookupFilterHeader() function\r\n\r\n@narula \r\n\r\nDone.",
      "created_at" : "2020-05-15T16:17:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-629351023",
      "id" : 629351023,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18960",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyOTM1MTAyMw==",
      "updated_at" : "2020-05-15T16:17:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/629351023",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r425911921"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/425911921"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nit: give justification in comments for magic numbers so future readers have some idea how this was chosen and if/when it will need to be adjusted.",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-15T16:24:18Z",
      "diff_hunk" : "@@ -31,6 +31,8 @@ constexpr char DB_FILTER_POS = 'P';\n constexpr unsigned int MAX_FLTR_FILE_SIZE = 0x1000000; // 16 MiB\n /** The pre-allocation chunk size for fltr?????.dat files */\n constexpr unsigned int FLTR_FILE_CHUNK_SIZE = 0x100000; // 1 MiB\n+/** Maximum size of the cfheaders cache */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r425911921",
      "id" : 425911921,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTkxMTkyMQ==",
      "original_commit_id" : "4018953ee9d190188b0b10ef1463f7b64b4e59bb",
      "original_line" : 34,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : null,
      "pull_request_review_id" : 412792135,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-18T16:54:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/425911921",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r425918218"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/425918218"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You'll still want to condition this on `block_index->nHeight % CFCHECKPT_INTERVAL == 0`, otherwise the most recent 2000 requested headers will be cached rather than the desired ones.",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-15T16:34:43Z",
      "diff_hunk" : "@@ -387,13 +389,25 @@ bool BlockFilterIndex::LookupFilter(const CBlockIndex* block_index, BlockFilter&\n     return ReadFilterFromDisk(entry.pos, filter_out);\n }\n \n-bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out) const\n+bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out)\n {\n+    LOCK(m_cs_headers_cache);\n+    auto header = m_headers_cache.find(block_index->GetBlockHash());\n+    if (header != m_headers_cache.end()) {\n+        header_out = header->second;\n+        return true;\n+    }\n+\n     DBVal entry;\n     if (!LookupOne(*m_db, block_index, entry)) {\n         return false;\n     }\n \n+    // Add to the headers cache\n+    if (m_headers_cache.size() < CF_HEADERS_CACHE_MAX_SZ) {\n+        m_headers_cache.emplace(block_index->GetBlockHash(), entry.header);\n+    }\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r425918218",
      "id" : 425918218,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTkxODIxOA==",
      "original_commit_id" : "4018953ee9d190188b0b10ef1463f7b64b4e59bb",
      "original_line" : 421,
      "original_position" : 32,
      "original_start_line" : 406,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : null,
      "pull_request_review_id" : 412800070,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-05-18T16:54:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/425918218",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4015903?v=4",
         "events_url" : "https://api.github.com/users/jkczyz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jkczyz/followers",
         "following_url" : "https://api.github.com/users/jkczyz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jkczyz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jkczyz",
         "id" : 4015903,
         "login" : "jkczyz",
         "node_id" : "MDQ6VXNlcjQwMTU5MDM=",
         "organizations_url" : "https://api.github.com/users/jkczyz/orgs",
         "received_events_url" : "https://api.github.com/users/jkczyz/received_events",
         "repos_url" : "https://api.github.com/users/jkczyz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jkczyz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jkczyz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jkczyz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r425918731"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/425918731"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yikes. Thanks",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-15T16:35:39Z",
      "diff_hunk" : "@@ -387,13 +389,25 @@ bool BlockFilterIndex::LookupFilter(const CBlockIndex* block_index, BlockFilter&\n     return ReadFilterFromDisk(entry.pos, filter_out);\n }\n \n-bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out) const\n+bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out)\n {\n+    LOCK(m_cs_headers_cache);\n+    auto header = m_headers_cache.find(block_index->GetBlockHash());\n+    if (header != m_headers_cache.end()) {\n+        header_out = header->second;\n+        return true;\n+    }\n+\n     DBVal entry;\n     if (!LookupOne(*m_db, block_index, entry)) {\n         return false;\n     }\n \n+    // Add to the headers cache\n+    if (m_headers_cache.size() < CF_HEADERS_CACHE_MAX_SZ) {\n+        m_headers_cache.emplace(block_index->GetBlockHash(), entry.header);\n+    }\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r425918731",
      "id" : 425918731,
      "in_reply_to_id" : 425918218,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTkxODczMQ==",
      "original_commit_id" : "4018953ee9d190188b0b10ef1463f7b64b4e59bb",
      "original_line" : 421,
      "original_position" : 32,
      "original_start_line" : 406,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : null,
      "pull_request_review_id" : 412800738,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-05-18T16:54:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/425918731",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "utACK",
      "created_at" : "2020-05-15T16:40:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-629361597",
      "id" : 629361597,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18960",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyOTM2MTU5Nw==",
      "updated_at" : "2020-05-15T16:40:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/629361597",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've force-pushed a branch that changes this to use an unordered_map and only lock once.\r\n\r\nComparing the unordered map implementation to map:\r\n\r\n#### unordered_map\r\n\r\n<details><summary>Log</summary>\r\n\r\n```\r\ngetcfcheckpt request received to cfcheckpt response constructed: 12.808ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 2.783ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 2.712ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 2.656ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 2.672ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 2.82ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 2.994ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.068ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.335ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.444ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.159ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.194ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 2.601ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 2.692ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 2.982ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.209ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.116ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.136ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 2.666ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.091ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.444ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.385ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.147ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.145ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.053ms\r\n```\r\n</p></details>\r\nFirst lookup: 12.8ms, average subsequent lookup: 3.02ms\r\n\r\n#### map\r\n\r\n<details><summary>Log</summary>\r\n\r\n```\r\ngetcfcheckpt request received to cfcheckpt response constructed: 12.959ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.001ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.656ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 2.07ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 2.537ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 2.838ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 2.994ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.143ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.383ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.666ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.889ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.553ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.394ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.3ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.5ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.372ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.329ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.308ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.564ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.746ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.714ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.423ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.517ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.636ms\r\ngetcfcheckpt request received to cfcheckpt response constructed: 3.595ms\r\n```\r\n</details>\r\nFirst lookup: 13.0ms, average subsequent lookup: 3.60s\r\n\r\nSo from this single test, it appears that an unordered_map is indeed faster. That's what we'd expect, since lookup is O(1) and number of lookups required for a single getcfcheckpt request is O(n), so total is O(n). For a map, a single lookup is O(logn), so total is O(nlogn).\r\n\r\nThe original implementation is faster still, since it's storing the checkpts in a single vector, but the aim of this PR is to avoid disk reads for getcfcheckpt messages, which the simple unordered_map implementation does. Further performance improvements could be done as a follow-up if required.",
      "created_at" : "2020-05-15T16:41:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-629361873",
      "id" : 629361873,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18960",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyOTM2MTg3Mw==",
      "updated_at" : "2020-05-15T16:41:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/629361873",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r425925522"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/425925522"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-15T16:48:01Z",
      "diff_hunk" : "@@ -31,6 +31,8 @@ constexpr char DB_FILTER_POS = 'P';\n constexpr unsigned int MAX_FLTR_FILE_SIZE = 0x1000000; // 16 MiB\n /** The pre-allocation chunk size for fltr?????.dat files */\n constexpr unsigned int FLTR_FILE_CHUNK_SIZE = 0x100000; // 1 MiB\n+/** Maximum size of the cfheaders cache */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r425925522",
      "id" : 425925522,
      "in_reply_to_id" : 425911921,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTkyNTUyMg==",
      "original_commit_id" : "4018953ee9d190188b0b10ef1463f7b64b4e59bb",
      "original_line" : 34,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : null,
      "pull_request_review_id" : 412809145,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-18T16:54:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/425925522",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r425925547"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/425925547"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-15T16:48:05Z",
      "diff_hunk" : "@@ -387,13 +389,25 @@ bool BlockFilterIndex::LookupFilter(const CBlockIndex* block_index, BlockFilter&\n     return ReadFilterFromDisk(entry.pos, filter_out);\n }\n \n-bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out) const\n+bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out)\n {\n+    LOCK(m_cs_headers_cache);\n+    auto header = m_headers_cache.find(block_index->GetBlockHash());\n+    if (header != m_headers_cache.end()) {\n+        header_out = header->second;\n+        return true;\n+    }\n+\n     DBVal entry;\n     if (!LookupOne(*m_db, block_index, entry)) {\n         return false;\n     }\n \n+    // Add to the headers cache\n+    if (m_headers_cache.size() < CF_HEADERS_CACHE_MAX_SZ) {\n+        m_headers_cache.emplace(block_index->GetBlockHash(), entry.header);\n+    }\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r425925547",
      "id" : 425925547,
      "in_reply_to_id" : 425918218,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTkyNTU0Nw==",
      "original_commit_id" : "4018953ee9d190188b0b10ef1463f7b64b4e59bb",
      "original_line" : 421,
      "original_position" : 32,
      "original_start_line" : 406,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : null,
      "pull_request_review_id" : 412809181,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-05-18T16:54:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/425925547",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Feedback from @narula and @jkczyz addressed. Thanks!",
      "created_at" : "2020-05-15T16:48:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-629365265",
      "id" : 629365265,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18960",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyOTM2NTI2NQ==",
      "updated_at" : "2020-05-15T16:48:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/629365265",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK b6eba9e492e1dfb38baec894bfda1cfb4d709e5d\r\n\r\nRan all tests.",
      "created_at" : "2020-05-15T17:55:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-629397391",
      "id" : 629397391,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18960",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyOTM5NzM5MQ==",
      "updated_at" : "2020-05-15T17:55:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/629397391",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4015903?v=4",
         "events_url" : "https://api.github.com/users/jkczyz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jkczyz/followers",
         "following_url" : "https://api.github.com/users/jkczyz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jkczyz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jkczyz",
         "id" : 4015903,
         "login" : "jkczyz",
         "node_id" : "MDQ6VXNlcjQwMTU5MDM=",
         "organizations_url" : "https://api.github.com/users/jkczyz/orgs",
         "received_events_url" : "https://api.github.com/users/jkczyz/received_events",
         "repos_url" : "https://api.github.com/users/jkczyz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jkczyz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jkczyz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jkczyz"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "utACK b6eba9e492e1dfb38baec894bfda1cfb4d709e5d",
      "created_at" : "2020-05-15T19:30:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-629439397",
      "id" : 629439397,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18960",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyOTQzOTM5Nw==",
      "updated_at" : "2020-05-15T19:30:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/629439397",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r426246248"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426246248"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Before the last change, the cache lookup only happened for checkpoint blocks (i.e. block number modulo 1000 is zero). Is this removal of the condition intended?",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-17T10:49:38Z",
      "diff_hunk" : "@@ -387,13 +393,26 @@ bool BlockFilterIndex::LookupFilter(const CBlockIndex* block_index, BlockFilter&\n     return ReadFilterFromDisk(entry.pos, filter_out);\n }\n \n-bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out) const\n+bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out)\n {\n+    LOCK(m_cs_headers_cache);\n+    auto header = m_headers_cache.find(block_index->GetBlockHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r426246248",
      "id" : 426246248,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI0NjI0OA==",
      "original_commit_id" : "b6eba9e492e1dfb38baec894bfda1cfb4d709e5d",
      "original_line" : 399,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : null,
      "pull_request_review_id" : 413149842,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-18T16:54:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426246248",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r426766679"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426766679"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No. Not intentional. I just messed up splitting out the `LOCK(m_cs_headers_cache)`. Thanks for catching this.",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-18T16:54:54Z",
      "diff_hunk" : "@@ -387,13 +393,26 @@ bool BlockFilterIndex::LookupFilter(const CBlockIndex* block_index, BlockFilter&\n     return ReadFilterFromDisk(entry.pos, filter_out);\n }\n \n-bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out) const\n+bool BlockFilterIndex::LookupFilterHeader(const CBlockIndex* block_index, uint256& header_out)\n {\n+    LOCK(m_cs_headers_cache);\n+    auto header = m_headers_cache.find(block_index->GetBlockHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r426766679",
      "id" : 426766679,
      "in_reply_to_id" : 426246248,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc2NjY3OQ==",
      "original_commit_id" : "b6eba9e492e1dfb38baec894bfda1cfb4d709e5d",
      "original_line" : 399,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.cpp",
      "position" : null,
      "pull_request_review_id" : 413774709,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-18T16:54:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426766679",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the rereview @jkczyz and @theStack , and for catching the problems with checking checkpoint heights. Should be fixed now.",
      "created_at" : "2020-05-18T16:55:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-630310732",
      "id" : 630310732,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18960",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMDMxMDczMg==",
      "updated_at" : "2020-05-18T16:55:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/630310732",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK 0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-18T17:22:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-630325155",
      "id" : 630325155,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18960",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMDMyNTE1NQ==",
      "updated_at" : "2020-05-18T17:22:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/630325155",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4015903?v=4",
         "events_url" : "https://api.github.com/users/jkczyz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jkczyz/followers",
         "following_url" : "https://api.github.com/users/jkczyz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jkczyz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jkczyz",
         "id" : 4015903,
         "login" : "jkczyz",
         "node_id" : "MDQ6VXNlcjQwMTU5MDM=",
         "organizations_url" : "https://api.github.com/users/jkczyz/orgs",
         "received_events_url" : "https://api.github.com/users/jkczyz/received_events",
         "repos_url" : "https://api.github.com/users/jkczyz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jkczyz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jkczyz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jkczyz"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK 0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf :tada: \r\n\r\nBy the way, I'm neutral to the question on whether to use `std::map` or `std::unordered_map` for the cache -- `std::unordered_map` does indeed seem to lead to some performance improvement (my tests show a rough 10% improvement, see numbers below; [jnewberys tests](https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-629361873) show an even higher improvement of close to 20%), but on the other hand takes both more space (as [pointed out by MarcoFalke](https://github.com/bitcoin/bitcoin/pull/18960#discussion_r425708660)) and also more code due to the need to provide a hash function. Maybe someone has a more clear opinion on the choice, personally I'm okay with ACKing either version.\r\n\r\nTest with `std::map`:\r\n```\r\n2020-05-19T09:09:01Z getcfcheckpt processing took 13817us\r\n2020-05-19T09:09:01Z getcfcheckpt processing took 2855us\r\n2020-05-19T09:09:01Z getcfcheckpt processing took 3573us\r\n2020-05-19T09:09:01Z getcfcheckpt processing took 3444us\r\n2020-05-19T09:09:01Z getcfcheckpt processing took 3236us\r\n2020-05-19T09:09:01Z getcfcheckpt processing took 3385us\r\n2020-05-19T09:09:01Z getcfcheckpt processing took 3543us\r\n2020-05-19T09:09:01Z getcfcheckpt processing took 3378us\r\n2020-05-19T09:09:01Z getcfcheckpt processing took 3450us\r\n2020-05-19T09:09:01Z getcfcheckpt processing took 3041us\r\n2020-05-19T09:09:01Z getcfcheckpt processing took 3561us\r\n...\r\n```\r\n:arrow_right: Average subsequent lookup: 3,346ms\r\n\r\nTest with `std::unordered_map`:\r\n```\r\n2020-05-19T08:59:53Z getcfcheckpt processing took 12205us\r\n2020-05-19T08:59:53Z getcfcheckpt processing took 3650us\r\n2020-05-19T08:59:53Z getcfcheckpt processing took 4660us\r\n2020-05-19T08:59:53Z getcfcheckpt processing took 3393us\r\n2020-05-19T08:59:53Z getcfcheckpt processing took 3669us\r\n2020-05-19T08:59:53Z getcfcheckpt processing took 2919us\r\n2020-05-19T08:59:53Z getcfcheckpt processing took 2565us\r\n2020-05-19T08:59:53Z getcfcheckpt processing took 2804us\r\n2020-05-19T08:59:53Z getcfcheckpt processing took 2348us\r\n2020-05-19T08:59:53Z getcfcheckpt processing took 2511us\r\n2020-05-19T08:59:53Z getcfcheckpt processing took 2264us\r\n...\r\n```\r\n:arrow_right: Average subsequent lookup: 3,078ms",
      "created_at" : "2020-05-19T09:33:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-630706114",
      "id" : 630706114,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18960",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMDcwNjExNA==",
      "updated_at" : "2020-05-19T09:33:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/630706114",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "re-utACK 0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf\r\n\r\nCompared to my last review `is_checkpoint` variable is introduced for better readability and if statement that was removed in error is added back: https://github.com/bitcoin/bitcoin/compare/b6eba9e492e1dfb38baec894bfda1cfb4d709e5d..0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-19T14:08:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-630843553",
      "id" : 630843553,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18960",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMDg0MzU1Mw==",
      "updated_at" : "2020-05-19T14:08:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/630843553",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r428395728"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/428395728"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If you have to change PR again, you may comment that key value is block hash and mapped value filter-header, type being the same it may be confusing at first look.",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-21T01:25:22Z",
      "diff_hunk" : "@@ -30,6 +38,9 @@ class BlockFilterIndex final : public BaseIndex\n     bool ReadFilterFromDisk(const FlatFilePos& pos, BlockFilter& filter) const;\n     size_t WriteFilterToDisk(FlatFilePos& pos, const BlockFilter& filter);\n \n+    Mutex m_cs_headers_cache;\n+    std::unordered_map<uint256, uint256, FilterHeaderHasher> m_headers_cache GUARDED_BY(m_cs_headers_cache);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r428395728",
      "id" : 428395728,
      "line" : 42,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODM5NTcyOA==",
      "original_commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "original_line" : 42,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.h",
      "position" : 20,
      "pull_request_review_id" : 415819860,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-21T01:29:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/428395728",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r428714115"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/428714115"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point. I'll add a comment if I need to retouch the branch.",
      "commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-21T15:06:27Z",
      "diff_hunk" : "@@ -30,6 +38,9 @@ class BlockFilterIndex final : public BaseIndex\n     bool ReadFilterFromDisk(const FlatFilePos& pos, BlockFilter& filter) const;\n     size_t WriteFilterToDisk(FlatFilePos& pos, const BlockFilter& filter);\n \n+    Mutex m_cs_headers_cache;\n+    std::unordered_map<uint256, uint256, FilterHeaderHasher> m_headers_cache GUARDED_BY(m_cs_headers_cache);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#discussion_r428714115",
      "id" : 428714115,
      "in_reply_to_id" : 428395728,
      "line" : 42,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODcxNDExNQ==",
      "original_commit_id" : "0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "original_line" : 42,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/index/blockfilterindex.h",
      "position" : 20,
      "pull_request_review_id" : 416230929,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18960",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-21T15:06:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/428714115",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "code review ACK 0187d4c118ab4c0f5c2d4fb180c2a8dea8ac53cf",
      "created_at" : "2020-05-21T17:34:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18960#issuecomment-632242849",
      "id" : 632242849,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18960",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMjI0Mjg0OQ==",
      "updated_at" : "2020-05-21T17:34:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/632242849",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
