{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "ASLR is not currently working for the `bitcoin-cli.exe` binary. This is\r\ndue to it not having a .reloc section, which is stripped by default by\r\nthe mingw-w64 ld we use for gitian builds. A good summary of issues with\r\nld and mingw-w64 is available in this thread: \r\nhttps://sourceware.org/bugzilla/show_bug.cgi?id=19011.\r\n\r\nAll other Windows binaries that we distribute (bitcoind, bitcoin-qt,\r\nbitcoin-wallet, bitcoin-tx and test_bitcoin) do not suffer this issue,\r\nand currently having working ASLR. This is due to them exporting\r\n(inadvertent or not) libsecp256k1 symbols, and, as a result, the .reloc\r\nsection is not stripped by ld.\r\n\r\nThis change is a temporary workaround, also the same one described here:\r\nhttps://www.kb.cert.org/vuls/id/307144/, that causes main() to be\r\nexported. Exporting a symbol will mean that the .reloc section is not\r\nstripped, and ASLR will function correctly.\r\n\r\nUltimately, this will be fixed by using a newer version of binutils (that has this [change](https://sourceware.org/git/gitweb.cgi?p=binutils-gdb.git;a=commit;h=dc9bd8c92af67947db44b3cb428c050259b15cd0)). Whether that's through bumping our gitian distro, or Guix.\r\n\r\nRelated to #18629, which has a bunch of additional information in the PR description. If you would like to verify whether or not ASLR is indeed working, with or without this change. One easy way to check is using a tool like [VMMap](https://docs.microsoft.com/en-us/sysinternals/downloads/vmmap).\r\n\r\nHere are the memory mappings for the 0.20.0rc1 `bitcoind.exe` and `bitcoin-cli.exe` binaries. You'll notice that over machine restarts, even though the image is marked `(ASLR)` (which I assume may be due to the header bit being set), no ASLR is actually occuring for `bitcoin-cli.exe`:\r\n\r\n#### bitcoind.exe\r\n\r\n![bitcoind-1](https://user-images.githubusercontent.com/863730/79678203-74065c80-822b-11ea-90bc-9c883d0aeefa.png)\r\n\r\n![bitcoind-2](https://user-images.githubusercontent.com/863730/79678204-7668b680-822b-11ea-9263-3e7ba22f904c.png)\r\n\r\n![bitcoind-3](https://user-images.githubusercontent.com/863730/79678206-7963a700-822b-11ea-972f-af31a514b9b4.png)\r\n\r\n#### bitcoin-cli.exe \r\n\r\n![bitcoin-cli-1](https://user-images.githubusercontent.com/863730/79678208-7ec0f180-822b-11ea-8480-a4b5d1762945.png)\r\n\r\n![bitcoin-cli-2](https://user-images.githubusercontent.com/863730/79678213-81bbe200-822b-11ea-964d-994f58ff12b0.png)\r\n\r\n![bitcoin-cli-3](https://user-images.githubusercontent.com/863730/79678215-84b6d280-822b-11ea-9cd6-fee2e239c003.png)\r\n",
   "closed_at" : "2020-04-22T13:18:37Z",
   "closed_by" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   },
   "comments" : 3,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18702/comments",
   "created_at" : "2020-04-19T02:57:32Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18702/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/18702",
   "id" : 602605504,
   "labels" : [
      {
         "color" : "5319e7",
         "default" : false,
         "description" : null,
         "id" : 61889416,
         "name" : "Build system",
         "node_id" : "MDU6TGFiZWw2MTg4OTQxNg==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Build%20system"
      },
      {
         "color" : "ff8200",
         "default" : false,
         "description" : "",
         "id" : 1979938469,
         "name" : "Needs backport (0.20)",
         "node_id" : "MDU6TGFiZWwxOTc5OTM4NDY5",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Needs%20backport%20(0.20)"
      },
      {
         "color" : "884400",
         "default" : false,
         "description" : null,
         "id" : 234877,
         "name" : "Windows",
         "node_id" : "MDU6TGFiZWwyMzQ4Nzc=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Windows"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18702/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDExOlB1bGxSZXF1ZXN0NDA1NTk0OTc3",
   "number" : 18702,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/18702.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18702",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/18702.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18702"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "build: fix ASLR for bitcoin-cli on Windows",
   "updated_at" : "2020-04-22T13:18:37Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18702",
   "user" : {
      "avatar_url" : "https://avatars2.githubusercontent.com/u/863730?v=4",
      "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
      "followers_url" : "https://api.github.com/users/fanquake/followers",
      "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
      "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/fanquake",
      "id" : 863730,
      "login" : "fanquake",
      "node_id" : "MDQ6VXNlcjg2MzczMA==",
      "organizations_url" : "https://api.github.com/users/fanquake/orgs",
      "received_events_url" : "https://api.github.com/users/fanquake/received_events",
      "repos_url" : "https://api.github.com/users/fanquake/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/fanquake"
   }
}
