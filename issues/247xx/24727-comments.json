[
   {
      "author_association" : "MEMBER",
      "body" : "Code review ACK, though this still seems mysterious to me.\r\n\r\nAny idea why we're just now running into this? Afaics that gcc bug has been around for years.",
      "created_at" : "2022-03-31T22:36:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24727#issuecomment-1085196391",
      "id" : 1085196391,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24727",
      "node_id" : "IC_kwDOABII585Arshn",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1085196391/reactions"
      },
      "updated_at" : "2022-03-31T22:36:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1085196391",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I don't know. Did the previous mingw-w64 compiler have AVX2 support at all? If so, we could compare the assembly of the [`_ZN14sha256d64_avx214Transform_8wayEPhPKh`](https://gist.github.com/laanwj/95d97cd218d99c68c1437115e0db9394) with that of older releases.\r\n\r\nIt's also mysterious it's a pretty rare problem. E.g. in @hebasto's case it only turns up on `-signet`. Maybe the stack is almost always aligned to 32  bytes for some reason it's just not guaranteed.\r\n\r\nThat said, if this really fixes it, I prefer this solution. Who knows how many mysterious crashes have gone unreported. People blaming their hardware, or Windows.",
      "created_at" : "2022-03-31T22:39:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24727#issuecomment-1085198199",
      "id" : 1085198199,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24727",
      "node_id" : "IC_kwDOABII585Ars93",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1085198199/reactions"
      },
      "updated_at" : "2022-03-31T22:44:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1085198199",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Still curious why v22.0 works fine?\r\n\r\nHave you checked that it picks the AVX2 code path on v22.0? E.g. that line would show `avx2(8way)`.\r\n",
      "created_at" : "2022-04-01T07:40:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24727#issuecomment-1085539611",
      "id" : 1085539611,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24727",
      "node_id" : "IC_kwDOABII585AtAUb",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1085539611/reactions"
      },
      "updated_at" : "2022-04-01T07:40:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1085539611",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> > Still curious why v22.0 works fine?\r\n> \r\n> \r\n> \r\n> Have you checked that it picks the AVX2 code path on v22.0? E.g. that line would show `avx2(8way)`.\r\n> \r\n> \r\n\r\nYes, v22.0 does pick AVX2:\r\n```\r\nC:\\Users\\hebasto\\Desktop\\22.0\\bitcoin-22.0>bin\\bitcoind.exe -signet\r\n2022-04-01T07:42:37Z Bitcoin Core version v22.0.0 (release build)\r\n2022-04-01T07:42:37Z Signet derived magic (message start): 0a03cf40\r\n2022-04-01T07:42:37Z Assuming ancestors of block 000000187d4440e5bff91488b700a140441e089a8aaea707414982460edbfe54 have valid signatures.\r\n2022-04-01T07:42:37Z Setting nMinimumChainWork=0000000000000000000000000000000000000000000000000000008546553c03\r\n2022-04-01T07:42:37Z Using the 'sse4(1way),sse41(4way),avx2(8way)' SHA256 implementation\r\n...\r\n```",
      "created_at" : "2022-04-01T07:41:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24727#issuecomment-1085540795",
      "id" : 1085540795,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24727",
      "node_id" : "IC_kwDOABII585AtAm7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1085540795/reactions"
      },
      "updated_at" : "2022-04-01T07:43:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1085540795",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "So I see three possible reasons:\r\n- It just happens that %esp is always 32-aligned on 22.0 when calling that specific function. Voodoo magic witchcraft. (Edit: I think this one is ruled out: 22.0 bitcoind.exe does not contain any `vmovdqa` instructions involving the stack, so 32-alignment ought to not matter)\r\n- gcc got \"smarter\" about alignment and started using the 256-bit aligned store `vmovdqa` instead of split-aligned or non-aligned store in this case. After all, we did change compiler version to 10.3 right?\r\n- gcc got dumber and needs to spill, where it could juggle everything in registers before.\r\n\r\nTo know for sure we would need to compare the disassembly of that function. I can take a look.",
      "created_at" : "2022-04-01T07:51:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24727#issuecomment-1085547515",
      "id" : 1085547515,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24727",
      "node_id" : "IC_kwDOABII585AtCP7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1085547515/reactions"
      },
      "updated_at" : "2022-04-01T08:42:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1085547515",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I looked at the assembly again and the direct cause seems to be that gcc 10.3 stopped inlining `sha256d64_avx2::Write8`. This puts the argument on the stack. It's **not** spilling as I thought.\r\n\r\nForcing inline of `Write` might work for a bit but is brittle and unsafe.\r\n\r\nThanks to @fanquake we may have a better alternative solution. Other distributions patch mingw-w64 to not generate AVX code that makes alignment assumptions. E.g. this is debian's patch:\r\nhttps://salsa.debian.org/mingw-w64-team/gcc-mingw-w64/-/blob/master/debian/patches/vmov-alignment.patch\r\n\r\nIf we can integrate it in the guix build it may be safe to keep AVX2 enabled for the windows build.",
      "created_at" : "2022-04-01T09:33:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24727#issuecomment-1085679276",
      "id" : 1085679276,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24727",
      "node_id" : "IC_kwDOABII585Atias",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1085679276/reactions"
      },
      "updated_at" : "2022-04-01T09:33:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1085679276",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Closing in favor of #24736",
      "created_at" : "2022-04-01T13:03:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24727#issuecomment-1085872993",
      "id" : 1085872993,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24727",
      "node_id" : "IC_kwDOABII585AuRth",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1085872993/reactions"
      },
      "updated_at" : "2022-04-01T13:03:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1085872993",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
