[
   {
      "author_association" : "MEMBER",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [ghost](https://github.com/bitcoin/bitcoin/pull/25979#issuecomment-1236054202) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#bitcoin-core/gui/700](https://github.com/bitcoin-core/gui/pull/700) (Dialog for allowing the user to choose the change output when bumping a tx by achow101)\n* [#bitcoin-core/gui/650](https://github.com/bitcoin-core/gui/pull/650) (Add Import to Wallet GUI by KolbyML)\n* [#26840](https://github.com/bitcoin/bitcoin/pull/26840) (refactor: importpubkey, importprivkey, importaddress, importmulti, and importdescriptors rpc by KolbyML)\n* [#26627](https://github.com/bitcoin/bitcoin/pull/26627) (wallet: Migrate non-HD keys with single combo containing a list of keys by achow101)\n* [#26596](https://github.com/bitcoin/bitcoin/pull/26596) (wallet: Migrate legacy wallets to descriptor wallets without requiring BDB by achow101)\n* [#26467](https://github.com/bitcoin/bitcoin/pull/26467) (bumpfee: Allow the user to choose which output is change by achow101)\n* [#26008](https://github.com/bitcoin/bitcoin/pull/26008) (wallet: cache IsMine scriptPubKeys to improve performance of descriptor wallets by achow101)\n* [#25909](https://github.com/bitcoin/bitcoin/pull/25909) (wallet: coverage for receiving txes with same id but different witness data by furszy)\n* [#25907](https://github.com/bitcoin/bitcoin/pull/25907) (wallet: rpc to add automatically generated descriptors by achow101)\n* [#22838](https://github.com/bitcoin/bitcoin/pull/22838) (descriptors: Be able to specify change and receiving in a single descriptor string by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2022-09-01T21:23:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25979#issuecomment-1234798212",
      "id" : 1234798212,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25979",
      "node_id" : "IC_kwDOABII585JmYaE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1234798212/reactions"
      },
      "updated_at" : "2023-05-20T08:44:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1234798212",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Interesting pull request although I haven't tested it yet. \r\n\r\nDoes this also fix https://github.com/bitcoin/bitcoin/issues/20935 and https://github.com/bitcoin/bitcoin/issues/20795 ?\r\n\r\n > How Change Detection Currently Works?\r\nThe wallet walks-through the transaction outputs, extracts the script\r\ndestination and verify the following two points:\r\n\r\n> If the destination doesn't exist in the address book, then the script\r\nis a \"change address\".\r\n\r\n> If the destination exists in the address book, but it doesn't have a\r\nlabel, then the script is a \"change address\".\r\n\r\nI was assuming change address had different derivation path. Is that false?",
      "created_at" : "2022-09-02T02:31:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25979#issuecomment-1234999269",
      "id" : 1234999269,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25979",
      "node_id" : "IC_kwDOABII585JnJfl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1234999269/reactions"
      },
      "updated_at" : "2022-09-02T02:31:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1234999269",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10137?v=4",
         "events_url" : "https://api.github.com/users/ghost/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ghost/followers",
         "following_url" : "https://api.github.com/users/ghost/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ghost/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ghost",
         "id" : 10137,
         "login" : "ghost",
         "node_id" : "MDQ6VXNlcjEwMTM3",
         "organizations_url" : "https://api.github.com/users/ghost/orgs",
         "received_events_url" : "https://api.github.com/users/ghost/received_events",
         "repos_url" : "https://api.github.com/users/ghost/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ghost/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ghost/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ghost"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Does this also fix #20935 and #20795 ?\r\n\r\nYes for the change outputs detection part. It will allow us to properly detect each individual output as change or not, independently on what is stored in the address book entry (making the process deterministic across instances, and not dependent on a data structure that the user can freely modify).\r\n\r\nAs an edge case example; with this, users could even receive coins on an internal address and the new mechanism will properly detect it as an external reception, not a change output (the transaction inputs aren't from the wallet, so no coins are returning to it). Still, this behavior is obviously not encouraged, nor should be easy to do in the wallet, as it breaks the whole idea of internal/external derivation paths.\r\n\r\nPlus, would recommend you to check [#25685](https://github.com/bitcoin/bitcoin/pull/25685) as well. The first commit there fixes a misleading wallet behavior where even if you set `add_inputs=false` (telling the wallet to disallow automatic coin selection), the wallet will still fetch coins internally and use them in the Coin Selection process (if you don't pre-set inputs manually).\r\n\r\n\r\n> > How Change Detection Currently Works?\r\n> > The wallet walks-through the transaction outputs, extracts the script\r\n> > destination and verify the following two points:\r\n> \r\n> > If the destination doesn't exist in the address book, then the script\r\n> > is a \"change address\".\r\n> \r\n> > If the destination exists in the address book, but it doesn't have a\r\n> > label, then the script is a \"change address\".\r\n> \r\n> I was assuming change address had different derivation path. Is that false?\r\n\r\nNot entirely, the assumption is most of the time correct. It breaks on pre-split legacy wallets, where we don't have an internal derivation path. In those wallet versions we (1) only use an external path to derive public and change addresses, or if we go further back in time, (2) we use a raw pool of keys with no derivation paths at all. (Thus why the initial change detection process was implemented using the address book).",
      "created_at" : "2022-09-02T16:09:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25979#issuecomment-1235677701",
      "id" : 1235677701,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25979",
      "node_id" : "IC_kwDOABII585JpvIF",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1235677701/reactions"
      },
      "updated_at" : "2022-09-03T12:34:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1235677701",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Concept ACK\r\n",
      "created_at" : "2022-09-03T05:41:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25979#issuecomment-1236054202",
      "id" : 1236054202,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25979",
      "node_id" : "IC_kwDOABII585JrLC6",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1236054202/reactions"
      },
      "updated_at" : "2022-09-03T05:41:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1236054202",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10137?v=4",
         "events_url" : "https://api.github.com/users/ghost/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ghost/followers",
         "following_url" : "https://api.github.com/users/ghost/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ghost/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ghost",
         "id" : 10137,
         "login" : "ghost",
         "node_id" : "MDQ6VXNlcjEwMTM3",
         "organizations_url" : "https://api.github.com/users/ghost/orgs",
         "received_events_url" : "https://api.github.com/users/ghost/received_events",
         "repos_url" : "https://api.github.com/users/ghost/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ghost/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ghost/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ghost"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "While I like the idea this is going for, I don't think it is sufficient. It relies on `m_internal_spk_managers` which only contains the currently active SPKMs. If a user were to remove a SPKM from being active, all of the addresses that were produced by that would no longer be detected as change. This is especially problematic with #25907 which rotates all of the currently active descriptors.\r\n\r\nIn general, I'm not sure that we can determine which output is change without storing additional metadata. What has been suggested before is to explicitly store an \"IsChange\" value in address book entries, with a \"smart\" fallback like what this PR does.",
      "created_at" : "2022-10-31T19:53:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25979#issuecomment-1297598739",
      "id" : 1297598739,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25979",
      "node_id" : "IC_kwDOABII585NV8kT",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1297598739/reactions"
      },
      "updated_at" : "2022-10-31T19:53:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1297598739",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "finally here. Thanks for the input achow101\r\n\r\n> While I like the idea this is going for, I don't think it is sufficient. It relies on `m_internal_spk_managers` which only contains the currently active SPKMs. If a user were to remove a SPKM from being active, all of the addresses that were produced by that would no longer be detected as change. This is especially problematic with #25907 which rotates all of the currently active descriptors.\r\n\r\nI'm probably missing some context but.. wouldn't that be solvable by adding an `internal` field to the `WalletDescriptor` class? (32a990a). So we can keep track of non-active internal descriptors too.\r\nIt should work fine while we don't have any descriptor removal functionality (which would also mean to remove txs from the wallet etc) and require to keep historical records.\r\n\r\n> In general, I'm not sure that we can determine which output is change without storing additional metadata. What has been suggested before is to explicitly store an \"IsChange\" value in address book entries, with a \"smart\" fallback like what this PR does.\r\n\r\nI think that we should have a more granular distinction and move from \"change addresses\" to \"change outputs\". Storing any extra metadata, if needed, inside the wallet transaction class.\r\n\r\nA good use case for this is the reception of coins from an external source on internal addresses, which shouldn't be detected as change as it could be a simple reception or part of a dust attack.\r\nif the tx has no inputs belonging to the wallet, then no output should be labeled as change.",
      "created_at" : "2023-01-11T19:07:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25979#issuecomment-1379355951",
      "id" : 1379355951,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25979",
      "node_id" : "IC_kwDOABII585SN00v",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1379355951/reactions"
      },
      "updated_at" : "2023-01-11T19:07:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1379355951",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the ping marko, rebased.\r\nYeah, this is still relevant. Change detection is still an issue.\r\n\r\nThe base work is done, just need some extra love.\r\nWill keep it rebased, so anyone can review/test it meanwhile.",
      "created_at" : "2023-05-19T13:42:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25979#issuecomment-1554595205",
      "id" : 1554595205,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25979",
      "node_id" : "IC_kwDOABII585cqT2F",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1554595205/reactions"
      },
      "updated_at" : "2023-05-19T13:45:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1554595205",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This now depends on #27601.\r\nMoved to draft until that one gets merged.",
      "created_at" : "2023-05-19T13:52:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25979#issuecomment-1554609029",
      "id" : 1554609029,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25979",
      "node_id" : "IC_kwDOABII585cqXOF",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1554609029/reactions"
      },
      "updated_at" : "2023-05-19T13:52:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1554609029",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   }
]
