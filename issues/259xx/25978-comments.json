[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I checked out this PR and the tests run for me fine both with and without your changes. However, when I drop in some debugger breakpoints to understand things better, I am able to observe failures in the first test maybe 25% of the time (this is with the changes that are in this PR). The failure is that the `Synchronizing blockheaders, height: 14` log message cannot be found.\r\n\r\nIs there a known race condition here? Am I observing the behavior that this PR is aiming to fix?\r\n\r\nHere are my test steps:\r\n- check out branch, build\r\n- Use `import pdb; pdb.set_trace()` to add some breakpoints. Add a few at the beginning of the first test, but also to `test_node.py assert_debug_log` and `test_framework.py generate`\r\n- run the test: `test/functional/p2p_headers_sync_with_minchainwork.py`\r\n- During a breakpoint, get the log for node3 with `print(self.nodes[3].debug_log_path)` and tail it in another window. I thought this would be helpful but after comparing logs for a successful run, and a failed run, I can't quite catch when the failure is happening. The expected log message does appear in logs for both failed and successful runs.",
      "created_at" : "2022-09-02T16:56:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25978#issuecomment-1235721172",
      "id" : 1235721172,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25978",
      "node_id" : "IC_kwDOABII585Jp5vU",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1235721172/reactions"
      },
      "updated_at" : "2022-09-02T16:56:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1235721172",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1823216?v=4",
         "events_url" : "https://api.github.com/users/satsie/events{/privacy}",
         "followers_url" : "https://api.github.com/users/satsie/followers",
         "following_url" : "https://api.github.com/users/satsie/following{/other_user}",
         "gists_url" : "https://api.github.com/users/satsie/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/satsie",
         "id" : 1823216,
         "login" : "satsie",
         "node_id" : "MDQ6VXNlcjE4MjMyMTY=",
         "organizations_url" : "https://api.github.com/users/satsie/orgs",
         "received_events_url" : "https://api.github.com/users/satsie/received_events",
         "repos_url" : "https://api.github.com/users/satsie/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/satsie/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/satsie/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/satsie"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> However, when I drop in some debugger breakpoints to understand things better, I am able to observe failures\r\n\r\nWhile a debugger is attached, you may run into (unrelated) test timeouts, because the debugger doesn't prevent your system clock from advancing. You may increase the timeout with the timeout-factor command line option, but this will also make it harder to reproduce this intermittent issue, because you may have to wait longer for the timeout to happen if the issue occurs.\r\n\r\nUsually intermittent issues are observed when the system running them puts a thread to sleep for a longer time. Thus, I find it easiest to deterministically reproduce the failures by inserting the sleep myself. For example, you can modify the source code to insert a `UninterruptibleSleep()` into the right thread. (For example like done in https://github.com/bitcoin/bitcoin/pull/25914)\r\n\r\n",
      "created_at" : "2022-09-02T17:16:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25978#issuecomment-1235738097",
      "id" : 1235738097,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25978",
      "node_id" : "IC_kwDOABII585Jp93x",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1235738097/reactions"
      },
      "updated_at" : "2022-09-02T17:16:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1235738097",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Haven't had the chance to look into this yet, but just pointing out that the test currently fails intermittently in the CI, which this PR should fix:\r\nhttps://cirrus-ci.com/task/5407068940140544\r\nhttps://cirrus-ci.com/task/5945347225681920",
      "created_at" : "2022-09-02T17:23:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25978#issuecomment-1235743528",
      "id" : 1235743528,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25978",
      "node_id" : "IC_kwDOABII585Jp_Mo",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1235743528/reactions"
      },
      "updated_at" : "2022-09-02T17:23:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1235743528",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Code Review ACK 88e7807e771a568ac34c320b4055d832990049df\r\n\r\n> Is there a known race condition here? Am I observing the behavior that this PR is aiming to fix?\r\n\r\nYes, there is a race condition: While node 0 mines some blocks, and we wait for node 1 and 2 to complete the headers-sync (and decide to reject the headers because of insufficient work), there was no such check for node 3 before, so that it would be possible to call `getchaintips` for node 3 before it had completed the headerssync.\r\nThis can be seen in the linked logs (around line 4543) where the \"Synchronizing blockheaders, height: 14\" log appears after the `getchaintips` call.",
      "created_at" : "2022-09-02T18:15:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25978#issuecomment-1235783705",
      "id" : 1235783705,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25978",
      "node_id" : "IC_kwDOABII585JqJAZ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1235783705/reactions"
      },
      "updated_at" : "2022-09-02T18:15:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1235783705",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@MarcoFalke thank you for the valuable insight on the debugger's relationship (or lack thereof) with the system clock. I like what you said about intentionally inserting sleeps to reproduce intermittent timing failures. That's clever!\r\n\r\n@mzumsande thank you for explaining that race condition so thoroughly! It was really helpful to have the CI logs with the failure to reference.\r\n\r\nBased on these two comments I'm convinced I was introducing instability with the debugger, especially as I added additional breakpoints. Anyways I got confused about something and ended up running the tests 10 times (without the debugger) and never saw any failures. \r\n\r\nACK 88e7807e771a568ac34c320b4055d832990049df",
      "created_at" : "2022-09-03T01:26:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25978#issuecomment-1236019372",
      "id" : 1236019372,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25978",
      "node_id" : "IC_kwDOABII585JrCis",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1236019372/reactions"
      },
      "updated_at" : "2022-09-03T01:26:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1236019372",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1823216?v=4",
         "events_url" : "https://api.github.com/users/satsie/events{/privacy}",
         "followers_url" : "https://api.github.com/users/satsie/followers",
         "following_url" : "https://api.github.com/users/satsie/following{/other_user}",
         "gists_url" : "https://api.github.com/users/satsie/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/satsie",
         "id" : 1823216,
         "login" : "satsie",
         "node_id" : "MDQ6VXNlcjE4MjMyMTY=",
         "organizations_url" : "https://api.github.com/users/satsie/orgs",
         "received_events_url" : "https://api.github.com/users/satsie/received_events",
         "repos_url" : "https://api.github.com/users/satsie/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/satsie/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/satsie/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/satsie"
      }
   }
]
