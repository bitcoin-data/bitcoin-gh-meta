[
   {
      "author_association" : "OWNER",
      "body" : "For context: I had a node go into an infinite loop, when a bit flip in a transaction in the block file caused the merkle root check to fail. It kept printing the same message, pegging the CPU at 100% but without advancing:\r\n```\r\n2018-02-27 07:47:02 ERROR: ConnectBlock: Consensus::CheckBlock: bad-txnmrklroot,\r\n hashMerkleRoot mismatch (code 16)\r\n2018-02-27 07:47:02 ERROR: ConnectTip(): ConnectBlock 0000000000000000003cd56ca3\r\ncf3dbc186ff3a6713f6972a11089b6ae4bf625 failed\r\n```\r\nIt might be due to software or hardware reasons (in my case, I found out in retrospect that the CPU was seriously overheating). In this kind of case it is better to give up and have the user manually check the issue, than try to continue.\r\n\r\n>  I think we might as well get rid of this call and assume that the corruption will eventually be detected later.\r\n\r\nI'm not sure removing the check is the best way forward. I'm happy that the corruption was detected as early as possible so I could take action and fix the CPU cooler. However, it could stop trying after one time, then give up. Or am I misunderstanding what this does?",
      "created_at" : "2018-03-01T07:13:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12561#issuecomment-369498460",
      "id" : 369498460,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12561",
      "updated_at" : "2018-03-01T07:13:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/369498460",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I'm not sure removing the check is the best way forward. I'm happy that the corruption was detected as early as possible so I could take action and fix the CPU cooler. However, it could stop trying after one time, then give up. Or am I misunderstanding what this does?\r\n\r\nYeah it's not clear to me what is best.  With my current proposal here, we skip the CheckBlock check altogether and go straight on to transaction validation.  If some transaction was mutated (say due to disk corruption), it's likely that some validation would fail, and the node would fall out of sync, which would be an indicator to the operator that something is wrong.\r\n\r\nFor situations where the disk corruption could have been detected, I think it's better to more explicitly let the user know, rather than have to infer it from a random-looking validation failure.  However, in general we aren't able to detect all the forms of disk corruption that can happen (eg, typically we never know if the block was written correctly because we use an in-memory copy for validation).  So I wasn't sure it was worth trying to maintain some special-case logic to detect something that in general is unknowable.\r\n\r\nBut if you think catching this kind of thing some of the time is still better than nothing then I could just add back the CheckBlock() call and an assert that any failures cannot be due to potential corruption; I think that's also a reasonable way to improve this behavior.",
      "created_at" : "2018-03-05T02:16:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12561#issuecomment-370291093",
      "id" : 370291093,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12561",
      "updated_at" : "2018-03-05T02:16:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/370291093",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@laanwj I changed this to just shut down if we encounter a corrupt block in ConnectBlock().",
      "created_at" : "2018-03-05T15:48:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12561#issuecomment-370462825",
      "id" : 370462825,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12561",
      "updated_at" : "2018-03-05T15:48:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/370462825",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "utACK https://github.com/bitcoin/bitcoin/pull/12561/commits/0e7c52dc6cbb8fd881a0dd57a6167a812fe71dc4 looks good to me now\r\n(will try to test this once I get home, as I still have the corrupted file)",
      "created_at" : "2018-03-05T17:45:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12561#issuecomment-370502480",
      "id" : 370502480,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12561",
      "updated_at" : "2018-03-05T17:46:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/370502480",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Updated OP to reflect what this PR is doing, since those get included in our merge commits.  Original OP for posterity:\r\n\r\n> The call to CheckBlock() in ConnectBlock() was largely redundant -- the case it tried to protect against was one where we have somehow previously stored an invalid block (eg with different software, presumably).  However, there are other ways that we could get invalid blocks stored on disk, such as if a block was previously accepted (again by different software) that violates rules enforced in ContextualCheckBlock() or ContextualCheckBlockHeader().\r\n>\r\n> Because CheckBlock() can return failure due to potential malleability, this call could result in an infinite failure loop, in the event that we have disk corruption and the stored block that we're now trying to connect doesn't match.  Since we're already not catching all forms of corruption between AcceptBlock() and ConnectBlock() (for instance, corruption in a transaction witness), I think we might as well get rid of this call and assume that the corruption will eventually be detected later.\r\n>\r\n> Note: in the case of a planned soft-fork upgrade, we already need to solve the problem of how to ensure that we don't have invalid blocks stored on disk that might sneak through validation, but that problem is more general than what this invocation of CheckBlock() covers.  I've updated a long comment explaining this issue.",
      "created_at" : "2018-03-07T14:10:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12561#issuecomment-371149663",
      "id" : 371149663,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12561",
      "updated_at" : "2018-03-07T14:10:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/371149663",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/12561#discussion_r173641395"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12561"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173641395"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You should log the block hash as well, as that is useful information for anyone who wants to try to dig deeper (and is the first thing any developer would want to know). It looks like `AbortNode()` directs the user to check `debug.log`, so you can add a `LogPrintf()` statement before returning the error.",
      "commit_id" : "0e7c52dc6cbb8fd881a0dd57a6167a812fe71dc4",
      "created_at" : "2018-03-11T02:37:39Z",
      "diff_hunk" : "@@ -1791,8 +1791,15 @@ bool CChainState::ConnectBlock(const CBlock& block, CValidationState& state, CBl\n     // is enforced in ContextualCheckBlockHeader(); we wouldn't want to\n     // re-enforce that rule here (at least until we make it impossible for\n     // GetAdjustedTime() to go backward).\n-    if (!CheckBlock(block, state, chainparams.GetConsensus(), !fJustCheck, !fJustCheck))\n+    if (!CheckBlock(block, state, chainparams.GetConsensus(), !fJustCheck, !fJustCheck)) {\n+        if (state.CorruptionPossible()) {\n+            // We don't write down blocks to disk if they may have been\n+            // corrupted, so this should be impossible unless we're having hardware\n+            // problems.\n+            return AbortNode(state, \"Corrupt block found indicating potential hardware failure; shutting down\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12561#discussion_r173641395",
      "id" : 173641395,
      "original_commit_id" : "0e7c52dc6cbb8fd881a0dd57a6167a812fe71dc4",
      "original_position" : 10,
      "path" : "src/validation.cpp",
      "position" : 10,
      "pull_request_review_id" : 102869283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/12561",
      "updated_at" : "2018-03-11T02:37:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/173641395",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/2734?v=4",
         "events_url" : "https://api.github.com/users/eklitzke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/eklitzke/followers",
         "following_url" : "https://api.github.com/users/eklitzke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/eklitzke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/eklitzke",
         "id" : 2734,
         "login" : "eklitzke",
         "organizations_url" : "https://api.github.com/users/eklitzke/orgs",
         "received_events_url" : "https://api.github.com/users/eklitzke/received_events",
         "repos_url" : "https://api.github.com/users/eklitzke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/eklitzke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/eklitzke"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "Going to merge this; it's an improvement to error handing either way. Additional information can be added in future PRs.",
      "created_at" : "2018-04-08T09:07:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12561#issuecomment-379534009",
      "id" : 379534009,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12561",
      "updated_at" : "2018-04-08T09:07:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/379534009",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Marking \"up for grabs\" to add the logprint",
      "created_at" : "2018-04-08T15:51:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/12561#issuecomment-379560471",
      "id" : 379560471,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12561",
      "updated_at" : "2018-04-08T15:51:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/379560471",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
