[
   {
      "body" : "@sipa  I did end up reworking the tracking of in-mempool parents/children to use iterators rather than hashes as you had suggested (which I never pushed up to #6557).",
      "created_at" : "2015-09-09T01:31:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#issuecomment-138748338",
      "id" : 138748338,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6654",
      "updated_at" : "2015-09-09T01:31:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/138748338",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "@laanwj looks like travis crapped out on one of the jobs and needs restarting.",
      "created_at" : "2015-09-09T03:11:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#issuecomment-138764516",
      "id" : 138764516,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6654",
      "updated_at" : "2015-09-09T03:11:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/138764516",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7275704?v=3",
         "events_url" : "https://api.github.com/users/btcdrak/events{/privacy}",
         "followers_url" : "https://api.github.com/users/btcdrak/followers",
         "following_url" : "https://api.github.com/users/btcdrak/following{/other_user}",
         "gists_url" : "https://api.github.com/users/btcdrak/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/btcdrak",
         "id" : 7275704,
         "login" : "btcdrak",
         "organizations_url" : "https://api.github.com/users/btcdrak/orgs",
         "received_events_url" : "https://api.github.com/users/btcdrak/received_events",
         "repos_url" : "https://api.github.com/users/btcdrak/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/btcdrak/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/btcdrak/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/btcdrak"
      }
   },
   {
      "body" : "@btcdrak Actually I think this is some kind of problem with the unit test code -- not sure why it fails to compile only in that one job but I was just able to reproduce locally. Working on a fix...",
      "created_at" : "2015-09-09T12:35:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#issuecomment-138895713",
      "id" : 138895713,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6654",
      "updated_at" : "2015-09-09T12:35:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/138895713",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "@btcdrak Fixed and pushed back up, travis is happy now...",
      "created_at" : "2015-09-09T13:09:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#issuecomment-138904329",
      "id" : 138904329,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6654",
      "updated_at" : "2015-09-09T13:09:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/138904329",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39434359"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39434359"
         }
      },
      "body" : "Will move this to not be an internal code (so we send a reject message back).",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-14T19:13:25Z",
      "diff_hunk" : "@@ -466,5 +474,7 @@ static const unsigned int REJECT_HIGHFEE = 0x100;\n static const unsigned int REJECT_ALREADY_KNOWN = 0x101;\n /** Transaction conflicts with a transaction already known */\n static const unsigned int REJECT_CONFLICT = 0x102;\n+/** Transaction would result in too long in-mempool chain */\n+static const unsigned int REJECT_LONGCHAIN = 0x103;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39434359",
      "id" : 39434359,
      "original_commit_id" : "d6401c1547cbc39e55e71328e809e54a8bef4442",
      "original_position" : 20,
      "path" : "src/main.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39434359",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39436182"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39436182"
         }
      },
      "body" : "As the idea is the ancestor size is set such that the whole string of transactions could be included in a single block, we really want this to be a less than the max block size, as there's always overhead to consider. (e.g. the coinbase, soft-limit, etc)\r\n\r\nI'd suggest we set this to 900KB for a 100KB buffer - plenty even in the case of p2pool's large max 50KB coinbase. Another option might be to set it based on the soft-limit - default 750KB - with another 100KB of overhad buffer.",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-14T19:29:24Z",
      "diff_hunk" : "@@ -921,6 +921,17 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n                 REJECT_HIGHFEE, \"absurdly-high-fee\",\n                 strprintf(\"%d > %d\", nFees, ::minRelayTxFee.GetFee(nSize) * 10000));\n \n+        // Calculate in-mempool ancestors, up to a limit.\n+        CTxMemPool::setEntries setAncestors;\n+        size_t nLimitAncestors = GetArg(\"-limitancestorcount\", DEFAULT_ANCESTOR_LIMIT);\n+        size_t nLimitAncestorSize = GetArg(\"-limitancestorsize\", DEFAULT_ANCESTOR_SIZE_LIMIT)*1000;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39436182",
      "id" : 39436182,
      "original_commit_id" : "d6401c1547cbc39e55e71328e809e54a8bef4442",
      "original_position" : 7,
      "path" : "src/main.cpp",
      "position" : 7,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39436182",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "In general, it'd be good to think about separating the reorg case entirely from the main mempool codebase. For instance, keep a simple linear list of reorged transactions, and after a reorg attempt to add them back the mempool one-by-one. This separate code could also handle cases where we might want to remine transactions that we otherwise wouldn't, as a \"goodwill\" gesture to reduce the impact of large reorgs.",
      "created_at" : "2015-09-14T19:42:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#issuecomment-140186250",
      "id" : 140186250,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6654",
      "updated_at" : "2015-09-14T19:42:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/140186250",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39437909"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39437909"
         }
      },
      "body" : "trailing whitespace",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-14T19:45:54Z",
      "diff_hunk" : "@@ -48,6 +53,246 @@ CTxMemPoolEntry::GetPriority(unsigned int currentHeight) const\n     return dResult;\n }\n \n+// Update the given tx for any in-mempool descendants.\n+// Assumes that setMemPoolChildren is correct for the given tx and all\n+// descendants.\n+bool CTxMemPool::UpdateForDescendants(txiter updateIt, int maxDescendantsToVisit, cacheMap &cachedDescendants, const std::set<uint256> &setExclude)\n+{\n+    // Track the number of entries (outside setExclude) that we'd need to visit\n+    // (will bail out if it exceeds maxDescendantsToVisit)\n+    int nChildrenToVisit = 0; ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39437909",
      "id" : 39437909,
      "original_commit_id" : "d6401c1547cbc39e55e71328e809e54a8bef4442",
      "original_position" : 32,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39437909",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "Needs a comment defining ancestor/descendant. ",
      "created_at" : "2015-09-14T19:54:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#issuecomment-140188867",
      "id" : 140188867,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6654",
      "updated_at" : "2015-09-14T19:54:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/140188867",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/620611?v=3",
         "events_url" : "https://api.github.com/users/pstratem/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pstratem/followers",
         "following_url" : "https://api.github.com/users/pstratem/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pstratem/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pstratem",
         "id" : 620611,
         "login" : "pstratem",
         "organizations_url" : "https://api.github.com/users/pstratem/orgs",
         "received_events_url" : "https://api.github.com/users/pstratem/received_events",
         "repos_url" : "https://api.github.com/users/pstratem/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pstratem/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pstratem"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39438792"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39438792"
         }
      },
      "body" : "trailing whitespace",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-14T19:54:28Z",
      "diff_hunk" : "@@ -48,6 +53,246 @@ CTxMemPoolEntry::GetPriority(unsigned int currentHeight) const\n     return dResult;\n }\n \n+// Update the given tx for any in-mempool descendants.\n+// Assumes that setMemPoolChildren is correct for the given tx and all\n+// descendants.\n+bool CTxMemPool::UpdateForDescendants(txiter updateIt, int maxDescendantsToVisit, cacheMap &cachedDescendants, const std::set<uint256> &setExclude)\n+{\n+    // Track the number of entries (outside setExclude) that we'd need to visit\n+    // (will bail out if it exceeds maxDescendantsToVisit)\n+    int nChildrenToVisit = 0; \n+\n+    setEntries stageEntries, setAllDescendants;\n+    stageEntries = GetMemPoolChildren(updateIt);\n+\n+    while (!stageEntries.empty()) {\n+        setAllDescendants.insert(stageEntries.begin(), stageEntries.end());\n+\n+        setEntries entriesToAdd;\n+        BOOST_FOREACH(const txiter cit, stageEntries) {\n+            if (cit->IsDirty()) {\n+                // Don't consider any more children if any descendant is dirty\n+                return false;\n+            }\n+            const setEntries &setChildren = GetMemPoolChildren(cit);\n+            BOOST_FOREACH(const txiter childEntry, setChildren) {\n+                cacheMap::iterator cacheIt = cachedDescendants.find(childEntry);\n+                if (cacheIt != cachedDescendants.end()) {\n+                    // We've already calculated this one, just add the entries for this set\n+                    // but don't traverse again.\n+                    BOOST_FOREACH(const txiter cacheEntry, cacheIt->second) {\n+                        // update visit count only for new child transactions\n+                        // (outside of setExclude and entriesToAdd)\n+                        if (setAllDescendants.insert(cacheEntry).second &&\n+                                !setExclude.count(cacheEntry->GetTx().GetHash()) &&\n+                                !entriesToAdd.count(cacheEntry)) {\n+                            nChildrenToVisit++;\n+                        }\n+                    }\n+                } else if (!setAllDescendants.count(childEntry)) {\n+                    // Try adding to entriesToAdd, and update our visit count\n+                    if (entriesToAdd.insert(childEntry).second && !setExclude.count(childEntry->GetTx().GetHash())) {\n+                        nChildrenToVisit++;\n+                    }\n+                }\n+                if (nChildrenToVisit > maxDescendantsToVisit) {\n+                    return false;\n+                }\n+            }\n+        }\n+        stageEntries = entriesToAdd;\n+    }\n+    // setAllDescendants now contains all in-mempool descendants of updateIt.\n+    // Update and add to cached descendant map\n+    int64_t modifySize = 0;\n+    CAmount modifyFee = 0;\n+    int64_t modifyCount = 0;\n+    BOOST_FOREACH(txiter cit, setAllDescendants) {\n+        if (!setExclude.count(cit->GetTx().GetHash())) {\n+            modifySize += cit->GetTxSize();\n+            modifyFee += cit->GetFee();\n+            modifyCount++;\n+            cachedDescendants[updateIt].insert(cit);\n+        }\n+    }\n+    mapTx.modify(updateIt, update_descendant_state(modifySize, modifyFee, modifyCount));\n+    return true;\n+}\n+\n+// vHashesToUpdate is the set of transaction hashes from a disconnected block\n+// which has been re-added to the mempool.\n+// for each entry, look for descendants that are outside hashesToUpdate, and\n+// add fee/size information for such descendants to the parent.\n+void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashesToUpdate)\n+{\n+    // For each entry in vHashesToUpdate, store the set of in-mempool, but not\n+    // in-vHashesToUpdate transactions, so that we don't have to recalculate\n+    // descendants when we come across a previously seen entry.\n+    cacheMap mapMemPoolDescendantsToUpdate;\n+\n+    // Use a set for lookups into vHashesToUpdate (these entries are already\n+    // accounted for in the state of their ancestors)\n+    std::set<uint256> setAlreadyIncluded(vHashesToUpdate.begin(), vHashesToUpdate.end());\n+\n+    // Iterate in reverse, so that whenever we are looking at at a transaction\n+    // we are sure that all in-mempool descendants have already been processed.\n+    // This maximizes the benefit of the descendant cache and guarantees that\n+    // setMemPoolChildren will be updated, an assumption made in\n+    // UpdateForDescendants.\n+    BOOST_REVERSE_FOREACH(const uint256 &hash, vHashesToUpdate) {\n+        // we cache the in-mempool children to avoid duplicate updates\n+        setEntries setChildren;\n+        // calculate children from mapNextTx\n+        txiter it = mapTx.find(hash);\n+        if (it == mapTx.end()) {\n+            continue;\n+        }\n+        std::map<COutPoint, CInPoint>::iterator iter = mapNextTx.lower_bound(COutPoint(hash, 0));\n+        // First calculate the children, and update setMemPoolChildren to\n+        // include them, and update their setMemPoolParents to include this tx.\n+        for (; iter != mapNextTx.end() && iter->first.hash == hash; ++iter) {\n+            const uint256 &childHash = iter->second.ptx->GetHash();\n+            txiter childIter = mapTx.find(childHash);\n+            // We can skip updating entries we've encountered before or that\n+            // are in the block (which are already accounted for).\n+            if (setChildren.insert(childIter).second && !setAlreadyIncluded.count(childHash)) {\n+                UpdateChild(it, childIter, true);\n+                UpdateParent(childIter, it, true);\n+            }\n+        }\n+        if (!UpdateForDescendants(it, 100, mapMemPoolDescendantsToUpdate, setAlreadyIncluded)) {\n+            // Mark as dirty if we can't do the calculation.\n+            mapTx.modify(it, set_dirty());\n+        }\n+    }\n+}\n+\n+bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString)\n+{\n+    setEntries parentHashes;\n+    const CTransaction &tx = entry.GetTx();\n+\n+    // Get parents of this transaction that are in the mempool\n+    // entry may or may not already be in the mempool, so we iterate mapTx\n+    // to find parents, rather than try GetMemPoolParents(entry)\n+    // TODO: optimize this so that we only check limits and walk\n+    // tx.vin when called on entries not already in the mempool.\n+    for (unsigned int i = 0; i < tx.vin.size(); i++) {\n+        txiter piter = mapTx.find(tx.vin[i].prevout.hash);\n+        if (piter != mapTx.end()) {\n+            parentHashes.insert(piter);\n+            if (parentHashes.size() + 1 > limitAncestorCount) {\n+                errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                return false;\n+            }\n+        }\n+    }\n+\n+    size_t totalSizeWithAncestors = entry.GetTxSize();\n+\n+    while (!parentHashes.empty()) {\n+        setAncestors.insert(parentHashes.begin(), parentHashes.end());\n+        setEntries stageParentSet; ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39438792",
      "id" : 39438792,
      "original_commit_id" : "d6401c1547cbc39e55e71328e809e54a8bef4442",
      "original_position" : 164,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39438792",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39438992"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39438992"
         }
      },
      "body" : "trailing whitespace",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-14T19:56:25Z",
      "diff_hunk" : "@@ -48,6 +53,246 @@ CTxMemPoolEntry::GetPriority(unsigned int currentHeight) const\n     return dResult;\n }\n \n+// Update the given tx for any in-mempool descendants.\n+// Assumes that setMemPoolChildren is correct for the given tx and all\n+// descendants.\n+bool CTxMemPool::UpdateForDescendants(txiter updateIt, int maxDescendantsToVisit, cacheMap &cachedDescendants, const std::set<uint256> &setExclude)\n+{\n+    // Track the number of entries (outside setExclude) that we'd need to visit\n+    // (will bail out if it exceeds maxDescendantsToVisit)\n+    int nChildrenToVisit = 0; \n+\n+    setEntries stageEntries, setAllDescendants;\n+    stageEntries = GetMemPoolChildren(updateIt);\n+\n+    while (!stageEntries.empty()) {\n+        setAllDescendants.insert(stageEntries.begin(), stageEntries.end());\n+\n+        setEntries entriesToAdd;\n+        BOOST_FOREACH(const txiter cit, stageEntries) {\n+            if (cit->IsDirty()) {\n+                // Don't consider any more children if any descendant is dirty\n+                return false;\n+            }\n+            const setEntries &setChildren = GetMemPoolChildren(cit);\n+            BOOST_FOREACH(const txiter childEntry, setChildren) {\n+                cacheMap::iterator cacheIt = cachedDescendants.find(childEntry);\n+                if (cacheIt != cachedDescendants.end()) {\n+                    // We've already calculated this one, just add the entries for this set\n+                    // but don't traverse again.\n+                    BOOST_FOREACH(const txiter cacheEntry, cacheIt->second) {\n+                        // update visit count only for new child transactions\n+                        // (outside of setExclude and entriesToAdd)\n+                        if (setAllDescendants.insert(cacheEntry).second &&\n+                                !setExclude.count(cacheEntry->GetTx().GetHash()) &&\n+                                !entriesToAdd.count(cacheEntry)) {\n+                            nChildrenToVisit++;\n+                        }\n+                    }\n+                } else if (!setAllDescendants.count(childEntry)) {\n+                    // Try adding to entriesToAdd, and update our visit count\n+                    if (entriesToAdd.insert(childEntry).second && !setExclude.count(childEntry->GetTx().GetHash())) {\n+                        nChildrenToVisit++;\n+                    }\n+                }\n+                if (nChildrenToVisit > maxDescendantsToVisit) {\n+                    return false;\n+                }\n+            }\n+        }\n+        stageEntries = entriesToAdd;\n+    }\n+    // setAllDescendants now contains all in-mempool descendants of updateIt.\n+    // Update and add to cached descendant map\n+    int64_t modifySize = 0;\n+    CAmount modifyFee = 0;\n+    int64_t modifyCount = 0;\n+    BOOST_FOREACH(txiter cit, setAllDescendants) {\n+        if (!setExclude.count(cit->GetTx().GetHash())) {\n+            modifySize += cit->GetTxSize();\n+            modifyFee += cit->GetFee();\n+            modifyCount++;\n+            cachedDescendants[updateIt].insert(cit);\n+        }\n+    }\n+    mapTx.modify(updateIt, update_descendant_state(modifySize, modifyFee, modifyCount));\n+    return true;\n+}\n+\n+// vHashesToUpdate is the set of transaction hashes from a disconnected block\n+// which has been re-added to the mempool.\n+// for each entry, look for descendants that are outside hashesToUpdate, and\n+// add fee/size information for such descendants to the parent.\n+void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashesToUpdate)\n+{\n+    // For each entry in vHashesToUpdate, store the set of in-mempool, but not\n+    // in-vHashesToUpdate transactions, so that we don't have to recalculate\n+    // descendants when we come across a previously seen entry.\n+    cacheMap mapMemPoolDescendantsToUpdate;\n+\n+    // Use a set for lookups into vHashesToUpdate (these entries are already\n+    // accounted for in the state of their ancestors)\n+    std::set<uint256> setAlreadyIncluded(vHashesToUpdate.begin(), vHashesToUpdate.end());\n+\n+    // Iterate in reverse, so that whenever we are looking at at a transaction\n+    // we are sure that all in-mempool descendants have already been processed.\n+    // This maximizes the benefit of the descendant cache and guarantees that\n+    // setMemPoolChildren will be updated, an assumption made in\n+    // UpdateForDescendants.\n+    BOOST_REVERSE_FOREACH(const uint256 &hash, vHashesToUpdate) {\n+        // we cache the in-mempool children to avoid duplicate updates\n+        setEntries setChildren;\n+        // calculate children from mapNextTx\n+        txiter it = mapTx.find(hash);\n+        if (it == mapTx.end()) {\n+            continue;\n+        }\n+        std::map<COutPoint, CInPoint>::iterator iter = mapNextTx.lower_bound(COutPoint(hash, 0));\n+        // First calculate the children, and update setMemPoolChildren to\n+        // include them, and update their setMemPoolParents to include this tx.\n+        for (; iter != mapNextTx.end() && iter->first.hash == hash; ++iter) {\n+            const uint256 &childHash = iter->second.ptx->GetHash();\n+            txiter childIter = mapTx.find(childHash);\n+            // We can skip updating entries we've encountered before or that\n+            // are in the block (which are already accounted for).\n+            if (setChildren.insert(childIter).second && !setAlreadyIncluded.count(childHash)) {\n+                UpdateChild(it, childIter, true);\n+                UpdateParent(childIter, it, true);\n+            }\n+        }\n+        if (!UpdateForDescendants(it, 100, mapMemPoolDescendantsToUpdate, setAlreadyIncluded)) {\n+            // Mark as dirty if we can't do the calculation.\n+            mapTx.modify(it, set_dirty());\n+        }\n+    }\n+}\n+\n+bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString)\n+{\n+    setEntries parentHashes;\n+    const CTransaction &tx = entry.GetTx();\n+\n+    // Get parents of this transaction that are in the mempool\n+    // entry may or may not already be in the mempool, so we iterate mapTx\n+    // to find parents, rather than try GetMemPoolParents(entry)\n+    // TODO: optimize this so that we only check limits and walk\n+    // tx.vin when called on entries not already in the mempool.\n+    for (unsigned int i = 0; i < tx.vin.size(); i++) {\n+        txiter piter = mapTx.find(tx.vin[i].prevout.hash);\n+        if (piter != mapTx.end()) {\n+            parentHashes.insert(piter);\n+            if (parentHashes.size() + 1 > limitAncestorCount) {\n+                errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                return false;\n+            }\n+        }\n+    }\n+\n+    size_t totalSizeWithAncestors = entry.GetTxSize();\n+\n+    while (!parentHashes.empty()) {\n+        setAncestors.insert(parentHashes.begin(), parentHashes.end());\n+        setEntries stageParentSet; \n+        BOOST_FOREACH(const txiter &stageit, parentHashes) {\n+            assert(stageit != mapTx.end());\n+\n+            totalSizeWithAncestors += stageit->GetTxSize();\n+            if (stageit->GetSizeWithDescendants() + entry.GetTxSize() > limitDescendantSize) {\n+                errString = strprintf(\"exceeds descendant size limit for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString().substr(0,10), limitDescendantSize);\n+                return false;\n+            } else if (uint64_t(stageit->GetCountWithDescendants() + 1) > limitDescendantCount) {\n+                errString = strprintf(\"too many descendants for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString().substr(0,10), limitDescendantCount);\n+                return false;\n+            } else if (totalSizeWithAncestors > limitAncestorSize) {\n+                errString = strprintf(\"exceeds ancestor size limit [limit: %u]\", limitAncestorSize);\n+                return false;\n+            }\n+\n+            const setEntries & setMemPoolParents = GetMemPoolParents(stageit);\n+            BOOST_FOREACH(const txiter &phash, setMemPoolParents) {\n+                // If this is a new ancestor, add it.\n+                if (setAncestors.count(phash) == 0) {\n+                    stageParentSet.insert(phash);\n+                }\n+                if (stageParentSet.size() + setAncestors.size() + 1 > limitAncestorCount) {\n+                    errString = strprintf(\"too many unconfirmed ancestors [limit: %u]\", limitAncestorCount);\n+                    return false;\n+                }\n+            }    ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39438992",
      "id" : 39438992,
      "original_commit_id" : "d6401c1547cbc39e55e71328e809e54a8bef4442",
      "original_position" : 190,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39438992",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39440454"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39440454"
         }
      },
      "body" : "trailing whitespace",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-14T20:10:06Z",
      "diff_hunk" : "@@ -89,34 +334,106 @@ void CTxMemPool::AddTransactionsUpdated(unsigned int n)\n     nTransactionsUpdated += n;\n }\n \n-\n-bool CTxMemPool::addUnchecked(const uint256& hash, const CTxMemPoolEntry &entry, bool fCurrentEstimate)\n+bool CTxMemPool::addUnchecked(const uint256& hash, const CTxMemPoolEntry &entry, setEntries &setAncestors, bool fCurrentEstimate)\n {\n     // Add to memory pool without checking anything.\n     // Used by main.cpp AcceptToMemoryPool(), which DOES do\n     // all the appropriate checks.\n     LOCK(cs);\n-    mapTx[hash] = entry;\n-    const CTransaction& tx = mapTx[hash].GetTx();\n-    for (unsigned int i = 0; i < tx.vin.size(); i++)\n+    indexed_transaction_set::iterator newit = mapTx.insert(entry).first;\n+    mapLinks.insert(make_pair(newit, TxLinks()));\n+\n+    // Update cachedInnerUsage to include contained transaction's usage.\n+    // (When we update the entry for in-mempool parents, memory usage will be\n+    // further updated.)\n+    cachedInnerUsage += entry.DynamicMemoryUsage();\n+\n+    const CTransaction& tx = newit->GetTx();\n+    std::set<uint256> setParentTransactions;\n+    for (unsigned int i = 0; i < tx.vin.size(); i++) {\n         mapNextTx[tx.vin[i].prevout] = CInPoint(&tx, i);\n+        setParentTransactions.insert(tx.vin[i].prevout.hash);\n+    }\n+    // Don't bother worrying about child transactions of this one.\n+    // Normal case of a new transaction arriving is that there can't be any\n+    // children, because such children would be orphans.\n+    // An exception to that is if a transaction enters that used to be in a block.\n+    // In that case, our disconnect block logic will call UpdateTransactionsFromBlock\n+    // to clean up the mess we're leaving here.\n+\n+    // Update ancestors with information about this tx\n+    BOOST_FOREACH (const uint256 &phash, setParentTransactions) {\n+        txiter pit = mapTx.find(phash);\n+        if (pit != mapTx.end()) {\n+            UpdateParent(newit, pit, true);\n+        }\n+    }\n+    UpdateAncestorsOf(true, hash, setAncestors);\n+\n     nTransactionsUpdated++;\n     totalTxSize += entry.GetTxSize();\n-    cachedInnerUsage += entry.DynamicMemoryUsage();\n     minerPolicyEstimator->processTransaction(entry, fCurrentEstimate);\n \n     return true;\n }\n \n+// TODO: replace this hash with an iterator?\n+void CTxMemPool::removeUnchecked(const uint256& hash)\n+{\n+    indexed_transaction_set::iterator it = mapTx.find(hash);\n+\n+    BOOST_FOREACH(const CTxIn& txin, it->GetTx().vin)\n+        mapNextTx.erase(txin.prevout);\n+\n+    totalTxSize -= it->GetTxSize();\n+    cachedInnerUsage -= it->DynamicMemoryUsage();\n+    cachedInnerUsage -= memusage::DynamicUsage(mapLinks[it].parents) + memusage::DynamicUsage(mapLinks[it].children);\n+    mapLinks.erase(it);\n+    mapTx.erase(it);\n+    nTransactionsUpdated++;\n+    minerPolicyEstimator->removeTx(hash);\n+}\n+\n+// Calculates descendants of hash that are not already in setDescendants, and adds to ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39440454",
      "id" : 39440454,
      "original_commit_id" : "d6401c1547cbc39e55e71328e809e54a8bef4442",
      "original_position" : 338,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39440454",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39441365"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39441365"
         }
      },
      "body" : "trailing whitespace",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-14T20:18:35Z",
      "diff_hunk" : "@@ -247,19 +554,23 @@ void CTxMemPool::check(const CCoinsViewCache *pcoins) const\n \n     LOCK(cs);\n     list<const CTxMemPoolEntry*> waitingOnDependants;\n-    for (std::map<uint256, CTxMemPoolEntry>::const_iterator it = mapTx.begin(); it != mapTx.end(); it++) {\n+    for (indexed_transaction_set::const_iterator it = mapTx.begin(); it != mapTx.end(); it++) {\n         unsigned int i = 0;\n-        checkTotal += it->second.GetTxSize();\n-        innerUsage += it->second.DynamicMemoryUsage();\n-        const CTransaction& tx = it->second.GetTx();\n+        checkTotal += it->GetTxSize();\n+        innerUsage += it->DynamicMemoryUsage(); ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39441365",
      "id" : 39441365,
      "original_commit_id" : "d6401c1547cbc39e55e71328e809e54a8bef4442",
      "original_position" : 476,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39441365",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39443752"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39443752"
         }
      },
      "body" : "Need to document what RemoveStaged() is.",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-14T20:39:14Z",
      "diff_hunk" : "@@ -138,6 +363,29 @@ class CTxMemPool\n     void ApplyDeltas(const uint256 hash, double &dPriorityDelta, CAmount &nFeeDelta);\n     void ClearPrioritisation(const uint256 hash);\n \n+public:\n+    void RemoveStaged(std::set<uint256>& stage);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39443752",
      "id" : 39443752,
      "original_commit_id" : "d6401c1547cbc39e55e71328e809e54a8bef4442",
      "original_position" : 304,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39443752",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39443903"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39443903"
         }
      },
      "body" : "Would prefer if comments like this are written as \"Name()\" rather than just \"Name\" to make it clear what's a variable and what's a function.",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-14T20:40:29Z",
      "diff_hunk" : "@@ -138,6 +363,29 @@ class CTxMemPool\n     void ApplyDeltas(const uint256 hash, double &dPriorityDelta, CAmount &nFeeDelta);\n     void ClearPrioritisation(const uint256 hash);\n \n+public:\n+    void RemoveStaged(std::set<uint256>& stage);\n+\n+    /** When adding transactions from a disconnected block back to the mempool,\n+     *  new mempool entries may have children in the mempool (which is generally\n+     *  not the case when otherwise adding transactions).\n+     *  UpdateTransactionsFromBlock will find child transactions and update the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39443903",
      "id" : 39443903,
      "original_commit_id" : "d6401c1547cbc39e55e71328e809e54a8bef4442",
      "original_position" : 309,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39443903",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39443986"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39443986"
         }
      },
      "body" : "Double-space after periods? Obvs you're actually Satoshi.",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-14T20:41:20Z",
      "diff_hunk" : "@@ -169,6 +417,48 @@ class CTxMemPool\n     bool ReadFeeEstimates(CAutoFile& filein);\n \n     size_t DynamicMemoryUsage() const;\n+\n+private:\n+    /** UpdateForDescendants is used by UpdateTransactionsFromBlock to update\n+     *  the descendants for a single transaction that has been added to the\n+     *  mempool but may have child transactions in the mempool, eg during a\n+     *  chain reorg.  setExclude is the set of descendant transactions in the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39443986",
      "id" : 39443986,
      "original_commit_id" : "d6401c1547cbc39e55e71328e809e54a8bef4442",
      "original_position" : 338,
      "path" : "src/txmempool.h",
      "position" : 342,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39443986",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39444131"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39444131"
         }
      },
      "body" : "This comment doesn't make it clear whether or not transactions in hashesToUpdate are or are not already in the mempool. :)",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-14T20:42:34Z",
      "diff_hunk" : "@@ -138,6 +363,29 @@ class CTxMemPool\n     void ApplyDeltas(const uint256 hash, double &dPriorityDelta, CAmount &nFeeDelta);\n     void ClearPrioritisation(const uint256 hash);\n \n+public:\n+    void RemoveStaged(std::set<uint256>& stage);\n+\n+    /** When adding transactions from a disconnected block back to the mempool,\n+     *  new mempool entries may have children in the mempool (which is generally\n+     *  not the case when otherwise adding transactions).\n+     *  UpdateTransactionsFromBlock will find child transactions and update the\n+     *  descendant state for each transaction in hashesToUpdate (excluding any\n+     *  child transactions present in hashesToUpdate, which are already accounted\n+     *  for).\n+     */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39444131",
      "id" : 39444131,
      "original_commit_id" : "d6401c1547cbc39e55e71328e809e54a8bef4442",
      "original_position" : 313,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39444131",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "Concept ACK.",
      "created_at" : "2015-09-14T20:45:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#issuecomment-140200727",
      "id" : 140200727,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6654",
      "updated_at" : "2015-09-14T20:45:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/140200727",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "utACK, modulo nits.",
      "created_at" : "2015-09-14T20:54:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#issuecomment-140203389",
      "id" : 140203389,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6654",
      "updated_at" : "2015-09-14T20:54:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/140203389",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "Concept ACK / code review ACK.\r\nPasses gitian/osx/debian build/unit-tests/rpc-tests.",
      "created_at" : "2015-09-14T21:00:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#issuecomment-140204729",
      "id" : 140204729,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6654",
      "updated_at" : "2015-09-14T21:00:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/140204729",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=3",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "body" : "Tested with my FSS and Full RBF stress tests and -checkmempool, no unexpected failures. (this pull-req of course doesn't enable any RBF behavior, so replacements failed!)",
      "created_at" : "2015-09-14T21:16:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#issuecomment-140208052",
      "id" : 140208052,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6654",
      "updated_at" : "2015-09-14T21:16:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/140208052",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "concept ACK",
      "created_at" : "2015-09-14T22:00:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#issuecomment-140217087",
      "id" : 140217087,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6654",
      "updated_at" : "2015-09-14T22:00:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/140217087",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39454363"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39454363"
         }
      },
      "body" : "Using `GetArg` (an application level function) in mempool code feels a bit odd.",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-14T22:14:48Z",
      "diff_hunk" : "@@ -921,6 +921,17 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n                 REJECT_HIGHFEE, \"absurdly-high-fee\",\n                 strprintf(\"%d > %d\", nFees, ::minRelayTxFee.GetFee(nSize) * 10000));\n \n+        // Calculate in-mempool ancestors, up to a limit.\n+        CTxMemPool::setEntries setAncestors;\n+        size_t nLimitAncestors = GetArg(\"-limitancestorcount\", DEFAULT_ANCESTOR_LIMIT);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39454363",
      "id" : 39454363,
      "original_commit_id" : "d6401c1547cbc39e55e71328e809e54a8bef4442",
      "original_position" : 6,
      "path" : "src/main.cpp",
      "position" : 6,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39454363",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39455254"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39455254"
         }
      },
      "body" : "Dirty implies something changed typically,  perhaps instead change this to `ShouldSkip`?",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-14T22:25:48Z",
      "diff_hunk" : "@@ -48,6 +53,246 @@ CTxMemPoolEntry::GetPriority(unsigned int currentHeight) const\n     return dResult;\n }\n \n+// Update the given tx for any in-mempool descendants.\n+// Assumes that setMemPoolChildren is correct for the given tx and all\n+// descendants.\n+bool CTxMemPool::UpdateForDescendants(txiter updateIt, int maxDescendantsToVisit, cacheMap &cachedDescendants, const std::set<uint256> &setExclude)\n+{\n+    // Track the number of entries (outside setExclude) that we'd need to visit\n+    // (will bail out if it exceeds maxDescendantsToVisit)\n+    int nChildrenToVisit = 0; \n+\n+    setEntries stageEntries, setAllDescendants;\n+    stageEntries = GetMemPoolChildren(updateIt);\n+\n+    while (!stageEntries.empty()) {\n+        setAllDescendants.insert(stageEntries.begin(), stageEntries.end());\n+\n+        setEntries entriesToAdd;\n+        BOOST_FOREACH(const txiter cit, stageEntries) {\n+            if (cit->IsDirty()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39455254",
      "id" : 39455254,
      "original_commit_id" : "d6401c1547cbc39e55e71328e809e54a8bef4442",
      "original_position" : 42,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39455254",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39455495"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39455495"
         }
      },
      "body" : "Do we need to check `childIter == mapTx.end()`?",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-14T22:28:43Z",
      "diff_hunk" : "@@ -48,6 +53,246 @@ CTxMemPoolEntry::GetPriority(unsigned int currentHeight) const\n     return dResult;\n }\n \n+// Update the given tx for any in-mempool descendants.\n+// Assumes that setMemPoolChildren is correct for the given tx and all\n+// descendants.\n+bool CTxMemPool::UpdateForDescendants(txiter updateIt, int maxDescendantsToVisit, cacheMap &cachedDescendants, const std::set<uint256> &setExclude)\n+{\n+    // Track the number of entries (outside setExclude) that we'd need to visit\n+    // (will bail out if it exceeds maxDescendantsToVisit)\n+    int nChildrenToVisit = 0; \n+\n+    setEntries stageEntries, setAllDescendants;\n+    stageEntries = GetMemPoolChildren(updateIt);\n+\n+    while (!stageEntries.empty()) {\n+        setAllDescendants.insert(stageEntries.begin(), stageEntries.end());\n+\n+        setEntries entriesToAdd;\n+        BOOST_FOREACH(const txiter cit, stageEntries) {\n+            if (cit->IsDirty()) {\n+                // Don't consider any more children if any descendant is dirty\n+                return false;\n+            }\n+            const setEntries &setChildren = GetMemPoolChildren(cit);\n+            BOOST_FOREACH(const txiter childEntry, setChildren) {\n+                cacheMap::iterator cacheIt = cachedDescendants.find(childEntry);\n+                if (cacheIt != cachedDescendants.end()) {\n+                    // We've already calculated this one, just add the entries for this set\n+                    // but don't traverse again.\n+                    BOOST_FOREACH(const txiter cacheEntry, cacheIt->second) {\n+                        // update visit count only for new child transactions\n+                        // (outside of setExclude and entriesToAdd)\n+                        if (setAllDescendants.insert(cacheEntry).second &&\n+                                !setExclude.count(cacheEntry->GetTx().GetHash()) &&\n+                                !entriesToAdd.count(cacheEntry)) {\n+                            nChildrenToVisit++;\n+                        }\n+                    }\n+                } else if (!setAllDescendants.count(childEntry)) {\n+                    // Try adding to entriesToAdd, and update our visit count\n+                    if (entriesToAdd.insert(childEntry).second && !setExclude.count(childEntry->GetTx().GetHash())) {\n+                        nChildrenToVisit++;\n+                    }\n+                }\n+                if (nChildrenToVisit > maxDescendantsToVisit) {\n+                    return false;\n+                }\n+            }\n+        }\n+        stageEntries = entriesToAdd;\n+    }\n+    // setAllDescendants now contains all in-mempool descendants of updateIt.\n+    // Update and add to cached descendant map\n+    int64_t modifySize = 0;\n+    CAmount modifyFee = 0;\n+    int64_t modifyCount = 0;\n+    BOOST_FOREACH(txiter cit, setAllDescendants) {\n+        if (!setExclude.count(cit->GetTx().GetHash())) {\n+            modifySize += cit->GetTxSize();\n+            modifyFee += cit->GetFee();\n+            modifyCount++;\n+            cachedDescendants[updateIt].insert(cit);\n+        }\n+    }\n+    mapTx.modify(updateIt, update_descendant_state(modifySize, modifyFee, modifyCount));\n+    return true;\n+}\n+\n+// vHashesToUpdate is the set of transaction hashes from a disconnected block\n+// which has been re-added to the mempool.\n+// for each entry, look for descendants that are outside hashesToUpdate, and\n+// add fee/size information for such descendants to the parent.\n+void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashesToUpdate)\n+{\n+    // For each entry in vHashesToUpdate, store the set of in-mempool, but not\n+    // in-vHashesToUpdate transactions, so that we don't have to recalculate\n+    // descendants when we come across a previously seen entry.\n+    cacheMap mapMemPoolDescendantsToUpdate;\n+\n+    // Use a set for lookups into vHashesToUpdate (these entries are already\n+    // accounted for in the state of their ancestors)\n+    std::set<uint256> setAlreadyIncluded(vHashesToUpdate.begin(), vHashesToUpdate.end());\n+\n+    // Iterate in reverse, so that whenever we are looking at at a transaction\n+    // we are sure that all in-mempool descendants have already been processed.\n+    // This maximizes the benefit of the descendant cache and guarantees that\n+    // setMemPoolChildren will be updated, an assumption made in\n+    // UpdateForDescendants.\n+    BOOST_REVERSE_FOREACH(const uint256 &hash, vHashesToUpdate) {\n+        // we cache the in-mempool children to avoid duplicate updates\n+        setEntries setChildren;\n+        // calculate children from mapNextTx\n+        txiter it = mapTx.find(hash);\n+        if (it == mapTx.end()) {\n+            continue;\n+        }\n+        std::map<COutPoint, CInPoint>::iterator iter = mapNextTx.lower_bound(COutPoint(hash, 0));\n+        // First calculate the children, and update setMemPoolChildren to\n+        // include them, and update their setMemPoolParents to include this tx.\n+        for (; iter != mapNextTx.end() && iter->first.hash == hash; ++iter) {\n+            const uint256 &childHash = iter->second.ptx->GetHash();\n+            txiter childIter = mapTx.find(childHash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39455495",
      "id" : 39455495,
      "original_commit_id" : "d6401c1547cbc39e55e71328e809e54a8bef4442",
      "original_position" : 124,
      "path" : "src/txmempool.cpp",
      "position" : 125,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39455495",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39455549"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39455549"
         }
      },
      "body" : "`const`?",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-14T22:29:23Z",
      "diff_hunk" : "@@ -48,6 +53,246 @@ CTxMemPoolEntry::GetPriority(unsigned int currentHeight) const\n     return dResult;\n }\n \n+// Update the given tx for any in-mempool descendants.\n+// Assumes that setMemPoolChildren is correct for the given tx and all\n+// descendants.\n+bool CTxMemPool::UpdateForDescendants(txiter updateIt, int maxDescendantsToVisit, cacheMap &cachedDescendants, const std::set<uint256> &setExclude)\n+{\n+    // Track the number of entries (outside setExclude) that we'd need to visit\n+    // (will bail out if it exceeds maxDescendantsToVisit)\n+    int nChildrenToVisit = 0; \n+\n+    setEntries stageEntries, setAllDescendants;\n+    stageEntries = GetMemPoolChildren(updateIt);\n+\n+    while (!stageEntries.empty()) {\n+        setAllDescendants.insert(stageEntries.begin(), stageEntries.end());\n+\n+        setEntries entriesToAdd;\n+        BOOST_FOREACH(const txiter cit, stageEntries) {\n+            if (cit->IsDirty()) {\n+                // Don't consider any more children if any descendant is dirty\n+                return false;\n+            }\n+            const setEntries &setChildren = GetMemPoolChildren(cit);\n+            BOOST_FOREACH(const txiter childEntry, setChildren) {\n+                cacheMap::iterator cacheIt = cachedDescendants.find(childEntry);\n+                if (cacheIt != cachedDescendants.end()) {\n+                    // We've already calculated this one, just add the entries for this set\n+                    // but don't traverse again.\n+                    BOOST_FOREACH(const txiter cacheEntry, cacheIt->second) {\n+                        // update visit count only for new child transactions\n+                        // (outside of setExclude and entriesToAdd)\n+                        if (setAllDescendants.insert(cacheEntry).second &&\n+                                !setExclude.count(cacheEntry->GetTx().GetHash()) &&\n+                                !entriesToAdd.count(cacheEntry)) {\n+                            nChildrenToVisit++;\n+                        }\n+                    }\n+                } else if (!setAllDescendants.count(childEntry)) {\n+                    // Try adding to entriesToAdd, and update our visit count\n+                    if (entriesToAdd.insert(childEntry).second && !setExclude.count(childEntry->GetTx().GetHash())) {\n+                        nChildrenToVisit++;\n+                    }\n+                }\n+                if (nChildrenToVisit > maxDescendantsToVisit) {\n+                    return false;\n+                }\n+            }\n+        }\n+        stageEntries = entriesToAdd;\n+    }\n+    // setAllDescendants now contains all in-mempool descendants of updateIt.\n+    // Update and add to cached descendant map\n+    int64_t modifySize = 0;\n+    CAmount modifyFee = 0;\n+    int64_t modifyCount = 0;\n+    BOOST_FOREACH(txiter cit, setAllDescendants) {\n+        if (!setExclude.count(cit->GetTx().GetHash())) {\n+            modifySize += cit->GetTxSize();\n+            modifyFee += cit->GetFee();\n+            modifyCount++;\n+            cachedDescendants[updateIt].insert(cit);\n+        }\n+    }\n+    mapTx.modify(updateIt, update_descendant_state(modifySize, modifyFee, modifyCount));\n+    return true;\n+}\n+\n+// vHashesToUpdate is the set of transaction hashes from a disconnected block\n+// which has been re-added to the mempool.\n+// for each entry, look for descendants that are outside hashesToUpdate, and\n+// add fee/size information for such descendants to the parent.\n+void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashesToUpdate)\n+{\n+    // For each entry in vHashesToUpdate, store the set of in-mempool, but not\n+    // in-vHashesToUpdate transactions, so that we don't have to recalculate\n+    // descendants when we come across a previously seen entry.\n+    cacheMap mapMemPoolDescendantsToUpdate;\n+\n+    // Use a set for lookups into vHashesToUpdate (these entries are already\n+    // accounted for in the state of their ancestors)\n+    std::set<uint256> setAlreadyIncluded(vHashesToUpdate.begin(), vHashesToUpdate.end());\n+\n+    // Iterate in reverse, so that whenever we are looking at at a transaction\n+    // we are sure that all in-mempool descendants have already been processed.\n+    // This maximizes the benefit of the descendant cache and guarantees that\n+    // setMemPoolChildren will be updated, an assumption made in\n+    // UpdateForDescendants.\n+    BOOST_REVERSE_FOREACH(const uint256 &hash, vHashesToUpdate) {\n+        // we cache the in-mempool children to avoid duplicate updates\n+        setEntries setChildren;\n+        // calculate children from mapNextTx\n+        txiter it = mapTx.find(hash);\n+        if (it == mapTx.end()) {\n+            continue;\n+        }\n+        std::map<COutPoint, CInPoint>::iterator iter = mapNextTx.lower_bound(COutPoint(hash, 0));\n+        // First calculate the children, and update setMemPoolChildren to\n+        // include them, and update their setMemPoolParents to include this tx.\n+        for (; iter != mapNextTx.end() && iter->first.hash == hash; ++iter) {\n+            const uint256 &childHash = iter->second.ptx->GetHash();\n+            txiter childIter = mapTx.find(childHash);\n+            // We can skip updating entries we've encountered before or that\n+            // are in the block (which are already accounted for).\n+            if (setChildren.insert(childIter).second && !setAlreadyIncluded.count(childHash)) {\n+                UpdateChild(it, childIter, true);\n+                UpdateParent(childIter, it, true);\n+            }\n+        }\n+        if (!UpdateForDescendants(it, 100, mapMemPoolDescendantsToUpdate, setAlreadyIncluded)) {\n+            // Mark as dirty if we can't do the calculation.\n+            mapTx.modify(it, set_dirty());\n+        }\n+    }\n+}\n+\n+bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString)\n+{\n+    setEntries parentHashes;\n+    const CTransaction &tx = entry.GetTx();\n+\n+    // Get parents of this transaction that are in the mempool\n+    // entry may or may not already be in the mempool, so we iterate mapTx\n+    // to find parents, rather than try GetMemPoolParents(entry)\n+    // TODO: optimize this so that we only check limits and walk\n+    // tx.vin when called on entries not already in the mempool.\n+    for (unsigned int i = 0; i < tx.vin.size(); i++) {\n+        txiter piter = mapTx.find(tx.vin[i].prevout.hash);\n+        if (piter != mapTx.end()) {\n+            parentHashes.insert(piter);\n+            if (parentHashes.size() + 1 > limitAncestorCount) {\n+                errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                return false;\n+            }\n+        }\n+    }\n+\n+    size_t totalSizeWithAncestors = entry.GetTxSize();\n+\n+    while (!parentHashes.empty()) {\n+        setAncestors.insert(parentHashes.begin(), parentHashes.end());\n+        setEntries stageParentSet; \n+        BOOST_FOREACH(const txiter &stageit, parentHashes) {\n+            assert(stageit != mapTx.end());\n+\n+            totalSizeWithAncestors += stageit->GetTxSize();\n+            if (stageit->GetSizeWithDescendants() + entry.GetTxSize() > limitDescendantSize) {\n+                errString = strprintf(\"exceeds descendant size limit for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString().substr(0,10), limitDescendantSize);\n+                return false;\n+            } else if (uint64_t(stageit->GetCountWithDescendants() + 1) > limitDescendantCount) {\n+                errString = strprintf(\"too many descendants for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString().substr(0,10), limitDescendantCount);\n+                return false;\n+            } else if (totalSizeWithAncestors > limitAncestorSize) {\n+                errString = strprintf(\"exceeds ancestor size limit [limit: %u]\", limitAncestorSize);\n+                return false;\n+            }\n+\n+            const setEntries & setMemPoolParents = GetMemPoolParents(stageit);\n+            BOOST_FOREACH(const txiter &phash, setMemPoolParents) {\n+                // If this is a new ancestor, add it.\n+                if (setAncestors.count(phash) == 0) {\n+                    stageParentSet.insert(phash);\n+                }\n+                if (stageParentSet.size() + setAncestors.size() + 1 > limitAncestorCount) {\n+                    errString = strprintf(\"too many unconfirmed ancestors [limit: %u]\", limitAncestorCount);\n+                    return false;\n+                }\n+            }    \n+        }\n+        parentHashes = stageParentSet;\n+    }\n+\n+    return true;\n+}\n+\n+void CTxMemPool::UpdateAncestorsOf(bool add, const uint256 &hash, setEntries &setAncestors)\n+{\n+    indexed_transaction_set::iterator it = mapTx.find(hash);\n+    setEntries parentIters = GetMemPoolParents(it);\n+    // add or remove this tx as a child of each parent\n+    BOOST_FOREACH(txiter piter, parentIters) {\n+        UpdateChild(piter, it, add);\n+    }\n+    int64_t updateCount = (add ? 1 : -1);\n+    int64_t updateSize = updateCount * it->GetTxSize();\n+    CAmount updateFee = updateCount * it->GetFee();\n+    BOOST_FOREACH(txiter ancestorIt, setAncestors) {\n+        mapTx.modify(ancestorIt, update_descendant_state(updateSize, updateFee, updateCount));\n+    }\n+}\n+\n+// TODO: pass a txiter instead?\n+void CTxMemPool::UpdateChildrenForRemoval(const uint256 &hash)\n+{\n+    txiter it = mapTx.find(hash);\n+    const setEntries &setMemPoolChildren = GetMemPoolChildren(it);\n+    BOOST_FOREACH(txiter updateIt, setMemPoolChildren) {\n+        UpdateParent(updateIt, it, false);\n+    }\n+}\n+\n+void CTxMemPool::UpdateForRemoveFromMempool(const std::set<uint256> &hashesToRemove)\n+{\n+    // For each entry, walk back all ancestors and decrement size associated with this\n+    // transaction\n+    uint64_t nNoLimit = std::numeric_limits<uint64_t>::max();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39455549",
      "id" : 39455549,
      "original_commit_id" : "d6401c1547cbc39e55e71328e809e54a8bef4442",
      "original_position" : 228,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39455549",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39455606"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39455606"
         }
      },
      "body" : "nit: Spacing between operators",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-14T22:29:51Z",
      "diff_hunk" : "@@ -48,6 +53,246 @@ CTxMemPoolEntry::GetPriority(unsigned int currentHeight) const\n     return dResult;\n }\n \n+// Update the given tx for any in-mempool descendants.\n+// Assumes that setMemPoolChildren is correct for the given tx and all\n+// descendants.\n+bool CTxMemPool::UpdateForDescendants(txiter updateIt, int maxDescendantsToVisit, cacheMap &cachedDescendants, const std::set<uint256> &setExclude)\n+{\n+    // Track the number of entries (outside setExclude) that we'd need to visit\n+    // (will bail out if it exceeds maxDescendantsToVisit)\n+    int nChildrenToVisit = 0; \n+\n+    setEntries stageEntries, setAllDescendants;\n+    stageEntries = GetMemPoolChildren(updateIt);\n+\n+    while (!stageEntries.empty()) {\n+        setAllDescendants.insert(stageEntries.begin(), stageEntries.end());\n+\n+        setEntries entriesToAdd;\n+        BOOST_FOREACH(const txiter cit, stageEntries) {\n+            if (cit->IsDirty()) {\n+                // Don't consider any more children if any descendant is dirty\n+                return false;\n+            }\n+            const setEntries &setChildren = GetMemPoolChildren(cit);\n+            BOOST_FOREACH(const txiter childEntry, setChildren) {\n+                cacheMap::iterator cacheIt = cachedDescendants.find(childEntry);\n+                if (cacheIt != cachedDescendants.end()) {\n+                    // We've already calculated this one, just add the entries for this set\n+                    // but don't traverse again.\n+                    BOOST_FOREACH(const txiter cacheEntry, cacheIt->second) {\n+                        // update visit count only for new child transactions\n+                        // (outside of setExclude and entriesToAdd)\n+                        if (setAllDescendants.insert(cacheEntry).second &&\n+                                !setExclude.count(cacheEntry->GetTx().GetHash()) &&\n+                                !entriesToAdd.count(cacheEntry)) {\n+                            nChildrenToVisit++;\n+                        }\n+                    }\n+                } else if (!setAllDescendants.count(childEntry)) {\n+                    // Try adding to entriesToAdd, and update our visit count\n+                    if (entriesToAdd.insert(childEntry).second && !setExclude.count(childEntry->GetTx().GetHash())) {\n+                        nChildrenToVisit++;\n+                    }\n+                }\n+                if (nChildrenToVisit > maxDescendantsToVisit) {\n+                    return false;\n+                }\n+            }\n+        }\n+        stageEntries = entriesToAdd;\n+    }\n+    // setAllDescendants now contains all in-mempool descendants of updateIt.\n+    // Update and add to cached descendant map\n+    int64_t modifySize = 0;\n+    CAmount modifyFee = 0;\n+    int64_t modifyCount = 0;\n+    BOOST_FOREACH(txiter cit, setAllDescendants) {\n+        if (!setExclude.count(cit->GetTx().GetHash())) {\n+            modifySize += cit->GetTxSize();\n+            modifyFee += cit->GetFee();\n+            modifyCount++;\n+            cachedDescendants[updateIt].insert(cit);\n+        }\n+    }\n+    mapTx.modify(updateIt, update_descendant_state(modifySize, modifyFee, modifyCount));\n+    return true;\n+}\n+\n+// vHashesToUpdate is the set of transaction hashes from a disconnected block\n+// which has been re-added to the mempool.\n+// for each entry, look for descendants that are outside hashesToUpdate, and\n+// add fee/size information for such descendants to the parent.\n+void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashesToUpdate)\n+{\n+    // For each entry in vHashesToUpdate, store the set of in-mempool, but not\n+    // in-vHashesToUpdate transactions, so that we don't have to recalculate\n+    // descendants when we come across a previously seen entry.\n+    cacheMap mapMemPoolDescendantsToUpdate;\n+\n+    // Use a set for lookups into vHashesToUpdate (these entries are already\n+    // accounted for in the state of their ancestors)\n+    std::set<uint256> setAlreadyIncluded(vHashesToUpdate.begin(), vHashesToUpdate.end());\n+\n+    // Iterate in reverse, so that whenever we are looking at at a transaction\n+    // we are sure that all in-mempool descendants have already been processed.\n+    // This maximizes the benefit of the descendant cache and guarantees that\n+    // setMemPoolChildren will be updated, an assumption made in\n+    // UpdateForDescendants.\n+    BOOST_REVERSE_FOREACH(const uint256 &hash, vHashesToUpdate) {\n+        // we cache the in-mempool children to avoid duplicate updates\n+        setEntries setChildren;\n+        // calculate children from mapNextTx\n+        txiter it = mapTx.find(hash);\n+        if (it == mapTx.end()) {\n+            continue;\n+        }\n+        std::map<COutPoint, CInPoint>::iterator iter = mapNextTx.lower_bound(COutPoint(hash, 0));\n+        // First calculate the children, and update setMemPoolChildren to\n+        // include them, and update their setMemPoolParents to include this tx.\n+        for (; iter != mapNextTx.end() && iter->first.hash == hash; ++iter) {\n+            const uint256 &childHash = iter->second.ptx->GetHash();\n+            txiter childIter = mapTx.find(childHash);\n+            // We can skip updating entries we've encountered before or that\n+            // are in the block (which are already accounted for).\n+            if (setChildren.insert(childIter).second && !setAlreadyIncluded.count(childHash)) {\n+                UpdateChild(it, childIter, true);\n+                UpdateParent(childIter, it, true);\n+            }\n+        }\n+        if (!UpdateForDescendants(it, 100, mapMemPoolDescendantsToUpdate, setAlreadyIncluded)) {\n+            // Mark as dirty if we can't do the calculation.\n+            mapTx.modify(it, set_dirty());\n+        }\n+    }\n+}\n+\n+bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString)\n+{\n+    setEntries parentHashes;\n+    const CTransaction &tx = entry.GetTx();\n+\n+    // Get parents of this transaction that are in the mempool\n+    // entry may or may not already be in the mempool, so we iterate mapTx\n+    // to find parents, rather than try GetMemPoolParents(entry)\n+    // TODO: optimize this so that we only check limits and walk\n+    // tx.vin when called on entries not already in the mempool.\n+    for (unsigned int i = 0; i < tx.vin.size(); i++) {\n+        txiter piter = mapTx.find(tx.vin[i].prevout.hash);\n+        if (piter != mapTx.end()) {\n+            parentHashes.insert(piter);\n+            if (parentHashes.size() + 1 > limitAncestorCount) {\n+                errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                return false;\n+            }\n+        }\n+    }\n+\n+    size_t totalSizeWithAncestors = entry.GetTxSize();\n+\n+    while (!parentHashes.empty()) {\n+        setAncestors.insert(parentHashes.begin(), parentHashes.end());\n+        setEntries stageParentSet; \n+        BOOST_FOREACH(const txiter &stageit, parentHashes) {\n+            assert(stageit != mapTx.end());\n+\n+            totalSizeWithAncestors += stageit->GetTxSize();\n+            if (stageit->GetSizeWithDescendants() + entry.GetTxSize() > limitDescendantSize) {\n+                errString = strprintf(\"exceeds descendant size limit for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString().substr(0,10), limitDescendantSize);\n+                return false;\n+            } else if (uint64_t(stageit->GetCountWithDescendants() + 1) > limitDescendantCount) {\n+                errString = strprintf(\"too many descendants for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString().substr(0,10), limitDescendantCount);\n+                return false;\n+            } else if (totalSizeWithAncestors > limitAncestorSize) {\n+                errString = strprintf(\"exceeds ancestor size limit [limit: %u]\", limitAncestorSize);\n+                return false;\n+            }\n+\n+            const setEntries & setMemPoolParents = GetMemPoolParents(stageit);\n+            BOOST_FOREACH(const txiter &phash, setMemPoolParents) {\n+                // If this is a new ancestor, add it.\n+                if (setAncestors.count(phash) == 0) {\n+                    stageParentSet.insert(phash);\n+                }\n+                if (stageParentSet.size() + setAncestors.size() + 1 > limitAncestorCount) {\n+                    errString = strprintf(\"too many unconfirmed ancestors [limit: %u]\", limitAncestorCount);\n+                    return false;\n+                }\n+            }    \n+        }\n+        parentHashes = stageParentSet;\n+    }\n+\n+    return true;\n+}\n+\n+void CTxMemPool::UpdateAncestorsOf(bool add, const uint256 &hash, setEntries &setAncestors)\n+{\n+    indexed_transaction_set::iterator it = mapTx.find(hash);\n+    setEntries parentIters = GetMemPoolParents(it);\n+    // add or remove this tx as a child of each parent\n+    BOOST_FOREACH(txiter piter, parentIters) {\n+        UpdateChild(piter, it, add);\n+    }\n+    int64_t updateCount = (add ? 1 : -1);\n+    int64_t updateSize = updateCount * it->GetTxSize();\n+    CAmount updateFee = updateCount * it->GetFee();\n+    BOOST_FOREACH(txiter ancestorIt, setAncestors) {\n+        mapTx.modify(ancestorIt, update_descendant_state(updateSize, updateFee, updateCount));\n+    }\n+}\n+\n+// TODO: pass a txiter instead?\n+void CTxMemPool::UpdateChildrenForRemoval(const uint256 &hash)\n+{\n+    txiter it = mapTx.find(hash);\n+    const setEntries &setMemPoolChildren = GetMemPoolChildren(it);\n+    BOOST_FOREACH(txiter updateIt, setMemPoolChildren) {\n+        UpdateParent(updateIt, it, false);\n+    }\n+}\n+\n+void CTxMemPool::UpdateForRemoveFromMempool(const std::set<uint256> &hashesToRemove)\n+{\n+    // For each entry, walk back all ancestors and decrement size associated with this\n+    // transaction\n+    uint64_t nNoLimit = std::numeric_limits<uint64_t>::max();\n+    BOOST_FOREACH(const uint256& removeHash, hashesToRemove) {\n+        setEntries setAncestors;\n+        const CTxMemPoolEntry &entry = *mapTx.find(removeHash);\n+        std::string dummy;\n+        CalculateMemPoolAncestors(entry, setAncestors, nNoLimit, nNoLimit, nNoLimit, nNoLimit, dummy);\n+        // Note that UpdateAncestorsOf severs the child links that point to\n+        // removeHash in the entries for the parents of removeHash.  This is\n+        // fine since we don't need to use the mempool children of any entries\n+        // to walk back over our ancestors (but we do need the mempool\n+        // parents!)\n+        UpdateAncestorsOf(false, removeHash, setAncestors);\n+    }\n+    // After updating all the ancestor sizes, we can now sever the link between each\n+    // transaction being removed and any mempool children (ie, update setMemPoolParents\n+    // for each direct child of a transaction being removed).\n+    BOOST_FOREACH(const uint256& removeHash, hashesToRemove) {\n+        UpdateChildrenForRemoval(removeHash);\n+    }\n+}\n+\n+void CTxMemPoolEntry::SetDirty()\n+{\n+    nCountWithDescendants=0;\n+    nSizeWithDescendants=nTxSize;\n+    nFeesWithDescendants=nFee;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39455606",
      "id" : 39455606,
      "original_commit_id" : "d6401c1547cbc39e55e71328e809e54a8bef4442",
      "original_position" : 253,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39455606",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39455793"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39455793"
         }
      },
      "body" : "nit: `const` on these?",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-14T22:32:20Z",
      "diff_hunk" : "@@ -48,6 +53,246 @@ CTxMemPoolEntry::GetPriority(unsigned int currentHeight) const\n     return dResult;\n }\n \n+// Update the given tx for any in-mempool descendants.\n+// Assumes that setMemPoolChildren is correct for the given tx and all\n+// descendants.\n+bool CTxMemPool::UpdateForDescendants(txiter updateIt, int maxDescendantsToVisit, cacheMap &cachedDescendants, const std::set<uint256> &setExclude)\n+{\n+    // Track the number of entries (outside setExclude) that we'd need to visit\n+    // (will bail out if it exceeds maxDescendantsToVisit)\n+    int nChildrenToVisit = 0; \n+\n+    setEntries stageEntries, setAllDescendants;\n+    stageEntries = GetMemPoolChildren(updateIt);\n+\n+    while (!stageEntries.empty()) {\n+        setAllDescendants.insert(stageEntries.begin(), stageEntries.end());\n+\n+        setEntries entriesToAdd;\n+        BOOST_FOREACH(const txiter cit, stageEntries) {\n+            if (cit->IsDirty()) {\n+                // Don't consider any more children if any descendant is dirty\n+                return false;\n+            }\n+            const setEntries &setChildren = GetMemPoolChildren(cit);\n+            BOOST_FOREACH(const txiter childEntry, setChildren) {\n+                cacheMap::iterator cacheIt = cachedDescendants.find(childEntry);\n+                if (cacheIt != cachedDescendants.end()) {\n+                    // We've already calculated this one, just add the entries for this set\n+                    // but don't traverse again.\n+                    BOOST_FOREACH(const txiter cacheEntry, cacheIt->second) {\n+                        // update visit count only for new child transactions\n+                        // (outside of setExclude and entriesToAdd)\n+                        if (setAllDescendants.insert(cacheEntry).second &&\n+                                !setExclude.count(cacheEntry->GetTx().GetHash()) &&\n+                                !entriesToAdd.count(cacheEntry)) {\n+                            nChildrenToVisit++;\n+                        }\n+                    }\n+                } else if (!setAllDescendants.count(childEntry)) {\n+                    // Try adding to entriesToAdd, and update our visit count\n+                    if (entriesToAdd.insert(childEntry).second && !setExclude.count(childEntry->GetTx().GetHash())) {\n+                        nChildrenToVisit++;\n+                    }\n+                }\n+                if (nChildrenToVisit > maxDescendantsToVisit) {\n+                    return false;\n+                }\n+            }\n+        }\n+        stageEntries = entriesToAdd;\n+    }\n+    // setAllDescendants now contains all in-mempool descendants of updateIt.\n+    // Update and add to cached descendant map\n+    int64_t modifySize = 0;\n+    CAmount modifyFee = 0;\n+    int64_t modifyCount = 0;\n+    BOOST_FOREACH(txiter cit, setAllDescendants) {\n+        if (!setExclude.count(cit->GetTx().GetHash())) {\n+            modifySize += cit->GetTxSize();\n+            modifyFee += cit->GetFee();\n+            modifyCount++;\n+            cachedDescendants[updateIt].insert(cit);\n+        }\n+    }\n+    mapTx.modify(updateIt, update_descendant_state(modifySize, modifyFee, modifyCount));\n+    return true;\n+}\n+\n+// vHashesToUpdate is the set of transaction hashes from a disconnected block\n+// which has been re-added to the mempool.\n+// for each entry, look for descendants that are outside hashesToUpdate, and\n+// add fee/size information for such descendants to the parent.\n+void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashesToUpdate)\n+{\n+    // For each entry in vHashesToUpdate, store the set of in-mempool, but not\n+    // in-vHashesToUpdate transactions, so that we don't have to recalculate\n+    // descendants when we come across a previously seen entry.\n+    cacheMap mapMemPoolDescendantsToUpdate;\n+\n+    // Use a set for lookups into vHashesToUpdate (these entries are already\n+    // accounted for in the state of their ancestors)\n+    std::set<uint256> setAlreadyIncluded(vHashesToUpdate.begin(), vHashesToUpdate.end());\n+\n+    // Iterate in reverse, so that whenever we are looking at at a transaction\n+    // we are sure that all in-mempool descendants have already been processed.\n+    // This maximizes the benefit of the descendant cache and guarantees that\n+    // setMemPoolChildren will be updated, an assumption made in\n+    // UpdateForDescendants.\n+    BOOST_REVERSE_FOREACH(const uint256 &hash, vHashesToUpdate) {\n+        // we cache the in-mempool children to avoid duplicate updates\n+        setEntries setChildren;\n+        // calculate children from mapNextTx\n+        txiter it = mapTx.find(hash);\n+        if (it == mapTx.end()) {\n+            continue;\n+        }\n+        std::map<COutPoint, CInPoint>::iterator iter = mapNextTx.lower_bound(COutPoint(hash, 0));\n+        // First calculate the children, and update setMemPoolChildren to\n+        // include them, and update their setMemPoolParents to include this tx.\n+        for (; iter != mapNextTx.end() && iter->first.hash == hash; ++iter) {\n+            const uint256 &childHash = iter->second.ptx->GetHash();\n+            txiter childIter = mapTx.find(childHash);\n+            // We can skip updating entries we've encountered before or that\n+            // are in the block (which are already accounted for).\n+            if (setChildren.insert(childIter).second && !setAlreadyIncluded.count(childHash)) {\n+                UpdateChild(it, childIter, true);\n+                UpdateParent(childIter, it, true);\n+            }\n+        }\n+        if (!UpdateForDescendants(it, 100, mapMemPoolDescendantsToUpdate, setAlreadyIncluded)) {\n+            // Mark as dirty if we can't do the calculation.\n+            mapTx.modify(it, set_dirty());\n+        }\n+    }\n+}\n+\n+bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString)\n+{\n+    setEntries parentHashes;\n+    const CTransaction &tx = entry.GetTx();\n+\n+    // Get parents of this transaction that are in the mempool\n+    // entry may or may not already be in the mempool, so we iterate mapTx\n+    // to find parents, rather than try GetMemPoolParents(entry)\n+    // TODO: optimize this so that we only check limits and walk\n+    // tx.vin when called on entries not already in the mempool.\n+    for (unsigned int i = 0; i < tx.vin.size(); i++) {\n+        txiter piter = mapTx.find(tx.vin[i].prevout.hash);\n+        if (piter != mapTx.end()) {\n+            parentHashes.insert(piter);\n+            if (parentHashes.size() + 1 > limitAncestorCount) {\n+                errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                return false;\n+            }\n+        }\n+    }\n+\n+    size_t totalSizeWithAncestors = entry.GetTxSize();\n+\n+    while (!parentHashes.empty()) {\n+        setAncestors.insert(parentHashes.begin(), parentHashes.end());\n+        setEntries stageParentSet; \n+        BOOST_FOREACH(const txiter &stageit, parentHashes) {\n+            assert(stageit != mapTx.end());\n+\n+            totalSizeWithAncestors += stageit->GetTxSize();\n+            if (stageit->GetSizeWithDescendants() + entry.GetTxSize() > limitDescendantSize) {\n+                errString = strprintf(\"exceeds descendant size limit for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString().substr(0,10), limitDescendantSize);\n+                return false;\n+            } else if (uint64_t(stageit->GetCountWithDescendants() + 1) > limitDescendantCount) {\n+                errString = strprintf(\"too many descendants for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString().substr(0,10), limitDescendantCount);\n+                return false;\n+            } else if (totalSizeWithAncestors > limitAncestorSize) {\n+                errString = strprintf(\"exceeds ancestor size limit [limit: %u]\", limitAncestorSize);\n+                return false;\n+            }\n+\n+            const setEntries & setMemPoolParents = GetMemPoolParents(stageit);\n+            BOOST_FOREACH(const txiter &phash, setMemPoolParents) {\n+                // If this is a new ancestor, add it.\n+                if (setAncestors.count(phash) == 0) {\n+                    stageParentSet.insert(phash);\n+                }\n+                if (stageParentSet.size() + setAncestors.size() + 1 > limitAncestorCount) {\n+                    errString = strprintf(\"too many unconfirmed ancestors [limit: %u]\", limitAncestorCount);\n+                    return false;\n+                }\n+            }    \n+        }\n+        parentHashes = stageParentSet;\n+    }\n+\n+    return true;\n+}\n+\n+void CTxMemPool::UpdateAncestorsOf(bool add, const uint256 &hash, setEntries &setAncestors)\n+{\n+    indexed_transaction_set::iterator it = mapTx.find(hash);\n+    setEntries parentIters = GetMemPoolParents(it);\n+    // add or remove this tx as a child of each parent\n+    BOOST_FOREACH(txiter piter, parentIters) {\n+        UpdateChild(piter, it, add);\n+    }\n+    int64_t updateCount = (add ? 1 : -1);\n+    int64_t updateSize = updateCount * it->GetTxSize();\n+    CAmount updateFee = updateCount * it->GetFee();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39455793",
      "id" : 39455793,
      "original_commit_id" : "d6401c1547cbc39e55e71328e809e54a8bef4442",
      "original_position" : 208,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39455793",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39455846"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39455846"
         }
      },
      "body" : "Check/assert `it == mapTx.end()`?",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-14T22:33:09Z",
      "diff_hunk" : "@@ -48,6 +53,246 @@ CTxMemPoolEntry::GetPriority(unsigned int currentHeight) const\n     return dResult;\n }\n \n+// Update the given tx for any in-mempool descendants.\n+// Assumes that setMemPoolChildren is correct for the given tx and all\n+// descendants.\n+bool CTxMemPool::UpdateForDescendants(txiter updateIt, int maxDescendantsToVisit, cacheMap &cachedDescendants, const std::set<uint256> &setExclude)\n+{\n+    // Track the number of entries (outside setExclude) that we'd need to visit\n+    // (will bail out if it exceeds maxDescendantsToVisit)\n+    int nChildrenToVisit = 0; \n+\n+    setEntries stageEntries, setAllDescendants;\n+    stageEntries = GetMemPoolChildren(updateIt);\n+\n+    while (!stageEntries.empty()) {\n+        setAllDescendants.insert(stageEntries.begin(), stageEntries.end());\n+\n+        setEntries entriesToAdd;\n+        BOOST_FOREACH(const txiter cit, stageEntries) {\n+            if (cit->IsDirty()) {\n+                // Don't consider any more children if any descendant is dirty\n+                return false;\n+            }\n+            const setEntries &setChildren = GetMemPoolChildren(cit);\n+            BOOST_FOREACH(const txiter childEntry, setChildren) {\n+                cacheMap::iterator cacheIt = cachedDescendants.find(childEntry);\n+                if (cacheIt != cachedDescendants.end()) {\n+                    // We've already calculated this one, just add the entries for this set\n+                    // but don't traverse again.\n+                    BOOST_FOREACH(const txiter cacheEntry, cacheIt->second) {\n+                        // update visit count only for new child transactions\n+                        // (outside of setExclude and entriesToAdd)\n+                        if (setAllDescendants.insert(cacheEntry).second &&\n+                                !setExclude.count(cacheEntry->GetTx().GetHash()) &&\n+                                !entriesToAdd.count(cacheEntry)) {\n+                            nChildrenToVisit++;\n+                        }\n+                    }\n+                } else if (!setAllDescendants.count(childEntry)) {\n+                    // Try adding to entriesToAdd, and update our visit count\n+                    if (entriesToAdd.insert(childEntry).second && !setExclude.count(childEntry->GetTx().GetHash())) {\n+                        nChildrenToVisit++;\n+                    }\n+                }\n+                if (nChildrenToVisit > maxDescendantsToVisit) {\n+                    return false;\n+                }\n+            }\n+        }\n+        stageEntries = entriesToAdd;\n+    }\n+    // setAllDescendants now contains all in-mempool descendants of updateIt.\n+    // Update and add to cached descendant map\n+    int64_t modifySize = 0;\n+    CAmount modifyFee = 0;\n+    int64_t modifyCount = 0;\n+    BOOST_FOREACH(txiter cit, setAllDescendants) {\n+        if (!setExclude.count(cit->GetTx().GetHash())) {\n+            modifySize += cit->GetTxSize();\n+            modifyFee += cit->GetFee();\n+            modifyCount++;\n+            cachedDescendants[updateIt].insert(cit);\n+        }\n+    }\n+    mapTx.modify(updateIt, update_descendant_state(modifySize, modifyFee, modifyCount));\n+    return true;\n+}\n+\n+// vHashesToUpdate is the set of transaction hashes from a disconnected block\n+// which has been re-added to the mempool.\n+// for each entry, look for descendants that are outside hashesToUpdate, and\n+// add fee/size information for such descendants to the parent.\n+void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashesToUpdate)\n+{\n+    // For each entry in vHashesToUpdate, store the set of in-mempool, but not\n+    // in-vHashesToUpdate transactions, so that we don't have to recalculate\n+    // descendants when we come across a previously seen entry.\n+    cacheMap mapMemPoolDescendantsToUpdate;\n+\n+    // Use a set for lookups into vHashesToUpdate (these entries are already\n+    // accounted for in the state of their ancestors)\n+    std::set<uint256> setAlreadyIncluded(vHashesToUpdate.begin(), vHashesToUpdate.end());\n+\n+    // Iterate in reverse, so that whenever we are looking at at a transaction\n+    // we are sure that all in-mempool descendants have already been processed.\n+    // This maximizes the benefit of the descendant cache and guarantees that\n+    // setMemPoolChildren will be updated, an assumption made in\n+    // UpdateForDescendants.\n+    BOOST_REVERSE_FOREACH(const uint256 &hash, vHashesToUpdate) {\n+        // we cache the in-mempool children to avoid duplicate updates\n+        setEntries setChildren;\n+        // calculate children from mapNextTx\n+        txiter it = mapTx.find(hash);\n+        if (it == mapTx.end()) {\n+            continue;\n+        }\n+        std::map<COutPoint, CInPoint>::iterator iter = mapNextTx.lower_bound(COutPoint(hash, 0));\n+        // First calculate the children, and update setMemPoolChildren to\n+        // include them, and update their setMemPoolParents to include this tx.\n+        for (; iter != mapNextTx.end() && iter->first.hash == hash; ++iter) {\n+            const uint256 &childHash = iter->second.ptx->GetHash();\n+            txiter childIter = mapTx.find(childHash);\n+            // We can skip updating entries we've encountered before or that\n+            // are in the block (which are already accounted for).\n+            if (setChildren.insert(childIter).second && !setAlreadyIncluded.count(childHash)) {\n+                UpdateChild(it, childIter, true);\n+                UpdateParent(childIter, it, true);\n+            }\n+        }\n+        if (!UpdateForDescendants(it, 100, mapMemPoolDescendantsToUpdate, setAlreadyIncluded)) {\n+            // Mark as dirty if we can't do the calculation.\n+            mapTx.modify(it, set_dirty());\n+        }\n+    }\n+}\n+\n+bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString)\n+{\n+    setEntries parentHashes;\n+    const CTransaction &tx = entry.GetTx();\n+\n+    // Get parents of this transaction that are in the mempool\n+    // entry may or may not already be in the mempool, so we iterate mapTx\n+    // to find parents, rather than try GetMemPoolParents(entry)\n+    // TODO: optimize this so that we only check limits and walk\n+    // tx.vin when called on entries not already in the mempool.\n+    for (unsigned int i = 0; i < tx.vin.size(); i++) {\n+        txiter piter = mapTx.find(tx.vin[i].prevout.hash);\n+        if (piter != mapTx.end()) {\n+            parentHashes.insert(piter);\n+            if (parentHashes.size() + 1 > limitAncestorCount) {\n+                errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                return false;\n+            }\n+        }\n+    }\n+\n+    size_t totalSizeWithAncestors = entry.GetTxSize();\n+\n+    while (!parentHashes.empty()) {\n+        setAncestors.insert(parentHashes.begin(), parentHashes.end());\n+        setEntries stageParentSet; \n+        BOOST_FOREACH(const txiter &stageit, parentHashes) {\n+            assert(stageit != mapTx.end());\n+\n+            totalSizeWithAncestors += stageit->GetTxSize();\n+            if (stageit->GetSizeWithDescendants() + entry.GetTxSize() > limitDescendantSize) {\n+                errString = strprintf(\"exceeds descendant size limit for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString().substr(0,10), limitDescendantSize);\n+                return false;\n+            } else if (uint64_t(stageit->GetCountWithDescendants() + 1) > limitDescendantCount) {\n+                errString = strprintf(\"too many descendants for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString().substr(0,10), limitDescendantCount);\n+                return false;\n+            } else if (totalSizeWithAncestors > limitAncestorSize) {\n+                errString = strprintf(\"exceeds ancestor size limit [limit: %u]\", limitAncestorSize);\n+                return false;\n+            }\n+\n+            const setEntries & setMemPoolParents = GetMemPoolParents(stageit);\n+            BOOST_FOREACH(const txiter &phash, setMemPoolParents) {\n+                // If this is a new ancestor, add it.\n+                if (setAncestors.count(phash) == 0) {\n+                    stageParentSet.insert(phash);\n+                }\n+                if (stageParentSet.size() + setAncestors.size() + 1 > limitAncestorCount) {\n+                    errString = strprintf(\"too many unconfirmed ancestors [limit: %u]\", limitAncestorCount);\n+                    return false;\n+                }\n+            }    \n+        }\n+        parentHashes = stageParentSet;\n+    }\n+\n+    return true;\n+}\n+\n+void CTxMemPool::UpdateAncestorsOf(bool add, const uint256 &hash, setEntries &setAncestors)\n+{\n+    indexed_transaction_set::iterator it = mapTx.find(hash);\n+    setEntries parentIters = GetMemPoolParents(it);\n+    // add or remove this tx as a child of each parent\n+    BOOST_FOREACH(txiter piter, parentIters) {\n+        UpdateChild(piter, it, add);\n+    }\n+    int64_t updateCount = (add ? 1 : -1);\n+    int64_t updateSize = updateCount * it->GetTxSize();\n+    CAmount updateFee = updateCount * it->GetFee();\n+    BOOST_FOREACH(txiter ancestorIt, setAncestors) {\n+        mapTx.modify(ancestorIt, update_descendant_state(updateSize, updateFee, updateCount));\n+    }\n+}\n+\n+// TODO: pass a txiter instead?\n+void CTxMemPool::UpdateChildrenForRemoval(const uint256 &hash)\n+{\n+    txiter it = mapTx.find(hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39455846",
      "id" : 39455846,
      "original_commit_id" : "d6401c1547cbc39e55e71328e809e54a8bef4442",
      "original_position" : 217,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39455846",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39455889"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39455889"
         }
      },
      "body" : "Check/assert `it == mapTx.end()`, especially before de-reference",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-14T22:33:53Z",
      "diff_hunk" : "@@ -48,6 +53,246 @@ CTxMemPoolEntry::GetPriority(unsigned int currentHeight) const\n     return dResult;\n }\n \n+// Update the given tx for any in-mempool descendants.\n+// Assumes that setMemPoolChildren is correct for the given tx and all\n+// descendants.\n+bool CTxMemPool::UpdateForDescendants(txiter updateIt, int maxDescendantsToVisit, cacheMap &cachedDescendants, const std::set<uint256> &setExclude)\n+{\n+    // Track the number of entries (outside setExclude) that we'd need to visit\n+    // (will bail out if it exceeds maxDescendantsToVisit)\n+    int nChildrenToVisit = 0; \n+\n+    setEntries stageEntries, setAllDescendants;\n+    stageEntries = GetMemPoolChildren(updateIt);\n+\n+    while (!stageEntries.empty()) {\n+        setAllDescendants.insert(stageEntries.begin(), stageEntries.end());\n+\n+        setEntries entriesToAdd;\n+        BOOST_FOREACH(const txiter cit, stageEntries) {\n+            if (cit->IsDirty()) {\n+                // Don't consider any more children if any descendant is dirty\n+                return false;\n+            }\n+            const setEntries &setChildren = GetMemPoolChildren(cit);\n+            BOOST_FOREACH(const txiter childEntry, setChildren) {\n+                cacheMap::iterator cacheIt = cachedDescendants.find(childEntry);\n+                if (cacheIt != cachedDescendants.end()) {\n+                    // We've already calculated this one, just add the entries for this set\n+                    // but don't traverse again.\n+                    BOOST_FOREACH(const txiter cacheEntry, cacheIt->second) {\n+                        // update visit count only for new child transactions\n+                        // (outside of setExclude and entriesToAdd)\n+                        if (setAllDescendants.insert(cacheEntry).second &&\n+                                !setExclude.count(cacheEntry->GetTx().GetHash()) &&\n+                                !entriesToAdd.count(cacheEntry)) {\n+                            nChildrenToVisit++;\n+                        }\n+                    }\n+                } else if (!setAllDescendants.count(childEntry)) {\n+                    // Try adding to entriesToAdd, and update our visit count\n+                    if (entriesToAdd.insert(childEntry).second && !setExclude.count(childEntry->GetTx().GetHash())) {\n+                        nChildrenToVisit++;\n+                    }\n+                }\n+                if (nChildrenToVisit > maxDescendantsToVisit) {\n+                    return false;\n+                }\n+            }\n+        }\n+        stageEntries = entriesToAdd;\n+    }\n+    // setAllDescendants now contains all in-mempool descendants of updateIt.\n+    // Update and add to cached descendant map\n+    int64_t modifySize = 0;\n+    CAmount modifyFee = 0;\n+    int64_t modifyCount = 0;\n+    BOOST_FOREACH(txiter cit, setAllDescendants) {\n+        if (!setExclude.count(cit->GetTx().GetHash())) {\n+            modifySize += cit->GetTxSize();\n+            modifyFee += cit->GetFee();\n+            modifyCount++;\n+            cachedDescendants[updateIt].insert(cit);\n+        }\n+    }\n+    mapTx.modify(updateIt, update_descendant_state(modifySize, modifyFee, modifyCount));\n+    return true;\n+}\n+\n+// vHashesToUpdate is the set of transaction hashes from a disconnected block\n+// which has been re-added to the mempool.\n+// for each entry, look for descendants that are outside hashesToUpdate, and\n+// add fee/size information for such descendants to the parent.\n+void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashesToUpdate)\n+{\n+    // For each entry in vHashesToUpdate, store the set of in-mempool, but not\n+    // in-vHashesToUpdate transactions, so that we don't have to recalculate\n+    // descendants when we come across a previously seen entry.\n+    cacheMap mapMemPoolDescendantsToUpdate;\n+\n+    // Use a set for lookups into vHashesToUpdate (these entries are already\n+    // accounted for in the state of their ancestors)\n+    std::set<uint256> setAlreadyIncluded(vHashesToUpdate.begin(), vHashesToUpdate.end());\n+\n+    // Iterate in reverse, so that whenever we are looking at at a transaction\n+    // we are sure that all in-mempool descendants have already been processed.\n+    // This maximizes the benefit of the descendant cache and guarantees that\n+    // setMemPoolChildren will be updated, an assumption made in\n+    // UpdateForDescendants.\n+    BOOST_REVERSE_FOREACH(const uint256 &hash, vHashesToUpdate) {\n+        // we cache the in-mempool children to avoid duplicate updates\n+        setEntries setChildren;\n+        // calculate children from mapNextTx\n+        txiter it = mapTx.find(hash);\n+        if (it == mapTx.end()) {\n+            continue;\n+        }\n+        std::map<COutPoint, CInPoint>::iterator iter = mapNextTx.lower_bound(COutPoint(hash, 0));\n+        // First calculate the children, and update setMemPoolChildren to\n+        // include them, and update their setMemPoolParents to include this tx.\n+        for (; iter != mapNextTx.end() && iter->first.hash == hash; ++iter) {\n+            const uint256 &childHash = iter->second.ptx->GetHash();\n+            txiter childIter = mapTx.find(childHash);\n+            // We can skip updating entries we've encountered before or that\n+            // are in the block (which are already accounted for).\n+            if (setChildren.insert(childIter).second && !setAlreadyIncluded.count(childHash)) {\n+                UpdateChild(it, childIter, true);\n+                UpdateParent(childIter, it, true);\n+            }\n+        }\n+        if (!UpdateForDescendants(it, 100, mapMemPoolDescendantsToUpdate, setAlreadyIncluded)) {\n+            // Mark as dirty if we can't do the calculation.\n+            mapTx.modify(it, set_dirty());\n+        }\n+    }\n+}\n+\n+bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString)\n+{\n+    setEntries parentHashes;\n+    const CTransaction &tx = entry.GetTx();\n+\n+    // Get parents of this transaction that are in the mempool\n+    // entry may or may not already be in the mempool, so we iterate mapTx\n+    // to find parents, rather than try GetMemPoolParents(entry)\n+    // TODO: optimize this so that we only check limits and walk\n+    // tx.vin when called on entries not already in the mempool.\n+    for (unsigned int i = 0; i < tx.vin.size(); i++) {\n+        txiter piter = mapTx.find(tx.vin[i].prevout.hash);\n+        if (piter != mapTx.end()) {\n+            parentHashes.insert(piter);\n+            if (parentHashes.size() + 1 > limitAncestorCount) {\n+                errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                return false;\n+            }\n+        }\n+    }\n+\n+    size_t totalSizeWithAncestors = entry.GetTxSize();\n+\n+    while (!parentHashes.empty()) {\n+        setAncestors.insert(parentHashes.begin(), parentHashes.end());\n+        setEntries stageParentSet; \n+        BOOST_FOREACH(const txiter &stageit, parentHashes) {\n+            assert(stageit != mapTx.end());\n+\n+            totalSizeWithAncestors += stageit->GetTxSize();\n+            if (stageit->GetSizeWithDescendants() + entry.GetTxSize() > limitDescendantSize) {\n+                errString = strprintf(\"exceeds descendant size limit for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString().substr(0,10), limitDescendantSize);\n+                return false;\n+            } else if (uint64_t(stageit->GetCountWithDescendants() + 1) > limitDescendantCount) {\n+                errString = strprintf(\"too many descendants for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString().substr(0,10), limitDescendantCount);\n+                return false;\n+            } else if (totalSizeWithAncestors > limitAncestorSize) {\n+                errString = strprintf(\"exceeds ancestor size limit [limit: %u]\", limitAncestorSize);\n+                return false;\n+            }\n+\n+            const setEntries & setMemPoolParents = GetMemPoolParents(stageit);\n+            BOOST_FOREACH(const txiter &phash, setMemPoolParents) {\n+                // If this is a new ancestor, add it.\n+                if (setAncestors.count(phash) == 0) {\n+                    stageParentSet.insert(phash);\n+                }\n+                if (stageParentSet.size() + setAncestors.size() + 1 > limitAncestorCount) {\n+                    errString = strprintf(\"too many unconfirmed ancestors [limit: %u]\", limitAncestorCount);\n+                    return false;\n+                }\n+            }    \n+        }\n+        parentHashes = stageParentSet;\n+    }\n+\n+    return true;\n+}\n+\n+void CTxMemPool::UpdateAncestorsOf(bool add, const uint256 &hash, setEntries &setAncestors)\n+{\n+    indexed_transaction_set::iterator it = mapTx.find(hash);\n+    setEntries parentIters = GetMemPoolParents(it);\n+    // add or remove this tx as a child of each parent\n+    BOOST_FOREACH(txiter piter, parentIters) {\n+        UpdateChild(piter, it, add);\n+    }\n+    int64_t updateCount = (add ? 1 : -1);\n+    int64_t updateSize = updateCount * it->GetTxSize();\n+    CAmount updateFee = updateCount * it->GetFee();\n+    BOOST_FOREACH(txiter ancestorIt, setAncestors) {\n+        mapTx.modify(ancestorIt, update_descendant_state(updateSize, updateFee, updateCount));\n+    }\n+}\n+\n+// TODO: pass a txiter instead?\n+void CTxMemPool::UpdateChildrenForRemoval(const uint256 &hash)\n+{\n+    txiter it = mapTx.find(hash);\n+    const setEntries &setMemPoolChildren = GetMemPoolChildren(it);\n+    BOOST_FOREACH(txiter updateIt, setMemPoolChildren) {\n+        UpdateParent(updateIt, it, false);\n+    }\n+}\n+\n+void CTxMemPool::UpdateForRemoveFromMempool(const std::set<uint256> &hashesToRemove)\n+{\n+    // For each entry, walk back all ancestors and decrement size associated with this\n+    // transaction\n+    uint64_t nNoLimit = std::numeric_limits<uint64_t>::max();\n+    BOOST_FOREACH(const uint256& removeHash, hashesToRemove) {\n+        setEntries setAncestors;\n+        const CTxMemPoolEntry &entry = *mapTx.find(removeHash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39455889",
      "id" : 39455889,
      "original_commit_id" : "d6401c1547cbc39e55e71328e809e54a8bef4442",
      "original_position" : 231,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39455889",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39456040"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39456040"
         }
      },
      "body" : "Check/assert `it == mapTx.end()`?\r\nWould only be possible on the first `stagehash` AFAIK\r\n\r\nAlso, `const`/`const_iterator`?",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-14T22:35:51Z",
      "diff_hunk" : "@@ -89,34 +334,106 @@ void CTxMemPool::AddTransactionsUpdated(unsigned int n)\n     nTransactionsUpdated += n;\n }\n \n-\n-bool CTxMemPool::addUnchecked(const uint256& hash, const CTxMemPoolEntry &entry, bool fCurrentEstimate)\n+bool CTxMemPool::addUnchecked(const uint256& hash, const CTxMemPoolEntry &entry, setEntries &setAncestors, bool fCurrentEstimate)\n {\n     // Add to memory pool without checking anything.\n     // Used by main.cpp AcceptToMemoryPool(), which DOES do\n     // all the appropriate checks.\n     LOCK(cs);\n-    mapTx[hash] = entry;\n-    const CTransaction& tx = mapTx[hash].GetTx();\n-    for (unsigned int i = 0; i < tx.vin.size(); i++)\n+    indexed_transaction_set::iterator newit = mapTx.insert(entry).first;\n+    mapLinks.insert(make_pair(newit, TxLinks()));\n+\n+    // Update cachedInnerUsage to include contained transaction's usage.\n+    // (When we update the entry for in-mempool parents, memory usage will be\n+    // further updated.)\n+    cachedInnerUsage += entry.DynamicMemoryUsage();\n+\n+    const CTransaction& tx = newit->GetTx();\n+    std::set<uint256> setParentTransactions;\n+    for (unsigned int i = 0; i < tx.vin.size(); i++) {\n         mapNextTx[tx.vin[i].prevout] = CInPoint(&tx, i);\n+        setParentTransactions.insert(tx.vin[i].prevout.hash);\n+    }\n+    // Don't bother worrying about child transactions of this one.\n+    // Normal case of a new transaction arriving is that there can't be any\n+    // children, because such children would be orphans.\n+    // An exception to that is if a transaction enters that used to be in a block.\n+    // In that case, our disconnect block logic will call UpdateTransactionsFromBlock\n+    // to clean up the mess we're leaving here.\n+\n+    // Update ancestors with information about this tx\n+    BOOST_FOREACH (const uint256 &phash, setParentTransactions) {\n+        txiter pit = mapTx.find(phash);\n+        if (pit != mapTx.end()) {\n+            UpdateParent(newit, pit, true);\n+        }\n+    }\n+    UpdateAncestorsOf(true, hash, setAncestors);\n+\n     nTransactionsUpdated++;\n     totalTxSize += entry.GetTxSize();\n-    cachedInnerUsage += entry.DynamicMemoryUsage();\n     minerPolicyEstimator->processTransaction(entry, fCurrentEstimate);\n \n     return true;\n }\n \n+// TODO: replace this hash with an iterator?\n+void CTxMemPool::removeUnchecked(const uint256& hash)\n+{\n+    indexed_transaction_set::iterator it = mapTx.find(hash);\n+\n+    BOOST_FOREACH(const CTxIn& txin, it->GetTx().vin)\n+        mapNextTx.erase(txin.prevout);\n+\n+    totalTxSize -= it->GetTxSize();\n+    cachedInnerUsage -= it->DynamicMemoryUsage();\n+    cachedInnerUsage -= memusage::DynamicUsage(mapLinks[it].parents) + memusage::DynamicUsage(mapLinks[it].children);\n+    mapLinks.erase(it);\n+    mapTx.erase(it);\n+    nTransactionsUpdated++;\n+    minerPolicyEstimator->removeTx(hash);\n+}\n+\n+// Calculates descendants of hash that are not already in setDescendants, and adds to \n+// setDescendants. Assumes hash is already a tx in the mempool and setMemPoolChildren\n+// is correct for tx and all descendants.\n+// Also assumes that if an entry is in setDescendants already, then all\n+// in-mempool descendants of it are already in setDescendants as well, so that we\n+// can save time by not iterating over those entries.\n+void CTxMemPool::CalculateDescendants(const uint256 &hash, std::set<uint256> &setDescendants)\n+{\n+    std::set<uint256> stage;\n+    if (setDescendants.count(hash) == 0) {\n+        stage.insert(hash);\n+    }\n+    // Traverse down the children of each hash, only adding children that are not\n+    // accounted for in setDescendants already (because those children have either\n+    // already been walked, or will be walked in this iteration).\n+    while (!stage.empty()) {\n+        setDescendants.insert(stage.begin(), stage.end());\n+        std::set<uint256> setNext;\n+        BOOST_FOREACH(const uint256 &stagehash, stage) {\n+            indexed_transaction_set::iterator it = mapTx.find(stagehash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39456040",
      "id" : 39456040,
      "original_commit_id" : "d6401c1547cbc39e55e71328e809e54a8bef4442",
      "original_position" : 357,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39456040",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39456108"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39456108"
         }
      },
      "body" : "Again,  assumption of `hash` in `mapTx`,  worth asserting?",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-14T22:36:54Z",
      "diff_hunk" : "@@ -125,34 +442,21 @@ void CTxMemPool::remove(const CTransaction &origTx, std::list<CTransaction>& rem\n                 std::map<COutPoint, CInPoint>::iterator it = mapNextTx.find(COutPoint(origTx.GetHash(), i));\n                 if (it == mapNextTx.end())\n                     continue;\n-                txToRemove.push_back(it->second.ptx->GetHash());\n+                txToRemove.insert(it->second.ptx->GetHash());\n             }\n         }\n-        while (!txToRemove.empty())\n-        {\n-            uint256 hash = txToRemove.front();\n-            txToRemove.pop_front();\n-            if (!mapTx.count(hash))\n-                continue;\n-            const CTransaction& tx = mapTx[hash].GetTx();\n-            if (fRecursive) {\n-                for (unsigned int i = 0; i < tx.vout.size(); i++) {\n-                    std::map<COutPoint, CInPoint>::iterator it = mapNextTx.find(COutPoint(hash, i));\n-                    if (it == mapNextTx.end())\n-                        continue;\n-                    txToRemove.push_back(it->second.ptx->GetHash());\n-                }\n+        std::set<uint256> setAllRemoves;\n+        if (fRecursive) {\n+            BOOST_FOREACH(const uint256 &hash, txToRemove) {\n+                CalculateDescendants(hash, setAllRemoves);\n             }\n-            BOOST_FOREACH(const CTxIn& txin, tx.vin)\n-                mapNextTx.erase(txin.prevout);\n-\n-            removed.push_back(tx);\n-            totalTxSize -= mapTx[hash].GetTxSize();\n-            cachedInnerUsage -= mapTx[hash].DynamicMemoryUsage();\n-            mapTx.erase(hash);\n-            nTransactionsUpdated++;\n-            minerPolicyEstimator->removeTx(hash);\n+        } else {\n+            setAllRemoves = txToRemove;\n+        }\n+        BOOST_FOREACH(const uint256& hash, setAllRemoves) {\n+            removed.push_back(mapTx.find(hash)->GetTx());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39456108",
      "id" : 39456108,
      "original_commit_id" : "d6401c1547cbc39e55e71328e809e54a8bef4442",
      "original_position" : 424,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39456108",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39456258"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39456258"
         }
      },
      "body" : "Again, `find` not checked,  if this assumption can hold true,  can it be documented?",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-14T22:39:13Z",
      "diff_hunk" : "@@ -271,8 +582,34 @@ void CTxMemPool::check(const CCoinsViewCache *pcoins) const\n             assert(it3->second.n == i);\n             i++;\n         }\n+        assert(setParentCheck == GetMemPoolParents(it));\n+        // Check children against mapNextTx\n+        CTxMemPool::setEntries setChildrenCheck;\n+        std::map<COutPoint, CInPoint>::const_iterator iter = mapNextTx.lower_bound(COutPoint(it->GetTx().GetHash(), 0));\n+        int64_t childSizes = 0;\n+        CAmount childFees = 0;\n+        for (; iter != mapNextTx.end() && iter->first.hash == it->GetTx().GetHash(); ++iter) {\n+            txiter childit = mapTx.find(iter->second.ptx->GetHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39456258",
      "id" : 39456258,
      "original_commit_id" : "d6401c1547cbc39e55e71328e809e54a8bef4442",
      "original_position" : 506,
      "path" : "src/txmempool.cpp",
      "position" : 508,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39456258",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39456322"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39456322"
         }
      },
      "body" : "Is `mapLinks` in perfect sync with `mapTx`?",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-14T22:40:16Z",
      "diff_hunk" : "@@ -247,19 +554,23 @@ void CTxMemPool::check(const CCoinsViewCache *pcoins) const\n \n     LOCK(cs);\n     list<const CTxMemPoolEntry*> waitingOnDependants;\n-    for (std::map<uint256, CTxMemPoolEntry>::const_iterator it = mapTx.begin(); it != mapTx.end(); it++) {\n+    for (indexed_transaction_set::const_iterator it = mapTx.begin(); it != mapTx.end(); it++) {\n         unsigned int i = 0;\n-        checkTotal += it->second.GetTxSize();\n-        innerUsage += it->second.DynamicMemoryUsage();\n-        const CTransaction& tx = it->second.GetTx();\n+        checkTotal += it->GetTxSize();\n+        innerUsage += it->DynamicMemoryUsage(); \n+        const CTransaction& tx = it->GetTx();\n+        const TxLinks &links = mapLinks.find(it)->second;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39456322",
      "id" : 39456322,
      "original_commit_id" : "d6401c1547cbc39e55e71328e809e54a8bef4442",
      "original_position" : 478,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39456322",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39552306"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39552306"
         }
      },
      "body" : "Yes -- I'll be adding some additional asserts to make this more clear.",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-15T19:13:03Z",
      "diff_hunk" : "@@ -247,19 +554,23 @@ void CTxMemPool::check(const CCoinsViewCache *pcoins) const\n \n     LOCK(cs);\n     list<const CTxMemPoolEntry*> waitingOnDependants;\n-    for (std::map<uint256, CTxMemPoolEntry>::const_iterator it = mapTx.begin(); it != mapTx.end(); it++) {\n+    for (indexed_transaction_set::const_iterator it = mapTx.begin(); it != mapTx.end(); it++) {\n         unsigned int i = 0;\n-        checkTotal += it->second.GetTxSize();\n-        innerUsage += it->second.DynamicMemoryUsage();\n-        const CTransaction& tx = it->second.GetTx();\n+        checkTotal += it->GetTxSize();\n+        innerUsage += it->DynamicMemoryUsage(); \n+        const CTransaction& tx = it->GetTx();\n+        const TxLinks &links = mapLinks.find(it)->second;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39552306",
      "id" : 39552306,
      "original_commit_id" : "d6401c1547cbc39e55e71328e809e54a8bef4442",
      "original_position" : 478,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39552306",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39557768"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39557768"
         }
      },
      "body" : "mapNextTx contains exactly the in-mempool children of a given transaction, so this code should be safe.  I'll add an assert to make the assumption clearer (the semantics of mapNextTx weren't changed by this pull).",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-15T20:06:04Z",
      "diff_hunk" : "@@ -271,8 +582,34 @@ void CTxMemPool::check(const CCoinsViewCache *pcoins) const\n             assert(it3->second.n == i);\n             i++;\n         }\n+        assert(setParentCheck == GetMemPoolParents(it));\n+        // Check children against mapNextTx\n+        CTxMemPool::setEntries setChildrenCheck;\n+        std::map<COutPoint, CInPoint>::const_iterator iter = mapNextTx.lower_bound(COutPoint(it->GetTx().GetHash(), 0));\n+        int64_t childSizes = 0;\n+        CAmount childFees = 0;\n+        for (; iter != mapNextTx.end() && iter->first.hash == it->GetTx().GetHash(); ++iter) {\n+            txiter childit = mapTx.find(iter->second.ptx->GetHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39557768",
      "id" : 39557768,
      "original_commit_id" : "d6401c1547cbc39e55e71328e809e54a8bef4442",
      "original_position" : 506,
      "path" : "src/txmempool.cpp",
      "position" : 508,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39557768",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39581755"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39581755"
         }
      },
      "body" : "I agree but is there a better way to do this?  I think I'm following the common practice in the code base, though I look forward to a future refactoring when we have better encapsulation.",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-16T00:12:05Z",
      "diff_hunk" : "@@ -921,6 +921,17 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n                 REJECT_HIGHFEE, \"absurdly-high-fee\",\n                 strprintf(\"%d > %d\", nFees, ::minRelayTxFee.GetFee(nSize) * 10000));\n \n+        // Calculate in-mempool ancestors, up to a limit.\n+        CTxMemPool::setEntries setAncestors;\n+        size_t nLimitAncestors = GetArg(\"-limitancestorcount\", DEFAULT_ANCESTOR_LIMIT);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39581755",
      "id" : 39581755,
      "original_commit_id" : "d6401c1547cbc39e55e71328e809e54a8bef4442",
      "original_position" : 6,
      "path" : "src/main.cpp",
      "position" : 6,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39581755",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39582922"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39582922"
         }
      },
      "body" : "I'll add an assert to make clear that is not possible.",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-16T00:31:38Z",
      "diff_hunk" : "@@ -48,6 +53,246 @@ CTxMemPoolEntry::GetPriority(unsigned int currentHeight) const\n     return dResult;\n }\n \n+// Update the given tx for any in-mempool descendants.\n+// Assumes that setMemPoolChildren is correct for the given tx and all\n+// descendants.\n+bool CTxMemPool::UpdateForDescendants(txiter updateIt, int maxDescendantsToVisit, cacheMap &cachedDescendants, const std::set<uint256> &setExclude)\n+{\n+    // Track the number of entries (outside setExclude) that we'd need to visit\n+    // (will bail out if it exceeds maxDescendantsToVisit)\n+    int nChildrenToVisit = 0; \n+\n+    setEntries stageEntries, setAllDescendants;\n+    stageEntries = GetMemPoolChildren(updateIt);\n+\n+    while (!stageEntries.empty()) {\n+        setAllDescendants.insert(stageEntries.begin(), stageEntries.end());\n+\n+        setEntries entriesToAdd;\n+        BOOST_FOREACH(const txiter cit, stageEntries) {\n+            if (cit->IsDirty()) {\n+                // Don't consider any more children if any descendant is dirty\n+                return false;\n+            }\n+            const setEntries &setChildren = GetMemPoolChildren(cit);\n+            BOOST_FOREACH(const txiter childEntry, setChildren) {\n+                cacheMap::iterator cacheIt = cachedDescendants.find(childEntry);\n+                if (cacheIt != cachedDescendants.end()) {\n+                    // We've already calculated this one, just add the entries for this set\n+                    // but don't traverse again.\n+                    BOOST_FOREACH(const txiter cacheEntry, cacheIt->second) {\n+                        // update visit count only for new child transactions\n+                        // (outside of setExclude and entriesToAdd)\n+                        if (setAllDescendants.insert(cacheEntry).second &&\n+                                !setExclude.count(cacheEntry->GetTx().GetHash()) &&\n+                                !entriesToAdd.count(cacheEntry)) {\n+                            nChildrenToVisit++;\n+                        }\n+                    }\n+                } else if (!setAllDescendants.count(childEntry)) {\n+                    // Try adding to entriesToAdd, and update our visit count\n+                    if (entriesToAdd.insert(childEntry).second && !setExclude.count(childEntry->GetTx().GetHash())) {\n+                        nChildrenToVisit++;\n+                    }\n+                }\n+                if (nChildrenToVisit > maxDescendantsToVisit) {\n+                    return false;\n+                }\n+            }\n+        }\n+        stageEntries = entriesToAdd;\n+    }\n+    // setAllDescendants now contains all in-mempool descendants of updateIt.\n+    // Update and add to cached descendant map\n+    int64_t modifySize = 0;\n+    CAmount modifyFee = 0;\n+    int64_t modifyCount = 0;\n+    BOOST_FOREACH(txiter cit, setAllDescendants) {\n+        if (!setExclude.count(cit->GetTx().GetHash())) {\n+            modifySize += cit->GetTxSize();\n+            modifyFee += cit->GetFee();\n+            modifyCount++;\n+            cachedDescendants[updateIt].insert(cit);\n+        }\n+    }\n+    mapTx.modify(updateIt, update_descendant_state(modifySize, modifyFee, modifyCount));\n+    return true;\n+}\n+\n+// vHashesToUpdate is the set of transaction hashes from a disconnected block\n+// which has been re-added to the mempool.\n+// for each entry, look for descendants that are outside hashesToUpdate, and\n+// add fee/size information for such descendants to the parent.\n+void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashesToUpdate)\n+{\n+    // For each entry in vHashesToUpdate, store the set of in-mempool, but not\n+    // in-vHashesToUpdate transactions, so that we don't have to recalculate\n+    // descendants when we come across a previously seen entry.\n+    cacheMap mapMemPoolDescendantsToUpdate;\n+\n+    // Use a set for lookups into vHashesToUpdate (these entries are already\n+    // accounted for in the state of their ancestors)\n+    std::set<uint256> setAlreadyIncluded(vHashesToUpdate.begin(), vHashesToUpdate.end());\n+\n+    // Iterate in reverse, so that whenever we are looking at at a transaction\n+    // we are sure that all in-mempool descendants have already been processed.\n+    // This maximizes the benefit of the descendant cache and guarantees that\n+    // setMemPoolChildren will be updated, an assumption made in\n+    // UpdateForDescendants.\n+    BOOST_REVERSE_FOREACH(const uint256 &hash, vHashesToUpdate) {\n+        // we cache the in-mempool children to avoid duplicate updates\n+        setEntries setChildren;\n+        // calculate children from mapNextTx\n+        txiter it = mapTx.find(hash);\n+        if (it == mapTx.end()) {\n+            continue;\n+        }\n+        std::map<COutPoint, CInPoint>::iterator iter = mapNextTx.lower_bound(COutPoint(hash, 0));\n+        // First calculate the children, and update setMemPoolChildren to\n+        // include them, and update their setMemPoolParents to include this tx.\n+        for (; iter != mapNextTx.end() && iter->first.hash == hash; ++iter) {\n+            const uint256 &childHash = iter->second.ptx->GetHash();\n+            txiter childIter = mapTx.find(childHash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39582922",
      "id" : 39582922,
      "original_commit_id" : "d6401c1547cbc39e55e71328e809e54a8bef4442",
      "original_position" : 124,
      "path" : "src/txmempool.cpp",
      "position" : 125,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39582922",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "Thanks everyone for reviewing!  I've pushed up a series of commits to address everyone's feedback; I believe all comments should have been addressed.\r\n\r\nThese cleanups need to be squashed, and this pull now needs to be rebased (a merge conflict crept in now that I'm outputting additional information in getrawmempool).  Reviewers -- please let me know if you prefer I leave these commits unsquashed/unrebased so you can review the changes.  (In the absence of any expressed preferences, I'll plan to squash/rebase in a day or two so that this can become mergeable.)\r\n\r\n@petertodd I added the extra information to the getrawmempool RPC call (good idea!).  Now that the RPC call is there, I realized that adding an RPC test that exercises the new limits is a good idea, so I've started work on that, but it's not yet complete.",
      "created_at" : "2015-09-16T13:44:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#issuecomment-140746438",
      "id" : 140746438,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6654",
      "updated_at" : "2015-09-16T13:44:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/140746438",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "utACK,  thanks @sdaftuar!\r\n\r\n**edit:** wait up,  might need to re-evaluate the policy options in regards to comments in #6403",
      "created_at" : "2015-09-16T15:16:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#issuecomment-140773288",
      "id" : 140773288,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6654",
      "updated_at" : "2015-09-16T15:26:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/140773288",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39649035"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39649035"
         }
      },
      "body" : "Can all these new members from here through to `UpdateChild` be made private?",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-16T16:02:31Z",
      "diff_hunk" : "@@ -99,8 +285,43 @@ class CTxMemPool\n     uint64_t cachedInnerUsage; //! sum of dynamic memory usage of all the map elements (NOT the maps themselves)\n \n public:\n+    typedef boost::multi_index_container<\n+        CTxMemPoolEntry,\n+        boost::multi_index::indexed_by<\n+            // sorted by txid\n+            boost::multi_index::ordered_unique<mempoolentry_txid>,\n+            // sorted by fee rate\n+            boost::multi_index::ordered_non_unique<\n+                boost::multi_index::identity<CTxMemPoolEntry>,\n+                CompareTxMemPoolEntryByFee\n+            >\n+        >\n+    > indexed_transaction_set;\n+\n     mutable CCriticalSection cs;\n-    std::map<uint256, CTxMemPoolEntry> mapTx;\n+    indexed_transaction_set mapTx;\n+    typedef indexed_transaction_set::iterator txiter;\n+    struct CompareIteratorByHash {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39649035",
      "id" : 39649035,
      "original_commit_id" : "38e9d0da46004e76dddb4021bfd9e66ad21ec001",
      "original_position" : 258,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39649035",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39649355"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39649355"
         }
      },
      "body" : "needs LOCK(cs)?",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-16T16:04:53Z",
      "diff_hunk" : "@@ -429,5 +758,58 @@ bool CCoinsViewMemPool::HaveCoins(const uint256 &txid) const {\n \n size_t CTxMemPool::DynamicMemoryUsage() const {\n     LOCK(cs);\n-    return memusage::DynamicUsage(mapTx) + memusage::DynamicUsage(mapNextTx) + memusage::DynamicUsage(mapDeltas) + cachedInnerUsage;\n+    // Estimate the overhead of mapTx to be 9 pointers + an allocation, as no exact formula for boost::multi_index_contained is implemented.\n+    return memusage::MallocUsage(sizeof(CTxMemPoolEntry) + 9 * sizeof(void*)) * mapTx.size() + memusage::DynamicUsage(mapNextTx) + memusage::DynamicUsage(mapDeltas) + memusage::DynamicUsage(mapLinks) + cachedInnerUsage;\n+}\n+\n+void CTxMemPool::RemoveStaged(setEntries &stage) {\n+    UpdateForRemoveFromMempool(stage);\n+    BOOST_FOREACH(const txiter& it, stage) {\n+        removeUnchecked(it);\n+    }\n+}\n+\n+bool CTxMemPool::addUnchecked(const uint256&hash, const CTxMemPoolEntry &entry, bool fCurrentEstimate)\n+{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39649355",
      "id" : 39649355,
      "original_commit_id" : "38e9d0da46004e76dddb4021bfd9e66ad21ec001",
      "original_position" : 582,
      "path" : "src/txmempool.cpp",
      "position" : 584,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39649355",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39649424"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39649424"
         }
      },
      "body" : "Needs LOCK(cs) if ever called from somewhere else.",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-16T16:05:24Z",
      "diff_hunk" : "@@ -429,5 +758,58 @@ bool CCoinsViewMemPool::HaveCoins(const uint256 &txid) const {\n \n size_t CTxMemPool::DynamicMemoryUsage() const {\n     LOCK(cs);\n-    return memusage::DynamicUsage(mapTx) + memusage::DynamicUsage(mapNextTx) + memusage::DynamicUsage(mapDeltas) + cachedInnerUsage;\n+    // Estimate the overhead of mapTx to be 9 pointers + an allocation, as no exact formula for boost::multi_index_contained is implemented.\n+    return memusage::MallocUsage(sizeof(CTxMemPoolEntry) + 9 * sizeof(void*)) * mapTx.size() + memusage::DynamicUsage(mapNextTx) + memusage::DynamicUsage(mapDeltas) + memusage::DynamicUsage(mapLinks) + cachedInnerUsage;\n+}\n+\n+void CTxMemPool::RemoveStaged(setEntries &stage) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39649424",
      "id" : 39649424,
      "original_commit_id" : "38e9d0da46004e76dddb4021bfd9e66ad21ec001",
      "original_position" : 574,
      "path" : "src/txmempool.cpp",
      "position" : 575,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39649424",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39649501"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39649501"
         }
      },
      "body" : "Needs LOCK(cs)",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-16T16:06:08Z",
      "diff_hunk" : "@@ -48,6 +46,243 @@ CTxMemPoolEntry::GetPriority(unsigned int currentHeight) const\n     return dResult;\n }\n \n+// Update the given tx for any in-mempool descendants.\n+// Assumes that setMemPoolChildren is correct for the given tx and all\n+// descendants.\n+bool CTxMemPool::UpdateForDescendants(txiter updateIt, int maxDescendantsToVisit, cacheMap &cachedDescendants, const std::set<uint256> &setExclude)\n+{\n+    // Track the number of entries (outside setExclude) that we'd need to visit\n+    // (will bail out if it exceeds maxDescendantsToVisit)\n+    int nChildrenToVisit = 0;\n+\n+    setEntries stageEntries, setAllDescendants;\n+    stageEntries = GetMemPoolChildren(updateIt);\n+\n+    while (!stageEntries.empty()) {\n+        const txiter cit = *stageEntries.begin();\n+        if (cit->IsDirty()) {\n+            // Don't consider any more children if any descendant is dirty\n+            return false;\n+        }\n+        setAllDescendants.insert(cit);\n+        stageEntries.erase(cit);\n+        const setEntries &setChildren = GetMemPoolChildren(cit);\n+        BOOST_FOREACH(const txiter childEntry, setChildren) {\n+            cacheMap::iterator cacheIt = cachedDescendants.find(childEntry);\n+            if (cacheIt != cachedDescendants.end()) {\n+                // We've already calculated this one, just add the entries for this set\n+                // but don't traverse again.\n+                BOOST_FOREACH(const txiter cacheEntry, cacheIt->second) {\n+                    // update visit count only for new child transactions\n+                    // (outside of setExclude and stageEntries)\n+                    if (setAllDescendants.insert(cacheEntry).second &&\n+                            !setExclude.count(cacheEntry->GetTx().GetHash()) &&\n+                            !stageEntries.count(cacheEntry)) {\n+                        nChildrenToVisit++;\n+                    }\n+                }\n+            } else if (!setAllDescendants.count(childEntry)) {\n+                // Schedule for later processing and update our visit count\n+                if (stageEntries.insert(childEntry).second && !setExclude.count(childEntry->GetTx().GetHash())) {\n+                        nChildrenToVisit++;\n+                }\n+            }\n+            if (nChildrenToVisit > maxDescendantsToVisit) {\n+                return false;\n+            }\n+        }\n+    }\n+    // setAllDescendants now contains all in-mempool descendants of updateIt.\n+    // Update and add to cached descendant map\n+    int64_t modifySize = 0;\n+    CAmount modifyFee = 0;\n+    int64_t modifyCount = 0;\n+    BOOST_FOREACH(txiter cit, setAllDescendants) {\n+        if (!setExclude.count(cit->GetTx().GetHash())) {\n+            modifySize += cit->GetTxSize();\n+            modifyFee += cit->GetFee();\n+            modifyCount++;\n+            cachedDescendants[updateIt].insert(cit);\n+        }\n+    }\n+    mapTx.modify(updateIt, update_descendant_state(modifySize, modifyFee, modifyCount));\n+    return true;\n+}\n+\n+// vHashesToUpdate is the set of transaction hashes from a disconnected block\n+// which has been re-added to the mempool.\n+// for each entry, look for descendants that are outside hashesToUpdate, and\n+// add fee/size information for such descendants to the parent.\n+void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashesToUpdate)\n+{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39649501",
      "id" : 39649501,
      "original_commit_id" : "38e9d0da46004e76dddb4021bfd9e66ad21ec001",
      "original_position" : 96,
      "path" : "src/txmempool.cpp",
      "position" : 96,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39649501",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39650632"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39650632"
         }
      },
      "body" : "oops, `setEntries` needs to be public, the rest can be private though.",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-16T16:15:40Z",
      "diff_hunk" : "@@ -99,8 +285,43 @@ class CTxMemPool\n     uint64_t cachedInnerUsage; //! sum of dynamic memory usage of all the map elements (NOT the maps themselves)\n \n public:\n+    typedef boost::multi_index_container<\n+        CTxMemPoolEntry,\n+        boost::multi_index::indexed_by<\n+            // sorted by txid\n+            boost::multi_index::ordered_unique<mempoolentry_txid>,\n+            // sorted by fee rate\n+            boost::multi_index::ordered_non_unique<\n+                boost::multi_index::identity<CTxMemPoolEntry>,\n+                CompareTxMemPoolEntryByFee\n+            >\n+        >\n+    > indexed_transaction_set;\n+\n     mutable CCriticalSection cs;\n-    std::map<uint256, CTxMemPoolEntry> mapTx;\n+    indexed_transaction_set mapTx;\n+    typedef indexed_transaction_set::iterator txiter;\n+    struct CompareIteratorByHash {\n+        bool operator()(const txiter &a, const txiter &b) const {\n+            return a->GetTx().GetHash() < b->GetTx().GetHash();\n+        }\n+    };\n+    typedef std::set<txiter, CompareIteratorByHash> setEntries;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39650632",
      "id" : 39650632,
      "original_commit_id" : "38e9d0da46004e76dddb4021bfd9e66ad21ec001",
      "original_position" : 263,
      "path" : "src/txmempool.h",
      "position" : 263,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39650632",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39914366"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39914366"
         }
      },
      "body" : "You can also AssertLockHeld(cs), otherwise, to make things more readable.\n\nOn September 16, 2015 11:05:34 AM CDT, Alex Morcos <notifications@github.com> wrote:\n>> @@ -429,5 +758,58 @@ bool CCoinsViewMemPool::HaveCoins(const uint256\n>&txid) const {\n>>  \n>>  size_t CTxMemPool::DynamicMemoryUsage() const {\n>>      LOCK(cs);\n>> -    return memusage::DynamicUsage(mapTx) +\n>memusage::DynamicUsage(mapNextTx) + memusage::DynamicUsage(mapDeltas) +\n>cachedInnerUsage;\n>> +    // Estimate the overhead of mapTx to be 9 pointers + an\n>allocation, as no exact formula for boost::multi_index_contained is\n>implemented.\n>> +    return memusage::MallocUsage(sizeof(CTxMemPoolEntry) + 9 *\n>sizeof(void*)) * mapTx.size() + memusage::DynamicUsage(mapNextTx) +\n>memusage::DynamicUsage(mapDeltas) + memusage::DynamicUsage(mapLinks) +\n>cachedInnerUsage;\n>> +}\n>> +\n>> +void CTxMemPool::RemoveStaged(setEntries &stage) {\n>\n>Needs LOCK(cs) if ever called from somewhere else.\n>\n>---\n>Reply to this email directly or view it on GitHub:\n>https://github.com/bitcoin/bitcoin/pull/6654/files#r39649424\n",
      "commit_id" : "5add7a74a672cb12b0a2a630d318d9bc64dd0f77",
      "created_at" : "2015-09-19T01:23:30Z",
      "diff_hunk" : "@@ -429,5 +758,58 @@ bool CCoinsViewMemPool::HaveCoins(const uint256 &txid) const {\n \n size_t CTxMemPool::DynamicMemoryUsage() const {\n     LOCK(cs);\n-    return memusage::DynamicUsage(mapTx) + memusage::DynamicUsage(mapNextTx) + memusage::DynamicUsage(mapDeltas) + cachedInnerUsage;\n+    // Estimate the overhead of mapTx to be 9 pointers + an allocation, as no exact formula for boost::multi_index_contained is implemented.\n+    return memusage::MallocUsage(sizeof(CTxMemPoolEntry) + 9 * sizeof(void*)) * mapTx.size() + memusage::DynamicUsage(mapNextTx) + memusage::DynamicUsage(mapDeltas) + memusage::DynamicUsage(mapLinks) + cachedInnerUsage;\n+}\n+\n+void CTxMemPool::RemoveStaged(setEntries &stage) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#discussion_r39914366",
      "id" : 39914366,
      "original_commit_id" : "38e9d0da46004e76dddb4021bfd9e66ad21ec001",
      "original_position" : 574,
      "path" : "src/txmempool.cpp",
      "position" : 575,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6654",
      "updated_at" : "2015-09-19T17:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/39914366",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "My computer's battery died, but in txmempool.h, the definition of txiter as \"boost::multi_index_container::iterator\" is \"implementation defined\" according to boost's docs. In the latest versions it is defined to an equivalent of \"boost::multi_index_container::nth_index<0>::type::iterator\", so you should use that.\n\nOn September 16, 2015 8:44:26 AM CDT, Suhas Daftuar <notifications@github.com> wrote:\n>Thanks everyone for reviewing!  I've pushed up a series of commits to\n>address everyone's feedback; I believe all comments should have been\n>addressed.\n>\n>These cleanups need to be squashed, and this pull now needs to be\n>rebased (a merge conflict crept in now that I'm outputting additional\n>information in getrawmempool).  Reviewers -- please let me know if you\n>prefer I leave these commits unsquashed/unrebased so you can review the\n>changes.  (In the absence of any expressed preferences, I'll plan to\n>squash/rebase in a day or two so that this can become mergeable.)\n>\n>@petertodd I added the extra information to the getrawmempool RPC call\n>(good idea!).  Now that the RPC call is there, I realized that adding\n>an RPC test that exercises the new limits is a good idea, so I've\n>started work on that, but it's not yet complete.\n>\n>---\n>Reply to this email directly or view it on GitHub:\n>https://github.com/bitcoin/bitcoin/pull/6654#issuecomment-140746438\n",
      "created_at" : "2015-09-19T01:23:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#issuecomment-141606429",
      "id" : 141606429,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6654",
      "updated_at" : "2015-09-19T01:23:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/141606429",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/649246?v=3",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "body" : "@sdaftuar needs rebase.",
      "created_at" : "2015-09-19T03:04:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#issuecomment-141613695",
      "id" : 141613695,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6654",
      "updated_at" : "2015-09-19T03:04:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/141613695",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=3",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "body" : "I addressed the latest comments from @morcos and @TheBlueMatt, added an rpc test (it only tests the ancestor/descendant length limits, not the size limits, nor the handling of reorgs -- so that still can be improved), and then squashed everything down and rebased on master to get rid of the merge conflict in ```rpcblockchain.cpp```.",
      "created_at" : "2015-09-19T17:40:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#issuecomment-141692820",
      "id" : 141692820,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6654",
      "updated_at" : "2015-09-19T17:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/141692820",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=3",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "body" : "Does anyone else think the ancestor limit is way to generous? In what other case than spamming do txs have 100 ancestors in mempool? Shouldn't 5 be enough?",
      "created_at" : "2015-09-19T18:39:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#issuecomment-141696711",
      "id" : 141696711,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6654",
      "updated_at" : "2015-09-19T18:39:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/141696711",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13236924?v=3",
         "events_url" : "https://api.github.com/users/Mirobit/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Mirobit/followers",
         "following_url" : "https://api.github.com/users/Mirobit/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Mirobit/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Mirobit",
         "id" : 13236924,
         "login" : "Mirobit",
         "organizations_url" : "https://api.github.com/users/Mirobit/orgs",
         "received_events_url" : "https://api.github.com/users/Mirobit/received_events",
         "repos_url" : "https://api.github.com/users/Mirobit/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Mirobit/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Mirobit/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Mirobit"
      }
   },
   {
      "body" : "@Mirobit The limits are there to limit computational costs in determining things like dependent fees/size etc. There's no need to set them low unless the algorithms take a long time to compute those sums; the data structures in the mempool are mainly pointer following so it's fairly fast.",
      "created_at" : "2015-09-20T00:53:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#issuecomment-141723288",
      "id" : 141723288,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6654",
      "updated_at" : "2015-09-20T00:53:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/141723288",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7042?v=3",
         "events_url" : "https://api.github.com/users/petertodd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/petertodd/followers",
         "following_url" : "https://api.github.com/users/petertodd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/petertodd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/petertodd",
         "id" : 7042,
         "login" : "petertodd",
         "organizations_url" : "https://api.github.com/users/petertodd/orgs",
         "received_events_url" : "https://api.github.com/users/petertodd/received_events",
         "repos_url" : "https://api.github.com/users/petertodd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/petertodd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/petertodd"
      }
   },
   {
      "body" : "utACK",
      "created_at" : "2015-09-21T12:26:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#issuecomment-141957549",
      "id" : 141957549,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6654",
      "updated_at" : "2015-09-21T12:26:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/141957549",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "My node running 5add7a7 with -checkmempool crashed. Last debug.log message was:\r\n```\r\n2015-09-22 13:06:19 - Disconnect block: 90.04ms\r\n```\r\n",
      "created_at" : "2015-09-22T16:47:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#issuecomment-142345556",
      "id" : 142345556,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6654",
      "updated_at" : "2015-09-22T16:47:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/142345556",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=3",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "body" : "@sipa can you give us some more details?  were you running will all -debug options?  for instance I assume you were not running with estimatefee debugging?   it helps to narrow down where it crashed based on what didn't get printed to the debug log.",
      "created_at" : "2015-09-22T17:13:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6654#issuecomment-142352916",
      "id" : 142352916,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6654",
      "updated_at" : "2015-09-22T17:13:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/142352916",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4360349?v=3",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   }
]
