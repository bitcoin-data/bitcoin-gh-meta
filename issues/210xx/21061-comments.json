[
   {
      "author_association" : "MEMBER",
      "body" : "## Future work \r\nto be addressed either in this PR or a follow up: \r\n- persist rebroadcast attempt tracker to disk\r\n- remove wallet dependency for `p2p_rebroadcast.py` \r\n\r\n## Merge Plan & Next Steps:\r\nAll of the functionality in this PR is hidden behind a configuration switch that defaults to off, and the wallet rebroadcast logic is currently untouched. The idea is to make these changes as safe as possible to merge into master, and allow reviewers to easily enable and observe the new rebroadcast mechanism in todayâs network conditions. \r\n\r\nIf we build confidence that these changes are safe and desirable, we can default enable this new node rebroadcast logic and disable the legacy wallet rebroadcast logic. This is the desired end goal. \r\n\r\n## Project History: \r\nA version of these changes were originally proposed in #16698. \r\n\r\n#18038 broke out a subset of the functionality, enabling the node to provide a guarantee around minimal initial broadcast & reducing the frequency of the existing wallet rebroadcast functionality (unbroadcast set) \r\n\r\nSince #16698, there have been some changes in approach, and all of the unbroadcast conversation is no longer relevant. So, to help with review, I've decided to open a new PR. To preserve the relevant feedback and concerns, I've tried my best to capture the history of conversations in the following write-up: https://github.com/amitiuttarwar/bitcoin-notes/blob/main/rebroadcast-history.md. warning: it goes quite in depth.\r\n\r\n\r\nðð½ Huge shout out to the village of core contributors who have provided feedback & guidance on this project so far. Honestly too many to name, but this project is much better for it. Thank you :) \r\n",
      "created_at" : "2021-02-02T07:23:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-771426879",
      "id" : 771426879,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3MTQyNjg3OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-16T20:14:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/771426879",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21866 ([Bundle 7/7] validation: Farewell, global Chainstate! by dongcarl)\n* #21789 (refactor: Remove ::Params() global from CChainState by MarcoFalke)\n* #21562 ([net processing] Various tidying up of PeerManagerImpl ctor by jnewbery)\n* #21526 (validation: UpdateTip/CheckBlockIndex assumeutxo support by jamesob)\n* #17580 (refactor: Add ALLOW_LIST flags and enforce usage in CheckArgFlags by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-02-02T08:05:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-771448221",
      "id" : 771448221,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3MTQ0ODIyMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-11T07:17:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/771448221",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "marking as draft until I resolve CI issues",
      "created_at" : "2021-02-03T03:32:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-772195305",
      "id" : 772195305,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3MjE5NTMwNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-03T03:32:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/772195305",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r572243729"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572243729"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm importing this file so I can use the default key extractors in the `indexed_rebroadcast_set` multi_index: 1. https://github.com/bitcoin/bitcoin/pull/21061/files#diff-eccf6b88ae8b612dbdbdb92c110b66e4e7e3ffa665ccdc1acf08093aadc66b82R49 2. https://github.com/bitcoin/bitcoin/pull/21061/files#diff-eccf6b88ae8b612dbdbdb92c110b66e4e7e3ffa665ccdc1acf08093aadc66b82R55\r\n\r\nThe contents of the boost header file can be found [here](https://www.boost.org/doc/libs/1_71_0/boost/multi_index/member.hpp).\r\n\r\nIf we'd rather not import another boost header, I can avoid by writing custom key extractors.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-02-08T17:44:59Z",
      "diff_hunk" : "@@ -57,6 +57,7 @@ EXPECTED_BOOST_INCLUDES=(\n     boost/filesystem.hpp\n     boost/filesystem/fstream.hpp\n     boost/multi_index/hashed_index.hpp\n+    boost/multi_index/member.hpp",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r572243729",
      "id" : 572243729,
      "line" : 60,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjI0MzcyOQ==",
      "original_commit_id" : "3766479d7924358f9c3b0d53fca1ca2e218e66fb",
      "original_line" : 60,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/lint/lint-includes.sh",
      "position" : 4,
      "pull_request_review_id" : 585760946,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572243729",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased master, added a functional test, some small fixups. \r\n\r\nthis PR is ready for review! ð",
      "created_at" : "2021-02-10T02:44:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-776398956",
      "id" : 776398956,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NjM5ODk1Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-10T02:44:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/776398956",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r574281895"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574281895"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think it's fine to add a boost multi_index header dependency, it's the only submodule of boost that we really need and for which there is no replacement on the horizon. So just use what you need IMO, re-implementing anything from multi-index without a good plan would be a waste of time, I think. ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-02-11T06:58:44Z",
      "diff_hunk" : "@@ -57,6 +57,7 @@ EXPECTED_BOOST_INCLUDES=(\n     boost/filesystem.hpp\n     boost/filesystem/fstream.hpp\n     boost/multi_index/hashed_index.hpp\n+    boost/multi_index/member.hpp",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r574281895",
      "id" : 574281895,
      "in_reply_to_id" : 572243729,
      "line" : 60,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDI4MTg5NQ==",
      "original_commit_id" : "3766479d7924358f9c3b0d53fca1ca2e218e66fb",
      "original_line" : 60,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/lint/lint-includes.sh",
      "position" : 4,
      "pull_request_review_id" : 588280404,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574281895",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-02-16T20:20:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-780093975",
      "id" : 780093975,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MDA5Mzk3NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-16T20:20:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/780093975",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2021-02-16T20:27:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-780097794",
      "id" : 780097794,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MDA5Nzc5NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-16T20:27:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/780097794",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased to include #21121",
      "created_at" : "2021-02-17T23:29:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-780922203",
      "id" : 780922203,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MDkyMjIwMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-17T23:29:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/780922203",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This seems like a big win, both for privacy and for quality of service. There are a lot of nodes out there with larger-than-default mempools, and if this were the default, they would serve as reservoirs for transactions that were dropped from the default mempool, eventually rebroadcasting them when they noticed that they had a chance of getting confirmed. This would save users from sometimes having to manually intervene to unstick stuck transactions.\r\n\r\nIt might be a good idea to log whenever this logic kicks in and rebroadcast transactions. Perhaps just the number of transactions that it's rebroadcasting, i.e. `Rebroadcasting 23 transactions`, and maybe also the individual transaction IDs.\r\n\r\nI'd like to run this code on mainnet, and having logging statements would be very helpful for tracking how it actually behaves.",
      "created_at" : "2021-02-28T00:52:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-787211962",
      "id" : 787211962,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4NzIxMTk2Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-28T00:52:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/787211962",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1945?v=4",
         "events_url" : "https://api.github.com/users/casey/events{/privacy}",
         "followers_url" : "https://api.github.com/users/casey/followers",
         "following_url" : "https://api.github.com/users/casey/following{/other_user}",
         "gists_url" : "https://api.github.com/users/casey/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/casey",
         "id" : 1945,
         "login" : "casey",
         "node_id" : "MDQ6VXNlcjE5NDU=",
         "organizations_url" : "https://api.github.com/users/casey/orgs",
         "received_events_url" : "https://api.github.com/users/casey/received_events",
         "repos_url" : "https://api.github.com/users/casey/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/casey/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/casey/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/casey"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Can you help do this\n\nOn Sun, 28 Feb 2021, 11:55 Casey Rodarmor, <notifications@github.com> wrote:\n\n> This seems like a big win, both for privacy and for quality of service.\n> There are a lot of nodes out there with larger-than-default mempools, and\n> if this were the default, they would serve as reservoirs for transactions\n> that were dropped from the default mempool, eventually rebroadcasting them\n> when they noticed that they had a chance of getting confirmed. This would\n> save users from sometimes having to manually intervene to unstick stuck\n> transactions.\n>\n> It might be a good idea to log whenever this logic kicks in and\n> rebroadcast transactions. Perhaps just the number of transactions that it's\n> rebroadcasting, i.e. Rebroadcasting 23 transactions, and maybe also the\n> individual transaction IDs.\n>\n> I'd like to run this code on mainnet, and having logging statements would\n> be very helpful for tracking how it actually behaves.\n>\n> â\n> You are receiving this because you are subscribed to this thread.\n> Reply to this email directly, view it on GitHub\n> <https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-787211962>,\n> or unsubscribe\n> <https://github.com/notifications/unsubscribe-auth/ATAD2EYMMKQOW2CLWSDRZNLTBGH6LANCNFSM4W5YT4HA>\n> .\n>\n",
      "created_at" : "2021-02-28T00:57:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-787212349",
      "id" : 787212349,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4NzIxMjM0OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-28T00:57:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/787212349",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/79707411?v=4",
         "events_url" : "https://api.github.com/users/schuie2528/events{/privacy}",
         "followers_url" : "https://api.github.com/users/schuie2528/followers",
         "following_url" : "https://api.github.com/users/schuie2528/following{/other_user}",
         "gists_url" : "https://api.github.com/users/schuie2528/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/schuie2528",
         "id" : 79707411,
         "login" : "schuie2528",
         "node_id" : "MDQ6VXNlcjc5NzA3NDEx",
         "organizations_url" : "https://api.github.com/users/schuie2528/orgs",
         "received_events_url" : "https://api.github.com/users/schuie2528/received_events",
         "repos_url" : "https://api.github.com/users/schuie2528/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/schuie2528/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/schuie2528/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/schuie2528"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@casey thanks for taking a look! \r\n\r\nThe current code does have some logging, the most relevant statement firing here: https://github.com/bitcoin/bitcoin/pull/21061/files?file-filters%5B%5D=.cpp&file-filters%5B%5D=.h&file-filters%5B%5D=.py&file-filters%5B%5D=.sh#diff-7dff50848db96bdb8edffc4d21daeca6d9050ec0e67d96072780ea5751e7df06R90. This prints the transactions hashes where a rebroadcast will be attempted for all peers. Those candidates will go through additional per-peer filters (see SendMessages code that copies `setInventoryTxToSend` and `filterInventoryKnown`), so might not actually make it to every peer, but should be sufficient signal for us to monitor the frequency of rebroadcast. \r\n\r\nI've also added logs to monitor how long it takes to calculate rebroadcast blocks. The logs are all in the `NET` & `BENCH` categories. I'm currently running a node with this patch, but I'd love to gather more data so It'd be helpful if you are willing to run the patch and share your findings. \r\n\r\nSo far, I ran a node for 1 week with default mempool settings & 0 transactions were selected for rebroadcast. That seems reasonable. I'm now running a node with a larger mempool, and also want to tinker with making low fee rate wallet transactions to monitor node rebroadcast logic.\r\n\r\nIf you've intended to request more logging than what's currently there, I'm open to suggestions. ",
      "created_at" : "2021-02-28T22:17:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-787533629",
      "id" : 787533629,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4NzUzMzYyOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-28T22:17:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/787533629",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> The current code does have some logging, the most relevant statement firing here:\r\n\r\nAh, excellent! I was looking where the transactions are actually rebroadcast, so I missed that. What's there looks good, I can't think of anything else I'd want.\r\n\r\n> â¦but I'd love to gather more data so It'd be helpful if you are willing to run the patch and share your findings.\r\n\r\nI was thinking about running a node with a very large max mempool size, as well as no mempool expiration time, to try to maximize transaction rebroadcasting. (Those are the only two settings I can think of that would affect this, but let me know if you can think of others.) I'll definitely share the logs if I wind up doing this!",
      "created_at" : "2021-03-01T06:09:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-787673640",
      "id" : 787673640,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4NzY3MzY0MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-01T06:09:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/787673640",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1945?v=4",
         "events_url" : "https://api.github.com/users/casey/events{/privacy}",
         "followers_url" : "https://api.github.com/users/casey/followers",
         "following_url" : "https://api.github.com/users/casey/following{/other_user}",
         "gists_url" : "https://api.github.com/users/casey/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/casey",
         "id" : 1945,
         "login" : "casey",
         "node_id" : "MDQ6VXNlcjE5NDU=",
         "organizations_url" : "https://api.github.com/users/casey/orgs",
         "received_events_url" : "https://api.github.com/users/casey/received_events",
         "repos_url" : "https://api.github.com/users/casey/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/casey/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/casey/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/casey"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@casey \r\n\r\n> I was thinking about running a node with a very large max mempool size, as well as no mempool expiration time, to try to maximize transaction rebroadcasting\r\n\r\nyup, that's exactly what I did, I also minimized the `feefilter` and `minrelaytxfee` to ensure I'd get all the transactions. \r\n\r\n> I'll definitely share the logs if I wind up doing this!\r\n\r\nsounds good, thanks :) ",
      "created_at" : "2021-03-02T05:15:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-788594423",
      "id" : 788594423,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4ODU5NDQyMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-02T05:15:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/788594423",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased",
      "created_at" : "2021-03-04T22:27:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-790989016",
      "id" : 790989016,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MDk4OTAxNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-04T22:27:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/790989016",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-03-11T12:46:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-796710682",
      "id" : 796710682,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5NjcxMDY4Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-11T12:46:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/796710682",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased",
      "created_at" : "2021-03-11T23:34:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-797121429",
      "id" : 797121429,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5NzEyMTQyOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-11T23:34:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/797121429",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Motivation and PR overview looks interesting. Couldn't compile though. Maybe I should have checked CI results.\r\n\r\n![image](https://user-images.githubusercontent.com/13405205/110874750-525a0c00-82fa-11eb-9a14-e632f0084574.png)\r\n\r\n\r\n",
      "created_at" : "2021-03-12T00:45:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-797153844",
      "id" : 797153844,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5NzE1Mzg0NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-12T00:45:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/797153844",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@prayank23 Thanks for taking a look. I missed the tests in a recent rebase. It should be fixed now",
      "created_at" : "2021-03-12T18:39:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-797676411",
      "id" : 797676411,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5NzY3NjQxMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-12T18:39:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/797676411",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK. Have few questions about the approach and will mention them below. Compiled successfully on Ubuntu. Tests passed.\r\n\r\n> Conceptually, we want to rebroadcast transactions that we believe âshouldâ have been mined by now.\r\n\r\nNot sure about this part. Can we randomly rebroadcast different transactions to make it difficult for spy nodes to notice any pattern?\r\n\r\nI used below `bitcoin.conf`:\r\n```\r\ntestnet=1\r\nrebroadcast=1\r\ndebug=1\r\n```\r\n\r\nHad 1 incoming and 1 outgoing transaction pending associated with my wallet (segwit,rbf,1sat/vB). Node was connected to 10 peers.\r\n\r\n![image](https://user-images.githubusercontent.com/13405205/111013015-f22f9c80-83c3-11eb-9183-76d8d62f66f5.png)\r\n\r\nStill trying to understand if I can find something relevant in logs. Only one line related to `rebroadcast`:\r\n\r\n`2021-03-13T00:34:03Z Caching minimum fee for rebroadcast to 1.000 sat/vB, took 122 Âµs to calculate.`\r\n\r\n> After we process a block, invoke the rebroadcast module to identify if there\r\nare any transactions we would have expected to be included, and queue them up\r\nfor relay to our peers.\r\n\r\nMaybe it couldn't find any transactions that should be rebroadcasted based on fee rate and other things.\r\n\r\n> In order to prevent spam, we need to carefully select which transactions to rebroadcast. As of this commit, we select the transactions in the mempool that have the highest feerate.\r\n\r\nCan you explain the SPAM part mentioned in https://github.com/bitcoin/bitcoin/pull/21061/commits/b86f6d90a844dd71008f7c8a5fb92a1ac8673891? \r\n\r\nChecked unit tests and functional test included in this PR. It would be helpful if you can suggest more ways to experiment with `rebroadcast` and check different things? \r\n\r\n",
      "created_at" : "2021-03-13T00:58:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-797836751",
      "id" : 797836751,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5NzgzNjc1MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-14T21:51:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/797836751",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r593968023"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/593968023"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Any reasons for 30 minutes? Less than 30 minutes might have issues. What if we use more than 30 minutes or user can define this in `bitcoin.conf`?",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-14T22:03:37Z",
      "diff_hunk" : "@@ -7,17 +7,22 @@\n #include <miner.h>\n #include <script/script.h>\n #include <txrebroadcast.h>\n+#include <util/time.h>\n \n /** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n  *  such as miners mining priority transactions. */\n static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\n \n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE = 30min;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r593968023",
      "id" : 593968023,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5Mzk2ODAyMw==",
      "original_commit_id" : "24e7415aeb248f5df3ca3492d5a6b75a213f978d",
      "original_line" : 24,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 611742673,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/593968023",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r594660140"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594660140"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Prefer default initialization when a member will always be initialized to the same value.\r\n\r\n```suggestion\r\n    int m_count{1};\r\n```\r\n\r\nAnd remove `m_count` from the initializer list.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-15T20:27:25Z",
      "diff_hunk" : "@@ -0,0 +1,95 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXREBROADCAST_H\n+#define BITCOIN_TXREBROADCAST_H\n+\n+#include <policy/feerate.h>\n+#include <tuple>\n+#include <txmempool.h>\n+#include <util/hasher.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+struct TxIds {\n+    TxIds(uint256 txid, uint256 wtxid) : m_txid(txid), m_wtxid(wtxid) {}\n+\n+    const uint256 m_txid;\n+    const uint256 m_wtxid;\n+};\n+\n+struct RebroadcastEntry {\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\n+        : m_last_attempt(now_time),\n+          m_wtxid(wtxid),\n+          m_count(1) {}\n+\n+    std::chrono::microseconds m_last_attempt;\n+    const uint256 m_wtxid;\n+    int m_count;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r594660140",
      "id" : 594660140,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDY2MDE0MA==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 35,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.h",
      "position" : null,
      "pull_request_review_id" : 612614556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594660140",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r594661183"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594661183"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this is unused.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-15T20:28:58Z",
      "diff_hunk" : "@@ -0,0 +1,95 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXREBROADCAST_H\n+#define BITCOIN_TXREBROADCAST_H\n+\n+#include <policy/feerate.h>\n+#include <tuple>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r594661183",
      "id" : 594661183,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDY2MTE4Mw==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 9,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.h",
      "position" : null,
      "pull_request_review_id" : 612614556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594661183",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r594666637"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594666637"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It seems unnecessary to define a type here. `GetRebroadcastTransactions()` could just return a vector of std::pairs, and the one caller (`UpdatedBlockTip()`) can unpack that vector of pairs using :sparkle: s t r u c t u t e d :sparkle: b i n d i n g s :sparkle:. Here's what the caller would look like:\r\n\r\n```diff\r\ndiff --git a/src/net_processing.cpp b/src/net_processing.cpp\r\nindex 7811e3ca40..e5a425b4c1 100644\r\n--- a/src/net_processing.cpp\r\n+++ b/src/net_processing.cpp\r\n@@ -1393,12 +1393,12 @@ void PeerManagerImpl::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlock\r\n \r\n     // Rebroadcast selected mempool transactions\r\n     if (gArgs.GetArg(\"-rebroadcast\", DEFAULT_REBROADCAST_ENABLED)) {\r\n-        std::vector<TxIds> rebroadcast_txs = m_txrebroadcast.GetRebroadcastTransactions();\r\n+        auto rebroadcast_txs = m_txrebroadcast.GetRebroadcastTransactions();\r\n \r\n         LOCK(cs_main);\r\n \r\n-        for (auto ids : rebroadcast_txs) {\r\n-            RelayTransaction(ids.m_txid, ids.m_wtxid, m_connman);\r\n+        for (auto [txid, wtxid] : rebroadcast_txs) {\r\n+            RelayTransaction(txid, wtxid, m_connman);\r\n         }\r\n     }\r\n```\r\n\r\nThat client code works whether you return a vector of `TxIds` or a vector of `std::pair<uint256, uint256>>`s (which is as it should be :slightly_smiling_face: )",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-15T20:38:08Z",
      "diff_hunk" : "@@ -0,0 +1,95 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXREBROADCAST_H\n+#define BITCOIN_TXREBROADCAST_H\n+\n+#include <policy/feerate.h>\n+#include <tuple>\n+#include <txmempool.h>\n+#include <util/hasher.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+struct TxIds {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r594666637",
      "id" : 594666637,
      "line" : 15,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDY2NjYzNw==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 15,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.h",
      "position" : 15,
      "pull_request_review_id" : 612614556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594666637",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r594670252"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594670252"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps make this a unique_ptr, and then pass in a boolean to the PeerManagerImpl ctor to indicate whether you want to enable tx rebroadcast and initialize the pointer.\r\n\r\nThen, in `UpdatedBlockTip`:\r\n\r\n```diff\r\ndiff --git a/src/net_processing.cpp b/src/net_processing.cpp\r\nindex 7811e3ca40..8bb5e8f87f 100644\r\n--- a/src/net_processing.cpp\r\n+++ b/src/net_processing.cpp\r\n@@ -1392,8 +1392,8 @@ void PeerManagerImpl::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlock\r\n     }\r\n \r\n     // Rebroadcast selected mempool transactions\r\n-    if (gArgs.GetArg(\"-rebroadcast\", DEFAULT_REBROADCAST_ENABLED)) {\r\n-        std::vector<TxIds> rebroadcast_txs = m_txrebroadcast.GetRebroadcastTransactions();\r\n+    if (m_txrebroadcast) {\r\n+        std::vector<TxIds> rebroadcast_txs = m_txrebroadcast->GetRebroadcastTransactions();\r\n \r\n         LOCK(cs_main);\r\n```\r\n\r\nparametrizing whether the TxRebroadcastHandler is initialized avoids having to read the global args every block, and should make it the code path more obviously isolated and testable.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-15T20:44:21Z",
      "diff_hunk" : "@@ -325,6 +326,7 @@ class PeerManagerImpl final : public PeerManager\n     ChainstateManager& m_chainman;\n     CTxMemPool& m_mempool;\n     TxRequestTracker m_txrequest GUARDED_BY(::cs_main);\n+    TxRebroadcastHandler m_txrebroadcast;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r594670252",
      "id" : 594670252,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDY3MDI1Mg==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 329,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 612614556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594670252",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r594671707"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594671707"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Prefer default initialization in the declaration, rather than setting these in the ctor.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-15T20:46:39Z",
      "diff_hunk" : "@@ -53,6 +53,8 @@ void RegenerateCommitments(CBlock& block, BlockManager& blockman)\n BlockAssembler::Options::Options() {\n     blockMinFeeRate = CFeeRate(DEFAULT_BLOCK_MIN_TX_FEE);\n     nBlockMaxWeight = DEFAULT_BLOCK_MAX_WEIGHT;\n+    m_skip_inclusion_until = std::chrono::microseconds::max();\n+    check_block_validity = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r594671707",
      "id" : 594671707,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDY3MTcwNw==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 57,
      "original_position" : 5,
      "original_start_line" : 56,
      "path" : "src/miner.cpp",
      "position" : null,
      "pull_request_review_id" : 612614556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-05T05:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594671707",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r594672688"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594672688"
         }
      },
      "author_association" : "MEMBER",
      "body" : "These aren't doing anything. They already get set in the `Options` constructor.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-15T20:48:04Z",
      "diff_hunk" : "@@ -76,6 +80,9 @@ static BlockAssembler::Options DefaultOptions()\n     } else {\n         options.blockMinFeeRate = CFeeRate(DEFAULT_BLOCK_MIN_TX_FEE);\n     }\n+\n+    options.m_skip_inclusion_until = std::chrono::microseconds::max();\n+    options.check_block_validity = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r594672688",
      "id" : 594672688,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDY3MjY4OA==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 85,
      "original_position" : 24,
      "original_start_line" : 84,
      "path" : "src/miner.cpp",
      "position" : null,
      "pull_request_review_id" : 612614556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-05T05:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594672688",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r594673886"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594673886"
         }
      },
      "author_association" : "MEMBER",
      "body" : "not needed!",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-15T20:49:54Z",
      "diff_hunk" : "@@ -0,0 +1,193 @@\n+// Copyright (c) 2011-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <amount.h>\n+#include <boost/test/unit_test.hpp>\n+#include <clientversion.h>\n+#include <consensus/tx_check.h>\n+#include <consensus/validation.h>\n+#include <core_io.h>\n+#include <key_io.h>\n+#include <rpc/util.h>\n+#include <script/interpreter.h>\n+#include <script/script.h>\n+#include <streams.h>\n+#include <test/util/setup_common.h>\n+#include <tuple>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r594673886",
      "id" : 594673886,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDY3Mzg4Ng==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 17,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/test/txrebroadcast_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 612614556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594673886",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r594674279"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594674279"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Separate library imports from local project imports:\r\n\r\n```suggestion\r\n#include <boost/test/unit_test.hpp>\r\n\r\n#include <amount.h>\r\n```",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-15T20:50:31Z",
      "diff_hunk" : "@@ -0,0 +1,193 @@\n+// Copyright (c) 2011-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <amount.h>\n+#include <boost/test/unit_test.hpp>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r594674279",
      "id" : 594674279,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDY3NDI3OQ==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 6,
      "original_position" : 6,
      "original_start_line" : 5,
      "path" : "src/test/txrebroadcast_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 612614556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-05T05:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594674279",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r594677303"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594677303"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It'd be really nice to avoid including these boost headers in a header that will transitively be included in a lot of translation units. Could you hide the `indexed_rebroadcast_set` inside the .cpp file to avoid this?",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-15T20:55:29Z",
      "diff_hunk" : "@@ -0,0 +1,95 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXREBROADCAST_H\n+#define BITCOIN_TXREBROADCAST_H\n+\n+#include <policy/feerate.h>\n+#include <tuple>\n+#include <txmempool.h>\n+#include <util/hasher.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r594677303",
      "id" : 594677303,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDY3NzMwMw==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 18,
      "original_position" : 18,
      "original_start_line" : 15,
      "path" : "src/txrebroadcast.h",
      "position" : null,
      "pull_request_review_id" : 612614556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-05T05:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594677303",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r595033242"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595033242"
         }
      },
      "author_association" : "MEMBER",
      "body" : "A quick and easy way to do this is to make `indexed_rebroadcast_set` a class that inherits from the `boost::multi_index_container` template class (defined in .cpp), forward declare it in .h and make `m_attempt_tracker` a unique pointer to `indexed_rebroadcast_set`. A few other things need to be shuffled around to make that work, but here's a rough implementation:\r\n\r\n<details>\r\n<summary>Diff</summary>\r\n\r\n```diff\r\ndiff --git a/src/test/txrebroadcast_tests.cpp b/src/test/txrebroadcast_tests.cpp\r\nindex 6fdd5deb8f..d10a962ab3 100644\r\n--- a/src/test/txrebroadcast_tests.cpp\r\n+++ b/src/test/txrebroadcast_tests.cpp\r\n@@ -27,34 +27,13 @@ public:\r\n \r\n     bool CheckRecordedAttempt(uint256 txhsh, int expected_count, std::chrono::microseconds expected_timestamp)\r\n     {\r\n-        const auto it = m_attempt_tracker.find(txhsh);\r\n-        if (it == m_attempt_tracker.end()) return false;\r\n-        if (it->m_count != expected_count) return false;\r\n-\r\n-        // Check the recorded timestamp is within 2 seconds of the param passed in\r\n-        std::chrono::microseconds delta = expected_timestamp - it->m_last_attempt;\r\n-        if (delta.count() > 2) return false;\r\n-\r\n-        return true;\r\n-    };\r\n+        return TxRebroadcastHandler::CheckRecordedAttempt(txhsh, expected_count, expected_timestamp);\r\n+    }\r\n \r\n     void UpdateAttempt(uint256 txhsh, int count)\r\n     {\r\n-        auto it = m_attempt_tracker.find(txhsh);\r\n-        for (int i = 0; i < count; ++i) {\r\n-            RecordAttempt(it);\r\n-        }\r\n-    };\r\n-\r\n-    void RecordAttempt(indexed_rebroadcast_set::index<index_by_wtxid>::type::iterator& entry_it)\r\n-    {\r\n-        auto UpdateRebroadcastEntry = [](RebroadcastEntry& rebroadcast_entry) {\r\n-            rebroadcast_entry.m_last_attempt = GetTime<std::chrono::microseconds>() - 4h;\r\n-            ++rebroadcast_entry.m_count;\r\n-        };\r\n-\r\n-        m_attempt_tracker.modify(entry_it, UpdateRebroadcastEntry);\r\n-    };\r\n+        TxRebroadcastHandler::UpdateAttempt(txhsh, count);\r\n+    }\r\n \r\n     void UpdateCachedFeeRate(CFeeRate new_fee_rate)\r\n     {\r\ndiff --git a/src/txrebroadcast.cpp b/src/txrebroadcast.cpp\r\nindex 3cb9abaf69..49050c0d39 100644\r\n--- a/src/txrebroadcast.cpp\r\n+++ b/src/txrebroadcast.cpp\r\n@@ -10,6 +10,11 @@\r\n #include <txrebroadcast.h>\r\n #include <validation.h>\r\n \r\n+#include <boost/multi_index/hashed_index.hpp>\r\n+#include <boost/multi_index/member.hpp>\r\n+#include <boost/multi_index/ordered_index.hpp>\r\n+#include <boost/multi_index_container.hpp>\r\n+\r\n /** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\r\n  *  such as miners mining priority transactions. */\r\n static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\r\n@@ -30,6 +35,46 @@ static constexpr int MAX_ENTRIES = 500;\r\n /** The maximum age of an entry ~3 months */\r\n static constexpr std::chrono::hours MAX_ENTRY_AGE = std::chrono::hours(3 * 30 * 24);\r\n \r\n+/** Used for multi_index tag  */\r\n+struct index_by_last_attempt {};\r\n+\r\n+struct RebroadcastEntry {\r\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\r\n+        : m_last_attempt(now_time),\r\n+          m_wtxid(wtxid),\r\n+          m_count(1) {}\r\n+\r\n+    std::chrono::microseconds m_last_attempt;\r\n+    const uint256 m_wtxid;\r\n+    int m_count;\r\n+};\r\n+\r\n+class indexed_rebroadcast_set : public\r\n+boost::multi_index_container<\r\n+    RebroadcastEntry,\r\n+    boost::multi_index::indexed_by<\r\n+        // sorted by wtxid\r\n+        boost::multi_index::hashed_unique<\r\n+            boost::multi_index::tag<index_by_wtxid>,\r\n+            boost::multi_index::member<RebroadcastEntry, const uint256, &RebroadcastEntry::m_wtxid>,\r\n+            SaltedTxidHasher\r\n+        >,\r\n+        // sorted by last rebroadcast time\r\n+        boost::multi_index::ordered_non_unique<\r\n+            boost::multi_index::tag<index_by_last_attempt>,\r\n+            boost::multi_index::member<RebroadcastEntry, std::chrono::microseconds, &RebroadcastEntry::m_last_attempt>\r\n+        >\r\n+    >\r\n+> {};\r\n+\r\n+TxRebroadcastHandler::TxRebroadcastHandler(CTxMemPool& mempool, ChainstateManager& chainman)\r\n+    : m_attempt_tracker{std::make_unique<indexed_rebroadcast_set>()}\r\n+    , m_mempool{mempool}\r\n+    , m_chainman{chainman}\r\n+{}\r\n+\r\n+TxRebroadcastHandler::~TxRebroadcastHandler() = default;\r\n+\r\n std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\r\n {\r\n     std::vector<TxIds> rebroadcast_txs;\r\n@@ -58,12 +103,12 @@ std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\r\n \r\n         // Check if we have previously rebroadcasted, decide if we will this\r\n         // round, and if so, record the attempt.\r\n-        auto entry_it = m_attempt_tracker.find(wtxid);\r\n+        auto entry_it = m_attempt_tracker->find(wtxid);\r\n \r\n-        if (entry_it == m_attempt_tracker.end()) {\r\n+        if (entry_it == m_attempt_tracker->end()) {\r\n             // No existing entry, we will rebroadcast, so create a new one\r\n             RebroadcastEntry entry(start_time, wtxid);\r\n-            m_attempt_tracker.insert(entry);\r\n+            m_attempt_tracker->insert(entry);\r\n         } else if (entry_it->m_count >= MAX_REBROADCAST_COUNT) {\r\n             // We have already rebroadcast this transaction the maximum number\r\n             // of times permitted, so skip rebroadcasting.\r\n@@ -76,7 +121,12 @@ std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\r\n         } else {\r\n             // We have rebroadcasted this transaction before, but will try\r\n             // again now.\r\n-            RecordAttempt(entry_it);\r\n+            auto UpdateRebroadcastEntry = [](RebroadcastEntry& rebroadcast_entry) {\r\n+                rebroadcast_entry.m_last_attempt = GetTime<std::chrono::microseconds>();\r\n+                ++rebroadcast_entry.m_count;\r\n+            };\r\n+\r\n+            m_attempt_tracker->modify(entry_it, UpdateRebroadcastEntry);\r\n         }\r\n \r\n         // Add to set of rebroadcast candidates\r\n@@ -97,6 +147,32 @@ std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\r\n     return rebroadcast_txs;\r\n };\r\n \r\n+void TxRebroadcastHandler::UpdateAttempt(uint256 txhsh, int count)\r\n+{\r\n+    auto it = m_attempt_tracker->find(txhsh);\r\n+    for (int i = 0; i < count; ++i) {\r\n+        auto UpdateRebroadcastEntry = [](RebroadcastEntry& rebroadcast_entry) {\r\n+            rebroadcast_entry.m_last_attempt = GetTime<std::chrono::microseconds>() - 4h;\r\n+            ++rebroadcast_entry.m_count;\r\n+        };\r\n+\r\n+        m_attempt_tracker->modify(it, UpdateRebroadcastEntry);\r\n+    }\r\n+};\r\n+\r\n+bool TxRebroadcastHandler::CheckRecordedAttempt(uint256 txhsh, int expected_count, std::chrono::microseconds expected_timestamp)\r\n+{\r\n+    const auto it = m_attempt_tracker->find(txhsh);\r\n+    if (it == m_attempt_tracker->end()) return false;\r\n+    if (it->m_count != expected_count) return false;\r\n+\r\n+    // Check the recorded timestamp is within 2 seconds of the param passed in\r\n+    std::chrono::microseconds delta = expected_timestamp - it->m_last_attempt;\r\n+    if (delta.count() > 2) return false;\r\n+\r\n+    return true;\r\n+};\r\n+\r\n void TxRebroadcastHandler::CacheMinRebroadcastFee()\r\n {\r\n     // Update stamp of chain tip on cache run\r\n@@ -109,33 +185,23 @@ void TxRebroadcastHandler::CacheMinRebroadcastFee()\r\n     LogPrint(BCLog::BENCH, \"Caching minimum fee for rebroadcast to %s, took %d Âµs to calculate.\\n\", m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB), delta_time.count());\r\n };\r\n \r\n-void TxRebroadcastHandler::RecordAttempt(indexed_rebroadcast_set::index<index_by_wtxid>::type::iterator& entry_it)\r\n-{\r\n-    auto UpdateRebroadcastEntry = [](RebroadcastEntry& rebroadcast_entry) {\r\n-        rebroadcast_entry.m_last_attempt = GetTime<std::chrono::microseconds>();\r\n-        ++rebroadcast_entry.m_count;\r\n-    };\r\n-\r\n-    m_attempt_tracker.modify(entry_it, UpdateRebroadcastEntry);\r\n-};\r\n-\r\n void TxRebroadcastHandler::TrimMaxRebroadcast()\r\n {\r\n     // Delete any entries that are older than MAX_ENTRY_AGE\r\n     std::chrono::microseconds min_age = GetTime<std::chrono::microseconds>() - MAX_ENTRY_AGE;\r\n \r\n-    while (!m_attempt_tracker.empty()) {\r\n-        auto it = m_attempt_tracker.get<index_by_last_attempt>().begin();\r\n+    while (!m_attempt_tracker->empty()) {\r\n+        auto it = m_attempt_tracker->get<index_by_last_attempt>().begin();\r\n         if (it->m_last_attempt < min_age) {\r\n-            m_attempt_tracker.get<index_by_last_attempt>().erase(it);\r\n+            m_attempt_tracker->get<index_by_last_attempt>().erase(it);\r\n         } else {\r\n             break;\r\n         }\r\n     }\r\n \r\n     // If there are still too many entries, delete the oldest ones\r\n-    while (m_attempt_tracker.size() > MAX_ENTRIES) {\r\n-        auto it = m_attempt_tracker.get<index_by_last_attempt>().begin();\r\n-        m_attempt_tracker.get<index_by_last_attempt>().erase(it);\r\n+    while (m_attempt_tracker->size() > MAX_ENTRIES) {\r\n+        auto it = m_attempt_tracker->get<index_by_last_attempt>().begin();\r\n+        m_attempt_tracker->get<index_by_last_attempt>().erase(it);\r\n     }\r\n };\r\ndiff --git a/src/txrebroadcast.h b/src/txrebroadcast.h\r\nindex 8a176a08bc..ec3ea34ed7 100644\r\n--- a/src/txrebroadcast.h\r\n+++ b/src/txrebroadcast.h\r\n@@ -12,11 +12,6 @@\r\n #include <util/time.h>\r\n #include <validation.h>\r\n \r\n-#include <boost/multi_index/hashed_index.hpp>\r\n-#include <boost/multi_index/member.hpp>\r\n-#include <boost/multi_index/ordered_index.hpp>\r\n-#include <boost/multi_index_container.hpp>\r\n-\r\n struct TxIds {\r\n     TxIds(uint256 txid, uint256 wtxid) : m_txid(txid), m_wtxid(wtxid) {}\r\n \r\n@@ -24,43 +19,15 @@ struct TxIds {\r\n     const uint256 m_wtxid;\r\n };\r\n \r\n-struct RebroadcastEntry {\r\n-    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\r\n-        : m_last_attempt(now_time),\r\n-          m_wtxid(wtxid),\r\n-          m_count(1) {}\r\n-\r\n-    std::chrono::microseconds m_last_attempt;\r\n-    const uint256 m_wtxid;\r\n-    int m_count;\r\n-};\r\n-\r\n-/** Used for multi_index tag  */\r\n-struct index_by_last_attempt {};\r\n-\r\n-using indexed_rebroadcast_set = boost::multi_index_container<\r\n-    RebroadcastEntry,\r\n-    boost::multi_index::indexed_by<\r\n-        // sorted by wtxid\r\n-        boost::multi_index::hashed_unique<\r\n-            boost::multi_index::tag<index_by_wtxid>,\r\n-            boost::multi_index::member<RebroadcastEntry, const uint256, &RebroadcastEntry::m_wtxid>,\r\n-            SaltedTxidHasher\r\n-        >,\r\n-        // sorted by last rebroadcast time\r\n-        boost::multi_index::ordered_non_unique<\r\n-            boost::multi_index::tag<index_by_last_attempt>,\r\n-            boost::multi_index::member<RebroadcastEntry, std::chrono::microseconds, &RebroadcastEntry::m_last_attempt>\r\n-        >\r\n-    >\r\n->;\r\n+class indexed_rebroadcast_set;\r\n \r\n class TxRebroadcastHandler\r\n {\r\n public:\r\n-    TxRebroadcastHandler(CTxMemPool& mempool, ChainstateManager& chainman)\r\n-        : m_mempool(mempool),\r\n-          m_chainman(chainman){};\r\n+    TxRebroadcastHandler(CTxMemPool& mempool, ChainstateManager& chainman);\r\n+    ~TxRebroadcastHandler();\r\n+\r\n+    TxRebroadcastHandler(const TxRebroadcastHandler& other) = delete;\r\n \r\n     std::vector<TxIds> GetRebroadcastTransactions();\r\n \r\n@@ -75,10 +42,13 @@ protected:\r\n     CFeeRate m_cached_fee_rate;\r\n \r\n     /** Keep track of previous rebroadcast attempts */\r\n-    indexed_rebroadcast_set m_attempt_tracker;\r\n+    std::unique_ptr<indexed_rebroadcast_set> m_attempt_tracker;\r\n+\r\n+    /** Test only */\r\n+    void UpdateAttempt(uint256 txhsh, int count);\r\n \r\n-    /** Update an existing RebroadcastEntry - increment count and update timestamp */\r\n-    void RecordAttempt(indexed_rebroadcast_set::index<index_by_wtxid>::type::iterator& entry_it);\r\n+    /** Test only */\r\n+    bool CheckRecordedAttempt(uint256 txhsh, int expected_count, std::chrono::microseconds expected_timestamp);\r\n \r\n private:\r\n     const CTxMemPool& m_mempool;\r\n```\r\n\r\n</details>",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-16T10:20:02Z",
      "diff_hunk" : "@@ -0,0 +1,95 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXREBROADCAST_H\n+#define BITCOIN_TXREBROADCAST_H\n+\n+#include <policy/feerate.h>\n+#include <tuple>\n+#include <txmempool.h>\n+#include <util/hasher.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r595033242",
      "id" : 595033242,
      "in_reply_to_id" : 594677303,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTAzMzI0Mg==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 18,
      "original_position" : 18,
      "original_start_line" : 15,
      "path" : "src/txrebroadcast.h",
      "position" : null,
      "pull_request_review_id" : 613068719,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-05T05:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595033242",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r596515495"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/596515495"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Could keep the old cached fee rate here, so that if you try end up doing `UpdateTip / CacheMinRebroadcastFee / RebroadcatTxs` you can do something sensible?\r\n\r\n```c++\r\n   new_tip = ::ChainActive().Tip();\r\n   if (new_tip != m_tip_at_cache_time) {\r\n       m_last_cached_fee_rate = m_cached_fee_rate;\r\n   } else {\r\n       m_last_cached_fee_rate = max; // ?\r\n   }\r\n   m_tip_at_cache_time = new_tip;\r\n```   ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-18T02:50:16Z",
      "diff_hunk" : "@@ -0,0 +1,141 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <validation.h>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE = 30min;\n+\n+/** Maximum number of times we will rebroadcast a tranasaction */\n+static constexpr int MAX_REBROADCAST_COUNT = 6;\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL = 4h;\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES = 500;\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE = std::chrono::hours(3 * 30 * 24);\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    std::chrono::microseconds start_time = GetTime<std::chrono::microseconds>();\n+\n+    // If there has not been a cache run since the last block, the fee rate\n+    // condition will not filter out any transactions, so skip this run.\n+    if (m_tip_at_cache_time == ::ChainActive().Tip()) return rebroadcast_txs;\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = MAX_REBROADCAST_WEIGHT;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.check_block_validity = false;\n+    options.blockMinFeeRate = m_cached_fee_rate;\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_mempool, Params(), options)\n+                          .CreateNewBlock(m_chainman.ActiveChainstate(), CScript());\n+    std::chrono::microseconds after_CNB_time = GetTime<std::chrono::microseconds>();\n+\n+    for (const CTransactionRef& tx : block_template->block.vtx) {\n+        if (tx->IsCoinBase()) continue;\n+\n+        uint256 txid = tx->GetHash();\n+        uint256 wtxid = tx->GetWitnessHash();\n+\n+        // Check if we have previously rebroadcasted, decide if we will this\n+        // round, and if so, record the attempt.\n+        auto entry_it = m_attempt_tracker.find(wtxid);\n+\n+        if (entry_it == m_attempt_tracker.end()) {\n+            // No existing entry, we will rebroadcast, so create a new one\n+            RebroadcastEntry entry(start_time, wtxid);\n+            m_attempt_tracker.insert(entry);\n+        } else if (entry_it->m_count >= MAX_REBROADCAST_COUNT) {\n+            // We have already rebroadcast this transaction the maximum number\n+            // of times permitted, so skip rebroadcasting.\n+            continue;\n+        } else if (entry_it->m_last_attempt > start_time - MIN_REATTEMPT_INTERVAL) {\n+            // We already rebroadcasted this in the past 4 hours. Even if we\n+            // added it to the set, it would probably not get INVed to most\n+            // peers due to filterInventoryKnown.\n+            continue;\n+        } else {\n+            // We have rebroadcasted this transaction before, but will try\n+            // again now.\n+            RecordAttempt(entry_it);\n+        }\n+\n+        // Add to set of rebroadcast candidates\n+        rebroadcast_txs.push_back(TxIds(txid, wtxid));\n+    }\n+\n+    TrimMaxRebroadcast();\n+\n+    std::chrono::microseconds delta1 = after_CNB_time - start_time;\n+    std::chrono::microseconds delta2 = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"GetRebroadcastTransactions(): %d Âµs total, %d Âµs spent in CreateNewBlock.\\n\", delta1.count(), delta2.count());\n+    LogPrint(BCLog::NET, \"Queued %d transactions for attempted rebroadcast, filtered from %d candidates with cached fee rate of %s.\\n\", rebroadcast_txs.size(), block_template->block.vtx.size() - 1, m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB));\n+\n+    for (TxIds ids : rebroadcast_txs) {\n+        LogPrint(BCLog::NET, \"Attempting to rebroadcast txid: %s, wtxid: %s\\n\", ids.m_txid.ToString(), ids.m_wtxid.ToString());\n+    }\n+\n+    return rebroadcast_txs;\n+};\n+\n+void TxRebroadcastHandler::CacheMinRebroadcastFee()\n+{\n+    // Update stamp of chain tip on cache run\n+    m_tip_at_cache_time = ::ChainActive().Tip();\n+\n+    // Update cache fee rate\n+    std::chrono::microseconds start_time = GetTime<std::chrono::microseconds>();\n+    m_cached_fee_rate = BlockAssembler(m_mempool, Params()).minTxFeeRate();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r596515495",
      "id" : 596515495,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NjUxNTQ5NQ==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 107,
      "original_position" : 107,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 614939135,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/596515495",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r596516729"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/596516729"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "txrebroadcast.h is only included from net_processing and txrebroadcast.cpp itself, and net_processing already includes txmempool.h so there's not much saving to be had here I think",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-18T02:54:33Z",
      "diff_hunk" : "@@ -0,0 +1,95 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXREBROADCAST_H\n+#define BITCOIN_TXREBROADCAST_H\n+\n+#include <policy/feerate.h>\n+#include <tuple>\n+#include <txmempool.h>\n+#include <util/hasher.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r596516729",
      "id" : 596516729,
      "in_reply_to_id" : 594677303,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NjUxNjcyOQ==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 18,
      "original_position" : 18,
      "original_start_line" : 15,
      "path" : "src/txrebroadcast.h",
      "position" : null,
      "pull_request_review_id" : 614940621,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-05T05:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/596516729",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Sorry to bring bad news but this needs rebase. There is a silent merge conflict (with 680eb56d828ce358b4e000c140f5b247ff5e6179 part of #21162). Merged on top of master the following build error appears:\r\n```\r\n  CXX      libbitcoin_server_a-net_processing.o\r\nnet_processing.cpp:1396:55: error: too many arguments to function call, expected 2, have 3\r\n            RelayTransaction(ids.m_txid, ids.m_wtxid, m_connman);\r\n            ~~~~~~~~~~~~~~~~                          ^~~~~~~~~\r\nnet_processing.cpp:251:5: note: 'RelayTransaction' declared here\r\n    void RelayTransaction(const uint256& txid, const uint256& wtxid) override;\r\n    ^\r\n1 error generated.\r\n```",
      "created_at" : "2021-03-24T09:15:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-805633642",
      "id" : 805633642,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwNTYzMzY0Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-24T09:15:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/805633642",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r600423847"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/600423847"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not currently, but I think a long-term it'd be good to remove the boost header dependencies from modules that aren't using boost multi_index. That'd involve refactoring the txmempool interface so it's not exposing multi_index objects.\r\n\r\nTo be honest, I'm not entirely sure how much actual benefit this would have on build times and binary size. I think that boost multi_index is almost entirely templates, so if they're not being instantiated in a translation unit, then it's probably minimal. Still, I think it's a good goal in itself to minimize where third party libraries are exposed within our code structure.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-24T12:17:30Z",
      "diff_hunk" : "@@ -0,0 +1,95 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXREBROADCAST_H\n+#define BITCOIN_TXREBROADCAST_H\n+\n+#include <policy/feerate.h>\n+#include <tuple>\n+#include <txmempool.h>\n+#include <util/hasher.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r600423847",
      "id" : 600423847,
      "in_reply_to_id" : 594677303,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMDQyMzg0Nw==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 18,
      "original_position" : 18,
      "original_start_line" : 15,
      "path" : "src/txrebroadcast.h",
      "position" : null,
      "pull_request_review_id" : 619647027,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-05T05:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/600423847",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r600948474"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/600948474"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why is this lock added in the first commit and then removed?",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-24T23:51:06Z",
      "diff_hunk" : "@@ -17,29 +16,63 @@ static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\n /** Default minimum age for a transaction to be rebroadcast */\n static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE = 30min;\n \n+/** Maximum number of times we will rebroadcast a tranasaction */\n+static constexpr int MAX_REBROADCAST_COUNT = 6;\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL = 4h;\n+\n std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\n {\n     std::vector<TxIds> rebroadcast_txs;\n+    std::chrono::microseconds start_time = GetTime<std::chrono::microseconds>();\n \n     // If there has not been a cache run since the last block, the fee rate\n     // condition will not filter out any transactions, so skip this run.\n     if (m_tip_at_cache_time == ::ChainActive().Tip()) return rebroadcast_txs;\n \n     BlockAssembler::Options options;\n     options.nBlockMaxWeight = MAX_REBROADCAST_WEIGHT;\n-    options.m_skip_inclusion_until = GetTime<std::chrono::microseconds>() - REBROADCAST_MIN_TX_AGE;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n     options.check_block_validity = false;\n     options.blockMinFeeRate = m_cached_fee_rate;\n \n     // Use CreateNewBlock to identify rebroadcast candidates\n     auto block_template = BlockAssembler(m_mempool, Params(), options)\n                           .CreateNewBlock(m_chainman.ActiveChainstate(), CScript());\n \n-    LOCK(m_mempool.cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r600948474",
      "id" : 600948474,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMDk0ODQ3NA==",
      "original_commit_id" : "0c84415ae9fa1a32faace05db1e0d83979c7533b",
      "original_line" : 38,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 620319791,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/600948474",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "~~NACK if:~~\r\n\r\n~~1. Not random\r\nhttps://github.com/bitcoin/bitcoin/pull/21061#issuecomment-797836751~~\r\n\r\n~~2.  User cannot decide REBROADCAST_MIN_TX_AGE https://github.com/bitcoin/bitcoin/pull/21061#discussion_r593968023~~\r\n\r\n~~Because, then it does not achieve things mentioned in  motivation: _This is bad for privacy because it leaks information that allows spy nodes to link bitcoin addresses with IP addresses, a relationship we aim to obfuscate._~~\r\n\r\n~~We should not change the way spy nodes work. There will be a pattern here which can be followed.~~\r\n\r\nI changed my opinion and shared things below: https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-808026799",
      "created_at" : "2021-03-25T00:01:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-806259991",
      "id" : 806259991,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwNjI1OTk5MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-26T08:14:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/806259991",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r600952359"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/600952359"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Entries from `m_attempt_tracker` seem to be only cleared after 3 months or when it's full. Shouldn't we also remove them if the tx is removed from the mempool because it has made it into a block (which would seem like the most common cause for removing)?",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-25T00:02:14Z",
      "diff_hunk" : "@@ -96,3 +104,24 @@ void TxRebroadcastHandler::RecordAttempt(indexed_rebroadcast_set::index<index_by\n \n     m_attempt_tracker.modify(entry_it, UpdateRebroadcastEntry);\n };\n+\n+void TxRebroadcastHandler::TrimMaxRebroadcast()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r600952359",
      "id" : 600952359,
      "line" : 191,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMDk1MjM1OQ==",
      "original_commit_id" : "6f70142fcecac7098fb5aed1ae51cc59d20fb14c",
      "original_line" : 191,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 191,
      "pull_request_review_id" : 620319791,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/600952359",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@prayank23 I think you're confused about the goal of this PR. The current problem is that rebroadcasting is something that _only_ happens for your own transactions. Any peer that observes rebroadcasting knows for a fact that it is yours. This PR changes things so that rebroadcasting is done uniformly for *all* transactions, without special treatment of your own. By definition, if the fact whether a transaction is yours is no longer used in the decision to rebroadcast or not, there is no signal any peer can infer anything from.\r\n\r\nThat obviously does not prevent spy nodes from learning other things (like observing which nodes broadcast first to infer origin), but it categorically removes rebroadcasting behavior from the set of leaks.",
      "created_at" : "2021-03-25T00:07:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-806262328",
      "id" : 806262328,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwNjI2MjMyOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-25T00:10:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/806262328",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r600955209"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/600955209"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The mempool is persisted to disk, would it make sense to do the same with the rebroadcast tracker? With the index designed to keep a memory of months, I'd guess that several nodes would undergo several restarts during such a long period and, currently, lose all memory about past rebroadcasts.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-25T00:10:19Z",
      "diff_hunk" : "@@ -8,15 +8,53 @@\n #include <policy/feerate.h>\n #include <tuple>\n #include <txmempool.h>\n+#include <util/hasher.h>\n+#include <util/time.h>\n #include <validation.h>\n \n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n struct TxIds {\n     TxIds(uint256 txid, uint256 wtxid) : m_txid(txid), m_wtxid(wtxid) {}\n \n     const uint256 m_txid;\n     const uint256 m_wtxid;\n };\n \n+struct RebroadcastEntry {\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\n+        : m_last_attempt(now_time),\n+          m_wtxid(wtxid),\n+          m_count(1) {}\n+\n+    std::chrono::microseconds m_last_attempt;\n+    const uint256 m_wtxid;\n+    int m_count;\n+};\n+\n+/** Used for multi_index tag  */\n+struct index_by_last_attempt {};\n+\n+using indexed_rebroadcast_set = boost::multi_index_container<",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r600955209",
      "id" : 600955209,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMDk1NTIwOQ==",
      "original_commit_id" : "0c84415ae9fa1a32faace05db1e0d83979c7533b",
      "original_line" : 41,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.h",
      "position" : null,
      "pull_request_review_id" : 620319791,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/600955209",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> This PR changes things so that rebroadcasting is done **uniformly for all transactions**, **without special treatment** of your own. By definition, if the fact whether a transaction is yours is no longer used in the decision to rebroadcast or not, there is no signal any peer can infer anything from.\r\n\r\nThis PR improves on 1 thing: They are not all mine\r\nThis PR adds 1 thing: New pattern (fee rate and time in mempool)\r\n\r\nIt makes things different but not difficult for spy nodes \r\n\r\nWhat is wrong with my comments? Random txs and time decided by users\r\n\r\nNobody knows what \"should\" be mined except miners and that 30 minutes time frame is weird for Bitcoin",
      "created_at" : "2021-03-25T00:44:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-806276155",
      "id" : 806276155,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwNjI3NjE1NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-25T00:45:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/806276155",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> This PR adds 1 thing: New pattern (fee rate and time in mempool)\r\n\r\nI see what you mean now. Indeed, it does, but I think this is completely negligible. What it leaks about the mempool is on a scale of 30 minutes to hours. Within such amounts of time, we already reveal the transactions we've learned (simply by telling other nodes in the process of normal relay, every few seconds). The concern about privacy here is on the scale of seconds or less - by knowing which nodes see a transaction first an attacker can infer its origin. Revealing what was in your mempool 30 minutes ago is a non-issue.\r\n\r\nFeerate is already revealed (infrequently & quantized) through BIP133 feefilter messages.\r\n\r\n> It makes things different but not difficult for spy nodes.\r\n\r\nI disagree here. This change completely removes the issue of learning which transactions belong to a node based on rebroadcasting behavior, which is an enormous leak.\r\n\r\n> What is wrong with my comments? Random txs and time decided by users\r\n\r\nWhat do you mean by \"random txs\"?\r\n\r\nTime decided by users: generally the criterion for deciding whether a parameter should be configurable is whether you can also give advice under which cases users should be changing it, and how. I don't know what advice I'd give users except not to touch it; setting it very low could become a privacy issue (using the mechanism you point out), setting it very high may make it useless; things in between probably hardly matter. Do you have a scenario in mind under which you'd suggest changing it?\r\n\r\n> Nobody knows what \"should\" be mined except miners\r\n\r\nThat is literally what the mempool is: a node's prediction of what will be mined in the near future. It doesn't matter that this prediction is sometimes wrong.\r\n\r\n> and that 30 minutes time frame is weird for Bitcoin\r\n\r\nReal world protocol implementations are full of arbitrary-seeming constants.",
      "created_at" : "2021-03-25T01:09:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-806284509",
      "id" : 806284509,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwNjI4NDUwOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-25T01:25:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/806284509",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I thought of different scenarios including weekends when we see less transactions but couldn't find anything that supports my argument. So I change my opinion for now and maybe need to do more research. This PR improves things and if there is any need for further changes to improve privacy it can be done in follow up PRs.\r\n\r\nBelow is a diagram in which I was trying to visualize what happens in A(this PR) and B(things I suggested). I agree with you this change completely removes the issue of learning which transactions belong to a node based on rebroadcasting behavior, which is an enormous leak.\r\n\r\n![image](https://user-images.githubusercontent.com/13405205/112599666-41e77c80-8e36-11eb-8cea-b487903dc4ae.png)\r\n\r\n> What do you mean by \"random txs\"?\r\n\r\nRandomization can be done using different algorithms. But a basic random rebroadcast would ignore filtering based on fee rate. Example: Mempool has 10 txs. A,B,C,D,E,F,G,H,I,J. Using this PR, ABCD are rebroadcasted but in my case AB rebroadcasted once and maybe AED next time if still not confirmed and almost same mempool. Again this suggestion can be ignored and I saw 1sat/vByte being used for filtering when I tried on testnet. Maybe need to do more tests and use mainnet as well.\r\n\r\n> Real world protocol implementations are full of arbitrary-seeming constants.\r\n\r\nI was suggesting to use either a default value like 30 minutes and user can change it if required. Or decide a MIN and MAX so that anything between this range can be used else default 30 minutes will be used.\r\n\r\nSometimes we don't see any blocks for more than 30 minutes in Bitcoin and few blocks are mined in couple of minutes gap. Considering this it would have been better if there was some algorithm that could adjust the value for us automatically within a range based on last N blocks. But it can also be done manually or we could just ignore this suggestion and do in follow up PRs if required.\r\n\r\n![image](https://user-images.githubusercontent.com/13405205/112601480-8411bd80-8e38-11eb-814a-78dfd6f2bf62.png)\r\n\r\n",
      "created_at" : "2021-03-26T08:14:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-808026799",
      "id" : 808026799,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwODAyNjc5OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-26T08:14:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/808026799",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602170601"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602170601"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We're trying to get rid of global calls like `Params()`. Consider adding a:\r\n\r\n```\r\n    const CChainParams& m_chainparams;\r\n```\r\n\r\nmember to `TxRebroadcastHandler` and setting it in the ctor (like `PeerManagerImpl` does)",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-26T10:27:16Z",
      "diff_hunk" : "@@ -0,0 +1,141 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <validation.h>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE = 30min;\n+\n+/** Maximum number of times we will rebroadcast a tranasaction */\n+static constexpr int MAX_REBROADCAST_COUNT = 6;\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL = 4h;\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES = 500;\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE = std::chrono::hours(3 * 30 * 24);\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    std::chrono::microseconds start_time = GetTime<std::chrono::microseconds>();\n+\n+    // If there has not been a cache run since the last block, the fee rate\n+    // condition will not filter out any transactions, so skip this run.\n+    if (m_tip_at_cache_time == ::ChainActive().Tip()) return rebroadcast_txs;\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = MAX_REBROADCAST_WEIGHT;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.check_block_validity = false;\n+    options.blockMinFeeRate = m_cached_fee_rate;\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_mempool, Params(), options)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602170601",
      "id" : 602170601,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjE3MDYwMQ==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 49,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 621980840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602170601",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602247755"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602247755"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    bool m_check_block_validity;\r\n```",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-26T12:38:06Z",
      "diff_hunk" : "@@ -133,6 +133,10 @@ class BlockAssembler\n     bool fIncludeWitness;\n     unsigned int nBlockMaxWeight;\n     CFeeRate blockMinFeeRate;\n+    std::chrono::microseconds m_skip_inclusion_until;\n+\n+    // To permit disabling block validity check\n+    bool check_block_validity;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602247755",
      "id" : 602247755,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjI0Nzc1NQ==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 139,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/miner.h",
      "position" : null,
      "pull_request_review_id" : 621980840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602247755",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602249928"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602249928"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The type is obvious from the template parameter, so may be a good place to use auto:\r\n\r\n```suggestion\r\n    auto start_time = GetTime<std::chrono::microseconds>();\r\n```\r\n\r\n(and in the other calls to `GetTime`)",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-26T12:41:37Z",
      "diff_hunk" : "@@ -0,0 +1,141 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <validation.h>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE = 30min;\n+\n+/** Maximum number of times we will rebroadcast a tranasaction */\n+static constexpr int MAX_REBROADCAST_COUNT = 6;\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL = 4h;\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES = 500;\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE = std::chrono::hours(3 * 30 * 24);\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    std::chrono::microseconds start_time = GetTime<std::chrono::microseconds>();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602249928",
      "id" : 602249928,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjI0OTkyOA==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 36,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 621980840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602249928",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602253880"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602253880"
         }
      },
      "author_association" : "MEMBER",
      "body" : "AUTO",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-26T12:46:16Z",
      "diff_hunk" : "@@ -0,0 +1,141 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <validation.h>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE = 30min;\n+\n+/** Maximum number of times we will rebroadcast a tranasaction */\n+static constexpr int MAX_REBROADCAST_COUNT = 6;\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL = 4h;\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES = 500;\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE = std::chrono::hours(3 * 30 * 24);\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    std::chrono::microseconds start_time = GetTime<std::chrono::microseconds>();\n+\n+    // If there has not been a cache run since the last block, the fee rate\n+    // condition will not filter out any transactions, so skip this run.\n+    if (m_tip_at_cache_time == ::ChainActive().Tip()) return rebroadcast_txs;\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = MAX_REBROADCAST_WEIGHT;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.check_block_validity = false;\n+    options.blockMinFeeRate = m_cached_fee_rate;\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_mempool, Params(), options)\n+                          .CreateNewBlock(m_chainman.ActiveChainstate(), CScript());\n+    std::chrono::microseconds after_CNB_time = GetTime<std::chrono::microseconds>();\n+\n+    for (const CTransactionRef& tx : block_template->block.vtx) {\n+        if (tx->IsCoinBase()) continue;\n+\n+        uint256 txid = tx->GetHash();\n+        uint256 wtxid = tx->GetWitnessHash();\n+\n+        // Check if we have previously rebroadcasted, decide if we will this\n+        // round, and if so, record the attempt.\n+        auto entry_it = m_attempt_tracker.find(wtxid);\n+\n+        if (entry_it == m_attempt_tracker.end()) {\n+            // No existing entry, we will rebroadcast, so create a new one\n+            RebroadcastEntry entry(start_time, wtxid);\n+            m_attempt_tracker.insert(entry);\n+        } else if (entry_it->m_count >= MAX_REBROADCAST_COUNT) {\n+            // We have already rebroadcast this transaction the maximum number\n+            // of times permitted, so skip rebroadcasting.\n+            continue;\n+        } else if (entry_it->m_last_attempt > start_time - MIN_REATTEMPT_INTERVAL) {\n+            // We already rebroadcasted this in the past 4 hours. Even if we\n+            // added it to the set, it would probably not get INVed to most\n+            // peers due to filterInventoryKnown.\n+            continue;\n+        } else {\n+            // We have rebroadcasted this transaction before, but will try\n+            // again now.\n+            RecordAttempt(entry_it);\n+        }\n+\n+        // Add to set of rebroadcast candidates\n+        rebroadcast_txs.push_back(TxIds(txid, wtxid));\n+    }\n+\n+    TrimMaxRebroadcast();\n+\n+    std::chrono::microseconds delta1 = after_CNB_time - start_time;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602253880",
      "id" : 602253880,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjI1Mzg4MA==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 88,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 621980840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602253880",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602255196"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602255196"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe better to use \"us\" instead of \"Âµs\" to keep logs in ascii.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-26T12:47:38Z",
      "diff_hunk" : "@@ -0,0 +1,141 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <validation.h>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE = 30min;\n+\n+/** Maximum number of times we will rebroadcast a tranasaction */\n+static constexpr int MAX_REBROADCAST_COUNT = 6;\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL = 4h;\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES = 500;\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE = std::chrono::hours(3 * 30 * 24);\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    std::chrono::microseconds start_time = GetTime<std::chrono::microseconds>();\n+\n+    // If there has not been a cache run since the last block, the fee rate\n+    // condition will not filter out any transactions, so skip this run.\n+    if (m_tip_at_cache_time == ::ChainActive().Tip()) return rebroadcast_txs;\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = MAX_REBROADCAST_WEIGHT;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.check_block_validity = false;\n+    options.blockMinFeeRate = m_cached_fee_rate;\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_mempool, Params(), options)\n+                          .CreateNewBlock(m_chainman.ActiveChainstate(), CScript());\n+    std::chrono::microseconds after_CNB_time = GetTime<std::chrono::microseconds>();\n+\n+    for (const CTransactionRef& tx : block_template->block.vtx) {\n+        if (tx->IsCoinBase()) continue;\n+\n+        uint256 txid = tx->GetHash();\n+        uint256 wtxid = tx->GetWitnessHash();\n+\n+        // Check if we have previously rebroadcasted, decide if we will this\n+        // round, and if so, record the attempt.\n+        auto entry_it = m_attempt_tracker.find(wtxid);\n+\n+        if (entry_it == m_attempt_tracker.end()) {\n+            // No existing entry, we will rebroadcast, so create a new one\n+            RebroadcastEntry entry(start_time, wtxid);\n+            m_attempt_tracker.insert(entry);\n+        } else if (entry_it->m_count >= MAX_REBROADCAST_COUNT) {\n+            // We have already rebroadcast this transaction the maximum number\n+            // of times permitted, so skip rebroadcasting.\n+            continue;\n+        } else if (entry_it->m_last_attempt > start_time - MIN_REATTEMPT_INTERVAL) {\n+            // We already rebroadcasted this in the past 4 hours. Even if we\n+            // added it to the set, it would probably not get INVed to most\n+            // peers due to filterInventoryKnown.\n+            continue;\n+        } else {\n+            // We have rebroadcasted this transaction before, but will try\n+            // again now.\n+            RecordAttempt(entry_it);\n+        }\n+\n+        // Add to set of rebroadcast candidates\n+        rebroadcast_txs.push_back(TxIds(txid, wtxid));\n+    }\n+\n+    TrimMaxRebroadcast();\n+\n+    std::chrono::microseconds delta1 = after_CNB_time - start_time;\n+    std::chrono::microseconds delta2 = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"GetRebroadcastTransactions(): %d Âµs total, %d Âµs spent in CreateNewBlock.\\n\", delta1.count(), delta2.count());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602255196",
      "id" : 602255196,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjI1NTE5Ng==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 90,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 621980840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602255196",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602260866"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602260866"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Also make sure that you remove transactions that are conflicted out by the block (ie a conflicting transaction is included in the block).",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-26T12:53:40Z",
      "diff_hunk" : "@@ -96,3 +104,24 @@ void TxRebroadcastHandler::RecordAttempt(indexed_rebroadcast_set::index<index_by\n \n     m_attempt_tracker.modify(entry_it, UpdateRebroadcastEntry);\n };\n+\n+void TxRebroadcastHandler::TrimMaxRebroadcast()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602260866",
      "id" : 602260866,
      "in_reply_to_id" : 600952359,
      "line" : 191,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjI2MDg2Ng==",
      "original_commit_id" : "6f70142fcecac7098fb5aed1ae51cc59d20fb14c",
      "original_line" : 191,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 191,
      "pull_request_review_id" : 621980840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602260866",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602266206"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602266206"
         }
      },
      "author_association" : "MEMBER",
      "body" : "use `std::make_unique()` to make unique pointers.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-26T12:59:11Z",
      "diff_hunk" : "@@ -298,6 +311,43 @@ void BlockAssembler::SortForBlock(const CTxMemPool::setEntries& package, std::ve\n     std::sort(sortedEntries.begin(), sortedEntries.end(), CompareTxIterByAncestorCount());\n }\n \n+CFeeRate BlockAssembler::minTxFeeRate()\n+{\n+    int packages_selected = 0;\n+    int descendants_updated = 0;\n+    CFeeRate min_fee_rate = CFeeRate(COIN, 1);\n+\n+    resetBlock();\n+    pblocktemplate.reset(new CBlockTemplate());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602266206",
      "id" : 602266206,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjI2NjIwNg==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 321,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/miner.cpp",
      "position" : null,
      "pull_request_review_id" : 621980840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602266206",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602267130"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602267130"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This seems impossible to hit. You've just constructed a new `std::unique_ptr<CBlockTemplate>`.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-26T13:00:03Z",
      "diff_hunk" : "@@ -298,6 +311,43 @@ void BlockAssembler::SortForBlock(const CTxMemPool::setEntries& package, std::ve\n     std::sort(sortedEntries.begin(), sortedEntries.end(), CompareTxIterByAncestorCount());\n }\n \n+CFeeRate BlockAssembler::minTxFeeRate()\n+{\n+    int packages_selected = 0;\n+    int descendants_updated = 0;\n+    CFeeRate min_fee_rate = CFeeRate(COIN, 1);\n+\n+    resetBlock();\n+    pblocktemplate.reset(new CBlockTemplate());\n+\n+    if (!pblocktemplate.get()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602267130",
      "id" : 602267130,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjI2NzEzMA==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 323,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/miner.cpp",
      "position" : null,
      "pull_request_review_id" : 621980840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602267130",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602268144"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602268144"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think this is needed. Witness is definitely enabled at the tip!",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-26T13:01:11Z",
      "diff_hunk" : "@@ -298,6 +311,43 @@ void BlockAssembler::SortForBlock(const CTxMemPool::setEntries& package, std::ve\n     std::sort(sortedEntries.begin(), sortedEntries.end(), CompareTxIterByAncestorCount());\n }\n \n+CFeeRate BlockAssembler::minTxFeeRate()\n+{\n+    int packages_selected = 0;\n+    int descendants_updated = 0;\n+    CFeeRate min_fee_rate = CFeeRate(COIN, 1);\n+\n+    resetBlock();\n+    pblocktemplate.reset(new CBlockTemplate());\n+\n+    if (!pblocktemplate.get()) {\n+        return min_fee_rate;\n+    }\n+    CBlock* block = &pblocktemplate->block;\n+\n+    // Add dummy coinbase tx as first transaction\n+    block->vtx.emplace_back();\n+    pblocktemplate->vTxFees.push_back(-1);\n+    pblocktemplate->vTxSigOpsCost.push_back(-1);\n+\n+    CBlockIndex* prev_block_index = ::ChainActive().Tip();\n+    assert(prev_block_index != nullptr);\n+    nHeight = prev_block_index->nHeight + 1;\n+\n+    block->nTime = static_cast<uint32_t>(GetAdjustedTime());\n+    const int64_t median_time_past = prev_block_index->GetMedianTimePast();\n+\n+    nLockTimeCutoff = median_time_past;\n+    fIncludeWitness = IsWitnessEnabled(prev_block_index, chainparams.GetConsensus());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602268144",
      "id" : 602268144,
      "line" : 322,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjI2ODE0NA==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 322,
      "original_position" : 93,
      "original_start_line" : null,
      "path" : "src/miner.cpp",
      "position" : 70,
      "pull_request_review_id" : 621980840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602268144",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602269820"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602269820"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Avoid calls to the global `::ChainActive()`.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-26T13:03:02Z",
      "diff_hunk" : "@@ -0,0 +1,141 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <validation.h>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE = 30min;\n+\n+/** Maximum number of times we will rebroadcast a tranasaction */\n+static constexpr int MAX_REBROADCAST_COUNT = 6;\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL = 4h;\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES = 500;\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE = std::chrono::hours(3 * 30 * 24);\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    std::chrono::microseconds start_time = GetTime<std::chrono::microseconds>();\n+\n+    // If there has not been a cache run since the last block, the fee rate\n+    // condition will not filter out any transactions, so skip this run.\n+    if (m_tip_at_cache_time == ::ChainActive().Tip()) return rebroadcast_txs;\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = MAX_REBROADCAST_WEIGHT;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.check_block_validity = false;\n+    options.blockMinFeeRate = m_cached_fee_rate;\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_mempool, Params(), options)\n+                          .CreateNewBlock(m_chainman.ActiveChainstate(), CScript());\n+    std::chrono::microseconds after_CNB_time = GetTime<std::chrono::microseconds>();\n+\n+    for (const CTransactionRef& tx : block_template->block.vtx) {\n+        if (tx->IsCoinBase()) continue;\n+\n+        uint256 txid = tx->GetHash();\n+        uint256 wtxid = tx->GetWitnessHash();\n+\n+        // Check if we have previously rebroadcasted, decide if we will this\n+        // round, and if so, record the attempt.\n+        auto entry_it = m_attempt_tracker.find(wtxid);\n+\n+        if (entry_it == m_attempt_tracker.end()) {\n+            // No existing entry, we will rebroadcast, so create a new one\n+            RebroadcastEntry entry(start_time, wtxid);\n+            m_attempt_tracker.insert(entry);\n+        } else if (entry_it->m_count >= MAX_REBROADCAST_COUNT) {\n+            // We have already rebroadcast this transaction the maximum number\n+            // of times permitted, so skip rebroadcasting.\n+            continue;\n+        } else if (entry_it->m_last_attempt > start_time - MIN_REATTEMPT_INTERVAL) {\n+            // We already rebroadcasted this in the past 4 hours. Even if we\n+            // added it to the set, it would probably not get INVed to most\n+            // peers due to filterInventoryKnown.\n+            continue;\n+        } else {\n+            // We have rebroadcasted this transaction before, but will try\n+            // again now.\n+            RecordAttempt(entry_it);\n+        }\n+\n+        // Add to set of rebroadcast candidates\n+        rebroadcast_txs.push_back(TxIds(txid, wtxid));\n+    }\n+\n+    TrimMaxRebroadcast();\n+\n+    std::chrono::microseconds delta1 = after_CNB_time - start_time;\n+    std::chrono::microseconds delta2 = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"GetRebroadcastTransactions(): %d Âµs total, %d Âµs spent in CreateNewBlock.\\n\", delta1.count(), delta2.count());\n+    LogPrint(BCLog::NET, \"Queued %d transactions for attempted rebroadcast, filtered from %d candidates with cached fee rate of %s.\\n\", rebroadcast_txs.size(), block_template->block.vtx.size() - 1, m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB));\n+\n+    for (TxIds ids : rebroadcast_txs) {\n+        LogPrint(BCLog::NET, \"Attempting to rebroadcast txid: %s, wtxid: %s\\n\", ids.m_txid.ToString(), ids.m_wtxid.ToString());\n+    }\n+\n+    return rebroadcast_txs;\n+};\n+\n+void TxRebroadcastHandler::CacheMinRebroadcastFee()\n+{\n+    // Update stamp of chain tip on cache run\n+    m_tip_at_cache_time = ::ChainActive().Tip();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602269820",
      "id" : 602269820,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjI2OTgyMA==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 103,
      "original_position" : 103,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 621980840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602269820",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602269986"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602269986"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    auto start_time = GetTime<std::chrono::microseconds>();\r\n```",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-26T13:03:10Z",
      "diff_hunk" : "@@ -0,0 +1,141 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <validation.h>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE = 30min;\n+\n+/** Maximum number of times we will rebroadcast a tranasaction */\n+static constexpr int MAX_REBROADCAST_COUNT = 6;\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL = 4h;\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES = 500;\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE = std::chrono::hours(3 * 30 * 24);\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    std::chrono::microseconds start_time = GetTime<std::chrono::microseconds>();\n+\n+    // If there has not been a cache run since the last block, the fee rate\n+    // condition will not filter out any transactions, so skip this run.\n+    if (m_tip_at_cache_time == ::ChainActive().Tip()) return rebroadcast_txs;\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = MAX_REBROADCAST_WEIGHT;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.check_block_validity = false;\n+    options.blockMinFeeRate = m_cached_fee_rate;\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_mempool, Params(), options)\n+                          .CreateNewBlock(m_chainman.ActiveChainstate(), CScript());\n+    std::chrono::microseconds after_CNB_time = GetTime<std::chrono::microseconds>();\n+\n+    for (const CTransactionRef& tx : block_template->block.vtx) {\n+        if (tx->IsCoinBase()) continue;\n+\n+        uint256 txid = tx->GetHash();\n+        uint256 wtxid = tx->GetWitnessHash();\n+\n+        // Check if we have previously rebroadcasted, decide if we will this\n+        // round, and if so, record the attempt.\n+        auto entry_it = m_attempt_tracker.find(wtxid);\n+\n+        if (entry_it == m_attempt_tracker.end()) {\n+            // No existing entry, we will rebroadcast, so create a new one\n+            RebroadcastEntry entry(start_time, wtxid);\n+            m_attempt_tracker.insert(entry);\n+        } else if (entry_it->m_count >= MAX_REBROADCAST_COUNT) {\n+            // We have already rebroadcast this transaction the maximum number\n+            // of times permitted, so skip rebroadcasting.\n+            continue;\n+        } else if (entry_it->m_last_attempt > start_time - MIN_REATTEMPT_INTERVAL) {\n+            // We already rebroadcasted this in the past 4 hours. Even if we\n+            // added it to the set, it would probably not get INVed to most\n+            // peers due to filterInventoryKnown.\n+            continue;\n+        } else {\n+            // We have rebroadcasted this transaction before, but will try\n+            // again now.\n+            RecordAttempt(entry_it);\n+        }\n+\n+        // Add to set of rebroadcast candidates\n+        rebroadcast_txs.push_back(TxIds(txid, wtxid));\n+    }\n+\n+    TrimMaxRebroadcast();\n+\n+    std::chrono::microseconds delta1 = after_CNB_time - start_time;\n+    std::chrono::microseconds delta2 = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"GetRebroadcastTransactions(): %d Âµs total, %d Âµs spent in CreateNewBlock.\\n\", delta1.count(), delta2.count());\n+    LogPrint(BCLog::NET, \"Queued %d transactions for attempted rebroadcast, filtered from %d candidates with cached fee rate of %s.\\n\", rebroadcast_txs.size(), block_template->block.vtx.size() - 1, m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB));\n+\n+    for (TxIds ids : rebroadcast_txs) {\n+        LogPrint(BCLog::NET, \"Attempting to rebroadcast txid: %s, wtxid: %s\\n\", ids.m_txid.ToString(), ids.m_wtxid.ToString());\n+    }\n+\n+    return rebroadcast_txs;\n+};\n+\n+void TxRebroadcastHandler::CacheMinRebroadcastFee()\n+{\n+    // Update stamp of chain tip on cache run\n+    m_tip_at_cache_time = ::ChainActive().Tip();\n+\n+    // Update cache fee rate\n+    std::chrono::microseconds start_time = GetTime<std::chrono::microseconds>();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602269986",
      "id" : 602269986,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjI2OTk4Ng==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 106,
      "original_position" : 106,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 621980840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602269986",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602270596"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602270596"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Functions should be capitalized:\r\n\r\n```suggestion\r\n    CFeeRate MinTxFeeRate();\r\n```",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-26T13:03:54Z",
      "diff_hunk" : "@@ -163,6 +169,12 @@ class BlockAssembler\n     static Optional<int64_t> m_last_block_num_txs;\n     static Optional<int64_t> m_last_block_weight;\n \n+    /* This function wraps addPackageTxs to calculate and return the minimum fee\n+     * rate required for a package to currently be included in the highest fee rate\n+     * block possible based on mempool transactions.\n+     */\n+    CFeeRate minTxFeeRate();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602270596",
      "id" : 602270596,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjI3MDU5Ng==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 176,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/miner.h",
      "position" : null,
      "pull_request_review_id" : 621980840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602270596",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602272135"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602272135"
         }
      },
      "author_association" : "MEMBER",
      "body" : "again, maybe avoid greek letters:\r\n\r\n```suggestion\r\n    LogPrint(BCLog::BENCH, \"Caching minimum fee for rebroadcast to %s, took %d us to calculate.\\n\", m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB), delta_time.count());\r\n```",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-26T13:05:25Z",
      "diff_hunk" : "@@ -0,0 +1,141 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <validation.h>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE = 30min;\n+\n+/** Maximum number of times we will rebroadcast a tranasaction */\n+static constexpr int MAX_REBROADCAST_COUNT = 6;\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL = 4h;\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES = 500;\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE = std::chrono::hours(3 * 30 * 24);\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    std::chrono::microseconds start_time = GetTime<std::chrono::microseconds>();\n+\n+    // If there has not been a cache run since the last block, the fee rate\n+    // condition will not filter out any transactions, so skip this run.\n+    if (m_tip_at_cache_time == ::ChainActive().Tip()) return rebroadcast_txs;\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = MAX_REBROADCAST_WEIGHT;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.check_block_validity = false;\n+    options.blockMinFeeRate = m_cached_fee_rate;\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_mempool, Params(), options)\n+                          .CreateNewBlock(m_chainman.ActiveChainstate(), CScript());\n+    std::chrono::microseconds after_CNB_time = GetTime<std::chrono::microseconds>();\n+\n+    for (const CTransactionRef& tx : block_template->block.vtx) {\n+        if (tx->IsCoinBase()) continue;\n+\n+        uint256 txid = tx->GetHash();\n+        uint256 wtxid = tx->GetWitnessHash();\n+\n+        // Check if we have previously rebroadcasted, decide if we will this\n+        // round, and if so, record the attempt.\n+        auto entry_it = m_attempt_tracker.find(wtxid);\n+\n+        if (entry_it == m_attempt_tracker.end()) {\n+            // No existing entry, we will rebroadcast, so create a new one\n+            RebroadcastEntry entry(start_time, wtxid);\n+            m_attempt_tracker.insert(entry);\n+        } else if (entry_it->m_count >= MAX_REBROADCAST_COUNT) {\n+            // We have already rebroadcast this transaction the maximum number\n+            // of times permitted, so skip rebroadcasting.\n+            continue;\n+        } else if (entry_it->m_last_attempt > start_time - MIN_REATTEMPT_INTERVAL) {\n+            // We already rebroadcasted this in the past 4 hours. Even if we\n+            // added it to the set, it would probably not get INVed to most\n+            // peers due to filterInventoryKnown.\n+            continue;\n+        } else {\n+            // We have rebroadcasted this transaction before, but will try\n+            // again now.\n+            RecordAttempt(entry_it);\n+        }\n+\n+        // Add to set of rebroadcast candidates\n+        rebroadcast_txs.push_back(TxIds(txid, wtxid));\n+    }\n+\n+    TrimMaxRebroadcast();\n+\n+    std::chrono::microseconds delta1 = after_CNB_time - start_time;\n+    std::chrono::microseconds delta2 = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"GetRebroadcastTransactions(): %d Âµs total, %d Âµs spent in CreateNewBlock.\\n\", delta1.count(), delta2.count());\n+    LogPrint(BCLog::NET, \"Queued %d transactions for attempted rebroadcast, filtered from %d candidates with cached fee rate of %s.\\n\", rebroadcast_txs.size(), block_template->block.vtx.size() - 1, m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB));\n+\n+    for (TxIds ids : rebroadcast_txs) {\n+        LogPrint(BCLog::NET, \"Attempting to rebroadcast txid: %s, wtxid: %s\\n\", ids.m_txid.ToString(), ids.m_wtxid.ToString());\n+    }\n+\n+    return rebroadcast_txs;\n+};\n+\n+void TxRebroadcastHandler::CacheMinRebroadcastFee()\n+{\n+    // Update stamp of chain tip on cache run\n+    m_tip_at_cache_time = ::ChainActive().Tip();\n+\n+    // Update cache fee rate\n+    std::chrono::microseconds start_time = GetTime<std::chrono::microseconds>();\n+    m_cached_fee_rate = BlockAssembler(m_mempool, Params()).minTxFeeRate();\n+    std::chrono::microseconds delta_time = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"Caching minimum fee for rebroadcast to %s, took %d Âµs to calculate.\\n\", m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB), delta_time.count());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602272135",
      "id" : 602272135,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjI3MjEzNQ==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 109,
      "original_position" : 109,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 621980840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602272135",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602276459"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602276459"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Are these definitely needed? You're just going to throw the block template away at the end.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-26T13:09:48Z",
      "diff_hunk" : "@@ -298,6 +311,43 @@ void BlockAssembler::SortForBlock(const CTxMemPool::setEntries& package, std::ve\n     std::sort(sortedEntries.begin(), sortedEntries.end(), CompareTxIterByAncestorCount());\n }\n \n+CFeeRate BlockAssembler::minTxFeeRate()\n+{\n+    int packages_selected = 0;\n+    int descendants_updated = 0;\n+    CFeeRate min_fee_rate = CFeeRate(COIN, 1);\n+\n+    resetBlock();\n+    pblocktemplate.reset(new CBlockTemplate());\n+\n+    if (!pblocktemplate.get()) {\n+        return min_fee_rate;\n+    }\n+    CBlock* block = &pblocktemplate->block;\n+\n+    // Add dummy coinbase tx as first transaction\n+    block->vtx.emplace_back();\n+    pblocktemplate->vTxFees.push_back(-1);\n+    pblocktemplate->vTxSigOpsCost.push_back(-1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602276459",
      "id" : 602276459,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjI3NjQ1OQ==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 331,
      "original_position" : 83,
      "original_start_line" : 329,
      "path" : "src/miner.cpp",
      "position" : null,
      "pull_request_review_id" : 621980840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602276459",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602276869"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602276869"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Avoid the global `::ChainActive()`",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-26T13:10:12Z",
      "diff_hunk" : "@@ -298,6 +311,43 @@ void BlockAssembler::SortForBlock(const CTxMemPool::setEntries& package, std::ve\n     std::sort(sortedEntries.begin(), sortedEntries.end(), CompareTxIterByAncestorCount());\n }\n \n+CFeeRate BlockAssembler::minTxFeeRate()\n+{\n+    int packages_selected = 0;\n+    int descendants_updated = 0;\n+    CFeeRate min_fee_rate = CFeeRate(COIN, 1);\n+\n+    resetBlock();\n+    pblocktemplate.reset(new CBlockTemplate());\n+\n+    if (!pblocktemplate.get()) {\n+        return min_fee_rate;\n+    }\n+    CBlock* block = &pblocktemplate->block;\n+\n+    // Add dummy coinbase tx as first transaction\n+    block->vtx.emplace_back();\n+    pblocktemplate->vTxFees.push_back(-1);\n+    pblocktemplate->vTxSigOpsCost.push_back(-1);\n+\n+    CBlockIndex* prev_block_index = ::ChainActive().Tip();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602276869",
      "id" : 602276869,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjI3Njg2OQ==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 333,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/miner.cpp",
      "position" : null,
      "pull_request_review_id" : 621980840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602276869",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602278993"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602278993"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think this is needed. You're throwing away the block afterwards.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-26T13:12:33Z",
      "diff_hunk" : "@@ -298,6 +311,43 @@ void BlockAssembler::SortForBlock(const CTxMemPool::setEntries& package, std::ve\n     std::sort(sortedEntries.begin(), sortedEntries.end(), CompareTxIterByAncestorCount());\n }\n \n+CFeeRate BlockAssembler::minTxFeeRate()\n+{\n+    int packages_selected = 0;\n+    int descendants_updated = 0;\n+    CFeeRate min_fee_rate = CFeeRate(COIN, 1);\n+\n+    resetBlock();\n+    pblocktemplate.reset(new CBlockTemplate());\n+\n+    if (!pblocktemplate.get()) {\n+        return min_fee_rate;\n+    }\n+    CBlock* block = &pblocktemplate->block;\n+\n+    // Add dummy coinbase tx as first transaction\n+    block->vtx.emplace_back();\n+    pblocktemplate->vTxFees.push_back(-1);\n+    pblocktemplate->vTxSigOpsCost.push_back(-1);\n+\n+    CBlockIndex* prev_block_index = ::ChainActive().Tip();\n+    assert(prev_block_index != nullptr);\n+    nHeight = prev_block_index->nHeight + 1;\n+\n+    block->nTime = static_cast<uint32_t>(GetAdjustedTime());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602278993",
      "id" : 602278993,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjI3ODk5Mw==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 337,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "src/miner.cpp",
      "position" : null,
      "pull_request_review_id" : 621980840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602278993",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602279120"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602279120"
         }
      },
      "author_association" : "MEMBER",
      "body" : "join these lines?",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-26T13:12:42Z",
      "diff_hunk" : "@@ -298,6 +311,43 @@ void BlockAssembler::SortForBlock(const CTxMemPool::setEntries& package, std::ve\n     std::sort(sortedEntries.begin(), sortedEntries.end(), CompareTxIterByAncestorCount());\n }\n \n+CFeeRate BlockAssembler::minTxFeeRate()\n+{\n+    int packages_selected = 0;\n+    int descendants_updated = 0;\n+    CFeeRate min_fee_rate = CFeeRate(COIN, 1);\n+\n+    resetBlock();\n+    pblocktemplate.reset(new CBlockTemplate());\n+\n+    if (!pblocktemplate.get()) {\n+        return min_fee_rate;\n+    }\n+    CBlock* block = &pblocktemplate->block;\n+\n+    // Add dummy coinbase tx as first transaction\n+    block->vtx.emplace_back();\n+    pblocktemplate->vTxFees.push_back(-1);\n+    pblocktemplate->vTxSigOpsCost.push_back(-1);\n+\n+    CBlockIndex* prev_block_index = ::ChainActive().Tip();\n+    assert(prev_block_index != nullptr);\n+    nHeight = prev_block_index->nHeight + 1;\n+\n+    block->nTime = static_cast<uint32_t>(GetAdjustedTime());\n+    const int64_t median_time_past = prev_block_index->GetMedianTimePast();\n+\n+    nLockTimeCutoff = median_time_past;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602279120",
      "id" : 602279120,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjI3OTEyMA==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 340,
      "original_position" : 92,
      "original_start_line" : 338,
      "path" : "src/miner.cpp",
      "position" : null,
      "pull_request_review_id" : 621980840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602279120",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602283867"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602283867"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is `cs_main` definitely required here? `addPackageTxs()` isn't annotated to say that it's required.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-26T13:17:38Z",
      "diff_hunk" : "@@ -298,6 +311,43 @@ void BlockAssembler::SortForBlock(const CTxMemPool::setEntries& package, std::ve\n     std::sort(sortedEntries.begin(), sortedEntries.end(), CompareTxIterByAncestorCount());\n }\n \n+CFeeRate BlockAssembler::minTxFeeRate()\n+{\n+    int packages_selected = 0;\n+    int descendants_updated = 0;\n+    CFeeRate min_fee_rate = CFeeRate(COIN, 1);\n+\n+    resetBlock();\n+    pblocktemplate.reset(new CBlockTemplate());\n+\n+    if (!pblocktemplate.get()) {\n+        return min_fee_rate;\n+    }\n+    CBlock* block = &pblocktemplate->block;\n+\n+    // Add dummy coinbase tx as first transaction\n+    block->vtx.emplace_back();\n+    pblocktemplate->vTxFees.push_back(-1);\n+    pblocktemplate->vTxSigOpsCost.push_back(-1);\n+\n+    CBlockIndex* prev_block_index = ::ChainActive().Tip();\n+    assert(prev_block_index != nullptr);\n+    nHeight = prev_block_index->nHeight + 1;\n+\n+    block->nTime = static_cast<uint32_t>(GetAdjustedTime());\n+    const int64_t median_time_past = prev_block_index->GetMedianTimePast();\n+\n+    nLockTimeCutoff = median_time_past;\n+    fIncludeWitness = IsWitnessEnabled(prev_block_index, chainparams.GetConsensus());\n+\n+    {\n+        LOCK2(cs_main, m_mempool.cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602283867",
      "id" : 602283867,
      "line" : 325,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjI4Mzg2Nw==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 325,
      "original_position" : 96,
      "original_start_line" : null,
      "path" : "src/miner.cpp",
      "position" : 73,
      "pull_request_review_id" : 621980840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602283867",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602295773"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602295773"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`min_package_fee_rate` seems very cheap to calculate. Perhaps just make it a reference so it's always returned.\r\n\r\n(even better would be:\r\n\r\n```suggestion\r\nstd::tuple<int, int, CFeeRate> BlockAssembler::addPackageTxs()\r\n```\r\n\r\nbut that's maybe beyond the scope of this PR)",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-26T13:32:06Z",
      "diff_hunk" : "@@ -308,7 +358,7 @@ void BlockAssembler::SortForBlock(const CTxMemPool::setEntries& package, std::ve\n // Each time through the loop, we compare the best transaction in\n // mapModifiedTxs with the next transaction in the mempool to decide what\n // transaction package to work on next.\n-void BlockAssembler::addPackageTxs(int &nPackagesSelected, int &nDescendantsUpdated)\n+void BlockAssembler::addPackageTxs(int& nPackagesSelected, int& nDescendantsUpdated, CFeeRate* min_package_fee_rate)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602295773",
      "id" : 602295773,
      "line" : 342,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjI5NTc3Mw==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 342,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/miner.cpp",
      "position" : 88,
      "pull_request_review_id" : 621980840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602295773",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602301898"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602301898"
         }
      },
      "author_association" : "MEMBER",
      "body" : "avoid global `::ChainActive`",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-26T13:40:39Z",
      "diff_hunk" : "@@ -0,0 +1,141 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <validation.h>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE = 30min;\n+\n+/** Maximum number of times we will rebroadcast a tranasaction */\n+static constexpr int MAX_REBROADCAST_COUNT = 6;\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL = 4h;\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES = 500;\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE = std::chrono::hours(3 * 30 * 24);\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    std::chrono::microseconds start_time = GetTime<std::chrono::microseconds>();\n+\n+    // If there has not been a cache run since the last block, the fee rate\n+    // condition will not filter out any transactions, so skip this run.\n+    if (m_tip_at_cache_time == ::ChainActive().Tip()) return rebroadcast_txs;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602301898",
      "id" : 602301898,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjMwMTg5OA==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 40,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 621980840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602301898",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602306177"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602306177"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think we prefer to include all headers that are used in the translation unit, even if they're also included in the corresponding header file. You don't need to remove the \"#include <util/time.h> in the _[rebroadcast] Track rebroadcast attempts_ commit.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-26T13:46:30Z",
      "diff_hunk" : "@@ -0,0 +1,141 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602306177",
      "id" : 602306177,
      "line" : 11,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjMwNjE3Nw==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 11,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 11,
      "pull_request_review_id" : 621980840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602306177",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602306915"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602306915"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps add some of the description from the _[rebroadcast] Track rebroadcast attempts_ commit log here. It's not at all obvious why we'd stop rebroadcasting after some time, and that commit log has a good explanation.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-26T13:47:29Z",
      "diff_hunk" : "@@ -0,0 +1,141 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <validation.h>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE = 30min;\n+\n+/** Maximum number of times we will rebroadcast a tranasaction */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602306915",
      "id" : 602306915,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjMwNjkxNQ==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 26,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 621980840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602306915",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602310627"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602310627"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe pass in the current time to avoid calling `GetTime()` for every transaction?",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-26T13:52:23Z",
      "diff_hunk" : "@@ -0,0 +1,141 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <validation.h>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE = 30min;\n+\n+/** Maximum number of times we will rebroadcast a tranasaction */\n+static constexpr int MAX_REBROADCAST_COUNT = 6;\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL = 4h;\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES = 500;\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE = std::chrono::hours(3 * 30 * 24);\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    std::chrono::microseconds start_time = GetTime<std::chrono::microseconds>();\n+\n+    // If there has not been a cache run since the last block, the fee rate\n+    // condition will not filter out any transactions, so skip this run.\n+    if (m_tip_at_cache_time == ::ChainActive().Tip()) return rebroadcast_txs;\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = MAX_REBROADCAST_WEIGHT;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.check_block_validity = false;\n+    options.blockMinFeeRate = m_cached_fee_rate;\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_mempool, Params(), options)\n+                          .CreateNewBlock(m_chainman.ActiveChainstate(), CScript());\n+    std::chrono::microseconds after_CNB_time = GetTime<std::chrono::microseconds>();\n+\n+    for (const CTransactionRef& tx : block_template->block.vtx) {\n+        if (tx->IsCoinBase()) continue;\n+\n+        uint256 txid = tx->GetHash();\n+        uint256 wtxid = tx->GetWitnessHash();\n+\n+        // Check if we have previously rebroadcasted, decide if we will this\n+        // round, and if so, record the attempt.\n+        auto entry_it = m_attempt_tracker.find(wtxid);\n+\n+        if (entry_it == m_attempt_tracker.end()) {\n+            // No existing entry, we will rebroadcast, so create a new one\n+            RebroadcastEntry entry(start_time, wtxid);\n+            m_attempt_tracker.insert(entry);\n+        } else if (entry_it->m_count >= MAX_REBROADCAST_COUNT) {\n+            // We have already rebroadcast this transaction the maximum number\n+            // of times permitted, so skip rebroadcasting.\n+            continue;\n+        } else if (entry_it->m_last_attempt > start_time - MIN_REATTEMPT_INTERVAL) {\n+            // We already rebroadcasted this in the past 4 hours. Even if we\n+            // added it to the set, it would probably not get INVed to most\n+            // peers due to filterInventoryKnown.\n+            continue;\n+        } else {\n+            // We have rebroadcasted this transaction before, but will try\n+            // again now.\n+            RecordAttempt(entry_it);\n+        }\n+\n+        // Add to set of rebroadcast candidates\n+        rebroadcast_txs.push_back(TxIds(txid, wtxid));\n+    }\n+\n+    TrimMaxRebroadcast();\n+\n+    std::chrono::microseconds delta1 = after_CNB_time - start_time;\n+    std::chrono::microseconds delta2 = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"GetRebroadcastTransactions(): %d Âµs total, %d Âµs spent in CreateNewBlock.\\n\", delta1.count(), delta2.count());\n+    LogPrint(BCLog::NET, \"Queued %d transactions for attempted rebroadcast, filtered from %d candidates with cached fee rate of %s.\\n\", rebroadcast_txs.size(), block_template->block.vtx.size() - 1, m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB));\n+\n+    for (TxIds ids : rebroadcast_txs) {\n+        LogPrint(BCLog::NET, \"Attempting to rebroadcast txid: %s, wtxid: %s\\n\", ids.m_txid.ToString(), ids.m_wtxid.ToString());\n+    }\n+\n+    return rebroadcast_txs;\n+};\n+\n+void TxRebroadcastHandler::CacheMinRebroadcastFee()\n+{\n+    // Update stamp of chain tip on cache run\n+    m_tip_at_cache_time = ::ChainActive().Tip();\n+\n+    // Update cache fee rate\n+    std::chrono::microseconds start_time = GetTime<std::chrono::microseconds>();\n+    m_cached_fee_rate = BlockAssembler(m_mempool, Params()).minTxFeeRate();\n+    std::chrono::microseconds delta_time = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"Caching minimum fee for rebroadcast to %s, took %d Âµs to calculate.\\n\", m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB), delta_time.count());\n+};\n+\n+void TxRebroadcastHandler::RecordAttempt(indexed_rebroadcast_set::index<index_by_wtxid>::type::iterator& entry_it)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602310627",
      "id" : 602310627,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjMxMDYyNw==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 112,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 621980840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602310627",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602313388"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602313388"
         }
      },
      "author_association" : "MEMBER",
      "body" : "y so verbose?\r\n\r\n```suggestion\r\nstatic constexpr std::chrono::hours MAX_ENTRY_AGE = 24h * 30 * 3;\r\n```",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-26T13:55:51Z",
      "diff_hunk" : "@@ -0,0 +1,141 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <validation.h>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE = 30min;\n+\n+/** Maximum number of times we will rebroadcast a tranasaction */\n+static constexpr int MAX_REBROADCAST_COUNT = 6;\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL = 4h;\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES = 500;\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE = std::chrono::hours(3 * 30 * 24);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602313388",
      "id" : 602313388,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjMxMzM4OA==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 31,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 621980840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602313388",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602315679"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602315679"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Import standard libraries first, then local modules (this is the opposite order from c++)",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-03-26T13:58:26Z",
      "diff_hunk" : "@@ -0,0 +1,191 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2009-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"Test node rebroadcast logic.\n+\n+We start by creating a set of transactions to set the rebroadcast minimum fee\n+cache to a medium fee rate value.\n+\n+We then create three sets of transactions:\n+    1. aged high fee rate\n+    2. aged low fee rate\n+    3. recent high fee rate\n+\n+We add a new connection, trigger the rebroadcast functionality by mining an\n+empty block, check that the aged high fee rate transactions were succesfully\n+rebroadcast, and that the other two sets were not rebroadcast.\n+\"\"\"\n+\n+from test_framework.p2p import P2PTxInvStore\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_approx,\n+    assert_greater_than,\n+    create_confirmed_utxos,\n+)\n+import time",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602315679",
      "id" : 602315679,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjMxNTY3OQ==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 28,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_rebroadcast.py",
      "position" : null,
      "pull_request_review_id" : 621980840,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/602315679",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK: this removes the rebroadcasting privacy leak\n\nI found the your [summary](https://github.com/amitiuttarwar/bitcoin-notes/blob/main/rebroadcast-history.md) of the previous discussion very helpful and still want to think though some of the edge cases in regards to e.g. bandwidth usage (which I think is already in a good state).\n\n--- \n\n@prayank23 I'm not sure I understood your concern with the constant min-age of 30min before consider to rebroadcast a transaction. This exists to limit the bandwidth usage (see the summary linked above if you haven't already read it). I think having this configurable doesn't add anything.\n\n---\n\nI've been comparing the contents of block templates to the actual blocks (with the goal detecting miners censoring transactions; unrelated to this PR). One edge case I've observed a few times is: \nA transaction `tx1` is missing from 100+ blocks it \"should have been in\". Manually rebroadcasting fails as there exists a conflicting and better propagated transaction `tx2` paying a substantially lower feerate. (This essentially a real-world observation of what @gmaxwell mentioned at the end of https://github.com/bitcoin/bitcoin/pull/16698#issuecomment-571399346 as a potential bandwidth attack). \n\nA naive implemention would try to rebroadcast `tx1` for each of the 100+ blocks until `tx2` confirms. I haven't checked your code, but based on the summary this would be mitigated by only rebroadcasting the transaction every 4h and not more than six times total. I don't think adding 'do-not-re-rebroadcast-previously-rejected/conflicting-tx'-logic is worth it.\n\n\n\n\n\n\n\n",
      "created_at" : "2021-03-31T13:33:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-811072127",
      "id" : 811072127,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxMTA3MjEyNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-31T13:33:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/811072127",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19157360?v=4",
         "events_url" : "https://api.github.com/users/0xB10C/events{/privacy}",
         "followers_url" : "https://api.github.com/users/0xB10C/followers",
         "following_url" : "https://api.github.com/users/0xB10C/following{/other_user}",
         "gists_url" : "https://api.github.com/users/0xB10C/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/0xB10C",
         "id" : 19157360,
         "login" : "0xB10C",
         "node_id" : "MDQ6VXNlcjE5MTU3MzYw",
         "organizations_url" : "https://api.github.com/users/0xB10C/orgs",
         "received_events_url" : "https://api.github.com/users/0xB10C/received_events",
         "repos_url" : "https://api.github.com/users/0xB10C/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/0xB10C/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/0xB10C/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/0xB10C"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-04-01T09:05:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-811767811",
      "id" : 811767811,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxMTc2NzgxMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-01T09:05:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/811767811",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r605955358"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/605955358"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "braced initialization? ð ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-01T21:26:23Z",
      "diff_hunk" : "@@ -0,0 +1,141 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <validation.h>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE = 30min;\n+\n+/** Maximum number of times we will rebroadcast a tranasaction */\n+static constexpr int MAX_REBROADCAST_COUNT = 6;\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL = 4h;\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES = 500;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r605955358",
      "id" : 605955358,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNTk1NTM1OA==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 34,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 626660219,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/605955358",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r605958836"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/605958836"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why oldest and not random eviction, for example?\r\nHave you considered having a configurable value (similar to `-maxorphantx`)?",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-01T21:34:05Z",
      "diff_hunk" : "@@ -0,0 +1,95 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXREBROADCAST_H\n+#define BITCOIN_TXREBROADCAST_H\n+\n+#include <policy/feerate.h>\n+#include <tuple>\n+#include <txmempool.h>\n+#include <util/hasher.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+struct TxIds {\n+    TxIds(uint256 txid, uint256 wtxid) : m_txid(txid), m_wtxid(wtxid) {}\n+\n+    const uint256 m_txid;\n+    const uint256 m_wtxid;\n+};\n+\n+struct RebroadcastEntry {\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\n+        : m_last_attempt(now_time),\n+          m_wtxid(wtxid),\n+          m_count(1) {}\n+\n+    std::chrono::microseconds m_last_attempt;\n+    const uint256 m_wtxid;\n+    int m_count;\n+};\n+\n+/** Used for multi_index tag  */\n+struct index_by_last_attempt {};\n+\n+using indexed_rebroadcast_set = boost::multi_index_container<\n+    RebroadcastEntry,\n+    boost::multi_index::indexed_by<\n+        // sorted by wtxid\n+        boost::multi_index::hashed_unique<\n+            boost::multi_index::tag<index_by_wtxid>,\n+            boost::multi_index::member<RebroadcastEntry, const uint256, &RebroadcastEntry::m_wtxid>,\n+            SaltedTxidHasher\n+        >,\n+        // sorted by last rebroadcast time\n+        boost::multi_index::ordered_non_unique<\n+            boost::multi_index::tag<index_by_last_attempt>,\n+            boost::multi_index::member<RebroadcastEntry, std::chrono::microseconds, &RebroadcastEntry::m_last_attempt>\n+        >\n+    >\n+>;\n+\n+class TxRebroadcastHandler\n+{\n+public:\n+    TxRebroadcastHandler(CTxMemPool& mempool, ChainstateManager& chainman)\n+        : m_mempool(mempool),\n+          m_chainman(chainman){};\n+\n+    std::vector<TxIds> GetRebroadcastTransactions();\n+\n+    /** Assemble a block from the highest fee rate packages in the local\n+     *  mempool. Update the cache with the minimum fee rate for a package to be\n+     *  included.\n+     * */\n+    void CacheMinRebroadcastFee();\n+\n+protected:\n+    /** Minimum fee rate for package to be included in block */\n+    CFeeRate m_cached_fee_rate;\n+\n+    /** Keep track of previous rebroadcast attempts */\n+    indexed_rebroadcast_set m_attempt_tracker;\n+\n+    /** Update an existing RebroadcastEntry - increment count and update timestamp */\n+    void RecordAttempt(indexed_rebroadcast_set::index<index_by_wtxid>::type::iterator& entry_it);\n+\n+private:\n+    const CTxMemPool& m_mempool;\n+\n+    const ChainstateManager& m_chainman;\n+\n+    /** Block at time of cache */\n+    CBlockIndex* m_tip_at_cache_time{nullptr};\n+\n+    /** Limit the size of m_attempt_tracker by deleting the oldest entries */\n+    void TrimMaxRebroadcast();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r605958836",
      "id" : 605958836,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNTk1ODgzNg==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 86,
      "original_position" : 92,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.h",
      "position" : null,
      "pull_request_review_id" : 626660219,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/605958836",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r605964572"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/605964572"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Other cases:\r\n- tx was RBFed out of mempool\r\n- parents were invalidated by conflicting tx in mempool and/or block\r\n\r\n~I think it boils down to = if we aren't keeping the tx in mempool, don't keep it in the rebroadcast tracker.~ I totally misunderstood, I thought you wouldn't want a tx in rebroadcast tracker if you didn't have it in mempool, but actually you'd want to keep it for a bit.\r\n\r\n",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-01T21:48:08Z",
      "diff_hunk" : "@@ -96,3 +104,24 @@ void TxRebroadcastHandler::RecordAttempt(indexed_rebroadcast_set::index<index_by\n \n     m_attempt_tracker.modify(entry_it, UpdateRebroadcastEntry);\n };\n+\n+void TxRebroadcastHandler::TrimMaxRebroadcast()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r605964572",
      "id" : 605964572,
      "in_reply_to_id" : 600952359,
      "line" : 191,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNTk2NDU3Mg==",
      "original_commit_id" : "6f70142fcecac7098fb5aed1ae51cc59d20fb14c",
      "original_line" : 191,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 191,
      "pull_request_review_id" : 626660219,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/605964572",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r605967262"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/605967262"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "~I don't think we should rebroadcast after every block if we're in IBD?~\r\nNevermind there's already an IBD gate above",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-01T21:55:02Z",
      "diff_hunk" : "@@ -1384,6 +1391,17 @@ void PeerManagerImpl::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlock\n         }\n     }\n \n+    // Rebroadcast selected mempool transactions\n+    if (gArgs.GetArg(\"-rebroadcast\", DEFAULT_REBROADCAST_ENABLED)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r605967262",
      "id" : 605967262,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNTk2NzI2Mg==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 1395,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 626660219,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/605967262",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r605968636"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/605968636"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Same, maybe not worth doing until after IBD?",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-01T21:58:17Z",
      "diff_hunk" : "@@ -1246,9 +1249,12 @@ PeerManagerImpl::PeerManagerImpl(const CChainParams& chainparams, CConnman& conn\n     static_assert(EXTRA_PEER_CHECK_INTERVAL < STALE_CHECK_INTERVAL, \"peer eviction timer should be less than stale tip check timer\");\n     scheduler.scheduleEvery([this] { this->CheckForStaleTipAndEvictPeers(); }, std::chrono::seconds{EXTRA_PEER_CHECK_INTERVAL});\n \n-    // schedule next run for 10-15 minutes in the future\n+    // Attempt initial broadcast of locally submitted transactions in 10-15 minutes\n     const std::chrono::milliseconds delta = std::chrono::minutes{10} + GetRandMillis(std::chrono::minutes{5});\n     scheduler.scheduleFromNow([&] { ReattemptInitialBroadcast(scheduler); }, delta);\n+\n+    // Rebroadcast cache every minute\n+    scheduler.scheduleEvery([this] { m_txrebroadcast.CacheMinRebroadcastFee(); }, std::chrono::minutes{1});",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r605968636",
      "id" : 605968636,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNTk2ODYzNg==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 1257,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 626660219,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/605968636",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> @prayank23 I'm not sure I understood your concern with the constant min-age of 30min before consider to rebroadcast a transaction. This exists to limit the bandwidth usage (see the summary linked above if you haven't already read it). I think having this configurable doesn't add anything.\r\n\r\n@0xB10C \r\n\r\nI think having this configurable improves a lot of things, however:\r\n\r\n1. You don't have to answer questions why its 30\r\n2. If not anyone. Can you answer me why its 30 and not 25 or 20? or 23.5 or something else?\r\n3. What is wrong with a range? Anything special with 30",
      "created_at" : "2021-04-03T01:41:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-812774166",
      "id" : 812774166,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxMjc3NDE2Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-03T01:41:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/812774166",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r606592920"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606592920"
         }
      },
      "author_association" : "MEMBER",
      "body" : "so you'd prefer if I hard coded this to `fIncludeWitness = true`? \r\nð¤ `IsWitnessEnabled` doesn't seem like an expensive function. ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-03T02:14:31Z",
      "diff_hunk" : "@@ -298,6 +311,43 @@ void BlockAssembler::SortForBlock(const CTxMemPool::setEntries& package, std::ve\n     std::sort(sortedEntries.begin(), sortedEntries.end(), CompareTxIterByAncestorCount());\n }\n \n+CFeeRate BlockAssembler::minTxFeeRate()\n+{\n+    int packages_selected = 0;\n+    int descendants_updated = 0;\n+    CFeeRate min_fee_rate = CFeeRate(COIN, 1);\n+\n+    resetBlock();\n+    pblocktemplate.reset(new CBlockTemplate());\n+\n+    if (!pblocktemplate.get()) {\n+        return min_fee_rate;\n+    }\n+    CBlock* block = &pblocktemplate->block;\n+\n+    // Add dummy coinbase tx as first transaction\n+    block->vtx.emplace_back();\n+    pblocktemplate->vTxFees.push_back(-1);\n+    pblocktemplate->vTxSigOpsCost.push_back(-1);\n+\n+    CBlockIndex* prev_block_index = ::ChainActive().Tip();\n+    assert(prev_block_index != nullptr);\n+    nHeight = prev_block_index->nHeight + 1;\n+\n+    block->nTime = static_cast<uint32_t>(GetAdjustedTime());\n+    const int64_t median_time_past = prev_block_index->GetMedianTimePast();\n+\n+    nLockTimeCutoff = median_time_past;\n+    fIncludeWitness = IsWitnessEnabled(prev_block_index, chainparams.GetConsensus());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r606592920",
      "id" : 606592920,
      "in_reply_to_id" : 602268144,
      "line" : 322,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNjU5MjkyMA==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 322,
      "original_position" : 93,
      "original_start_line" : null,
      "path" : "src/miner.cpp",
      "position" : 70,
      "pull_request_review_id" : 627423620,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/606592920",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r608381620"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/608381620"
         }
      },
      "author_association" : "NONE",
      "body" : "Removing entries from `m_attempt_tracker` when tx is removed from mempool doesn't seem necessary given `m_attempt_tracker` isn't used as a source for txs that need to be rebroadcasted.\r\n\r\nI also don't see an issue with keeping txs that have already been included in a block or RBFed out of mempool in the `m_attempt_tracker` for up to 90 days (as per current setting) or till it gets removed after 500 limit is reached. Removing these entries from `m_attempt_tracker` would  add unnecessary complexity for a small benefit of a little saved memory as far as I understand. On that note, would perhaps removing the 90 days limit and just keeping the 500 limit still be fine?",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-07T06:46:11Z",
      "diff_hunk" : "@@ -96,3 +104,24 @@ void TxRebroadcastHandler::RecordAttempt(indexed_rebroadcast_set::index<index_by\n \n     m_attempt_tracker.modify(entry_it, UpdateRebroadcastEntry);\n };\n+\n+void TxRebroadcastHandler::TrimMaxRebroadcast()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r608381620",
      "id" : 608381620,
      "in_reply_to_id" : 600952359,
      "line" : 191,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwODM4MTYyMA==",
      "original_commit_id" : "6f70142fcecac7098fb5aed1ae51cc59d20fb14c",
      "original_line" : 191,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 191,
      "pull_request_review_id" : 629644971,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/608381620",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/77497807?v=4",
         "events_url" : "https://api.github.com/users/i0x0ff/events{/privacy}",
         "followers_url" : "https://api.github.com/users/i0x0ff/followers",
         "following_url" : "https://api.github.com/users/i0x0ff/following{/other_user}",
         "gists_url" : "https://api.github.com/users/i0x0ff/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/i0x0ff",
         "id" : 77497807,
         "login" : "i0x0ff",
         "node_id" : "MDQ6VXNlcjc3NDk3ODA3",
         "organizations_url" : "https://api.github.com/users/i0x0ff/orgs",
         "received_events_url" : "https://api.github.com/users/i0x0ff/received_events",
         "repos_url" : "https://api.github.com/users/i0x0ff/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/i0x0ff/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/i0x0ff/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/i0x0ff"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r608501464"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/608501464"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Super small nit: Since this is new code - consider renaming as `after_cnb_time` to conform to the symbol naming conventions as described in the developer notes? :)",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-07T09:42:05Z",
      "diff_hunk" : "@@ -0,0 +1,141 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <validation.h>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE = 30min;\n+\n+/** Maximum number of times we will rebroadcast a tranasaction */\n+static constexpr int MAX_REBROADCAST_COUNT = 6;\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL = 4h;\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES = 500;\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE = std::chrono::hours(3 * 30 * 24);\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    std::chrono::microseconds start_time = GetTime<std::chrono::microseconds>();\n+\n+    // If there has not been a cache run since the last block, the fee rate\n+    // condition will not filter out any transactions, so skip this run.\n+    if (m_tip_at_cache_time == ::ChainActive().Tip()) return rebroadcast_txs;\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = MAX_REBROADCAST_WEIGHT;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.check_block_validity = false;\n+    options.blockMinFeeRate = m_cached_fee_rate;\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_mempool, Params(), options)\n+                          .CreateNewBlock(m_chainman.ActiveChainstate(), CScript());\n+    std::chrono::microseconds after_CNB_time = GetTime<std::chrono::microseconds>();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r608501464",
      "id" : 608501464,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwODUwMTQ2NA==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 51,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 629804032,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/608501464",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Looks like 7b8e976cd5ac78a22f1be2b2fed8562c693af5d9 (#21525) introduced a small merge conflict with 9307196d13ec589f01546ff8c4758211fc1d48cb in `miner.cpp` (function `BlockAssembler::CreateNewBlock`).\r\n\r\nI think it can be solved by changing `chainparams` to `m_chainparams` on the affected line.\r\nEdit: no, it is needed on more lines. This is just the only one where an explicit conflict happens.",
      "created_at" : "2021-04-07T14:14:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-814949875",
      "id" : 814949875,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxNDk0OTg3NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-07T14:24:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/814949875",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r608820579"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/608820579"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Removing entries from `m_attempt_tracker` when tx is removed from mempool doesn't seem necessary given `m_attempt_tracker` isn't used as a source for txs that need to be rebroadcasted.\r\n\r\nI agree that rebroadcast would still work - the problem is more that `m_attempt_tracker` might not be able to fulfill its intended purpose with a 500 limit if it was keeping track of too many unnecessary transactions (and at the same time expel those that it was meant to keep track off after capacity is reached).\r\n",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-07T16:40:54Z",
      "diff_hunk" : "@@ -96,3 +104,24 @@ void TxRebroadcastHandler::RecordAttempt(indexed_rebroadcast_set::index<index_by\n \n     m_attempt_tracker.modify(entry_it, UpdateRebroadcastEntry);\n };\n+\n+void TxRebroadcastHandler::TrimMaxRebroadcast()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r608820579",
      "id" : 608820579,
      "in_reply_to_id" : 600952359,
      "line" : 191,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwODgyMDU3OQ==",
      "original_commit_id" : "6f70142fcecac7098fb5aed1ae51cc59d20fb14c",
      "original_line" : 191,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 191,
      "pull_request_review_id" : 630230235,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/608820579",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609138170"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609138170"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-07T23:28:31Z",
      "diff_hunk" : "@@ -0,0 +1,95 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXREBROADCAST_H\n+#define BITCOIN_TXREBROADCAST_H\n+\n+#include <policy/feerate.h>\n+#include <tuple>\n+#include <txmempool.h>\n+#include <util/hasher.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+struct TxIds {\n+    TxIds(uint256 txid, uint256 wtxid) : m_txid(txid), m_wtxid(wtxid) {}\n+\n+    const uint256 m_txid;\n+    const uint256 m_wtxid;\n+};\n+\n+struct RebroadcastEntry {\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\n+        : m_last_attempt(now_time),\n+          m_wtxid(wtxid),\n+          m_count(1) {}\n+\n+    std::chrono::microseconds m_last_attempt;\n+    const uint256 m_wtxid;\n+    int m_count;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609138170",
      "id" : 609138170,
      "in_reply_to_id" : 594660140,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTEzODE3MA==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 35,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.h",
      "position" : null,
      "pull_request_review_id" : 630806829,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609138170",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609138293"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609138293"
         }
      },
      "author_association" : "MEMBER",
      "body" : "removed",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-07T23:28:50Z",
      "diff_hunk" : "@@ -0,0 +1,95 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXREBROADCAST_H\n+#define BITCOIN_TXREBROADCAST_H\n+\n+#include <policy/feerate.h>\n+#include <tuple>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609138293",
      "id" : 609138293,
      "in_reply_to_id" : 594661183,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTEzODI5Mw==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 9,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.h",
      "position" : null,
      "pull_request_review_id" : 630807264,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609138293",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609139124"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609139124"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yeah, I considered this approach but I went for an explicitly defined structure because its easy to mix up txid & wtxid, and doing so would cause quiet failures. It feels harder for a call site to accidentally mixup with the named access. ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-07T23:31:12Z",
      "diff_hunk" : "@@ -0,0 +1,95 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXREBROADCAST_H\n+#define BITCOIN_TXREBROADCAST_H\n+\n+#include <policy/feerate.h>\n+#include <tuple>\n+#include <txmempool.h>\n+#include <util/hasher.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+struct TxIds {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609139124",
      "id" : 609139124,
      "in_reply_to_id" : 594666637,
      "line" : 15,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTEzOTEyNA==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 15,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.h",
      "position" : 15,
      "pull_request_review_id" : 630811077,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609139124",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609139254"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609139254"
         }
      },
      "author_association" : "MEMBER",
      "body" : "great idea! done ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-07T23:31:42Z",
      "diff_hunk" : "@@ -325,6 +326,7 @@ class PeerManagerImpl final : public PeerManager\n     ChainstateManager& m_chainman;\n     CTxMemPool& m_mempool;\n     TxRequestTracker m_txrequest GUARDED_BY(::cs_main);\n+    TxRebroadcastHandler m_txrebroadcast;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609139254",
      "id" : 609139254,
      "in_reply_to_id" : 594670252,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTEzOTI1NA==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 329,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 630811754,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609139254",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609140585"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609140585"
         }
      },
      "author_association" : "MEMBER",
      "body" : "good point, removed",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-07T23:35:55Z",
      "diff_hunk" : "@@ -76,6 +80,9 @@ static BlockAssembler::Options DefaultOptions()\n     } else {\n         options.blockMinFeeRate = CFeeRate(DEFAULT_BLOCK_MIN_TX_FEE);\n     }\n+\n+    options.m_skip_inclusion_until = std::chrono::microseconds::max();\n+    options.check_block_validity = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609140585",
      "id" : 609140585,
      "in_reply_to_id" : 594672688,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTE0MDU4NQ==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 85,
      "original_position" : 24,
      "original_start_line" : 84,
      "path" : "src/miner.cpp",
      "position" : null,
      "pull_request_review_id" : 630817965,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609140585",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609140637"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609140637"
         }
      },
      "author_association" : "MEMBER",
      "body" : "removed",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-07T23:36:04Z",
      "diff_hunk" : "@@ -0,0 +1,193 @@\n+// Copyright (c) 2011-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <amount.h>\n+#include <boost/test/unit_test.hpp>\n+#include <clientversion.h>\n+#include <consensus/tx_check.h>\n+#include <consensus/validation.h>\n+#include <core_io.h>\n+#include <key_io.h>\n+#include <rpc/util.h>\n+#include <script/interpreter.h>\n+#include <script/script.h>\n+#include <streams.h>\n+#include <test/util/setup_common.h>\n+#include <tuple>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609140637",
      "id" : 609140637,
      "in_reply_to_id" : 594673886,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTE0MDYzNw==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 17,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/test/txrebroadcast_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 630818234,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609140637",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609142392"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609142392"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I separated them, but I have boost after internal. Is that ok? Btw, I don't see anything in the style guide about this, maybe we should add? ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-07T23:40:55Z",
      "diff_hunk" : "@@ -0,0 +1,193 @@\n+// Copyright (c) 2011-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <amount.h>\n+#include <boost/test/unit_test.hpp>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609142392",
      "id" : 609142392,
      "in_reply_to_id" : 594674279,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTE0MjM5Mg==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 6,
      "original_position" : 6,
      "original_start_line" : 5,
      "path" : "src/test/txrebroadcast_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 630825755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609142392",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609145300"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609145300"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think that having the boost headers has much tangible impact, but I decided to implement mostly for code legibility. The boost logic was ~1/2 of `txrebroadcast.h`, obscuring the way the module is supposed to be interacted with. I think it'd be fine for now, but more annoying if the rebroadcast logic were to get any more complex, which I think is a possibility. ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-07T23:49:10Z",
      "diff_hunk" : "@@ -0,0 +1,95 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXREBROADCAST_H\n+#define BITCOIN_TXREBROADCAST_H\n+\n+#include <policy/feerate.h>\n+#include <tuple>\n+#include <txmempool.h>\n+#include <util/hasher.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609145300",
      "id" : 609145300,
      "in_reply_to_id" : 594677303,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTE0NTMwMA==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 18,
      "original_position" : 18,
      "original_start_line" : 15,
      "path" : "src/txrebroadcast.h",
      "position" : null,
      "pull_request_review_id" : 630838092,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609145300",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609145812"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609145812"
         }
      },
      "author_association" : "MEMBER",
      "body" : "oops, removed",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-07T23:50:44Z",
      "diff_hunk" : "@@ -17,29 +16,63 @@ static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\n /** Default minimum age for a transaction to be rebroadcast */\n static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE = 30min;\n \n+/** Maximum number of times we will rebroadcast a tranasaction */\n+static constexpr int MAX_REBROADCAST_COUNT = 6;\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL = 4h;\n+\n std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\n {\n     std::vector<TxIds> rebroadcast_txs;\n+    std::chrono::microseconds start_time = GetTime<std::chrono::microseconds>();\n \n     // If there has not been a cache run since the last block, the fee rate\n     // condition will not filter out any transactions, so skip this run.\n     if (m_tip_at_cache_time == ::ChainActive().Tip()) return rebroadcast_txs;\n \n     BlockAssembler::Options options;\n     options.nBlockMaxWeight = MAX_REBROADCAST_WEIGHT;\n-    options.m_skip_inclusion_until = GetTime<std::chrono::microseconds>() - REBROADCAST_MIN_TX_AGE;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n     options.check_block_validity = false;\n     options.blockMinFeeRate = m_cached_fee_rate;\n \n     // Use CreateNewBlock to identify rebroadcast candidates\n     auto block_template = BlockAssembler(m_mempool, Params(), options)\n                           .CreateNewBlock(m_chainman.ActiveChainstate(), CScript());\n \n-    LOCK(m_mempool.cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609145812",
      "id" : 609145812,
      "in_reply_to_id" : 600948474,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTE0NTgxMg==",
      "original_commit_id" : "0c84415ae9fa1a32faace05db1e0d83979c7533b",
      "original_line" : 38,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 630840211,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609145812",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609146845"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609146845"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-07T23:54:01Z",
      "diff_hunk" : "@@ -0,0 +1,141 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <validation.h>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE = 30min;\n+\n+/** Maximum number of times we will rebroadcast a tranasaction */\n+static constexpr int MAX_REBROADCAST_COUNT = 6;\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL = 4h;\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES = 500;\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE = std::chrono::hours(3 * 30 * 24);\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    std::chrono::microseconds start_time = GetTime<std::chrono::microseconds>();\n+\n+    // If there has not been a cache run since the last block, the fee rate\n+    // condition will not filter out any transactions, so skip this run.\n+    if (m_tip_at_cache_time == ::ChainActive().Tip()) return rebroadcast_txs;\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = MAX_REBROADCAST_WEIGHT;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.check_block_validity = false;\n+    options.blockMinFeeRate = m_cached_fee_rate;\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_mempool, Params(), options)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609146845",
      "id" : 609146845,
      "in_reply_to_id" : 602170601,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTE0Njg0NQ==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 49,
      "original_position" : 49,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 630845156,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609146845",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609146983"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609146983"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-07T23:54:24Z",
      "diff_hunk" : "@@ -133,6 +133,10 @@ class BlockAssembler\n     bool fIncludeWitness;\n     unsigned int nBlockMaxWeight;\n     CFeeRate blockMinFeeRate;\n+    std::chrono::microseconds m_skip_inclusion_until;\n+\n+    // To permit disabling block validity check\n+    bool check_block_validity;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609146983",
      "id" : 609146983,
      "in_reply_to_id" : 602247755,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTE0Njk4Mw==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 139,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/miner.h",
      "position" : null,
      "pull_request_review_id" : 630845784,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609146983",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609147479"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609147479"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ok ok, I think I auto-ed the `GetTime` call sites. ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-07T23:55:49Z",
      "diff_hunk" : "@@ -0,0 +1,141 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <validation.h>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE = 30min;\n+\n+/** Maximum number of times we will rebroadcast a tranasaction */\n+static constexpr int MAX_REBROADCAST_COUNT = 6;\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL = 4h;\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES = 500;\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE = std::chrono::hours(3 * 30 * 24);\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    std::chrono::microseconds start_time = GetTime<std::chrono::microseconds>();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609147479",
      "id" : 609147479,
      "in_reply_to_id" : 602249928,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTE0NzQ3OQ==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 36,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 630848012,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609147479",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609147657"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609147657"
         }
      },
      "author_association" : "MEMBER",
      "body" : "aw man, I thought I was _so cool_ ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-07T23:56:21Z",
      "diff_hunk" : "@@ -0,0 +1,141 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <validation.h>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE = 30min;\n+\n+/** Maximum number of times we will rebroadcast a tranasaction */\n+static constexpr int MAX_REBROADCAST_COUNT = 6;\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL = 4h;\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES = 500;\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE = std::chrono::hours(3 * 30 * 24);\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    std::chrono::microseconds start_time = GetTime<std::chrono::microseconds>();\n+\n+    // If there has not been a cache run since the last block, the fee rate\n+    // condition will not filter out any transactions, so skip this run.\n+    if (m_tip_at_cache_time == ::ChainActive().Tip()) return rebroadcast_txs;\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = MAX_REBROADCAST_WEIGHT;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.check_block_validity = false;\n+    options.blockMinFeeRate = m_cached_fee_rate;\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_mempool, Params(), options)\n+                          .CreateNewBlock(m_chainman.ActiveChainstate(), CScript());\n+    std::chrono::microseconds after_CNB_time = GetTime<std::chrono::microseconds>();\n+\n+    for (const CTransactionRef& tx : block_template->block.vtx) {\n+        if (tx->IsCoinBase()) continue;\n+\n+        uint256 txid = tx->GetHash();\n+        uint256 wtxid = tx->GetWitnessHash();\n+\n+        // Check if we have previously rebroadcasted, decide if we will this\n+        // round, and if so, record the attempt.\n+        auto entry_it = m_attempt_tracker.find(wtxid);\n+\n+        if (entry_it == m_attempt_tracker.end()) {\n+            // No existing entry, we will rebroadcast, so create a new one\n+            RebroadcastEntry entry(start_time, wtxid);\n+            m_attempt_tracker.insert(entry);\n+        } else if (entry_it->m_count >= MAX_REBROADCAST_COUNT) {\n+            // We have already rebroadcast this transaction the maximum number\n+            // of times permitted, so skip rebroadcasting.\n+            continue;\n+        } else if (entry_it->m_last_attempt > start_time - MIN_REATTEMPT_INTERVAL) {\n+            // We already rebroadcasted this in the past 4 hours. Even if we\n+            // added it to the set, it would probably not get INVed to most\n+            // peers due to filterInventoryKnown.\n+            continue;\n+        } else {\n+            // We have rebroadcasted this transaction before, but will try\n+            // again now.\n+            RecordAttempt(entry_it);\n+        }\n+\n+        // Add to set of rebroadcast candidates\n+        rebroadcast_txs.push_back(TxIds(txid, wtxid));\n+    }\n+\n+    TrimMaxRebroadcast();\n+\n+    std::chrono::microseconds delta1 = after_CNB_time - start_time;\n+    std::chrono::microseconds delta2 = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"GetRebroadcastTransactions(): %d Âµs total, %d Âµs spent in CreateNewBlock.\\n\", delta1.count(), delta2.count());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609147657",
      "id" : 609147657,
      "in_reply_to_id" : 602255196,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTE0NzY1Nw==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 90,
      "original_position" : 90,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 630848798,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609147657",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609147770"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609147770"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-07T23:56:45Z",
      "diff_hunk" : "@@ -298,6 +311,43 @@ void BlockAssembler::SortForBlock(const CTxMemPool::setEntries& package, std::ve\n     std::sort(sortedEntries.begin(), sortedEntries.end(), CompareTxIterByAncestorCount());\n }\n \n+CFeeRate BlockAssembler::minTxFeeRate()\n+{\n+    int packages_selected = 0;\n+    int descendants_updated = 0;\n+    CFeeRate min_fee_rate = CFeeRate(COIN, 1);\n+\n+    resetBlock();\n+    pblocktemplate.reset(new CBlockTemplate());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609147770",
      "id" : 609147770,
      "in_reply_to_id" : 602266206,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTE0Nzc3MA==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 321,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/miner.cpp",
      "position" : null,
      "pull_request_review_id" : 630849283,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609147770",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609148059"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609148059"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yeah, looks like I copied this from `CreateNewBlock` and thought it was a \"safety check\" but I agree, it seems pointless. Removed.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-07T23:57:35Z",
      "diff_hunk" : "@@ -298,6 +311,43 @@ void BlockAssembler::SortForBlock(const CTxMemPool::setEntries& package, std::ve\n     std::sort(sortedEntries.begin(), sortedEntries.end(), CompareTxIterByAncestorCount());\n }\n \n+CFeeRate BlockAssembler::minTxFeeRate()\n+{\n+    int packages_selected = 0;\n+    int descendants_updated = 0;\n+    CFeeRate min_fee_rate = CFeeRate(COIN, 1);\n+\n+    resetBlock();\n+    pblocktemplate.reset(new CBlockTemplate());\n+\n+    if (!pblocktemplate.get()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609148059",
      "id" : 609148059,
      "in_reply_to_id" : 602267130,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTE0ODA1OQ==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 323,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/miner.cpp",
      "position" : null,
      "pull_request_review_id" : 630850553,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609148059",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609150392"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609150392"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done by making chainman a member",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-08T00:04:45Z",
      "diff_hunk" : "@@ -0,0 +1,141 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <validation.h>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE = 30min;\n+\n+/** Maximum number of times we will rebroadcast a tranasaction */\n+static constexpr int MAX_REBROADCAST_COUNT = 6;\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL = 4h;\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES = 500;\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE = std::chrono::hours(3 * 30 * 24);\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    std::chrono::microseconds start_time = GetTime<std::chrono::microseconds>();\n+\n+    // If there has not been a cache run since the last block, the fee rate\n+    // condition will not filter out any transactions, so skip this run.\n+    if (m_tip_at_cache_time == ::ChainActive().Tip()) return rebroadcast_txs;\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = MAX_REBROADCAST_WEIGHT;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.check_block_validity = false;\n+    options.blockMinFeeRate = m_cached_fee_rate;\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_mempool, Params(), options)\n+                          .CreateNewBlock(m_chainman.ActiveChainstate(), CScript());\n+    std::chrono::microseconds after_CNB_time = GetTime<std::chrono::microseconds>();\n+\n+    for (const CTransactionRef& tx : block_template->block.vtx) {\n+        if (tx->IsCoinBase()) continue;\n+\n+        uint256 txid = tx->GetHash();\n+        uint256 wtxid = tx->GetWitnessHash();\n+\n+        // Check if we have previously rebroadcasted, decide if we will this\n+        // round, and if so, record the attempt.\n+        auto entry_it = m_attempt_tracker.find(wtxid);\n+\n+        if (entry_it == m_attempt_tracker.end()) {\n+            // No existing entry, we will rebroadcast, so create a new one\n+            RebroadcastEntry entry(start_time, wtxid);\n+            m_attempt_tracker.insert(entry);\n+        } else if (entry_it->m_count >= MAX_REBROADCAST_COUNT) {\n+            // We have already rebroadcast this transaction the maximum number\n+            // of times permitted, so skip rebroadcasting.\n+            continue;\n+        } else if (entry_it->m_last_attempt > start_time - MIN_REATTEMPT_INTERVAL) {\n+            // We already rebroadcasted this in the past 4 hours. Even if we\n+            // added it to the set, it would probably not get INVed to most\n+            // peers due to filterInventoryKnown.\n+            continue;\n+        } else {\n+            // We have rebroadcasted this transaction before, but will try\n+            // again now.\n+            RecordAttempt(entry_it);\n+        }\n+\n+        // Add to set of rebroadcast candidates\n+        rebroadcast_txs.push_back(TxIds(txid, wtxid));\n+    }\n+\n+    TrimMaxRebroadcast();\n+\n+    std::chrono::microseconds delta1 = after_CNB_time - start_time;\n+    std::chrono::microseconds delta2 = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"GetRebroadcastTransactions(): %d Âµs total, %d Âµs spent in CreateNewBlock.\\n\", delta1.count(), delta2.count());\n+    LogPrint(BCLog::NET, \"Queued %d transactions for attempted rebroadcast, filtered from %d candidates with cached fee rate of %s.\\n\", rebroadcast_txs.size(), block_template->block.vtx.size() - 1, m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB));\n+\n+    for (TxIds ids : rebroadcast_txs) {\n+        LogPrint(BCLog::NET, \"Attempting to rebroadcast txid: %s, wtxid: %s\\n\", ids.m_txid.ToString(), ids.m_wtxid.ToString());\n+    }\n+\n+    return rebroadcast_txs;\n+};\n+\n+void TxRebroadcastHandler::CacheMinRebroadcastFee()\n+{\n+    // Update stamp of chain tip on cache run\n+    m_tip_at_cache_time = ::ChainActive().Tip();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609150392",
      "id" : 609150392,
      "in_reply_to_id" : 602269820,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTE1MDM5Mg==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 103,
      "original_position" : 103,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 630860859,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609150392",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609150476"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609150476"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-08T00:05:04Z",
      "diff_hunk" : "@@ -163,6 +169,12 @@ class BlockAssembler\n     static Optional<int64_t> m_last_block_num_txs;\n     static Optional<int64_t> m_last_block_weight;\n \n+    /* This function wraps addPackageTxs to calculate and return the minimum fee\n+     * rate required for a package to currently be included in the highest fee rate\n+     * block possible based on mempool transactions.\n+     */\n+    CFeeRate minTxFeeRate();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r609150476",
      "id" : 609150476,
      "in_reply_to_id" : 602270596,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwOTE1MDQ3Ng==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 176,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/miner.h",
      "position" : null,
      "pull_request_review_id" : 630861294,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/609150476",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "thank you all for the reviews! I'm working on incorporating/addressing all the comments. I've taken a first pass, but am still working my way through, I'll post again when I believe I've addressed all outstanding comments. ",
      "created_at" : "2021-04-08T02:08:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-815393414",
      "id" : 815393414,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxNTM5MzQxNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-08T02:08:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/815393414",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r610047195"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/610047195"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think you're right, so I've removed these three lines. nice catch! ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-08T19:49:05Z",
      "diff_hunk" : "@@ -298,6 +311,43 @@ void BlockAssembler::SortForBlock(const CTxMemPool::setEntries& package, std::ve\n     std::sort(sortedEntries.begin(), sortedEntries.end(), CompareTxIterByAncestorCount());\n }\n \n+CFeeRate BlockAssembler::minTxFeeRate()\n+{\n+    int packages_selected = 0;\n+    int descendants_updated = 0;\n+    CFeeRate min_fee_rate = CFeeRate(COIN, 1);\n+\n+    resetBlock();\n+    pblocktemplate.reset(new CBlockTemplate());\n+\n+    if (!pblocktemplate.get()) {\n+        return min_fee_rate;\n+    }\n+    CBlock* block = &pblocktemplate->block;\n+\n+    // Add dummy coinbase tx as first transaction\n+    block->vtx.emplace_back();\n+    pblocktemplate->vTxFees.push_back(-1);\n+    pblocktemplate->vTxSigOpsCost.push_back(-1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r610047195",
      "id" : 610047195,
      "in_reply_to_id" : 602276459,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMDA0NzE5NQ==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 331,
      "original_position" : 83,
      "original_start_line" : 329,
      "path" : "src/miner.cpp",
      "position" : null,
      "pull_request_review_id" : 631775638,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/610047195",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r610048842"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/610048842"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-08T19:51:40Z",
      "diff_hunk" : "@@ -298,6 +311,43 @@ void BlockAssembler::SortForBlock(const CTxMemPool::setEntries& package, std::ve\n     std::sort(sortedEntries.begin(), sortedEntries.end(), CompareTxIterByAncestorCount());\n }\n \n+CFeeRate BlockAssembler::minTxFeeRate()\n+{\n+    int packages_selected = 0;\n+    int descendants_updated = 0;\n+    CFeeRate min_fee_rate = CFeeRate(COIN, 1);\n+\n+    resetBlock();\n+    pblocktemplate.reset(new CBlockTemplate());\n+\n+    if (!pblocktemplate.get()) {\n+        return min_fee_rate;\n+    }\n+    CBlock* block = &pblocktemplate->block;\n+\n+    // Add dummy coinbase tx as first transaction\n+    block->vtx.emplace_back();\n+    pblocktemplate->vTxFees.push_back(-1);\n+    pblocktemplate->vTxSigOpsCost.push_back(-1);\n+\n+    CBlockIndex* prev_block_index = ::ChainActive().Tip();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r610048842",
      "id" : 610048842,
      "in_reply_to_id" : 602276869,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMDA0ODg0Mg==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 333,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/miner.cpp",
      "position" : null,
      "pull_request_review_id" : 631777585,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/610048842",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r610049607"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/610049607"
         }
      },
      "author_association" : "MEMBER",
      "body" : "agreed, gone",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-08T19:52:47Z",
      "diff_hunk" : "@@ -298,6 +311,43 @@ void BlockAssembler::SortForBlock(const CTxMemPool::setEntries& package, std::ve\n     std::sort(sortedEntries.begin(), sortedEntries.end(), CompareTxIterByAncestorCount());\n }\n \n+CFeeRate BlockAssembler::minTxFeeRate()\n+{\n+    int packages_selected = 0;\n+    int descendants_updated = 0;\n+    CFeeRate min_fee_rate = CFeeRate(COIN, 1);\n+\n+    resetBlock();\n+    pblocktemplate.reset(new CBlockTemplate());\n+\n+    if (!pblocktemplate.get()) {\n+        return min_fee_rate;\n+    }\n+    CBlock* block = &pblocktemplate->block;\n+\n+    // Add dummy coinbase tx as first transaction\n+    block->vtx.emplace_back();\n+    pblocktemplate->vTxFees.push_back(-1);\n+    pblocktemplate->vTxSigOpsCost.push_back(-1);\n+\n+    CBlockIndex* prev_block_index = ::ChainActive().Tip();\n+    assert(prev_block_index != nullptr);\n+    nHeight = prev_block_index->nHeight + 1;\n+\n+    block->nTime = static_cast<uint32_t>(GetAdjustedTime());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r610049607",
      "id" : 610049607,
      "in_reply_to_id" : 602278993,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMDA0OTYwNw==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 337,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "src/miner.cpp",
      "position" : null,
      "pull_request_review_id" : 631778430,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/610049607",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r610161831"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/610161831"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-08T22:29:21Z",
      "diff_hunk" : "@@ -0,0 +1,141 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <validation.h>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE = 30min;\n+\n+/** Maximum number of times we will rebroadcast a tranasaction */\n+static constexpr int MAX_REBROADCAST_COUNT = 6;\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL = 4h;\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES = 500;\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE = std::chrono::hours(3 * 30 * 24);\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    std::chrono::microseconds start_time = GetTime<std::chrono::microseconds>();\n+\n+    // If there has not been a cache run since the last block, the fee rate\n+    // condition will not filter out any transactions, so skip this run.\n+    if (m_tip_at_cache_time == ::ChainActive().Tip()) return rebroadcast_txs;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r610161831",
      "id" : 610161831,
      "in_reply_to_id" : 602301898,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMDE2MTgzMQ==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 40,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 631889360,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/610161831",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Two noob questions (I did not look at the code):\r\n\r\n1. Could it happen that well propagated transactions with high fees are unnecessary rebroadcasted by all nodes at the same time, if a new block is mined that does not include them? Could this even be common? @0xB10C do you have some stats, on average, per block, how many transactions are not mined, that should have been mined?\r\n\r\n2. Wrt transactions with very low fees that originated on our node, is my understanding correct:\r\n* before this PR we would have rebroadcast them which is good for propagation and bad for privacy\r\n* after this PR we would not rebroadcast them which is good for privacy and bad for propagation?\r\n\r\nIf yes, then what about still rebroadcasting our low-fee transactions but also rebroadcast a bunch of random ones to make it less obvious that a tx is ours?",
      "created_at" : "2021-04-09T15:09:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-816751363",
      "id" : 816751363,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxNjc1MTM2Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-09T15:09:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/816751363",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> 0xB10C do you have some stats, on average, per block, how many transactions are not mined, that should have been mined?\r\n\r\nOver the last ~2350 blocks there were on average 38 transactions (standard derivation of 116) and median 15 transactions not in the the block that my node's template (generated a few seconds before the pool-set block time Â¹ ) would have included. Not all of these on average 38 transactions would make it into the rebroadcast set. \r\n\r\n```\r\ncount    2347.000000\r\nmean       37.921176\r\nstd       116.198727\r\nmin         1.000000\r\n25%         6.000000\r\n50%        15.000000\r\n75%        36.000000\r\nmax      3226.000000\r\n```\r\n\r\nÂ¹) My methodology is not perfect as 1) pools clocks are not always accurate and 2) miners do additional nTime rolling on the timestamp so the pool likely generated his template before the block-time of the final block. That said, these numbers should still work here.",
      "created_at" : "2021-04-09T21:41:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-816987152",
      "id" : 816987152,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxNjk4NzE1Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-09T21:41:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/816987152",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19157360?v=4",
         "events_url" : "https://api.github.com/users/0xB10C/events{/privacy}",
         "followers_url" : "https://api.github.com/users/0xB10C/followers",
         "following_url" : "https://api.github.com/users/0xB10C/following{/other_user}",
         "gists_url" : "https://api.github.com/users/0xB10C/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/0xB10C",
         "id" : 19157360,
         "login" : "0xB10C",
         "node_id" : "MDQ6VXNlcjE5MTU3MzYw",
         "organizations_url" : "https://api.github.com/users/0xB10C/orgs",
         "received_events_url" : "https://api.github.com/users/0xB10C/received_events",
         "repos_url" : "https://api.github.com/users/0xB10C/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/0xB10C/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/0xB10C/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/0xB10C"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@0xB10C, thanks!\r\n\r\nSo, to summarize, most of the time, shortly after every block is created, all nodes (that run this software) will rebroadcast a few 10s of transactions (and occasionally a few 1000s of transactions (corresponding to max 3226 above)). And this will be because miners' algo for composing a block differ from ours, not necessary because the transactions are not well propagated.\r\n\r\nIs this too aggressive, possibly creating unnecessary traffic? Would it make sense to rebroadcast a given tx only if it should have been included in each one of the last N blocks, but was not? (currently, I assume, it works as if N=1)",
      "created_at" : "2021-04-12T08:38:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-817610973",
      "id" : 817610973,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxNzYxMDk3Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-12T08:38:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/817610973",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r611919507"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611919507"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 06890651027cc50bdf3897283386a973bbf55725 \"[mining] Add recency condition on block creation to get rebroadcast set\"\r\n\r\nThis comment could be clearer as `m_skip_inclusion_until` isn't really an age. Rather we exclude any transactions that entered the mempool after the time specified by `m_skip_inclusion_until`.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-12T20:06:55Z",
      "diff_hunk" : "@@ -188,7 +190,10 @@ class BlockAssembler\n       * only as an extra check in case of suboptimal node configuration */\n     bool TestPackageTransactions(const CTxMemPool::setEntries& package) const;\n     /** Return true if given transaction from mapTx has already been evaluated,\n-      * or if the transaction's cached data in mapTx is incorrect. */\n+      * or if the transaction's cached data in mapTx is incorrect.\n+      * If m_skip_inclusion_until is set in the options, we will skip\n+      * transactions until they meet that age. This is currently used for\n+      * rebroadcast logic.*/",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r611919507",
      "id" : 611919507,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMTkxOTUwNw==",
      "original_commit_id" : "06890651027cc50bdf3897283386a973bbf55725",
      "original_line" : 196,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/miner.h",
      "position" : null,
      "pull_request_review_id" : 633921697,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611919507",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r611930625"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611930625"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 8b4db051bac56cefa8c85fe20e5548ddfab0f070 \"[rebroadcast] Apply a fee rate filter\"\r\n\r\nI'm having a hard time understanding how this comment explains the condition here. Could you explain in more detail?",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-12T20:26:14Z",
      "diff_hunk" : "@@ -20,10 +21,15 @@ std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\n {\n     std::vector<TxIds> rebroadcast_txs;\n \n+    // If there has not been a cache run since the last block, the fee rate\n+    // condition will not filter out any transactions, so skip this run.\n+    if (m_tip_at_cache_time == m_chainman.ActiveChain().Tip()) return rebroadcast_txs;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r611930625",
      "id" : 611930625,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMTkzMDYyNQ==",
      "original_commit_id" : "8b4db051bac56cefa8c85fe20e5548ddfab0f070",
      "original_line" : 26,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 633921697,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611930625",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r611952972"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611952972"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In d579110263ad07386f1fbf796a3397a12340b6d5 \"[test] Add unit test for rebroadcast attempt logic\"\r\n\r\nIt seems like this for loop is not necessary as it is essentially doing `m_count += count`. Could instead be:\r\n\r\n```suggestion\r\n    auto UpdateRebroadcastEntry = [last_attempt_time, count](RebroadcastEntry& rebroadcast_entry) {\r\n        rebroadcast_entry.m_last_attempt = last_attempt_time;\r\n        rebroadcast_entry.m_count += count;\r\n    };\r\n\r\n    m_attempt_tracker->modify(it, UpdateRebroadcastEntry);\r\n```",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-12T21:03:35Z",
      "diff_hunk" : "@@ -181,3 +181,29 @@ void TxRebroadcastHandler::TrimMaxRebroadcast()\n         m_attempt_tracker->get<index_by_last_attempt>().erase(it);\n     }\n };\n+\n+void TxRebroadcastHandler::UpdateAttempt(const uint256 txhsh, const int count, const std::chrono::microseconds last_attempt_time)\n+{\n+    auto it = m_attempt_tracker->find(txhsh);\n+    for (int i = 0; i < count; ++i) {\n+        auto UpdateRebroadcastEntry = [last_attempt_time](RebroadcastEntry& rebroadcast_entry) {\n+            rebroadcast_entry.m_last_attempt = last_attempt_time;\n+            ++rebroadcast_entry.m_count;\n+        };\n+\n+        m_attempt_tracker->modify(it, UpdateRebroadcastEntry);\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r611952972",
      "id" : 611952972,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMTk1Mjk3Mg==",
      "original_commit_id" : "d579110263ad07386f1fbf796a3397a12340b6d5",
      "original_line" : 195,
      "original_position" : 15,
      "original_start_line" : 188,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 633921697,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611952972",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r611954385"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611954385"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In d579110263ad07386f1fbf796a3397a12340b6d5 \"[test] Add unit test for rebroadcast attempt logic\"\r\n\r\nIt seems a bit odd to me that this function is supposed to be a wrapper but it also implements a little bit of test logic in that it changes the recorded last attempt time. I think it would make more sense to have the main test logic calculate the timestamp change and make this function a pure wrapper (or perhaps remove the entire class).",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-12T21:06:07Z",
      "diff_hunk" : "@@ -20,6 +20,24 @@\n \n #include <boost/test/unit_test.hpp>\n \n+class TxRebroadcastHandlerTest : public TxRebroadcastHandler\n+{\n+public:\n+    TxRebroadcastHandlerTest(CTxMemPool& mempool, ChainstateManager& chainman, const CChainParams& chainparams) :\n+        TxRebroadcastHandler(mempool, chainman, chainparams){};\n+\n+    void UpdateAttempt(uint256 txhsh, int count)\n+    {\n+        auto attempt_time = GetTime<std::chrono::microseconds>() - 4h;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r611954385",
      "id" : 611954385,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMTk1NDM4NQ==",
      "original_commit_id" : "d579110263ad07386f1fbf796a3397a12340b6d5",
      "original_line" : 36,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/test/txrebroadcast_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 633921697,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611954385",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r611956645"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611956645"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 0f13d876977d6a83549fa40f68a73308ba10d95d \"[test] Add unit test for the fee rate cache\"\r\n\r\nSeems like this change should be part of the previous commit.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-12T21:10:11Z",
      "diff_hunk" : "@@ -96,7 +142,7 @@ BOOST_AUTO_TEST_CASE(max_rebroadcast)\n \n     // Check that the transaction gets returned to rebroadcast\n     std::vector<TxIds> candidates = tx_rebroadcast.GetRebroadcastTransactions();\n-    BOOST_CHECK_EQUAL(candidates.size(), 1);\n+    BOOST_REQUIRE_EQUAL(candidates.size(), 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r611956645",
      "id" : 611956645,
      "line" : 125,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMTk1NjY0NQ==",
      "original_commit_id" : "0f13d876977d6a83549fa40f68a73308ba10d95d",
      "original_line" : 125,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/test/txrebroadcast_tests.cpp",
      "position" : 125,
      "pull_request_review_id" : 633921697,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611956645",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r611956732"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611956732"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 0f13d876977d6a83549fa40f68a73308ba10d95d \"[test] Add unit test for the fee rate cache\"\r\n\r\nSeems like this change should be part of the previous commit.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-12T21:10:20Z",
      "diff_hunk" : "@@ -114,7 +160,7 @@ BOOST_AUTO_TEST_CASE(max_rebroadcast)\n     SetMockTime(current_time);\n     // Then check that it gets returned for rebroadacst\n     candidates = tx_rebroadcast.GetRebroadcastTransactions();\n-    BOOST_CHECK_EQUAL(candidates.size(), 1);\n+    BOOST_REQUIRE_EQUAL(candidates.size(), 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r611956732",
      "id" : 611956732,
      "line" : 145,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMTk1NjczMg==",
      "original_commit_id" : "0f13d876977d6a83549fa40f68a73308ba10d95d",
      "original_line" : 145,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "src/test/txrebroadcast_tests.cpp",
      "position" : 145,
      "pull_request_review_id" : 633921697,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611956732",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r611961040"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611961040"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 7005767691005f66e7e08ec2e575d436dae3be47 \"[test] Functional tests for rebroadcast logic.\"\r\n\r\n```suggestion\r\n# Copyright (c) 2021 The Bitcoin Core developers\r\n```",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-12T21:18:18Z",
      "diff_hunk" : "@@ -0,0 +1,191 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2009-2021 The Bitcoin Core developers",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r611961040",
      "id" : 611961040,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMTk2MTA0MA==",
      "original_commit_id" : "7005767691005f66e7e08ec2e575d436dae3be47",
      "original_line" : 2,
      "original_position" : 2,
      "original_start_line" : null,
      "path" : "test/functional/p2p_rebroadcast.py",
      "position" : null,
      "pull_request_review_id" : 633921697,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611961040",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r611964069"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611964069"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 7005767691005f66e7e08ec2e575d436dae3be47 \"[test] Functional tests for rebroadcast logic.\"\r\n\r\n`getrawtransaction` can decode txs too.\r\n\r\n\r\n```suggestion\r\n        raw_tx = node.getrawtransaction(input_tx_hsh, True)\r\n```",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-12T21:24:05Z",
      "diff_hunk" : "@@ -0,0 +1,191 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2009-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"Test node rebroadcast logic.\n+\n+We start by creating a set of transactions to set the rebroadcast minimum fee\n+cache to a medium fee rate value.\n+\n+We then create three sets of transactions:\n+    1. aged high fee rate\n+    2. aged low fee rate\n+    3. recent high fee rate\n+\n+We add a new connection, trigger the rebroadcast functionality by mining an\n+empty block, check that the aged high fee rate transactions were succesfully\n+rebroadcast, and that the other two sets were not rebroadcast.\n+\"\"\"\n+\n+from test_framework.p2p import P2PTxInvStore\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_approx,\n+    assert_greater_than,\n+    create_confirmed_utxos,\n+)\n+import time\n+from decimal import Decimal\n+\n+# Constant from consensus.h\n+MAX_BLOCK_WEIGHT = 4000000\n+\n+\n+class NodeRebroadcastTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\n+            \"-whitelist=127.0.0.1\",\n+            \"-txindex\",\n+            \"-rebroadcast=1\"\n+        ]] * self.num_nodes\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def make_txn_at_fee_rate(self, input_utxo, outputs, outputs_sum, desired_fee_rate, change_address):\n+        node = self.nodes[0]\n+        node1 = self.nodes[1]\n+\n+        inputs = [{'txid': input_utxo['txid'], 'vout': input_utxo['vout']}]\n+\n+        # Calculate how much input values add up to\n+        input_tx_hsh = input_utxo['txid']\n+        raw_tx = node.decoderawtransaction(node.getrawtransaction(input_tx_hsh))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r611964069",
      "id" : 611964069,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMTk2NDA2OQ==",
      "original_commit_id" : "7005767691005f66e7e08ec2e575d436dae3be47",
      "original_line" : 55,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "test/functional/p2p_rebroadcast.py",
      "position" : null,
      "pull_request_review_id" : 633921697,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611964069",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r611967264"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611967264"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 7005767691005f66e7e08ec2e575d436dae3be47 \"[test] Functional tests for rebroadcast logic.\"\r\n\r\nIt would be nice to not require the wallet for a p2p test.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-12T21:29:58Z",
      "diff_hunk" : "@@ -0,0 +1,191 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2009-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"Test node rebroadcast logic.\n+\n+We start by creating a set of transactions to set the rebroadcast minimum fee\n+cache to a medium fee rate value.\n+\n+We then create three sets of transactions:\n+    1. aged high fee rate\n+    2. aged low fee rate\n+    3. recent high fee rate\n+\n+We add a new connection, trigger the rebroadcast functionality by mining an\n+empty block, check that the aged high fee rate transactions were succesfully\n+rebroadcast, and that the other two sets were not rebroadcast.\n+\"\"\"\n+\n+from test_framework.p2p import P2PTxInvStore\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_approx,\n+    assert_greater_than,\n+    create_confirmed_utxos,\n+)\n+import time\n+from decimal import Decimal\n+\n+# Constant from consensus.h\n+MAX_BLOCK_WEIGHT = 4000000\n+\n+\n+class NodeRebroadcastTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\n+            \"-whitelist=127.0.0.1\",\n+            \"-txindex\",\n+            \"-rebroadcast=1\"\n+        ]] * self.num_nodes\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r611967264",
      "id" : 611967264,
      "line" : 46,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMTk2NzI2NA==",
      "original_commit_id" : "7005767691005f66e7e08ec2e575d436dae3be47",
      "original_line" : 46,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "test/functional/p2p_rebroadcast.py",
      "position" : 46,
      "pull_request_review_id" : 633921697,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611967264",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r612104598"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612104598"
         }
      },
      "author_association" : "MEMBER",
      "body" : "30 minutes was chosen as the minimum age to ensure that transactions would have ample time to propagate through mempools. I don't think it makes sense for this to be a configurable value, both because of what sipa highlighted here: https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-806284509, as well as the fact that it would increase the complexity of reasoning about & maintenance burden. However, that said, I don't think of this value (30min) as set in stone- through the review process & running the patch, we should identify if this value is appropriate. Another thing to keep in mind is that any rebroadcast candidates will have to pass through `filterInventoryKnown` for an inv to be sent to the peer. \r\n",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-13T03:40:34Z",
      "diff_hunk" : "@@ -7,17 +7,22 @@\n #include <miner.h>\n #include <script/script.h>\n #include <txrebroadcast.h>\n+#include <util/time.h>\n \n /** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n  *  such as miners mining priority transactions. */\n static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\n \n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE = 30min;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r612104598",
      "id" : 612104598,
      "in_reply_to_id" : 593968023,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjEwNDU5OA==",
      "original_commit_id" : "24e7415aeb248f5df3ca3492d5a6b75a213f978d",
      "original_line" : 24,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 634143525,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612104598",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r612114162"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612114162"
         }
      },
      "author_association" : "MEMBER",
      "body" : "RE oldest vs random:\r\nsince the attempt tracker updates the timestamp every time a transaction is selected as a candidate for rebroadcast, it makes sense to me that the least relevant would be ones that haven't been selected for the longest time. usually we use randomness in p2p data structures to ensure that a malicious peer cannot have disproportionate influence, which I don't think quite applies here. its possible that a peer could roll the attempt tracker, but they would also have to roll filterInventoryKnown in order to spend actual network bandwidth. I haven't thought this through in great depth, so let me know if I'm missing some reasons why we should consider randomizing.\r\n\r\nRE configurable: \r\nas sipa mentioned in https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-806284509, \"generally the criterion for deciding whether a parameter should be configurable is whether you can also give advice under which cases users should be changing it, and how.\" I am also sensitive to introducing configurable params because it increases the maintenance burden of the project essentially forever. Do you see use cases of how you would recommend users to adjust the attempt tracker? The main reason I'd imagine for wanting a larger tracker is to reduce bandwidth, but in that case I think a \"turn rebroadcast off\" toggle would make more sense (and of this PR its off by default) ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-13T04:06:49Z",
      "diff_hunk" : "@@ -0,0 +1,95 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXREBROADCAST_H\n+#define BITCOIN_TXREBROADCAST_H\n+\n+#include <policy/feerate.h>\n+#include <tuple>\n+#include <txmempool.h>\n+#include <util/hasher.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+struct TxIds {\n+    TxIds(uint256 txid, uint256 wtxid) : m_txid(txid), m_wtxid(wtxid) {}\n+\n+    const uint256 m_txid;\n+    const uint256 m_wtxid;\n+};\n+\n+struct RebroadcastEntry {\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\n+        : m_last_attempt(now_time),\n+          m_wtxid(wtxid),\n+          m_count(1) {}\n+\n+    std::chrono::microseconds m_last_attempt;\n+    const uint256 m_wtxid;\n+    int m_count;\n+};\n+\n+/** Used for multi_index tag  */\n+struct index_by_last_attempt {};\n+\n+using indexed_rebroadcast_set = boost::multi_index_container<\n+    RebroadcastEntry,\n+    boost::multi_index::indexed_by<\n+        // sorted by wtxid\n+        boost::multi_index::hashed_unique<\n+            boost::multi_index::tag<index_by_wtxid>,\n+            boost::multi_index::member<RebroadcastEntry, const uint256, &RebroadcastEntry::m_wtxid>,\n+            SaltedTxidHasher\n+        >,\n+        // sorted by last rebroadcast time\n+        boost::multi_index::ordered_non_unique<\n+            boost::multi_index::tag<index_by_last_attempt>,\n+            boost::multi_index::member<RebroadcastEntry, std::chrono::microseconds, &RebroadcastEntry::m_last_attempt>\n+        >\n+    >\n+>;\n+\n+class TxRebroadcastHandler\n+{\n+public:\n+    TxRebroadcastHandler(CTxMemPool& mempool, ChainstateManager& chainman)\n+        : m_mempool(mempool),\n+          m_chainman(chainman){};\n+\n+    std::vector<TxIds> GetRebroadcastTransactions();\n+\n+    /** Assemble a block from the highest fee rate packages in the local\n+     *  mempool. Update the cache with the minimum fee rate for a package to be\n+     *  included.\n+     * */\n+    void CacheMinRebroadcastFee();\n+\n+protected:\n+    /** Minimum fee rate for package to be included in block */\n+    CFeeRate m_cached_fee_rate;\n+\n+    /** Keep track of previous rebroadcast attempts */\n+    indexed_rebroadcast_set m_attempt_tracker;\n+\n+    /** Update an existing RebroadcastEntry - increment count and update timestamp */\n+    void RecordAttempt(indexed_rebroadcast_set::index<index_by_wtxid>::type::iterator& entry_it);\n+\n+private:\n+    const CTxMemPool& m_mempool;\n+\n+    const ChainstateManager& m_chainman;\n+\n+    /** Block at time of cache */\n+    CBlockIndex* m_tip_at_cache_time{nullptr};\n+\n+    /** Limit the size of m_attempt_tracker by deleting the oldest entries */\n+    void TrimMaxRebroadcast();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r612114162",
      "id" : 612114162,
      "in_reply_to_id" : 605958836,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjExNDE2Mg==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 86,
      "original_position" : 92,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.h",
      "position" : null,
      "pull_request_review_id" : 634156171,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612114162",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r612122954"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612122954"
         }
      },
      "author_association" : "MEMBER",
      "body" : "you're right, this comment is really confusing. updated to: \r\n```\r\n    // If the cache has run since we received the last block, the fee rate\r\n    // condition will not filter out any transactions, so skip this run.\r\n```\r\n\r\nAnd here's some more explanation: \r\n\r\nLet's refer to the fee rate for a txn to be in the top `MAX_REBROADCAST_WEIGHT` as top-of-mempool fee rate. The only event that has the ability to decrease the top-of-mempool fee rate is a block being mined. Otherwise, as transactions enter the mempool, the top-of-mempool fee rate either stays the same or increases. \r\n\r\nIf the top-of-mempool fee rate is only increasing over time, the fee rate cache would not help filter any transactions out. \r\n\r\nOur desired order is: cache | block | rebroadcast, with the delta between cache & block to be as small as possible. \r\n\r\nThe order we want to skip is: block | cache | rebroadcast, because then the fee rate filter will be meaningless, and would simply select the _next highest_ transactions to rebroadcast (which we logically wouldn't expect to be mined yet). \r\n\r\nDoes this make sense? Does the update to the comment help clarify? I'm not sure the best way to capture this in the code, so open to suggestions. ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-13T04:29:17Z",
      "diff_hunk" : "@@ -20,10 +21,15 @@ std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\n {\n     std::vector<TxIds> rebroadcast_txs;\n \n+    // If there has not been a cache run since the last block, the fee rate\n+    // condition will not filter out any transactions, so skip this run.\n+    if (m_tip_at_cache_time == m_chainman.ActiveChain().Tip()) return rebroadcast_txs;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r612122954",
      "id" : 612122954,
      "in_reply_to_id" : 611930625,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjEyMjk1NA==",
      "original_commit_id" : "8b4db051bac56cefa8c85fe20e5548ddfab0f070",
      "original_line" : 26,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 634165996,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612122954",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r612128556"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612128556"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done, how's it look? [`3f4b664` (#21061)](https://github.com/bitcoin/bitcoin/pull/21061/commits/3f4b664fbc021b1c1ccabbf0f448a208c1463496)",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-13T04:49:55Z",
      "diff_hunk" : "@@ -0,0 +1,141 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <validation.h>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE = 30min;\n+\n+/** Maximum number of times we will rebroadcast a tranasaction */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r612128556",
      "id" : 612128556,
      "in_reply_to_id" : 602306915,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjEyODU1Ng==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 26,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 634172110,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612128556",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r612129176"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612129176"
         }
      },
      "author_association" : "MEMBER",
      "body" : "no longer using the `RecordAttempt` function here, but did apply the concept so we don't call `GetTime` on a loop, https://github.com/bitcoin/bitcoin/pull/21061/files?file-filters%5B%5D=.cpp&file-filters%5B%5D=.h&file-filters%5B%5D=.py&file-filters%5B%5D=.sh#diff-7dff50848db96bdb8edffc4d21daeca6d9050ec0e67d96072780ea5751e7df06R124",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-13T04:52:22Z",
      "diff_hunk" : "@@ -0,0 +1,141 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <validation.h>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE = 30min;\n+\n+/** Maximum number of times we will rebroadcast a tranasaction */\n+static constexpr int MAX_REBROADCAST_COUNT = 6;\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL = 4h;\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES = 500;\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE = std::chrono::hours(3 * 30 * 24);\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    std::chrono::microseconds start_time = GetTime<std::chrono::microseconds>();\n+\n+    // If there has not been a cache run since the last block, the fee rate\n+    // condition will not filter out any transactions, so skip this run.\n+    if (m_tip_at_cache_time == ::ChainActive().Tip()) return rebroadcast_txs;\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = MAX_REBROADCAST_WEIGHT;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.check_block_validity = false;\n+    options.blockMinFeeRate = m_cached_fee_rate;\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_mempool, Params(), options)\n+                          .CreateNewBlock(m_chainman.ActiveChainstate(), CScript());\n+    std::chrono::microseconds after_CNB_time = GetTime<std::chrono::microseconds>();\n+\n+    for (const CTransactionRef& tx : block_template->block.vtx) {\n+        if (tx->IsCoinBase()) continue;\n+\n+        uint256 txid = tx->GetHash();\n+        uint256 wtxid = tx->GetWitnessHash();\n+\n+        // Check if we have previously rebroadcasted, decide if we will this\n+        // round, and if so, record the attempt.\n+        auto entry_it = m_attempt_tracker.find(wtxid);\n+\n+        if (entry_it == m_attempt_tracker.end()) {\n+            // No existing entry, we will rebroadcast, so create a new one\n+            RebroadcastEntry entry(start_time, wtxid);\n+            m_attempt_tracker.insert(entry);\n+        } else if (entry_it->m_count >= MAX_REBROADCAST_COUNT) {\n+            // We have already rebroadcast this transaction the maximum number\n+            // of times permitted, so skip rebroadcasting.\n+            continue;\n+        } else if (entry_it->m_last_attempt > start_time - MIN_REATTEMPT_INTERVAL) {\n+            // We already rebroadcasted this in the past 4 hours. Even if we\n+            // added it to the set, it would probably not get INVed to most\n+            // peers due to filterInventoryKnown.\n+            continue;\n+        } else {\n+            // We have rebroadcasted this transaction before, but will try\n+            // again now.\n+            RecordAttempt(entry_it);\n+        }\n+\n+        // Add to set of rebroadcast candidates\n+        rebroadcast_txs.push_back(TxIds(txid, wtxid));\n+    }\n+\n+    TrimMaxRebroadcast();\n+\n+    std::chrono::microseconds delta1 = after_CNB_time - start_time;\n+    std::chrono::microseconds delta2 = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"GetRebroadcastTransactions(): %d Âµs total, %d Âµs spent in CreateNewBlock.\\n\", delta1.count(), delta2.count());\n+    LogPrint(BCLog::NET, \"Queued %d transactions for attempted rebroadcast, filtered from %d candidates with cached fee rate of %s.\\n\", rebroadcast_txs.size(), block_template->block.vtx.size() - 1, m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB));\n+\n+    for (TxIds ids : rebroadcast_txs) {\n+        LogPrint(BCLog::NET, \"Attempting to rebroadcast txid: %s, wtxid: %s\\n\", ids.m_txid.ToString(), ids.m_wtxid.ToString());\n+    }\n+\n+    return rebroadcast_txs;\n+};\n+\n+void TxRebroadcastHandler::CacheMinRebroadcastFee()\n+{\n+    // Update stamp of chain tip on cache run\n+    m_tip_at_cache_time = ::ChainActive().Tip();\n+\n+    // Update cache fee rate\n+    std::chrono::microseconds start_time = GetTime<std::chrono::microseconds>();\n+    m_cached_fee_rate = BlockAssembler(m_mempool, Params()).minTxFeeRate();\n+    std::chrono::microseconds delta_time = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"Caching minimum fee for rebroadcast to %s, took %d Âµs to calculate.\\n\", m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB), delta_time.count());\n+};\n+\n+void TxRebroadcastHandler::RecordAttempt(indexed_rebroadcast_set::index<index_by_wtxid>::type::iterator& entry_it)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r612129176",
      "id" : 612129176,
      "in_reply_to_id" : 602310627,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjEyOTE3Ng==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 112,
      "original_position" : 112,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 634172845,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612129176",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r612129381"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612129381"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ok, done for all the constants in this file ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-13T04:53:16Z",
      "diff_hunk" : "@@ -0,0 +1,141 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <validation.h>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE = 30min;\n+\n+/** Maximum number of times we will rebroadcast a tranasaction */\n+static constexpr int MAX_REBROADCAST_COUNT = 6;\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL = 4h;\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES = 500;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r612129381",
      "id" : 612129381,
      "in_reply_to_id" : 605955358,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjEyOTM4MQ==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 34,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 634173135,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612129381",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r612129729"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612129729"
         }
      },
      "author_association" : "MEMBER",
      "body" : "good point! I kick off the scheduler here, but an early exit in the function if IBD: https://github.com/bitcoin/bitcoin/pull/21061/files?file-filters%5B%5D=.cpp&file-filters%5B%5D=.py&file-filters%5B%5D=.sh#diff-7dff50848db96bdb8edffc4d21daeca6d9050ec0e67d96072780ea5751e7df06R152",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-13T04:54:31Z",
      "diff_hunk" : "@@ -1246,9 +1249,12 @@ PeerManagerImpl::PeerManagerImpl(const CChainParams& chainparams, CConnman& conn\n     static_assert(EXTRA_PEER_CHECK_INTERVAL < STALE_CHECK_INTERVAL, \"peer eviction timer should be less than stale tip check timer\");\n     scheduler.scheduleEvery([this] { this->CheckForStaleTipAndEvictPeers(); }, std::chrono::seconds{EXTRA_PEER_CHECK_INTERVAL});\n \n-    // schedule next run for 10-15 minutes in the future\n+    // Attempt initial broadcast of locally submitted transactions in 10-15 minutes\n     const std::chrono::milliseconds delta = std::chrono::minutes{10} + GetRandMillis(std::chrono::minutes{5});\n     scheduler.scheduleFromNow([&] { ReattemptInitialBroadcast(scheduler); }, delta);\n+\n+    // Rebroadcast cache every minute\n+    scheduler.scheduleEvery([this] { m_txrebroadcast.CacheMinRebroadcastFee(); }, std::chrono::minutes{1});",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r612129729",
      "id" : 612129729,
      "in_reply_to_id" : 605968636,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjEyOTcyOQ==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 1257,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 634173548,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612129729",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r612130356"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612130356"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Used this suggested wording & updated to: \r\n```\r\n      * If m_skip_inclusion_until is set in the options, we will exclude any\r\n      * transactions that entered the mempool after the time specified. This is\r\n      * currently used for rebroadcast logic. */\r\n```",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-13T04:56:46Z",
      "diff_hunk" : "@@ -188,7 +190,10 @@ class BlockAssembler\n       * only as an extra check in case of suboptimal node configuration */\n     bool TestPackageTransactions(const CTxMemPool::setEntries& package) const;\n     /** Return true if given transaction from mapTx has already been evaluated,\n-      * or if the transaction's cached data in mapTx is incorrect. */\n+      * or if the transaction's cached data in mapTx is incorrect.\n+      * If m_skip_inclusion_until is set in the options, we will skip\n+      * transactions until they meet that age. This is currently used for\n+      * rebroadcast logic.*/",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r612130356",
      "id" : 612130356,
      "in_reply_to_id" : 611919507,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjEzMDM1Ng==",
      "original_commit_id" : "06890651027cc50bdf3897283386a973bbf55725",
      "original_line" : 196,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/miner.h",
      "position" : null,
      "pull_request_review_id" : 634174256,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612130356",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r612130713"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612130713"
         }
      },
      "author_association" : "MEMBER",
      "body" : "good point, updated!",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-13T04:57:49Z",
      "diff_hunk" : "@@ -181,3 +181,29 @@ void TxRebroadcastHandler::TrimMaxRebroadcast()\n         m_attempt_tracker->get<index_by_last_attempt>().erase(it);\n     }\n };\n+\n+void TxRebroadcastHandler::UpdateAttempt(const uint256 txhsh, const int count, const std::chrono::microseconds last_attempt_time)\n+{\n+    auto it = m_attempt_tracker->find(txhsh);\n+    for (int i = 0; i < count; ++i) {\n+        auto UpdateRebroadcastEntry = [last_attempt_time](RebroadcastEntry& rebroadcast_entry) {\n+            rebroadcast_entry.m_last_attempt = last_attempt_time;\n+            ++rebroadcast_entry.m_count;\n+        };\n+\n+        m_attempt_tracker->modify(it, UpdateRebroadcastEntry);\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r612130713",
      "id" : 612130713,
      "in_reply_to_id" : 611952972,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjEzMDcxMw==",
      "original_commit_id" : "d579110263ad07386f1fbf796a3397a12340b6d5",
      "original_line" : 195,
      "original_position" : 15,
      "original_start_line" : 188,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 634174588,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612130713",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r612130777"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612130777"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-13T04:57:57Z",
      "diff_hunk" : "@@ -96,7 +142,7 @@ BOOST_AUTO_TEST_CASE(max_rebroadcast)\n \n     // Check that the transaction gets returned to rebroadcast\n     std::vector<TxIds> candidates = tx_rebroadcast.GetRebroadcastTransactions();\n-    BOOST_CHECK_EQUAL(candidates.size(), 1);\n+    BOOST_REQUIRE_EQUAL(candidates.size(), 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r612130777",
      "id" : 612130777,
      "in_reply_to_id" : 611956645,
      "line" : 125,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjEzMDc3Nw==",
      "original_commit_id" : "0f13d876977d6a83549fa40f68a73308ba10d95d",
      "original_line" : 125,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/test/txrebroadcast_tests.cpp",
      "position" : 125,
      "pull_request_review_id" : 634174634,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612130777",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r612329994"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612329994"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, that's the right way to do it.\r\n\r\nI don't think we have any guidance in the style guide, but general best practice seems to be to go from small to large: https://stackoverflow.com/a/2762596/933705.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-13T10:37:13Z",
      "diff_hunk" : "@@ -0,0 +1,193 @@\n+// Copyright (c) 2011-2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <amount.h>\n+#include <boost/test/unit_test.hpp>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r612329994",
      "id" : 612329994,
      "in_reply_to_id" : 594674279,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjMyOTk5NA==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 6,
      "original_position" : 6,
      "original_start_line" : 5,
      "path" : "src/test/txrebroadcast_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 634434327,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612329994",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r612330523"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612330523"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(this is recommended in PEP8: https://www.python.org/dev/peps/pep-0008/#imports)",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-13T10:37:59Z",
      "diff_hunk" : "@@ -0,0 +1,191 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2009-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"Test node rebroadcast logic.\n+\n+We start by creating a set of transactions to set the rebroadcast minimum fee\n+cache to a medium fee rate value.\n+\n+We then create three sets of transactions:\n+    1. aged high fee rate\n+    2. aged low fee rate\n+    3. recent high fee rate\n+\n+We add a new connection, trigger the rebroadcast functionality by mining an\n+empty block, check that the aged high fee rate transactions were succesfully\n+rebroadcast, and that the other two sets were not rebroadcast.\n+\"\"\"\n+\n+from test_framework.p2p import P2PTxInvStore\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_approx,\n+    assert_greater_than,\n+    create_confirmed_utxos,\n+)\n+import time",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r612330523",
      "id" : 612330523,
      "in_reply_to_id" : 602315679,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjMzMDUyMw==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 28,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_rebroadcast.py",
      "position" : null,
      "pull_request_review_id" : 634434904,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612330523",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "FWIW, I've been running this for about a week (a total of 1012 blocks), and most blocks result in an attempt to rebroadcast 6 or fewer txs, 75% of blocks are 51 or under, 99% of blocks are under 600 transactions, and the highest 1% of blocks result in 586- 1075 txs being queued for rebroadcast.\r\n\r\nI haven't investigated how many of these \"queued for attempted rebroadcast\" txs actually result in an INV being sent to some/all peers (since they'll be filtered by the inventory known bloom filter if they were at all recent), or how many of the txs that get INVed actually get requested. (I have seen at least one rebroadcasted tx get requested by a peer though, so that's something!)",
      "created_at" : "2021-04-15T03:29:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-820030611",
      "id" : 820030611,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMDAzMDYxMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-15T03:29:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/820030611",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615063731"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615063731"
         }
      },
      "author_association" : "MEMBER",
      "body" : "agree that updating `min_package_fee_rate` is pretty cheap, there's no additional calculation, its just updating the stored value, but might do so up to ~once per mempool transaction. \r\n\r\nbut can you help me understand the context of why you're suggesting a reference? even if it's not a lot of calculation, seems unnecessary? \r\n\r\n(agree that returning a tuple instead of in/out params would be nice. but leaving other params as is within this PR.)",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-16T19:00:00Z",
      "diff_hunk" : "@@ -308,7 +358,7 @@ void BlockAssembler::SortForBlock(const CTxMemPool::setEntries& package, std::ve\n // Each time through the loop, we compare the best transaction in\n // mapModifiedTxs with the next transaction in the mempool to decide what\n // transaction package to work on next.\n-void BlockAssembler::addPackageTxs(int &nPackagesSelected, int &nDescendantsUpdated)\n+void BlockAssembler::addPackageTxs(int& nPackagesSelected, int& nDescendantsUpdated, CFeeRate* min_package_fee_rate)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615063731",
      "id" : 615063731,
      "in_reply_to_id" : 602295773,
      "line" : 342,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTA2MzczMQ==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 342,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/miner.cpp",
      "position" : 88,
      "pull_request_review_id" : 638006948,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615063731",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615105060"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615105060"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I added some logging to see how often this happens, and indeed it looks like it skips 1-3 times on most days, sometimes up to ~10 times. So, this mechanism seems good, I'll add it. ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-16T20:26:56Z",
      "diff_hunk" : "@@ -0,0 +1,141 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <validation.h>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE = 30min;\n+\n+/** Maximum number of times we will rebroadcast a tranasaction */\n+static constexpr int MAX_REBROADCAST_COUNT = 6;\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL = 4h;\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES = 500;\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE = std::chrono::hours(3 * 30 * 24);\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    std::chrono::microseconds start_time = GetTime<std::chrono::microseconds>();\n+\n+    // If there has not been a cache run since the last block, the fee rate\n+    // condition will not filter out any transactions, so skip this run.\n+    if (m_tip_at_cache_time == ::ChainActive().Tip()) return rebroadcast_txs;\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = MAX_REBROADCAST_WEIGHT;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.check_block_validity = false;\n+    options.blockMinFeeRate = m_cached_fee_rate;\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_mempool, Params(), options)\n+                          .CreateNewBlock(m_chainman.ActiveChainstate(), CScript());\n+    std::chrono::microseconds after_CNB_time = GetTime<std::chrono::microseconds>();\n+\n+    for (const CTransactionRef& tx : block_template->block.vtx) {\n+        if (tx->IsCoinBase()) continue;\n+\n+        uint256 txid = tx->GetHash();\n+        uint256 wtxid = tx->GetWitnessHash();\n+\n+        // Check if we have previously rebroadcasted, decide if we will this\n+        // round, and if so, record the attempt.\n+        auto entry_it = m_attempt_tracker.find(wtxid);\n+\n+        if (entry_it == m_attempt_tracker.end()) {\n+            // No existing entry, we will rebroadcast, so create a new one\n+            RebroadcastEntry entry(start_time, wtxid);\n+            m_attempt_tracker.insert(entry);\n+        } else if (entry_it->m_count >= MAX_REBROADCAST_COUNT) {\n+            // We have already rebroadcast this transaction the maximum number\n+            // of times permitted, so skip rebroadcasting.\n+            continue;\n+        } else if (entry_it->m_last_attempt > start_time - MIN_REATTEMPT_INTERVAL) {\n+            // We already rebroadcasted this in the past 4 hours. Even if we\n+            // added it to the set, it would probably not get INVed to most\n+            // peers due to filterInventoryKnown.\n+            continue;\n+        } else {\n+            // We have rebroadcasted this transaction before, but will try\n+            // again now.\n+            RecordAttempt(entry_it);\n+        }\n+\n+        // Add to set of rebroadcast candidates\n+        rebroadcast_txs.push_back(TxIds(txid, wtxid));\n+    }\n+\n+    TrimMaxRebroadcast();\n+\n+    std::chrono::microseconds delta1 = after_CNB_time - start_time;\n+    std::chrono::microseconds delta2 = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"GetRebroadcastTransactions(): %d Âµs total, %d Âµs spent in CreateNewBlock.\\n\", delta1.count(), delta2.count());\n+    LogPrint(BCLog::NET, \"Queued %d transactions for attempted rebroadcast, filtered from %d candidates with cached fee rate of %s.\\n\", rebroadcast_txs.size(), block_template->block.vtx.size() - 1, m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB));\n+\n+    for (TxIds ids : rebroadcast_txs) {\n+        LogPrint(BCLog::NET, \"Attempting to rebroadcast txid: %s, wtxid: %s\\n\", ids.m_txid.ToString(), ids.m_wtxid.ToString());\n+    }\n+\n+    return rebroadcast_txs;\n+};\n+\n+void TxRebroadcastHandler::CacheMinRebroadcastFee()\n+{\n+    // Update stamp of chain tip on cache run\n+    m_tip_at_cache_time = ::ChainActive().Tip();\n+\n+    // Update cache fee rate\n+    std::chrono::microseconds start_time = GetTime<std::chrono::microseconds>();\n+    m_cached_fee_rate = BlockAssembler(m_mempool, Params()).minTxFeeRate();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615105060",
      "id" : 615105060,
      "in_reply_to_id" : 596515495,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTEwNTA2MA==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 107,
      "original_position" : 107,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 638061925,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615105060",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615107046"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615107046"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I added commit 2ac22164f82a51d4eaece9acc42f346e8db679a5 to address this! I agree that when transactions are removed from the mempool for certain reasons, we are highly unlikely to see it again, so it makes sense for it to be removed from the rebroadcast attempt tracker. It's ok if it doesn't work perfectly for edge cases, but this behavior supports helps it work as intended. Thanks! ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-16T20:31:06Z",
      "diff_hunk" : "@@ -96,3 +104,24 @@ void TxRebroadcastHandler::RecordAttempt(indexed_rebroadcast_set::index<index_by\n \n     m_attempt_tracker.modify(entry_it, UpdateRebroadcastEntry);\n };\n+\n+void TxRebroadcastHandler::TrimMaxRebroadcast()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615107046",
      "id" : 615107046,
      "in_reply_to_id" : 600952359,
      "line" : 191,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTEwNzA0Ng==",
      "original_commit_id" : "6f70142fcecac7098fb5aed1ae51cc59d20fb14c",
      "original_line" : 191,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 191,
      "pull_request_review_id" : 638064435,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615107046",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615107487"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615107487"
         }
      },
      "author_association" : "MEMBER",
      "body" : "seems reasonable, but this PR is getting pretty huge so I'd rather keep this for a follow-up. I've noted it down here https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-771426879 so I can keep track of it, and am going to resolve this conversation. ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-16T20:32:08Z",
      "diff_hunk" : "@@ -8,15 +8,53 @@\n #include <policy/feerate.h>\n #include <tuple>\n #include <txmempool.h>\n+#include <util/hasher.h>\n+#include <util/time.h>\n #include <validation.h>\n \n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n struct TxIds {\n     TxIds(uint256 txid, uint256 wtxid) : m_txid(txid), m_wtxid(wtxid) {}\n \n     const uint256 m_txid;\n     const uint256 m_wtxid;\n };\n \n+struct RebroadcastEntry {\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\n+        : m_last_attempt(now_time),\n+          m_wtxid(wtxid),\n+          m_count(1) {}\n+\n+    std::chrono::microseconds m_last_attempt;\n+    const uint256 m_wtxid;\n+    int m_count;\n+};\n+\n+/** Used for multi_index tag  */\n+struct index_by_last_attempt {};\n+\n+using indexed_rebroadcast_set = boost::multi_index_container<",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615107487",
      "id" : 615107487,
      "in_reply_to_id" : 600955209,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTEwNzQ4Nw==",
      "original_commit_id" : "0c84415ae9fa1a32faace05db1e0d83979c7533b",
      "original_line" : 41,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.h",
      "position" : null,
      "pull_request_review_id" : 638065064,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615107487",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615108294"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615108294"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I tried to audit `addPackageTxs` and I think you're right that it's not necessary, but it's hard to be certain because there is a lot going on in the function & its only ever called under the `cs_main` lock. Do you have any recommendations for how I could build confidence other than checking the thread of every call site of every invoked function / variable? Maybe I could just remove and run the node and give it a ð if it doesn't crash for a week? ð",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-16T20:34:05Z",
      "diff_hunk" : "@@ -298,6 +311,43 @@ void BlockAssembler::SortForBlock(const CTxMemPool::setEntries& package, std::ve\n     std::sort(sortedEntries.begin(), sortedEntries.end(), CompareTxIterByAncestorCount());\n }\n \n+CFeeRate BlockAssembler::minTxFeeRate()\n+{\n+    int packages_selected = 0;\n+    int descendants_updated = 0;\n+    CFeeRate min_fee_rate = CFeeRate(COIN, 1);\n+\n+    resetBlock();\n+    pblocktemplate.reset(new CBlockTemplate());\n+\n+    if (!pblocktemplate.get()) {\n+        return min_fee_rate;\n+    }\n+    CBlock* block = &pblocktemplate->block;\n+\n+    // Add dummy coinbase tx as first transaction\n+    block->vtx.emplace_back();\n+    pblocktemplate->vTxFees.push_back(-1);\n+    pblocktemplate->vTxSigOpsCost.push_back(-1);\n+\n+    CBlockIndex* prev_block_index = ::ChainActive().Tip();\n+    assert(prev_block_index != nullptr);\n+    nHeight = prev_block_index->nHeight + 1;\n+\n+    block->nTime = static_cast<uint32_t>(GetAdjustedTime());\n+    const int64_t median_time_past = prev_block_index->GetMedianTimePast();\n+\n+    nLockTimeCutoff = median_time_past;\n+    fIncludeWitness = IsWitnessEnabled(prev_block_index, chainparams.GetConsensus());\n+\n+    {\n+        LOCK2(cs_main, m_mempool.cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615108294",
      "id" : 615108294,
      "in_reply_to_id" : 602283867,
      "line" : 325,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTEwODI5NA==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 325,
      "original_position" : 96,
      "original_start_line" : null,
      "path" : "src/miner.cpp",
      "position" : 73,
      "pull_request_review_id" : 638066211,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615108294",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615108623"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615108623"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ok! removed the entire class and just made the test functions public with a comment indicating they are test only ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-16T20:34:51Z",
      "diff_hunk" : "@@ -20,6 +20,24 @@\n \n #include <boost/test/unit_test.hpp>\n \n+class TxRebroadcastHandlerTest : public TxRebroadcastHandler\n+{\n+public:\n+    TxRebroadcastHandlerTest(CTxMemPool& mempool, ChainstateManager& chainman, const CChainParams& chainparams) :\n+        TxRebroadcastHandler(mempool, chainman, chainparams){};\n+\n+    void UpdateAttempt(uint256 txhsh, int count)\n+    {\n+        auto attempt_time = GetTime<std::chrono::microseconds>() - 4h;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615108623",
      "id" : 615108623,
      "in_reply_to_id" : 611954385,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTEwODYyMw==",
      "original_commit_id" : "d579110263ad07386f1fbf796a3397a12340b6d5",
      "original_line" : 36,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/test/txrebroadcast_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 638066656,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615108623",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615108953"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615108953"
         }
      },
      "author_association" : "MEMBER",
      "body" : "agreed, I've noted it down here: https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-771426879 so I can keep track of it, and will address either in this PR or in a follow up. I'm going to resolve this conversation and will track it with that comment.  ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-16T20:35:31Z",
      "diff_hunk" : "@@ -0,0 +1,191 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2009-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"Test node rebroadcast logic.\n+\n+We start by creating a set of transactions to set the rebroadcast minimum fee\n+cache to a medium fee rate value.\n+\n+We then create three sets of transactions:\n+    1. aged high fee rate\n+    2. aged low fee rate\n+    3. recent high fee rate\n+\n+We add a new connection, trigger the rebroadcast functionality by mining an\n+empty block, check that the aged high fee rate transactions were succesfully\n+rebroadcast, and that the other two sets were not rebroadcast.\n+\"\"\"\n+\n+from test_framework.p2p import P2PTxInvStore\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_approx,\n+    assert_greater_than,\n+    create_confirmed_utxos,\n+)\n+import time\n+from decimal import Decimal\n+\n+# Constant from consensus.h\n+MAX_BLOCK_WEIGHT = 4000000\n+\n+\n+class NodeRebroadcastTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\n+            \"-whitelist=127.0.0.1\",\n+            \"-txindex\",\n+            \"-rebroadcast=1\"\n+        ]] * self.num_nodes\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615108953",
      "id" : 615108953,
      "in_reply_to_id" : 611967264,
      "line" : 46,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTEwODk1Mw==",
      "original_commit_id" : "7005767691005f66e7e08ec2e575d436dae3be47",
      "original_line" : 46,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "test/functional/p2p_rebroadcast.py",
      "position" : 46,
      "pull_request_review_id" : 638067080,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615108953",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615132868"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615132868"
         }
      },
      "author_association" : "MEMBER",
      "body" : "IIUC the purpose of this variable, we assume miners's mempools to be composed in average of 1/4 of _irreplaceable_ transactions. I.e transactions even if we know better feerate candidates, we won't be able to replace them as their scores are unduly increased by miner's mempool policy.\r\n\r\nIntuitively, this sounds a lot, do you have any real-world data backing up this assumption ? One could look on how many mined block transactions are under the local node `MinTxFeeRate` you've introduced to determine the size of the _surprise_ set.\r\n\r\nWhat's the trade-off of picking a value deviating from real-world data ? Well I think you may prevent or delay rebroadcast of transactions in the bottom quarter of block feerate. Due to this delay, broadcasting clients of those transactions may reach a fee-bumping timer and they trigger a RBF/CPFP in consequence. As such bleeding feerate beyond what would have been effective to get into block templates.\r\n\r\nIf the risk I'm describing is founded, do you think we should preserve transactions broadcaster's feerate instead of network nodes' bandwidth ? I'm leaning toward a yes as rebroadcast logic is at least opt-in, but broadcaster won't be aware of their peers's policies barring propagation of their good-enough feerate transaction.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-16T21:34:02Z",
      "diff_hunk" : "@@ -0,0 +1,219 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615132868",
      "id" : 615132868,
      "line" : 21,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTEzMjg2OA==",
      "original_commit_id" : "d1bcb1d213ae380bbfce516a04c11a68864d3bbd",
      "original_line" : 21,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 21,
      "pull_request_review_id" : 638098056,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615132868",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615146994"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615146994"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Let's say an attacker partitions a victim's mempool from the rest of network mempools thanks to maliciously conflicting transactions. E.g send non-rbf signaling, _differing_ transactions to victim and all its tx-relay connected peers. \r\n\r\nThose malicious transactions are attached a feerate high-enough to completely occupy the `m_attempt_tracker`. Due to `MIN_REATTEMPT_INTERVAL`=4h and assuming 6 blocks per hour, it will require 6 * 4 * 500 = 12000 transactions to jam victim's rebroadcast attempt. Of course, `MAX_REBROADCAST_COUNT` should upper bound such behavior, but an attacker can easily renew `m_attempt_tracker` jamming by RBFing the pinning transactions.\r\n\r\nLet's assume malicious transactions size is `MIN_STANDARD_TX_NONWITNESS_SIZE`, so 82 bytes. Let's assume top block feerate is 170 sat/vbyte. Shrugging at RBF replacement fee penalties, 12_000 * 82 * 170 = 167_280_000 sats. So a permanent `m_attempt_tracker` jamming would require 1,67 BTC available to the attacker, though not burnt if the mempool isolation is operated properly.\r\n\r\nDo the attack model seems sound to you ? If so I think we should carefully document risks of `m_attempt_tracker` pinning and likely scale up parameters value.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-16T22:14:41Z",
      "diff_hunk" : "@@ -0,0 +1,219 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615146994",
      "id" : 615146994,
      "line" : 34,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTE0Njk5NA==",
      "original_commit_id" : "d1bcb1d213ae380bbfce516a04c11a68864d3bbd",
      "original_line" : 34,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 34,
      "pull_request_review_id" : 638098056,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615146994",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615153925"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615153925"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Assuming an entry's `m_count` reaches `MAX_REBROADCAST_COUNT`, it should never be again selected by `GetRebroadcastTransactions`. At that point, should we return an event to the wallet logic inviting to RBF the transaction ? \r\n\r\nOtherwise, the entry should stale until deletion by `TrimMaxRebroadcast`. At that point should we return an event inviting to re-submit the _same_ transaction ? Network mempools might have cleared up in between.\r\n\r\nI don't know if this new rebroadcasting mechanism should be transparent or not to Bitcoin applications vetted with their own rebroadcasting logics. ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-16T22:38:12Z",
      "diff_hunk" : "@@ -0,0 +1,219 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615153925",
      "id" : 615153925,
      "line" : 27,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTE1MzkyNQ==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 27,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 27,
      "pull_request_review_id" : 638098056,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615153925",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615156761"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615156761"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What's the rational to pick up this value ?\r\n\r\nI don't think Bitcoin applications care about confirmation of transactions broadcast 3 months ago. At the contrary, an attacker could use this really long expiration delay as a fingerprint vector.\r\n\r\nLet's say in optimistic scenarios, a rebroadcast entry has a compelling feerate enough to be selected by `GetRebroadcastTransactions` after each `MIN_REATTEMPT_INTERVAL`, after 6 * 4, it's matured enough to be legitimately expired ? Of course, we can assume some margin of error and double to 48h. Or even select `MEMPOOL_EXPIRY` as a maximum age. But I don't understand the month-length delay...  ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-16T22:48:22Z",
      "diff_hunk" : "@@ -0,0 +1,219 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE{24h * 30 * 3};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615156761",
      "id" : 615156761,
      "line" : 37,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTE1Njc2MQ==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 37,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 37,
      "pull_request_review_id" : 638098056,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615156761",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615157000"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615157000"
         }
      },
      "author_association" : "NONE",
      "body" : "```suggestion\r\n  txdb.h \\\r\n  txmempool.h \\\r\n  txorphanage.h \\\r\n  txrebroadcast.h \\\r\n  txrequest.h \\\r\n  undo.h \\\r\n```",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-16T22:49:23Z",
      "diff_hunk" : "@@ -226,6 +226,7 @@ BITCOIN_CORE_H = \\\n   txdb.h \\\n   txmempool.h \\\n   txorphanage.h \\\n+  txrebroadcast.h \\\n   txrequest.h \\\n   undo.h \\",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615157000",
      "id" : 615157000,
      "line" : 240,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTE1NzAwMA==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 240,
      "original_position" : 6,
      "original_start_line" : 226,
      "path" : "src/Makefile.am",
      "position" : 6,
      "pull_request_review_id" : 638126672,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : 235,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615157000",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/37097169?v=4",
         "events_url" : "https://api.github.com/users/78051301012/events{/privacy}",
         "followers_url" : "https://api.github.com/users/78051301012/followers",
         "following_url" : "https://api.github.com/users/78051301012/following{/other_user}",
         "gists_url" : "https://api.github.com/users/78051301012/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/78051301012",
         "id" : 37097169,
         "login" : "78051301012",
         "node_id" : "MDQ6VXNlcjM3MDk3MTY5",
         "organizations_url" : "https://api.github.com/users/78051301012/orgs",
         "received_events_url" : "https://api.github.com/users/78051301012/received_events",
         "repos_url" : "https://api.github.com/users/78051301012/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/78051301012/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/78051301012/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/78051301012"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615158074"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615158074"
         }
      },
      "author_association" : "MEMBER",
      "body" : "is there a suggestion here?",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-16T22:53:42Z",
      "diff_hunk" : "@@ -226,6 +226,7 @@ BITCOIN_CORE_H = \\\n   txdb.h \\\n   txmempool.h \\\n   txorphanage.h \\\n+  txrebroadcast.h \\\n   txrequest.h \\\n   undo.h \\",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615158074",
      "id" : 615158074,
      "in_reply_to_id" : 615157000,
      "line" : 240,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTE1ODA3NA==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 240,
      "original_position" : 6,
      "original_start_line" : 226,
      "path" : "src/Makefile.am",
      "position" : 6,
      "pull_request_review_id" : 638127908,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : 235,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615158074",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615158323"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615158323"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Have you tried to run this branch on mainet with a wide-sized mempool ? I think there is a logger in `CacheMinRebroadcastFee`, do you have stats to share on how much time it take by attempts ?\r\n\r\nNot sure if the block min feerate accuracy is worth the CPU time...",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-16T22:54:41Z",
      "diff_hunk" : "@@ -1283,22 +1286,57 @@ PeerManagerImpl::PeerManagerImpl(const CChainParams& chainparams, CConnman& conn\n     // same probability that we have in the reject filter).\n     m_recent_confirmed_transactions.reset(new CRollingBloomFilter(48000, 0.000001));\n \n+    if (enable_rebroadcast) {\n+        m_txrebroadcast = std::make_unique<TxRebroadcastHandler>(m_mempool, m_chainman, m_chainparams);\n+\n+        // Run fee rate cache every minute\n+        scheduler.scheduleEvery([this] { m_txrebroadcast->CacheMinRebroadcastFee(); }, std::chrono::minutes{1});",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615158323",
      "id" : 615158323,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTE1ODMyMw==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 1293,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 638098056,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615158323",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615159376"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615159376"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think a deletion criteria which might applied before age is delaying if `m_count` == `MAX_REBROADCAST_COUNT`. A transaction might be the oldest one but still feerate compelling and was unlucky on its previous rebroadcast attempts ?",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-16T22:58:11Z",
      "diff_hunk" : "@@ -0,0 +1,219 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE{24h * 30 * 3};\n+\n+struct RebroadcastEntry {\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\n+        : m_last_attempt(now_time),\n+          m_wtxid(wtxid) {}\n+\n+    std::chrono::microseconds m_last_attempt;\n+    const uint256 m_wtxid;\n+    int m_count{1};\n+};\n+\n+/** Used for multi_index tag  */\n+struct index_by_last_attempt {};\n+\n+class indexed_rebroadcast_set : public\n+boost::multi_index_container<\n+    RebroadcastEntry,\n+    boost::multi_index::indexed_by<\n+        // sorted by wtxid\n+        boost::multi_index::hashed_unique<\n+            boost::multi_index::tag<index_by_wtxid>,\n+            boost::multi_index::member<RebroadcastEntry, const uint256, &RebroadcastEntry::m_wtxid>,\n+            SaltedTxidHasher\n+        >,\n+        // sorted by last rebroadcast time\n+        boost::multi_index::ordered_non_unique<\n+            boost::multi_index::tag<index_by_last_attempt>,\n+            boost::multi_index::member<RebroadcastEntry, std::chrono::microseconds, &RebroadcastEntry::m_last_attempt>\n+        >\n+    >\n+>{};\n+\n+TxRebroadcastHandler::~TxRebroadcastHandler() = default;\n+\n+TxRebroadcastHandler::TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams)\n+    : m_mempool{mempool},\n+      m_chainman{chainman},\n+      m_chainparams(chainparams),\n+      m_attempt_tracker{std::make_unique<indexed_rebroadcast_set>()}{}\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    auto start_time = GetTime<std::chrono::microseconds>();\n+\n+    // If the cache has run since we received the last block, the fee rate\n+    // condition will not filter out any transactions, so skip this run.\n+    if (m_tip_at_cache_time == m_chainman.ActiveTip()) return rebroadcast_txs;\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = MAX_REBROADCAST_WEIGHT;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.m_check_block_validity = false;\n+    options.blockMinFeeRate = m_cached_fee_rate;\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_chainman.ActiveChainstate(), m_mempool, m_chainparams, options)\n+                              .CreateNewBlock(CScript());\n+    auto after_cnb_time = GetTime<std::chrono::microseconds>();\n+\n+    for (const CTransactionRef& tx : block_template->block.vtx) {\n+        if (tx->IsCoinBase()) continue;\n+\n+        uint256 txid = tx->GetHash();\n+        uint256 wtxid = tx->GetWitnessHash();\n+\n+        // Check if we have previously rebroadcasted, decide if we will this\n+        // round, and if so, record the attempt.\n+        auto entry_it = m_attempt_tracker->find(wtxid);\n+\n+        if (entry_it == m_attempt_tracker->end()) {\n+            // No existing entry, we will rebroadcast, so create a new one\n+            RebroadcastEntry entry(start_time, wtxid);\n+            m_attempt_tracker->insert(entry);\n+        } else if (entry_it->m_count >= MAX_REBROADCAST_COUNT) {\n+            // We have already rebroadcast this transaction the maximum number\n+            // of times permitted, so skip rebroadcasting.\n+            continue;\n+        } else if (entry_it->m_last_attempt > start_time - MIN_REATTEMPT_INTERVAL) {\n+            // We already rebroadcasted this in the past 4 hours. Even if we\n+            // added it to the set, it would probably not get INVed to most\n+            // peers due to filterInventoryKnown.\n+            continue;\n+        } else {\n+            // We have rebroadcasted this transaction before, but will try\n+            // again now. Record the attempt.\n+            auto UpdateRebroadcastEntry = [start_time](RebroadcastEntry& rebroadcast_entry) {\n+                rebroadcast_entry.m_last_attempt = start_time;\n+                ++rebroadcast_entry.m_count;\n+            };\n+\n+            m_attempt_tracker->modify(entry_it, UpdateRebroadcastEntry);\n+        }\n+\n+        // Add to set of rebroadcast candidates\n+        rebroadcast_txs.push_back(TxIds(txid, wtxid));\n+    }\n+\n+    TrimMaxRebroadcast();\n+\n+    auto delta1 = after_cnb_time - start_time;\n+    auto delta2 = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"GetRebroadcastTransactions(): %d us total, %d us spent in CreateNewBlock.\\n\", delta2.count(), delta1.count());\n+    LogPrint(BCLog::NET, \"Queued %d transactions for attempted rebroadcast, filtered from %d candidates with cached fee rate of %s.\\n\", rebroadcast_txs.size(), block_template->block.vtx.size() - 1, m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB));\n+\n+    for (TxIds ids : rebroadcast_txs) {\n+        LogPrint(BCLog::NET, \"Attempting to rebroadcast txid: %s, wtxid: %s\\n\", ids.m_txid.ToString(), ids.m_wtxid.ToString());\n+    }\n+\n+    return rebroadcast_txs;\n+};\n+\n+void TxRebroadcastHandler::CacheMinRebroadcastFee()\n+{\n+    if (m_chainman.ActiveChainstate().IsInitialBlockDownload()) return;\n+\n+    // Update stamp of chain tip on cache run\n+    m_tip_at_cache_time = m_chainman.ActiveTip();\n+\n+    // Update cache fee rate\n+    auto start_time = GetTime<std::chrono::microseconds>();\n+    m_cached_fee_rate = BlockAssembler(m_chainman.ActiveChainstate(), m_mempool, m_chainparams).MinTxFeeRate();\n+    auto delta_time = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"Caching minimum fee for rebroadcast to %s, took %d us to calculate.\\n\", m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB), delta_time.count());\n+};\n+\n+void TxRebroadcastHandler::RemoveFromAttemptTracker(const CTransactionRef& tx) {\n+    const auto it = m_attempt_tracker->find(tx->GetWitnessHash());\n+    if (it == m_attempt_tracker->end()) return;\n+    m_attempt_tracker->erase(it);\n+}\n+\n+void TxRebroadcastHandler::TrimMaxRebroadcast()\n+{\n+    // Delete any entries that are older than MAX_ENTRY_AGE\n+    auto min_age = GetTime<std::chrono::microseconds>() - MAX_ENTRY_AGE;\n+\n+    while (!m_attempt_tracker->empty()) {\n+        auto it = m_attempt_tracker->get<index_by_last_attempt>().begin();\n+        if (it->m_last_attempt < min_age) {\n+            m_attempt_tracker->get<index_by_last_attempt>().erase(it);\n+        } else {\n+            break;\n+        }\n+    }\n+\n+    // If there are still too many entries, delete the oldest ones",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615159376",
      "id" : 615159376,
      "line" : 205,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTE1OTM3Ng==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 205,
      "original_position" : 184,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 205,
      "pull_request_review_id" : 638098056,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-06T16:36:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615159376",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615159937"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615159937"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not exactly to be included in a block as we overprice its weight with `MAX_REBROADCAST_WEIGHT` ?",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-16T23:00:26Z",
      "diff_hunk" : "@@ -0,0 +1,85 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXREBROADCAST_H\n+#define BITCOIN_TXREBROADCAST_H\n+\n+#include <policy/feerate.h>\n+#include <txmempool.h>\n+#include <validation.h>\n+\n+struct TxIds {\n+    TxIds(uint256 txid, uint256 wtxid) : m_txid(txid), m_wtxid(wtxid) {}\n+\n+    const uint256 m_txid;\n+    const uint256 m_wtxid;\n+};\n+\n+class indexed_rebroadcast_set;\n+\n+class TxRebroadcastHandler\n+{\n+public:\n+    TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams);\n+    ~TxRebroadcastHandler();\n+\n+    TxRebroadcastHandler(const TxRebroadcastHandler& other) = delete;\n+    TxRebroadcastHandler& operator=(const TxRebroadcastHandler& other) = delete;\n+\n+    std::vector<TxIds> GetRebroadcastTransactions();\n+\n+    /** Assemble a block from the highest fee rate packages in the local\n+     *  mempool. Update the cache with the minimum fee rate for a package to be\n+     *  included.\n+     * */\n+    void CacheMinRebroadcastFee();\n+\n+    /** Remove transaction entry from the attempt tracker.*/\n+    void RemoveFromAttemptTracker(const CTransactionRef& tx);\n+\n+    /** Test only */\n+    void UpdateAttempt(const uint256& wtxid, const int count, const std::chrono::microseconds last_attempt_time);\n+\n+    /** Test only */\n+    bool CheckRecordedAttempt(const uint256& wtxid, const int expected_count, const std::chrono::microseconds expected_timestamp) const;\n+\n+    /** Test only */\n+    void UpdateCachedFeeRate(const CFeeRate& new_fee_rate);\n+\n+private:\n+    const CTxMemPool& m_mempool;\n+    const ChainstateManager& m_chainman;\n+    const CChainParams& m_chainparams;\n+\n+    /** Block at time of cache */\n+    CBlockIndex* m_tip_at_cache_time{nullptr};\n+\n+    /** Minimum fee rate for package to be included in block */\n+    CFeeRate m_cached_fee_rate;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615159937",
      "id" : 615159937,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTE1OTkzNw==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 62,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.h",
      "position" : null,
      "pull_request_review_id" : 638098056,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615159937",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615161228"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615161228"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't understand how victim's node distance from miner mempools make it easier or harder to successfully conflict. Of course, you can assume that few miner mempools are running full-rbf and as such you can't leverage lack of rbf signaling as a tx-relay jamming vector but a) require victim to be _strict neighbor_ of miner and b) attacker can exploit other relay policies differences, i.e non taproot spend allowed ?",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-16T23:06:21Z",
      "diff_hunk" : "@@ -0,0 +1,85 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXREBROADCAST_H\n+#define BITCOIN_TXREBROADCAST_H\n+\n+#include <policy/feerate.h>\n+#include <txmempool.h>\n+#include <validation.h>\n+\n+struct TxIds {\n+    TxIds(uint256 txid, uint256 wtxid) : m_txid(txid), m_wtxid(wtxid) {}\n+\n+    const uint256 m_txid;\n+    const uint256 m_wtxid;\n+};\n+\n+class indexed_rebroadcast_set;\n+\n+class TxRebroadcastHandler\n+{\n+public:\n+    TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams);\n+    ~TxRebroadcastHandler();\n+\n+    TxRebroadcastHandler(const TxRebroadcastHandler& other) = delete;\n+    TxRebroadcastHandler& operator=(const TxRebroadcastHandler& other) = delete;\n+\n+    std::vector<TxIds> GetRebroadcastTransactions();\n+\n+    /** Assemble a block from the highest fee rate packages in the local\n+     *  mempool. Update the cache with the minimum fee rate for a package to be\n+     *  included.\n+     * */\n+    void CacheMinRebroadcastFee();\n+\n+    /** Remove transaction entry from the attempt tracker.*/\n+    void RemoveFromAttemptTracker(const CTransactionRef& tx);\n+\n+    /** Test only */\n+    void UpdateAttempt(const uint256& wtxid, const int count, const std::chrono::microseconds last_attempt_time);\n+\n+    /** Test only */\n+    bool CheckRecordedAttempt(const uint256& wtxid, const int expected_count, const std::chrono::microseconds expected_timestamp) const;\n+\n+    /** Test only */\n+    void UpdateCachedFeeRate(const CFeeRate& new_fee_rate);\n+\n+private:\n+    const CTxMemPool& m_mempool;\n+    const ChainstateManager& m_chainman;\n+    const CChainParams& m_chainparams;\n+\n+    /** Block at time of cache */\n+    CBlockIndex* m_tip_at_cache_time{nullptr};\n+\n+    /** Minimum fee rate for package to be included in block */\n+    CFeeRate m_cached_fee_rate;\n+\n+    /** Keep track of previous rebroadcast attempts.\n+     *\n+     *  There are circumstances where our mempool might know about transactions\n+     *  that will never be mined. Two examples:\n+     *  1. A software upgrade tightens policy, but the node has not been\n+     *  upgraded and thus is accepting transactions that other nodes on the\n+     *  network now reject.\n+     *  2. An attacker targets the network by sending conflicting transactions\n+     *  to nodes based on their distance from a miner.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615161228",
      "id" : 615161228,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTE2MTIyOA==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 69,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.h",
      "position" : null,
      "pull_request_review_id" : 638098056,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615161228",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615164135"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615164135"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think you should document somewhere how `filterInventoryKnown` is mitigating bandwidth attacks as described by gmaxwell in your notes. Even if you can pin `m_attempt_tracker` permanently or for a while, most of reattempt should be ended up by being passed over and won't consume again INV bandwidth.\r\n\r\nThough you may roll over a majority of network nodes's `filterInventoryKnown` with cheap-RBF replacement ? Dunno if anyone has already done the math, but it might be interesting to know them for this PR...",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-16T23:18:42Z",
      "diff_hunk" : "@@ -0,0 +1,219 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615164135",
      "id" : 615164135,
      "line" : 31,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTE2NDEzNQ==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 31,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 31,
      "pull_request_review_id" : 638098056,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615164135",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615166865"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615166865"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think for rational 2) to hold (\"If a spy observes a bitcoin core node rebroadcasting a transaction, it would no longer know that the node has wallet enabled\"), you need bandwidth increase from rebroadcast set to be low enough for not being a burden to a wide majority of node operators. Otherwise, a privacy attacker can still guess with high success that only node operators with an associated wallet will activate rebroadcasting.\r\n\r\nIs the longer plan to activate it by default ? If so we should have really good real-world data and I think consensus of what's an acceptable bandwidth increase for the alleged benefits.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-16T23:30:54Z",
      "diff_hunk" : "@@ -458,6 +458,7 @@ void SetupServerArgs(NodeContext& node)\n     argsman.AddArg(\"-port=<port>\", strprintf(\"Listen for connections on <port>. Nodes not using the default ports (default: %u, testnet: %u, signet: %u, regtest: %u) are unlikely to get incoming connections.\", defaultChainParams->GetDefaultPort(), testnetChainParams->GetDefaultPort(), signetChainParams->GetDefaultPort(), regtestChainParams->GetDefaultPort()), ArgsManager::ALLOW_ANY | ArgsManager::NETWORK_ONLY, OptionsCategory::CONNECTION);\n     argsman.AddArg(\"-proxy=<ip:port>\", \"Connect through SOCKS5 proxy, set -noproxy to disable (default: disabled)\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n     argsman.AddArg(\"-proxyrandomize\", strprintf(\"Randomize credentials for every proxy connection. This enables Tor stream isolation (default: %u)\", DEFAULT_PROXYRANDOMIZE), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n+    argsman.AddArg(\"-rebroadcast\", strprintf(\"Enable node rebroadcast functionality (default: %u)\", DEFAULT_REBROADCAST_ENABLED), ArgsManager::ALLOW_BOOL | ArgsManager::DEBUG_ONLY, OptionsCategory::CONNECTION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615166865",
      "id" : 615166865,
      "line" : 451,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTE2Njg2NQ==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 451,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 4,
      "pull_request_review_id" : 638098056,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615166865",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "thank you all SO MUCH for these reviews ðð½ I believe I have addressed all outstanding review comments ð I have one more piece of functionality I'd like to implement in this patch ([link](https://github.com/bitcoin/bitcoin/pull/21061#discussion_r596515495)), but otherwise everything in this PR should be current and ready for further review.\r\n\r\nMy next step is to develop a patch for more insightful monitoring. I've been running this patch on mainnet for the past 2 weeks, and have seen results very similar to what aj reported [in this comment](https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-820030611). However, my main curiosity is how many of these transactions queued for rebroadcast 1. actually get `inv`ed to the network & 2. are subsequently requested via a `getdata`? Once I've written that, I'll share here incase anyone else is interested in running. \r\n\r\nA couple more conceptual responses:\r\n\r\n@0xB10C really cool that you're doing a very similar comparison, I'd be curious to learn more about how this patch compares to what you are running. I agree that the attempt tracker will mitigate & cap the worst case of something like this.\r\n\r\n@vasild it seems like your questions are highlighting two tensions that we are aiming to strike a balance between: \r\n1. privacy vs propagation\r\n2. propagation vs bandwidth \r\n\r\nWhile this patch uses `getblocktemplate` logic as a starting point for identifying which transactions to attempt to rebroadcast, there is a lot of nuance to ensure that we don't waste bandwidth (such as the attempt tracker). I'd suggest looking at the `GetRebroadcastTransaction` function ([link](https://github.com/bitcoin/bitcoin/pull/21061/files?file-filters%5B%5D=.cpp&file-filters%5B%5D=.h&file-filters%5B%5D=.py&file-filters%5B%5D=.sh#diff-7dff50848db96bdb8edffc4d21daeca6d9050ec0e67d96072780ea5751e7df06R78)) to see the various filters being applied. However, after they are selected, they will also need to pass through `filterInventoryKnown` before they actually make it as a network message. The monitoring I mentioned above will help us observe the numbers around that.\r\n\r\nIf we find that the number of transactions currently being rebroadcast is too high, the suggestion of looking at the last N blocks seems like a good approach :)",
      "created_at" : "2021-04-16T23:31:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-821722492",
      "id" : 821722492,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMTcyMjQ5Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-16T23:32:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/821722492",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615263491"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615263491"
         }
      },
      "author_association" : "MEMBER",
      "body" : "we apply `MAX_REBROADCAST_WEIGHT` for calculating the set of candidates when it is time to rebroadcast, not for calculating the minimum fee rate ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-17T14:45:45Z",
      "diff_hunk" : "@@ -0,0 +1,85 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXREBROADCAST_H\n+#define BITCOIN_TXREBROADCAST_H\n+\n+#include <policy/feerate.h>\n+#include <txmempool.h>\n+#include <validation.h>\n+\n+struct TxIds {\n+    TxIds(uint256 txid, uint256 wtxid) : m_txid(txid), m_wtxid(wtxid) {}\n+\n+    const uint256 m_txid;\n+    const uint256 m_wtxid;\n+};\n+\n+class indexed_rebroadcast_set;\n+\n+class TxRebroadcastHandler\n+{\n+public:\n+    TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams);\n+    ~TxRebroadcastHandler();\n+\n+    TxRebroadcastHandler(const TxRebroadcastHandler& other) = delete;\n+    TxRebroadcastHandler& operator=(const TxRebroadcastHandler& other) = delete;\n+\n+    std::vector<TxIds> GetRebroadcastTransactions();\n+\n+    /** Assemble a block from the highest fee rate packages in the local\n+     *  mempool. Update the cache with the minimum fee rate for a package to be\n+     *  included.\n+     * */\n+    void CacheMinRebroadcastFee();\n+\n+    /** Remove transaction entry from the attempt tracker.*/\n+    void RemoveFromAttemptTracker(const CTransactionRef& tx);\n+\n+    /** Test only */\n+    void UpdateAttempt(const uint256& wtxid, const int count, const std::chrono::microseconds last_attempt_time);\n+\n+    /** Test only */\n+    bool CheckRecordedAttempt(const uint256& wtxid, const int expected_count, const std::chrono::microseconds expected_timestamp) const;\n+\n+    /** Test only */\n+    void UpdateCachedFeeRate(const CFeeRate& new_fee_rate);\n+\n+private:\n+    const CTxMemPool& m_mempool;\n+    const ChainstateManager& m_chainman;\n+    const CChainParams& m_chainparams;\n+\n+    /** Block at time of cache */\n+    CBlockIndex* m_tip_at_cache_time{nullptr};\n+\n+    /** Minimum fee rate for package to be included in block */\n+    CFeeRate m_cached_fee_rate;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615263491",
      "id" : 615263491,
      "in_reply_to_id" : 615159937,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTI2MzQ5MQ==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 62,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.h",
      "position" : null,
      "pull_request_review_id" : 638232677,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615263491",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615289678"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615289678"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yup, here are some values are for running the whole function. Note that it does not distinguish CPU time vs time spent waiting to acquire the lock, as it currently acquires `cs_main` and `mempool.cs`, but the first might be unnecessary (see https://github.com/bitcoin/bitcoin/pull/21061#discussion_r602283867): \r\n\r\nthe median value is 9090 Î¼s, with 75% of the runs being under 11300 Î¼s, and 99% of the run being under 11826 Î¼s.\r\n\r\n> Not sure if the block min feerate accuracy is worth the CPU time...\r\n\r\nits a pretty critical component to this approach, without it the node would most likely be attempting to rebroadcast `MAX_REBROADCAST_WEIGHT` of transactions on every block.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-17T18:30:31Z",
      "diff_hunk" : "@@ -1283,22 +1286,57 @@ PeerManagerImpl::PeerManagerImpl(const CChainParams& chainparams, CConnman& conn\n     // same probability that we have in the reject filter).\n     m_recent_confirmed_transactions.reset(new CRollingBloomFilter(48000, 0.000001));\n \n+    if (enable_rebroadcast) {\n+        m_txrebroadcast = std::make_unique<TxRebroadcastHandler>(m_mempool, m_chainman, m_chainparams);\n+\n+        // Run fee rate cache every minute\n+        scheduler.scheduleEvery([this] { m_txrebroadcast->CacheMinRebroadcastFee(); }, std::chrono::minutes{1});",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615289678",
      "id" : 615289678,
      "in_reply_to_id" : 615158323,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTI4OTY3OA==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 1293,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 638266254,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615289678",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615290277"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615290277"
         }
      },
      "author_association" : "MEMBER",
      "body" : "agree that we don't want rebroadcast to have high bandwidth requirements. the longer plan is to activate it by default after building confidence about resource usage. please see [Merge Plan & Next Steps](https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-771426879).",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-17T18:36:48Z",
      "diff_hunk" : "@@ -458,6 +458,7 @@ void SetupServerArgs(NodeContext& node)\n     argsman.AddArg(\"-port=<port>\", strprintf(\"Listen for connections on <port>. Nodes not using the default ports (default: %u, testnet: %u, signet: %u, regtest: %u) are unlikely to get incoming connections.\", defaultChainParams->GetDefaultPort(), testnetChainParams->GetDefaultPort(), signetChainParams->GetDefaultPort(), regtestChainParams->GetDefaultPort()), ArgsManager::ALLOW_ANY | ArgsManager::NETWORK_ONLY, OptionsCategory::CONNECTION);\n     argsman.AddArg(\"-proxy=<ip:port>\", \"Connect through SOCKS5 proxy, set -noproxy to disable (default: disabled)\", ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n     argsman.AddArg(\"-proxyrandomize\", strprintf(\"Randomize credentials for every proxy connection. This enables Tor stream isolation (default: %u)\", DEFAULT_PROXYRANDOMIZE), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n+    argsman.AddArg(\"-rebroadcast\", strprintf(\"Enable node rebroadcast functionality (default: %u)\", DEFAULT_REBROADCAST_ENABLED), ArgsManager::ALLOW_BOOL | ArgsManager::DEBUG_ONLY, OptionsCategory::CONNECTION);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615290277",
      "id" : 615290277,
      "in_reply_to_id" : 615166865,
      "line" : 451,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTI5MDI3Nw==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 451,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 4,
      "pull_request_review_id" : 638266672,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615290277",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615295498"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615295498"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> I don't understand how victim's node distance from miner mempools make it easier or harder to successfully conflict\r\n\r\nI'm not suggesting it is?? ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-17T19:31:03Z",
      "diff_hunk" : "@@ -0,0 +1,85 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXREBROADCAST_H\n+#define BITCOIN_TXREBROADCAST_H\n+\n+#include <policy/feerate.h>\n+#include <txmempool.h>\n+#include <validation.h>\n+\n+struct TxIds {\n+    TxIds(uint256 txid, uint256 wtxid) : m_txid(txid), m_wtxid(wtxid) {}\n+\n+    const uint256 m_txid;\n+    const uint256 m_wtxid;\n+};\n+\n+class indexed_rebroadcast_set;\n+\n+class TxRebroadcastHandler\n+{\n+public:\n+    TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams);\n+    ~TxRebroadcastHandler();\n+\n+    TxRebroadcastHandler(const TxRebroadcastHandler& other) = delete;\n+    TxRebroadcastHandler& operator=(const TxRebroadcastHandler& other) = delete;\n+\n+    std::vector<TxIds> GetRebroadcastTransactions();\n+\n+    /** Assemble a block from the highest fee rate packages in the local\n+     *  mempool. Update the cache with the minimum fee rate for a package to be\n+     *  included.\n+     * */\n+    void CacheMinRebroadcastFee();\n+\n+    /** Remove transaction entry from the attempt tracker.*/\n+    void RemoveFromAttemptTracker(const CTransactionRef& tx);\n+\n+    /** Test only */\n+    void UpdateAttempt(const uint256& wtxid, const int count, const std::chrono::microseconds last_attempt_time);\n+\n+    /** Test only */\n+    bool CheckRecordedAttempt(const uint256& wtxid, const int expected_count, const std::chrono::microseconds expected_timestamp) const;\n+\n+    /** Test only */\n+    void UpdateCachedFeeRate(const CFeeRate& new_fee_rate);\n+\n+private:\n+    const CTxMemPool& m_mempool;\n+    const ChainstateManager& m_chainman;\n+    const CChainParams& m_chainparams;\n+\n+    /** Block at time of cache */\n+    CBlockIndex* m_tip_at_cache_time{nullptr};\n+\n+    /** Minimum fee rate for package to be included in block */\n+    CFeeRate m_cached_fee_rate;\n+\n+    /** Keep track of previous rebroadcast attempts.\n+     *\n+     *  There are circumstances where our mempool might know about transactions\n+     *  that will never be mined. Two examples:\n+     *  1. A software upgrade tightens policy, but the node has not been\n+     *  upgraded and thus is accepting transactions that other nodes on the\n+     *  network now reject.\n+     *  2. An attacker targets the network by sending conflicting transactions\n+     *  to nodes based on their distance from a miner.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615295498",
      "id" : 615295498,
      "in_reply_to_id" : 615161228,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTI5NTQ5OA==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 69,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.h",
      "position" : null,
      "pull_request_review_id" : 638269876,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615295498",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Hey @amitiuttarwar what is the best way to pay you for the work you have done? I don't have BTCPay but can do static address or paypal.",
      "created_at" : "2021-04-21T05:19:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-823783793",
      "id" : 823783793,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMzc4Mzc5Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-21T05:19:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/823783793",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48271670?v=4",
         "events_url" : "https://api.github.com/users/DISC30/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DISC30/followers",
         "following_url" : "https://api.github.com/users/DISC30/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DISC30/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DISC30",
         "id" : 48271670,
         "login" : "DISC30",
         "node_id" : "MDQ6VXNlcjQ4MjcxNjcw",
         "organizations_url" : "https://api.github.com/users/DISC30/orgs",
         "received_events_url" : "https://api.github.com/users/DISC30/received_events",
         "repos_url" : "https://api.github.com/users/DISC30/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DISC30/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DISC30/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DISC30"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r617629020"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617629020"
         }
      },
      "author_association" : "MEMBER",
      "body" : "So what are you suggesting is how a victim node distance from a miner enters into attacker motivation to target it ? Otherwise, I would suggest just drop \"distance from a miner\" part, I'm not sure if it significant information here.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-21T14:58:09Z",
      "diff_hunk" : "@@ -0,0 +1,85 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXREBROADCAST_H\n+#define BITCOIN_TXREBROADCAST_H\n+\n+#include <policy/feerate.h>\n+#include <txmempool.h>\n+#include <validation.h>\n+\n+struct TxIds {\n+    TxIds(uint256 txid, uint256 wtxid) : m_txid(txid), m_wtxid(wtxid) {}\n+\n+    const uint256 m_txid;\n+    const uint256 m_wtxid;\n+};\n+\n+class indexed_rebroadcast_set;\n+\n+class TxRebroadcastHandler\n+{\n+public:\n+    TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams);\n+    ~TxRebroadcastHandler();\n+\n+    TxRebroadcastHandler(const TxRebroadcastHandler& other) = delete;\n+    TxRebroadcastHandler& operator=(const TxRebroadcastHandler& other) = delete;\n+\n+    std::vector<TxIds> GetRebroadcastTransactions();\n+\n+    /** Assemble a block from the highest fee rate packages in the local\n+     *  mempool. Update the cache with the minimum fee rate for a package to be\n+     *  included.\n+     * */\n+    void CacheMinRebroadcastFee();\n+\n+    /** Remove transaction entry from the attempt tracker.*/\n+    void RemoveFromAttemptTracker(const CTransactionRef& tx);\n+\n+    /** Test only */\n+    void UpdateAttempt(const uint256& wtxid, const int count, const std::chrono::microseconds last_attempt_time);\n+\n+    /** Test only */\n+    bool CheckRecordedAttempt(const uint256& wtxid, const int expected_count, const std::chrono::microseconds expected_timestamp) const;\n+\n+    /** Test only */\n+    void UpdateCachedFeeRate(const CFeeRate& new_fee_rate);\n+\n+private:\n+    const CTxMemPool& m_mempool;\n+    const ChainstateManager& m_chainman;\n+    const CChainParams& m_chainparams;\n+\n+    /** Block at time of cache */\n+    CBlockIndex* m_tip_at_cache_time{nullptr};\n+\n+    /** Minimum fee rate for package to be included in block */\n+    CFeeRate m_cached_fee_rate;\n+\n+    /** Keep track of previous rebroadcast attempts.\n+     *\n+     *  There are circumstances where our mempool might know about transactions\n+     *  that will never be mined. Two examples:\n+     *  1. A software upgrade tightens policy, but the node has not been\n+     *  upgraded and thus is accepting transactions that other nodes on the\n+     *  network now reject.\n+     *  2. An attacker targets the network by sending conflicting transactions\n+     *  to nodes based on their distance from a miner.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r617629020",
      "id" : 617629020,
      "in_reply_to_id" : 615161228,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzYyOTAyMA==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 69,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.h",
      "position" : null,
      "pull_request_review_id" : 641200868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617629020",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r617653118"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617653118"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> the median value is 9090 Î¼s, with 75% of the runs being under 11300 Î¼s, and 99% of the run being under 11826 Î¼s.\r\n\r\nOkay and with a fulfilled mempool of the default size 300 MiB ? If yes I agree that's not that much and I think we're relieved on this concern :) If it does causes issues on low-grade nodes in the future, due to non-linear scaling of the CPU time in function of mempool size, I guess we'll be able to make this value configurable, offering a trade-off between CPU and bandwidth to node operators.\r\n\r\n> its a pretty critical component to this approach, without it the node would most likely be attempting to rebroadcast MAX_REBROADCAST_WEIGHT of transactions on every block.\r\n\r\nDo you mean without it or with a lower frequency rather than 1 min ? IIUC, the node would attempt to rebroadcast `MAX_REBROADCAST_WEIGHT` because you don't account for the fresh arrivals of new transactions. The feerate of those newcomers making most of your rebroadcast candidates irrelevant to block confirmation ? If refreshing the cache was costly, I guess we would run it once between _expected_ block intervals when the odds of having discovered enough new transactions to have a consistent view of next block are high. But cost is pretty low, so I don't think we care further... \r\n\r\nnit: maybe replace 1 by a named constant like `CACHE_REBROADCAST_FEERATE_FREQUENCY` ?",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-21T15:26:17Z",
      "diff_hunk" : "@@ -1283,22 +1286,57 @@ PeerManagerImpl::PeerManagerImpl(const CChainParams& chainparams, CConnman& conn\n     // same probability that we have in the reject filter).\n     m_recent_confirmed_transactions.reset(new CRollingBloomFilter(48000, 0.000001));\n \n+    if (enable_rebroadcast) {\n+        m_txrebroadcast = std::make_unique<TxRebroadcastHandler>(m_mempool, m_chainman, m_chainparams);\n+\n+        // Run fee rate cache every minute\n+        scheduler.scheduleEvery([this] { m_txrebroadcast->CacheMinRebroadcastFee(); }, std::chrono::minutes{1});",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r617653118",
      "id" : 617653118,
      "in_reply_to_id" : 615158323,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNzY1MzExOA==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 1293,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 641233365,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/617653118",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I haven't followed the project in detail over the past few months and might have missed some discussions on this aspect, so forgive me if this is a stupid question: The issues around nodes that use this new module but are not aware of a new softfork were discussed in the review club and also that `m_attempt_tracker` seems to resolve the issue. But it seems this could be exploited by an attacker at almost zero cost, spamming these nodes with such txs that are high fee but invalid under the new rules. Has this already been discussed somewhere? I havenât thought about it much but maybe rebroadcast should ignore txs with anyone-can-spend outputs?",
      "created_at" : "2021-04-25T13:25:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-826324358",
      "id" : 826324358,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNjMyNDM1OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-25T13:25:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/826324358",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r621629648"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/621629648"
         }
      },
      "author_association" : "MEMBER",
      "body" : "what is the fundamental resource that is being spent in this attack? are you evaluating the possibility of asymmetric bandwidth usage? if that's the case then you also need to factor in rolling over `filterInventoryKnown`. \r\n\r\nalso I don't understand how the attacker avoids spending any funds- say A and A' are two versions of the same txn via RBF. A is sent to the victim & A' is sent to the rest of the network. according to the current patch, if A' gets mined into a block, A is removed from the attempt tracker. \r\n\r\nupdate: wait, you refer to the bandwidth interactions with `filterInventoryKnown` in your comment https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615164135, so then I must be missing what you are trying to describe in this attack.  \r\n\r\nsecond update: is an assumption behind this hypothetical attack that jamming `m_attempt_tracker` would prevent a node from rebroadcasting? just want to clarify that rebroadcasts would work without the tracker, its mainly a technique to mitigate bandwidth usage.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-27T21:51:05Z",
      "diff_hunk" : "@@ -0,0 +1,219 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r621629648",
      "id" : 621629648,
      "in_reply_to_id" : 615146994,
      "line" : 34,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMTYyOTY0OA==",
      "original_commit_id" : "d1bcb1d213ae380bbfce516a04c11a68864d3bbd",
      "original_line" : 34,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 34,
      "pull_request_review_id" : 646390846,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/621629648",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r621632712"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/621632712"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> At that point, should we return an event to the wallet logic inviting to RBF the transaction ?\r\n\r\nthat's a cool idea. I don't think it is applicable yet, but I've noted it down for future work where it would be more relevant.\r\n\r\nwhy I don't think it is applicable yet: as of this patch, `ResendWalletTransactions` still calls `SubmitMemoryPoolAndRelay` with the `relay` bool set to `true` (aka patch doesn't change it). This gets used in `BroadcastTransaction` to force relaying the transaction to peers at the time of submission. in the future, the goal is to disable this (see \"Merge Plan & Next Steps\" in  https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-771426879), at which time I believe this sort of mechanism would make sense. ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-27T21:56:47Z",
      "diff_hunk" : "@@ -0,0 +1,219 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r621632712",
      "id" : 621632712,
      "in_reply_to_id" : 615153925,
      "line" : 27,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMTYzMjcxMg==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 27,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 27,
      "pull_request_review_id" : 646394238,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/621632712",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r621658134"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/621658134"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't understand this comment, let me explain some of the mechanisms incase that helps. otherwise, please help me understand what you are trying to communicate.\r\n\r\n> I don't think Bitcoin applications care about confirmation of transactions broadcast 3 months ago.\r\n\r\n1. the attempt tracker records the timestamp of when the mempool transaction was last selected for rebroadcast, not when it was initially broadcast / ATMPed (see https://github.com/bitcoin/bitcoin/pull/21061/files?file-filters%5B%5D=.cpp&file-filters%5B%5D=.h&file-filters%5B%5D=.py&file-filters%5B%5D=.sh#diff-7dff50848db96bdb8edffc4d21daeca6d9050ec0e67d96072780ea5751e7df06R110 and https://github.com/bitcoin/bitcoin/pull/21061/files?file-filters%5B%5D=.cpp&file-filters%5B%5D=.h&file-filters%5B%5D=.py&file-filters%5B%5D=.sh#diff-7dff50848db96bdb8edffc4d21daeca6d9050ec0e67d96072780ea5751e7df06R125).\r\n2. `MAX_ENTRY_AGE` is only called from `TrimMaxRebroadcast`. It is essentially used to say \"if a transaction hasn't been selected for rebroadcast in the past 3 months, remove it from the attempt tracker\"\r\n\r\n> Let's say in optimistic scenarios, a rebroadcast entry has a compelling feerate enough to be selected by GetRebroadcastTransactions after each MIN_REATTEMPT_INTERVAL, after 6 * 4, it's matured enough to be legitimately expired ?\r\n\r\ncan you clarify what you mean by \"legitimately expired\"? if you mean that we should disable automatic rebroadcast so the txn can (probably) expire from the (majority of) network mempools, then yes I agree. which is why we put it on the tracker. but then, what is the question? \r\n\r\n>  select MEMPOOL_EXPIRY as a maximum age.\r\n\r\nif we stored transactions on the attempt tracker for the same duration as `MEMPOOL_EXPIRY` time, that would leave room for the issue that the attempt tracker is meant to address. for more explanation on that, please see https://github.com/amitiuttarwar/bitcoin-notes/blob/main/rebroadcast-history.md#faq section \"What happens if a transaction can / will never be mined?\". expiry would be one of the main ways to get the ping-ponging behavior for never-going-to-be-mined transactions (eg. due to a policy upgrade on the network).",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-27T22:30:54Z",
      "diff_hunk" : "@@ -0,0 +1,219 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE{24h * 30 * 3};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r621658134",
      "id" : 621658134,
      "in_reply_to_id" : 615156761,
      "line" : 37,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMTY1ODEzNA==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 37,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 37,
      "pull_request_review_id" : 646422332,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/621658134",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r621660734"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/621660734"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Okay and with a fulfilled mempool of the default size 300 MiB ? If yes I agree that's not that much and I think we're relieved on this concern :)\r\n\r\nmy mempool is bumped up to 1000MiB, so these are values for a significantly-larger-than-normal mempool :)\r\n\r\n> I guess we'll be able to make this value configurable\r\n\r\nyup, rebroadcast currently defaults off, but the plan is to keep this toggle in the long run to address any bandwidth concerns.\r\n\r\n",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-27T22:36:39Z",
      "diff_hunk" : "@@ -1283,22 +1286,57 @@ PeerManagerImpl::PeerManagerImpl(const CChainParams& chainparams, CConnman& conn\n     // same probability that we have in the reject filter).\n     m_recent_confirmed_transactions.reset(new CRollingBloomFilter(48000, 0.000001));\n \n+    if (enable_rebroadcast) {\n+        m_txrebroadcast = std::make_unique<TxRebroadcastHandler>(m_mempool, m_chainman, m_chainparams);\n+\n+        // Run fee rate cache every minute\n+        scheduler.scheduleEvery([this] { m_txrebroadcast->CacheMinRebroadcastFee(); }, std::chrono::minutes{1});",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r621660734",
      "id" : 621660734,
      "in_reply_to_id" : 615158323,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMTY2MDczNA==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 1293,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 646430272,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/621660734",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r621673594"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/621673594"
         }
      },
      "author_association" : "MEMBER",
      "body" : "hm, then what do you propose as the method to ensure old attempts expire from the tracker?\r\n\r\nkeep in mind that the time is updated every time a transaction is selected to be rebroadcast.\r\n\r\nthat said, there still could be the case that the transaction is very high fee rate but hasn't been rebroadcast in a long time because it hit the `MAX_REBROADCAST_COUNT`. if this is the concern, we could address that by re-ordering the if / else logic in `GetRebroadcastTransactions` and update the timestamp if a transaction is being considered to rebroadcast, but filtered due to having hit the max. this way they would stay recent and we could continue with the same deletion logic.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-27T22:59:45Z",
      "diff_hunk" : "@@ -0,0 +1,219 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE{24h * 30 * 3};\n+\n+struct RebroadcastEntry {\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\n+        : m_last_attempt(now_time),\n+          m_wtxid(wtxid) {}\n+\n+    std::chrono::microseconds m_last_attempt;\n+    const uint256 m_wtxid;\n+    int m_count{1};\n+};\n+\n+/** Used for multi_index tag  */\n+struct index_by_last_attempt {};\n+\n+class indexed_rebroadcast_set : public\n+boost::multi_index_container<\n+    RebroadcastEntry,\n+    boost::multi_index::indexed_by<\n+        // sorted by wtxid\n+        boost::multi_index::hashed_unique<\n+            boost::multi_index::tag<index_by_wtxid>,\n+            boost::multi_index::member<RebroadcastEntry, const uint256, &RebroadcastEntry::m_wtxid>,\n+            SaltedTxidHasher\n+        >,\n+        // sorted by last rebroadcast time\n+        boost::multi_index::ordered_non_unique<\n+            boost::multi_index::tag<index_by_last_attempt>,\n+            boost::multi_index::member<RebroadcastEntry, std::chrono::microseconds, &RebroadcastEntry::m_last_attempt>\n+        >\n+    >\n+>{};\n+\n+TxRebroadcastHandler::~TxRebroadcastHandler() = default;\n+\n+TxRebroadcastHandler::TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams)\n+    : m_mempool{mempool},\n+      m_chainman{chainman},\n+      m_chainparams(chainparams),\n+      m_attempt_tracker{std::make_unique<indexed_rebroadcast_set>()}{}\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    auto start_time = GetTime<std::chrono::microseconds>();\n+\n+    // If the cache has run since we received the last block, the fee rate\n+    // condition will not filter out any transactions, so skip this run.\n+    if (m_tip_at_cache_time == m_chainman.ActiveTip()) return rebroadcast_txs;\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = MAX_REBROADCAST_WEIGHT;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.m_check_block_validity = false;\n+    options.blockMinFeeRate = m_cached_fee_rate;\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_chainman.ActiveChainstate(), m_mempool, m_chainparams, options)\n+                              .CreateNewBlock(CScript());\n+    auto after_cnb_time = GetTime<std::chrono::microseconds>();\n+\n+    for (const CTransactionRef& tx : block_template->block.vtx) {\n+        if (tx->IsCoinBase()) continue;\n+\n+        uint256 txid = tx->GetHash();\n+        uint256 wtxid = tx->GetWitnessHash();\n+\n+        // Check if we have previously rebroadcasted, decide if we will this\n+        // round, and if so, record the attempt.\n+        auto entry_it = m_attempt_tracker->find(wtxid);\n+\n+        if (entry_it == m_attempt_tracker->end()) {\n+            // No existing entry, we will rebroadcast, so create a new one\n+            RebroadcastEntry entry(start_time, wtxid);\n+            m_attempt_tracker->insert(entry);\n+        } else if (entry_it->m_count >= MAX_REBROADCAST_COUNT) {\n+            // We have already rebroadcast this transaction the maximum number\n+            // of times permitted, so skip rebroadcasting.\n+            continue;\n+        } else if (entry_it->m_last_attempt > start_time - MIN_REATTEMPT_INTERVAL) {\n+            // We already rebroadcasted this in the past 4 hours. Even if we\n+            // added it to the set, it would probably not get INVed to most\n+            // peers due to filterInventoryKnown.\n+            continue;\n+        } else {\n+            // We have rebroadcasted this transaction before, but will try\n+            // again now. Record the attempt.\n+            auto UpdateRebroadcastEntry = [start_time](RebroadcastEntry& rebroadcast_entry) {\n+                rebroadcast_entry.m_last_attempt = start_time;\n+                ++rebroadcast_entry.m_count;\n+            };\n+\n+            m_attempt_tracker->modify(entry_it, UpdateRebroadcastEntry);\n+        }\n+\n+        // Add to set of rebroadcast candidates\n+        rebroadcast_txs.push_back(TxIds(txid, wtxid));\n+    }\n+\n+    TrimMaxRebroadcast();\n+\n+    auto delta1 = after_cnb_time - start_time;\n+    auto delta2 = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"GetRebroadcastTransactions(): %d us total, %d us spent in CreateNewBlock.\\n\", delta2.count(), delta1.count());\n+    LogPrint(BCLog::NET, \"Queued %d transactions for attempted rebroadcast, filtered from %d candidates with cached fee rate of %s.\\n\", rebroadcast_txs.size(), block_template->block.vtx.size() - 1, m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB));\n+\n+    for (TxIds ids : rebroadcast_txs) {\n+        LogPrint(BCLog::NET, \"Attempting to rebroadcast txid: %s, wtxid: %s\\n\", ids.m_txid.ToString(), ids.m_wtxid.ToString());\n+    }\n+\n+    return rebroadcast_txs;\n+};\n+\n+void TxRebroadcastHandler::CacheMinRebroadcastFee()\n+{\n+    if (m_chainman.ActiveChainstate().IsInitialBlockDownload()) return;\n+\n+    // Update stamp of chain tip on cache run\n+    m_tip_at_cache_time = m_chainman.ActiveTip();\n+\n+    // Update cache fee rate\n+    auto start_time = GetTime<std::chrono::microseconds>();\n+    m_cached_fee_rate = BlockAssembler(m_chainman.ActiveChainstate(), m_mempool, m_chainparams).MinTxFeeRate();\n+    auto delta_time = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"Caching minimum fee for rebroadcast to %s, took %d us to calculate.\\n\", m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB), delta_time.count());\n+};\n+\n+void TxRebroadcastHandler::RemoveFromAttemptTracker(const CTransactionRef& tx) {\n+    const auto it = m_attempt_tracker->find(tx->GetWitnessHash());\n+    if (it == m_attempt_tracker->end()) return;\n+    m_attempt_tracker->erase(it);\n+}\n+\n+void TxRebroadcastHandler::TrimMaxRebroadcast()\n+{\n+    // Delete any entries that are older than MAX_ENTRY_AGE\n+    auto min_age = GetTime<std::chrono::microseconds>() - MAX_ENTRY_AGE;\n+\n+    while (!m_attempt_tracker->empty()) {\n+        auto it = m_attempt_tracker->get<index_by_last_attempt>().begin();\n+        if (it->m_last_attempt < min_age) {\n+            m_attempt_tracker->get<index_by_last_attempt>().erase(it);\n+        } else {\n+            break;\n+        }\n+    }\n+\n+    // If there are still too many entries, delete the oldest ones",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r621673594",
      "id" : 621673594,
      "in_reply_to_id" : 615159376,
      "line" : 205,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMTY3MzU5NA==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 205,
      "original_position" : 184,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 205,
      "pull_request_review_id" : 646441726,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/621673594",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r621685372"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/621685372"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm unable to parse your question. Although I think it helps motivate the attack, I'll drop the end of the sentence.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-27T23:20:21Z",
      "diff_hunk" : "@@ -0,0 +1,85 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXREBROADCAST_H\n+#define BITCOIN_TXREBROADCAST_H\n+\n+#include <policy/feerate.h>\n+#include <txmempool.h>\n+#include <validation.h>\n+\n+struct TxIds {\n+    TxIds(uint256 txid, uint256 wtxid) : m_txid(txid), m_wtxid(wtxid) {}\n+\n+    const uint256 m_txid;\n+    const uint256 m_wtxid;\n+};\n+\n+class indexed_rebroadcast_set;\n+\n+class TxRebroadcastHandler\n+{\n+public:\n+    TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams);\n+    ~TxRebroadcastHandler();\n+\n+    TxRebroadcastHandler(const TxRebroadcastHandler& other) = delete;\n+    TxRebroadcastHandler& operator=(const TxRebroadcastHandler& other) = delete;\n+\n+    std::vector<TxIds> GetRebroadcastTransactions();\n+\n+    /** Assemble a block from the highest fee rate packages in the local\n+     *  mempool. Update the cache with the minimum fee rate for a package to be\n+     *  included.\n+     * */\n+    void CacheMinRebroadcastFee();\n+\n+    /** Remove transaction entry from the attempt tracker.*/\n+    void RemoveFromAttemptTracker(const CTransactionRef& tx);\n+\n+    /** Test only */\n+    void UpdateAttempt(const uint256& wtxid, const int count, const std::chrono::microseconds last_attempt_time);\n+\n+    /** Test only */\n+    bool CheckRecordedAttempt(const uint256& wtxid, const int expected_count, const std::chrono::microseconds expected_timestamp) const;\n+\n+    /** Test only */\n+    void UpdateCachedFeeRate(const CFeeRate& new_fee_rate);\n+\n+private:\n+    const CTxMemPool& m_mempool;\n+    const ChainstateManager& m_chainman;\n+    const CChainParams& m_chainparams;\n+\n+    /** Block at time of cache */\n+    CBlockIndex* m_tip_at_cache_time{nullptr};\n+\n+    /** Minimum fee rate for package to be included in block */\n+    CFeeRate m_cached_fee_rate;\n+\n+    /** Keep track of previous rebroadcast attempts.\n+     *\n+     *  There are circumstances where our mempool might know about transactions\n+     *  that will never be mined. Two examples:\n+     *  1. A software upgrade tightens policy, but the node has not been\n+     *  upgraded and thus is accepting transactions that other nodes on the\n+     *  network now reject.\n+     *  2. An attacker targets the network by sending conflicting transactions\n+     *  to nodes based on their distance from a miner.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r621685372",
      "id" : 621685372,
      "in_reply_to_id" : 615161228,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMTY4NTM3Mg==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 69,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.h",
      "position" : null,
      "pull_request_review_id" : 646456271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/621685372",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r621687434"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/621687434"
         }
      },
      "author_association" : "MEMBER",
      "body" : "this comment seems to have a lot of overlap with the one you left here: https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615146994. I don't understand exactly what you mean by \"cheap-RBF replacement\". I'm going to resolve this conversation, but we can continue the topic in that other thread. ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-27T23:25:43Z",
      "diff_hunk" : "@@ -0,0 +1,219 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r621687434",
      "id" : 621687434,
      "in_reply_to_id" : 615164135,
      "line" : 31,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMTY4NzQzNA==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 31,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 31,
      "pull_request_review_id" : 646464168,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/621687434",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r621709334"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/621709334"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> maybe replace 1 by a named constant like `CACHE_REBROADCAST_FEERATE_FREQUENCY`\r\n\r\ndone",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-28T00:03:20Z",
      "diff_hunk" : "@@ -1283,22 +1286,57 @@ PeerManagerImpl::PeerManagerImpl(const CChainParams& chainparams, CConnman& conn\n     // same probability that we have in the reject filter).\n     m_recent_confirmed_transactions.reset(new CRollingBloomFilter(48000, 0.000001));\n \n+    if (enable_rebroadcast) {\n+        m_txrebroadcast = std::make_unique<TxRebroadcastHandler>(m_mempool, m_chainman, m_chainparams);\n+\n+        // Run fee rate cache every minute\n+        scheduler.scheduleEvery([this] { m_txrebroadcast->CacheMinRebroadcastFee(); }, std::chrono::minutes{1});",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r621709334",
      "id" : 621709334,
      "in_reply_to_id" : 615158323,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMTcwOTMzNA==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 1293,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 646488920,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/621709334",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r621709628"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/621709628"
         }
      },
      "author_association" : "MEMBER",
      "body" : "updated to `2. An attacker targets the network by sending conflicting transactions to nodes.`\r\n",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-04-28T00:04:02Z",
      "diff_hunk" : "@@ -0,0 +1,85 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXREBROADCAST_H\n+#define BITCOIN_TXREBROADCAST_H\n+\n+#include <policy/feerate.h>\n+#include <txmempool.h>\n+#include <validation.h>\n+\n+struct TxIds {\n+    TxIds(uint256 txid, uint256 wtxid) : m_txid(txid), m_wtxid(wtxid) {}\n+\n+    const uint256 m_txid;\n+    const uint256 m_wtxid;\n+};\n+\n+class indexed_rebroadcast_set;\n+\n+class TxRebroadcastHandler\n+{\n+public:\n+    TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams);\n+    ~TxRebroadcastHandler();\n+\n+    TxRebroadcastHandler(const TxRebroadcastHandler& other) = delete;\n+    TxRebroadcastHandler& operator=(const TxRebroadcastHandler& other) = delete;\n+\n+    std::vector<TxIds> GetRebroadcastTransactions();\n+\n+    /** Assemble a block from the highest fee rate packages in the local\n+     *  mempool. Update the cache with the minimum fee rate for a package to be\n+     *  included.\n+     * */\n+    void CacheMinRebroadcastFee();\n+\n+    /** Remove transaction entry from the attempt tracker.*/\n+    void RemoveFromAttemptTracker(const CTransactionRef& tx);\n+\n+    /** Test only */\n+    void UpdateAttempt(const uint256& wtxid, const int count, const std::chrono::microseconds last_attempt_time);\n+\n+    /** Test only */\n+    bool CheckRecordedAttempt(const uint256& wtxid, const int expected_count, const std::chrono::microseconds expected_timestamp) const;\n+\n+    /** Test only */\n+    void UpdateCachedFeeRate(const CFeeRate& new_fee_rate);\n+\n+private:\n+    const CTxMemPool& m_mempool;\n+    const ChainstateManager& m_chainman;\n+    const CChainParams& m_chainparams;\n+\n+    /** Block at time of cache */\n+    CBlockIndex* m_tip_at_cache_time{nullptr};\n+\n+    /** Minimum fee rate for package to be included in block */\n+    CFeeRate m_cached_fee_rate;\n+\n+    /** Keep track of previous rebroadcast attempts.\n+     *\n+     *  There are circumstances where our mempool might know about transactions\n+     *  that will never be mined. Two examples:\n+     *  1. A software upgrade tightens policy, but the node has not been\n+     *  upgraded and thus is accepting transactions that other nodes on the\n+     *  network now reject.\n+     *  2. An attacker targets the network by sending conflicting transactions\n+     *  to nodes based on their distance from a miner.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r621709628",
      "id" : 621709628,
      "in_reply_to_id" : 615161228,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMTcwOTYyOA==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 69,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.h",
      "position" : null,
      "pull_request_review_id" : 646489224,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T05:52:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/621709628",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> But it seems this could be exploited by an attacker at almost zero cost, spamming these nodes with such txs that are high fee but invalid under the new rules.\r\n\r\nIf the txs are invalid under the new rules no node will accept them -- new nodes won't because they'll be invalid, old nodes won't because anything covered by the new rules is non-standard so not acceptable to the mempool/for relay.\r\n\r\nThe spam case is for txs that are only valid under the new rules, but miners aren't bothering to mine any txs that use the new rules -- in that case all the nodes running the new rules will rebroadcast them to everyone regularly -- but that's limited by expiry (each tx can only be rebroadcast so many times), inventory known (won't inv the same thing until it expires from the bloom filter), and (hopefully) by some miner creating blocks with txs that follow the new rules.",
      "created_at" : "2021-04-29T11:45:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-829160497",
      "id" : 829160497,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyOTE2MDQ5Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-29T11:45:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/829160497",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r626866576"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/626866576"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-05T20:13:05Z",
      "diff_hunk" : "@@ -0,0 +1,141 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <validation.h>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT = 3 * MAX_BLOCK_WEIGHT / 4;\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE = 30min;\n+\n+/** Maximum number of times we will rebroadcast a tranasaction */\n+static constexpr int MAX_REBROADCAST_COUNT = 6;\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL = 4h;\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES = 500;\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE = std::chrono::hours(3 * 30 * 24);\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    std::chrono::microseconds start_time = GetTime<std::chrono::microseconds>();\n+\n+    // If there has not been a cache run since the last block, the fee rate\n+    // condition will not filter out any transactions, so skip this run.\n+    if (m_tip_at_cache_time == ::ChainActive().Tip()) return rebroadcast_txs;\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = MAX_REBROADCAST_WEIGHT;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.check_block_validity = false;\n+    options.blockMinFeeRate = m_cached_fee_rate;\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_mempool, Params(), options)\n+                          .CreateNewBlock(m_chainman.ActiveChainstate(), CScript());\n+    std::chrono::microseconds after_CNB_time = GetTime<std::chrono::microseconds>();\n+\n+    for (const CTransactionRef& tx : block_template->block.vtx) {\n+        if (tx->IsCoinBase()) continue;\n+\n+        uint256 txid = tx->GetHash();\n+        uint256 wtxid = tx->GetWitnessHash();\n+\n+        // Check if we have previously rebroadcasted, decide if we will this\n+        // round, and if so, record the attempt.\n+        auto entry_it = m_attempt_tracker.find(wtxid);\n+\n+        if (entry_it == m_attempt_tracker.end()) {\n+            // No existing entry, we will rebroadcast, so create a new one\n+            RebroadcastEntry entry(start_time, wtxid);\n+            m_attempt_tracker.insert(entry);\n+        } else if (entry_it->m_count >= MAX_REBROADCAST_COUNT) {\n+            // We have already rebroadcast this transaction the maximum number\n+            // of times permitted, so skip rebroadcasting.\n+            continue;\n+        } else if (entry_it->m_last_attempt > start_time - MIN_REATTEMPT_INTERVAL) {\n+            // We already rebroadcasted this in the past 4 hours. Even if we\n+            // added it to the set, it would probably not get INVed to most\n+            // peers due to filterInventoryKnown.\n+            continue;\n+        } else {\n+            // We have rebroadcasted this transaction before, but will try\n+            // again now.\n+            RecordAttempt(entry_it);\n+        }\n+\n+        // Add to set of rebroadcast candidates\n+        rebroadcast_txs.push_back(TxIds(txid, wtxid));\n+    }\n+\n+    TrimMaxRebroadcast();\n+\n+    std::chrono::microseconds delta1 = after_CNB_time - start_time;\n+    std::chrono::microseconds delta2 = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"GetRebroadcastTransactions(): %d Âµs total, %d Âµs spent in CreateNewBlock.\\n\", delta1.count(), delta2.count());\n+    LogPrint(BCLog::NET, \"Queued %d transactions for attempted rebroadcast, filtered from %d candidates with cached fee rate of %s.\\n\", rebroadcast_txs.size(), block_template->block.vtx.size() - 1, m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB));\n+\n+    for (TxIds ids : rebroadcast_txs) {\n+        LogPrint(BCLog::NET, \"Attempting to rebroadcast txid: %s, wtxid: %s\\n\", ids.m_txid.ToString(), ids.m_wtxid.ToString());\n+    }\n+\n+    return rebroadcast_txs;\n+};\n+\n+void TxRebroadcastHandler::CacheMinRebroadcastFee()\n+{\n+    // Update stamp of chain tip on cache run\n+    m_tip_at_cache_time = ::ChainActive().Tip();\n+\n+    // Update cache fee rate\n+    std::chrono::microseconds start_time = GetTime<std::chrono::microseconds>();\n+    m_cached_fee_rate = BlockAssembler(m_mempool, Params()).minTxFeeRate();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r626866576",
      "id" : 626866576,
      "in_reply_to_id" : 596515495,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNjg2NjU3Ng==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 107,
      "original_position" : 107,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 652706191,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-05T20:13:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/626866576",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I believe all review comments are now addressed (including the explanations below) ð\r\n\r\nSome updates about the latest push: \r\n- The rebroadcast logic now mines a block with a weight of 3/4 weight-of-incoming-block instead of 3/4 weight-of-maximum-block, to reduce bandwidth spikes \r\n- Rebased on master to resolve a silent merge conflict \r\n- We now store the last two values for the fee-rate cache, so we can use the previous if there has been a run since the block came in\r\n\r\nOne more note- looks like the latest push has caused a lock-order failure in the TSan build. I will address this soon! \r\n\r\nAlso, I've been monitoring the code using [this branch](https://github.com/amitiuttarwar/bitcoin/commits/2021-04-rebroadcast-monitoring2). In addition to a bunch of rebroadcast specific logging, the top commit adds two RPC endpoints: `getrebroadcastinfo` and `getgeneralbroadcastinfo` which reports counts of # of times we do events such as sending INVs and receiving GETDATAs. \r\n\r\nHere are a couple observations: \r\n- The patch has been running on my node with a huge mempool. I have `feefilter`: 0, `maxmempool`: 1000, `mempoolexpiry`:17520 (approx 2 years), and `minrelaytxfee`: 0, along with inbound connections enabled.\r\n- After running for a couple days, the rebroadcast INV:GETDATA ratio was 11-12:1, while the general ratio was 35-40:1. As the node ran for longer, both of these ratios have been reducing. After running for ~8 days, the rebroadcast ratio has been hovering around 9:1, and the general broadcast ratio has dropped to ~12:1. \r\n- The number of transactions identified for rebroadcast is very spiky, its often 0, or will hop up to 100-150 on a particular block. The latest push has changed the maximum weight to reflect the incoming block, so I'm curious to see \r\n\r\nIf anyone is interested in reviewing or running the monitoring code, that would be awesome! I'd love to gather more data :) \r\n\r\n--- \r\n\r\n@fjahr \r\n\r\n> But it seems this could be exploited by an attacker at almost zero cost, spamming these nodes with such txs that are high fee but invalid under the new rules. \r\n\r\nHm, so indeed an attacker could essentially nullify the utility of a mempool by spamming old nodes with now-policy-invalid transactions, but this is already the case. \r\n\r\nIn relation to this PR, we want to make sure we don't worsen, or automate that behavior. So `m_attempt_tracker` ensures that there are bounds on the number of times & frequency that we will rebroadcast any particular transaction. Combined with the `filterInventoryKnown` functionality, we can have some guarantees around bandwidth usage, especially asymmetric bandwidth usage, that nodes will have under normal or malicious worst case scenarios. However, I am not aiming to fix the existing issue around policy upgrades and attack vectors. \r\n\r\nDoes this help / make sense? \r\n\r\n\r\n@ariard \r\n\r\n> A lot of second-layers nodes and more and more Bitcoin applications have their own RBF-able rebroadcast logics, with their own frequencies and attempt limits. This new mechanism doesn't serve them well as their rebroadcast logics are going to leak a behavior breaking from the anonymous sets constituted by m_attempt_tracker. \r\n\r\nI don't understand what you are trying to say here. I don't find it unexpected or undesirable for various applications, users, companies to run custom rebroadcast logic. I also don't understand why you say that `m_attempt_tracker` is creating an anonymity set- it mostly serves as a way to mitigate frequently rebroadcasting any particular transaction, not the technique we use to identify rebroadcasts. \r\n\r\n\r\n> Another concern, I think this PR is making the assumption that big-sized node mempools will serve as some sort of transaction archives for the rest of the network by rebroadcasting a-week-ago-or-month-ago bottom of mempools now feerate compelling for block inclusion ?\r\n\r\nYes I think that's a fair way of looking at the long picture vision. \r\n\r\n> Further, I would attend a more detailed privacy attacker model, we might have other privacy-preserving rebroadcast strategies with cheaper bandwidth trade-offs...\r\n\r\nI agree that there are many possibilities & that it would be beneficial to have a more specific breakdown of privacy assumptions & guarantees. However, I don't think that we should gate concrete improvements on theoretically infinite problem spaces. I believe that the changes proposed in this PR & the intended direction of this project offer concrete, auditable improvements to privacy around 3rd parties deducing the source wallet of a transaction. \r\n\r\n\r\n@DISC30 thanks for the offer, I don't think this PR is the right place to discuss, so I emailed you (based on the email in your github). ",
      "created_at" : "2021-05-05T20:35:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-832989504",
      "id" : 832989504,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzMjk4OTUwNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-05T20:37:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/832989504",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r627470377"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627470377"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, my question was simply \"Why a node distance from a miner helps to motivate the attack ?\"",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-06T14:26:28Z",
      "diff_hunk" : "@@ -0,0 +1,85 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXREBROADCAST_H\n+#define BITCOIN_TXREBROADCAST_H\n+\n+#include <policy/feerate.h>\n+#include <txmempool.h>\n+#include <validation.h>\n+\n+struct TxIds {\n+    TxIds(uint256 txid, uint256 wtxid) : m_txid(txid), m_wtxid(wtxid) {}\n+\n+    const uint256 m_txid;\n+    const uint256 m_wtxid;\n+};\n+\n+class indexed_rebroadcast_set;\n+\n+class TxRebroadcastHandler\n+{\n+public:\n+    TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams);\n+    ~TxRebroadcastHandler();\n+\n+    TxRebroadcastHandler(const TxRebroadcastHandler& other) = delete;\n+    TxRebroadcastHandler& operator=(const TxRebroadcastHandler& other) = delete;\n+\n+    std::vector<TxIds> GetRebroadcastTransactions();\n+\n+    /** Assemble a block from the highest fee rate packages in the local\n+     *  mempool. Update the cache with the minimum fee rate for a package to be\n+     *  included.\n+     * */\n+    void CacheMinRebroadcastFee();\n+\n+    /** Remove transaction entry from the attempt tracker.*/\n+    void RemoveFromAttemptTracker(const CTransactionRef& tx);\n+\n+    /** Test only */\n+    void UpdateAttempt(const uint256& wtxid, const int count, const std::chrono::microseconds last_attempt_time);\n+\n+    /** Test only */\n+    bool CheckRecordedAttempt(const uint256& wtxid, const int expected_count, const std::chrono::microseconds expected_timestamp) const;\n+\n+    /** Test only */\n+    void UpdateCachedFeeRate(const CFeeRate& new_fee_rate);\n+\n+private:\n+    const CTxMemPool& m_mempool;\n+    const ChainstateManager& m_chainman;\n+    const CChainParams& m_chainparams;\n+\n+    /** Block at time of cache */\n+    CBlockIndex* m_tip_at_cache_time{nullptr};\n+\n+    /** Minimum fee rate for package to be included in block */\n+    CFeeRate m_cached_fee_rate;\n+\n+    /** Keep track of previous rebroadcast attempts.\n+     *\n+     *  There are circumstances where our mempool might know about transactions\n+     *  that will never be mined. Two examples:\n+     *  1. A software upgrade tightens policy, but the node has not been\n+     *  upgraded and thus is accepting transactions that other nodes on the\n+     *  network now reject.\n+     *  2. An attacker targets the network by sending conflicting transactions\n+     *  to nodes based on their distance from a miner.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r627470377",
      "id" : 627470377,
      "in_reply_to_id" : 615161228,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNzQ3MDM3Nw==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 69,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.h",
      "position" : null,
      "pull_request_review_id" : 653488835,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-06T14:26:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627470377",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r627575612"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627575612"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks for the second clarifying update, effectively this is documented L124 in `src/txrebroadcast.cpp`, \"No existing entry, we will rebroadcast, so create new one\". \r\n\r\nSo IIUC, even if `m_attempt_tracker` is fulfilled with pinning transactions, it won't block node rebroadcast capability. I think pinning costs of `m_attempt_tracker` above roughly above but it can't be abused by an attacker to jam rebroadcasting, so we're good.\r\n\r\nI would recommend to document this \"pinning-doesn't-block-rebroadcast-so-not-a-new-tx-relay jamming-vector\" around `m_attempt_tracker` declaration in `src/txreconciliation.h`, it's quite an important design aspect imo.\r\n\r\nW.r.t to asymmetric bandwidth usage and risks of bleeding, I don't think `m_attempt_tracker` pinning is making it better or worst, I share the opinion we're ultimately protected by `filterInventoryKnown`.\r\n\r\n>  I don't understand how the attacker avoids spending any funds- say A and A' are two versions of the same txn via RBF. A is sent to the victim & A' is sent to the rest of the network. according to the current patch, if A' gets mined into a block, A is removed from the attempt tracker.\r\n\r\nI should have precise this point. Transaction A feerate to successfully pin `m_attempt_tracker` must be at 170 sat/vbyte. However transaction A' feerate just need to be above miners'mempools min feerates to block propagation of transaction A. If transaction A' feerate is 2 sat/vbyte, with same equation laid out above, effective pinning cost for an attacker is 12_000 * 82 * 2 = 1_968_000 sats and not 167_280_000 sats. Miners observe and eventually mine transactions with a far lower-feerate than the ones maliciously sent to non-miner nodes. This is what I meant by \"not burnt if the mempool isolation is operated properly\".",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-06T16:20:16Z",
      "diff_hunk" : "@@ -0,0 +1,219 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r627575612",
      "id" : 627575612,
      "in_reply_to_id" : 615146994,
      "line" : 34,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNzU3NTYxMg==",
      "original_commit_id" : "d1bcb1d213ae380bbfce516a04c11a68864d3bbd",
      "original_line" : 34,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 34,
      "pull_request_review_id" : 653648606,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-06T17:13:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627575612",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r627615103"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627615103"
         }
      },
      "author_association" : "MEMBER",
      "body" : "IIRC, by \"legitimately expired\" I meant a transaction of which `m_count` has reached `MAX_REBROADCAST_COUNT`. As we already rebroadcasted this transaction the maximum number of times permitted, we skip its rebroadcasting forever, but without necessarily removing it from `m_attempt_tracker` ? I think such transaction has exhausted its rebroadcast \"credit\" and it's mature enough to be \"legitimately\" expired or pruned. Though this deletion criteria isn't currently considered in `TrimMaxRebroadcast()` ? \r\n\r\nI think this deletion criteria would be more efficient to expire transactions from the majority of network mempools rather than MAX_ENTRY_AGE, especially with a 3 months delay.\r\n\r\n> if we stored transactions on the attempt tracker for the same duration as MEMPOOL_EXPIRY time, that would leave room for the issue that the attempt tracker is meant to address. for more explanation on that, please see https://github.com/amitiuttarwar/bitcoin-notes/blob/main/rebroadcast-history.md#faq section \"What happens if a transaction can / will never be mined?\". expiry would be one of the main ways to get the ping-ponging behavior for never-going-to-be-mined transactions (eg. due to a policy upgrade on the network)\r\n\r\nIIUC, the problem we're trying to solve is \"How to avoid never-going-to-be-mined transactions to forever ping-pong across the network ?\". \r\n\r\nTo achieve this aim, I believe we should expire a rebroadcast entry as soon as it has exhausted its rebroadcast count, a hint that either feerate is definitively aloof or severer circumstances as described in documentation. But selecting a MAX_ENTRY_AGE superior to MEMPOOL_EXPIRY moves in the opposite direction. \r\n\r\nIf rebroadcast entry _average_ rebroadcast interval  is superior to 56 hours, 56 * MAX_REBROADCAST_COUNT== MEMPOOL_EXPIRY and node rebroadcast guarantees attempts beyond the mempool expiration limit ?\r\n\r\nOr is the behavior I'm describing not possible ? I'm happy to illustrate with a test to assert our intuitions :)\r\n\r\nupdate: Or is the purpose of keeping rebroadcast entry with `m_count` == `MAX_REBROADCAST_COUNT` and only expire them when `last_attempt` is older than MAX_ENTRY_AGE prevent new registration in `m_attempt_tracker` cache provoked by rebroadcast from other network mempools ? Thus you expect a transaction to expire from mempools after MEMPOOL_EXPIRY, then to avoid network laggards with differing policy to trigger new rebroadcasting wawes, you have MAX_ENTRY_AGE as an upper bound of MEMPOOL_EXPIRY ? \r\n\r\nOkay I can see how it solves mempool ping-pong though reasoning could be better documented and still we should envisage to reduce MAX_ENTRY_AGE to minimize node fingerprinting.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-06T17:08:55Z",
      "diff_hunk" : "@@ -0,0 +1,219 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE{24h * 30 * 3};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r627615103",
      "id" : 627615103,
      "in_reply_to_id" : 615156761,
      "line" : 37,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNzYxNTEwMw==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 37,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 37,
      "pull_request_review_id" : 653697420,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-06T17:32:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627615103",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r627623142"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627623142"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Do we agree first on the problem solved by `m_attempt_tracker` ? See new comment : https://github.com/bitcoin/bitcoin/pull/21061#discussion_r627615103\r\n\r\nWhat we want to do in `TrimMaxRebroadcast()` is pending on this conversation imo.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-06T17:21:38Z",
      "diff_hunk" : "@@ -0,0 +1,219 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE{24h * 30 * 3};\n+\n+struct RebroadcastEntry {\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\n+        : m_last_attempt(now_time),\n+          m_wtxid(wtxid) {}\n+\n+    std::chrono::microseconds m_last_attempt;\n+    const uint256 m_wtxid;\n+    int m_count{1};\n+};\n+\n+/** Used for multi_index tag  */\n+struct index_by_last_attempt {};\n+\n+class indexed_rebroadcast_set : public\n+boost::multi_index_container<\n+    RebroadcastEntry,\n+    boost::multi_index::indexed_by<\n+        // sorted by wtxid\n+        boost::multi_index::hashed_unique<\n+            boost::multi_index::tag<index_by_wtxid>,\n+            boost::multi_index::member<RebroadcastEntry, const uint256, &RebroadcastEntry::m_wtxid>,\n+            SaltedTxidHasher\n+        >,\n+        // sorted by last rebroadcast time\n+        boost::multi_index::ordered_non_unique<\n+            boost::multi_index::tag<index_by_last_attempt>,\n+            boost::multi_index::member<RebroadcastEntry, std::chrono::microseconds, &RebroadcastEntry::m_last_attempt>\n+        >\n+    >\n+>{};\n+\n+TxRebroadcastHandler::~TxRebroadcastHandler() = default;\n+\n+TxRebroadcastHandler::TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams)\n+    : m_mempool{mempool},\n+      m_chainman{chainman},\n+      m_chainparams(chainparams),\n+      m_attempt_tracker{std::make_unique<indexed_rebroadcast_set>()}{}\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    auto start_time = GetTime<std::chrono::microseconds>();\n+\n+    // If the cache has run since we received the last block, the fee rate\n+    // condition will not filter out any transactions, so skip this run.\n+    if (m_tip_at_cache_time == m_chainman.ActiveTip()) return rebroadcast_txs;\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = MAX_REBROADCAST_WEIGHT;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.m_check_block_validity = false;\n+    options.blockMinFeeRate = m_cached_fee_rate;\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_chainman.ActiveChainstate(), m_mempool, m_chainparams, options)\n+                              .CreateNewBlock(CScript());\n+    auto after_cnb_time = GetTime<std::chrono::microseconds>();\n+\n+    for (const CTransactionRef& tx : block_template->block.vtx) {\n+        if (tx->IsCoinBase()) continue;\n+\n+        uint256 txid = tx->GetHash();\n+        uint256 wtxid = tx->GetWitnessHash();\n+\n+        // Check if we have previously rebroadcasted, decide if we will this\n+        // round, and if so, record the attempt.\n+        auto entry_it = m_attempt_tracker->find(wtxid);\n+\n+        if (entry_it == m_attempt_tracker->end()) {\n+            // No existing entry, we will rebroadcast, so create a new one\n+            RebroadcastEntry entry(start_time, wtxid);\n+            m_attempt_tracker->insert(entry);\n+        } else if (entry_it->m_count >= MAX_REBROADCAST_COUNT) {\n+            // We have already rebroadcast this transaction the maximum number\n+            // of times permitted, so skip rebroadcasting.\n+            continue;\n+        } else if (entry_it->m_last_attempt > start_time - MIN_REATTEMPT_INTERVAL) {\n+            // We already rebroadcasted this in the past 4 hours. Even if we\n+            // added it to the set, it would probably not get INVed to most\n+            // peers due to filterInventoryKnown.\n+            continue;\n+        } else {\n+            // We have rebroadcasted this transaction before, but will try\n+            // again now. Record the attempt.\n+            auto UpdateRebroadcastEntry = [start_time](RebroadcastEntry& rebroadcast_entry) {\n+                rebroadcast_entry.m_last_attempt = start_time;\n+                ++rebroadcast_entry.m_count;\n+            };\n+\n+            m_attempt_tracker->modify(entry_it, UpdateRebroadcastEntry);\n+        }\n+\n+        // Add to set of rebroadcast candidates\n+        rebroadcast_txs.push_back(TxIds(txid, wtxid));\n+    }\n+\n+    TrimMaxRebroadcast();\n+\n+    auto delta1 = after_cnb_time - start_time;\n+    auto delta2 = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"GetRebroadcastTransactions(): %d us total, %d us spent in CreateNewBlock.\\n\", delta2.count(), delta1.count());\n+    LogPrint(BCLog::NET, \"Queued %d transactions for attempted rebroadcast, filtered from %d candidates with cached fee rate of %s.\\n\", rebroadcast_txs.size(), block_template->block.vtx.size() - 1, m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB));\n+\n+    for (TxIds ids : rebroadcast_txs) {\n+        LogPrint(BCLog::NET, \"Attempting to rebroadcast txid: %s, wtxid: %s\\n\", ids.m_txid.ToString(), ids.m_wtxid.ToString());\n+    }\n+\n+    return rebroadcast_txs;\n+};\n+\n+void TxRebroadcastHandler::CacheMinRebroadcastFee()\n+{\n+    if (m_chainman.ActiveChainstate().IsInitialBlockDownload()) return;\n+\n+    // Update stamp of chain tip on cache run\n+    m_tip_at_cache_time = m_chainman.ActiveTip();\n+\n+    // Update cache fee rate\n+    auto start_time = GetTime<std::chrono::microseconds>();\n+    m_cached_fee_rate = BlockAssembler(m_chainman.ActiveChainstate(), m_mempool, m_chainparams).MinTxFeeRate();\n+    auto delta_time = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"Caching minimum fee for rebroadcast to %s, took %d us to calculate.\\n\", m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB), delta_time.count());\n+};\n+\n+void TxRebroadcastHandler::RemoveFromAttemptTracker(const CTransactionRef& tx) {\n+    const auto it = m_attempt_tracker->find(tx->GetWitnessHash());\n+    if (it == m_attempt_tracker->end()) return;\n+    m_attempt_tracker->erase(it);\n+}\n+\n+void TxRebroadcastHandler::TrimMaxRebroadcast()\n+{\n+    // Delete any entries that are older than MAX_ENTRY_AGE\n+    auto min_age = GetTime<std::chrono::microseconds>() - MAX_ENTRY_AGE;\n+\n+    while (!m_attempt_tracker->empty()) {\n+        auto it = m_attempt_tracker->get<index_by_last_attempt>().begin();\n+        if (it->m_last_attempt < min_age) {\n+            m_attempt_tracker->get<index_by_last_attempt>().erase(it);\n+        } else {\n+            break;\n+        }\n+    }\n+\n+    // If there are still too many entries, delete the oldest ones",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r627623142",
      "id" : 627623142,
      "in_reply_to_id" : 615159376,
      "line" : 205,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNzYyMzE0Mg==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 205,
      "original_position" : 184,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 205,
      "pull_request_review_id" : 653708582,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-06T17:21:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627623142",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r627635595"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627635595"
         }
      },
      "author_association" : "MEMBER",
      "body" : "See second half of other comment answer on why you can consider RBF cheap for an attacker. More generally there is also the fact that the bip125 replacement penalty is static (DEFAULT_INCREMENTAL_RELAY_FEE) is _static_ and doesn't scale up in function of your mempool congestion.\r\n\r\nSimplify fee-bumping algorithms a lot though at the price of bandwidth overcost for network nodes processing replacement...\r\n\r\nW.r.t to `filterInventoryKnown`, a malicious roll over isn't new from introducing node rebroadcast logic, though from now this module make assumptions on it to prevent bandwidth bleeding.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-06T17:38:49Z",
      "diff_hunk" : "@@ -0,0 +1,219 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r627635595",
      "id" : 627635595,
      "in_reply_to_id" : 615164135,
      "line" : 31,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyNzYzNTU5NQ==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 31,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 31,
      "pull_request_review_id" : 653724809,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-06T17:38:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/627635595",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@amitiuttarwar \r\n\r\n> I don't understand what you are trying to say here. I don't find it unexpected or undesirable for various applications, users, companies to run custom rebroadcast logic. \r\n\r\nI think the problem this work is alleguing to solve is \"How to improve Bitcoin Core Wallet rebroadcast privacy\". The solution proposed is to rebroadcast _any_ transaction identified as missing from a block based on feerate expectations. This new behavior is justifying to improve privacy for the following reason \"If a spy observes a bitcoin core node rebroadcasting a transaction, it would not longer know that the node has wallet enabled\" among others. I believe we agree this assumption is function of *node* rebroadcasting module being activated by default.\r\n\r\nHowever, and that's my point, a lot of full-nodes are hosting Bitcoin applications with custom rebroadcast logic, and this trend is likely to increase in the future. So those full-nodes operators, with custom rebroadcast logics and not using the bitcoin core wallet, won't be incentivized to activate by default *node* rebroadcasting as it doesn't enhance privacy of their transactions. For this reason, improvement of Bitcoin Core wallet rebroadcast privacy as alleged by this work might reveal a tight upper bound in the future, under our optimistic intuitions. To be more concrete, if only 5% of node operators activate the node rebroadcast module, it won't offer the same level of rebroadcast privacy that if it's activated on 80% of the network IMHO.\r\n\r\nI believe we should address this concern before to propose default activation of this module in the future, or at least gauge bandwidth increases are insignificant to be borne by default. I'll try to run the patch soon to help there :)\r\n\r\nAgain, as I noticed in my previous comment, this work is of course a valuable privacy improvement for Bitcoin Core wallet users, or any Bitcoin software with the same rebroadcast strategy.\r\n\r\n> I also don't understand why you say that m_attempt_tracker is creating an anonymity set- it mostly serves as a way to mitigate frequently rebroadcasting any particular transaction, not the technique we use to identify rebroadcasts.\r\n\r\nIIUC, a transaction is selected for rebroadcast if it passes block min feerate, reattempt interval and max reattempt count. However those 2 late checks aren't applied if the transaction isn't a rebroadcast entry. So `m_attempt_tracker` and its content is part of the logic determining the rebroadcast set. From an attacker viewpoint, this rebroadcast set constitutes an anonymity set. Yes `m_attempt_tracker` isn't a technique to identify rebroadcast but it's used to filter them. Though I agree, for clarify of conversation, it would have been easier to employ as a term node rebroadcast logic.\r\n\r\n> I agree that there are many possibilities & that it would be beneficial to have a more specific breakdown of privacy assumptions & guarantees. However, I don't think that we should gate concrete improvements on theoretically infinite problem spaces. I believe that the changes proposed in this PR & the intended direction of this project offer concrete, auditable improvements to privacy around 3rd parties deducing the source wallet of a transaction.\r\n\r\nAnd I share the same feeling, we would be better off not traversing an infinite problem space. Though, unless you propose an efficient problem space traversal algorithm, we're left with raising and proceeding problem if _relevant_ one by one :/ FYI, IETF does have such design questions checklist about Internet protocols (see https://www.rfc-editor.org/rfc/rfc3426.html), though ofc not suiting per se Bitcoin space. Otherwise, I would recall that this project history showed us \"concrete improvements\" not solving the privacy issues alleged while introducing subtle DoS issues (e.g bloom filters)",
      "created_at" : "2021-05-06T18:22:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-833755057",
      "id" : 833755057,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzMzc1NTA1Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-06T18:24:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/833755057",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@ariard: To summarize, I think what you are concerned with is the rebroadcast privacy offered by this module to nodes that are using it assuming only a minority (perhaps a small minority) of the network is using it. This module is currently off by default and according to you (I have no reason to doubt you) a significant proportion of the network is already running custom rebroadcast logic.\r\n\r\nTo me it appears nodes that choose to use the module benefit and nodes that aren't using it aren't negatively impacted. As long as that is true (and you agree with that) it doesn't matter if only a (small) minority are using it? (Of course in time there could be a lot more than a small minority of the network using it.) Or is your concern with nodes that choose to use this module when they really shouldn't be using it?\r\n\r\n",
      "created_at" : "2021-05-06T19:01:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-833784113",
      "id" : 833784113,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzMzc4NDExMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-06T19:01:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/833784113",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/16323900?v=4",
         "events_url" : "https://api.github.com/users/michaelfolkson/events{/privacy}",
         "followers_url" : "https://api.github.com/users/michaelfolkson/followers",
         "following_url" : "https://api.github.com/users/michaelfolkson/following{/other_user}",
         "gists_url" : "https://api.github.com/users/michaelfolkson/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/michaelfolkson",
         "id" : 16323900,
         "login" : "michaelfolkson",
         "node_id" : "MDQ6VXNlcjE2MzIzOTAw",
         "organizations_url" : "https://api.github.com/users/michaelfolkson/orgs",
         "received_events_url" : "https://api.github.com/users/michaelfolkson/received_events",
         "repos_url" : "https://api.github.com/users/michaelfolkson/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/michaelfolkson/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/michaelfolkson/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/michaelfolkson"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> However, and that's my point, a lot of full-nodes are hosting Bitcoin applications with custom rebroadcast logic, and this trend is likely to increase in the future\r\n\r\nInteresting. Can you please share few examples?",
      "created_at" : "2021-05-07T00:29:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-833970247",
      "id" : 833970247,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzMzk3MDI0Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-07T00:29:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/833970247",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r628043830"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628043830"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It seems a shame to add a disk read here (which gets called in net_processing's `UpdatedBlockTip()` callback). We could avoid this by updating the `UpdatedBlockTip()` signature function to also pass a `const std::shared_ptr<const CBlock> &block` in the same way that `BlockConnected()` does. It could also just pass the weight of the new block, but that seems strangely specific for the validation interface. What do you think?",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-07T08:55:45Z",
      "diff_hunk" : "@@ -0,0 +1,242 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <node/blockstorage.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast upto 3/4 of max block weight to reduce noise due to\n+ * circumstances such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE{24h * 30 * 3};\n+\n+struct RebroadcastEntry {\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\n+        : m_last_attempt(now_time),\n+          m_wtxid(wtxid) {}\n+\n+    std::chrono::microseconds m_last_attempt;\n+    const uint256 m_wtxid;\n+    int m_count{1};\n+};\n+\n+/** Used for multi_index tag  */\n+struct index_by_last_attempt {};\n+\n+class indexed_rebroadcast_set : public\n+boost::multi_index_container<\n+    RebroadcastEntry,\n+    boost::multi_index::indexed_by<\n+        // sorted by wtxid\n+        boost::multi_index::hashed_unique<\n+            boost::multi_index::tag<index_by_wtxid>,\n+            boost::multi_index::member<RebroadcastEntry, const uint256, &RebroadcastEntry::m_wtxid>,\n+            SaltedTxidHasher\n+        >,\n+        // sorted by last rebroadcast time\n+        boost::multi_index::ordered_non_unique<\n+            boost::multi_index::tag<index_by_last_attempt>,\n+            boost::multi_index::member<RebroadcastEntry, std::chrono::microseconds, &RebroadcastEntry::m_last_attempt>\n+        >\n+    >\n+>{};\n+\n+TxRebroadcastHandler::~TxRebroadcastHandler() = default;\n+\n+TxRebroadcastHandler::TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams)\n+    : m_mempool{mempool},\n+      m_chainman{chainman},\n+      m_chainparams(chainparams),\n+      m_attempt_tracker{std::make_unique<indexed_rebroadcast_set>()}{}\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions(const CBlockIndex* recent_block_index)\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    auto start_time = GetTime<std::chrono::microseconds>();\n+\n+    int rebroadcast_block_weight = MAX_REBROADCAST_WEIGHT;\n+    CBlock block;\n+    const Consensus::Params& consensus_params = m_chainparams.GetConsensus();\n+    if (ReadBlockFromDisk(block, recent_block_index, consensus_params)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r628043830",
      "id" : 628043830,
      "line" : 86,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyODA0MzgzMA==",
      "original_commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "original_line" : 86,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 86,
      "pull_request_review_id" : 654234067,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-07T10:59:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628043830",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r628053757"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628053757"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This could go in the initializer list:\r\n\r\n```diff\r\ndiff --git a/src/net_processing.cpp b/src/net_processing.cpp\r\nindex 9a7bc8efd3..79897845d3 100644\r\n--- a/src/net_processing.cpp\r\n+++ b/src/net_processing.cpp\r\n@@ -337,7 +337,7 @@ private:\r\n     ChainstateManager& m_chainman;\r\n     CTxMemPool& m_mempool;\r\n     TxRequestTracker m_txrequest GUARDED_BY(::cs_main);\r\n-    std::unique_ptr<TxRebroadcastHandler> m_txrebroadcast;\r\n+    const std::unique_ptr<TxRebroadcastHandler> m_txrebroadcast;\r\n \r\n     /** The height of the best chain */\r\n     std::atomic<int> m_best_height{-1};\r\n@@ -1271,6 +1271,7 @@ PeerManagerImpl::PeerManagerImpl(const CChainParams& chainparams, CConnman& conn\r\n       m_banman(banman),\r\n       m_chainman(chainman),\r\n       m_mempool(pool),\r\n+      m_txrebroadcast{enable_rebroadcast ? std::make_unique<TxRebroadcastHandler>(m_mempool, m_chainman, m_chainparams) : nullptr},\r\n       m_stale_tip_check_time(0),\r\n       m_ignore_incoming_txs(ignore_incoming_txs)\r\n {\r\n@@ -1289,9 +1290,7 @@ PeerManagerImpl::PeerManagerImpl(const CChainParams& chainparams, CConnman& conn\r\n     // same probability that we have in the reject filter).\r\n     m_recent_confirmed_transactions.reset(new CRollingBloomFilter(48000, 0.000001));\r\n \r\n-    if (enable_rebroadcast) {\r\n-        m_txrebroadcast = std::make_unique<TxRebroadcastHandler>(m_mempool, m_chainman, m_chainparams);\r\n-\r\n+    if (m_txrebroadcast) {\r\n         // Run fee rate cache every minute\r\n         scheduler.scheduleEvery([this] { m_txrebroadcast->CacheMinRebroadcastFee(); }, REBROADCAST_CACHE_FREQUENCY);\r\n     }\r\n[john] /home/john/Code/crypto/bitcoin\r\n```\r\n\r\nThat allows you to make the `m_txrebroadcast` member `const` (which means that there can't possibly be any data races on setting/reading the pointer).",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-07T09:11:19Z",
      "diff_hunk" : "@@ -1286,22 +1289,57 @@ PeerManagerImpl::PeerManagerImpl(const CChainParams& chainparams, CConnman& conn\n     // same probability that we have in the reject filter).\n     m_recent_confirmed_transactions.reset(new CRollingBloomFilter(48000, 0.000001));\n \n+    if (enable_rebroadcast) {\n+        m_txrebroadcast = std::make_unique<TxRebroadcastHandler>(m_mempool, m_chainman, m_chainparams);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r628053757",
      "id" : 628053757,
      "line" : 1293,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyODA1Mzc1Nw==",
      "original_commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "original_line" : 1293,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 51,
      "pull_request_review_id" : 654234067,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-07T10:59:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628053757",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r628054781"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628054781"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Don't put the value (`minute`) in this comment. If the constant is updated at some point in the future, this comment will become outdated. In fact, I think this comment can be removed entirely. The code is pretty self-documenting.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-07T09:12:48Z",
      "diff_hunk" : "@@ -1286,22 +1289,57 @@ PeerManagerImpl::PeerManagerImpl(const CChainParams& chainparams, CConnman& conn\n     // same probability that we have in the reject filter).\n     m_recent_confirmed_transactions.reset(new CRollingBloomFilter(48000, 0.000001));\n \n+    if (enable_rebroadcast) {\n+        m_txrebroadcast = std::make_unique<TxRebroadcastHandler>(m_mempool, m_chainman, m_chainparams);\n+\n+        // Run fee rate cache every minute",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r628054781",
      "id" : 628054781,
      "line" : 1295,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyODA1NDc4MQ==",
      "original_commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "original_line" : 1295,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 53,
      "pull_request_review_id" : 654234067,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-07T10:59:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628054781",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r628060392"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628060392"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It'd be really nice if `BlockAssembler` could be extracted so that rebroadcast doesn't have dependencies on the mining-specific code. That would allow you to remove `m_chainman.ActiveChainstate()`, `m_chainparams` and `CScript()` from this call.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-07T09:21:13Z",
      "diff_hunk" : "@@ -0,0 +1,242 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <node/blockstorage.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast upto 3/4 of max block weight to reduce noise due to\n+ * circumstances such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE{24h * 30 * 3};\n+\n+struct RebroadcastEntry {\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\n+        : m_last_attempt(now_time),\n+          m_wtxid(wtxid) {}\n+\n+    std::chrono::microseconds m_last_attempt;\n+    const uint256 m_wtxid;\n+    int m_count{1};\n+};\n+\n+/** Used for multi_index tag  */\n+struct index_by_last_attempt {};\n+\n+class indexed_rebroadcast_set : public\n+boost::multi_index_container<\n+    RebroadcastEntry,\n+    boost::multi_index::indexed_by<\n+        // sorted by wtxid\n+        boost::multi_index::hashed_unique<\n+            boost::multi_index::tag<index_by_wtxid>,\n+            boost::multi_index::member<RebroadcastEntry, const uint256, &RebroadcastEntry::m_wtxid>,\n+            SaltedTxidHasher\n+        >,\n+        // sorted by last rebroadcast time\n+        boost::multi_index::ordered_non_unique<\n+            boost::multi_index::tag<index_by_last_attempt>,\n+            boost::multi_index::member<RebroadcastEntry, std::chrono::microseconds, &RebroadcastEntry::m_last_attempt>\n+        >\n+    >\n+>{};\n+\n+TxRebroadcastHandler::~TxRebroadcastHandler() = default;\n+\n+TxRebroadcastHandler::TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams)\n+    : m_mempool{mempool},\n+      m_chainman{chainman},\n+      m_chainparams(chainparams),\n+      m_attempt_tracker{std::make_unique<indexed_rebroadcast_set>()}{}\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions(const CBlockIndex* recent_block_index)\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    auto start_time = GetTime<std::chrono::microseconds>();\n+\n+    int rebroadcast_block_weight = MAX_REBROADCAST_WEIGHT;\n+    CBlock block;\n+    const Consensus::Params& consensus_params = m_chainparams.GetConsensus();\n+    if (ReadBlockFromDisk(block, recent_block_index, consensus_params)) {\n+        rebroadcast_block_weight = 3 * GetBlockWeight(block) / 4;\n+    }\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = rebroadcast_block_weight;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.m_check_block_validity = false;\n+\n+    // The fee rate condition only filters out transactions if it runs before\n+    // we process the recently mined block. If the cache has since been\n+    // updated, used the value from the previous run to filter transactions.\n+    {\n+        LOCK(m_rebroadcast_mutex);\n+        if (m_tip_at_cache_time == m_chainman.ActiveTip()) {\n+            options.blockMinFeeRate = m_previous_cached_fee_rate;\n+        } else {\n+            options.blockMinFeeRate = m_cached_fee_rate;\n+        }\n+    }\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_chainman.ActiveChainstate(), m_mempool, m_chainparams, options)\n+                              .CreateNewBlock(CScript());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r628060392",
      "id" : 628060392,
      "line" : 109,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyODA2MDM5Mg==",
      "original_commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "original_line" : 109,
      "original_position" : 109,
      "original_start_line" : 108,
      "path" : "src/txrebroadcast.cpp",
      "position" : 109,
      "pull_request_review_id" : 654234067,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : 108,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-07T10:59:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628060392",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r628064681"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628064681"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe move this initialization down to below the call to CNB (just above the main for loop in this function where `rebroadcast_txs` is used), and then call `reserve` to the size of `block_template->block.vtx` so that we don't to multiple reallocations)",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-07T09:27:55Z",
      "diff_hunk" : "@@ -0,0 +1,242 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <node/blockstorage.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast upto 3/4 of max block weight to reduce noise due to\n+ * circumstances such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE{24h * 30 * 3};\n+\n+struct RebroadcastEntry {\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\n+        : m_last_attempt(now_time),\n+          m_wtxid(wtxid) {}\n+\n+    std::chrono::microseconds m_last_attempt;\n+    const uint256 m_wtxid;\n+    int m_count{1};\n+};\n+\n+/** Used for multi_index tag  */\n+struct index_by_last_attempt {};\n+\n+class indexed_rebroadcast_set : public\n+boost::multi_index_container<\n+    RebroadcastEntry,\n+    boost::multi_index::indexed_by<\n+        // sorted by wtxid\n+        boost::multi_index::hashed_unique<\n+            boost::multi_index::tag<index_by_wtxid>,\n+            boost::multi_index::member<RebroadcastEntry, const uint256, &RebroadcastEntry::m_wtxid>,\n+            SaltedTxidHasher\n+        >,\n+        // sorted by last rebroadcast time\n+        boost::multi_index::ordered_non_unique<\n+            boost::multi_index::tag<index_by_last_attempt>,\n+            boost::multi_index::member<RebroadcastEntry, std::chrono::microseconds, &RebroadcastEntry::m_last_attempt>\n+        >\n+    >\n+>{};\n+\n+TxRebroadcastHandler::~TxRebroadcastHandler() = default;\n+\n+TxRebroadcastHandler::TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams)\n+    : m_mempool{mempool},\n+      m_chainman{chainman},\n+      m_chainparams(chainparams),\n+      m_attempt_tracker{std::make_unique<indexed_rebroadcast_set>()}{}\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions(const CBlockIndex* recent_block_index)\n+{\n+    std::vector<TxIds> rebroadcast_txs;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r628064681",
      "id" : 628064681,
      "line" : 80,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyODA2NDY4MQ==",
      "original_commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "original_line" : 80,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 80,
      "pull_request_review_id" : 654234067,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-07T10:59:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628064681",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r628081472"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628081472"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That's fair. Marking this as resolved.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-07T09:54:48Z",
      "diff_hunk" : "@@ -0,0 +1,95 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXREBROADCAST_H\n+#define BITCOIN_TXREBROADCAST_H\n+\n+#include <policy/feerate.h>\n+#include <tuple>\n+#include <txmempool.h>\n+#include <util/hasher.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+struct TxIds {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r628081472",
      "id" : 628081472,
      "in_reply_to_id" : 594666637,
      "line" : 15,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyODA4MTQ3Mg==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 15,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.h",
      "position" : 15,
      "pull_request_review_id" : 654234067,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-07T10:59:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628081472",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r628084018"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628084018"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could this be a `const CBlockIndex&` rather than pointer? `ReadBlockFromDisk()` unconditionally dereferences the pointer, so it can't be null.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-07T09:58:49Z",
      "diff_hunk" : "@@ -0,0 +1,92 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXREBROADCAST_H\n+#define BITCOIN_TXREBROADCAST_H\n+\n+#include <policy/feerate.h>\n+#include <txmempool.h>\n+#include <validation.h>\n+\n+/** Frequency to run the fee rate cache. */\n+constexpr std::chrono::minutes REBROADCAST_CACHE_FREQUENCY{1};\n+\n+struct TxIds {\n+    TxIds(uint256 txid, uint256 wtxid) : m_txid(txid), m_wtxid(wtxid) {}\n+\n+    const uint256 m_txid;\n+    const uint256 m_wtxid;\n+};\n+\n+class indexed_rebroadcast_set;\n+\n+class TxRebroadcastHandler\n+{\n+public:\n+    TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams);\n+    ~TxRebroadcastHandler();\n+\n+    TxRebroadcastHandler(const TxRebroadcastHandler& other) = delete;\n+    TxRebroadcastHandler& operator=(const TxRebroadcastHandler& other) = delete;\n+\n+    std::vector<TxIds> GetRebroadcastTransactions(const CBlockIndex* recent_block_index);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r628084018",
      "id" : 628084018,
      "line" : 33,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyODA4NDAxOA==",
      "original_commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "original_line" : 33,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.h",
      "position" : 33,
      "pull_request_review_id" : 654234067,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-07T10:59:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628084018",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r628097324"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628097324"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe add an assertion that `m_attempt_tracker` is held.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-07T10:21:35Z",
      "diff_hunk" : "@@ -0,0 +1,242 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <node/blockstorage.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast upto 3/4 of max block weight to reduce noise due to\n+ * circumstances such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE{24h * 30 * 3};\n+\n+struct RebroadcastEntry {\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\n+        : m_last_attempt(now_time),\n+          m_wtxid(wtxid) {}\n+\n+    std::chrono::microseconds m_last_attempt;\n+    const uint256 m_wtxid;\n+    int m_count{1};\n+};\n+\n+/** Used for multi_index tag  */\n+struct index_by_last_attempt {};\n+\n+class indexed_rebroadcast_set : public\n+boost::multi_index_container<\n+    RebroadcastEntry,\n+    boost::multi_index::indexed_by<\n+        // sorted by wtxid\n+        boost::multi_index::hashed_unique<\n+            boost::multi_index::tag<index_by_wtxid>,\n+            boost::multi_index::member<RebroadcastEntry, const uint256, &RebroadcastEntry::m_wtxid>,\n+            SaltedTxidHasher\n+        >,\n+        // sorted by last rebroadcast time\n+        boost::multi_index::ordered_non_unique<\n+            boost::multi_index::tag<index_by_last_attempt>,\n+            boost::multi_index::member<RebroadcastEntry, std::chrono::microseconds, &RebroadcastEntry::m_last_attempt>\n+        >\n+    >\n+>{};\n+\n+TxRebroadcastHandler::~TxRebroadcastHandler() = default;\n+\n+TxRebroadcastHandler::TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams)\n+    : m_mempool{mempool},\n+      m_chainman{chainman},\n+      m_chainparams(chainparams),\n+      m_attempt_tracker{std::make_unique<indexed_rebroadcast_set>()}{}\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions(const CBlockIndex* recent_block_index)\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    auto start_time = GetTime<std::chrono::microseconds>();\n+\n+    int rebroadcast_block_weight = MAX_REBROADCAST_WEIGHT;\n+    CBlock block;\n+    const Consensus::Params& consensus_params = m_chainparams.GetConsensus();\n+    if (ReadBlockFromDisk(block, recent_block_index, consensus_params)) {\n+        rebroadcast_block_weight = 3 * GetBlockWeight(block) / 4;\n+    }\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = rebroadcast_block_weight;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.m_check_block_validity = false;\n+\n+    // The fee rate condition only filters out transactions if it runs before\n+    // we process the recently mined block. If the cache has since been\n+    // updated, used the value from the previous run to filter transactions.\n+    {\n+        LOCK(m_rebroadcast_mutex);\n+        if (m_tip_at_cache_time == m_chainman.ActiveTip()) {\n+            options.blockMinFeeRate = m_previous_cached_fee_rate;\n+        } else {\n+            options.blockMinFeeRate = m_cached_fee_rate;\n+        }\n+    }\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_chainman.ActiveChainstate(), m_mempool, m_chainparams, options)\n+                              .CreateNewBlock(CScript());\n+    auto after_cnb_time = GetTime<std::chrono::microseconds>();\n+\n+    LOCK(m_rebroadcast_mutex);\n+    for (const CTransactionRef& tx : block_template->block.vtx) {\n+        if (tx->IsCoinBase()) continue;\n+\n+        uint256 txid = tx->GetHash();\n+        uint256 wtxid = tx->GetWitnessHash();\n+\n+        // Check if we have previously rebroadcasted, decide if we will this\n+        // round, and if so, record the attempt.\n+        auto entry_it = m_attempt_tracker->find(wtxid);\n+\n+        if (entry_it == m_attempt_tracker->end()) {\n+            // No existing entry, we will rebroadcast, so create a new one\n+            RebroadcastEntry entry(start_time, wtxid);\n+            m_attempt_tracker->insert(entry);\n+        } else if (entry_it->m_count >= MAX_REBROADCAST_COUNT) {\n+            // We have already rebroadcast this transaction the maximum number\n+            // of times permitted, so skip rebroadcasting.\n+            continue;\n+        } else if (entry_it->m_last_attempt > start_time - MIN_REATTEMPT_INTERVAL) {\n+            // We already rebroadcasted this in the past 4 hours. Even if we\n+            // added it to the set, it would probably not get INVed to most\n+            // peers due to filterInventoryKnown.\n+            continue;\n+        } else {\n+            // We have rebroadcasted this transaction before, but will try\n+            // again now. Record the attempt.\n+            auto UpdateRebroadcastEntry = [start_time](RebroadcastEntry& rebroadcast_entry) {\n+                rebroadcast_entry.m_last_attempt = start_time;\n+                ++rebroadcast_entry.m_count;\n+            };\n+\n+            m_attempt_tracker->modify(entry_it, UpdateRebroadcastEntry);\n+        }\n+\n+        // Add to set of rebroadcast candidates\n+        rebroadcast_txs.push_back(TxIds(txid, wtxid));\n+    }\n+\n+    TrimMaxRebroadcast();\n+\n+    auto delta1 = after_cnb_time - start_time;\n+    auto delta2 = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"GetRebroadcastTransactions(): %d us total, %d us spent in CreateNewBlock.\\n\", delta2.count(), delta1.count());\n+    LogPrint(BCLog::NET, \"Queued %d transactions for attempted rebroadcast, filtered from %d candidates with cached fee rate of %s.\\n\", rebroadcast_txs.size(), block_template->block.vtx.size() - 1, m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB));\n+\n+    for (TxIds ids : rebroadcast_txs) {\n+        LogPrint(BCLog::NET, \"Attempting to rebroadcast txid: %s, wtxid: %s\\n\", ids.m_txid.ToString(), ids.m_wtxid.ToString());\n+    }\n+\n+    return rebroadcast_txs;\n+};\n+\n+void TxRebroadcastHandler::CacheMinRebroadcastFee()\n+{\n+    if (m_chainman.ActiveChainstate().IsInitialBlockDownload()) return;\n+\n+    LOCK(m_rebroadcast_mutex);\n+\n+    // Update stamp of chain tip on cache run\n+    m_tip_at_cache_time = m_chainman.ActiveTip();\n+\n+    // Store the existing fee rate\n+    m_previous_cached_fee_rate = m_cached_fee_rate;\n+\n+    // Calculate a new cached fee rate\n+    auto start_time = GetTime<std::chrono::microseconds>();\n+    m_cached_fee_rate = BlockAssembler(m_chainman.ActiveChainstate(), m_mempool, m_chainparams).MinTxFeeRate();\n+    auto delta_time = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"Caching minimum fee for rebroadcast to %s, took %d us to calculate.\\n\", m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB), delta_time.count());\n+};\n+\n+void TxRebroadcastHandler::RemoveFromAttemptTracker(const CTransactionRef& tx) {\n+    LOCK(m_rebroadcast_mutex);\n+    const auto it = m_attempt_tracker->find(tx->GetWitnessHash());\n+    if (it == m_attempt_tracker->end()) return;\n+    m_attempt_tracker->erase(it);\n+}\n+\n+void TxRebroadcastHandler::TrimMaxRebroadcast()\n+{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r628097324",
      "id" : 628097324,
      "line" : 192,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyODA5NzMyNA==",
      "original_commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "original_line" : 192,
      "original_position" : 192,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 192,
      "pull_request_review_id" : 654234067,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-07T10:59:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628097324",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r628101402"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628101402"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The two while loops can be consolidated:\r\n\r\n```diff\r\ndiff --git a/src/txrebroadcast.cpp b/src/txrebroadcast.cpp\r\nindex 940735df1a..401621153c 100644\r\n--- a/src/txrebroadcast.cpp\r\n+++ b/src/txrebroadcast.cpp\r\n@@ -195,18 +195,11 @@ void TxRebroadcastHandler::TrimMaxRebroadcast()\r\n \r\n     while (!m_attempt_tracker->empty()) {\r\n         auto it = m_attempt_tracker->get<index_by_last_attempt>().begin();\r\n-        if (it->m_last_attempt < min_age) {\r\n-            m_attempt_tracker->get<index_by_last_attempt>().erase(it);\r\n-        } else {\r\n+        if (it->m_last_attempt >= min_age && m_attempt_tracker->size() <= MAX_ENTRIES) {\r\n+            // The transaction is not old enough to trim and the attempt tracker is not full\r\n             break;\r\n         }\r\n     }\r\n-\r\n-    // If there are still too many entries, delete the oldest ones\r\n-    while (m_attempt_tracker->size() > MAX_ENTRIES) {\r\n-        auto it = m_attempt_tracker->get<index_by_last_attempt>().begin();\r\n-        m_attempt_tracker->get<index_by_last_attempt>().erase(it);\r\n-    }\r\n };\r\n```\r\n\r\nPerhaps that's easier to read since there's less repetition?\r\n\r\nIf you do that, then perhaps you could just remove this function entirely and put the loop inside `GetRebroadcastTransactions()` since it's only called in that one place.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-07T10:28:31Z",
      "diff_hunk" : "@@ -0,0 +1,242 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <node/blockstorage.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast upto 3/4 of max block weight to reduce noise due to\n+ * circumstances such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE{24h * 30 * 3};\n+\n+struct RebroadcastEntry {\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\n+        : m_last_attempt(now_time),\n+          m_wtxid(wtxid) {}\n+\n+    std::chrono::microseconds m_last_attempt;\n+    const uint256 m_wtxid;\n+    int m_count{1};\n+};\n+\n+/** Used for multi_index tag  */\n+struct index_by_last_attempt {};\n+\n+class indexed_rebroadcast_set : public\n+boost::multi_index_container<\n+    RebroadcastEntry,\n+    boost::multi_index::indexed_by<\n+        // sorted by wtxid\n+        boost::multi_index::hashed_unique<\n+            boost::multi_index::tag<index_by_wtxid>,\n+            boost::multi_index::member<RebroadcastEntry, const uint256, &RebroadcastEntry::m_wtxid>,\n+            SaltedTxidHasher\n+        >,\n+        // sorted by last rebroadcast time\n+        boost::multi_index::ordered_non_unique<\n+            boost::multi_index::tag<index_by_last_attempt>,\n+            boost::multi_index::member<RebroadcastEntry, std::chrono::microseconds, &RebroadcastEntry::m_last_attempt>\n+        >\n+    >\n+>{};\n+\n+TxRebroadcastHandler::~TxRebroadcastHandler() = default;\n+\n+TxRebroadcastHandler::TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams)\n+    : m_mempool{mempool},\n+      m_chainman{chainman},\n+      m_chainparams(chainparams),\n+      m_attempt_tracker{std::make_unique<indexed_rebroadcast_set>()}{}\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions(const CBlockIndex* recent_block_index)\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    auto start_time = GetTime<std::chrono::microseconds>();\n+\n+    int rebroadcast_block_weight = MAX_REBROADCAST_WEIGHT;\n+    CBlock block;\n+    const Consensus::Params& consensus_params = m_chainparams.GetConsensus();\n+    if (ReadBlockFromDisk(block, recent_block_index, consensus_params)) {\n+        rebroadcast_block_weight = 3 * GetBlockWeight(block) / 4;\n+    }\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = rebroadcast_block_weight;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.m_check_block_validity = false;\n+\n+    // The fee rate condition only filters out transactions if it runs before\n+    // we process the recently mined block. If the cache has since been\n+    // updated, used the value from the previous run to filter transactions.\n+    {\n+        LOCK(m_rebroadcast_mutex);\n+        if (m_tip_at_cache_time == m_chainman.ActiveTip()) {\n+            options.blockMinFeeRate = m_previous_cached_fee_rate;\n+        } else {\n+            options.blockMinFeeRate = m_cached_fee_rate;\n+        }\n+    }\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_chainman.ActiveChainstate(), m_mempool, m_chainparams, options)\n+                              .CreateNewBlock(CScript());\n+    auto after_cnb_time = GetTime<std::chrono::microseconds>();\n+\n+    LOCK(m_rebroadcast_mutex);\n+    for (const CTransactionRef& tx : block_template->block.vtx) {\n+        if (tx->IsCoinBase()) continue;\n+\n+        uint256 txid = tx->GetHash();\n+        uint256 wtxid = tx->GetWitnessHash();\n+\n+        // Check if we have previously rebroadcasted, decide if we will this\n+        // round, and if so, record the attempt.\n+        auto entry_it = m_attempt_tracker->find(wtxid);\n+\n+        if (entry_it == m_attempt_tracker->end()) {\n+            // No existing entry, we will rebroadcast, so create a new one\n+            RebroadcastEntry entry(start_time, wtxid);\n+            m_attempt_tracker->insert(entry);\n+        } else if (entry_it->m_count >= MAX_REBROADCAST_COUNT) {\n+            // We have already rebroadcast this transaction the maximum number\n+            // of times permitted, so skip rebroadcasting.\n+            continue;\n+        } else if (entry_it->m_last_attempt > start_time - MIN_REATTEMPT_INTERVAL) {\n+            // We already rebroadcasted this in the past 4 hours. Even if we\n+            // added it to the set, it would probably not get INVed to most\n+            // peers due to filterInventoryKnown.\n+            continue;\n+        } else {\n+            // We have rebroadcasted this transaction before, but will try\n+            // again now. Record the attempt.\n+            auto UpdateRebroadcastEntry = [start_time](RebroadcastEntry& rebroadcast_entry) {\n+                rebroadcast_entry.m_last_attempt = start_time;\n+                ++rebroadcast_entry.m_count;\n+            };\n+\n+            m_attempt_tracker->modify(entry_it, UpdateRebroadcastEntry);\n+        }\n+\n+        // Add to set of rebroadcast candidates\n+        rebroadcast_txs.push_back(TxIds(txid, wtxid));\n+    }\n+\n+    TrimMaxRebroadcast();\n+\n+    auto delta1 = after_cnb_time - start_time;\n+    auto delta2 = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"GetRebroadcastTransactions(): %d us total, %d us spent in CreateNewBlock.\\n\", delta2.count(), delta1.count());\n+    LogPrint(BCLog::NET, \"Queued %d transactions for attempted rebroadcast, filtered from %d candidates with cached fee rate of %s.\\n\", rebroadcast_txs.size(), block_template->block.vtx.size() - 1, m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB));\n+\n+    for (TxIds ids : rebroadcast_txs) {\n+        LogPrint(BCLog::NET, \"Attempting to rebroadcast txid: %s, wtxid: %s\\n\", ids.m_txid.ToString(), ids.m_wtxid.ToString());\n+    }\n+\n+    return rebroadcast_txs;\n+};\n+\n+void TxRebroadcastHandler::CacheMinRebroadcastFee()\n+{\n+    if (m_chainman.ActiveChainstate().IsInitialBlockDownload()) return;\n+\n+    LOCK(m_rebroadcast_mutex);\n+\n+    // Update stamp of chain tip on cache run\n+    m_tip_at_cache_time = m_chainman.ActiveTip();\n+\n+    // Store the existing fee rate\n+    m_previous_cached_fee_rate = m_cached_fee_rate;\n+\n+    // Calculate a new cached fee rate\n+    auto start_time = GetTime<std::chrono::microseconds>();\n+    m_cached_fee_rate = BlockAssembler(m_chainman.ActiveChainstate(), m_mempool, m_chainparams).MinTxFeeRate();\n+    auto delta_time = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"Caching minimum fee for rebroadcast to %s, took %d us to calculate.\\n\", m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB), delta_time.count());\n+};\n+\n+void TxRebroadcastHandler::RemoveFromAttemptTracker(const CTransactionRef& tx) {\n+    LOCK(m_rebroadcast_mutex);\n+    const auto it = m_attempt_tracker->find(tx->GetWitnessHash());\n+    if (it == m_attempt_tracker->end()) return;\n+    m_attempt_tracker->erase(it);\n+}\n+\n+void TxRebroadcastHandler::TrimMaxRebroadcast()\n+{\n+    // Delete any entries that are older than MAX_ENTRY_AGE\n+    auto min_age = GetTime<std::chrono::microseconds>() - MAX_ENTRY_AGE;\n+\n+    while (!m_attempt_tracker->empty()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r628101402",
      "id" : 628101402,
      "line" : 196,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyODEwMTQwMg==",
      "original_commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "original_line" : 196,
      "original_position" : 196,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 196,
      "pull_request_review_id" : 654234067,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-07T10:59:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628101402",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r628102526"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628102526"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps remove this added newline?",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-07T10:30:24Z",
      "diff_hunk" : "@@ -78,6 +80,7 @@ static BlockAssembler::Options DefaultOptions()\n     } else {\n         options.blockMinFeeRate = CFeeRate(DEFAULT_BLOCK_MIN_TX_FEE);\n     }\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r628102526",
      "id" : 628102526,
      "line" : 83,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyODEwMjUyNg==",
      "original_commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "original_line" : 83,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/miner.cpp",
      "position" : 15,
      "pull_request_review_id" : 654234067,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-07T10:59:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628102526",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r628119730"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628119730"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It seems to me that `m_attempt_tracker` has two distinct purposes:\r\n\r\n1. prevent us from rebroadcasting transactions too frequently (see `entry_it->m_last_attempt > start_time - MIN_REATTEMPT_INTERVAL`)\r\n2. prevent us from rebroadcasting transactions too many times (see `else if (entry_it->m_count >= MAX_REBROADCAST_COUNT)`)\r\n\r\nI think the expiry strategies conflict for these two purposes. Imagine that we (unupgraded) have 550 txs that are no longer standard for the rest of the network\r\n\r\n- for don't-rebroadcast-too-frequently, we want to expire least-recently-rebroadcast first, since if we expire more recently rebroadcast transactions, then we'll try to rebroadcast them again the next time we receive a block, and we'll end up rebroadcasting a very small set of txs very frequently.\r\n- for don't-rebroadcast-too-many-times, if we expire the least-recently-rebroadcast first, then the next time we calculate a rebroadcast set, we'll include them again, re-add them to attempt_tracker, and expire the next oldest 50. We'll continue cycling all the now-nonstandard transactions through the attempt tracker over and over again.\r\n\r\nI think it might be a good idea to separate these two purposes by adding a (rolling?) bloom filter for (2). Once a transaction has been rebroadcast `MIN_REATTEMPT_INTERVAL` times (or it's removed from the attempt tracker because the tracker is full) we toss it in the bloom filter and then never rebroadcast it again (at least until restart).",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-07T10:58:58Z",
      "diff_hunk" : "@@ -0,0 +1,242 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <node/blockstorage.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast upto 3/4 of max block weight to reduce noise due to\n+ * circumstances such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE{24h * 30 * 3};\n+\n+struct RebroadcastEntry {\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\n+        : m_last_attempt(now_time),\n+          m_wtxid(wtxid) {}\n+\n+    std::chrono::microseconds m_last_attempt;\n+    const uint256 m_wtxid;\n+    int m_count{1};\n+};\n+\n+/** Used for multi_index tag  */\n+struct index_by_last_attempt {};\n+\n+class indexed_rebroadcast_set : public\n+boost::multi_index_container<\n+    RebroadcastEntry,\n+    boost::multi_index::indexed_by<\n+        // sorted by wtxid\n+        boost::multi_index::hashed_unique<\n+            boost::multi_index::tag<index_by_wtxid>,\n+            boost::multi_index::member<RebroadcastEntry, const uint256, &RebroadcastEntry::m_wtxid>,\n+            SaltedTxidHasher\n+        >,\n+        // sorted by last rebroadcast time\n+        boost::multi_index::ordered_non_unique<\n+            boost::multi_index::tag<index_by_last_attempt>,\n+            boost::multi_index::member<RebroadcastEntry, std::chrono::microseconds, &RebroadcastEntry::m_last_attempt>\n+        >\n+    >\n+>{};\n+\n+TxRebroadcastHandler::~TxRebroadcastHandler() = default;\n+\n+TxRebroadcastHandler::TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams)\n+    : m_mempool{mempool},\n+      m_chainman{chainman},\n+      m_chainparams(chainparams),\n+      m_attempt_tracker{std::make_unique<indexed_rebroadcast_set>()}{}\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions(const CBlockIndex* recent_block_index)\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    auto start_time = GetTime<std::chrono::microseconds>();\n+\n+    int rebroadcast_block_weight = MAX_REBROADCAST_WEIGHT;\n+    CBlock block;\n+    const Consensus::Params& consensus_params = m_chainparams.GetConsensus();\n+    if (ReadBlockFromDisk(block, recent_block_index, consensus_params)) {\n+        rebroadcast_block_weight = 3 * GetBlockWeight(block) / 4;\n+    }\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = rebroadcast_block_weight;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.m_check_block_validity = false;\n+\n+    // The fee rate condition only filters out transactions if it runs before\n+    // we process the recently mined block. If the cache has since been\n+    // updated, used the value from the previous run to filter transactions.\n+    {\n+        LOCK(m_rebroadcast_mutex);\n+        if (m_tip_at_cache_time == m_chainman.ActiveTip()) {\n+            options.blockMinFeeRate = m_previous_cached_fee_rate;\n+        } else {\n+            options.blockMinFeeRate = m_cached_fee_rate;\n+        }\n+    }\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_chainman.ActiveChainstate(), m_mempool, m_chainparams, options)\n+                              .CreateNewBlock(CScript());\n+    auto after_cnb_time = GetTime<std::chrono::microseconds>();\n+\n+    LOCK(m_rebroadcast_mutex);\n+    for (const CTransactionRef& tx : block_template->block.vtx) {\n+        if (tx->IsCoinBase()) continue;\n+\n+        uint256 txid = tx->GetHash();\n+        uint256 wtxid = tx->GetWitnessHash();\n+\n+        // Check if we have previously rebroadcasted, decide if we will this\n+        // round, and if so, record the attempt.\n+        auto entry_it = m_attempt_tracker->find(wtxid);\n+\n+        if (entry_it == m_attempt_tracker->end()) {\n+            // No existing entry, we will rebroadcast, so create a new one\n+            RebroadcastEntry entry(start_time, wtxid);\n+            m_attempt_tracker->insert(entry);\n+        } else if (entry_it->m_count >= MAX_REBROADCAST_COUNT) {\n+            // We have already rebroadcast this transaction the maximum number\n+            // of times permitted, so skip rebroadcasting.\n+            continue;\n+        } else if (entry_it->m_last_attempt > start_time - MIN_REATTEMPT_INTERVAL) {\n+            // We already rebroadcasted this in the past 4 hours. Even if we\n+            // added it to the set, it would probably not get INVed to most\n+            // peers due to filterInventoryKnown.\n+            continue;\n+        } else {\n+            // We have rebroadcasted this transaction before, but will try\n+            // again now. Record the attempt.\n+            auto UpdateRebroadcastEntry = [start_time](RebroadcastEntry& rebroadcast_entry) {\n+                rebroadcast_entry.m_last_attempt = start_time;\n+                ++rebroadcast_entry.m_count;\n+            };\n+\n+            m_attempt_tracker->modify(entry_it, UpdateRebroadcastEntry);\n+        }\n+\n+        // Add to set of rebroadcast candidates\n+        rebroadcast_txs.push_back(TxIds(txid, wtxid));\n+    }\n+\n+    TrimMaxRebroadcast();\n+\n+    auto delta1 = after_cnb_time - start_time;\n+    auto delta2 = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"GetRebroadcastTransactions(): %d us total, %d us spent in CreateNewBlock.\\n\", delta2.count(), delta1.count());\n+    LogPrint(BCLog::NET, \"Queued %d transactions for attempted rebroadcast, filtered from %d candidates with cached fee rate of %s.\\n\", rebroadcast_txs.size(), block_template->block.vtx.size() - 1, m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB));\n+\n+    for (TxIds ids : rebroadcast_txs) {\n+        LogPrint(BCLog::NET, \"Attempting to rebroadcast txid: %s, wtxid: %s\\n\", ids.m_txid.ToString(), ids.m_wtxid.ToString());\n+    }\n+\n+    return rebroadcast_txs;\n+};\n+\n+void TxRebroadcastHandler::CacheMinRebroadcastFee()\n+{\n+    if (m_chainman.ActiveChainstate().IsInitialBlockDownload()) return;\n+\n+    LOCK(m_rebroadcast_mutex);\n+\n+    // Update stamp of chain tip on cache run\n+    m_tip_at_cache_time = m_chainman.ActiveTip();\n+\n+    // Store the existing fee rate\n+    m_previous_cached_fee_rate = m_cached_fee_rate;\n+\n+    // Calculate a new cached fee rate\n+    auto start_time = GetTime<std::chrono::microseconds>();\n+    m_cached_fee_rate = BlockAssembler(m_chainman.ActiveChainstate(), m_mempool, m_chainparams).MinTxFeeRate();\n+    auto delta_time = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"Caching minimum fee for rebroadcast to %s, took %d us to calculate.\\n\", m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB), delta_time.count());\n+};\n+\n+void TxRebroadcastHandler::RemoveFromAttemptTracker(const CTransactionRef& tx) {\n+    LOCK(m_rebroadcast_mutex);\n+    const auto it = m_attempt_tracker->find(tx->GetWitnessHash());\n+    if (it == m_attempt_tracker->end()) return;\n+    m_attempt_tracker->erase(it);\n+}\n+\n+void TxRebroadcastHandler::TrimMaxRebroadcast()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r628119730",
      "id" : 628119730,
      "line" : 191,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyODExOTczMA==",
      "original_commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "original_line" : 191,
      "original_position" : 191,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 191,
      "pull_request_review_id" : 654234067,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-07T10:59:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628119730",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@michaelfolkson \r\n\r\n> @ariard: To summarize, I think what you are concerned with is the rebroadcast privacy offered by this module to nodes that are using it assuming only a minority (perhaps a small minority) of the network is using it. This module is currently off by default and according to you (I have no reason to doubt you) a significant proportion of the network is already running custom rebroadcast logic.\r\n\r\nYes you're summing up well my concern, though significant would need more qualification. I gave some rough numbers above with 10k of Lightning nodes for 100k estimated full-nodes.\r\n\r\n> To me it appears nodes that choose to use the module benefit and nodes that aren't using it aren't negatively impacted. As long as that is true (and you agree with that) it doesn't matter if only a (small) minority are using it? (Of course in time there could be a lot more than a small minority of the network using it.) Or is your concern with nodes that choose to use this module when they really shouldn't be using it?\r\n\r\nWithholding the point on risks of [node fingerprint](https://github.com/bitcoin/bitcoin/pull/21061#discussion_r615156761), I agree it should benefit nodes that are using this module and don't have negative impacts for not-using nodes/other network clients. It doesn't matter if only a small minority are using it, though due to the more limited set of module users, rebroadcast privacy won't be as good as alleged. Where I'm really skeptical is about *activating by default* this module in the future and thus inflating everyone's bandwidth if only a minority of nodes operators are benefiting from the feature.\r\n\r\n> I have no reason to doubt you\r\n\r\nPlease always doubt what I'm saying, I might be wrong or approximate :)\r\n\r\n@prayank23 \r\n\r\n> Interesting. Can you please share few examples?\r\n\r\nMost of Lightning nodes implementations are able to CPFP their transactions. It might be automatically triggered by a block-based timer, a user-selected once-for-all height confirmation or manually through custom's RPC. For eg see lnd's `bumpfee` or dual-funded channel spec with a new `init_rbf` message. For CPFP to be efficient, you will rebroadcast the parent, and its frequency is matter of suiting application/user requirements, likely not matching the new rebroadcast policy introduced by this module.",
      "created_at" : "2021-05-07T18:16:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-834668685",
      "id" : 834668685,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzNDY2ODY4NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-07T18:18:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/834668685",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@ariard:\r\n\r\n> Where I'm really skeptical is about activating by default this module in the future and thus inflating everyone's bandwidth if only a minority of nodes operators are benefiting from the feature.\r\n\r\n> Most of Lightning nodes implementations are able to CPFP their transactions. It might be automatically triggered by a block-based timer, a user-selected once-for-all height confirmation or manually through custom's RPC. For eg see lnd's bumpfee or dual-funded channel spec with a new init_rbf message. For CPFP to be efficient, you will rebroadcast the parent, and its frequency is matter of suiting application/user requirements, likely not matching the new rebroadcast policy introduced by this module.\r\n\r\nOk thanks, makes sense. Based on that I'm a Concept ACK, Approach ACK for this particular PR (and it sounds like @ariard isn't NACKing this PR either). Any future PR turning this module on by default will need a more rigorous discussion based on above considerations.",
      "created_at" : "2021-05-08T13:54:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-835373212",
      "id" : 835373212,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgzNTM3MzIxMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-08T13:54:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/835373212",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/16323900?v=4",
         "events_url" : "https://api.github.com/users/michaelfolkson/events{/privacy}",
         "followers_url" : "https://api.github.com/users/michaelfolkson/followers",
         "following_url" : "https://api.github.com/users/michaelfolkson/following{/other_user}",
         "gists_url" : "https://api.github.com/users/michaelfolkson/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/michaelfolkson",
         "id" : 16323900,
         "login" : "michaelfolkson",
         "node_id" : "MDQ6VXNlcjE2MzIzOTAw",
         "organizations_url" : "https://api.github.com/users/michaelfolkson/orgs",
         "received_events_url" : "https://api.github.com/users/michaelfolkson/received_events",
         "repos_url" : "https://api.github.com/users/michaelfolkson/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/michaelfolkson/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/michaelfolkson/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/michaelfolkson"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r628786207"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628786207"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> So IIUC, even if m_attempt_tracker is fulfilled with pinning transactions, it won't block node rebroadcast capability. \r\n\r\nyeah, exactly. \r\n\r\n> I would recommend to document this \"pinning-doesn't-block-rebroadcast-so-not-a-new-tx-relay jamming-vector\" around m_attempt_tracker declaration in src/txreconciliation.h, it's quite an important design aspect imo.\r\n\r\nI don't think it makes sense to document what data structures _don't_ do. \r\n\r\n> I should have precise this point...\r\n\r\nAh I understand now, thanks for clarifying. ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-08T19:17:09Z",
      "diff_hunk" : "@@ -0,0 +1,219 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r628786207",
      "id" : 628786207,
      "in_reply_to_id" : 615146994,
      "line" : 34,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyODc4NjIwNw==",
      "original_commit_id" : "d1bcb1d213ae380bbfce516a04c11a68864d3bbd",
      "original_line" : 34,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 34,
      "pull_request_review_id" : 655015796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-08T19:17:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628786207",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r628821403"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628821403"
         }
      },
      "author_association" : "MEMBER",
      "body" : "it seems like the majority of this comment is based on a misunderstanding of how `m_attempt_tracker` works. \r\n\r\nthe update seems like its getting on the right track- the main purpose of tracking rebroadcast entries is to allow enforcing a maximum number of rebroadcast attempts. \r\n\r\n> IIUC, the problem we're trying to solve is \"How to avoid never-going-to-be-mined transactions to forever ping-pong across the network ?\".\r\n\r\nyes, exactly.\r\n\r\nbut it still seems like there is remaining confusion. `MAX_ENTRY_AGE` indicates the amount of time has passed since tx A has been rebroadcast to peers. if its been 3 months since we last tried to rebroadcast tx A, we remove the attempts from the tracker. if there is no entry for tx A on the tracker, we don't have record of the fact that we tried to rebroadcast it, so if tx A is selected by the block assembler, we would rebroadcast it again. \r\n\r\nI don't see how `MAX_ENTRY_AGE` would viably be used for node fingerprinting when you combine with the other factors such as `filterInventoryKnown`. ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-09T02:14:06Z",
      "diff_hunk" : "@@ -0,0 +1,219 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE{24h * 30 * 3};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r628821403",
      "id" : 628821403,
      "in_reply_to_id" : 615156761,
      "line" : 37,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyODgyMTQwMw==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 37,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 37,
      "pull_request_review_id" : 655034454,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-09T02:14:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628821403",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r628821498"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628821498"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ok, going to resolve this conversation here in favor of the other comment thread. ",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-09T02:15:16Z",
      "diff_hunk" : "@@ -0,0 +1,219 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast 3/4 of max block weight to reduce noise due to circumstances\n+ *  such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE{24h * 30 * 3};\n+\n+struct RebroadcastEntry {\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\n+        : m_last_attempt(now_time),\n+          m_wtxid(wtxid) {}\n+\n+    std::chrono::microseconds m_last_attempt;\n+    const uint256 m_wtxid;\n+    int m_count{1};\n+};\n+\n+/** Used for multi_index tag  */\n+struct index_by_last_attempt {};\n+\n+class indexed_rebroadcast_set : public\n+boost::multi_index_container<\n+    RebroadcastEntry,\n+    boost::multi_index::indexed_by<\n+        // sorted by wtxid\n+        boost::multi_index::hashed_unique<\n+            boost::multi_index::tag<index_by_wtxid>,\n+            boost::multi_index::member<RebroadcastEntry, const uint256, &RebroadcastEntry::m_wtxid>,\n+            SaltedTxidHasher\n+        >,\n+        // sorted by last rebroadcast time\n+        boost::multi_index::ordered_non_unique<\n+            boost::multi_index::tag<index_by_last_attempt>,\n+            boost::multi_index::member<RebroadcastEntry, std::chrono::microseconds, &RebroadcastEntry::m_last_attempt>\n+        >\n+    >\n+>{};\n+\n+TxRebroadcastHandler::~TxRebroadcastHandler() = default;\n+\n+TxRebroadcastHandler::TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams)\n+    : m_mempool{mempool},\n+      m_chainman{chainman},\n+      m_chainparams(chainparams),\n+      m_attempt_tracker{std::make_unique<indexed_rebroadcast_set>()}{}\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions()\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    auto start_time = GetTime<std::chrono::microseconds>();\n+\n+    // If the cache has run since we received the last block, the fee rate\n+    // condition will not filter out any transactions, so skip this run.\n+    if (m_tip_at_cache_time == m_chainman.ActiveTip()) return rebroadcast_txs;\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = MAX_REBROADCAST_WEIGHT;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.m_check_block_validity = false;\n+    options.blockMinFeeRate = m_cached_fee_rate;\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_chainman.ActiveChainstate(), m_mempool, m_chainparams, options)\n+                              .CreateNewBlock(CScript());\n+    auto after_cnb_time = GetTime<std::chrono::microseconds>();\n+\n+    for (const CTransactionRef& tx : block_template->block.vtx) {\n+        if (tx->IsCoinBase()) continue;\n+\n+        uint256 txid = tx->GetHash();\n+        uint256 wtxid = tx->GetWitnessHash();\n+\n+        // Check if we have previously rebroadcasted, decide if we will this\n+        // round, and if so, record the attempt.\n+        auto entry_it = m_attempt_tracker->find(wtxid);\n+\n+        if (entry_it == m_attempt_tracker->end()) {\n+            // No existing entry, we will rebroadcast, so create a new one\n+            RebroadcastEntry entry(start_time, wtxid);\n+            m_attempt_tracker->insert(entry);\n+        } else if (entry_it->m_count >= MAX_REBROADCAST_COUNT) {\n+            // We have already rebroadcast this transaction the maximum number\n+            // of times permitted, so skip rebroadcasting.\n+            continue;\n+        } else if (entry_it->m_last_attempt > start_time - MIN_REATTEMPT_INTERVAL) {\n+            // We already rebroadcasted this in the past 4 hours. Even if we\n+            // added it to the set, it would probably not get INVed to most\n+            // peers due to filterInventoryKnown.\n+            continue;\n+        } else {\n+            // We have rebroadcasted this transaction before, but will try\n+            // again now. Record the attempt.\n+            auto UpdateRebroadcastEntry = [start_time](RebroadcastEntry& rebroadcast_entry) {\n+                rebroadcast_entry.m_last_attempt = start_time;\n+                ++rebroadcast_entry.m_count;\n+            };\n+\n+            m_attempt_tracker->modify(entry_it, UpdateRebroadcastEntry);\n+        }\n+\n+        // Add to set of rebroadcast candidates\n+        rebroadcast_txs.push_back(TxIds(txid, wtxid));\n+    }\n+\n+    TrimMaxRebroadcast();\n+\n+    auto delta1 = after_cnb_time - start_time;\n+    auto delta2 = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"GetRebroadcastTransactions(): %d us total, %d us spent in CreateNewBlock.\\n\", delta2.count(), delta1.count());\n+    LogPrint(BCLog::NET, \"Queued %d transactions for attempted rebroadcast, filtered from %d candidates with cached fee rate of %s.\\n\", rebroadcast_txs.size(), block_template->block.vtx.size() - 1, m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB));\n+\n+    for (TxIds ids : rebroadcast_txs) {\n+        LogPrint(BCLog::NET, \"Attempting to rebroadcast txid: %s, wtxid: %s\\n\", ids.m_txid.ToString(), ids.m_wtxid.ToString());\n+    }\n+\n+    return rebroadcast_txs;\n+};\n+\n+void TxRebroadcastHandler::CacheMinRebroadcastFee()\n+{\n+    if (m_chainman.ActiveChainstate().IsInitialBlockDownload()) return;\n+\n+    // Update stamp of chain tip on cache run\n+    m_tip_at_cache_time = m_chainman.ActiveTip();\n+\n+    // Update cache fee rate\n+    auto start_time = GetTime<std::chrono::microseconds>();\n+    m_cached_fee_rate = BlockAssembler(m_chainman.ActiveChainstate(), m_mempool, m_chainparams).MinTxFeeRate();\n+    auto delta_time = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"Caching minimum fee for rebroadcast to %s, took %d us to calculate.\\n\", m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB), delta_time.count());\n+};\n+\n+void TxRebroadcastHandler::RemoveFromAttemptTracker(const CTransactionRef& tx) {\n+    const auto it = m_attempt_tracker->find(tx->GetWitnessHash());\n+    if (it == m_attempt_tracker->end()) return;\n+    m_attempt_tracker->erase(it);\n+}\n+\n+void TxRebroadcastHandler::TrimMaxRebroadcast()\n+{\n+    // Delete any entries that are older than MAX_ENTRY_AGE\n+    auto min_age = GetTime<std::chrono::microseconds>() - MAX_ENTRY_AGE;\n+\n+    while (!m_attempt_tracker->empty()) {\n+        auto it = m_attempt_tracker->get<index_by_last_attempt>().begin();\n+        if (it->m_last_attempt < min_age) {\n+            m_attempt_tracker->get<index_by_last_attempt>().erase(it);\n+        } else {\n+            break;\n+        }\n+    }\n+\n+    // If there are still too many entries, delete the oldest ones",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r628821498",
      "id" : 628821498,
      "in_reply_to_id" : 615159376,
      "line" : 205,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyODgyMTQ5OA==",
      "original_commit_id" : "7ae2e385b69764bd381677a17183ee01ffc7f178",
      "original_line" : 205,
      "original_position" : 184,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 205,
      "pull_request_review_id" : 655034518,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-09T02:15:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/628821498",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r629292659"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/629292659"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Quick comment noticed while writing about this review club session. IIRC it's preferable to pass `uint256` by reference to const rather than by value, e.g. `const uint256& txid{tx->GetHash()};` or `const auto& txid = tx->GetHash();` (and here these aliases may as well be const anyway as IIUC they aren't intended to be mutated). It looks like there are a few other places.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-10T11:50:13Z",
      "diff_hunk" : "@@ -0,0 +1,242 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <node/blockstorage.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast upto 3/4 of max block weight to reduce noise due to\n+ * circumstances such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE{24h * 30 * 3};\n+\n+struct RebroadcastEntry {\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\n+        : m_last_attempt(now_time),\n+          m_wtxid(wtxid) {}\n+\n+    std::chrono::microseconds m_last_attempt;\n+    const uint256 m_wtxid;\n+    int m_count{1};\n+};\n+\n+/** Used for multi_index tag  */\n+struct index_by_last_attempt {};\n+\n+class indexed_rebroadcast_set : public\n+boost::multi_index_container<\n+    RebroadcastEntry,\n+    boost::multi_index::indexed_by<\n+        // sorted by wtxid\n+        boost::multi_index::hashed_unique<\n+            boost::multi_index::tag<index_by_wtxid>,\n+            boost::multi_index::member<RebroadcastEntry, const uint256, &RebroadcastEntry::m_wtxid>,\n+            SaltedTxidHasher\n+        >,\n+        // sorted by last rebroadcast time\n+        boost::multi_index::ordered_non_unique<\n+            boost::multi_index::tag<index_by_last_attempt>,\n+            boost::multi_index::member<RebroadcastEntry, std::chrono::microseconds, &RebroadcastEntry::m_last_attempt>\n+        >\n+    >\n+>{};\n+\n+TxRebroadcastHandler::~TxRebroadcastHandler() = default;\n+\n+TxRebroadcastHandler::TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams)\n+    : m_mempool{mempool},\n+      m_chainman{chainman},\n+      m_chainparams(chainparams),\n+      m_attempt_tracker{std::make_unique<indexed_rebroadcast_set>()}{}\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions(const CBlockIndex* recent_block_index)\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    auto start_time = GetTime<std::chrono::microseconds>();\n+\n+    int rebroadcast_block_weight = MAX_REBROADCAST_WEIGHT;\n+    CBlock block;\n+    const Consensus::Params& consensus_params = m_chainparams.GetConsensus();\n+    if (ReadBlockFromDisk(block, recent_block_index, consensus_params)) {\n+        rebroadcast_block_weight = 3 * GetBlockWeight(block) / 4;\n+    }\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = rebroadcast_block_weight;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.m_check_block_validity = false;\n+\n+    // The fee rate condition only filters out transactions if it runs before\n+    // we process the recently mined block. If the cache has since been\n+    // updated, used the value from the previous run to filter transactions.\n+    {\n+        LOCK(m_rebroadcast_mutex);\n+        if (m_tip_at_cache_time == m_chainman.ActiveTip()) {\n+            options.blockMinFeeRate = m_previous_cached_fee_rate;\n+        } else {\n+            options.blockMinFeeRate = m_cached_fee_rate;\n+        }\n+    }\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_chainman.ActiveChainstate(), m_mempool, m_chainparams, options)\n+                              .CreateNewBlock(CScript());\n+    auto after_cnb_time = GetTime<std::chrono::microseconds>();\n+\n+    LOCK(m_rebroadcast_mutex);\n+    for (const CTransactionRef& tx : block_template->block.vtx) {\n+        if (tx->IsCoinBase()) continue;\n+\n+        uint256 txid = tx->GetHash();\n+        uint256 wtxid = tx->GetWitnessHash();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r629292659",
      "id" : 629292659,
      "line" : 117,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTI5MjY1OQ==",
      "original_commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "original_line" : 117,
      "original_position" : 117,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 117,
      "pull_request_review_id" : 655550429,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-10T12:00:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/629292659",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r629805112"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/629805112"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In a3367b9b79086326f75d111d6b381088d88312f0 [p2p] Implement flag to disable rebroadcast \r\n\r\nShould this be in net_processing.h instead of net.h? It seems more like an application-layer thing.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-11T02:32:14Z",
      "diff_hunk" : "@@ -76,6 +76,8 @@ static const unsigned int DEFAULT_MAX_PEER_CONNECTIONS = 125;\n static constexpr uint64_t DEFAULT_MAX_UPLOAD_TARGET = 0;\n /** Default for blocks only*/\n static const bool DEFAULT_BLOCKSONLY = false;\n+/** Default for node rebroadcast logic */\n+static constexpr bool DEFAULT_REBROADCAST_ENABLED = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r629805112",
      "id" : 629805112,
      "line" : 80,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTgwNTExMg==",
      "original_commit_id" : "a3367b9b79086326f75d111d6b381088d88312f0",
      "original_line" : 80,
      "original_position" : 5,
      "original_start_line" : 79,
      "path" : "src/net.h",
      "position" : 5,
      "pull_request_review_id" : 656231133,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : 79,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-11T03:46:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/629805112",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r629809015"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/629809015"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Approach-related question about d72f030be9c9fa77e23132268e16708d7cbb192e  [mining] Calculate the minimum fee rate for transaction inclusion\r\n\r\nApologies if this has already been asked. Why is a new `BlockAssembler::MinTxFeeRate()` function created instead of using `CBlockPolicyEstimator::estimateSmartFee()` with a confirmation target of 1 block or some implementation built using the fee estimator? I'm not too familiar with how it works, but it seems like a very similar idea - get an estimation of what fee would be needed to make it into the next block.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-11T02:45:57Z",
      "diff_hunk" : "@@ -306,6 +306,29 @@ void BlockAssembler::SortForBlock(const CTxMemPool::setEntries& package, std::ve\n     std::sort(sortedEntries.begin(), sortedEntries.end(), CompareTxIterByAncestorCount());\n }\n \n+CFeeRate BlockAssembler::MinTxFeeRate()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r629809015",
      "id" : 629809015,
      "line" : 309,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTgwOTAxNQ==",
      "original_commit_id" : "d72f030be9c9fa77e23132268e16708d7cbb192e",
      "original_line" : 309,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/miner.cpp",
      "position" : 57,
      "pull_request_review_id" : 656231133,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-11T03:46:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/629809015",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r629812701"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/629812701"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In 956819c69de99db84908df0fb3b25ba616f2362d [rebroadcast] Apply a fee rate filter:\r\n\r\nWhat happens if our node has its own prioritized transactions, which could be returned by our own block assembler but miners wouldn't care about? I believe the block assembler uses modified feerate, so setting `blockMinFeeRate` here won't filter those out.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-11T02:58:16Z",
      "diff_hunk" : "@@ -33,6 +33,18 @@ std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions(const CBlock\n     options.m_skip_inclusion_until = GetTime<std::chrono::microseconds>() - REBROADCAST_MIN_TX_AGE;\n     options.m_check_block_validity = false;\n \n+    // The fee rate condition only filters out transactions if it runs before\n+    // we process the recently mined block. If the cache has since been\n+    // updated, used the value from the previous run to filter transactions.\n+    {\n+        LOCK(m_rebroadcast_mutex);\n+        if (m_tip_at_cache_time == m_chainman.ActiveTip()) {\n+            options.blockMinFeeRate = m_previous_cached_fee_rate;\n+        } else {\n+            options.blockMinFeeRate = m_cached_fee_rate;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r629812701",
      "id" : 629812701,
      "line" : 103,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTgxMjcwMQ==",
      "original_commit_id" : "956819c69de99db84908df0fb3b25ba616f2362d",
      "original_line" : 44,
      "original_position" : 12,
      "original_start_line" : 41,
      "path" : "src/txrebroadcast.cpp",
      "position" : 103,
      "pull_request_review_id" : 656231133,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : 100,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-11T03:46:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/629812701",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r629818366"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/629818366"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In 4165cb0606e4be476651899b80525f63f6e4465a [rebroadcast] Stop tracking rebroadcast attempts for certain transactions\r\n\r\nWould it be possible to write in a comment here \"we want to avoid a situation where two peers that are unaware of new policy/consensus rules endlessly rebroadcast a transaction considered invalid by the majority of the network. Thus, the rebroadcast attempt tracker should remember transactions even after they have expired from the mempool.\" or something along those lines? I just remember it being confusing what \"genuinely expire from majority of mempools\" meant and why we don't remove from the tracker when a tx expires from mempool.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-11T03:19:23Z",
      "diff_hunk" : "@@ -1308,9 +1309,37 @@ PeerManagerImpl::PeerManagerImpl(const CChainParams& chainparams, CConnman& conn\n }\n \n /**\n- * Evict orphan txn pool entries based on a newly connected\n- * block, remember the recently confirmed transactions, and delete tracked\n- * announcements for them. Also save the time of the last tip update.\n+ * If a transaction was removed from the mempool for a reason that entails it\n+ * most likely will not re-enter, let the rebroadcast handler know.\n+ */\n+void PeerManagerImpl::TransactionRemovedFromMempool(const CTransactionRef& tx, MemPoolRemovalReason reason, uint64_t mempool_sequence)\n+{\n+    if (!m_txrebroadcast) return;\n+\n+    switch(reason) {\n+        case MemPoolRemovalReason::BLOCK:\n+            // Although transactions removed for this reason will not be\n+            // returned by this callback, include it here so the compiler\n+            // can warn about missing cases in this switch statement.\n+            // These transactions are handled by BlockConnected.\n+            break;\n+        case MemPoolRemovalReason::EXPIRY:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r629818366",
      "id" : 629818366,
      "line" : 1326,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTgxODM2Ng==",
      "original_commit_id" : "4165cb0606e4be476651899b80525f63f6e4465a",
      "original_line" : 1326,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 88,
      "pull_request_review_id" : 656231133,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-11T03:46:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/629818366",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r629819928"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/629819928"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In 4165cb0606e4be476651899b80525f63f6e4465a [rebroadcast] Stop tracking rebroadcast attempts for certain transactions\r\n\r\nWhy not group `MemPoolRemovalReason::BLOCK` with the cases that we call `RemoveFromAttemptTracker()` for (while keeping the comment indicating that they don't go through this callback)?",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-11T03:24:51Z",
      "diff_hunk" : "@@ -1308,9 +1309,37 @@ PeerManagerImpl::PeerManagerImpl(const CChainParams& chainparams, CConnman& conn\n }\n \n /**\n- * Evict orphan txn pool entries based on a newly connected\n- * block, remember the recently confirmed transactions, and delete tracked\n- * announcements for them. Also save the time of the last tip update.\n+ * If a transaction was removed from the mempool for a reason that entails it\n+ * most likely will not re-enter, let the rebroadcast handler know.\n+ */\n+void PeerManagerImpl::TransactionRemovedFromMempool(const CTransactionRef& tx, MemPoolRemovalReason reason, uint64_t mempool_sequence)\n+{\n+    if (!m_txrebroadcast) return;\n+\n+    switch(reason) {\n+        case MemPoolRemovalReason::BLOCK:\n+            // Although transactions removed for this reason will not be\n+            // returned by this callback, include it here so the compiler\n+            // can warn about missing cases in this switch statement.\n+            // These transactions are handled by BlockConnected.\n+            break;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r629819928",
      "id" : 629819928,
      "line" : 1325,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTgxOTkyOA==",
      "original_commit_id" : "4165cb0606e4be476651899b80525f63f6e4465a",
      "original_line" : 1325,
      "original_position" : 28,
      "original_start_line" : 1320,
      "path" : "src/net_processing.cpp",
      "position" : 87,
      "pull_request_review_id" : 656231133,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : 1320,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-11T03:46:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/629819928",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r629820715"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/629820715"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n * - Delete tracked rebroadcast attempts for block transactions\r\n```",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-11T03:27:56Z",
      "diff_hunk" : "@@ -1308,9 +1309,37 @@ PeerManagerImpl::PeerManagerImpl(const CChainParams& chainparams, CConnman& conn\n }\n \n /**\n- * Evict orphan txn pool entries based on a newly connected\n- * block, remember the recently confirmed transactions, and delete tracked\n- * announcements for them. Also save the time of the last tip update.\n+ * If a transaction was removed from the mempool for a reason that entails it\n+ * most likely will not re-enter, let the rebroadcast handler know.\n+ */\n+void PeerManagerImpl::TransactionRemovedFromMempool(const CTransactionRef& tx, MemPoolRemovalReason reason, uint64_t mempool_sequence)\n+{\n+    if (!m_txrebroadcast) return;\n+\n+    switch(reason) {\n+        case MemPoolRemovalReason::BLOCK:\n+            // Although transactions removed for this reason will not be\n+            // returned by this callback, include it here so the compiler\n+            // can warn about missing cases in this switch statement.\n+            // These transactions are handled by BlockConnected.\n+            break;\n+        case MemPoolRemovalReason::EXPIRY:\n+        case MemPoolRemovalReason::SIZELIMIT:\n+            break;\n+        case MemPoolRemovalReason::REORG:\n+        case MemPoolRemovalReason::CONFLICT:\n+        case MemPoolRemovalReason::REPLACED:\n+            m_txrebroadcast->RemoveFromAttemptTracker(tx);\n+    } // No default case, so the compiler can warn about missing cases\n+}\n+\n+/**\n+ * Update state based on a newly connected block:\n+ * - Evict orphan txn pool entries\n+ * - Save the time of the last tip update\n+ * - Remember recently confirmed transactions\n+ * - Delete tracked announcements for block transactions\n+ * - Delete tracked rebroadcast attempts",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r629820715",
      "id" : 629820715,
      "line" : 1342,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTgyMDcxNQ==",
      "original_commit_id" : "4165cb0606e4be476651899b80525f63f6e4465a",
      "original_line" : 1342,
      "original_position" : 45,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 104,
      "pull_request_review_id" : 656231133,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-11T03:46:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/629820715",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r629823940"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/629823940"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In 0ae1420767a320cfeafd2acee0b54bc6a6eb9b27 [test] Add unit test for the fee rate cache \r\n\r\nWhy note just use + REBROADCAST_MIN_TX_AGE + 5 minutes here?",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-11T03:39:41Z",
      "diff_hunk" : "@@ -57,6 +57,48 @@ BOOST_AUTO_TEST_CASE(recency)\n     BOOST_CHECK_EQUAL(candidates.front().m_txid, tx_old.GetHash());\n }\n \n+BOOST_AUTO_TEST_CASE(fee_rate)\n+{\n+    // Since the test chain comes with 100 blocks, the first coinbase is\n+    // already valid to spend. Generate another block to have two valid\n+    // coinbase inputs to spend.\n+    CreateAndProcessBlock(std::vector<CMutableTransaction>(), CScript());\n+\n+    // Instantiate rebroadcast module & mine a block, so when we run\n+    // GetRebroadcastTransactions, Chain tip will be beyond m_tip_at_cache_time\n+    const auto chain_params = CreateChainParams(*m_node.args, CBaseChainParams::MAIN);\n+    TxRebroadcastHandler tx_rebroadcast(*m_node.mempool, *m_node.chainman, *chain_params);\n+    CBlock recent_block = CreateAndProcessBlock(std::vector<CMutableTransaction>(), CScript());\n+    CBlockIndex recent_block_index{recent_block.GetBlockHeader()};\n+\n+    // Update m_cached_fee_rate\n+    // The transactions created in this test are each 157 bytes, and they set\n+    // the fee at 1 BTC and 2 BTC.\n+    CFeeRate cached_fee_rate(1.5 * COIN, 157);\n+    tx_rebroadcast.UpdateCachedFeeRate(cached_fee_rate);\n+\n+    // Create two transactions\n+    CKey key;\n+    key.MakeNewKey(true);\n+    CScript output_destination = GetScriptForDestination(PKHash(key.GetPubKey()));\n+\n+    // - One with a low fee rate\n+    CMutableTransaction tx_low = CreateValidMempoolTransaction(m_coinbase_txns[0], /* vout */ 0, /* input_height */ 0, coinbaseKey, output_destination, CAmount(49 * COIN));\n+    // - One with a high fee rate\n+    CMutableTransaction tx_high = CreateValidMempoolTransaction(m_coinbase_txns[1], /* vout */ 0, /* input_height */ 1, coinbaseKey, output_destination, CAmount(48 * COIN));\n+\n+    // Confirm both transactions successfully made it into the mempool\n+    BOOST_CHECK_EQUAL(m_node.mempool->size(), 2);\n+\n+    // Age transaction to be older than REBROADCAST_MIN_TX_AGE\n+    SetMockTime(GetTime<std::chrono::seconds>() + 35min);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r629823940",
      "id" : 629823940,
      "line" : 94,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTgyMzk0MA==",
      "original_commit_id" : "0ae1420767a320cfeafd2acee0b54bc6a6eb9b27",
      "original_line" : 94,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/test/txrebroadcast_tests.cpp",
      "position" : 94,
      "pull_request_review_id" : 656231133,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-11T03:46:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/629823940",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r629824222"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/629824222"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In 0ae1420767a320cfeafd2acee0b54bc6a6eb9b27 [test] Add unit test for the fee rate cache \r\n\r\nWould be nice if the test also checked what happens with transactions that are prioritized.",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-11T03:40:41Z",
      "diff_hunk" : "@@ -57,6 +57,48 @@ BOOST_AUTO_TEST_CASE(recency)\n     BOOST_CHECK_EQUAL(candidates.front().m_txid, tx_old.GetHash());\n }\n \n+BOOST_AUTO_TEST_CASE(fee_rate)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r629824222",
      "id" : 629824222,
      "line" : 60,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTgyNDIyMg==",
      "original_commit_id" : "0ae1420767a320cfeafd2acee0b54bc6a6eb9b27",
      "original_line" : 60,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/test/txrebroadcast_tests.cpp",
      "position" : 60,
      "pull_request_review_id" : 656231133,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-11T03:46:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/629824222",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r629825081"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/629825081"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In 87d6466380737c2d05932d4af3879950982e61c4 [test] Add unit test for rebroadcast attempt logic \r\n\r\nI'm not sure what difference it would make, but why don't these require `m_rebroadcast_mutex` instead of doing the locking internally?",
      "commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "created_at" : "2021-05-11T03:43:43Z",
      "diff_hunk" : "@@ -41,13 +41,19 @@ class TxRebroadcastHandler\n     /** Remove transaction entry from the attempt tracker.*/\n     void RemoveFromAttemptTracker(const CTransactionRef& tx);\n \n+    /** Test only */\n+    void UpdateAttempt(const uint256& wtxid, const int count, const std::chrono::microseconds last_attempt_time);\n+\n+    /** Test only */\n+    bool CheckRecordedAttempt(const uint256& wtxid, const int expected_count, const std::chrono::microseconds expected_timestamp) const;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r629825081",
      "id" : 629825081,
      "line" : 48,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyOTgyNTA4MQ==",
      "original_commit_id" : "87d6466380737c2d05932d4af3879950982e61c4",
      "original_line" : 48,
      "original_position" : 8,
      "original_start_line" : 45,
      "path" : "src/txrebroadcast.h",
      "position" : 48,
      "pull_request_review_id" : 656231133,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : 45,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-11T03:46:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/629825081",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631543314"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631543314"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yeah, I went through a similar thought process. In the initial pass, I opted for the `ReadBlockFromDisk` approach because it seemed simpler. But in the latest push, I updated the `UpdateBlockTip` function signature to also take in `block`. Unfortunately, it seems like callers cannot rely on `block` to be properly populated, so I still need to have the `ReadBlockFromDisk` as a fallback. The relevant code is in 33eb966d284bd954af16ed5905315e0bc91c3662 & 33eb966d284bd954af16ed5905315e0bc91c3662, let me know what you think.",
      "commit_id" : "a71810a4856c24617a15c550a2ed7462a9b95627",
      "created_at" : "2021-05-13T03:51:25Z",
      "diff_hunk" : "@@ -0,0 +1,242 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <node/blockstorage.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast upto 3/4 of max block weight to reduce noise due to\n+ * circumstances such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE{24h * 30 * 3};\n+\n+struct RebroadcastEntry {\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\n+        : m_last_attempt(now_time),\n+          m_wtxid(wtxid) {}\n+\n+    std::chrono::microseconds m_last_attempt;\n+    const uint256 m_wtxid;\n+    int m_count{1};\n+};\n+\n+/** Used for multi_index tag  */\n+struct index_by_last_attempt {};\n+\n+class indexed_rebroadcast_set : public\n+boost::multi_index_container<\n+    RebroadcastEntry,\n+    boost::multi_index::indexed_by<\n+        // sorted by wtxid\n+        boost::multi_index::hashed_unique<\n+            boost::multi_index::tag<index_by_wtxid>,\n+            boost::multi_index::member<RebroadcastEntry, const uint256, &RebroadcastEntry::m_wtxid>,\n+            SaltedTxidHasher\n+        >,\n+        // sorted by last rebroadcast time\n+        boost::multi_index::ordered_non_unique<\n+            boost::multi_index::tag<index_by_last_attempt>,\n+            boost::multi_index::member<RebroadcastEntry, std::chrono::microseconds, &RebroadcastEntry::m_last_attempt>\n+        >\n+    >\n+>{};\n+\n+TxRebroadcastHandler::~TxRebroadcastHandler() = default;\n+\n+TxRebroadcastHandler::TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams)\n+    : m_mempool{mempool},\n+      m_chainman{chainman},\n+      m_chainparams(chainparams),\n+      m_attempt_tracker{std::make_unique<indexed_rebroadcast_set>()}{}\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions(const CBlockIndex* recent_block_index)\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    auto start_time = GetTime<std::chrono::microseconds>();\n+\n+    int rebroadcast_block_weight = MAX_REBROADCAST_WEIGHT;\n+    CBlock block;\n+    const Consensus::Params& consensus_params = m_chainparams.GetConsensus();\n+    if (ReadBlockFromDisk(block, recent_block_index, consensus_params)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631543314",
      "id" : 631543314,
      "in_reply_to_id" : 628043830,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTU0MzMxNA==",
      "original_commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "original_line" : 86,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 658559408,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-13T03:51:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631543314",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631543511"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631543511"
         }
      },
      "author_association" : "MEMBER",
      "body" : "very nice, done ",
      "commit_id" : "a71810a4856c24617a15c550a2ed7462a9b95627",
      "created_at" : "2021-05-13T03:52:07Z",
      "diff_hunk" : "@@ -1286,22 +1289,57 @@ PeerManagerImpl::PeerManagerImpl(const CChainParams& chainparams, CConnman& conn\n     // same probability that we have in the reject filter).\n     m_recent_confirmed_transactions.reset(new CRollingBloomFilter(48000, 0.000001));\n \n+    if (enable_rebroadcast) {\n+        m_txrebroadcast = std::make_unique<TxRebroadcastHandler>(m_mempool, m_chainman, m_chainparams);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631543511",
      "id" : 631543511,
      "in_reply_to_id" : 628053757,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTU0MzUxMQ==",
      "original_commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "original_line" : 1293,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 658559613,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-13T03:52:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631543511",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631543597"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631543597"
         }
      },
      "author_association" : "MEMBER",
      "body" : "agree, removed.",
      "commit_id" : "a71810a4856c24617a15c550a2ed7462a9b95627",
      "created_at" : "2021-05-13T03:52:27Z",
      "diff_hunk" : "@@ -1286,22 +1289,57 @@ PeerManagerImpl::PeerManagerImpl(const CChainParams& chainparams, CConnman& conn\n     // same probability that we have in the reject filter).\n     m_recent_confirmed_transactions.reset(new CRollingBloomFilter(48000, 0.000001));\n \n+    if (enable_rebroadcast) {\n+        m_txrebroadcast = std::make_unique<TxRebroadcastHandler>(m_mempool, m_chainman, m_chainparams);\n+\n+        // Run fee rate cache every minute",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631543597",
      "id" : 631543597,
      "in_reply_to_id" : 628054781,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTU0MzU5Nw==",
      "original_commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "original_line" : 1295,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 658559707,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-13T03:52:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631543597",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631543989"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631543989"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yeah, that would be nice! I don't think it makes sense to increase the complexity of this PR, but I have noted it down as potential future work.",
      "commit_id" : "a71810a4856c24617a15c550a2ed7462a9b95627",
      "created_at" : "2021-05-13T03:54:02Z",
      "diff_hunk" : "@@ -0,0 +1,242 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <node/blockstorage.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast upto 3/4 of max block weight to reduce noise due to\n+ * circumstances such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE{24h * 30 * 3};\n+\n+struct RebroadcastEntry {\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\n+        : m_last_attempt(now_time),\n+          m_wtxid(wtxid) {}\n+\n+    std::chrono::microseconds m_last_attempt;\n+    const uint256 m_wtxid;\n+    int m_count{1};\n+};\n+\n+/** Used for multi_index tag  */\n+struct index_by_last_attempt {};\n+\n+class indexed_rebroadcast_set : public\n+boost::multi_index_container<\n+    RebroadcastEntry,\n+    boost::multi_index::indexed_by<\n+        // sorted by wtxid\n+        boost::multi_index::hashed_unique<\n+            boost::multi_index::tag<index_by_wtxid>,\n+            boost::multi_index::member<RebroadcastEntry, const uint256, &RebroadcastEntry::m_wtxid>,\n+            SaltedTxidHasher\n+        >,\n+        // sorted by last rebroadcast time\n+        boost::multi_index::ordered_non_unique<\n+            boost::multi_index::tag<index_by_last_attempt>,\n+            boost::multi_index::member<RebroadcastEntry, std::chrono::microseconds, &RebroadcastEntry::m_last_attempt>\n+        >\n+    >\n+>{};\n+\n+TxRebroadcastHandler::~TxRebroadcastHandler() = default;\n+\n+TxRebroadcastHandler::TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams)\n+    : m_mempool{mempool},\n+      m_chainman{chainman},\n+      m_chainparams(chainparams),\n+      m_attempt_tracker{std::make_unique<indexed_rebroadcast_set>()}{}\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions(const CBlockIndex* recent_block_index)\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    auto start_time = GetTime<std::chrono::microseconds>();\n+\n+    int rebroadcast_block_weight = MAX_REBROADCAST_WEIGHT;\n+    CBlock block;\n+    const Consensus::Params& consensus_params = m_chainparams.GetConsensus();\n+    if (ReadBlockFromDisk(block, recent_block_index, consensus_params)) {\n+        rebroadcast_block_weight = 3 * GetBlockWeight(block) / 4;\n+    }\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = rebroadcast_block_weight;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.m_check_block_validity = false;\n+\n+    // The fee rate condition only filters out transactions if it runs before\n+    // we process the recently mined block. If the cache has since been\n+    // updated, used the value from the previous run to filter transactions.\n+    {\n+        LOCK(m_rebroadcast_mutex);\n+        if (m_tip_at_cache_time == m_chainman.ActiveTip()) {\n+            options.blockMinFeeRate = m_previous_cached_fee_rate;\n+        } else {\n+            options.blockMinFeeRate = m_cached_fee_rate;\n+        }\n+    }\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_chainman.ActiveChainstate(), m_mempool, m_chainparams, options)\n+                              .CreateNewBlock(CScript());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631543989",
      "id" : 631543989,
      "in_reply_to_id" : 628060392,
      "line" : 118,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTU0Mzk4OQ==",
      "original_commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "original_line" : 118,
      "original_position" : 109,
      "original_start_line" : 108,
      "path" : "src/txrebroadcast.cpp",
      "position" : 118,
      "pull_request_review_id" : 658560139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : 117,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-13T03:54:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631543989",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631544094"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631544094"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "a71810a4856c24617a15c550a2ed7462a9b95627",
      "created_at" : "2021-05-13T03:54:23Z",
      "diff_hunk" : "@@ -0,0 +1,242 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <node/blockstorage.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast upto 3/4 of max block weight to reduce noise due to\n+ * circumstances such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE{24h * 30 * 3};\n+\n+struct RebroadcastEntry {\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\n+        : m_last_attempt(now_time),\n+          m_wtxid(wtxid) {}\n+\n+    std::chrono::microseconds m_last_attempt;\n+    const uint256 m_wtxid;\n+    int m_count{1};\n+};\n+\n+/** Used for multi_index tag  */\n+struct index_by_last_attempt {};\n+\n+class indexed_rebroadcast_set : public\n+boost::multi_index_container<\n+    RebroadcastEntry,\n+    boost::multi_index::indexed_by<\n+        // sorted by wtxid\n+        boost::multi_index::hashed_unique<\n+            boost::multi_index::tag<index_by_wtxid>,\n+            boost::multi_index::member<RebroadcastEntry, const uint256, &RebroadcastEntry::m_wtxid>,\n+            SaltedTxidHasher\n+        >,\n+        // sorted by last rebroadcast time\n+        boost::multi_index::ordered_non_unique<\n+            boost::multi_index::tag<index_by_last_attempt>,\n+            boost::multi_index::member<RebroadcastEntry, std::chrono::microseconds, &RebroadcastEntry::m_last_attempt>\n+        >\n+    >\n+>{};\n+\n+TxRebroadcastHandler::~TxRebroadcastHandler() = default;\n+\n+TxRebroadcastHandler::TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams)\n+    : m_mempool{mempool},\n+      m_chainman{chainman},\n+      m_chainparams(chainparams),\n+      m_attempt_tracker{std::make_unique<indexed_rebroadcast_set>()}{}\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions(const CBlockIndex* recent_block_index)\n+{\n+    std::vector<TxIds> rebroadcast_txs;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631544094",
      "id" : 631544094,
      "in_reply_to_id" : 628064681,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTU0NDA5NA==",
      "original_commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "original_line" : 80,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 658560232,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-13T03:54:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631544094",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631544292"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631544292"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "a71810a4856c24617a15c550a2ed7462a9b95627",
      "created_at" : "2021-05-13T03:55:01Z",
      "diff_hunk" : "@@ -0,0 +1,92 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TXREBROADCAST_H\n+#define BITCOIN_TXREBROADCAST_H\n+\n+#include <policy/feerate.h>\n+#include <txmempool.h>\n+#include <validation.h>\n+\n+/** Frequency to run the fee rate cache. */\n+constexpr std::chrono::minutes REBROADCAST_CACHE_FREQUENCY{1};\n+\n+struct TxIds {\n+    TxIds(uint256 txid, uint256 wtxid) : m_txid(txid), m_wtxid(wtxid) {}\n+\n+    const uint256 m_txid;\n+    const uint256 m_wtxid;\n+};\n+\n+class indexed_rebroadcast_set;\n+\n+class TxRebroadcastHandler\n+{\n+public:\n+    TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams);\n+    ~TxRebroadcastHandler();\n+\n+    TxRebroadcastHandler(const TxRebroadcastHandler& other) = delete;\n+    TxRebroadcastHandler& operator=(const TxRebroadcastHandler& other) = delete;\n+\n+    std::vector<TxIds> GetRebroadcastTransactions(const CBlockIndex* recent_block_index);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631544292",
      "id" : 631544292,
      "in_reply_to_id" : 628084018,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTU0NDI5Mg==",
      "original_commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "original_line" : 33,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.h",
      "position" : null,
      "pull_request_review_id" : 658560431,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-13T03:55:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631544292",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631544648"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631544648"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done ",
      "commit_id" : "a71810a4856c24617a15c550a2ed7462a9b95627",
      "created_at" : "2021-05-13T03:56:16Z",
      "diff_hunk" : "@@ -0,0 +1,242 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <node/blockstorage.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast upto 3/4 of max block weight to reduce noise due to\n+ * circumstances such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE{24h * 30 * 3};\n+\n+struct RebroadcastEntry {\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\n+        : m_last_attempt(now_time),\n+          m_wtxid(wtxid) {}\n+\n+    std::chrono::microseconds m_last_attempt;\n+    const uint256 m_wtxid;\n+    int m_count{1};\n+};\n+\n+/** Used for multi_index tag  */\n+struct index_by_last_attempt {};\n+\n+class indexed_rebroadcast_set : public\n+boost::multi_index_container<\n+    RebroadcastEntry,\n+    boost::multi_index::indexed_by<\n+        // sorted by wtxid\n+        boost::multi_index::hashed_unique<\n+            boost::multi_index::tag<index_by_wtxid>,\n+            boost::multi_index::member<RebroadcastEntry, const uint256, &RebroadcastEntry::m_wtxid>,\n+            SaltedTxidHasher\n+        >,\n+        // sorted by last rebroadcast time\n+        boost::multi_index::ordered_non_unique<\n+            boost::multi_index::tag<index_by_last_attempt>,\n+            boost::multi_index::member<RebroadcastEntry, std::chrono::microseconds, &RebroadcastEntry::m_last_attempt>\n+        >\n+    >\n+>{};\n+\n+TxRebroadcastHandler::~TxRebroadcastHandler() = default;\n+\n+TxRebroadcastHandler::TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams)\n+    : m_mempool{mempool},\n+      m_chainman{chainman},\n+      m_chainparams(chainparams),\n+      m_attempt_tracker{std::make_unique<indexed_rebroadcast_set>()}{}\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions(const CBlockIndex* recent_block_index)\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    auto start_time = GetTime<std::chrono::microseconds>();\n+\n+    int rebroadcast_block_weight = MAX_REBROADCAST_WEIGHT;\n+    CBlock block;\n+    const Consensus::Params& consensus_params = m_chainparams.GetConsensus();\n+    if (ReadBlockFromDisk(block, recent_block_index, consensus_params)) {\n+        rebroadcast_block_weight = 3 * GetBlockWeight(block) / 4;\n+    }\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = rebroadcast_block_weight;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.m_check_block_validity = false;\n+\n+    // The fee rate condition only filters out transactions if it runs before\n+    // we process the recently mined block. If the cache has since been\n+    // updated, used the value from the previous run to filter transactions.\n+    {\n+        LOCK(m_rebroadcast_mutex);\n+        if (m_tip_at_cache_time == m_chainman.ActiveTip()) {\n+            options.blockMinFeeRate = m_previous_cached_fee_rate;\n+        } else {\n+            options.blockMinFeeRate = m_cached_fee_rate;\n+        }\n+    }\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_chainman.ActiveChainstate(), m_mempool, m_chainparams, options)\n+                              .CreateNewBlock(CScript());\n+    auto after_cnb_time = GetTime<std::chrono::microseconds>();\n+\n+    LOCK(m_rebroadcast_mutex);\n+    for (const CTransactionRef& tx : block_template->block.vtx) {\n+        if (tx->IsCoinBase()) continue;\n+\n+        uint256 txid = tx->GetHash();\n+        uint256 wtxid = tx->GetWitnessHash();\n+\n+        // Check if we have previously rebroadcasted, decide if we will this\n+        // round, and if so, record the attempt.\n+        auto entry_it = m_attempt_tracker->find(wtxid);\n+\n+        if (entry_it == m_attempt_tracker->end()) {\n+            // No existing entry, we will rebroadcast, so create a new one\n+            RebroadcastEntry entry(start_time, wtxid);\n+            m_attempt_tracker->insert(entry);\n+        } else if (entry_it->m_count >= MAX_REBROADCAST_COUNT) {\n+            // We have already rebroadcast this transaction the maximum number\n+            // of times permitted, so skip rebroadcasting.\n+            continue;\n+        } else if (entry_it->m_last_attempt > start_time - MIN_REATTEMPT_INTERVAL) {\n+            // We already rebroadcasted this in the past 4 hours. Even if we\n+            // added it to the set, it would probably not get INVed to most\n+            // peers due to filterInventoryKnown.\n+            continue;\n+        } else {\n+            // We have rebroadcasted this transaction before, but will try\n+            // again now. Record the attempt.\n+            auto UpdateRebroadcastEntry = [start_time](RebroadcastEntry& rebroadcast_entry) {\n+                rebroadcast_entry.m_last_attempt = start_time;\n+                ++rebroadcast_entry.m_count;\n+            };\n+\n+            m_attempt_tracker->modify(entry_it, UpdateRebroadcastEntry);\n+        }\n+\n+        // Add to set of rebroadcast candidates\n+        rebroadcast_txs.push_back(TxIds(txid, wtxid));\n+    }\n+\n+    TrimMaxRebroadcast();\n+\n+    auto delta1 = after_cnb_time - start_time;\n+    auto delta2 = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"GetRebroadcastTransactions(): %d us total, %d us spent in CreateNewBlock.\\n\", delta2.count(), delta1.count());\n+    LogPrint(BCLog::NET, \"Queued %d transactions for attempted rebroadcast, filtered from %d candidates with cached fee rate of %s.\\n\", rebroadcast_txs.size(), block_template->block.vtx.size() - 1, m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB));\n+\n+    for (TxIds ids : rebroadcast_txs) {\n+        LogPrint(BCLog::NET, \"Attempting to rebroadcast txid: %s, wtxid: %s\\n\", ids.m_txid.ToString(), ids.m_wtxid.ToString());\n+    }\n+\n+    return rebroadcast_txs;\n+};\n+\n+void TxRebroadcastHandler::CacheMinRebroadcastFee()\n+{\n+    if (m_chainman.ActiveChainstate().IsInitialBlockDownload()) return;\n+\n+    LOCK(m_rebroadcast_mutex);\n+\n+    // Update stamp of chain tip on cache run\n+    m_tip_at_cache_time = m_chainman.ActiveTip();\n+\n+    // Store the existing fee rate\n+    m_previous_cached_fee_rate = m_cached_fee_rate;\n+\n+    // Calculate a new cached fee rate\n+    auto start_time = GetTime<std::chrono::microseconds>();\n+    m_cached_fee_rate = BlockAssembler(m_chainman.ActiveChainstate(), m_mempool, m_chainparams).MinTxFeeRate();\n+    auto delta_time = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"Caching minimum fee for rebroadcast to %s, took %d us to calculate.\\n\", m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB), delta_time.count());\n+};\n+\n+void TxRebroadcastHandler::RemoveFromAttemptTracker(const CTransactionRef& tx) {\n+    LOCK(m_rebroadcast_mutex);\n+    const auto it = m_attempt_tracker->find(tx->GetWitnessHash());\n+    if (it == m_attempt_tracker->end()) return;\n+    m_attempt_tracker->erase(it);\n+}\n+\n+void TxRebroadcastHandler::TrimMaxRebroadcast()\n+{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631544648",
      "id" : 631544648,
      "in_reply_to_id" : 628097324,
      "line" : 202,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTU0NDY0OA==",
      "original_commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "original_line" : 202,
      "original_position" : 192,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 202,
      "pull_request_review_id" : 658560861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-13T03:56:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631544648",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631545127"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631545127"
         }
      },
      "author_association" : "MEMBER",
      "body" : "good point on consolidating the two loops. the code you shared doesn't quite make sense (it no longer erases anything from the attempt tracker? ð), but I got the gist and reworked the logic. ",
      "commit_id" : "a71810a4856c24617a15c550a2ed7462a9b95627",
      "created_at" : "2021-05-13T03:58:09Z",
      "diff_hunk" : "@@ -0,0 +1,242 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <node/blockstorage.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast upto 3/4 of max block weight to reduce noise due to\n+ * circumstances such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE{24h * 30 * 3};\n+\n+struct RebroadcastEntry {\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\n+        : m_last_attempt(now_time),\n+          m_wtxid(wtxid) {}\n+\n+    std::chrono::microseconds m_last_attempt;\n+    const uint256 m_wtxid;\n+    int m_count{1};\n+};\n+\n+/** Used for multi_index tag  */\n+struct index_by_last_attempt {};\n+\n+class indexed_rebroadcast_set : public\n+boost::multi_index_container<\n+    RebroadcastEntry,\n+    boost::multi_index::indexed_by<\n+        // sorted by wtxid\n+        boost::multi_index::hashed_unique<\n+            boost::multi_index::tag<index_by_wtxid>,\n+            boost::multi_index::member<RebroadcastEntry, const uint256, &RebroadcastEntry::m_wtxid>,\n+            SaltedTxidHasher\n+        >,\n+        // sorted by last rebroadcast time\n+        boost::multi_index::ordered_non_unique<\n+            boost::multi_index::tag<index_by_last_attempt>,\n+            boost::multi_index::member<RebroadcastEntry, std::chrono::microseconds, &RebroadcastEntry::m_last_attempt>\n+        >\n+    >\n+>{};\n+\n+TxRebroadcastHandler::~TxRebroadcastHandler() = default;\n+\n+TxRebroadcastHandler::TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams)\n+    : m_mempool{mempool},\n+      m_chainman{chainman},\n+      m_chainparams(chainparams),\n+      m_attempt_tracker{std::make_unique<indexed_rebroadcast_set>()}{}\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions(const CBlockIndex* recent_block_index)\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    auto start_time = GetTime<std::chrono::microseconds>();\n+\n+    int rebroadcast_block_weight = MAX_REBROADCAST_WEIGHT;\n+    CBlock block;\n+    const Consensus::Params& consensus_params = m_chainparams.GetConsensus();\n+    if (ReadBlockFromDisk(block, recent_block_index, consensus_params)) {\n+        rebroadcast_block_weight = 3 * GetBlockWeight(block) / 4;\n+    }\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = rebroadcast_block_weight;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.m_check_block_validity = false;\n+\n+    // The fee rate condition only filters out transactions if it runs before\n+    // we process the recently mined block. If the cache has since been\n+    // updated, used the value from the previous run to filter transactions.\n+    {\n+        LOCK(m_rebroadcast_mutex);\n+        if (m_tip_at_cache_time == m_chainman.ActiveTip()) {\n+            options.blockMinFeeRate = m_previous_cached_fee_rate;\n+        } else {\n+            options.blockMinFeeRate = m_cached_fee_rate;\n+        }\n+    }\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_chainman.ActiveChainstate(), m_mempool, m_chainparams, options)\n+                              .CreateNewBlock(CScript());\n+    auto after_cnb_time = GetTime<std::chrono::microseconds>();\n+\n+    LOCK(m_rebroadcast_mutex);\n+    for (const CTransactionRef& tx : block_template->block.vtx) {\n+        if (tx->IsCoinBase()) continue;\n+\n+        uint256 txid = tx->GetHash();\n+        uint256 wtxid = tx->GetWitnessHash();\n+\n+        // Check if we have previously rebroadcasted, decide if we will this\n+        // round, and if so, record the attempt.\n+        auto entry_it = m_attempt_tracker->find(wtxid);\n+\n+        if (entry_it == m_attempt_tracker->end()) {\n+            // No existing entry, we will rebroadcast, so create a new one\n+            RebroadcastEntry entry(start_time, wtxid);\n+            m_attempt_tracker->insert(entry);\n+        } else if (entry_it->m_count >= MAX_REBROADCAST_COUNT) {\n+            // We have already rebroadcast this transaction the maximum number\n+            // of times permitted, so skip rebroadcasting.\n+            continue;\n+        } else if (entry_it->m_last_attempt > start_time - MIN_REATTEMPT_INTERVAL) {\n+            // We already rebroadcasted this in the past 4 hours. Even if we\n+            // added it to the set, it would probably not get INVed to most\n+            // peers due to filterInventoryKnown.\n+            continue;\n+        } else {\n+            // We have rebroadcasted this transaction before, but will try\n+            // again now. Record the attempt.\n+            auto UpdateRebroadcastEntry = [start_time](RebroadcastEntry& rebroadcast_entry) {\n+                rebroadcast_entry.m_last_attempt = start_time;\n+                ++rebroadcast_entry.m_count;\n+            };\n+\n+            m_attempt_tracker->modify(entry_it, UpdateRebroadcastEntry);\n+        }\n+\n+        // Add to set of rebroadcast candidates\n+        rebroadcast_txs.push_back(TxIds(txid, wtxid));\n+    }\n+\n+    TrimMaxRebroadcast();\n+\n+    auto delta1 = after_cnb_time - start_time;\n+    auto delta2 = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"GetRebroadcastTransactions(): %d us total, %d us spent in CreateNewBlock.\\n\", delta2.count(), delta1.count());\n+    LogPrint(BCLog::NET, \"Queued %d transactions for attempted rebroadcast, filtered from %d candidates with cached fee rate of %s.\\n\", rebroadcast_txs.size(), block_template->block.vtx.size() - 1, m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB));\n+\n+    for (TxIds ids : rebroadcast_txs) {\n+        LogPrint(BCLog::NET, \"Attempting to rebroadcast txid: %s, wtxid: %s\\n\", ids.m_txid.ToString(), ids.m_wtxid.ToString());\n+    }\n+\n+    return rebroadcast_txs;\n+};\n+\n+void TxRebroadcastHandler::CacheMinRebroadcastFee()\n+{\n+    if (m_chainman.ActiveChainstate().IsInitialBlockDownload()) return;\n+\n+    LOCK(m_rebroadcast_mutex);\n+\n+    // Update stamp of chain tip on cache run\n+    m_tip_at_cache_time = m_chainman.ActiveTip();\n+\n+    // Store the existing fee rate\n+    m_previous_cached_fee_rate = m_cached_fee_rate;\n+\n+    // Calculate a new cached fee rate\n+    auto start_time = GetTime<std::chrono::microseconds>();\n+    m_cached_fee_rate = BlockAssembler(m_chainman.ActiveChainstate(), m_mempool, m_chainparams).MinTxFeeRate();\n+    auto delta_time = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"Caching minimum fee for rebroadcast to %s, took %d us to calculate.\\n\", m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB), delta_time.count());\n+};\n+\n+void TxRebroadcastHandler::RemoveFromAttemptTracker(const CTransactionRef& tx) {\n+    LOCK(m_rebroadcast_mutex);\n+    const auto it = m_attempt_tracker->find(tx->GetWitnessHash());\n+    if (it == m_attempt_tracker->end()) return;\n+    m_attempt_tracker->erase(it);\n+}\n+\n+void TxRebroadcastHandler::TrimMaxRebroadcast()\n+{\n+    // Delete any entries that are older than MAX_ENTRY_AGE\n+    auto min_age = GetTime<std::chrono::microseconds>() - MAX_ENTRY_AGE;\n+\n+    while (!m_attempt_tracker->empty()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631545127",
      "id" : 631545127,
      "in_reply_to_id" : 628101402,
      "line" : 206,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTU0NTEyNw==",
      "original_commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "original_line" : 206,
      "original_position" : 196,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 206,
      "pull_request_review_id" : 658561398,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-13T03:58:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631545127",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631546704"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631546704"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yup, makes sense. thanks!\r\n\r\nI've updated this site, but in all the other places that I found, was already using references. Let me know if I'm missing some?",
      "commit_id" : "a71810a4856c24617a15c550a2ed7462a9b95627",
      "created_at" : "2021-05-13T04:04:32Z",
      "diff_hunk" : "@@ -0,0 +1,242 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <node/blockstorage.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast upto 3/4 of max block weight to reduce noise due to\n+ * circumstances such as miners mining priority transactions. */\n+static constexpr unsigned int MAX_REBROADCAST_WEIGHT{3 * MAX_BLOCK_WEIGHT / 4};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE{24h * 30 * 3};\n+\n+struct RebroadcastEntry {\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\n+        : m_last_attempt(now_time),\n+          m_wtxid(wtxid) {}\n+\n+    std::chrono::microseconds m_last_attempt;\n+    const uint256 m_wtxid;\n+    int m_count{1};\n+};\n+\n+/** Used for multi_index tag  */\n+struct index_by_last_attempt {};\n+\n+class indexed_rebroadcast_set : public\n+boost::multi_index_container<\n+    RebroadcastEntry,\n+    boost::multi_index::indexed_by<\n+        // sorted by wtxid\n+        boost::multi_index::hashed_unique<\n+            boost::multi_index::tag<index_by_wtxid>,\n+            boost::multi_index::member<RebroadcastEntry, const uint256, &RebroadcastEntry::m_wtxid>,\n+            SaltedTxidHasher\n+        >,\n+        // sorted by last rebroadcast time\n+        boost::multi_index::ordered_non_unique<\n+            boost::multi_index::tag<index_by_last_attempt>,\n+            boost::multi_index::member<RebroadcastEntry, std::chrono::microseconds, &RebroadcastEntry::m_last_attempt>\n+        >\n+    >\n+>{};\n+\n+TxRebroadcastHandler::~TxRebroadcastHandler() = default;\n+\n+TxRebroadcastHandler::TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams)\n+    : m_mempool{mempool},\n+      m_chainman{chainman},\n+      m_chainparams(chainparams),\n+      m_attempt_tracker{std::make_unique<indexed_rebroadcast_set>()}{}\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions(const CBlockIndex* recent_block_index)\n+{\n+    std::vector<TxIds> rebroadcast_txs;\n+    auto start_time = GetTime<std::chrono::microseconds>();\n+\n+    int rebroadcast_block_weight = MAX_REBROADCAST_WEIGHT;\n+    CBlock block;\n+    const Consensus::Params& consensus_params = m_chainparams.GetConsensus();\n+    if (ReadBlockFromDisk(block, recent_block_index, consensus_params)) {\n+        rebroadcast_block_weight = 3 * GetBlockWeight(block) / 4;\n+    }\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = rebroadcast_block_weight;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.m_check_block_validity = false;\n+\n+    // The fee rate condition only filters out transactions if it runs before\n+    // we process the recently mined block. If the cache has since been\n+    // updated, used the value from the previous run to filter transactions.\n+    {\n+        LOCK(m_rebroadcast_mutex);\n+        if (m_tip_at_cache_time == m_chainman.ActiveTip()) {\n+            options.blockMinFeeRate = m_previous_cached_fee_rate;\n+        } else {\n+            options.blockMinFeeRate = m_cached_fee_rate;\n+        }\n+    }\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_chainman.ActiveChainstate(), m_mempool, m_chainparams, options)\n+                              .CreateNewBlock(CScript());\n+    auto after_cnb_time = GetTime<std::chrono::microseconds>();\n+\n+    LOCK(m_rebroadcast_mutex);\n+    for (const CTransactionRef& tx : block_template->block.vtx) {\n+        if (tx->IsCoinBase()) continue;\n+\n+        uint256 txid = tx->GetHash();\n+        uint256 wtxid = tx->GetWitnessHash();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631546704",
      "id" : 631546704,
      "in_reply_to_id" : 629292659,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTU0NjcwNA==",
      "original_commit_id" : "343e3cbb3aea6c8e1f561c798a62b343f5ac7e1c",
      "original_line" : 117,
      "original_position" : 117,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 658563254,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-13T04:04:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631546704",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631547275"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631547275"
         }
      },
      "author_association" : "MEMBER",
      "body" : "great point! fixed now, thanks.",
      "commit_id" : "a71810a4856c24617a15c550a2ed7462a9b95627",
      "created_at" : "2021-05-13T04:06:59Z",
      "diff_hunk" : "@@ -76,6 +76,8 @@ static const unsigned int DEFAULT_MAX_PEER_CONNECTIONS = 125;\n static constexpr uint64_t DEFAULT_MAX_UPLOAD_TARGET = 0;\n /** Default for blocks only*/\n static const bool DEFAULT_BLOCKSONLY = false;\n+/** Default for node rebroadcast logic */\n+static constexpr bool DEFAULT_REBROADCAST_ENABLED = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631547275",
      "id" : 631547275,
      "in_reply_to_id" : 629805112,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTU0NzI3NQ==",
      "original_commit_id" : "a3367b9b79086326f75d111d6b381088d88312f0",
      "original_line" : 80,
      "original_position" : 5,
      "original_start_line" : 79,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 658563963,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-13T04:06:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631547275",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631549506"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631549506"
         }
      },
      "author_association" : "MEMBER",
      "body" : "it's an interesting idea, but I don't think it makes sense to reuse. although they are answering conceptually similar questions, the way these two functions are going about answering is quite different. `MinTxFeeRate` is calculating very precisely based on the state of the mempool _right now_, where as the `estimateSmartFee` function is trying to predict a rate based on current conditions combined with various confidence thresholds.  \r\n\r\n(also note that a `confTarget` of 1 gets automatically turned into 2. I didn't dig into the function too deep to understand exactly why that's necessary, but I think indicates the divergent aims)",
      "commit_id" : "a71810a4856c24617a15c550a2ed7462a9b95627",
      "created_at" : "2021-05-13T04:15:54Z",
      "diff_hunk" : "@@ -306,6 +306,29 @@ void BlockAssembler::SortForBlock(const CTxMemPool::setEntries& package, std::ve\n     std::sort(sortedEntries.begin(), sortedEntries.end(), CompareTxIterByAncestorCount());\n }\n \n+CFeeRate BlockAssembler::MinTxFeeRate()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631549506",
      "id" : 631549506,
      "in_reply_to_id" : 629809015,
      "line" : 308,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTU0OTUwNg==",
      "original_commit_id" : "d72f030be9c9fa77e23132268e16708d7cbb192e",
      "original_line" : 308,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/miner.cpp",
      "position" : 49,
      "pull_request_review_id" : 658566488,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-13T04:15:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631549506",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631550246"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631550246"
         }
      },
      "author_association" : "MEMBER",
      "body" : "GREAT point! in the original PR (#16698), I had a commit to update the `prioritisetransaction` help documentation, but somehow got lost along the way to this current PR. In the latest push, I've cherry-picked that commit onto this PR. \r\n\r\nand, to confirm, you're absolutely right. the block assembler uses modified feerate, so could select transactions to rebroadcast that the user has manually added priority.",
      "commit_id" : "a71810a4856c24617a15c550a2ed7462a9b95627",
      "created_at" : "2021-05-13T04:18:59Z",
      "diff_hunk" : "@@ -33,6 +33,18 @@ std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions(const CBlock\n     options.m_skip_inclusion_until = GetTime<std::chrono::microseconds>() - REBROADCAST_MIN_TX_AGE;\n     options.m_check_block_validity = false;\n \n+    // The fee rate condition only filters out transactions if it runs before\n+    // we process the recently mined block. If the cache has since been\n+    // updated, used the value from the previous run to filter transactions.\n+    {\n+        LOCK(m_rebroadcast_mutex);\n+        if (m_tip_at_cache_time == m_chainman.ActiveTip()) {\n+            options.blockMinFeeRate = m_previous_cached_fee_rate;\n+        } else {\n+            options.blockMinFeeRate = m_cached_fee_rate;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631550246",
      "id" : 631550246,
      "in_reply_to_id" : 629812701,
      "line" : 111,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTU1MDI0Ng==",
      "original_commit_id" : "956819c69de99db84908df0fb3b25ba616f2362d",
      "original_line" : 111,
      "original_position" : 12,
      "original_start_line" : 41,
      "path" : "src/txrebroadcast.cpp",
      "position" : 111,
      "pull_request_review_id" : 658567391,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : 108,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-13T04:19:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631550246",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631550445"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631550445"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done, thanks! I've been having a hard time explaining, added a comment along these lines.",
      "commit_id" : "a71810a4856c24617a15c550a2ed7462a9b95627",
      "created_at" : "2021-05-13T04:19:55Z",
      "diff_hunk" : "@@ -1308,9 +1309,37 @@ PeerManagerImpl::PeerManagerImpl(const CChainParams& chainparams, CConnman& conn\n }\n \n /**\n- * Evict orphan txn pool entries based on a newly connected\n- * block, remember the recently confirmed transactions, and delete tracked\n- * announcements for them. Also save the time of the last tip update.\n+ * If a transaction was removed from the mempool for a reason that entails it\n+ * most likely will not re-enter, let the rebroadcast handler know.\n+ */\n+void PeerManagerImpl::TransactionRemovedFromMempool(const CTransactionRef& tx, MemPoolRemovalReason reason, uint64_t mempool_sequence)\n+{\n+    if (!m_txrebroadcast) return;\n+\n+    switch(reason) {\n+        case MemPoolRemovalReason::BLOCK:\n+            // Although transactions removed for this reason will not be\n+            // returned by this callback, include it here so the compiler\n+            // can warn about missing cases in this switch statement.\n+            // These transactions are handled by BlockConnected.\n+            break;\n+        case MemPoolRemovalReason::EXPIRY:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631550445",
      "id" : 631550445,
      "in_reply_to_id" : 629818366,
      "line" : 1323,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTU1MDQ0NQ==",
      "original_commit_id" : "4165cb0606e4be476651899b80525f63f6e4465a",
      "original_line" : 1323,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 95,
      "pull_request_review_id" : 658567628,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-13T04:19:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631550445",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631550588"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631550588"
         }
      },
      "author_association" : "MEMBER",
      "body" : "sure, doesn't seem like it matters either way? but done regardless",
      "commit_id" : "a71810a4856c24617a15c550a2ed7462a9b95627",
      "created_at" : "2021-05-13T04:20:31Z",
      "diff_hunk" : "@@ -1308,9 +1309,37 @@ PeerManagerImpl::PeerManagerImpl(const CChainParams& chainparams, CConnman& conn\n }\n \n /**\n- * Evict orphan txn pool entries based on a newly connected\n- * block, remember the recently confirmed transactions, and delete tracked\n- * announcements for them. Also save the time of the last tip update.\n+ * If a transaction was removed from the mempool for a reason that entails it\n+ * most likely will not re-enter, let the rebroadcast handler know.\n+ */\n+void PeerManagerImpl::TransactionRemovedFromMempool(const CTransactionRef& tx, MemPoolRemovalReason reason, uint64_t mempool_sequence)\n+{\n+    if (!m_txrebroadcast) return;\n+\n+    switch(reason) {\n+        case MemPoolRemovalReason::BLOCK:\n+            // Although transactions removed for this reason will not be\n+            // returned by this callback, include it here so the compiler\n+            // can warn about missing cases in this switch statement.\n+            // These transactions are handled by BlockConnected.\n+            break;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631550588",
      "id" : 631550588,
      "in_reply_to_id" : 629819928,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTU1MDU4OA==",
      "original_commit_id" : "4165cb0606e4be476651899b80525f63f6e4465a",
      "original_line" : 1325,
      "original_position" : 28,
      "original_start_line" : 1320,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 658567796,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-13T04:20:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631550588",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631551672"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631551672"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`REBROADCAST_MIN_TX_AGE` is defined in the `.cpp`, so isn't available to import in the test. I could move it to the header, but I was trying to minimize how much stuff is in the header only for tests. I could redefine the symbol as a constant in the test, but then we run into the same issue of having to update it if the code changes, so doesn't seem much better.. ",
      "commit_id" : "a71810a4856c24617a15c550a2ed7462a9b95627",
      "created_at" : "2021-05-13T04:24:41Z",
      "diff_hunk" : "@@ -57,6 +57,48 @@ BOOST_AUTO_TEST_CASE(recency)\n     BOOST_CHECK_EQUAL(candidates.front().m_txid, tx_old.GetHash());\n }\n \n+BOOST_AUTO_TEST_CASE(fee_rate)\n+{\n+    // Since the test chain comes with 100 blocks, the first coinbase is\n+    // already valid to spend. Generate another block to have two valid\n+    // coinbase inputs to spend.\n+    CreateAndProcessBlock(std::vector<CMutableTransaction>(), CScript());\n+\n+    // Instantiate rebroadcast module & mine a block, so when we run\n+    // GetRebroadcastTransactions, Chain tip will be beyond m_tip_at_cache_time\n+    const auto chain_params = CreateChainParams(*m_node.args, CBaseChainParams::MAIN);\n+    TxRebroadcastHandler tx_rebroadcast(*m_node.mempool, *m_node.chainman, *chain_params);\n+    CBlock recent_block = CreateAndProcessBlock(std::vector<CMutableTransaction>(), CScript());\n+    CBlockIndex recent_block_index{recent_block.GetBlockHeader()};\n+\n+    // Update m_cached_fee_rate\n+    // The transactions created in this test are each 157 bytes, and they set\n+    // the fee at 1 BTC and 2 BTC.\n+    CFeeRate cached_fee_rate(1.5 * COIN, 157);\n+    tx_rebroadcast.UpdateCachedFeeRate(cached_fee_rate);\n+\n+    // Create two transactions\n+    CKey key;\n+    key.MakeNewKey(true);\n+    CScript output_destination = GetScriptForDestination(PKHash(key.GetPubKey()));\n+\n+    // - One with a low fee rate\n+    CMutableTransaction tx_low = CreateValidMempoolTransaction(m_coinbase_txns[0], /* vout */ 0, /* input_height */ 0, coinbaseKey, output_destination, CAmount(49 * COIN));\n+    // - One with a high fee rate\n+    CMutableTransaction tx_high = CreateValidMempoolTransaction(m_coinbase_txns[1], /* vout */ 0, /* input_height */ 1, coinbaseKey, output_destination, CAmount(48 * COIN));\n+\n+    // Confirm both transactions successfully made it into the mempool\n+    BOOST_CHECK_EQUAL(m_node.mempool->size(), 2);\n+\n+    // Age transaction to be older than REBROADCAST_MIN_TX_AGE\n+    SetMockTime(GetTime<std::chrono::seconds>() + 35min);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631551672",
      "id" : 631551672,
      "in_reply_to_id" : 629823940,
      "line" : 95,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTU1MTY3Mg==",
      "original_commit_id" : "0ae1420767a320cfeafd2acee0b54bc6a6eb9b27",
      "original_line" : 95,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/test/txrebroadcast_tests.cpp",
      "position" : 95,
      "pull_request_review_id" : 658569060,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-13T04:24:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631551672",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631552240"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631552240"
         }
      },
      "author_association" : "MEMBER",
      "body" : "just so I can keep `m_rebroadcast_mutex` as a private member ",
      "commit_id" : "a71810a4856c24617a15c550a2ed7462a9b95627",
      "created_at" : "2021-05-13T04:27:14Z",
      "diff_hunk" : "@@ -41,13 +41,19 @@ class TxRebroadcastHandler\n     /** Remove transaction entry from the attempt tracker.*/\n     void RemoveFromAttemptTracker(const CTransactionRef& tx);\n \n+    /** Test only */\n+    void UpdateAttempt(const uint256& wtxid, const int count, const std::chrono::microseconds last_attempt_time);\n+\n+    /** Test only */\n+    bool CheckRecordedAttempt(const uint256& wtxid, const int expected_count, const std::chrono::microseconds expected_timestamp) const;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r631552240",
      "id" : 631552240,
      "in_reply_to_id" : 629825081,
      "line" : 59,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMTU1MjI0MA==",
      "original_commit_id" : "87d6466380737c2d05932d4af3879950982e61c4",
      "original_line" : 59,
      "original_position" : 8,
      "original_start_line" : 45,
      "path" : "src/txrebroadcast.h",
      "position" : 59,
      "pull_request_review_id" : 658569837,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : 56,
      "start_side" : "RIGHT",
      "updated_at" : "2021-05-13T04:27:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/631552240",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r632905508"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632905508"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    const bool enable_rebroadcast{args.GetArg(\"-rebroadcast\", DEFAULT_REBROADCAST_ENABLED)};\r\n```",
      "commit_id" : "1cc12f956a30d1654cc5060e00f59dc4045a88d1",
      "created_at" : "2021-05-15T06:42:22Z",
      "diff_hunk" : "@@ -1224,8 +1225,10 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n     ChainstateManager& chainman = *Assert(node.chainman);\n \n     assert(!node.peerman);\n+    bool enable_rebroadcast = gArgs.GetArg(\"-rebroadcast\", DEFAULT_REBROADCAST_ENABLED);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r632905508",
      "id" : 632905508,
      "line" : 1228,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjkwNTUwOA==",
      "original_commit_id" : "1cc12f956a30d1654cc5060e00f59dc4045a88d1",
      "original_line" : 1228,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : 12,
      "pull_request_review_id" : 660312877,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-15T07:01:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632905508",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r632906592"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632906592"
         }
      },
      "author_association" : "MEMBER",
      "body" : "to avoid the recursive lock\r\n\r\n```suggestion\r\n            _RelayTransaction(ids.m_txid, ids.m_wtxid);\r\n```",
      "commit_id" : "1cc12f956a30d1654cc5060e00f59dc4045a88d1",
      "created_at" : "2021-05-15T06:54:27Z",
      "diff_hunk" : "@@ -1431,6 +1476,16 @@ void PeerManagerImpl::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlock\n         }\n     }\n \n+    // Rebroadcast selected mempool transactions\n+    if (m_txrebroadcast) {\n+        const std::vector<TxIds> rebroadcast_txs = m_txrebroadcast->GetRebroadcastTransactions(block, *pindexNew);\n+\n+        LOCK(cs_main);\n+        for (auto ids : rebroadcast_txs) {\n+            RelayTransaction(ids.m_txid, ids.m_wtxid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r632906592",
      "id" : 632906592,
      "line" : 1485,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjkwNjU5Mg==",
      "original_commit_id" : "1cc12f956a30d1654cc5060e00f59dc4045a88d1",
      "original_line" : 1485,
      "original_position" : 158,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 158,
      "pull_request_review_id" : 660312877,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-15T07:01:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632906592",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r632907051"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632907051"
         }
      },
      "author_association" : "MEMBER",
      "body" : "would be nice to select the exact permission needed",
      "commit_id" : "1cc12f956a30d1654cc5060e00f59dc4045a88d1",
      "created_at" : "2021-05-15T06:59:10Z",
      "diff_hunk" : "@@ -0,0 +1,205 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"Test node rebroadcast logic.\n+\n+We start by creating a set of transactions to set the rebroadcast minimum fee\n+cache to a medium fee rate value.\n+\n+We then create three sets of transactions:\n+    1. aged, high fee rate\n+    2. aged, low fee rate\n+    3. recent, high fee rate\n+\n+We add a new connection, trigger the rebroadcast functionality by mining an\n+empty block, check that the aged high fee rate transactions were succesfully\n+rebroadcast, and that the other two sets were not rebroadcast.\n+\"\"\"\n+\n+import time\n+from decimal import Decimal\n+\n+from test_framework.p2p import P2PTxInvStore\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_approx,\n+    assert_greater_than,\n+    create_confirmed_utxos,\n+)\n+\n+# Constant from consensus.h\n+MAX_BLOCK_WEIGHT = 4000000\n+\n+\n+class NodeRebroadcastTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\n+            \"-whitelist=127.0.0.1\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r632907051",
      "id" : 632907051,
      "line" : 40,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjkwNzA1MQ==",
      "original_commit_id" : "1cc12f956a30d1654cc5060e00f59dc4045a88d1",
      "original_line" : 40,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "test/functional/p2p_rebroadcast.py",
      "position" : 40,
      "pull_request_review_id" : 660312877,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-15T07:01:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632907051",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r633934902"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633934902"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done. note: had to change `GetArg` to `GetBoolArg` to work with braced initialization, which seems better anyways. ",
      "commit_id" : "3d664956b64388883a1b92b93a8053dd180f67d1",
      "created_at" : "2021-05-17T23:44:55Z",
      "diff_hunk" : "@@ -1224,8 +1225,10 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n     ChainstateManager& chainman = *Assert(node.chainman);\n \n     assert(!node.peerman);\n+    bool enable_rebroadcast = gArgs.GetArg(\"-rebroadcast\", DEFAULT_REBROADCAST_ENABLED);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r633934902",
      "id" : 633934902,
      "in_reply_to_id" : 632905508,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzkzNDkwMg==",
      "original_commit_id" : "1cc12f956a30d1654cc5060e00f59dc4045a88d1",
      "original_line" : 1228,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 661516674,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-17T23:44:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633934902",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r633935088"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633935088"
         }
      },
      "author_association" : "MEMBER",
      "body" : "good call, rebased to get the internal function & updated ",
      "commit_id" : "3d664956b64388883a1b92b93a8053dd180f67d1",
      "created_at" : "2021-05-17T23:45:32Z",
      "diff_hunk" : "@@ -1431,6 +1476,16 @@ void PeerManagerImpl::UpdatedBlockTip(const CBlockIndex *pindexNew, const CBlock\n         }\n     }\n \n+    // Rebroadcast selected mempool transactions\n+    if (m_txrebroadcast) {\n+        const std::vector<TxIds> rebroadcast_txs = m_txrebroadcast->GetRebroadcastTransactions(block, *pindexNew);\n+\n+        LOCK(cs_main);\n+        for (auto ids : rebroadcast_txs) {\n+            RelayTransaction(ids.m_txid, ids.m_wtxid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r633935088",
      "id" : 633935088,
      "in_reply_to_id" : 632906592,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzkzNTA4OA==",
      "original_commit_id" : "1cc12f956a30d1654cc5060e00f59dc4045a88d1",
      "original_line" : 1485,
      "original_position" : 158,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 661516890,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-17T23:45:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633935088",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r633935119"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633935119"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "3d664956b64388883a1b92b93a8053dd180f67d1",
      "created_at" : "2021-05-17T23:45:40Z",
      "diff_hunk" : "@@ -0,0 +1,205 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+\"\"\"Test node rebroadcast logic.\n+\n+We start by creating a set of transactions to set the rebroadcast minimum fee\n+cache to a medium fee rate value.\n+\n+We then create three sets of transactions:\n+    1. aged, high fee rate\n+    2. aged, low fee rate\n+    3. recent, high fee rate\n+\n+We add a new connection, trigger the rebroadcast functionality by mining an\n+empty block, check that the aged high fee rate transactions were succesfully\n+rebroadcast, and that the other two sets were not rebroadcast.\n+\"\"\"\n+\n+import time\n+from decimal import Decimal\n+\n+from test_framework.p2p import P2PTxInvStore\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_approx,\n+    assert_greater_than,\n+    create_confirmed_utxos,\n+)\n+\n+# Constant from consensus.h\n+MAX_BLOCK_WEIGHT = 4000000\n+\n+\n+class NodeRebroadcastTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\n+            \"-whitelist=127.0.0.1\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r633935119",
      "id" : 633935119,
      "in_reply_to_id" : 632907051,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzkzNTExOQ==",
      "original_commit_id" : "1cc12f956a30d1654cc5060e00f59dc4045a88d1",
      "original_line" : 40,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "test/functional/p2p_rebroadcast.py",
      "position" : null,
      "pull_request_review_id" : 661516931,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-17T23:45:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633935119",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r634900036"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634900036"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This gives a 1-in-10k fp rate, so once the bloom filter has had time to fill up, we should expect each node to incorrectly not rebroadcast 1-in-10k transactions. However, the nTweak parameter should ensure that this is affects different transactions on different nodes, so I think this should be fine.",
      "commit_id" : "b927ab97c7a66c0addff17f57e92054ad3547519",
      "created_at" : "2021-05-19T04:14:30Z",
      "diff_hunk" : "@@ -0,0 +1,273 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <node/blockstorage.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast upto 3/4 of max block weight to reduce noise due to\n+ * circumstances such as miners mining priority transactions. */\n+static constexpr float REBROADCAST_WEIGHT_RATIO{0.75};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE{24h * 30 * 3};\n+\n+struct RebroadcastEntry {\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\n+        : m_last_attempt(now_time),\n+          m_wtxid(wtxid) {}\n+\n+    std::chrono::microseconds m_last_attempt;\n+    const uint256 m_wtxid;\n+    int m_count{1};\n+};\n+\n+/** Used for multi_index tag  */\n+struct index_by_last_attempt {};\n+\n+class indexed_rebroadcast_set : public\n+boost::multi_index_container<\n+    RebroadcastEntry,\n+    boost::multi_index::indexed_by<\n+        // sorted by wtxid\n+        boost::multi_index::hashed_unique<\n+            boost::multi_index::tag<index_by_wtxid>,\n+            boost::multi_index::member<RebroadcastEntry, const uint256, &RebroadcastEntry::m_wtxid>,\n+            SaltedTxidHasher\n+        >,\n+        // sorted by last rebroadcast time\n+        boost::multi_index::ordered_non_unique<\n+            boost::multi_index::tag<index_by_last_attempt>,\n+            boost::multi_index::member<RebroadcastEntry, std::chrono::microseconds, &RebroadcastEntry::m_last_attempt>\n+        >\n+    >\n+>{};\n+\n+TxRebroadcastHandler::~TxRebroadcastHandler() = default;\n+\n+TxRebroadcastHandler::TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams)\n+    : m_mempool{mempool},\n+      m_chainman{chainman},\n+      m_chainparams(chainparams),\n+      m_attempt_tracker{std::make_unique<indexed_rebroadcast_set>()},\n+      m_max_filter(1500, 0.0001){}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r634900036",
      "id" : 634900036,
      "line" : 77,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNDkwMDAzNg==",
      "original_commit_id" : "b927ab97c7a66c0addff17f57e92054ad3547519",
      "original_line" : 77,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 77,
      "pull_request_review_id" : 662753505,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-19T04:14:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634900036",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r638418544"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638418544"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think you should be locking `cs_main` prior to calling this -- you want a consistent view between `tip` and `current_fee_rate`, but currently there's no reason you couldn't update the tip immediately after this line, thus associating the old tip with the new (much reduced) fee rate.",
      "commit_id" : "b927ab97c7a66c0addff17f57e92054ad3547519",
      "created_at" : "2021-05-25T03:00:00Z",
      "diff_hunk" : "@@ -0,0 +1,273 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <node/blockstorage.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast upto 3/4 of max block weight to reduce noise due to\n+ * circumstances such as miners mining priority transactions. */\n+static constexpr float REBROADCAST_WEIGHT_RATIO{0.75};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE{24h * 30 * 3};\n+\n+struct RebroadcastEntry {\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\n+        : m_last_attempt(now_time),\n+          m_wtxid(wtxid) {}\n+\n+    std::chrono::microseconds m_last_attempt;\n+    const uint256 m_wtxid;\n+    int m_count{1};\n+};\n+\n+/** Used for multi_index tag  */\n+struct index_by_last_attempt {};\n+\n+class indexed_rebroadcast_set : public\n+boost::multi_index_container<\n+    RebroadcastEntry,\n+    boost::multi_index::indexed_by<\n+        // sorted by wtxid\n+        boost::multi_index::hashed_unique<\n+            boost::multi_index::tag<index_by_wtxid>,\n+            boost::multi_index::member<RebroadcastEntry, const uint256, &RebroadcastEntry::m_wtxid>,\n+            SaltedTxidHasher\n+        >,\n+        // sorted by last rebroadcast time\n+        boost::multi_index::ordered_non_unique<\n+            boost::multi_index::tag<index_by_last_attempt>,\n+            boost::multi_index::member<RebroadcastEntry, std::chrono::microseconds, &RebroadcastEntry::m_last_attempt>\n+        >\n+    >\n+>{};\n+\n+TxRebroadcastHandler::~TxRebroadcastHandler() = default;\n+\n+TxRebroadcastHandler::TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams)\n+    : m_mempool{mempool},\n+      m_chainman{chainman},\n+      m_chainparams(chainparams),\n+      m_attempt_tracker{std::make_unique<indexed_rebroadcast_set>()},\n+      m_max_filter(1500, 0.0001){}\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions(const std::shared_ptr<const CBlock>& recent_block, const CBlockIndex& recent_block_index)\n+{\n+    auto start_time = GetTime<std::chrono::microseconds>();\n+\n+    // Calculate how many transactions to rebroadcast based on the size of the\n+    // incoming block.\n+    float rebroadcast_block_weight = REBROADCAST_WEIGHT_RATIO * MAX_BLOCK_WEIGHT;\n+    if (recent_block) {\n+        // If the passed in block is populated, use to avoid a disk read.\n+        rebroadcast_block_weight = REBROADCAST_WEIGHT_RATIO * GetBlockWeight(*recent_block.get());\n+    } else {\n+        // Otherwise, use the block index to retrieve the relevant block.\n+        const Consensus::Params& consensus_params = m_chainparams.GetConsensus();\n+        CBlock block;\n+\n+        if (ReadBlockFromDisk(block, &recent_block_index, consensus_params)) {\n+            rebroadcast_block_weight = REBROADCAST_WEIGHT_RATIO * GetBlockWeight(block);\n+        }\n+    }\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = rebroadcast_block_weight;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.m_check_block_validity = false;\n+\n+    // The fee rate condition only filters out transactions if it runs before\n+    // we process the recently mined block. If the cache has since been\n+    // updated, used the value from the previous run to filter transactions.\n+    {\n+        const CBlockIndex* tip = m_chainman.ActiveTip();\n+        LOCK(m_rebroadcast_mutex);\n+        if (m_tip_at_cache_time == tip) {\n+            options.blockMinFeeRate = m_previous_cached_fee_rate;\n+        } else {\n+            options.blockMinFeeRate = m_cached_fee_rate;\n+        }\n+    }\n+\n+    // Skip if the fee rate cache has not yet run, which could happen once on\n+    // startup\n+    std::vector<TxIds> rebroadcast_txs;\n+    if (options.blockMinFeeRate.GetFeePerK() == CAmount(0)) return rebroadcast_txs;\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_chainman.ActiveChainstate(), m_mempool, m_chainparams, options)\n+                              .CreateNewBlock(CScript());\n+    auto after_cnb_time = GetTime<std::chrono::microseconds>();\n+    rebroadcast_txs.reserve(block_template->block.vtx.size());\n+\n+    LOCK(m_rebroadcast_mutex);\n+    for (const CTransactionRef& tx : block_template->block.vtx) {\n+        if (tx->IsCoinBase()) continue;\n+\n+        const uint256& txid = tx->GetHash();\n+        const uint256& wtxid = tx->GetWitnessHash();\n+\n+        // Check if we have kinda recently rebroadcasted this transaction the\n+        // maximum number of times.\n+        if (m_max_filter.contains(wtxid)) continue;\n+\n+        // Check if we have previously rebroadcasted, decide if we will this\n+        // round, and if so, record the attempt.\n+        auto entry_it = m_attempt_tracker->find(wtxid);\n+\n+        if (entry_it == m_attempt_tracker->end()) {\n+            // No existing entry, we will rebroadcast, so create a new one\n+            RebroadcastEntry entry(start_time, wtxid);\n+            m_attempt_tracker->insert(entry);\n+        } else if (entry_it->m_count >= MAX_REBROADCAST_COUNT) {\n+            // We have already rebroadcast this transaction the maximum number\n+            // of times permitted. Record in the max filter, remove from\n+            // attempt tracker, and skip rebroadcasting.\n+            m_max_filter.insert(wtxid);\n+            const auto it = m_attempt_tracker->find(tx->GetWitnessHash());\n+            if (it != m_attempt_tracker->end()) m_attempt_tracker->erase(it);\n+            continue;\n+        } else if (entry_it->m_last_attempt > start_time - MIN_REATTEMPT_INTERVAL) {\n+            // We already rebroadcasted this in the past 4 hours. Even if we\n+            // added it to the set, it would probably not get INVed to most\n+            // peers due to filterInventoryKnown.\n+            continue;\n+        } else {\n+            // We have rebroadcasted this transaction before, but will try\n+            // again now. Record the attempt.\n+            auto UpdateRebroadcastEntry = [start_time](RebroadcastEntry& rebroadcast_entry) {\n+                rebroadcast_entry.m_last_attempt = start_time;\n+                ++rebroadcast_entry.m_count;\n+            };\n+\n+            m_attempt_tracker->modify(entry_it, UpdateRebroadcastEntry);\n+        }\n+\n+        // Add to set of rebroadcast candidates\n+        rebroadcast_txs.push_back(TxIds(txid, wtxid));\n+    }\n+\n+    TrimMaxRebroadcast();\n+\n+    auto delta1 = after_cnb_time - start_time;\n+    auto delta2 = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"GetRebroadcastTransactions(): %d us total, %d us spent in CreateNewBlock.\\n\", delta2.count(), delta1.count());\n+    LogPrint(BCLog::NET, \"Queued %d transactions for attempted rebroadcast, filtered from %d candidates with cached fee rate of %s.\\n\", rebroadcast_txs.size(), block_template->block.vtx.size() - 1, m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB));\n+\n+    for (TxIds ids : rebroadcast_txs) {\n+        LogPrint(BCLog::NET, \"Attempting to rebroadcast txid: %s, wtxid: %s\\n\", ids.m_txid.ToString(), ids.m_wtxid.ToString());\n+    }\n+\n+    return rebroadcast_txs;\n+};\n+\n+void TxRebroadcastHandler::CacheMinRebroadcastFee()\n+{\n+    CChainState& chain_state = m_chainman.ActiveChainstate();\n+    if (chain_state.IsInitialBlockDownload()) return;\n+    auto tip = m_chainman.ActiveTip();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r638418544",
      "id" : 638418544,
      "line" : 193,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODQxODU0NA==",
      "original_commit_id" : "b927ab97c7a66c0addff17f57e92054ad3547519",
      "original_line" : 193,
      "original_position" : 193,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 193,
      "pull_request_review_id" : 667349207,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-25T03:04:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638418544",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r638419647"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638419647"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Earlier in this function, there's code to skip transactions if they're too large for the block. I think this can result in the mempool containing txs with fee rates of: `120 s/vb, 119 s/vb, 118 s/vb, 117 s/vb, 115 s/vb, 110 s/vb, 105 s/vb, 100 s/vb, 95 s/vb, 80 s/vb, 79 s/vb, ...` and the block containing txs with fee rates of: `120, 119, 118, 117, 95, 80` -- because the 110-100 s/vb txs just didn't fit in the block, but the 95 and 80 s/vb txs happened to be tiny. This would then incorrectly result in txs with fee rates above 80 s/vb being rebroadcast, whereas really only txs with fee rates above 117 s/vb should be.",
      "commit_id" : "b927ab97c7a66c0addff17f57e92054ad3547519",
      "created_at" : "2021-05-25T03:04:23Z",
      "diff_hunk" : "@@ -419,6 +450,12 @@ void BlockAssembler::addPackageTxs(int &nPackagesSelected, int &nDescendantsUpda\n         // This transaction will make it in; reset the failed counter.\n         nConsecutiveFailed = 0;\n \n+        if (min_package_fee_rate) {\n+            // Compare package fee rate and potentially update new minimum\n+            CFeeRate newFeeRate(packageFees, packageSize);\n+            if (newFeeRate < *min_package_fee_rate) *min_package_fee_rate = newFeeRate;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r638419647",
      "id" : 638419647,
      "line" : 456,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODQxOTY0Nw==",
      "original_commit_id" : "b927ab97c7a66c0addff17f57e92054ad3547519",
      "original_line" : 456,
      "original_position" : 91,
      "original_start_line" : null,
      "path" : "src/miner.cpp",
      "position" : 91,
      "pull_request_review_id" : 667349207,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-25T03:04:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638419647",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r638423702"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638423702"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Perhaps this should also be conditional on `mempool.IsLoaded()` ?",
      "commit_id" : "b927ab97c7a66c0addff17f57e92054ad3547519",
      "created_at" : "2021-05-25T03:20:24Z",
      "diff_hunk" : "@@ -0,0 +1,273 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <node/blockstorage.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast upto 3/4 of max block weight to reduce noise due to\n+ * circumstances such as miners mining priority transactions. */\n+static constexpr float REBROADCAST_WEIGHT_RATIO{0.75};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE{24h * 30 * 3};\n+\n+struct RebroadcastEntry {\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\n+        : m_last_attempt(now_time),\n+          m_wtxid(wtxid) {}\n+\n+    std::chrono::microseconds m_last_attempt;\n+    const uint256 m_wtxid;\n+    int m_count{1};\n+};\n+\n+/** Used for multi_index tag  */\n+struct index_by_last_attempt {};\n+\n+class indexed_rebroadcast_set : public\n+boost::multi_index_container<\n+    RebroadcastEntry,\n+    boost::multi_index::indexed_by<\n+        // sorted by wtxid\n+        boost::multi_index::hashed_unique<\n+            boost::multi_index::tag<index_by_wtxid>,\n+            boost::multi_index::member<RebroadcastEntry, const uint256, &RebroadcastEntry::m_wtxid>,\n+            SaltedTxidHasher\n+        >,\n+        // sorted by last rebroadcast time\n+        boost::multi_index::ordered_non_unique<\n+            boost::multi_index::tag<index_by_last_attempt>,\n+            boost::multi_index::member<RebroadcastEntry, std::chrono::microseconds, &RebroadcastEntry::m_last_attempt>\n+        >\n+    >\n+>{};\n+\n+TxRebroadcastHandler::~TxRebroadcastHandler() = default;\n+\n+TxRebroadcastHandler::TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams)\n+    : m_mempool{mempool},\n+      m_chainman{chainman},\n+      m_chainparams(chainparams),\n+      m_attempt_tracker{std::make_unique<indexed_rebroadcast_set>()},\n+      m_max_filter(1500, 0.0001){}\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions(const std::shared_ptr<const CBlock>& recent_block, const CBlockIndex& recent_block_index)\n+{\n+    auto start_time = GetTime<std::chrono::microseconds>();\n+\n+    // Calculate how many transactions to rebroadcast based on the size of the\n+    // incoming block.\n+    float rebroadcast_block_weight = REBROADCAST_WEIGHT_RATIO * MAX_BLOCK_WEIGHT;\n+    if (recent_block) {\n+        // If the passed in block is populated, use to avoid a disk read.\n+        rebroadcast_block_weight = REBROADCAST_WEIGHT_RATIO * GetBlockWeight(*recent_block.get());\n+    } else {\n+        // Otherwise, use the block index to retrieve the relevant block.\n+        const Consensus::Params& consensus_params = m_chainparams.GetConsensus();\n+        CBlock block;\n+\n+        if (ReadBlockFromDisk(block, &recent_block_index, consensus_params)) {\n+            rebroadcast_block_weight = REBROADCAST_WEIGHT_RATIO * GetBlockWeight(block);\n+        }\n+    }\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = rebroadcast_block_weight;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.m_check_block_validity = false;\n+\n+    // The fee rate condition only filters out transactions if it runs before\n+    // we process the recently mined block. If the cache has since been\n+    // updated, used the value from the previous run to filter transactions.\n+    {\n+        const CBlockIndex* tip = m_chainman.ActiveTip();\n+        LOCK(m_rebroadcast_mutex);\n+        if (m_tip_at_cache_time == tip) {\n+            options.blockMinFeeRate = m_previous_cached_fee_rate;\n+        } else {\n+            options.blockMinFeeRate = m_cached_fee_rate;\n+        }\n+    }\n+\n+    // Skip if the fee rate cache has not yet run, which could happen once on\n+    // startup\n+    std::vector<TxIds> rebroadcast_txs;\n+    if (options.blockMinFeeRate.GetFeePerK() == CAmount(0)) return rebroadcast_txs;\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_chainman.ActiveChainstate(), m_mempool, m_chainparams, options)\n+                              .CreateNewBlock(CScript());\n+    auto after_cnb_time = GetTime<std::chrono::microseconds>();\n+    rebroadcast_txs.reserve(block_template->block.vtx.size());\n+\n+    LOCK(m_rebroadcast_mutex);\n+    for (const CTransactionRef& tx : block_template->block.vtx) {\n+        if (tx->IsCoinBase()) continue;\n+\n+        const uint256& txid = tx->GetHash();\n+        const uint256& wtxid = tx->GetWitnessHash();\n+\n+        // Check if we have kinda recently rebroadcasted this transaction the\n+        // maximum number of times.\n+        if (m_max_filter.contains(wtxid)) continue;\n+\n+        // Check if we have previously rebroadcasted, decide if we will this\n+        // round, and if so, record the attempt.\n+        auto entry_it = m_attempt_tracker->find(wtxid);\n+\n+        if (entry_it == m_attempt_tracker->end()) {\n+            // No existing entry, we will rebroadcast, so create a new one\n+            RebroadcastEntry entry(start_time, wtxid);\n+            m_attempt_tracker->insert(entry);\n+        } else if (entry_it->m_count >= MAX_REBROADCAST_COUNT) {\n+            // We have already rebroadcast this transaction the maximum number\n+            // of times permitted. Record in the max filter, remove from\n+            // attempt tracker, and skip rebroadcasting.\n+            m_max_filter.insert(wtxid);\n+            const auto it = m_attempt_tracker->find(tx->GetWitnessHash());\n+            if (it != m_attempt_tracker->end()) m_attempt_tracker->erase(it);\n+            continue;\n+        } else if (entry_it->m_last_attempt > start_time - MIN_REATTEMPT_INTERVAL) {\n+            // We already rebroadcasted this in the past 4 hours. Even if we\n+            // added it to the set, it would probably not get INVed to most\n+            // peers due to filterInventoryKnown.\n+            continue;\n+        } else {\n+            // We have rebroadcasted this transaction before, but will try\n+            // again now. Record the attempt.\n+            auto UpdateRebroadcastEntry = [start_time](RebroadcastEntry& rebroadcast_entry) {\n+                rebroadcast_entry.m_last_attempt = start_time;\n+                ++rebroadcast_entry.m_count;\n+            };\n+\n+            m_attempt_tracker->modify(entry_it, UpdateRebroadcastEntry);\n+        }\n+\n+        // Add to set of rebroadcast candidates\n+        rebroadcast_txs.push_back(TxIds(txid, wtxid));\n+    }\n+\n+    TrimMaxRebroadcast();\n+\n+    auto delta1 = after_cnb_time - start_time;\n+    auto delta2 = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"GetRebroadcastTransactions(): %d us total, %d us spent in CreateNewBlock.\\n\", delta2.count(), delta1.count());\n+    LogPrint(BCLog::NET, \"Queued %d transactions for attempted rebroadcast, filtered from %d candidates with cached fee rate of %s.\\n\", rebroadcast_txs.size(), block_template->block.vtx.size() - 1, m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB));\n+\n+    for (TxIds ids : rebroadcast_txs) {\n+        LogPrint(BCLog::NET, \"Attempting to rebroadcast txid: %s, wtxid: %s\\n\", ids.m_txid.ToString(), ids.m_wtxid.ToString());\n+    }\n+\n+    return rebroadcast_txs;\n+};\n+\n+void TxRebroadcastHandler::CacheMinRebroadcastFee()\n+{\n+    CChainState& chain_state = m_chainman.ActiveChainstate();\n+    if (chain_state.IsInitialBlockDownload()) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r638423702",
      "id" : 638423702,
      "line" : 192,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODQyMzcwMg==",
      "original_commit_id" : "b927ab97c7a66c0addff17f57e92054ad3547519",
      "original_line" : 192,
      "original_position" : 192,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : 192,
      "pull_request_review_id" : 667355760,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-25T03:20:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638423702",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r642210611"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/642210611"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done ",
      "commit_id" : "9b757c214e59fbf5dd028323a54734726a1c461b",
      "created_at" : "2021-05-31T05:01:15Z",
      "diff_hunk" : "@@ -0,0 +1,273 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <node/blockstorage.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast upto 3/4 of max block weight to reduce noise due to\n+ * circumstances such as miners mining priority transactions. */\n+static constexpr float REBROADCAST_WEIGHT_RATIO{0.75};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE{24h * 30 * 3};\n+\n+struct RebroadcastEntry {\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\n+        : m_last_attempt(now_time),\n+          m_wtxid(wtxid) {}\n+\n+    std::chrono::microseconds m_last_attempt;\n+    const uint256 m_wtxid;\n+    int m_count{1};\n+};\n+\n+/** Used for multi_index tag  */\n+struct index_by_last_attempt {};\n+\n+class indexed_rebroadcast_set : public\n+boost::multi_index_container<\n+    RebroadcastEntry,\n+    boost::multi_index::indexed_by<\n+        // sorted by wtxid\n+        boost::multi_index::hashed_unique<\n+            boost::multi_index::tag<index_by_wtxid>,\n+            boost::multi_index::member<RebroadcastEntry, const uint256, &RebroadcastEntry::m_wtxid>,\n+            SaltedTxidHasher\n+        >,\n+        // sorted by last rebroadcast time\n+        boost::multi_index::ordered_non_unique<\n+            boost::multi_index::tag<index_by_last_attempt>,\n+            boost::multi_index::member<RebroadcastEntry, std::chrono::microseconds, &RebroadcastEntry::m_last_attempt>\n+        >\n+    >\n+>{};\n+\n+TxRebroadcastHandler::~TxRebroadcastHandler() = default;\n+\n+TxRebroadcastHandler::TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams)\n+    : m_mempool{mempool},\n+      m_chainman{chainman},\n+      m_chainparams(chainparams),\n+      m_attempt_tracker{std::make_unique<indexed_rebroadcast_set>()},\n+      m_max_filter(1500, 0.0001){}\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions(const std::shared_ptr<const CBlock>& recent_block, const CBlockIndex& recent_block_index)\n+{\n+    auto start_time = GetTime<std::chrono::microseconds>();\n+\n+    // Calculate how many transactions to rebroadcast based on the size of the\n+    // incoming block.\n+    float rebroadcast_block_weight = REBROADCAST_WEIGHT_RATIO * MAX_BLOCK_WEIGHT;\n+    if (recent_block) {\n+        // If the passed in block is populated, use to avoid a disk read.\n+        rebroadcast_block_weight = REBROADCAST_WEIGHT_RATIO * GetBlockWeight(*recent_block.get());\n+    } else {\n+        // Otherwise, use the block index to retrieve the relevant block.\n+        const Consensus::Params& consensus_params = m_chainparams.GetConsensus();\n+        CBlock block;\n+\n+        if (ReadBlockFromDisk(block, &recent_block_index, consensus_params)) {\n+            rebroadcast_block_weight = REBROADCAST_WEIGHT_RATIO * GetBlockWeight(block);\n+        }\n+    }\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = rebroadcast_block_weight;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.m_check_block_validity = false;\n+\n+    // The fee rate condition only filters out transactions if it runs before\n+    // we process the recently mined block. If the cache has since been\n+    // updated, used the value from the previous run to filter transactions.\n+    {\n+        const CBlockIndex* tip = m_chainman.ActiveTip();\n+        LOCK(m_rebroadcast_mutex);\n+        if (m_tip_at_cache_time == tip) {\n+            options.blockMinFeeRate = m_previous_cached_fee_rate;\n+        } else {\n+            options.blockMinFeeRate = m_cached_fee_rate;\n+        }\n+    }\n+\n+    // Skip if the fee rate cache has not yet run, which could happen once on\n+    // startup\n+    std::vector<TxIds> rebroadcast_txs;\n+    if (options.blockMinFeeRate.GetFeePerK() == CAmount(0)) return rebroadcast_txs;\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_chainman.ActiveChainstate(), m_mempool, m_chainparams, options)\n+                              .CreateNewBlock(CScript());\n+    auto after_cnb_time = GetTime<std::chrono::microseconds>();\n+    rebroadcast_txs.reserve(block_template->block.vtx.size());\n+\n+    LOCK(m_rebroadcast_mutex);\n+    for (const CTransactionRef& tx : block_template->block.vtx) {\n+        if (tx->IsCoinBase()) continue;\n+\n+        const uint256& txid = tx->GetHash();\n+        const uint256& wtxid = tx->GetWitnessHash();\n+\n+        // Check if we have kinda recently rebroadcasted this transaction the\n+        // maximum number of times.\n+        if (m_max_filter.contains(wtxid)) continue;\n+\n+        // Check if we have previously rebroadcasted, decide if we will this\n+        // round, and if so, record the attempt.\n+        auto entry_it = m_attempt_tracker->find(wtxid);\n+\n+        if (entry_it == m_attempt_tracker->end()) {\n+            // No existing entry, we will rebroadcast, so create a new one\n+            RebroadcastEntry entry(start_time, wtxid);\n+            m_attempt_tracker->insert(entry);\n+        } else if (entry_it->m_count >= MAX_REBROADCAST_COUNT) {\n+            // We have already rebroadcast this transaction the maximum number\n+            // of times permitted. Record in the max filter, remove from\n+            // attempt tracker, and skip rebroadcasting.\n+            m_max_filter.insert(wtxid);\n+            const auto it = m_attempt_tracker->find(tx->GetWitnessHash());\n+            if (it != m_attempt_tracker->end()) m_attempt_tracker->erase(it);\n+            continue;\n+        } else if (entry_it->m_last_attempt > start_time - MIN_REATTEMPT_INTERVAL) {\n+            // We already rebroadcasted this in the past 4 hours. Even if we\n+            // added it to the set, it would probably not get INVed to most\n+            // peers due to filterInventoryKnown.\n+            continue;\n+        } else {\n+            // We have rebroadcasted this transaction before, but will try\n+            // again now. Record the attempt.\n+            auto UpdateRebroadcastEntry = [start_time](RebroadcastEntry& rebroadcast_entry) {\n+                rebroadcast_entry.m_last_attempt = start_time;\n+                ++rebroadcast_entry.m_count;\n+            };\n+\n+            m_attempt_tracker->modify(entry_it, UpdateRebroadcastEntry);\n+        }\n+\n+        // Add to set of rebroadcast candidates\n+        rebroadcast_txs.push_back(TxIds(txid, wtxid));\n+    }\n+\n+    TrimMaxRebroadcast();\n+\n+    auto delta1 = after_cnb_time - start_time;\n+    auto delta2 = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"GetRebroadcastTransactions(): %d us total, %d us spent in CreateNewBlock.\\n\", delta2.count(), delta1.count());\n+    LogPrint(BCLog::NET, \"Queued %d transactions for attempted rebroadcast, filtered from %d candidates with cached fee rate of %s.\\n\", rebroadcast_txs.size(), block_template->block.vtx.size() - 1, m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB));\n+\n+    for (TxIds ids : rebroadcast_txs) {\n+        LogPrint(BCLog::NET, \"Attempting to rebroadcast txid: %s, wtxid: %s\\n\", ids.m_txid.ToString(), ids.m_wtxid.ToString());\n+    }\n+\n+    return rebroadcast_txs;\n+};\n+\n+void TxRebroadcastHandler::CacheMinRebroadcastFee()\n+{\n+    CChainState& chain_state = m_chainman.ActiveChainstate();\n+    if (chain_state.IsInitialBlockDownload()) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r642210611",
      "id" : 642210611,
      "in_reply_to_id" : 638423702,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MjIxMDYxMQ==",
      "original_commit_id" : "b927ab97c7a66c0addff17f57e92054ad3547519",
      "original_line" : 192,
      "original_position" : 192,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 671949665,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-31T05:01:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/642210611",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r642210663"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/642210663"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yeah makes sense, done",
      "commit_id" : "9b757c214e59fbf5dd028323a54734726a1c461b",
      "created_at" : "2021-05-31T05:01:31Z",
      "diff_hunk" : "@@ -0,0 +1,273 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <chainparams.h>\n+#include <consensus/consensus.h>\n+#include <logging.h>\n+#include <miner.h>\n+#include <node/blockstorage.h>\n+#include <script/script.h>\n+#include <txrebroadcast.h>\n+#include <util/time.h>\n+\n+#include <boost/multi_index/hashed_index.hpp>\n+#include <boost/multi_index/member.hpp>\n+#include <boost/multi_index/ordered_index.hpp>\n+#include <boost/multi_index_container.hpp>\n+\n+/** We rebroadcast upto 3/4 of max block weight to reduce noise due to\n+ * circumstances such as miners mining priority transactions. */\n+static constexpr float REBROADCAST_WEIGHT_RATIO{0.75};\n+\n+/** Default minimum age for a transaction to be rebroadcast */\n+static constexpr std::chrono::minutes REBROADCAST_MIN_TX_AGE{30min};\n+\n+/** Maximum number of times we will rebroadcast a transaction */\n+static constexpr int MAX_REBROADCAST_COUNT{6};\n+\n+/** Minimum amount of time between returning the same transaction for\n+ * rebroadcast */\n+static constexpr std::chrono::hours MIN_REATTEMPT_INTERVAL{4h};\n+\n+/** The maximum number of entries permitted in m_attempt_tracker */\n+static constexpr int MAX_ENTRIES{500};\n+\n+/** The maximum age of an entry ~3 months */\n+static constexpr std::chrono::hours MAX_ENTRY_AGE{24h * 30 * 3};\n+\n+struct RebroadcastEntry {\n+    RebroadcastEntry(std::chrono::microseconds now_time, uint256 wtxid)\n+        : m_last_attempt(now_time),\n+          m_wtxid(wtxid) {}\n+\n+    std::chrono::microseconds m_last_attempt;\n+    const uint256 m_wtxid;\n+    int m_count{1};\n+};\n+\n+/** Used for multi_index tag  */\n+struct index_by_last_attempt {};\n+\n+class indexed_rebroadcast_set : public\n+boost::multi_index_container<\n+    RebroadcastEntry,\n+    boost::multi_index::indexed_by<\n+        // sorted by wtxid\n+        boost::multi_index::hashed_unique<\n+            boost::multi_index::tag<index_by_wtxid>,\n+            boost::multi_index::member<RebroadcastEntry, const uint256, &RebroadcastEntry::m_wtxid>,\n+            SaltedTxidHasher\n+        >,\n+        // sorted by last rebroadcast time\n+        boost::multi_index::ordered_non_unique<\n+            boost::multi_index::tag<index_by_last_attempt>,\n+            boost::multi_index::member<RebroadcastEntry, std::chrono::microseconds, &RebroadcastEntry::m_last_attempt>\n+        >\n+    >\n+>{};\n+\n+TxRebroadcastHandler::~TxRebroadcastHandler() = default;\n+\n+TxRebroadcastHandler::TxRebroadcastHandler(const CTxMemPool& mempool, const ChainstateManager& chainman, const CChainParams& chainparams)\n+    : m_mempool{mempool},\n+      m_chainman{chainman},\n+      m_chainparams(chainparams),\n+      m_attempt_tracker{std::make_unique<indexed_rebroadcast_set>()},\n+      m_max_filter(1500, 0.0001){}\n+\n+std::vector<TxIds> TxRebroadcastHandler::GetRebroadcastTransactions(const std::shared_ptr<const CBlock>& recent_block, const CBlockIndex& recent_block_index)\n+{\n+    auto start_time = GetTime<std::chrono::microseconds>();\n+\n+    // Calculate how many transactions to rebroadcast based on the size of the\n+    // incoming block.\n+    float rebroadcast_block_weight = REBROADCAST_WEIGHT_RATIO * MAX_BLOCK_WEIGHT;\n+    if (recent_block) {\n+        // If the passed in block is populated, use to avoid a disk read.\n+        rebroadcast_block_weight = REBROADCAST_WEIGHT_RATIO * GetBlockWeight(*recent_block.get());\n+    } else {\n+        // Otherwise, use the block index to retrieve the relevant block.\n+        const Consensus::Params& consensus_params = m_chainparams.GetConsensus();\n+        CBlock block;\n+\n+        if (ReadBlockFromDisk(block, &recent_block_index, consensus_params)) {\n+            rebroadcast_block_weight = REBROADCAST_WEIGHT_RATIO * GetBlockWeight(block);\n+        }\n+    }\n+\n+    BlockAssembler::Options options;\n+    options.nBlockMaxWeight = rebroadcast_block_weight;\n+    options.m_skip_inclusion_until = start_time - REBROADCAST_MIN_TX_AGE;\n+    options.m_check_block_validity = false;\n+\n+    // The fee rate condition only filters out transactions if it runs before\n+    // we process the recently mined block. If the cache has since been\n+    // updated, used the value from the previous run to filter transactions.\n+    {\n+        const CBlockIndex* tip = m_chainman.ActiveTip();\n+        LOCK(m_rebroadcast_mutex);\n+        if (m_tip_at_cache_time == tip) {\n+            options.blockMinFeeRate = m_previous_cached_fee_rate;\n+        } else {\n+            options.blockMinFeeRate = m_cached_fee_rate;\n+        }\n+    }\n+\n+    // Skip if the fee rate cache has not yet run, which could happen once on\n+    // startup\n+    std::vector<TxIds> rebroadcast_txs;\n+    if (options.blockMinFeeRate.GetFeePerK() == CAmount(0)) return rebroadcast_txs;\n+\n+    // Use CreateNewBlock to identify rebroadcast candidates\n+    auto block_template = BlockAssembler(m_chainman.ActiveChainstate(), m_mempool, m_chainparams, options)\n+                              .CreateNewBlock(CScript());\n+    auto after_cnb_time = GetTime<std::chrono::microseconds>();\n+    rebroadcast_txs.reserve(block_template->block.vtx.size());\n+\n+    LOCK(m_rebroadcast_mutex);\n+    for (const CTransactionRef& tx : block_template->block.vtx) {\n+        if (tx->IsCoinBase()) continue;\n+\n+        const uint256& txid = tx->GetHash();\n+        const uint256& wtxid = tx->GetWitnessHash();\n+\n+        // Check if we have kinda recently rebroadcasted this transaction the\n+        // maximum number of times.\n+        if (m_max_filter.contains(wtxid)) continue;\n+\n+        // Check if we have previously rebroadcasted, decide if we will this\n+        // round, and if so, record the attempt.\n+        auto entry_it = m_attempt_tracker->find(wtxid);\n+\n+        if (entry_it == m_attempt_tracker->end()) {\n+            // No existing entry, we will rebroadcast, so create a new one\n+            RebroadcastEntry entry(start_time, wtxid);\n+            m_attempt_tracker->insert(entry);\n+        } else if (entry_it->m_count >= MAX_REBROADCAST_COUNT) {\n+            // We have already rebroadcast this transaction the maximum number\n+            // of times permitted. Record in the max filter, remove from\n+            // attempt tracker, and skip rebroadcasting.\n+            m_max_filter.insert(wtxid);\n+            const auto it = m_attempt_tracker->find(tx->GetWitnessHash());\n+            if (it != m_attempt_tracker->end()) m_attempt_tracker->erase(it);\n+            continue;\n+        } else if (entry_it->m_last_attempt > start_time - MIN_REATTEMPT_INTERVAL) {\n+            // We already rebroadcasted this in the past 4 hours. Even if we\n+            // added it to the set, it would probably not get INVed to most\n+            // peers due to filterInventoryKnown.\n+            continue;\n+        } else {\n+            // We have rebroadcasted this transaction before, but will try\n+            // again now. Record the attempt.\n+            auto UpdateRebroadcastEntry = [start_time](RebroadcastEntry& rebroadcast_entry) {\n+                rebroadcast_entry.m_last_attempt = start_time;\n+                ++rebroadcast_entry.m_count;\n+            };\n+\n+            m_attempt_tracker->modify(entry_it, UpdateRebroadcastEntry);\n+        }\n+\n+        // Add to set of rebroadcast candidates\n+        rebroadcast_txs.push_back(TxIds(txid, wtxid));\n+    }\n+\n+    TrimMaxRebroadcast();\n+\n+    auto delta1 = after_cnb_time - start_time;\n+    auto delta2 = GetTime<std::chrono::microseconds>() - start_time;\n+    LogPrint(BCLog::BENCH, \"GetRebroadcastTransactions(): %d us total, %d us spent in CreateNewBlock.\\n\", delta2.count(), delta1.count());\n+    LogPrint(BCLog::NET, \"Queued %d transactions for attempted rebroadcast, filtered from %d candidates with cached fee rate of %s.\\n\", rebroadcast_txs.size(), block_template->block.vtx.size() - 1, m_cached_fee_rate.ToString(FeeEstimateMode::SAT_VB));\n+\n+    for (TxIds ids : rebroadcast_txs) {\n+        LogPrint(BCLog::NET, \"Attempting to rebroadcast txid: %s, wtxid: %s\\n\", ids.m_txid.ToString(), ids.m_wtxid.ToString());\n+    }\n+\n+    return rebroadcast_txs;\n+};\n+\n+void TxRebroadcastHandler::CacheMinRebroadcastFee()\n+{\n+    CChainState& chain_state = m_chainman.ActiveChainstate();\n+    if (chain_state.IsInitialBlockDownload()) return;\n+    auto tip = m_chainman.ActiveTip();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r642210663",
      "id" : 642210663,
      "in_reply_to_id" : 638418544,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MjIxMDY2Mw==",
      "original_commit_id" : "b927ab97c7a66c0addff17f57e92054ad3547519",
      "original_line" : 193,
      "original_position" : 193,
      "original_start_line" : null,
      "path" : "src/txrebroadcast.cpp",
      "position" : null,
      "pull_request_review_id" : 671949755,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-31T05:01:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/642210663",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r642211263"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/642211263"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I removed the `cs_main` call from here, but think I actually have to lock it from the caller, see:  https://github.com/bitcoin/bitcoin/pull/21061#discussion_r638418544",
      "commit_id" : "9b757c214e59fbf5dd028323a54734726a1c461b",
      "created_at" : "2021-05-31T05:03:43Z",
      "diff_hunk" : "@@ -298,6 +311,43 @@ void BlockAssembler::SortForBlock(const CTxMemPool::setEntries& package, std::ve\n     std::sort(sortedEntries.begin(), sortedEntries.end(), CompareTxIterByAncestorCount());\n }\n \n+CFeeRate BlockAssembler::minTxFeeRate()\n+{\n+    int packages_selected = 0;\n+    int descendants_updated = 0;\n+    CFeeRate min_fee_rate = CFeeRate(COIN, 1);\n+\n+    resetBlock();\n+    pblocktemplate.reset(new CBlockTemplate());\n+\n+    if (!pblocktemplate.get()) {\n+        return min_fee_rate;\n+    }\n+    CBlock* block = &pblocktemplate->block;\n+\n+    // Add dummy coinbase tx as first transaction\n+    block->vtx.emplace_back();\n+    pblocktemplate->vTxFees.push_back(-1);\n+    pblocktemplate->vTxSigOpsCost.push_back(-1);\n+\n+    CBlockIndex* prev_block_index = ::ChainActive().Tip();\n+    assert(prev_block_index != nullptr);\n+    nHeight = prev_block_index->nHeight + 1;\n+\n+    block->nTime = static_cast<uint32_t>(GetAdjustedTime());\n+    const int64_t median_time_past = prev_block_index->GetMedianTimePast();\n+\n+    nLockTimeCutoff = median_time_past;\n+    fIncludeWitness = IsWitnessEnabled(prev_block_index, chainparams.GetConsensus());\n+\n+    {\n+        LOCK2(cs_main, m_mempool.cs);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#discussion_r642211263",
      "id" : 642211263,
      "in_reply_to_id" : 602283867,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MjIxMTI2Mw==",
      "original_commit_id" : "038f751e9ce27f885f0baa87cd13d89fe71fa3d5",
      "original_line" : 324,
      "original_position" : 96,
      "original_start_line" : null,
      "path" : "src/miner.cpp",
      "position" : null,
      "pull_request_review_id" : 671950516,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21061",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-05-31T05:03:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/642211263",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've been simulating the behavior of this logic using historical transaction and block data, and I have some general concept thoughts:\r\n\r\n1) In a situation where a transaction propagated reasonably well, it doesn't make sense that the whole network should simultaneously try to rebroadcast that transaction at the same time.  That is needlessly bandwidth-wasteful, as it results in an INV for that transaction to be re-sent on every link in the network, in a situation where (by assumption) few nodes would be missing it.\r\n\r\n2) In a situation where a transaction didn't propagate well or has dropped out of many nodes' mempools, but would propagate well if rebroadcast, it should be sufficient for a single node or a small number of nodes to do the rebroadcasting. \r\n\r\n3) The benefit of rebroadcasting a transaction that wouldn't propagate well seems small.  The goal is to get good transactions into miners' mempools, but if a transaction doesn't propagate well to node mempools, it probably wouldn't make it into a lot of miners' mempools either.\r\n\r\n4) I think we want to avoid bandwidth spikes on the network -- particularly right after a new block is found, when we would ideally be prioritizing bandwidth for block relay.  So it seems better to me to (a) not have all nodes on the network synchronizing on rebroadcasting simultaneously and (b) not have block connection be a trigger for rebroadcast. \r\n\r\n5) If a bunch of nodes on the network are simultaneously deciding to rebroadcast a large set of transactions, the rate-limiting we have on transaction announcements will mean that the network's transaction relay latency will go up as it takes time for the backlog to clear.  So, I think in general we should want to avoid situations where a node might want to broadcast (for example) several hundred transactions at once -- even more so if all the nodes on the network would decide to do the same thing at the same time.  This is another reason for not synchronizing rebroadcast across nodes, and I think it is also an argument for capping the number of transactions that might get selected for rebroadcasting at any particular time.\r\n\r\n6) There's little value in rebroadcasting transactions whose feerates are only slightly better than other transactions in the mempool.  Not to say we should never do it, but in thinking about the cost/benefit of transaction rebroadcast, it seems to me that prioritizing bandwidth usage on the most comparatively valuable transactions makes the most sense.  \r\n\r\nTaking the above into account, I'd propose this approach:\r\n\r\na) Any given node should rebroadcast way less often -- perhaps each node could attempt to rebroadcast on the order of once every 24 hours or every 48 hours on average, whether on a poisson timer or a random offset.  In a network with 10k listening nodes this is already a lot of rebroadcasting (10,000 / (24*60) is about 7 such nodes attempting rebroadcast every minute, not even taking into account the non-listening nodes on the network which will also be doing this!).  \r\n\r\nb) If we do (a) then we've probably greatly mitigated bandwidth spikes on the network, but I'd go further and limit the number of transactions that are ever selected to be rebroadcast at some small value like 25 or 50, to ensure we don't ever try to re-announce several hundred (or more) transactions onto the network at once.  \r\n\r\nc) I think the logic in this PR could use some refining to avoid edge-case behavior when we might rebroadcast a lot of transactions that are not valuable to rebroadcast.  These first two are cases that I've seen so far in my simulations, and the last one is a conjecture: \r\n * If a node comes back online after being offline for a while, then using block connections to trigger rebroadcast can result in rapid-fire rebroadcast of transactions that we really shouldn't be reannouncing (because both our mempool and our tip are not up to date).  I think this would be fixed by adopting (a) and (b) above.\r\n *  The mining heuristic of calling `CreateNewBlock` with an option for excluding recent transactions can result in us deciding to rebroadcast a lot of transactions that we wouldn't even select for a new block. Imagine that the mempool has just less than 1MB (vsize) of high feerate stuff that is all recent, and everything else is some uniform low feerate.  Then our cached feerate for inclusion in a block might be the low feerate (if at least 1 such transaction would be included in the block), and the heuristic of calling `CNB` with the cached feerate and excluding recent transactions can pick up thousands of low-feerate old stuff that wouldn't all realistically make it in to a new block.\r\n *  I think that reannouncing transactions that are part of a package (ie have more than 1 unconfirmed ancestor) may not be a great idea, because there are at least two reasons that packages might not relay well: (a) if any unconfirmed parent has a feerate below a peer's mempool-min-fee, then the package won't be accepted, and (b) descendant transaction limits on unconfirmed parents can interfere with relay of even a high-fee-rate child.  So to avoid wasting bandwidth, I think there's an argument that perhaps we should start by just relaying transactions with no unconfirmed parents in our initial deployment of this logic, and defer trying to relay transactions with unconfirmed ancestors until we have a package relay protocol deployed.  \r\n\r\nd) Given the issue described above with `CreateNewBlock` and the issues I am conjecturing with package relay, I suggest that we simplify the logic by eliminating the dependency on the mining algorithm, and instead just do a really simple algorithm for deciding what to consider rebroadcasting.  Randomly once a day (or maybe once every two days):\r\n * Walk the mempool by descending ancestor-fee-rate\r\n * If in the first 1MB (by vsize) of size-with-ancestor we encounter a transaction that is > 30 minutes old and has no unconfirmed parents (and hasn't hit our max number of rebroadcast attempts), then add to the rebroadcast set.\r\n * If we we hit 1MB of vsize that we've looked at or hit some cap on the number of transactions to rebroadcast (say 25), break and announce whatever we've picked so far.\r\nOne thing I'm not sure about is if we should be concerned about rebroadcasting a transaction that is close to the end of our `-mempoolexpiry` value; it seems like it could be problematic if we rebroadcast some low-feerate transaction that would otherwise be expiring soon and somehow cause it to ping-pong into other's mempools again, and then others cause it to get resurrected in our own.  Maybe we should only rebroadcast transactions that are signaling BIP 125 RBF?\r\n\r\ne) I think that we should only rebroadcast transactions to peers that are using wtxidrelay (BIP 339).  Bitcoin Core software that predates wtxidrelay will not cache validation failure for segwit transactions that don't make it into the mempool. This means that if a transaction doesn't propagate for some random policy reason (eg feerate), then the peer would still try download it from every connection that announces it.  As this PR is drafted now, where all nodes are on the same announcement timer, that means a lot of wasted *transaction download* bandwidth (not just wasted INV bandwidth!) whenever a transaction that doesn't get accepted is rebroadcast.  This would be mitigated by randomizing rebroadcasts and reducing the frequency, but I think we might as well just limit this to wtxidrelay peers as well for an extra safety margin.\r\n\r\nMy simulations of this PR on historical data are still ongoing and I don't have a good summary yet, but please let me know if there are statistics or other specific questions that would be helpful for us to consider (I have a few ideas in mind but I'm still gathering my thoughts).",
      "created_at" : "2021-05-31T15:33:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-851563105",
      "id" : 851563105,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1MTU2MzEwNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-05-31T15:33:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/851563105",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I had one other thought about how we select transactions for rebroadcast; I think it could be problematic to base transaction rebroadcast solely on how transactions in our mempool compare to transactions that we would select in `CreateNewBlock` without regard to what transaction fees we're actually seeing in blocks on the network.\r\n\r\nImagine that you are running a somewhat older node, and there have been releases of Bitcoin Core that enable new standard transaction types that others are using.  Then your node will not be aware of those new transactions, and it's possible that only looking at the set of transactions that you know to be standard would result in rebroadcasting transactions from your mempool that are actually quite a bit below the feerate that the rest of the network thinks is needed to be confirmed soon.\r\n\r\n(Or really there could be any reason that miners might have access to better feerate transactions than a single node does -- there's still no point in aggressively rebroadcasting transactions that are worse than what we see are being confirmed.)\r\n\r\nThis problem would also be largely mitigated by making this behavior occur much less frequently and limiting the number of transactions that we'd consider rebroadcasting at once, but I think the heuristic of calling `CreateNewBlock` every minute and caching the lowest observed package feerate may be inferior to just looking at the contents of each block we see, and trying to infer the lowest feerate that we think is actually needed to be included in a block (perhaps we could look at the set of in-block transactions that have no ancestors or descendants, and try to estimate the minimum feerate needed for inclusion as a moving average of what we've recently observed -- would need to test out any kind of heuristic like this though).",
      "created_at" : "2021-06-01T14:00:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-852149829",
      "id" : 852149829,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1MjE0OTgyOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-01T14:00:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/852149829",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Marking this PR as draft-\r\nAfter offline conversations with @ajtowns, @sdaftuar & @jnewbery, I'm planning to rework the approach of this patch to increase the requirements for a transaction to be rebroadcast. The biggest change will be only sending an INV after a transaction has been missed from 3 blocks. ",
      "created_at" : "2021-06-04T21:57:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-855023462",
      "id" : 855023462,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1NTAyMzQ2Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-04T21:57:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/855023462",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I was searching for privacy related PRs to review and write tests using PowerShell scripts for my project.\r\n\r\nFound this PR in the search results which I had already reviewed in March 2021, however I don't think writing test for it makes sense based on last two comments.\r\n\r\nAlso agree with the things mentioned by Suhas Daftuar. \r\n\r\n> I'm planning to rework the approach of this patch to increase the requirements for a transaction to be rebroadcast. \r\n\r\nHoping new approach will be better and we soon improve privacy in rebroadcast mechanism. Thanks for working on this.",
      "created_at" : "2021-07-30T17:31:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-890045629",
      "id" : 890045629,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "IC_kwDOABII5841DQS9",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-30T17:31:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/890045629",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-12-13T23:18:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-993000456",
      "id" : 993000456,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "IC_kwDOABII5847L_wI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/993000456/reactions"
      },
      "updated_at" : "2021-12-13T23:18:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/993000456",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--13523179cfe9479db18ec6c5d236f789-->There hasn't been much activity lately and the patch still needs rebase. What is the status here?\n\n* Is it still relevant? â¡ï¸ Please solve the conflicts to make it ready for review and to ensure the CI passes.\n* Is it no longer relevant? â¡ï¸ Please close.\n* Did the author lose interest or time to work on this? â¡ï¸ Please close it and mark it 'Up for grabs' with the label, so that it can be picked up in the future.\n",
      "created_at" : "2022-03-21T13:06:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-1073871594",
      "id" : 1073871594,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "IC_kwDOABII585AAfrq",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1073871594/reactions"
      },
      "updated_at" : "2022-03-21T13:06:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1073871594",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Closing this for now. It may be reopened at a later point.",
      "created_at" : "2022-03-22T14:43:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21061#issuecomment-1075270440",
      "id" : 1075270440,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21061",
      "node_id" : "IC_kwDOABII585AF1Mo",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1075270440/reactions"
      },
      "updated_at" : "2022-03-22T14:43:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1075270440",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   }
]
