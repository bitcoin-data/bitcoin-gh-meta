[
   {
      "author_association" : "MEMBER",
      "body" : "> This can be useful when the process launching bitcoind wants to guarantee that either the RPC server is running, or that initialization failed, before continuing. The exit code indicates the initialization result.\r\n\r\nWhy such behavior couldn't be the default?",
      "created_at" : "2021-01-25T22:29:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-767155783",
      "id" : 767155783,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2NzE1NTc4Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-25T22:29:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/767155783",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r564088898"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/564088898"
         }
      },
      "author_association" : "MEMBER",
      "body" : "s/`ALLOW_ANY`/`ALLOW_BOOL`/ in both lines?",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-01-25T22:32:46Z",
      "diff_hunk" : "@@ -577,7 +577,8 @@ void SetupServerArgs(NodeContext& node)\n     argsman.AddArg(\"-server\", \"Accept command line and JSON-RPC commands\", ArgsManager::ALLOW_ANY, OptionsCategory::RPC);\n \n #if HAVE_DECL_DAEMON\n-    argsman.AddArg(\"-daemon\", \"Run in the background as a daemon and accept commands\", ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n+    argsman.AddArg(\"-daemon\", \"Run in the background as a daemon and accept commands (default: 0)\", ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n+    argsman.AddArg(\"-daemonwait\", \"Wait for initialization to be finished before exiting. This implies -daemon (default: 0)\", ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r564088898",
      "id" : 564088898,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDA4ODg5OA==",
      "original_commit_id" : "f88aa35dfe4d824ae2ded5c9229bf5763c459e5e",
      "original_line" : 581,
      "original_position" : 6,
      "original_start_line" : 580,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 575864170,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/564088898",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Why such behavior couldn't be the default?\r\n\r\nI didn't do that to avoid that discussion for now :slightly_smiling_face: . It could always be made default at some point in the future if that's what people want.",
      "created_at" : "2021-01-25T22:33:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-767157237",
      "id" : 767157237,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2NzE1NzIzNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-25T22:33:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/767157237",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2021-01-25T22:34:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-767157806",
      "id" : 767157806,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2NzE1NzgwNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-25T22:34:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/767157806",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21366 (refactor: replace util::Ref with std::any (C++17) by theStack)\n* #19471 (util: Make default arg values more specific by hebasto)\n* #19461 (multiprocess: Add bitcoin-gui -ipcconnect option by ryanofsky)\n* #19460 (multiprocess: Add bitcoin-wallet -ipcconnect option by ryanofsky)\n* #19160 (multiprocess: Add basic spawn and IPC support by ryanofsky)\n* #10102 ([experimental] Multiprocess bitcoin by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-01-26T02:08:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-767235287",
      "id" : 767235287,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2NzIzNTI4Nw==",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/767235287/reactions"
      },
      "updated_at" : "2021-03-11T07:39:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/767235287",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r564296569"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/564296569"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good idea!\r\nI'm also surprised there are no DEFAULT_XXX constants here.",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-01-26T07:28:09Z",
      "diff_hunk" : "@@ -577,7 +577,8 @@ void SetupServerArgs(NodeContext& node)\n     argsman.AddArg(\"-server\", \"Accept command line and JSON-RPC commands\", ArgsManager::ALLOW_ANY, OptionsCategory::RPC);\n \n #if HAVE_DECL_DAEMON\n-    argsman.AddArg(\"-daemon\", \"Run in the background as a daemon and accept commands\", ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n+    argsman.AddArg(\"-daemon\", \"Run in the background as a daemon and accept commands (default: 0)\", ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n+    argsman.AddArg(\"-daemonwait\", \"Wait for initialization to be finished before exiting. This implies -daemon (default: 0)\", ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r564296569",
      "id" : 564296569,
      "in_reply_to_id" : 564088898,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDI5NjU2OQ==",
      "original_commit_id" : "f88aa35dfe4d824ae2ded5c9229bf5763c459e5e",
      "original_line" : 581,
      "original_position" : 6,
      "original_start_line" : 580,
      "path" : "src/init.cpp",
      "position" : null,
      "pull_request_review_id" : 576079338,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/564296569",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2021-01-26T09:37:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-767421905",
      "id" : 767421905,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2NzQyMTkwNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-26T09:37:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/767421905",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2021-01-26T18:57:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-767756333",
      "id" : 767756333,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2Nzc1NjMzMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-26T18:57:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/767756333",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for testing! FWIW what I use to force a failure in `AppInitMain` is\r\n```\r\nsrc/bitcoind -regtest -daemonwait -pid=/invalid/path\r\n```\r\n(pid is, by definition, only written in the daemon process)\r\nBut that works too :smile: ",
      "created_at" : "2021-01-27T13:57:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-768302433",
      "id" : 768302433,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2ODMwMjQzMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-27T13:57:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/768302433",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> (pid is, by definition, only written in the daemon process)\r\n\r\nNot sure if this is true in the master branch.\r\n",
      "created_at" : "2021-01-27T14:01:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-768305065",
      "id" : 768305065,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2ODMwNTA2NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-27T14:01:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/768305065",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Not sure if this is true in the master branch.\r\n\r\nI am sure of this. I did not change this at all, and besides, it would be a bug otherwise. After all, what use is the temporary parent process' PID.",
      "created_at" : "2021-01-27T14:11:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-768311235",
      "id" : 768311235,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2ODMxMTIzNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-27T14:11:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/768311235",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> ... it would be a bug otherwise.\r\n\r\n```\r\nsrc/bitcoind -daemon=0\r\n```\r\ncreates `bitcoind.pid`",
      "created_at" : "2021-01-27T14:17:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-768315306",
      "id" : 768315306,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2ODMxNTMwNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-27T14:17:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/768315306",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> creates bitcoind.pid\r\n\r\nThat's not my point. My point is that it creates the PID file *after* daemonizing (when daemon is enabled). Sure, it also creates the PID file otherwise, that's okay. The only thing I was trying to say is that the option can be used for testing `-daemonwait` because it fails after daemonizing, nothing more.",
      "created_at" : "2021-01-27T14:24:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-768319284",
      "id" : 768319284,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2ODMxOTI4NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-27T14:25:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/768319284",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for testing @jonatack ,\r\n\r\n> (this particular case does not log anything to the debug log)\r\n\r\nThat it doesn't log anything is peculiar ! (but unrelated to this PR, I guess, the same problem would happen with `-daemon`, it would just mysteriously exit in the background).\r\n\r\n> Ctrl-C works with a second or two of delay; it seems to not take effect until the wait is released but I'm not sure.\r\n\r\nIt does respond to it? That's interesting. I thought the child process wouldn't get the SIGINT signal at all (hence my remaining TODO). That it doesn't react immediately is normal, It can't interrupt during verification of a block, for example. it's the same when interrupting a non-daemon startup.",
      "created_at" : "2021-01-27T18:13:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-768474737",
      "id" : 768474737,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2ODQ3NDczNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-27T18:13:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/768474737",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Tested with testnet, which is much slower than signet for me (95 sec vs 3)\r\n```\r\n$ time ./src/bitcoind -testnet -daemonwait=1 && ./src/bitcoin-cli -testnet stop\r\nBitcoin Core starting\r\n\r\nreal\t1m35.265s\r\nuser\t0m0.137s\r\nsys\t0m0.015s\r\nBitcoin Core stopping\r\n$\r\n```\r\n\r\nCtrl-C right after launching interrupts successfully after the same time period elapses \r\n```\r\n$ time ./src/bitcoind -testnet -daemonwait=1\r\nBitcoin Core starting\r\n^C\r\nreal\t1m39.239s\r\nuser\t0m0.130s\r\nsys\t0m0.022s\r\n$\r\n```\r\n",
      "created_at" : "2021-01-27T20:23:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-768553517",
      "id" : 768553517,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2ODU1MzUxNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-27T20:23:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/768553517",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've looked into this a bit.\r\n\r\nIt looks like that until the parent process exits, the child process is still attached to the terminal (or at least, shell session), so it still gets the `SIGINT` from Ctrl-C directly. Even though it did `dup2` `stdin/stdout/stderr` to `/dev/null` already.\r\n\r\nSo there appears to be no need to do explicit signal propagation. That's neat. I'll remove that TODO and open this for review.",
      "created_at" : "2021-01-28T12:01:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-769007341",
      "id" : 769007341,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc2OTAwNzM0MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-28T12:04:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/769007341",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r568983015"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568983015"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hm, it's always a bit frustrating to see that within a C++ ctor it's impossible to directly signal to the caller that the construction failed (I had to think about this article: https://250bpm.com/blog:4/). Since we can't do anything immediately anyways if there was a failure, I guess the pipe{2} return value checks could simply be dropped?",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-02-02T22:44:16Z",
      "diff_hunk" : "@@ -0,0 +1,98 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+#include <util/tokenpipe.h>\n+\n+#ifndef WIN32\n+\n+#include <errno.h>\n+#include <unistd.h>\n+\n+TokenPipe::TokenPipe()\n+{\n+#if HAVE_O_CLOEXEC\n+    if (pipe2(m_fds, O_CLOEXEC) != 0) {\n+        return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r568983015",
      "id" : 568983015,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODk4MzAxNQ==",
      "original_commit_id" : "0ef284ba1a4b942654552e4335225b6c2d34420c",
      "original_line" : 15,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/util/tokenpipe.cpp",
      "position" : null,
      "pull_request_review_id" : 581839115,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568983015",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r568985945"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568985945"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Could simply call the `Close()` method here to deduplicate? (Only drawback: it unnecessarily sets m_fd to -1 before destroying the object.)",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-02-02T22:50:21Z",
      "diff_hunk" : "@@ -0,0 +1,98 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+#include <util/tokenpipe.h>\n+\n+#ifndef WIN32\n+\n+#include <errno.h>\n+#include <unistd.h>\n+\n+TokenPipe::TokenPipe()\n+{\n+#if HAVE_O_CLOEXEC\n+    if (pipe2(m_fds, O_CLOEXEC) != 0) {\n+        return;\n+    }\n+#else\n+    if (pipe(m_fds) != 0) {\n+        return;\n+    }\n+#endif\n+}\n+\n+TokenPipe::~TokenPipe()\n+{\n+    if (m_fds[0] != -1) close(m_fds[0]);\n+    if (m_fds[1] != -1) close(m_fds[1]);\n+}\n+\n+TokenPipeEnd TokenPipe::ReadEnd()\n+{\n+    TokenPipeEnd res(m_fds[0]);\n+    m_fds[0] = -1;\n+    return res;\n+}\n+\n+TokenPipeEnd TokenPipe::WriteEnd()\n+{\n+    TokenPipeEnd res(m_fds[1]);\n+    m_fds[1] = -1;\n+    return res;\n+}\n+\n+TokenPipeEnd::TokenPipeEnd(int fd):\n+    m_fd(fd)\n+{\n+}\n+\n+TokenPipeEnd::~TokenPipeEnd()\n+{\n+    if (m_fd != -1) close(m_fd);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r568985945",
      "id" : 568985945,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODk4NTk0NQ==",
      "original_commit_id" : "0ef284ba1a4b942654552e4335225b6c2d34420c",
      "original_line" : 51,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/util/tokenpipe.cpp",
      "position" : null,
      "pull_request_review_id" : 581839115,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568985945",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r568990330"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568990330"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n    /** Return value constants for TokenWrite and TokenRead. */\r\n```",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-02-02T22:59:43Z",
      "diff_hunk" : "@@ -0,0 +1,98 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_TOKENPIPE_H\n+#define BITCOIN_UTIL_TOKENPIPE_H\n+\n+#ifndef WIN32\n+\n+#include <stdint.h>\n+\n+/** One end of a token pipe. */\n+class TokenPipeEnd {\n+private:\n+    int m_fd = -1;\n+public:\n+    TokenPipeEnd(int fd = -1);\n+    ~TokenPipeEnd();\n+\n+    /** Return valus constants for TokenWrite and TokenRead. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r568990330",
      "id" : 568990330,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODk5MDMzMA==",
      "original_commit_id" : "0ef284ba1a4b942654552e4335225b6c2d34420c",
      "original_line" : 20,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/util/tokenpipe.h",
      "position" : null,
      "pull_request_review_id" : 581839115,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568990330",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r568990947"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568990947"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n    /** Write token to file descriptor.\r\n```",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-02-02T23:01:06Z",
      "diff_hunk" : "@@ -0,0 +1,98 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_TOKENPIPE_H\n+#define BITCOIN_UTIL_TOKENPIPE_H\n+\n+#ifndef WIN32\n+\n+#include <stdint.h>\n+\n+/** One end of a token pipe. */\n+class TokenPipeEnd {\n+private:\n+    int m_fd = -1;\n+public:\n+    TokenPipeEnd(int fd = -1);\n+    ~TokenPipeEnd();\n+\n+    /** Return valus constants for TokenWrite and TokenRead. */\n+    enum Status {\n+        TS_ERR = -1, //!< I/O error\n+        TS_EOS = -2, //!< Unexpected end of stream\n+    };\n+\n+    /** Read token from file descriptor.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r568990947",
      "id" : 568990947,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODk5MDk0Nw==",
      "original_commit_id" : "0ef284ba1a4b942654552e4335225b6c2d34420c",
      "original_line" : 26,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/util/tokenpipe.h",
      "position" : null,
      "pull_request_review_id" : 581839115,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568990947",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r568997766"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568997766"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit, feel free to ignore: maybe avoid implicit casting from bool to uint8_t and use literal 1 (or some character literal) as success token instead? I think as it is this could be potentially confusing for readers (also the counterpart `TokenRead` call below). As a drawback though, `-daemonwait` code gets longer: `daemon_ep.TokenWrite(fRet ? 1 : 0)`.",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-02-02T23:17:20Z",
      "diff_hunk" : "@@ -105,24 +187,34 @@ static bool AppInit(int argc, char* argv[])\n             // InitError will have been called with detailed error, which ends up on console\n             return false;\n         }\n-        if (args.GetBoolArg(\"-daemon\", false)) {\n-#if HAVE_DECL_DAEMON\n-#if defined(MAC_OSX)\n-#pragma GCC diagnostic push\n-#pragma GCC diagnostic ignored \"-Wdeprecated-declarations\"\n-#endif\n+        if (args.GetBoolArg(\"-daemon\", DEFAULT_DAEMON) || args.GetBoolArg(\"-daemonwait\", DEFAULT_DAEMONWAIT)) {\n+#if HAVE_DECL_FORK\n             tfm::format(std::cout, PACKAGE_NAME \" starting\\n\");\n \n             // Daemonize\n-            if (daemon(1, 0)) { // don't chdir (1), do close FDs (0)\n-                return InitError(Untranslated(strprintf(\"daemon() failed: %s\\n\", strerror(errno))));\n+            switch (fork_daemon(1, 0, daemon_ep)) { // don't chdir (1), do close FDs (0)\n+                case 0: // Child: continue.\n+                    // If -daemonwait is not enabled, immediately send a success token the parent.\n+                    if (!args.GetBoolArg(\"-daemonwait\", DEFAULT_DAEMONWAIT)) {\n+                        daemon_ep.TokenWrite(true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r568997766",
      "id" : 568997766,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODk5Nzc2Ng==",
      "original_commit_id" : "7482634cd455c6d25287e52795c2ac78cb1d44b0",
      "original_line" : 199,
      "original_position" : 124,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : null,
      "pull_request_review_id" : 581839115,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568997766",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r569717901"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569717901"
         }
      },
      "author_association" : "MEMBER",
      "body" : "~~Agree, it's probably better to pass some constant.~~\r\n~~Or even just fRet as-is? It's an integer after all.~~\r\nNever mind, i was already doing that, just turned this into a value.",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-02-03T20:14:41Z",
      "diff_hunk" : "@@ -105,24 +187,34 @@ static bool AppInit(int argc, char* argv[])\n             // InitError will have been called with detailed error, which ends up on console\n             return false;\n         }\n-        if (args.GetBoolArg(\"-daemon\", false)) {\n-#if HAVE_DECL_DAEMON\n-#if defined(MAC_OSX)\n-#pragma GCC diagnostic push\n-#pragma GCC diagnostic ignored \"-Wdeprecated-declarations\"\n-#endif\n+        if (args.GetBoolArg(\"-daemon\", DEFAULT_DAEMON) || args.GetBoolArg(\"-daemonwait\", DEFAULT_DAEMONWAIT)) {\n+#if HAVE_DECL_FORK\n             tfm::format(std::cout, PACKAGE_NAME \" starting\\n\");\n \n             // Daemonize\n-            if (daemon(1, 0)) { // don't chdir (1), do close FDs (0)\n-                return InitError(Untranslated(strprintf(\"daemon() failed: %s\\n\", strerror(errno))));\n+            switch (fork_daemon(1, 0, daemon_ep)) { // don't chdir (1), do close FDs (0)\n+                case 0: // Child: continue.\n+                    // If -daemonwait is not enabled, immediately send a success token the parent.\n+                    if (!args.GetBoolArg(\"-daemonwait\", DEFAULT_DAEMONWAIT)) {\n+                        daemon_ep.TokenWrite(true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r569717901",
      "id" : 569717901,
      "in_reply_to_id" : 568997766,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTcxNzkwMQ==",
      "original_commit_id" : "7482634cd455c6d25287e52795c2ac78cb1d44b0",
      "original_line" : 199,
      "original_position" : 124,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : null,
      "pull_request_review_id" : 582762626,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569717901",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r569721308"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569721308"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I was first thinking of using the rust trick: to have a private constructor, and a static public factory function on the class that returns a `std::optional<Pipe>`. But it would complicate some things. E.g. currently this type is not movable at all, it felt like overkill to implement that just for initialization, but maybe it's worth it if we can make it a standard idiom.\r\n\r\nHaving to check `complete()` as a mandatory step feels slightly ugly too, after all.",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-02-03T20:20:25Z",
      "diff_hunk" : "@@ -0,0 +1,98 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+#include <util/tokenpipe.h>\n+\n+#ifndef WIN32\n+\n+#include <errno.h>\n+#include <unistd.h>\n+\n+TokenPipe::TokenPipe()\n+{\n+#if HAVE_O_CLOEXEC\n+    if (pipe2(m_fds, O_CLOEXEC) != 0) {\n+        return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r569721308",
      "id" : 569721308,
      "in_reply_to_id" : 568983015,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTcyMTMwOA==",
      "original_commit_id" : "0ef284ba1a4b942654552e4335225b6c2d34420c",
      "original_line" : 15,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/util/tokenpipe.cpp",
      "position" : null,
      "pull_request_review_id" : 582766865,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569721308",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r569724510"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569724510"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, why not. It seemed like so little code that it wouldn't really be worth deduplicating. I agree the redundant set to `-1` doesn't matter, this is not a performance critical function.",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-02-03T20:26:05Z",
      "diff_hunk" : "@@ -0,0 +1,98 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+#include <util/tokenpipe.h>\n+\n+#ifndef WIN32\n+\n+#include <errno.h>\n+#include <unistd.h>\n+\n+TokenPipe::TokenPipe()\n+{\n+#if HAVE_O_CLOEXEC\n+    if (pipe2(m_fds, O_CLOEXEC) != 0) {\n+        return;\n+    }\n+#else\n+    if (pipe(m_fds) != 0) {\n+        return;\n+    }\n+#endif\n+}\n+\n+TokenPipe::~TokenPipe()\n+{\n+    if (m_fds[0] != -1) close(m_fds[0]);\n+    if (m_fds[1] != -1) close(m_fds[1]);\n+}\n+\n+TokenPipeEnd TokenPipe::ReadEnd()\n+{\n+    TokenPipeEnd res(m_fds[0]);\n+    m_fds[0] = -1;\n+    return res;\n+}\n+\n+TokenPipeEnd TokenPipe::WriteEnd()\n+{\n+    TokenPipeEnd res(m_fds[1]);\n+    m_fds[1] = -1;\n+    return res;\n+}\n+\n+TokenPipeEnd::TokenPipeEnd(int fd):\n+    m_fd(fd)\n+{\n+}\n+\n+TokenPipeEnd::~TokenPipeEnd()\n+{\n+    if (m_fd != -1) close(m_fd);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r569724510",
      "id" : 569724510,
      "in_reply_to_id" : 568985945,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTcyNDUxMA==",
      "original_commit_id" : "0ef284ba1a4b942654552e4335225b6c2d34420c",
      "original_line" : 51,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/util/tokenpipe.cpp",
      "position" : null,
      "pull_request_review_id" : 582771069,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569724510",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Addressed @theStack's comments:\r\n- Added `TokenPipe::create()` that returns an optional (and make `TokenPipe` movable, and its constructor private), instead of the awkward incomplete construction.\r\n- Call `Close()` in destructor instead of duplicating code.\r\n- Consistently pass int to `TokenWrite`.\r\n- Fixed typos in comments.",
      "created_at" : "2021-02-16T19:06:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-780054109",
      "id" : 780054109,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MDA1NDEwOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-16T19:09:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/780054109",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r578007134"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578007134"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The error-check after TokenPipe creation is missing here, e.g. `if (!pipe) return false;`",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-02-17T23:05:37Z",
      "diff_hunk" : "@@ -24,25 +27,17 @@ std::mutex g_shutdown_mutex;\n std::condition_variable g_shutdown_cv;\n #else\n /** On UNIX-like operating systems use the self-pipe trick.\n- * Index 0 will be the read end of the pipe, index 1 the write end.\n  */\n-static int g_shutdown_pipe[2] = {-1, -1};\n+static TokenPipeEnd g_shutdown_r;\n+static TokenPipeEnd g_shutdown_w;\n #endif\n \n bool InitShutdownState()\n {\n #ifndef WIN32\n-#if HAVE_O_CLOEXEC\n-    // If we can, make sure that the file descriptors are closed on exec()\n-    // to prevent interference.\n-    if (pipe2(g_shutdown_pipe, O_CLOEXEC) != 0) {\n-        return false;\n-    }\n-#else\n-    if (pipe(g_shutdown_pipe) != 0) {\n-        return false;\n-    }\n-#endif\n+    std::optional<TokenPipe> pipe = TokenPipe::create();\n+    g_shutdown_r = pipe->ReadEnd();\n+    g_shutdown_w = pipe->WriteEnd();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r578007134",
      "id" : 578007134,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODAwNzEzNA==",
      "original_commit_id" : "581f48d818e17bebe75e24c9d72029e4a0f2e8af",
      "original_line" : 37,
      "original_position" : 37,
      "original_start_line" : 38,
      "path" : "src/shutdown.cpp",
      "position" : null,
      "pull_request_review_id" : 592705254,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578007134",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r578007441"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578007441"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n        return -1; // pipe or pipe2 failed.\r\n```",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-02-17T23:06:19Z",
      "diff_hunk" : "@@ -28,6 +29,79 @@\n const std::function<std::string(const char*)> G_TRANSLATION_FUN = nullptr;\n UrlDecodeFn* const URL_DECODE = urlDecode;\n \n+#if HAVE_DECL_FORK\n+\n+/** Custom implementation of daemon(). This implements the same order of operations as glibc.\n+ * Opens a pipe to the child process to be able to wait for an event to occur.\n+ *\n+ * @returns 0 if succesful, and in child process.\n+ *          >0 if succesful, and in parent process.\n+ *          -1 in case of error (in parent process).\n+ *\n+ *          In case of success, endpoint will be one end of a pipe from the child to parent process,\n+ *          which can be used with TokenWrite (in the child) or TokenRead (in the parent).\n+ */\n+int fork_daemon(bool nochdir, bool noclose, TokenPipeEnd &endpoint)\n+{\n+    // communication pipe with child process\n+    std::optional<TokenPipe> umblical = TokenPipe::create();\n+    if (!umblical) {\n+        return -1; // pipe or pip2 failed.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r578007441",
      "id" : 578007441,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODAwNzQ0MQ==",
      "original_commit_id" : "48858432bc7ef3e02685b693954173e722bae4e5",
      "original_line" : 49,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : null,
      "pull_request_review_id" : 592705254,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578007441",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r578013255"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578013255"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit:\r\n```suggestion\r\n                        if (token == 1) { // fRet == 1, Success\r\n```\r\n(probably the token variable could be eliminated by calling `TokenRead` directly in the if condition.)",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-02-17T23:19:26Z",
      "diff_hunk" : "@@ -105,24 +187,34 @@ static bool AppInit(int argc, char* argv[])\n             // InitError will have been called with detailed error, which ends up on console\n             return false;\n         }\n-        if (args.GetBoolArg(\"-daemon\", false)) {\n-#if HAVE_DECL_DAEMON\n-#if defined(MAC_OSX)\n-#pragma GCC diagnostic push\n-#pragma GCC diagnostic ignored \"-Wdeprecated-declarations\"\n-#endif\n+        if (args.GetBoolArg(\"-daemon\", DEFAULT_DAEMON) || args.GetBoolArg(\"-daemonwait\", DEFAULT_DAEMONWAIT)) {\n+#if HAVE_DECL_FORK\n             tfm::format(std::cout, PACKAGE_NAME \" starting\\n\");\n \n             // Daemonize\n-            if (daemon(1, 0)) { // don't chdir (1), do close FDs (0)\n-                return InitError(Untranslated(strprintf(\"daemon() failed: %s\\n\", strerror(errno))));\n+            switch (fork_daemon(1, 0, daemon_ep)) { // don't chdir (1), do close FDs (0)\n+                case 0: // Child: continue.\n+                    // If -daemonwait is not enabled, immediately send a success token the parent.\n+                    if (!args.GetBoolArg(\"-daemonwait\", DEFAULT_DAEMONWAIT)) {\n+                        daemon_ep.TokenWrite(1);\n+                        daemon_ep.Close();\n+                    }\n+                    break;\n+                case -1: // Error happened.\n+                    return InitError(Untranslated(strprintf(\"fork_daemon() failed: %s\\n\", strerror(errno))));\n+                default: { // Parent: wait and exit.\n+                        int token = daemon_ep.TokenRead();\n+                        if (token == true) { // fRet == true, Success",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r578013255",
      "id" : 578013255,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODAxMzI1NQ==",
      "original_commit_id" : "48858432bc7ef3e02685b693954173e722bae4e5",
      "original_line" : 207,
      "original_position" : 132,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : null,
      "pull_request_review_id" : 592705254,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578013255",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r578014248"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578014248"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "typos:\r\n```suggestion\r\n    // that the parent process can quit, and whether it was successful/unsuccessful.\r\n```",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-02-17T23:21:57Z",
      "diff_hunk" : "@@ -59,6 +133,14 @@ static bool AppInit(int argc, char* argv[])\n         return true;\n     }\n \n+#if HAVE_DECL_FORK\n+    // Communication with parent after daemonizing. This is used for signalling in the following ways:\n+    // - a boolean token is sent when the initialization process (all the Init* functions) have finished to indicate\n+    // that the parent process can quit, and whether it was succesful/unsuccesful.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r578014248",
      "id" : 578014248,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODAxNDI0OA==",
      "original_commit_id" : "48858432bc7ef3e02685b693954173e722bae4e5",
      "original_line" : 139,
      "original_position" : 95,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : null,
      "pull_request_review_id" : 592705254,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578014248",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r578017192"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578017192"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I didn't know the word before (nice name for a parent-child-pipe ð), but according to the dictionary the spelling is slightly different:\r\n```suggestion\r\n        endpoint = umbilical->ReadEnd();\r\n```",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-02-17T23:29:08Z",
      "diff_hunk" : "@@ -28,6 +29,79 @@\n const std::function<std::string(const char*)> G_TRANSLATION_FUN = nullptr;\n UrlDecodeFn* const URL_DECODE = urlDecode;\n \n+#if HAVE_DECL_FORK\n+\n+/** Custom implementation of daemon(). This implements the same order of operations as glibc.\n+ * Opens a pipe to the child process to be able to wait for an event to occur.\n+ *\n+ * @returns 0 if succesful, and in child process.\n+ *          >0 if succesful, and in parent process.\n+ *          -1 in case of error (in parent process).\n+ *\n+ *          In case of success, endpoint will be one end of a pipe from the child to parent process,\n+ *          which can be used with TokenWrite (in the child) or TokenRead (in the parent).\n+ */\n+int fork_daemon(bool nochdir, bool noclose, TokenPipeEnd &endpoint)\n+{\n+    // communication pipe with child process\n+    std::optional<TokenPipe> umblical = TokenPipe::create();\n+    if (!umblical) {\n+        return -1; // pipe or pip2 failed.\n+    }\n+\n+    int pid = fork();\n+    if (pid < 0) {\n+        return -1; // fork failed.\n+    }\n+    if (pid != 0) {\n+        // Parent process gets read end, closes write end.\n+        endpoint = umblical->ReadEnd();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r578017192",
      "id" : 578017192,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODAxNzE5Mg==",
      "original_commit_id" : "48858432bc7ef3e02685b693954173e722bae4e5",
      "original_line" : 58,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : null,
      "pull_request_review_id" : 592705254,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578017192",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r578235280"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578235280"
         }
      },
      "author_association" : "MEMBER",
      "body" : "~~Good point, will re-add an assertion.~~\r\n~~All the error handling in `shutdown` consists of assertions but skipping it is a bad idea.~~\r\nNo, returning false is the right thing to do here.",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-02-18T08:52:18Z",
      "diff_hunk" : "@@ -24,25 +27,17 @@ std::mutex g_shutdown_mutex;\n std::condition_variable g_shutdown_cv;\n #else\n /** On UNIX-like operating systems use the self-pipe trick.\n- * Index 0 will be the read end of the pipe, index 1 the write end.\n  */\n-static int g_shutdown_pipe[2] = {-1, -1};\n+static TokenPipeEnd g_shutdown_r;\n+static TokenPipeEnd g_shutdown_w;\n #endif\n \n bool InitShutdownState()\n {\n #ifndef WIN32\n-#if HAVE_O_CLOEXEC\n-    // If we can, make sure that the file descriptors are closed on exec()\n-    // to prevent interference.\n-    if (pipe2(g_shutdown_pipe, O_CLOEXEC) != 0) {\n-        return false;\n-    }\n-#else\n-    if (pipe(g_shutdown_pipe) != 0) {\n-        return false;\n-    }\n-#endif\n+    std::optional<TokenPipe> pipe = TokenPipe::create();\n+    g_shutdown_r = pipe->ReadEnd();\n+    g_shutdown_w = pipe->WriteEnd();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r578235280",
      "id" : 578235280,
      "in_reply_to_id" : 578007134,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODIzNTI4MA==",
      "original_commit_id" : "581f48d818e17bebe75e24c9d72029e4a0f2e8af",
      "original_line" : 37,
      "original_position" : 37,
      "original_start_line" : 38,
      "path" : "src/shutdown.cpp",
      "position" : null,
      "pull_request_review_id" : 592976710,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578235280",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r578236272"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578236272"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I prefer having a variable here. Having a read as a side effect of an if() clause is kind of meh.\r\nWill change the `true`.",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-02-18T08:53:52Z",
      "diff_hunk" : "@@ -105,24 +187,34 @@ static bool AppInit(int argc, char* argv[])\n             // InitError will have been called with detailed error, which ends up on console\n             return false;\n         }\n-        if (args.GetBoolArg(\"-daemon\", false)) {\n-#if HAVE_DECL_DAEMON\n-#if defined(MAC_OSX)\n-#pragma GCC diagnostic push\n-#pragma GCC diagnostic ignored \"-Wdeprecated-declarations\"\n-#endif\n+        if (args.GetBoolArg(\"-daemon\", DEFAULT_DAEMON) || args.GetBoolArg(\"-daemonwait\", DEFAULT_DAEMONWAIT)) {\n+#if HAVE_DECL_FORK\n             tfm::format(std::cout, PACKAGE_NAME \" starting\\n\");\n \n             // Daemonize\n-            if (daemon(1, 0)) { // don't chdir (1), do close FDs (0)\n-                return InitError(Untranslated(strprintf(\"daemon() failed: %s\\n\", strerror(errno))));\n+            switch (fork_daemon(1, 0, daemon_ep)) { // don't chdir (1), do close FDs (0)\n+                case 0: // Child: continue.\n+                    // If -daemonwait is not enabled, immediately send a success token the parent.\n+                    if (!args.GetBoolArg(\"-daemonwait\", DEFAULT_DAEMONWAIT)) {\n+                        daemon_ep.TokenWrite(1);\n+                        daemon_ep.Close();\n+                    }\n+                    break;\n+                case -1: // Error happened.\n+                    return InitError(Untranslated(strprintf(\"fork_daemon() failed: %s\\n\", strerror(errno))));\n+                default: { // Parent: wait and exit.\n+                        int token = daemon_ep.TokenRead();\n+                        if (token == true) { // fRet == true, Success",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r578236272",
      "id" : 578236272,
      "in_reply_to_id" : 578013255,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODIzNjI3Mg==",
      "original_commit_id" : "48858432bc7ef3e02685b693954173e722bae4e5",
      "original_line" : 207,
      "original_position" : 132,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : null,
      "pull_request_review_id" : 592978037,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578236272",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks again for the review @theStack \r\nPushed https://github.com/bitcoin/bitcoin/compare/48858432bc7ef3e02685b693954173e722bae4e5..652d4e4382e8964db3e1ba6e4bb8247daad7ae64",
      "created_at" : "2021-02-18T12:18:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-781303729",
      "id" : 781303729,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MTMwMzcyOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-18T12:18:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/781303729",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for testing!\r\n\r\n> Should disallow conflict options like -daemon=false -daemonwait=true?\r\n\r\nI'm not sure they're really conflicting (\"enable wait-for-daemon, but don't daemonize\"), though pointless, I see no reason to add a special error message for this.",
      "created_at" : "2021-02-22T12:40:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-783345611",
      "id" : 783345611,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MzM0NTYxMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-22T12:40:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/783345611",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "My point is with `-daemon=false -daemonwait=true` it will daemonize.",
      "created_at" : "2021-02-22T12:51:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-783351622",
      "id" : 783351622,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MzM1MTYyMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-22T12:51:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/783351622",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> My point is with -daemon=false -daemonwait=true it will daemonize.\r\n\r\nOh that's intentional, it means that you can just write `bitcoind -daemonwait` and it will work instead of having to do `bitcoind -daemon -daemonwait`.",
      "created_at" : "2021-02-22T13:12:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-783363821",
      "id" : 783363821,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MzM2MzgyMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-22T13:13:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/783363821",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased for  #21250.",
      "created_at" : "2021-02-23T18:07:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-784396850",
      "id" : 784396850,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4NDM5Njg1MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-23T18:07:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/784396850",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584617352"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584617352"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why are you calling `close(fd)` twice? Shouldn't it be a single `if (fd > 2) close(fd);` as per glibc?",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-01T10:56:14Z",
      "diff_hunk" : "@@ -28,6 +29,79 @@\n const std::function<std::string(const char*)> G_TRANSLATION_FUN = nullptr;\n UrlDecodeFn* const URL_DECODE = urlDecode;\n \n+#if HAVE_DECL_FORK\n+\n+/** Custom implementation of daemon(). This implements the same order of operations as glibc.\n+ * Opens a pipe to the child process to be able to wait for an event to occur.\n+ *\n+ * @returns 0 if succesful, and in child process.\n+ *          >0 if succesful, and in parent process.\n+ *          -1 in case of error (in parent process).\n+ *\n+ *          In case of success, endpoint will be one end of a pipe from the child to parent process,\n+ *          which can be used with TokenWrite (in the child) or TokenRead (in the parent).\n+ */\n+int fork_daemon(bool nochdir, bool noclose, TokenPipeEnd &endpoint)\n+{\n+    // communication pipe with child process\n+    std::optional<TokenPipe> umbilical = TokenPipe::create();\n+    if (!umbilical) {\n+        return -1; // pipe or pipe2 failed.\n+    }\n+\n+    int pid = fork();\n+    if (pid < 0) {\n+        return -1; // fork failed.\n+    }\n+    if (pid != 0) {\n+        // Parent process gets read end, closes write end.\n+        endpoint = umbilical->ReadEnd();\n+        umbilical->WriteEnd();\n+\n+        int status = endpoint.TokenRead();\n+        if (status != 0) { // Something went wrong while setting up child process.\n+            endpoint.Close();\n+            return -1;\n+        }\n+\n+        return pid;\n+    }\n+    // Child process gets write end, closes read end.\n+    endpoint = umbilical->WriteEnd();\n+    umbilical->ReadEnd();\n+\n+#if HAVE_DECL_SETSID\n+    if (setsid() < 0) {\n+        exit(1); // setsid failed.\n+    }\n+#endif\n+\n+    if (!nochdir) {\n+        if (chdir(\"/\") != 0) {\n+            exit(1); // chdir failed.\n+        }\n+    }\n+    if (!noclose) {\n+        // Open /dev/null, and clone it into STDIN, STDOUT and STDERR to detach\n+        // from terminal.\n+        int fd = open(\"/dev/null\", O_RDWR);\n+        if (fd >= 0) {\n+            bool err = dup2(fd, STDIN_FILENO) < 0 || dup2(fd, STDOUT_FILENO) < 0 || dup2(fd, STDERR_FILENO) < 0;\n+            close(fd);\n+            if (err) {\n+                exit(1); // dup2 failed.\n+            }\n+            close(fd);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584617352",
      "id" : 584617352,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDYxNzM1Mg==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 94,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : null,
      "pull_request_review_id" : 600609252,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584617352",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584624966"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584624966"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Calling `umbilical->ReadEnd()` to create the `TokenPipeEnd` then immediately destroy it, which then closes the underlying fd seems a bit clunky. A comment might be worthwhile at least.",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-01T11:07:48Z",
      "diff_hunk" : "@@ -28,6 +29,79 @@\n const std::function<std::string(const char*)> G_TRANSLATION_FUN = nullptr;\n UrlDecodeFn* const URL_DECODE = urlDecode;\n \n+#if HAVE_DECL_FORK\n+\n+/** Custom implementation of daemon(). This implements the same order of operations as glibc.\n+ * Opens a pipe to the child process to be able to wait for an event to occur.\n+ *\n+ * @returns 0 if succesful, and in child process.\n+ *          >0 if succesful, and in parent process.\n+ *          -1 in case of error (in parent process).\n+ *\n+ *          In case of success, endpoint will be one end of a pipe from the child to parent process,\n+ *          which can be used with TokenWrite (in the child) or TokenRead (in the parent).\n+ */\n+int fork_daemon(bool nochdir, bool noclose, TokenPipeEnd &endpoint)\n+{\n+    // communication pipe with child process\n+    std::optional<TokenPipe> umbilical = TokenPipe::create();\n+    if (!umbilical) {\n+        return -1; // pipe or pipe2 failed.\n+    }\n+\n+    int pid = fork();\n+    if (pid < 0) {\n+        return -1; // fork failed.\n+    }\n+    if (pid != 0) {\n+        // Parent process gets read end, closes write end.\n+        endpoint = umbilical->ReadEnd();\n+        umbilical->WriteEnd();\n+\n+        int status = endpoint.TokenRead();\n+        if (status != 0) { // Something went wrong while setting up child process.\n+            endpoint.Close();\n+            return -1;\n+        }\n+\n+        return pid;\n+    }\n+    // Child process gets write end, closes read end.\n+    endpoint = umbilical->WriteEnd();\n+    umbilical->ReadEnd();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584624966",
      "id" : 584624966,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDYyNDk2Ng==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 71,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : null,
      "pull_request_review_id" : 600609252,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584624966",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584631946"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584631946"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this would be incorrect if you had code like: `{ TokenPipe tp; a(); tp.Close(); b(); }` in particular -- the fds would be closed when `Close()` is called, but may be reallocated to different files during `b()` which would then be incorrectly closed when `tp` is destructed.\r\n\r\nCould explicitly set `m_fds = {-1,-1}`, or could drop `Close()` entirely and move the code into the destructor -- it's only called from `operator=(TokenPipe&&)` and you could just mark that as `= deleted;` I think; it doesn't seem to be needed.",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-01T11:19:09Z",
      "diff_hunk" : "@@ -0,0 +1,108 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+#include <util/tokenpipe.h>\n+\n+#include <config/bitcoin-config.h>\n+\n+#ifndef WIN32\n+\n+#include <errno.h>\n+#include <fcntl.h>\n+#include <unistd.h>\n+\n+std::optional<TokenPipe> TokenPipe::create()\n+{\n+    int fds[2] = {-1, -1};\n+#if HAVE_O_CLOEXEC && HAVE_DECL_PIPE2\n+    if (pipe2(fds, O_CLOEXEC) != 0) {\n+        return std::nullopt;\n+    }\n+#else\n+    if (pipe(fds) != 0) {\n+        return std::nullopt;\n+    }\n+#endif\n+    return TokenPipe(fds);\n+}\n+\n+TokenPipe::~TokenPipe()\n+{\n+    Close();\n+}\n+\n+void TokenPipe::Close()\n+{\n+    if (m_fds[0] != -1) close(m_fds[0]);\n+    if (m_fds[1] != -1) close(m_fds[1]);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584631946",
      "id" : 584631946,
      "line" : 37,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDYzMTk0Ng==",
      "original_commit_id" : "45fe328c1b3776f4d6666b2f4f3a6a51501f0f52",
      "original_line" : 37,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/util/tokenpipe.cpp",
      "position" : 37,
      "pull_request_review_id" : 600609252,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584631946",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584638097"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584638097"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Doesn't matter, but net_processing uses `make` as the name for PeerManager's nearly-but-not-quite-a-constructor.",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-01T11:29:35Z",
      "diff_hunk" : "@@ -0,0 +1,108 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+#include <util/tokenpipe.h>\n+\n+#include <config/bitcoin-config.h>\n+\n+#ifndef WIN32\n+\n+#include <errno.h>\n+#include <fcntl.h>\n+#include <unistd.h>\n+\n+std::optional<TokenPipe> TokenPipe::create()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584638097",
      "id" : 584638097,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDYzODA5Nw==",
      "original_commit_id" : "45fe328c1b3776f4d6666b2f4f3a6a51501f0f52",
      "original_line" : 14,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/util/tokenpipe.cpp",
      "position" : null,
      "pull_request_review_id" : 600609252,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584638097",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584641206"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584641206"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit, sort",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-01T11:35:13Z",
      "diff_hunk" : "@@ -240,6 +240,7 @@ BITCOIN_CORE_H = \\\n   util/memory.h \\\n   util/message.h \\\n   util/moneystr.h \\\n+  util/tokenpipe.h \\",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584641206",
      "id" : 584641206,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDY0MTIwNg==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 243,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/Makefile.am",
      "position" : null,
      "pull_request_review_id" : 600639629,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584641206",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584651551"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584651551"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`write` seems to be returning ssize_t / long, same for `read` line 86\r\n```suggestion\r\n        const long result{write(m_fd, &token, 1)};\r\n```",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-01T11:52:59Z",
      "diff_hunk" : "@@ -0,0 +1,108 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+#include <util/tokenpipe.h>\n+\n+#include <config/bitcoin-config.h>\n+\n+#ifndef WIN32\n+\n+#include <errno.h>\n+#include <fcntl.h>\n+#include <unistd.h>\n+\n+std::optional<TokenPipe> TokenPipe::create()\n+{\n+    int fds[2] = {-1, -1};\n+#if HAVE_O_CLOEXEC && HAVE_DECL_PIPE2\n+    if (pipe2(fds, O_CLOEXEC) != 0) {\n+        return std::nullopt;\n+    }\n+#else\n+    if (pipe(fds) != 0) {\n+        return std::nullopt;\n+    }\n+#endif\n+    return TokenPipe(fds);\n+}\n+\n+TokenPipe::~TokenPipe()\n+{\n+    Close();\n+}\n+\n+void TokenPipe::Close()\n+{\n+    if (m_fds[0] != -1) close(m_fds[0]);\n+    if (m_fds[1] != -1) close(m_fds[1]);\n+}\n+\n+TokenPipeEnd TokenPipe::ReadEnd()\n+{\n+    TokenPipeEnd res(m_fds[0]);\n+    m_fds[0] = -1;\n+    return res;\n+}\n+\n+TokenPipeEnd TokenPipe::WriteEnd()\n+{\n+    TokenPipeEnd res(m_fds[1]);\n+    m_fds[1] = -1;\n+    return res;\n+}\n+\n+TokenPipeEnd::TokenPipeEnd(int fd):\n+    m_fd(fd)\n+{\n+}\n+\n+TokenPipeEnd::~TokenPipeEnd()\n+{\n+    Close();\n+}\n+\n+int TokenPipeEnd::TokenWrite(uint8_t token)\n+{\n+    while (true) {\n+        int result = write(m_fd, &token, 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584651551",
      "id" : 584651551,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDY1MTU1MQ==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 67,
      "original_position" : 67,
      "original_start_line" : null,
      "path" : "src/util/tokenpipe.cpp",
      "position" : null,
      "pull_request_review_id" : 600639629,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584651551",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584651985"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584651985"
         }
      },
      "author_association" : "MEMBER",
      "body" : "these two can be `constexpr`",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-01T11:53:42Z",
      "diff_hunk" : "@@ -9,6 +9,11 @@\n #include <memory>\n #include <string>\n \n+//! Default value for -daemon option\n+static const bool DEFAULT_DAEMON = false;\n+//! Default value for -daemonwait option\n+static const bool DEFAULT_DAEMONWAIT = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584651985",
      "id" : 584651985,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDY1MTk4NQ==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 15,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/init.h",
      "position" : null,
      "pull_request_review_id" : 600639629,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584651985",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584652550"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584652550"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`fd` and `err` can be const",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-01T11:54:46Z",
      "diff_hunk" : "@@ -28,6 +29,79 @@\n const std::function<std::string(const char*)> G_TRANSLATION_FUN = nullptr;\n UrlDecodeFn* const URL_DECODE = urlDecode;\n \n+#if HAVE_DECL_FORK\n+\n+/** Custom implementation of daemon(). This implements the same order of operations as glibc.\n+ * Opens a pipe to the child process to be able to wait for an event to occur.\n+ *\n+ * @returns 0 if succesful, and in child process.\n+ *          >0 if succesful, and in parent process.\n+ *          -1 in case of error (in parent process).\n+ *\n+ *          In case of success, endpoint will be one end of a pipe from the child to parent process,\n+ *          which can be used with TokenWrite (in the child) or TokenRead (in the parent).\n+ */\n+int fork_daemon(bool nochdir, bool noclose, TokenPipeEnd &endpoint)\n+{\n+    // communication pipe with child process\n+    std::optional<TokenPipe> umbilical = TokenPipe::create();\n+    if (!umbilical) {\n+        return -1; // pipe or pipe2 failed.\n+    }\n+\n+    int pid = fork();\n+    if (pid < 0) {\n+        return -1; // fork failed.\n+    }\n+    if (pid != 0) {\n+        // Parent process gets read end, closes write end.\n+        endpoint = umbilical->ReadEnd();\n+        umbilical->WriteEnd();\n+\n+        int status = endpoint.TokenRead();\n+        if (status != 0) { // Something went wrong while setting up child process.\n+            endpoint.Close();\n+            return -1;\n+        }\n+\n+        return pid;\n+    }\n+    // Child process gets write end, closes read end.\n+    endpoint = umbilical->WriteEnd();\n+    umbilical->ReadEnd();\n+\n+#if HAVE_DECL_SETSID\n+    if (setsid() < 0) {\n+        exit(1); // setsid failed.\n+    }\n+#endif\n+\n+    if (!nochdir) {\n+        if (chdir(\"/\") != 0) {\n+            exit(1); // chdir failed.\n+        }\n+    }\n+    if (!noclose) {\n+        // Open /dev/null, and clone it into STDIN, STDOUT and STDERR to detach\n+        // from terminal.\n+        int fd = open(\"/dev/null\", O_RDWR);\n+        if (fd >= 0) {\n+            bool err = dup2(fd, STDIN_FILENO) < 0 || dup2(fd, STDOUT_FILENO) < 0 || dup2(fd, STDERR_FILENO) < 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584652550",
      "id" : 584652550,
      "line" : 89,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDY1MjU1MA==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 89,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : 69,
      "pull_request_review_id" : 600639629,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584652550",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584653087"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584653087"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`res` here and line 54 can be const",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-01T11:55:41Z",
      "diff_hunk" : "@@ -96,17 +81,10 @@ void WaitForShutdown()\n     std::unique_lock<std::mutex> lk(g_shutdown_mutex);\n     g_shutdown_cv.wait(lk, [] { return fRequestShutdown.load(); });\n #else\n-    char token;\n-    while (true) {\n-        int result = read(g_shutdown_pipe[0], &token, 1);\n-        if (result < 0) {\n-            // Failure. Check if the read was interrupted by a signal.\n-            // Other errors are unexpected here.\n-            assert(errno == EINTR);\n-        } else {\n-            assert(result == 1);\n-            break;\n-        }\n+    int res = g_shutdown_r.TokenRead();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584653087",
      "id" : 584653087,
      "line" : 84,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDY1MzA4Nw==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 84,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "src/shutdown.cpp",
      "position" : 89,
      "pull_request_review_id" : 600639629,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584653087",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584938135"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584938135"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style-nit, suggested by [clang-format-diff.py](https://github.com/bitcoin/bitcoin/tree/master/contrib/devtools#clang-format-diffpy):\r\n```suggestion\r\nTokenPipeEnd::TokenPipeEnd(int fd)\r\n    : m_fd(fd)\r\n```",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-01T18:09:18Z",
      "diff_hunk" : "@@ -0,0 +1,108 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+#include <util/tokenpipe.h>\n+\n+#include <config/bitcoin-config.h>\n+\n+#ifndef WIN32\n+\n+#include <errno.h>\n+#include <fcntl.h>\n+#include <unistd.h>\n+\n+std::optional<TokenPipe> TokenPipe::create()\n+{\n+    int fds[2] = {-1, -1};\n+#if HAVE_O_CLOEXEC && HAVE_DECL_PIPE2\n+    if (pipe2(fds, O_CLOEXEC) != 0) {\n+        return std::nullopt;\n+    }\n+#else\n+    if (pipe(fds) != 0) {\n+        return std::nullopt;\n+    }\n+#endif\n+    return TokenPipe(fds);\n+}\n+\n+TokenPipe::~TokenPipe()\n+{\n+    Close();\n+}\n+\n+void TokenPipe::Close()\n+{\n+    if (m_fds[0] != -1) close(m_fds[0]);\n+    if (m_fds[1] != -1) close(m_fds[1]);\n+}\n+\n+TokenPipeEnd TokenPipe::ReadEnd()\n+{\n+    TokenPipeEnd res(m_fds[0]);\n+    m_fds[0] = -1;\n+    return res;\n+}\n+\n+TokenPipeEnd TokenPipe::WriteEnd()\n+{\n+    TokenPipeEnd res(m_fds[1]);\n+    m_fds[1] = -1;\n+    return res;\n+}\n+\n+TokenPipeEnd::TokenPipeEnd(int fd):\n+    m_fd(fd)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584938135",
      "id" : 584938135,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDkzODEzNQ==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 55,
      "original_position" : 55,
      "original_start_line" : 54,
      "path" : "src/util/tokenpipe.cpp",
      "position" : null,
      "pull_request_review_id" : 601023934,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584938135",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584939246"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584939246"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style-nit, suggested by [clang-format-diff.py](https://github.com/bitcoin/bitcoin/tree/master/contrib/devtools#clang-format-diffpy):\r\n```suggestion\r\nclass TokenPipeEnd\r\n{\r\nprivate:\r\n    int m_fd = -1;\r\n\r\npublic:\r\n```",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-01T18:10:58Z",
      "diff_hunk" : "@@ -0,0 +1,123 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_TOKENPIPE_H\n+#define BITCOIN_UTIL_TOKENPIPE_H\n+\n+#ifndef WIN32\n+\n+#include <cstdint>\n+#include <optional>\n+\n+/** One end of a token pipe. */\n+class TokenPipeEnd {\n+private:\n+    int m_fd = -1;\n+public:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584939246",
      "id" : 584939246,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDkzOTI0Ng==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 19,
      "original_position" : 17,
      "original_start_line" : 14,
      "path" : "src/util/tokenpipe.h",
      "position" : null,
      "pull_request_review_id" : 601023934,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584939246",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584939998"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584939998"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style-nit, suggested by [clang-format-diff.py](https://github.com/bitcoin/bitcoin/tree/master/contrib/devtools#clang-format-diffpy):\r\n```suggestion\r\n    TokenPipeEnd(const TokenPipeEnd&) = delete;\r\n    TokenPipeEnd& operator=(const TokenPipeEnd&) = delete;\r\n```",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-01T18:11:56Z",
      "diff_hunk" : "@@ -0,0 +1,123 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_TOKENPIPE_H\n+#define BITCOIN_UTIL_TOKENPIPE_H\n+\n+#ifndef WIN32\n+\n+#include <cstdint>\n+#include <optional>\n+\n+/** One end of a token pipe. */\n+class TokenPipeEnd {\n+private:\n+    int m_fd = -1;\n+public:\n+    TokenPipeEnd(int fd = -1);\n+    ~TokenPipeEnd();\n+\n+    /** Return value constants for TokenWrite and TokenRead. */\n+    enum Status {\n+        TS_ERR = -1, //!< I/O error\n+        TS_EOS = -2, //!< Unexpected end of stream\n+    };\n+\n+    /** Write token to endpoint.\n+     *\n+     * @returns 0       If successful.\n+     *          <0 if error:\n+     *            TS_ERR  If an error happened.\n+     *            TS_EOS  If end of stream happened.\n+     */\n+    int TokenWrite(uint8_t token);\n+\n+    /** Read token from endpoint.\n+     *\n+     * @returns >=0     Token value, if successful.\n+     *          <0 if error:\n+     *            TS_ERR  If an error happened.\n+     *            TS_EOS  If end of stream happened.\n+     */\n+    int TokenRead();\n+\n+    /** Explicit close function.\n+     */\n+    void Close();\n+\n+    /** Return whether endpoint is open.\n+     */\n+    bool IsOpen() { return m_fd != -1; }\n+\n+    // Move-only class.\n+    TokenPipeEnd(TokenPipeEnd&& other)\n+    {\n+        m_fd = other.m_fd;\n+        other.m_fd = -1;\n+    }\n+    TokenPipeEnd& operator=(TokenPipeEnd&& other)\n+    {\n+        Close();\n+        m_fd = other.m_fd;\n+        other.m_fd = -1;\n+        return *this;\n+    }\n+    TokenPipeEnd (const TokenPipeEnd&) = delete;\n+    TokenPipeEnd &operator=(const TokenPipeEnd&) = delete;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584939998",
      "id" : 584939998,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDkzOTk5OA==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 67,
      "original_position" : 67,
      "original_start_line" : 66,
      "path" : "src/util/tokenpipe.h",
      "position" : null,
      "pull_request_review_id" : 601023934,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584939998",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584940313"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584940313"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style-nit, suggested by [clang-format-diff.py](https://github.com/bitcoin/bitcoin/tree/master/contrib/devtools#clang-format-diffpy):\r\n```suggestion\r\nclass TokenPipe\r\n{\r\n```",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-01T18:12:25Z",
      "diff_hunk" : "@@ -0,0 +1,123 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_TOKENPIPE_H\n+#define BITCOIN_UTIL_TOKENPIPE_H\n+\n+#ifndef WIN32\n+\n+#include <cstdint>\n+#include <optional>\n+\n+/** One end of a token pipe. */\n+class TokenPipeEnd {\n+private:\n+    int m_fd = -1;\n+public:\n+    TokenPipeEnd(int fd = -1);\n+    ~TokenPipeEnd();\n+\n+    /** Return value constants for TokenWrite and TokenRead. */\n+    enum Status {\n+        TS_ERR = -1, //!< I/O error\n+        TS_EOS = -2, //!< Unexpected end of stream\n+    };\n+\n+    /** Write token to endpoint.\n+     *\n+     * @returns 0       If successful.\n+     *          <0 if error:\n+     *            TS_ERR  If an error happened.\n+     *            TS_EOS  If end of stream happened.\n+     */\n+    int TokenWrite(uint8_t token);\n+\n+    /** Read token from endpoint.\n+     *\n+     * @returns >=0     Token value, if successful.\n+     *          <0 if error:\n+     *            TS_ERR  If an error happened.\n+     *            TS_EOS  If end of stream happened.\n+     */\n+    int TokenRead();\n+\n+    /** Explicit close function.\n+     */\n+    void Close();\n+\n+    /** Return whether endpoint is open.\n+     */\n+    bool IsOpen() { return m_fd != -1; }\n+\n+    // Move-only class.\n+    TokenPipeEnd(TokenPipeEnd&& other)\n+    {\n+        m_fd = other.m_fd;\n+        other.m_fd = -1;\n+    }\n+    TokenPipeEnd& operator=(TokenPipeEnd&& other)\n+    {\n+        Close();\n+        m_fd = other.m_fd;\n+        other.m_fd = -1;\n+        return *this;\n+    }\n+    TokenPipeEnd (const TokenPipeEnd&) = delete;\n+    TokenPipeEnd &operator=(const TokenPipeEnd&) = delete;\n+};\n+\n+/** An interprocess or interthread pipe for sending tokens (one-byte values)\n+ * over.\n+ */\n+class TokenPipe {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584940313",
      "id" : 584940313,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDk0MDMxMw==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 73,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "src/util/tokenpipe.h",
      "position" : null,
      "pull_request_review_id" : 601023934,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584940313",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584940905"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584940905"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style-nit, suggested by [clang-format-diff.py](https://github.com/bitcoin/bitcoin/tree/master/contrib/devtools#clang-format-diffpy):\r\n```suggestion\r\n    TokenPipe(int fds[2]) : m_fds{fds[0], fds[1]} {}\r\n\r\npublic:\r\n```",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-01T18:13:16Z",
      "diff_hunk" : "@@ -0,0 +1,123 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_TOKENPIPE_H\n+#define BITCOIN_UTIL_TOKENPIPE_H\n+\n+#ifndef WIN32\n+\n+#include <cstdint>\n+#include <optional>\n+\n+/** One end of a token pipe. */\n+class TokenPipeEnd {\n+private:\n+    int m_fd = -1;\n+public:\n+    TokenPipeEnd(int fd = -1);\n+    ~TokenPipeEnd();\n+\n+    /** Return value constants for TokenWrite and TokenRead. */\n+    enum Status {\n+        TS_ERR = -1, //!< I/O error\n+        TS_EOS = -2, //!< Unexpected end of stream\n+    };\n+\n+    /** Write token to endpoint.\n+     *\n+     * @returns 0       If successful.\n+     *          <0 if error:\n+     *            TS_ERR  If an error happened.\n+     *            TS_EOS  If end of stream happened.\n+     */\n+    int TokenWrite(uint8_t token);\n+\n+    /** Read token from endpoint.\n+     *\n+     * @returns >=0     Token value, if successful.\n+     *          <0 if error:\n+     *            TS_ERR  If an error happened.\n+     *            TS_EOS  If end of stream happened.\n+     */\n+    int TokenRead();\n+\n+    /** Explicit close function.\n+     */\n+    void Close();\n+\n+    /** Return whether endpoint is open.\n+     */\n+    bool IsOpen() { return m_fd != -1; }\n+\n+    // Move-only class.\n+    TokenPipeEnd(TokenPipeEnd&& other)\n+    {\n+        m_fd = other.m_fd;\n+        other.m_fd = -1;\n+    }\n+    TokenPipeEnd& operator=(TokenPipeEnd&& other)\n+    {\n+        Close();\n+        m_fd = other.m_fd;\n+        other.m_fd = -1;\n+        return *this;\n+    }\n+    TokenPipeEnd (const TokenPipeEnd&) = delete;\n+    TokenPipeEnd &operator=(const TokenPipeEnd&) = delete;\n+};\n+\n+/** An interprocess or interthread pipe for sending tokens (one-byte values)\n+ * over.\n+ */\n+class TokenPipe {\n+private:\n+    int m_fds[2] = {-1, -1};\n+\n+    TokenPipe(int fds[2]): m_fds{fds[0], fds[1]} {}\n+public:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584940905",
      "id" : 584940905,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDk0MDkwNQ==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 82,
      "original_position" : 78,
      "original_start_line" : 77,
      "path" : "src/util/tokenpipe.h",
      "position" : null,
      "pull_request_review_id" : 601023934,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584940905",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584941276"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584941276"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style-nit, suggested by [clang-format-diff.py](https://github.com/bitcoin/bitcoin/tree/master/contrib/devtools#clang-format-diffpy):\r\n```suggestion\r\n        for (int i = 0; i < 2; ++i) {\r\n```",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-01T18:13:48Z",
      "diff_hunk" : "@@ -0,0 +1,123 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_TOKENPIPE_H\n+#define BITCOIN_UTIL_TOKENPIPE_H\n+\n+#ifndef WIN32\n+\n+#include <cstdint>\n+#include <optional>\n+\n+/** One end of a token pipe. */\n+class TokenPipeEnd {\n+private:\n+    int m_fd = -1;\n+public:\n+    TokenPipeEnd(int fd = -1);\n+    ~TokenPipeEnd();\n+\n+    /** Return value constants for TokenWrite and TokenRead. */\n+    enum Status {\n+        TS_ERR = -1, //!< I/O error\n+        TS_EOS = -2, //!< Unexpected end of stream\n+    };\n+\n+    /** Write token to endpoint.\n+     *\n+     * @returns 0       If successful.\n+     *          <0 if error:\n+     *            TS_ERR  If an error happened.\n+     *            TS_EOS  If end of stream happened.\n+     */\n+    int TokenWrite(uint8_t token);\n+\n+    /** Read token from endpoint.\n+     *\n+     * @returns >=0     Token value, if successful.\n+     *          <0 if error:\n+     *            TS_ERR  If an error happened.\n+     *            TS_EOS  If end of stream happened.\n+     */\n+    int TokenRead();\n+\n+    /** Explicit close function.\n+     */\n+    void Close();\n+\n+    /** Return whether endpoint is open.\n+     */\n+    bool IsOpen() { return m_fd != -1; }\n+\n+    // Move-only class.\n+    TokenPipeEnd(TokenPipeEnd&& other)\n+    {\n+        m_fd = other.m_fd;\n+        other.m_fd = -1;\n+    }\n+    TokenPipeEnd& operator=(TokenPipeEnd&& other)\n+    {\n+        Close();\n+        m_fd = other.m_fd;\n+        other.m_fd = -1;\n+        return *this;\n+    }\n+    TokenPipeEnd (const TokenPipeEnd&) = delete;\n+    TokenPipeEnd &operator=(const TokenPipeEnd&) = delete;\n+};\n+\n+/** An interprocess or interthread pipe for sending tokens (one-byte values)\n+ * over.\n+ */\n+class TokenPipe {\n+private:\n+    int m_fds[2] = {-1, -1};\n+\n+    TokenPipe(int fds[2]): m_fds{fds[0], fds[1]} {}\n+public:\n+    ~TokenPipe();\n+\n+    /** Create a new pipe.\n+     * @returns The created TokenPipe, or an empty std::nullopt in case of error.\n+     */\n+    static std::optional<TokenPipe> create();\n+\n+    /** Get the read end of this pipe. This can only be called once,\n+     * as the object will be moved out.\n+     */\n+    TokenPipeEnd ReadEnd();\n+\n+    /** Get the write end of this pipe. This should only be called once,\n+     * as the object will be moved out.\n+     */\n+    TokenPipeEnd WriteEnd();\n+\n+    /** Close and end of the pipe that hasn't been moved out.\n+     */\n+    void Close();\n+\n+    // Move-only class.\n+    TokenPipe(TokenPipe&& other)\n+    {\n+        for(int i = 0; i < 2; ++i) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584941276",
      "id" : 584941276,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDk0MTI3Ng==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 103,
      "original_position" : 103,
      "original_start_line" : null,
      "path" : "src/util/tokenpipe.h",
      "position" : null,
      "pull_request_review_id" : 601023934,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584941276",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584941408"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584941408"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style-nit, suggested by [clang-format-diff.py](https://github.com/bitcoin/bitcoin/tree/master/contrib/devtools#clang-format-diffpy):\r\n```suggestion\r\n        for (int i = 0; i < 2; ++i) {\r\n```",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-01T18:14:01Z",
      "diff_hunk" : "@@ -0,0 +1,123 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_TOKENPIPE_H\n+#define BITCOIN_UTIL_TOKENPIPE_H\n+\n+#ifndef WIN32\n+\n+#include <cstdint>\n+#include <optional>\n+\n+/** One end of a token pipe. */\n+class TokenPipeEnd {\n+private:\n+    int m_fd = -1;\n+public:\n+    TokenPipeEnd(int fd = -1);\n+    ~TokenPipeEnd();\n+\n+    /** Return value constants for TokenWrite and TokenRead. */\n+    enum Status {\n+        TS_ERR = -1, //!< I/O error\n+        TS_EOS = -2, //!< Unexpected end of stream\n+    };\n+\n+    /** Write token to endpoint.\n+     *\n+     * @returns 0       If successful.\n+     *          <0 if error:\n+     *            TS_ERR  If an error happened.\n+     *            TS_EOS  If end of stream happened.\n+     */\n+    int TokenWrite(uint8_t token);\n+\n+    /** Read token from endpoint.\n+     *\n+     * @returns >=0     Token value, if successful.\n+     *          <0 if error:\n+     *            TS_ERR  If an error happened.\n+     *            TS_EOS  If end of stream happened.\n+     */\n+    int TokenRead();\n+\n+    /** Explicit close function.\n+     */\n+    void Close();\n+\n+    /** Return whether endpoint is open.\n+     */\n+    bool IsOpen() { return m_fd != -1; }\n+\n+    // Move-only class.\n+    TokenPipeEnd(TokenPipeEnd&& other)\n+    {\n+        m_fd = other.m_fd;\n+        other.m_fd = -1;\n+    }\n+    TokenPipeEnd& operator=(TokenPipeEnd&& other)\n+    {\n+        Close();\n+        m_fd = other.m_fd;\n+        other.m_fd = -1;\n+        return *this;\n+    }\n+    TokenPipeEnd (const TokenPipeEnd&) = delete;\n+    TokenPipeEnd &operator=(const TokenPipeEnd&) = delete;\n+};\n+\n+/** An interprocess or interthread pipe for sending tokens (one-byte values)\n+ * over.\n+ */\n+class TokenPipe {\n+private:\n+    int m_fds[2] = {-1, -1};\n+\n+    TokenPipe(int fds[2]): m_fds{fds[0], fds[1]} {}\n+public:\n+    ~TokenPipe();\n+\n+    /** Create a new pipe.\n+     * @returns The created TokenPipe, or an empty std::nullopt in case of error.\n+     */\n+    static std::optional<TokenPipe> create();\n+\n+    /** Get the read end of this pipe. This can only be called once,\n+     * as the object will be moved out.\n+     */\n+    TokenPipeEnd ReadEnd();\n+\n+    /** Get the write end of this pipe. This should only be called once,\n+     * as the object will be moved out.\n+     */\n+    TokenPipeEnd WriteEnd();\n+\n+    /** Close and end of the pipe that hasn't been moved out.\n+     */\n+    void Close();\n+\n+    // Move-only class.\n+    TokenPipe(TokenPipe&& other)\n+    {\n+        for(int i = 0; i < 2; ++i) {\n+            m_fds[i] = other.m_fds[i];\n+            other.m_fds[i] = -1;\n+        }\n+    }\n+    TokenPipe& operator=(TokenPipe&& other)\n+    {\n+        Close();\n+        for(int i = 0; i < 2; ++i) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584941408",
      "id" : 584941408,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDk0MTQwOA==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 111,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/util/tokenpipe.h",
      "position" : null,
      "pull_request_review_id" : 601023934,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584941408",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584941710"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584941710"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style-nit, suggested by [clang-format-diff.py](https://github.com/bitcoin/bitcoin/tree/master/contrib/devtools#clang-format-diffpy):\r\n```suggestion\r\n    TokenPipe(const TokenPipe&) = delete;\r\n    TokenPipe& operator=(const TokenPipe&) = delete;\r\n```",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-01T18:14:28Z",
      "diff_hunk" : "@@ -0,0 +1,123 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_TOKENPIPE_H\n+#define BITCOIN_UTIL_TOKENPIPE_H\n+\n+#ifndef WIN32\n+\n+#include <cstdint>\n+#include <optional>\n+\n+/** One end of a token pipe. */\n+class TokenPipeEnd {\n+private:\n+    int m_fd = -1;\n+public:\n+    TokenPipeEnd(int fd = -1);\n+    ~TokenPipeEnd();\n+\n+    /** Return value constants for TokenWrite and TokenRead. */\n+    enum Status {\n+        TS_ERR = -1, //!< I/O error\n+        TS_EOS = -2, //!< Unexpected end of stream\n+    };\n+\n+    /** Write token to endpoint.\n+     *\n+     * @returns 0       If successful.\n+     *          <0 if error:\n+     *            TS_ERR  If an error happened.\n+     *            TS_EOS  If end of stream happened.\n+     */\n+    int TokenWrite(uint8_t token);\n+\n+    /** Read token from endpoint.\n+     *\n+     * @returns >=0     Token value, if successful.\n+     *          <0 if error:\n+     *            TS_ERR  If an error happened.\n+     *            TS_EOS  If end of stream happened.\n+     */\n+    int TokenRead();\n+\n+    /** Explicit close function.\n+     */\n+    void Close();\n+\n+    /** Return whether endpoint is open.\n+     */\n+    bool IsOpen() { return m_fd != -1; }\n+\n+    // Move-only class.\n+    TokenPipeEnd(TokenPipeEnd&& other)\n+    {\n+        m_fd = other.m_fd;\n+        other.m_fd = -1;\n+    }\n+    TokenPipeEnd& operator=(TokenPipeEnd&& other)\n+    {\n+        Close();\n+        m_fd = other.m_fd;\n+        other.m_fd = -1;\n+        return *this;\n+    }\n+    TokenPipeEnd (const TokenPipeEnd&) = delete;\n+    TokenPipeEnd &operator=(const TokenPipeEnd&) = delete;\n+};\n+\n+/** An interprocess or interthread pipe for sending tokens (one-byte values)\n+ * over.\n+ */\n+class TokenPipe {\n+private:\n+    int m_fds[2] = {-1, -1};\n+\n+    TokenPipe(int fds[2]): m_fds{fds[0], fds[1]} {}\n+public:\n+    ~TokenPipe();\n+\n+    /** Create a new pipe.\n+     * @returns The created TokenPipe, or an empty std::nullopt in case of error.\n+     */\n+    static std::optional<TokenPipe> create();\n+\n+    /** Get the read end of this pipe. This can only be called once,\n+     * as the object will be moved out.\n+     */\n+    TokenPipeEnd ReadEnd();\n+\n+    /** Get the write end of this pipe. This should only be called once,\n+     * as the object will be moved out.\n+     */\n+    TokenPipeEnd WriteEnd();\n+\n+    /** Close and end of the pipe that hasn't been moved out.\n+     */\n+    void Close();\n+\n+    // Move-only class.\n+    TokenPipe(TokenPipe&& other)\n+    {\n+        for(int i = 0; i < 2; ++i) {\n+            m_fds[i] = other.m_fds[i];\n+            other.m_fds[i] = -1;\n+        }\n+    }\n+    TokenPipe& operator=(TokenPipe&& other)\n+    {\n+        Close();\n+        for(int i = 0; i < 2; ++i) {\n+            m_fds[i] = other.m_fds[i];\n+            other.m_fds[i] = -1;\n+        }\n+        return *this;\n+    }\n+    TokenPipe (const TokenPipe&) = delete;\n+    TokenPipe &operator=(const TokenPipe&) = delete;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584941710",
      "id" : 584941710,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDk0MTcxMA==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 118,
      "original_position" : 118,
      "original_start_line" : 117,
      "path" : "src/util/tokenpipe.h",
      "position" : null,
      "pull_request_review_id" : 601023934,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584941710",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584942855"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584942855"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style-nit, suggested by [clang-format-diff.py](https://github.com/bitcoin/bitcoin/tree/master/contrib/devtools#clang-format-diffpy):\r\n```suggestion\r\nint fork_daemon(bool nochdir, bool noclose, TokenPipeEnd& endpoint)\r\n```",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-01T18:16:13Z",
      "diff_hunk" : "@@ -28,6 +29,79 @@\n const std::function<std::string(const char*)> G_TRANSLATION_FUN = nullptr;\n UrlDecodeFn* const URL_DECODE = urlDecode;\n \n+#if HAVE_DECL_FORK\n+\n+/** Custom implementation of daemon(). This implements the same order of operations as glibc.\n+ * Opens a pipe to the child process to be able to wait for an event to occur.\n+ *\n+ * @returns 0 if succesful, and in child process.\n+ *          >0 if succesful, and in parent process.\n+ *          -1 in case of error (in parent process).\n+ *\n+ *          In case of success, endpoint will be one end of a pipe from the child to parent process,\n+ *          which can be used with TokenWrite (in the child) or TokenRead (in the parent).\n+ */\n+int fork_daemon(bool nochdir, bool noclose, TokenPipeEnd &endpoint)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584942855",
      "id" : 584942855,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDk0Mjg1NQ==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 44,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : null,
      "pull_request_review_id" : 601023934,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584942855",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584947020"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584947020"
         }
      },
      "author_association" : "MEMBER",
      "body" : "indentation-nit, suggested by [clang-format-diff.py](https://github.com/bitcoin/bitcoin/tree/master/contrib/devtools#clang-format-diffpy):\r\n```suggestion\r\n            switch (fork_daemon(1, 0, daemon_ep)) { // don't chdir (1), do close FDs (0)\r\n            case 0: // Child: continue.\r\n                // If -daemonwait is not enabled, immediately send a success token the parent.\r\n                if (!args.GetBoolArg(\"-daemonwait\", DEFAULT_DAEMONWAIT)) {\r\n                    daemon_ep.TokenWrite(1);\r\n                    daemon_ep.Close();\r\n                }\r\n                break;\r\n            case -1: // Error happened.\r\n                return InitError(Untranslated(strprintf(\"fork_daemon() failed: %s\\n\", strerror(errno))));\r\n            default: // Parent: wait and exit.\r\n                int token = daemon_ep.TokenRead();\r\n                if (token) { // Success\r\n                    exit(EXIT_SUCCESS);\r\n                } else { // fRet = false or token read error (premature exit).\r\n                    tfm::format(std::cout, \"Error during initializaton - check debug.log for details\\n\");\r\n                    exit(EXIT_FAILURE);\r\n               }\r\n```",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-01T18:22:18Z",
      "diff_hunk" : "@@ -105,24 +187,34 @@ static bool AppInit(int argc, char* argv[])\n             // InitError will have been called with detailed error, which ends up on console\n             return false;\n         }\n-        if (args.GetBoolArg(\"-daemon\", false)) {\n-#if HAVE_DECL_DAEMON\n-#if defined(MAC_OSX)\n-#pragma GCC diagnostic push\n-#pragma GCC diagnostic ignored \"-Wdeprecated-declarations\"\n-#endif\n+        if (args.GetBoolArg(\"-daemon\", DEFAULT_DAEMON) || args.GetBoolArg(\"-daemonwait\", DEFAULT_DAEMONWAIT)) {\n+#if HAVE_DECL_FORK\n             tfm::format(std::cout, PACKAGE_NAME \" starting\\n\");\n \n             // Daemonize\n-            if (daemon(1, 0)) { // don't chdir (1), do close FDs (0)\n-                return InitError(Untranslated(strprintf(\"daemon() failed: %s\\n\", strerror(errno))));\n+            switch (fork_daemon(1, 0, daemon_ep)) { // don't chdir (1), do close FDs (0)\n+                case 0: // Child: continue.\n+                    // If -daemonwait is not enabled, immediately send a success token the parent.\n+                    if (!args.GetBoolArg(\"-daemonwait\", DEFAULT_DAEMONWAIT)) {\n+                        daemon_ep.TokenWrite(1);\n+                        daemon_ep.Close();\n+                    }\n+                    break;\n+                case -1: // Error happened.\n+                    return InitError(Untranslated(strprintf(\"fork_daemon() failed: %s\\n\", strerror(errno))));\n+                default: { // Parent: wait and exit.\n+                        int token = daemon_ep.TokenRead();\n+                        if (token) { // Success\n+                            exit(EXIT_SUCCESS);\n+                        } else { // fRet = false or token read error (premature exit).\n+                            tfm::format(std::cout, \"Error during initializaton - check debug.log for details\\n\");\n+                            exit(EXIT_FAILURE);\n+                        }\n+                    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584947020",
      "id" : 584947020,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDk0NzAyMA==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 213,
      "original_position" : 138,
      "original_start_line" : 195,
      "path" : "src/bitcoind.cpp",
      "position" : null,
      "pull_request_review_id" : 601023934,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584947020",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584948106"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584948106"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Capitalize function name as others?\r\n```suggestion\r\n    static std::optional<TokenPipe> Create();\r\n```",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-01T18:24:01Z",
      "diff_hunk" : "@@ -0,0 +1,123 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_TOKENPIPE_H\n+#define BITCOIN_UTIL_TOKENPIPE_H\n+\n+#ifndef WIN32\n+\n+#include <cstdint>\n+#include <optional>\n+\n+/** One end of a token pipe. */\n+class TokenPipeEnd {\n+private:\n+    int m_fd = -1;\n+public:\n+    TokenPipeEnd(int fd = -1);\n+    ~TokenPipeEnd();\n+\n+    /** Return value constants for TokenWrite and TokenRead. */\n+    enum Status {\n+        TS_ERR = -1, //!< I/O error\n+        TS_EOS = -2, //!< Unexpected end of stream\n+    };\n+\n+    /** Write token to endpoint.\n+     *\n+     * @returns 0       If successful.\n+     *          <0 if error:\n+     *            TS_ERR  If an error happened.\n+     *            TS_EOS  If end of stream happened.\n+     */\n+    int TokenWrite(uint8_t token);\n+\n+    /** Read token from endpoint.\n+     *\n+     * @returns >=0     Token value, if successful.\n+     *          <0 if error:\n+     *            TS_ERR  If an error happened.\n+     *            TS_EOS  If end of stream happened.\n+     */\n+    int TokenRead();\n+\n+    /** Explicit close function.\n+     */\n+    void Close();\n+\n+    /** Return whether endpoint is open.\n+     */\n+    bool IsOpen() { return m_fd != -1; }\n+\n+    // Move-only class.\n+    TokenPipeEnd(TokenPipeEnd&& other)\n+    {\n+        m_fd = other.m_fd;\n+        other.m_fd = -1;\n+    }\n+    TokenPipeEnd& operator=(TokenPipeEnd&& other)\n+    {\n+        Close();\n+        m_fd = other.m_fd;\n+        other.m_fd = -1;\n+        return *this;\n+    }\n+    TokenPipeEnd (const TokenPipeEnd&) = delete;\n+    TokenPipeEnd &operator=(const TokenPipeEnd&) = delete;\n+};\n+\n+/** An interprocess or interthread pipe for sending tokens (one-byte values)\n+ * over.\n+ */\n+class TokenPipe {\n+private:\n+    int m_fds[2] = {-1, -1};\n+\n+    TokenPipe(int fds[2]): m_fds{fds[0], fds[1]} {}\n+public:\n+    ~TokenPipe();\n+\n+    /** Create a new pipe.\n+     * @returns The created TokenPipe, or an empty std::nullopt in case of error.\n+     */\n+    static std::optional<TokenPipe> create();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584948106",
      "id" : 584948106,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDk0ODEwNg==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 84,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "src/util/tokenpipe.h",
      "position" : null,
      "pull_request_review_id" : 601023934,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584948106",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584948457"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584948457"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n#endif // WIN32\r\n```",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-01T18:24:35Z",
      "diff_hunk" : "@@ -0,0 +1,123 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_TOKENPIPE_H\n+#define BITCOIN_UTIL_TOKENPIPE_H\n+\n+#ifndef WIN32\n+\n+#include <cstdint>\n+#include <optional>\n+\n+/** One end of a token pipe. */\n+class TokenPipeEnd {\n+private:\n+    int m_fd = -1;\n+public:\n+    TokenPipeEnd(int fd = -1);\n+    ~TokenPipeEnd();\n+\n+    /** Return value constants for TokenWrite and TokenRead. */\n+    enum Status {\n+        TS_ERR = -1, //!< I/O error\n+        TS_EOS = -2, //!< Unexpected end of stream\n+    };\n+\n+    /** Write token to endpoint.\n+     *\n+     * @returns 0       If successful.\n+     *          <0 if error:\n+     *            TS_ERR  If an error happened.\n+     *            TS_EOS  If end of stream happened.\n+     */\n+    int TokenWrite(uint8_t token);\n+\n+    /** Read token from endpoint.\n+     *\n+     * @returns >=0     Token value, if successful.\n+     *          <0 if error:\n+     *            TS_ERR  If an error happened.\n+     *            TS_EOS  If end of stream happened.\n+     */\n+    int TokenRead();\n+\n+    /** Explicit close function.\n+     */\n+    void Close();\n+\n+    /** Return whether endpoint is open.\n+     */\n+    bool IsOpen() { return m_fd != -1; }\n+\n+    // Move-only class.\n+    TokenPipeEnd(TokenPipeEnd&& other)\n+    {\n+        m_fd = other.m_fd;\n+        other.m_fd = -1;\n+    }\n+    TokenPipeEnd& operator=(TokenPipeEnd&& other)\n+    {\n+        Close();\n+        m_fd = other.m_fd;\n+        other.m_fd = -1;\n+        return *this;\n+    }\n+    TokenPipeEnd (const TokenPipeEnd&) = delete;\n+    TokenPipeEnd &operator=(const TokenPipeEnd&) = delete;\n+};\n+\n+/** An interprocess or interthread pipe for sending tokens (one-byte values)\n+ * over.\n+ */\n+class TokenPipe {\n+private:\n+    int m_fds[2] = {-1, -1};\n+\n+    TokenPipe(int fds[2]): m_fds{fds[0], fds[1]} {}\n+public:\n+    ~TokenPipe();\n+\n+    /** Create a new pipe.\n+     * @returns The created TokenPipe, or an empty std::nullopt in case of error.\n+     */\n+    static std::optional<TokenPipe> create();\n+\n+    /** Get the read end of this pipe. This can only be called once,\n+     * as the object will be moved out.\n+     */\n+    TokenPipeEnd ReadEnd();\n+\n+    /** Get the write end of this pipe. This should only be called once,\n+     * as the object will be moved out.\n+     */\n+    TokenPipeEnd WriteEnd();\n+\n+    /** Close and end of the pipe that hasn't been moved out.\n+     */\n+    void Close();\n+\n+    // Move-only class.\n+    TokenPipe(TokenPipe&& other)\n+    {\n+        for(int i = 0; i < 2; ++i) {\n+            m_fds[i] = other.m_fds[i];\n+            other.m_fds[i] = -1;\n+        }\n+    }\n+    TokenPipe& operator=(TokenPipe&& other)\n+    {\n+        Close();\n+        for(int i = 0; i < 2; ++i) {\n+            m_fds[i] = other.m_fds[i];\n+            other.m_fds[i] = -1;\n+        }\n+        return *this;\n+    }\n+    TokenPipe (const TokenPipe&) = delete;\n+    TokenPipe &operator=(const TokenPipe&) = delete;\n+};\n+\n+#endif",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r584948457",
      "id" : 584948457,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDk0ODQ1Nw==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 121,
      "original_position" : 121,
      "original_start_line" : null,
      "path" : "src/util/tokenpipe.h",
      "position" : null,
      "pull_request_review_id" : 601023934,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584948457",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r585061306"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585061306"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I thought about adding an explicit `CloseReadEnd` `CloseWriteEnd` function but as it'd essentially be the same I didn't do so. Will add a comment.",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-01T21:27:09Z",
      "diff_hunk" : "@@ -28,6 +29,79 @@\n const std::function<std::string(const char*)> G_TRANSLATION_FUN = nullptr;\n UrlDecodeFn* const URL_DECODE = urlDecode;\n \n+#if HAVE_DECL_FORK\n+\n+/** Custom implementation of daemon(). This implements the same order of operations as glibc.\n+ * Opens a pipe to the child process to be able to wait for an event to occur.\n+ *\n+ * @returns 0 if succesful, and in child process.\n+ *          >0 if succesful, and in parent process.\n+ *          -1 in case of error (in parent process).\n+ *\n+ *          In case of success, endpoint will be one end of a pipe from the child to parent process,\n+ *          which can be used with TokenWrite (in the child) or TokenRead (in the parent).\n+ */\n+int fork_daemon(bool nochdir, bool noclose, TokenPipeEnd &endpoint)\n+{\n+    // communication pipe with child process\n+    std::optional<TokenPipe> umbilical = TokenPipe::create();\n+    if (!umbilical) {\n+        return -1; // pipe or pipe2 failed.\n+    }\n+\n+    int pid = fork();\n+    if (pid < 0) {\n+        return -1; // fork failed.\n+    }\n+    if (pid != 0) {\n+        // Parent process gets read end, closes write end.\n+        endpoint = umbilical->ReadEnd();\n+        umbilical->WriteEnd();\n+\n+        int status = endpoint.TokenRead();\n+        if (status != 0) { // Something went wrong while setting up child process.\n+            endpoint.Close();\n+            return -1;\n+        }\n+\n+        return pid;\n+    }\n+    // Child process gets write end, closes read end.\n+    endpoint = umbilical->WriteEnd();\n+    umbilical->ReadEnd();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r585061306",
      "id" : 585061306,
      "in_reply_to_id" : 584624966,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTA2MTMwNg==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 71,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : null,
      "pull_request_review_id" : 601181564,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585061306",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r585062353"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585062353"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Will take a look. Agree the fds should be se to -1 after closing them to prevent 'use fd after close' problems, seems I forgot that. I made it like this to be symmetric with `TokenPipeEnd::Close`. Sure, I could move the code around if minimalism was the goal, but I like a consistent API more.",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-01T21:28:54Z",
      "diff_hunk" : "@@ -0,0 +1,108 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+#include <util/tokenpipe.h>\n+\n+#include <config/bitcoin-config.h>\n+\n+#ifndef WIN32\n+\n+#include <errno.h>\n+#include <fcntl.h>\n+#include <unistd.h>\n+\n+std::optional<TokenPipe> TokenPipe::create()\n+{\n+    int fds[2] = {-1, -1};\n+#if HAVE_O_CLOEXEC && HAVE_DECL_PIPE2\n+    if (pipe2(fds, O_CLOEXEC) != 0) {\n+        return std::nullopt;\n+    }\n+#else\n+    if (pipe(fds) != 0) {\n+        return std::nullopt;\n+    }\n+#endif\n+    return TokenPipe(fds);\n+}\n+\n+TokenPipe::~TokenPipe()\n+{\n+    Close();\n+}\n+\n+void TokenPipe::Close()\n+{\n+    if (m_fds[0] != -1) close(m_fds[0]);\n+    if (m_fds[1] != -1) close(m_fds[1]);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r585062353",
      "id" : 585062353,
      "in_reply_to_id" : 584631946,
      "line" : 37,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTA2MjM1Mw==",
      "original_commit_id" : "45fe328c1b3776f4d6666b2f4f3a6a51501f0f52",
      "original_line" : 37,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/util/tokenpipe.cpp",
      "position" : 37,
      "pull_request_review_id" : 601182877,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585062353",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r585062645"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585062645"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, I'm fine with a different name, `create` is the convention in rust but Make is fine with me too.",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-01T21:29:30Z",
      "diff_hunk" : "@@ -0,0 +1,108 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+#include <util/tokenpipe.h>\n+\n+#include <config/bitcoin-config.h>\n+\n+#ifndef WIN32\n+\n+#include <errno.h>\n+#include <fcntl.h>\n+#include <unistd.h>\n+\n+std::optional<TokenPipe> TokenPipe::create()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r585062645",
      "id" : 585062645,
      "in_reply_to_id" : 584638097,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTA2MjY0NQ==",
      "original_commit_id" : "45fe328c1b3776f4d6666b2f4f3a6a51501f0f52",
      "original_line" : 14,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/util/tokenpipe.cpp",
      "position" : null,
      "pull_request_review_id" : 601183338,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585062645",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r585065011"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585065011"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What if I call the functions `TakeReadEnd` `TakeWriteEnd` would that make it clearer that a move is happening?",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-01T21:33:41Z",
      "diff_hunk" : "@@ -28,6 +29,79 @@\n const std::function<std::string(const char*)> G_TRANSLATION_FUN = nullptr;\n UrlDecodeFn* const URL_DECODE = urlDecode;\n \n+#if HAVE_DECL_FORK\n+\n+/** Custom implementation of daemon(). This implements the same order of operations as glibc.\n+ * Opens a pipe to the child process to be able to wait for an event to occur.\n+ *\n+ * @returns 0 if succesful, and in child process.\n+ *          >0 if succesful, and in parent process.\n+ *          -1 in case of error (in parent process).\n+ *\n+ *          In case of success, endpoint will be one end of a pipe from the child to parent process,\n+ *          which can be used with TokenWrite (in the child) or TokenRead (in the parent).\n+ */\n+int fork_daemon(bool nochdir, bool noclose, TokenPipeEnd &endpoint)\n+{\n+    // communication pipe with child process\n+    std::optional<TokenPipe> umbilical = TokenPipe::create();\n+    if (!umbilical) {\n+        return -1; // pipe or pipe2 failed.\n+    }\n+\n+    int pid = fork();\n+    if (pid < 0) {\n+        return -1; // fork failed.\n+    }\n+    if (pid != 0) {\n+        // Parent process gets read end, closes write end.\n+        endpoint = umbilical->ReadEnd();\n+        umbilical->WriteEnd();\n+\n+        int status = endpoint.TokenRead();\n+        if (status != 0) { // Something went wrong while setting up child process.\n+            endpoint.Close();\n+            return -1;\n+        }\n+\n+        return pid;\n+    }\n+    // Child process gets write end, closes read end.\n+    endpoint = umbilical->WriteEnd();\n+    umbilical->ReadEnd();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r585065011",
      "id" : 585065011,
      "in_reply_to_id" : 584624966,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTA2NTAxMQ==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 71,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : null,
      "pull_request_review_id" : 601186347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585065011",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r585067416"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585067416"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Uhm, good catch, it should only be closed once. I don't think there's a need to compare it to 2.",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-01T21:37:49Z",
      "diff_hunk" : "@@ -28,6 +29,79 @@\n const std::function<std::string(const char*)> G_TRANSLATION_FUN = nullptr;\n UrlDecodeFn* const URL_DECODE = urlDecode;\n \n+#if HAVE_DECL_FORK\n+\n+/** Custom implementation of daemon(). This implements the same order of operations as glibc.\n+ * Opens a pipe to the child process to be able to wait for an event to occur.\n+ *\n+ * @returns 0 if succesful, and in child process.\n+ *          >0 if succesful, and in parent process.\n+ *          -1 in case of error (in parent process).\n+ *\n+ *          In case of success, endpoint will be one end of a pipe from the child to parent process,\n+ *          which can be used with TokenWrite (in the child) or TokenRead (in the parent).\n+ */\n+int fork_daemon(bool nochdir, bool noclose, TokenPipeEnd &endpoint)\n+{\n+    // communication pipe with child process\n+    std::optional<TokenPipe> umbilical = TokenPipe::create();\n+    if (!umbilical) {\n+        return -1; // pipe or pipe2 failed.\n+    }\n+\n+    int pid = fork();\n+    if (pid < 0) {\n+        return -1; // fork failed.\n+    }\n+    if (pid != 0) {\n+        // Parent process gets read end, closes write end.\n+        endpoint = umbilical->ReadEnd();\n+        umbilical->WriteEnd();\n+\n+        int status = endpoint.TokenRead();\n+        if (status != 0) { // Something went wrong while setting up child process.\n+            endpoint.Close();\n+            return -1;\n+        }\n+\n+        return pid;\n+    }\n+    // Child process gets write end, closes read end.\n+    endpoint = umbilical->WriteEnd();\n+    umbilical->ReadEnd();\n+\n+#if HAVE_DECL_SETSID\n+    if (setsid() < 0) {\n+        exit(1); // setsid failed.\n+    }\n+#endif\n+\n+    if (!nochdir) {\n+        if (chdir(\"/\") != 0) {\n+            exit(1); // chdir failed.\n+        }\n+    }\n+    if (!noclose) {\n+        // Open /dev/null, and clone it into STDIN, STDOUT and STDERR to detach\n+        // from terminal.\n+        int fd = open(\"/dev/null\", O_RDWR);\n+        if (fd >= 0) {\n+            bool err = dup2(fd, STDIN_FILENO) < 0 || dup2(fd, STDOUT_FILENO) < 0 || dup2(fd, STDERR_FILENO) < 0;\n+            close(fd);\n+            if (err) {\n+                exit(1); // dup2 failed.\n+            }\n+            close(fd);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r585067416",
      "id" : 585067416,
      "in_reply_to_id" : 584617352,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTA2NzQxNg==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 94,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : null,
      "pull_request_review_id" : 601189388,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585067416",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r585075652"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585075652"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks. FWIW it's fine to just mark one of these and say to run `clang-format-diff`, no need to open a review item for every little indentation/style mismatch :smile:  (as this makes it harder to find the more serious comments)",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-01T21:51:45Z",
      "diff_hunk" : "@@ -0,0 +1,123 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_TOKENPIPE_H\n+#define BITCOIN_UTIL_TOKENPIPE_H\n+\n+#ifndef WIN32\n+\n+#include <cstdint>\n+#include <optional>\n+\n+/** One end of a token pipe. */\n+class TokenPipeEnd {\n+private:\n+    int m_fd = -1;\n+public:\n+    TokenPipeEnd(int fd = -1);\n+    ~TokenPipeEnd();\n+\n+    /** Return value constants for TokenWrite and TokenRead. */\n+    enum Status {\n+        TS_ERR = -1, //!< I/O error\n+        TS_EOS = -2, //!< Unexpected end of stream\n+    };\n+\n+    /** Write token to endpoint.\n+     *\n+     * @returns 0       If successful.\n+     *          <0 if error:\n+     *            TS_ERR  If an error happened.\n+     *            TS_EOS  If end of stream happened.\n+     */\n+    int TokenWrite(uint8_t token);\n+\n+    /** Read token from endpoint.\n+     *\n+     * @returns >=0     Token value, if successful.\n+     *          <0 if error:\n+     *            TS_ERR  If an error happened.\n+     *            TS_EOS  If end of stream happened.\n+     */\n+    int TokenRead();\n+\n+    /** Explicit close function.\n+     */\n+    void Close();\n+\n+    /** Return whether endpoint is open.\n+     */\n+    bool IsOpen() { return m_fd != -1; }\n+\n+    // Move-only class.\n+    TokenPipeEnd(TokenPipeEnd&& other)\n+    {\n+        m_fd = other.m_fd;\n+        other.m_fd = -1;\n+    }\n+    TokenPipeEnd& operator=(TokenPipeEnd&& other)\n+    {\n+        Close();\n+        m_fd = other.m_fd;\n+        other.m_fd = -1;\n+        return *this;\n+    }\n+    TokenPipeEnd (const TokenPipeEnd&) = delete;\n+    TokenPipeEnd &operator=(const TokenPipeEnd&) = delete;\n+};\n+\n+/** An interprocess or interthread pipe for sending tokens (one-byte values)\n+ * over.\n+ */\n+class TokenPipe {\n+private:\n+    int m_fds[2] = {-1, -1};\n+\n+    TokenPipe(int fds[2]): m_fds{fds[0], fds[1]} {}\n+public:\n+    ~TokenPipe();\n+\n+    /** Create a new pipe.\n+     * @returns The created TokenPipe, or an empty std::nullopt in case of error.\n+     */\n+    static std::optional<TokenPipe> create();\n+\n+    /** Get the read end of this pipe. This can only be called once,\n+     * as the object will be moved out.\n+     */\n+    TokenPipeEnd ReadEnd();\n+\n+    /** Get the write end of this pipe. This should only be called once,\n+     * as the object will be moved out.\n+     */\n+    TokenPipeEnd WriteEnd();\n+\n+    /** Close and end of the pipe that hasn't been moved out.\n+     */\n+    void Close();\n+\n+    // Move-only class.\n+    TokenPipe(TokenPipe&& other)\n+    {\n+        for(int i = 0; i < 2; ++i) {\n+            m_fds[i] = other.m_fds[i];\n+            other.m_fds[i] = -1;\n+        }\n+    }\n+    TokenPipe& operator=(TokenPipe&& other)\n+    {\n+        Close();\n+        for(int i = 0; i < 2; ++i) {\n+            m_fds[i] = other.m_fds[i];\n+            other.m_fds[i] = -1;\n+        }\n+        return *this;\n+    }\n+    TokenPipe (const TokenPipe&) = delete;\n+    TokenPipe &operator=(const TokenPipe&) = delete;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r585075652",
      "id" : 585075652,
      "in_reply_to_id" : 584941710,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTA3NTY1Mg==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 118,
      "original_position" : 118,
      "original_start_line" : 117,
      "path" : "src/util/tokenpipe.h",
      "position" : null,
      "pull_request_review_id" : 601199645,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585075652",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r585080051"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585080051"
         }
      },
      "author_association" : "MEMBER",
      "body" : "good catch with the type, not sure though i like the `{}` initialization style more here, `=` seems to express intent clearer",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-01T21:59:09Z",
      "diff_hunk" : "@@ -0,0 +1,108 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+#include <util/tokenpipe.h>\n+\n+#include <config/bitcoin-config.h>\n+\n+#ifndef WIN32\n+\n+#include <errno.h>\n+#include <fcntl.h>\n+#include <unistd.h>\n+\n+std::optional<TokenPipe> TokenPipe::create()\n+{\n+    int fds[2] = {-1, -1};\n+#if HAVE_O_CLOEXEC && HAVE_DECL_PIPE2\n+    if (pipe2(fds, O_CLOEXEC) != 0) {\n+        return std::nullopt;\n+    }\n+#else\n+    if (pipe(fds) != 0) {\n+        return std::nullopt;\n+    }\n+#endif\n+    return TokenPipe(fds);\n+}\n+\n+TokenPipe::~TokenPipe()\n+{\n+    Close();\n+}\n+\n+void TokenPipe::Close()\n+{\n+    if (m_fds[0] != -1) close(m_fds[0]);\n+    if (m_fds[1] != -1) close(m_fds[1]);\n+}\n+\n+TokenPipeEnd TokenPipe::ReadEnd()\n+{\n+    TokenPipeEnd res(m_fds[0]);\n+    m_fds[0] = -1;\n+    return res;\n+}\n+\n+TokenPipeEnd TokenPipe::WriteEnd()\n+{\n+    TokenPipeEnd res(m_fds[1]);\n+    m_fds[1] = -1;\n+    return res;\n+}\n+\n+TokenPipeEnd::TokenPipeEnd(int fd):\n+    m_fd(fd)\n+{\n+}\n+\n+TokenPipeEnd::~TokenPipeEnd()\n+{\n+    Close();\n+}\n+\n+int TokenPipeEnd::TokenWrite(uint8_t token)\n+{\n+    while (true) {\n+        int result = write(m_fd, &token, 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r585080051",
      "id" : 585080051,
      "in_reply_to_id" : 584651551,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTA4MDA1MQ==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 67,
      "original_position" : 67,
      "original_start_line" : null,
      "path" : "src/util/tokenpipe.cpp",
      "position" : null,
      "pull_request_review_id" : 601205109,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585080051",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r585234399"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585234399"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Could also write `umbilical->ReadEnd().Close();` (relying on the destructor's second call to Close then being a no-op). I don't really have a preference.",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-02T04:11:12Z",
      "diff_hunk" : "@@ -28,6 +29,79 @@\n const std::function<std::string(const char*)> G_TRANSLATION_FUN = nullptr;\n UrlDecodeFn* const URL_DECODE = urlDecode;\n \n+#if HAVE_DECL_FORK\n+\n+/** Custom implementation of daemon(). This implements the same order of operations as glibc.\n+ * Opens a pipe to the child process to be able to wait for an event to occur.\n+ *\n+ * @returns 0 if succesful, and in child process.\n+ *          >0 if succesful, and in parent process.\n+ *          -1 in case of error (in parent process).\n+ *\n+ *          In case of success, endpoint will be one end of a pipe from the child to parent process,\n+ *          which can be used with TokenWrite (in the child) or TokenRead (in the parent).\n+ */\n+int fork_daemon(bool nochdir, bool noclose, TokenPipeEnd &endpoint)\n+{\n+    // communication pipe with child process\n+    std::optional<TokenPipe> umbilical = TokenPipe::create();\n+    if (!umbilical) {\n+        return -1; // pipe or pipe2 failed.\n+    }\n+\n+    int pid = fork();\n+    if (pid < 0) {\n+        return -1; // fork failed.\n+    }\n+    if (pid != 0) {\n+        // Parent process gets read end, closes write end.\n+        endpoint = umbilical->ReadEnd();\n+        umbilical->WriteEnd();\n+\n+        int status = endpoint.TokenRead();\n+        if (status != 0) { // Something went wrong while setting up child process.\n+            endpoint.Close();\n+            return -1;\n+        }\n+\n+        return pid;\n+    }\n+    // Child process gets write end, closes read end.\n+    endpoint = umbilical->WriteEnd();\n+    umbilical->ReadEnd();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r585234399",
      "id" : 585234399,
      "in_reply_to_id" : 584624966,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTIzNDM5OQ==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 71,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : null,
      "pull_request_review_id" : 601390392,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585234399",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r585240397"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585240397"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "The standard reason to compare it to 2 is in case you start the executable with stdin/stdout/stderr already closed -- in that case `fd` will be assigned to 0/1/2 because that's the first free fd, `dup2(fd,stdin)` (or out or err) will evaluate to `dup2(0,0)` and be a no-op, and you'll then call `close(0)` which will leave you without a dummied stdin (or out or err) which will mean some later fd you open might overlap with stdin (or out or err). Not sure that things wouldn't already be broken in those cases though -- TokenPipe would probably grab the free fds in that case, and then dup2 would close the TokenPipe fd.",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-02T04:22:46Z",
      "diff_hunk" : "@@ -28,6 +29,79 @@\n const std::function<std::string(const char*)> G_TRANSLATION_FUN = nullptr;\n UrlDecodeFn* const URL_DECODE = urlDecode;\n \n+#if HAVE_DECL_FORK\n+\n+/** Custom implementation of daemon(). This implements the same order of operations as glibc.\n+ * Opens a pipe to the child process to be able to wait for an event to occur.\n+ *\n+ * @returns 0 if succesful, and in child process.\n+ *          >0 if succesful, and in parent process.\n+ *          -1 in case of error (in parent process).\n+ *\n+ *          In case of success, endpoint will be one end of a pipe from the child to parent process,\n+ *          which can be used with TokenWrite (in the child) or TokenRead (in the parent).\n+ */\n+int fork_daemon(bool nochdir, bool noclose, TokenPipeEnd &endpoint)\n+{\n+    // communication pipe with child process\n+    std::optional<TokenPipe> umbilical = TokenPipe::create();\n+    if (!umbilical) {\n+        return -1; // pipe or pipe2 failed.\n+    }\n+\n+    int pid = fork();\n+    if (pid < 0) {\n+        return -1; // fork failed.\n+    }\n+    if (pid != 0) {\n+        // Parent process gets read end, closes write end.\n+        endpoint = umbilical->ReadEnd();\n+        umbilical->WriteEnd();\n+\n+        int status = endpoint.TokenRead();\n+        if (status != 0) { // Something went wrong while setting up child process.\n+            endpoint.Close();\n+            return -1;\n+        }\n+\n+        return pid;\n+    }\n+    // Child process gets write end, closes read end.\n+    endpoint = umbilical->WriteEnd();\n+    umbilical->ReadEnd();\n+\n+#if HAVE_DECL_SETSID\n+    if (setsid() < 0) {\n+        exit(1); // setsid failed.\n+    }\n+#endif\n+\n+    if (!nochdir) {\n+        if (chdir(\"/\") != 0) {\n+            exit(1); // chdir failed.\n+        }\n+    }\n+    if (!noclose) {\n+        // Open /dev/null, and clone it into STDIN, STDOUT and STDERR to detach\n+        // from terminal.\n+        int fd = open(\"/dev/null\", O_RDWR);\n+        if (fd >= 0) {\n+            bool err = dup2(fd, STDIN_FILENO) < 0 || dup2(fd, STDOUT_FILENO) < 0 || dup2(fd, STDERR_FILENO) < 0;\n+            close(fd);\n+            if (err) {\n+                exit(1); // dup2 failed.\n+            }\n+            close(fd);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r585240397",
      "id" : 585240397,
      "in_reply_to_id" : 584617352,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTI0MDM5Nw==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 94,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : null,
      "pull_request_review_id" : 601400771,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585240397",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r585241828"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585241828"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, either way. PeerManager could change too; it was just copied from some stackoverflow link or something.",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-02T04:24:42Z",
      "diff_hunk" : "@@ -0,0 +1,108 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+#include <util/tokenpipe.h>\n+\n+#include <config/bitcoin-config.h>\n+\n+#ifndef WIN32\n+\n+#include <errno.h>\n+#include <fcntl.h>\n+#include <unistd.h>\n+\n+std::optional<TokenPipe> TokenPipe::create()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r585241828",
      "id" : 585241828,
      "in_reply_to_id" : 584638097,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTI0MTgyOA==",
      "original_commit_id" : "45fe328c1b3776f4d6666b2f4f3a6a51501f0f52",
      "original_line" : 14,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/util/tokenpipe.cpp",
      "position" : null,
      "pull_request_review_id" : 601401460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585241828",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r586362501"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586362501"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah yea! I think I'll do both.\r\n```\r\numbilical->TakeReadEnd().Close();\r\n```\r\nFully self-documenting then.",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-03T12:06:43Z",
      "diff_hunk" : "@@ -28,6 +29,79 @@\n const std::function<std::string(const char*)> G_TRANSLATION_FUN = nullptr;\n UrlDecodeFn* const URL_DECODE = urlDecode;\n \n+#if HAVE_DECL_FORK\n+\n+/** Custom implementation of daemon(). This implements the same order of operations as glibc.\n+ * Opens a pipe to the child process to be able to wait for an event to occur.\n+ *\n+ * @returns 0 if succesful, and in child process.\n+ *          >0 if succesful, and in parent process.\n+ *          -1 in case of error (in parent process).\n+ *\n+ *          In case of success, endpoint will be one end of a pipe from the child to parent process,\n+ *          which can be used with TokenWrite (in the child) or TokenRead (in the parent).\n+ */\n+int fork_daemon(bool nochdir, bool noclose, TokenPipeEnd &endpoint)\n+{\n+    // communication pipe with child process\n+    std::optional<TokenPipe> umbilical = TokenPipe::create();\n+    if (!umbilical) {\n+        return -1; // pipe or pipe2 failed.\n+    }\n+\n+    int pid = fork();\n+    if (pid < 0) {\n+        return -1; // fork failed.\n+    }\n+    if (pid != 0) {\n+        // Parent process gets read end, closes write end.\n+        endpoint = umbilical->ReadEnd();\n+        umbilical->WriteEnd();\n+\n+        int status = endpoint.TokenRead();\n+        if (status != 0) { // Something went wrong while setting up child process.\n+            endpoint.Close();\n+            return -1;\n+        }\n+\n+        return pid;\n+    }\n+    // Child process gets write end, closes read end.\n+    endpoint = umbilical->WriteEnd();\n+    umbilical->ReadEnd();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r586362501",
      "id" : 586362501,
      "in_reply_to_id" : 584624966,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjM2MjUwMQ==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 71,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : null,
      "pull_request_review_id" : 602822380,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586362501",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r586366126"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586366126"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Hmm good point. I did not think about that case. It's really unconventional to start binaries with stdin/stdout/stderr closed (the graceful way would be to redirect them to `/dev/null` and I'm not sure we handle this in other places.",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-03T12:12:27Z",
      "diff_hunk" : "@@ -28,6 +29,79 @@\n const std::function<std::string(const char*)> G_TRANSLATION_FUN = nullptr;\n UrlDecodeFn* const URL_DECODE = urlDecode;\n \n+#if HAVE_DECL_FORK\n+\n+/** Custom implementation of daemon(). This implements the same order of operations as glibc.\n+ * Opens a pipe to the child process to be able to wait for an event to occur.\n+ *\n+ * @returns 0 if succesful, and in child process.\n+ *          >0 if succesful, and in parent process.\n+ *          -1 in case of error (in parent process).\n+ *\n+ *          In case of success, endpoint will be one end of a pipe from the child to parent process,\n+ *          which can be used with TokenWrite (in the child) or TokenRead (in the parent).\n+ */\n+int fork_daemon(bool nochdir, bool noclose, TokenPipeEnd &endpoint)\n+{\n+    // communication pipe with child process\n+    std::optional<TokenPipe> umbilical = TokenPipe::create();\n+    if (!umbilical) {\n+        return -1; // pipe or pipe2 failed.\n+    }\n+\n+    int pid = fork();\n+    if (pid < 0) {\n+        return -1; // fork failed.\n+    }\n+    if (pid != 0) {\n+        // Parent process gets read end, closes write end.\n+        endpoint = umbilical->ReadEnd();\n+        umbilical->WriteEnd();\n+\n+        int status = endpoint.TokenRead();\n+        if (status != 0) { // Something went wrong while setting up child process.\n+            endpoint.Close();\n+            return -1;\n+        }\n+\n+        return pid;\n+    }\n+    // Child process gets write end, closes read end.\n+    endpoint = umbilical->WriteEnd();\n+    umbilical->ReadEnd();\n+\n+#if HAVE_DECL_SETSID\n+    if (setsid() < 0) {\n+        exit(1); // setsid failed.\n+    }\n+#endif\n+\n+    if (!nochdir) {\n+        if (chdir(\"/\") != 0) {\n+            exit(1); // chdir failed.\n+        }\n+    }\n+    if (!noclose) {\n+        // Open /dev/null, and clone it into STDIN, STDOUT and STDERR to detach\n+        // from terminal.\n+        int fd = open(\"/dev/null\", O_RDWR);\n+        if (fd >= 0) {\n+            bool err = dup2(fd, STDIN_FILENO) < 0 || dup2(fd, STDOUT_FILENO) < 0 || dup2(fd, STDERR_FILENO) < 0;\n+            close(fd);\n+            if (err) {\n+                exit(1); // dup2 failed.\n+            }\n+            close(fd);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r586366126",
      "id" : 586366126,
      "in_reply_to_id" : 584617352,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjM2NjEyNg==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 94,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : null,
      "pull_request_review_id" : 602827013,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586366126",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r586381946"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586381946"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Strange, I guess I had this module named differently at first :smile: ",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-03T12:37:45Z",
      "diff_hunk" : "@@ -240,6 +240,7 @@ BITCOIN_CORE_H = \\\n   util/memory.h \\\n   util/message.h \\\n   util/moneystr.h \\\n+  util/tokenpipe.h \\",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r586381946",
      "id" : 586381946,
      "in_reply_to_id" : 584641206,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjM4MTk0Ng==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 243,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/Makefile.am",
      "position" : null,
      "pull_request_review_id" : 602847383,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586381946",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r586383949"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586383949"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm not really sure what the common thing is to do for internal variables, do we have a const-unless-required-otherwise recommendation?",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-03T12:41:02Z",
      "diff_hunk" : "@@ -28,6 +29,79 @@\n const std::function<std::string(const char*)> G_TRANSLATION_FUN = nullptr;\n UrlDecodeFn* const URL_DECODE = urlDecode;\n \n+#if HAVE_DECL_FORK\n+\n+/** Custom implementation of daemon(). This implements the same order of operations as glibc.\n+ * Opens a pipe to the child process to be able to wait for an event to occur.\n+ *\n+ * @returns 0 if succesful, and in child process.\n+ *          >0 if succesful, and in parent process.\n+ *          -1 in case of error (in parent process).\n+ *\n+ *          In case of success, endpoint will be one end of a pipe from the child to parent process,\n+ *          which can be used with TokenWrite (in the child) or TokenRead (in the parent).\n+ */\n+int fork_daemon(bool nochdir, bool noclose, TokenPipeEnd &endpoint)\n+{\n+    // communication pipe with child process\n+    std::optional<TokenPipe> umbilical = TokenPipe::create();\n+    if (!umbilical) {\n+        return -1; // pipe or pipe2 failed.\n+    }\n+\n+    int pid = fork();\n+    if (pid < 0) {\n+        return -1; // fork failed.\n+    }\n+    if (pid != 0) {\n+        // Parent process gets read end, closes write end.\n+        endpoint = umbilical->ReadEnd();\n+        umbilical->WriteEnd();\n+\n+        int status = endpoint.TokenRead();\n+        if (status != 0) { // Something went wrong while setting up child process.\n+            endpoint.Close();\n+            return -1;\n+        }\n+\n+        return pid;\n+    }\n+    // Child process gets write end, closes read end.\n+    endpoint = umbilical->WriteEnd();\n+    umbilical->ReadEnd();\n+\n+#if HAVE_DECL_SETSID\n+    if (setsid() < 0) {\n+        exit(1); // setsid failed.\n+    }\n+#endif\n+\n+    if (!nochdir) {\n+        if (chdir(\"/\") != 0) {\n+            exit(1); // chdir failed.\n+        }\n+    }\n+    if (!noclose) {\n+        // Open /dev/null, and clone it into STDIN, STDOUT and STDERR to detach\n+        // from terminal.\n+        int fd = open(\"/dev/null\", O_RDWR);\n+        if (fd >= 0) {\n+            bool err = dup2(fd, STDIN_FILENO) < 0 || dup2(fd, STDOUT_FILENO) < 0 || dup2(fd, STDERR_FILENO) < 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r586383949",
      "id" : 586383949,
      "in_reply_to_id" : 584652550,
      "line" : 89,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjM4Mzk0OQ==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 89,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : 69,
      "pull_request_review_id" : 602849929,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586383949",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r586394972"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586394972"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, I don't think it's explicitly stated, other than maybe via the C++ Code Guidelines linked to in the developer notes, but it's what I've been doing/reviewing, and seeing others say and do.",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-03T12:58:07Z",
      "diff_hunk" : "@@ -28,6 +29,79 @@\n const std::function<std::string(const char*)> G_TRANSLATION_FUN = nullptr;\n UrlDecodeFn* const URL_DECODE = urlDecode;\n \n+#if HAVE_DECL_FORK\n+\n+/** Custom implementation of daemon(). This implements the same order of operations as glibc.\n+ * Opens a pipe to the child process to be able to wait for an event to occur.\n+ *\n+ * @returns 0 if succesful, and in child process.\n+ *          >0 if succesful, and in parent process.\n+ *          -1 in case of error (in parent process).\n+ *\n+ *          In case of success, endpoint will be one end of a pipe from the child to parent process,\n+ *          which can be used with TokenWrite (in the child) or TokenRead (in the parent).\n+ */\n+int fork_daemon(bool nochdir, bool noclose, TokenPipeEnd &endpoint)\n+{\n+    // communication pipe with child process\n+    std::optional<TokenPipe> umbilical = TokenPipe::create();\n+    if (!umbilical) {\n+        return -1; // pipe or pipe2 failed.\n+    }\n+\n+    int pid = fork();\n+    if (pid < 0) {\n+        return -1; // fork failed.\n+    }\n+    if (pid != 0) {\n+        // Parent process gets read end, closes write end.\n+        endpoint = umbilical->ReadEnd();\n+        umbilical->WriteEnd();\n+\n+        int status = endpoint.TokenRead();\n+        if (status != 0) { // Something went wrong while setting up child process.\n+            endpoint.Close();\n+            return -1;\n+        }\n+\n+        return pid;\n+    }\n+    // Child process gets write end, closes read end.\n+    endpoint = umbilical->WriteEnd();\n+    umbilical->ReadEnd();\n+\n+#if HAVE_DECL_SETSID\n+    if (setsid() < 0) {\n+        exit(1); // setsid failed.\n+    }\n+#endif\n+\n+    if (!nochdir) {\n+        if (chdir(\"/\") != 0) {\n+            exit(1); // chdir failed.\n+        }\n+    }\n+    if (!noclose) {\n+        // Open /dev/null, and clone it into STDIN, STDOUT and STDERR to detach\n+        // from terminal.\n+        int fd = open(\"/dev/null\", O_RDWR);\n+        if (fd >= 0) {\n+            bool err = dup2(fd, STDIN_FILENO) < 0 || dup2(fd, STDOUT_FILENO) < 0 || dup2(fd, STDERR_FILENO) < 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r586394972",
      "id" : 586394972,
      "in_reply_to_id" : 584652550,
      "line" : 89,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjM5NDk3Mg==",
      "original_commit_id" : "8e6d339434fdb6cfe5057b60f89ce08101e2eeb0",
      "original_line" : 89,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : 69,
      "pull_request_review_id" : 602864142,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T12:58:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586394972",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@hebasto @jonatack @ajtowns\r\nThanks for the reviews. I have addressed your comments.",
      "created_at" : "2021-03-03T12:58:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-789696470",
      "id" : 789696470,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4OTY5NjQ3MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-03T12:58:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/789696470",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r586564996"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586564996"
         }
      },
      "author_association" : "MEMBER",
      "body" : "b83b386 s/cout/cerr/?",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-03T16:28:23Z",
      "diff_hunk" : "@@ -105,24 +187,34 @@ static bool AppInit(int argc, char* argv[])\n             // InitError will have been called with detailed error, which ends up on console\n             return false;\n         }\n-        if (args.GetBoolArg(\"-daemon\", false)) {\n-#if HAVE_DECL_DAEMON\n-#if defined(MAC_OSX)\n-#pragma GCC diagnostic push\n-#pragma GCC diagnostic ignored \"-Wdeprecated-declarations\"\n-#endif\n+        if (args.GetBoolArg(\"-daemon\", DEFAULT_DAEMON) || args.GetBoolArg(\"-daemonwait\", DEFAULT_DAEMONWAIT)) {\n+#if HAVE_DECL_FORK\n             tfm::format(std::cout, PACKAGE_NAME \" starting\\n\");\n \n             // Daemonize\n-            if (daemon(1, 0)) { // don't chdir (1), do close FDs (0)\n-                return InitError(Untranslated(strprintf(\"daemon() failed: %s\\n\", strerror(errno))));\n+            switch (fork_daemon(1, 0, daemon_ep)) { // don't chdir (1), do close FDs (0)\n+            case 0: // Child: continue.\n+                // If -daemonwait is not enabled, immediately send a success token the parent.\n+                if (!args.GetBoolArg(\"-daemonwait\", DEFAULT_DAEMONWAIT)) {\n+                    daemon_ep.TokenWrite(1);\n+                    daemon_ep.Close();\n+                }\n+                break;\n+            case -1: // Error happened.\n+                return InitError(Untranslated(strprintf(\"fork_daemon() failed: %s\\n\", strerror(errno))));\n+            default: { // Parent: wait and exit.\n+                int token = daemon_ep.TokenRead();\n+                if (token) { // Success\n+                    exit(EXIT_SUCCESS);\n+                } else { // fRet = false or token read error (premature exit).\n+                    tfm::format(std::cout, \"Error during initializaton - check debug.log for details\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r586564996",
      "id" : 586564996,
      "line" : 210,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjU2NDk5Ng==",
      "original_commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "original_line" : 210,
      "original_position" : 135,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : 135,
      "pull_request_review_id" : 603089570,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T16:36:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586564996",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r586567883"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586567883"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0b9994ac\r\n```suggestion\r\n#endif // WIN32\r\n```",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-03T16:31:33Z",
      "diff_hunk" : "@@ -0,0 +1,108 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+#include <util/tokenpipe.h>\n+\n+#include <config/bitcoin-config.h>\n+\n+#ifndef WIN32\n+\n+#include <errno.h>\n+#include <fcntl.h>\n+#include <unistd.h>\n+\n+std::optional<TokenPipe> TokenPipe::Make()\n+{\n+    int fds[2] = {-1, -1};\n+#if HAVE_O_CLOEXEC && HAVE_DECL_PIPE2\n+    if (pipe2(fds, O_CLOEXEC) != 0) {\n+        return std::nullopt;\n+    }\n+#else\n+    if (pipe(fds) != 0) {\n+        return std::nullopt;\n+    }\n+#endif\n+    return TokenPipe(fds);\n+}\n+\n+TokenPipe::~TokenPipe()\n+{\n+    Close();\n+}\n+\n+void TokenPipe::Close()\n+{\n+    if (m_fds[0] != -1) close(m_fds[0]);\n+    if (m_fds[1] != -1) close(m_fds[1]);\n+    m_fds[0] = m_fds[1] = -1;\n+}\n+\n+TokenPipeEnd TokenPipe::TakeReadEnd()\n+{\n+    TokenPipeEnd res(m_fds[0]);\n+    m_fds[0] = -1;\n+    return res;\n+}\n+\n+TokenPipeEnd TokenPipe::TakeWriteEnd()\n+{\n+    TokenPipeEnd res(m_fds[1]);\n+    m_fds[1] = -1;\n+    return res;\n+}\n+\n+TokenPipeEnd::TokenPipeEnd(int fd) : m_fd(fd)\n+{\n+}\n+\n+TokenPipeEnd::~TokenPipeEnd()\n+{\n+    Close();\n+}\n+\n+int TokenPipeEnd::TokenWrite(uint8_t token)\n+{\n+    while (true) {\n+        ssize_t result = write(m_fd, &token, 1);\n+        if (result < 0) {\n+            // Failure. It's possible that the write was interrupted by a signal,\n+            // in that case retry.\n+            if (errno != EINTR) {\n+                return TS_ERR;\n+            }\n+        } else if (result == 0) {\n+            return TS_EOS;\n+        } else { // ==1\n+            return 0;\n+        }\n+    }\n+}\n+\n+int TokenPipeEnd::TokenRead()\n+{\n+    uint8_t token;\n+    while (true) {\n+        ssize_t result = read(m_fd, &token, 1);\n+        if (result < 0) {\n+            // Failure. Check if the read was interrupted by a signal,\n+            // in that case retry.\n+            if (errno != EINTR) {\n+                return TS_ERR;\n+            }\n+        } else if (result == 0) {\n+            return TS_EOS;\n+        } else { // ==1\n+            return token;\n+        }\n+    }\n+    return token;\n+}\n+\n+void TokenPipeEnd::Close()\n+{\n+    if (m_fd != -1) close(m_fd);\n+    m_fd = -1;\n+}\n+\n+#endif",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r586567883",
      "id" : 586567883,
      "line" : 108,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjU2Nzg4Mw==",
      "original_commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "original_line" : 108,
      "original_position" : 108,
      "original_start_line" : null,
      "path" : "src/util/tokenpipe.cpp",
      "position" : 108,
      "pull_request_review_id" : 603089570,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T16:36:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586567883",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r586569854"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586569854"
         }
      },
      "author_association" : "MEMBER",
      "body" : "b83b386c lines 37 and 38: s/succesful/successful/",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-03T16:33:57Z",
      "diff_hunk" : "@@ -28,6 +29,79 @@\n const std::function<std::string(const char*)> G_TRANSLATION_FUN = nullptr;\n UrlDecodeFn* const URL_DECODE = urlDecode;\n \n+#if HAVE_DECL_FORK\n+\n+/** Custom implementation of daemon(). This implements the same order of operations as glibc.\n+ * Opens a pipe to the child process to be able to wait for an event to occur.\n+ *\n+ * @returns 0 if succesful, and in child process.\n+ *          >0 if succesful, and in parent process.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r586569854",
      "id" : 586569854,
      "line" : 38,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjU2OTg1NA==",
      "original_commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "original_line" : 38,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : 18,
      "pull_request_review_id" : 603089570,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T16:36:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586569854",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r586606199"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586606199"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, why not",
      "commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "created_at" : "2021-03-03T17:02:55Z",
      "diff_hunk" : "@@ -105,24 +187,34 @@ static bool AppInit(int argc, char* argv[])\n             // InitError will have been called with detailed error, which ends up on console\n             return false;\n         }\n-        if (args.GetBoolArg(\"-daemon\", false)) {\n-#if HAVE_DECL_DAEMON\n-#if defined(MAC_OSX)\n-#pragma GCC diagnostic push\n-#pragma GCC diagnostic ignored \"-Wdeprecated-declarations\"\n-#endif\n+        if (args.GetBoolArg(\"-daemon\", DEFAULT_DAEMON) || args.GetBoolArg(\"-daemonwait\", DEFAULT_DAEMONWAIT)) {\n+#if HAVE_DECL_FORK\n             tfm::format(std::cout, PACKAGE_NAME \" starting\\n\");\n \n             // Daemonize\n-            if (daemon(1, 0)) { // don't chdir (1), do close FDs (0)\n-                return InitError(Untranslated(strprintf(\"daemon() failed: %s\\n\", strerror(errno))));\n+            switch (fork_daemon(1, 0, daemon_ep)) { // don't chdir (1), do close FDs (0)\n+            case 0: // Child: continue.\n+                // If -daemonwait is not enabled, immediately send a success token the parent.\n+                if (!args.GetBoolArg(\"-daemonwait\", DEFAULT_DAEMONWAIT)) {\n+                    daemon_ep.TokenWrite(1);\n+                    daemon_ep.Close();\n+                }\n+                break;\n+            case -1: // Error happened.\n+                return InitError(Untranslated(strprintf(\"fork_daemon() failed: %s\\n\", strerror(errno))));\n+            default: { // Parent: wait and exit.\n+                int token = daemon_ep.TokenRead();\n+                if (token) { // Success\n+                    exit(EXIT_SUCCESS);\n+                } else { // fRet = false or token read error (premature exit).\n+                    tfm::format(std::cout, \"Error during initializaton - check debug.log for details\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#discussion_r586606199",
      "id" : 586606199,
      "in_reply_to_id" : 586564996,
      "line" : 210,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjYwNjE5OQ==",
      "original_commit_id" : "b83b386c6e03a57f93110dfefdbbf515e62b5753",
      "original_line" : 210,
      "original_position" : 135,
      "original_start_line" : null,
      "path" : "src/bitcoind.cpp",
      "position" : 135,
      "pull_request_review_id" : 603133029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21007",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T17:02:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586606199",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks @jonatack, have addressed the comments and re-pushed\r\n[b83b386c6e03a57f93110dfefdbbf515e62b5753..9a09a494e59b61d7a185da44f9c6736cb536c0c1](https://github.com/bitcoin/bitcoin/compare/b83b386c6e03a57f93110dfefdbbf515e62b5753..9a09a494e59b61d7a185da44f9c6736cb536c0c1)",
      "created_at" : "2021-03-04T14:14:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-790647321",
      "id" : 790647321,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MDY0NzMyMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-04T14:14:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/790647321",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-ACK 9a09a494e59b61d7a185da44f9c6736cb536c0c1",
      "created_at" : "2021-03-04T16:09:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-790731440",
      "id" : 790731440,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MDczMTQ0MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-04T16:09:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/790731440",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Repushed for an ordering issue in `tokenpipe.cpp` reported out-of-band, the implementation file now has same class order as the header\r\n[9a09a494e59b61d7a185da44f9c6736cb536c0c1..e017a913d0d78ef0766cf73586fe7a38488e1a26](https://github.com/bitcoin/bitcoin/compare/9a09a494e59b61d7a185da44f9c6736cb536c0c1..e017a913d0d78ef0766cf73586fe7a38488e1a26)\r\n\r\n",
      "created_at" : "2021-03-04T17:27:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-790790596",
      "id" : 790790596,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MDc5MDU5Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-04T17:27:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/790790596",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Tested ACK e017a913d0d78ef0766cf73586fe7a38488e1a26 checked change since previous review is move-only\r\n\r\n```\r\n$ time ./src/bitcoind -testnet -daemonwait=1 && ./src/bitcoin-cli -testnet stop\r\nBitcoin Core starting\r\n\r\nreal\t1m4.095s\r\nuser\t0m0.132s\r\nsys\t0m0.027s\r\nBitcoin Core stopping\r\n\r\n$ time ./src/bitcoind -testnet -daemonwait=1\r\nBitcoin Core starting\r\n^C \r\nreal\t1m5.311s\r\nuser\t0m0.047s\r\nsys\t0m0.023s\r\n```\r\n",
      "created_at" : "2021-03-04T18:23:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-790828126",
      "id" : 790828126,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MDgyODEyNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-04T18:23:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/790828126",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This change was part of 22.0, removing \"Needs release note\".",
      "created_at" : "2022-09-15T15:14:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21007#issuecomment-1248244044",
      "id" : 1248244044,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21007",
      "node_id" : "IC_kwDOABII585KZrFM",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1248244044/reactions"
      },
      "updated_at" : "2022-09-15T15:14:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1248244044",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   }
]
