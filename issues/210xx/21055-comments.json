[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21270 ([Bundle 4/n] Prune g_chainman usage in validation-adjacent modules by dongcarl)\n* #21090 (Default to NODE_WITNESS in nLocalServices by dhruv)\n* #21009 (Remove RewindBlockIndex logic by dhruv)\n* #20833 (rpc/validation: enable packages through testmempoolaccept by glozow)\n* #20331 (allow -loadblock blocks to be unsorted by LarryRuane)\n* #19573 (Replace unused BIP 9 logic with draft BIP 8 by luke-jr)\n* #19438 (Introduce deploymentstatus by ajtowns)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-02-01T23:42:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#issuecomment-771238834",
      "id" : 771238834,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21055",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3MTIzODgzNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-02T12:21:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/771238834",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r568938343"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568938343"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: Move LoadBlockIndexDB to CChainState\" (fa730f7a871c49072e2e899cefbc8275e5f67057)\r\n\r\nIt seems chainman variable wasn't really needed here, just the chainman.m_blockman member, so this might make more sense as a BlockManager method instead of CChainState method",
      "commit_id" : "e11b6496506246882df450586acf735dabedf731",
      "created_at" : "2021-02-02T21:19:39Z",
      "diff_hunk" : "@@ -4112,11 +4112,12 @@ void BlockManager::Unload() {\n     m_block_index.clear();\n }\n \n-bool static LoadBlockIndexDB(ChainstateManager& chainman, const CChainParams& chainparams) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+bool CChainState::LoadBlockIndexDB(const CChainParams& chainparams) EXCLUSIVE_LOCKS_REQUIRED(cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r568938343",
      "id" : 568938343,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODkzODM0Mw==",
      "original_commit_id" : "fa730f7a871c49072e2e899cefbc8275e5f67057",
      "original_line" : 4146,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 581783245,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T19:56:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568938343",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r568955284"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568955284"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: Pass in spendheight to CTxMemPool::check\" (a765747415aebd432d5feffb6cb609be62e2592b)\r\n\r\nI think it would be nice to delete the BlockManager::GetSpendHeight method entirely instead of adding new calls to it. It's basically a one-line function returning height of active_coins_tip + 1, and it would seem more straightforward to pass active_coins_tip and active_coins_tip height together as arguments to the mempool check method (assuming the check method can't access the height directly) instead of the tip and an offset height.",
      "commit_id" : "e11b6496506246882df450586acf735dabedf731",
      "created_at" : "2021-02-02T21:50:34Z",
      "diff_hunk" : "@@ -3201,7 +3203,10 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::list<CTransactionRef> lRemovedTxn;\n \n         if (AcceptToMemoryPool(::ChainstateActive(), m_mempool, state, ptx, &lRemovedTxn, false /* bypass_limits */)) {\n-            m_mempool.check(&::ChainstateActive().CoinsTip());\n+            CChainState& active_chainstate = m_chainman.ActiveChainstate();\n+            CCoinsViewCache& active_coins_tip = active_chainstate.CoinsTip();\n+            m_mempool.check(&active_coins_tip, active_chainstate.m_blockman.GetSpendHeight(active_coins_tip));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r568955284",
      "id" : 568955284,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODk1NTI4NA==",
      "original_commit_id" : "a765747415aebd432d5feffb6cb609be62e2592b",
      "original_line" : 3271,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 581783245,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T19:56:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/568955284",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r572031775"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572031775"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This global was introduced by d23f6c6. At that commit, the global`VersionBitsTipState`'s unique caller`BIP9SoftForkDesc` didn't require `cs_main` locking. \r\n\r\nThose methods were refactored by 3862e47, where the new `BIP9SoftForkDescPushBack` did require the lock. I think since then this lock has been useless and could have been substituted by an annotation.\r\n\r\nSo not a concern to get rid of them.",
      "commit_id" : "e11b6496506246882df450586acf735dabedf731",
      "created_at" : "2021-02-08T13:06:43Z",
      "diff_hunk" : "@@ -4973,24 +4973,6 @@ CBlockFileInfo* GetBlockFileInfo(size_t n)\n     return &vinfoBlockFile.at(n);\n }\n \n-ThresholdState VersionBitsTipState(const Consensus::Params& params, Consensus::DeploymentPos pos)\n-{\n-    LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r572031775",
      "id" : 572031775,
      "line" : 5014,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjAzMTc3NQ==",
      "original_commit_id" : "a756ecb7bcf3ddc2ff86d2005b6556668f47f988",
      "original_line" : 5014,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 414,
      "pull_request_review_id" : 585478190,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T19:56:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572031775",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r572046550"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572046550"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Shouldn't an assert be added here and before the following invocations ? The `CCoinsViewCache` pointer is used throughout `CTxMemPool::check.",
      "commit_id" : "e11b6496506246882df450586acf735dabedf731",
      "created_at" : "2021-02-08T13:29:57Z",
      "diff_hunk" : "@@ -2243,7 +2243,9 @@ void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n             break;\n         }\n     }\n-    m_mempool.check(&::ChainstateActive().CoinsTip());\n+    CChainState& active_chainstate = m_chainman.ActiveChainstate();\n+    CCoinsViewCache& active_coins_tip = active_chainstate.CoinsTip();\n+    m_mempool.check(&active_coins_tip, active_chainstate.m_blockman.GetSpendHeight(active_coins_tip));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r572046550",
      "id" : 572046550,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjA0NjU1MA==",
      "original_commit_id" : "a765747415aebd432d5feffb6cb609be62e2592b",
      "original_line" : 2307,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 585478190,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T19:56:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572046550",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-02-11T14:04:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#issuecomment-777481629",
      "id" : 777481629,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21055",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NzQ4MTYyOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-11T14:04:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/777481629",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Pushed f5ee2f37742da70d1731508e647dccd9b6035a7c -> eb8f8e42dcca3448ceddb2d774342a524475dd6e\r\n- Rebased on master\r\n\r\n> Note: Have not yet addressed review.",
      "created_at" : "2021-02-18T20:09:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#issuecomment-781604848",
      "id" : 781604848,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21055",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MTYwNDg0OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-18T20:09:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/781604848",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r578720086"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578720086"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Unfortunately we need `setBlockIndexCandidates` which is a member off `CChainState`... If you think `LoadBlockIndexDB` makes more sense logically as a method of `BlockManager` rather than `CChainState` we can pass in the `setBlockIndexCandidates`. Let me know!",
      "commit_id" : "e11b6496506246882df450586acf735dabedf731",
      "created_at" : "2021-02-18T20:19:52Z",
      "diff_hunk" : "@@ -4112,11 +4112,12 @@ void BlockManager::Unload() {\n     m_block_index.clear();\n }\n \n-bool static LoadBlockIndexDB(ChainstateManager& chainman, const CChainParams& chainparams) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+bool CChainState::LoadBlockIndexDB(const CChainParams& chainparams) EXCLUSIVE_LOCKS_REQUIRED(cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r578720086",
      "id" : 578720086,
      "in_reply_to_id" : 568938343,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODcyMDA4Ng==",
      "original_commit_id" : "fa730f7a871c49072e2e899cefbc8275e5f67057",
      "original_line" : 4146,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 593611262,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T19:56:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578720086",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r578727450"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578727450"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not entirely sure what you mean here by an \"offset height\"... Looking at all the uses of `spendheight` in `CTxMemPool::check` it seems that this \"offset height\" is exactly what `CheckInputsAndUpdateCoins` wants?",
      "commit_id" : "e11b6496506246882df450586acf735dabedf731",
      "created_at" : "2021-02-18T20:33:20Z",
      "diff_hunk" : "@@ -3201,7 +3203,10 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::list<CTransactionRef> lRemovedTxn;\n \n         if (AcceptToMemoryPool(::ChainstateActive(), m_mempool, state, ptx, &lRemovedTxn, false /* bypass_limits */)) {\n-            m_mempool.check(&::ChainstateActive().CoinsTip());\n+            CChainState& active_chainstate = m_chainman.ActiveChainstate();\n+            CCoinsViewCache& active_coins_tip = active_chainstate.CoinsTip();\n+            m_mempool.check(&active_coins_tip, active_chainstate.m_blockman.GetSpendHeight(active_coins_tip));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r578727450",
      "id" : 578727450,
      "in_reply_to_id" : 568955284,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODcyNzQ1MA==",
      "original_commit_id" : "a765747415aebd432d5feffb6cb609be62e2592b",
      "original_line" : 3271,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 593621198,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T19:56:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578727450",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Pushed eb8f8e42dcca3448ceddb2d774342a524475dd6e -> 914e9d321608b909f7f8f0442fa64cb425fcd955\r\n- Addressed: https://github.com/bitcoin/bitcoin/pull/21055#discussion_r572046550",
      "created_at" : "2021-02-18T20:48:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#issuecomment-781625212",
      "id" : 781625212,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21055",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MTYyNTIxMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-18T20:48:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/781625212",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r578736168"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578736168"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed in: 52c29d9aedcf8d141b75a6d923a5d5bea53f4079",
      "commit_id" : "e11b6496506246882df450586acf735dabedf731",
      "created_at" : "2021-02-18T20:49:25Z",
      "diff_hunk" : "@@ -2243,7 +2243,9 @@ void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n             break;\n         }\n     }\n-    m_mempool.check(&::ChainstateActive().CoinsTip());\n+    CChainState& active_chainstate = m_chainman.ActiveChainstate();\n+    CCoinsViewCache& active_coins_tip = active_chainstate.CoinsTip();\n+    m_mempool.check(&active_coins_tip, active_chainstate.m_blockman.GetSpendHeight(active_coins_tip));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r578736168",
      "id" : 578736168,
      "in_reply_to_id" : 572046550,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODczNjE2OA==",
      "original_commit_id" : "a765747415aebd432d5feffb6cb609be62e2592b",
      "original_line" : 2307,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 593632657,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T19:56:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/578736168",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. This may need rebase now that #20750 is merged.",
      "created_at" : "2021-02-20T10:47:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#issuecomment-782604784",
      "id" : 782604784,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21055",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MjYwNDc4NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-20T10:47:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/782604784",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@MarcoFalke w/re https://github.com/bitcoin/bitcoin/pull/20750#discussion_r579400663, it seems like making the change would require changing all callers as well (sorta out of scope for this PR), how about we just do the following for now to ensure that the theoretical UB won't happen?\r\n\r\n```diff\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex a66c3d09e3..2bd7046e0f 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -211,6 +211,7 @@ static FlatFileSeq UndoFileSeq();\r\n bool CheckFinalTx(const CBlockIndex* active_chain_tip, const CTransaction &tx, int flags)\r\n {\r\n     AssertLockHeld(cs_main);\r\n+    assert(active_chain_tip); // TODO: Make active_chain_tip a reference\r\n     assert(std::addressof(*::ChainActive().Tip()) == std::addressof(*active_chain_tip));\r\n \r\n     // By convention a negative value for flags indicates that the\r\n```",
      "created_at" : "2021-02-22T16:16:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#issuecomment-783489761",
      "id" : 783489761,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21055",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MzQ4OTc2MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-22T16:16:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/783489761",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Pushed 914e9d321608b909f7f8f0442fa64cb425fcd955 â 1e0d2d83f6ba8761eee4d2b97828e18204804dc3\r\n- Rebased on master",
      "created_at" : "2021-02-22T16:17:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#issuecomment-783490856",
      "id" : 783490856,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21055",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MzQ5MDg1Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-22T16:18:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/783490856",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Pushed 1e0d2d83f6ba8761eee4d2b97828e18204804dc3 â 0bd83b71afd7cd60bca6870ce9428b9fe5bc120e\r\n- Prepended commit 9da106be4db692fa5db7b4de79f9cf7bfef37075 to address https://github.com/bitcoin/bitcoin/pull/20750#discussion_r579400663",
      "created_at" : "2021-02-22T17:20:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#issuecomment-783534045",
      "id" : 783534045,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21055",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4MzUzNDA0NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-22T17:20:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/783534045",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r584304639"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584304639"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Don't split `{` into a new line.",
      "commit_id" : "e11b6496506246882df450586acf735dabedf731",
      "created_at" : "2021-02-28T14:18:57Z",
      "diff_hunk" : "@@ -2445,7 +2449,9 @@ static void UpdateTip(CTxMemPool& mempool, const CBlockIndex* pindexNew, const C\n     }\n \n     bilingual_str warning_messages;\n-    if (!::ChainstateActive().IsInitialBlockDownload()) {\n+    assert(std::addressof(::ChainstateActive()) == std::addressof(active_chainstate));\n+    if (!active_chainstate.IsInitialBlockDownload())\n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r584304639",
      "id" : 584304639,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDMwNDYzOQ==",
      "original_commit_id" : "0bd83b71afd7cd60bca6870ce9428b9fe5bc120e",
      "original_line" : 2454,
      "original_position" : 88,
      "original_start_line" : 2453,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 600264722,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-03T19:56:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584304639",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r584306548"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584306548"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps change this function to be annotated with `EXCLUSIVE_LOCKS_REQUIRED(cs_main)` and assert that cs_main is held, rather than locking cs_main in the first line of the function.\r\n\r\nThis function is always called with cs_main held. Without that guarantee, there's the possibility that one thread calls it with `::ChainstateActive()`, another thread updates the active chainstate, and then this thread asserts on the `std::addressof` check.",
      "commit_id" : "e11b6496506246882df450586acf735dabedf731",
      "created_at" : "2021-02-28T14:33:04Z",
      "diff_hunk" : "@@ -4242,15 +4246,16 @@ CVerifyDB::~CVerifyDB()\n     uiInterface.ShowProgress(\"\", 100, false);\n }\n \n-bool CVerifyDB::VerifyDB(const CChainParams& chainparams, CCoinsView *coinsview, int nCheckLevel, int nCheckDepth)\n+bool CVerifyDB::VerifyDB(const CChainParams& chainparams, CChainState& active_chainstate, CCoinsView *coinsview, int nCheckLevel, int nCheckDepth)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r584306548",
      "id" : 584306548,
      "line" : 4246,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDMwNjU0OA==",
      "original_commit_id" : "0bd83b71afd7cd60bca6870ce9428b9fe5bc120e",
      "original_line" : 4246,
      "original_position" : 296,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 293,
      "pull_request_review_id" : 600264722,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T19:56:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584306548",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r584307383"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584307383"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This function no longer exists. Remove the declaration.",
      "commit_id" : "e11b6496506246882df450586acf735dabedf731",
      "created_at" : "2021-02-28T14:36:33Z",
      "diff_hunk" : "@@ -776,21 +773,14 @@ class CChainState\n     //! Mark a block as not having block data\n     void EraseBlockData(CBlockIndex* index) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n-    friend ChainstateManager;\n-};\n-\n-/** Mark a block as precious and reorganize.\n- *\n- * May not be called in a\n- * validationinterface callback.\n- */\n-bool PreciousBlock(BlockValidationState& state, const CChainParams& params, CBlockIndex *pindex) LOCKS_EXCLUDED(cs_main);\n+    void CheckForkWarningConditions() EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+    void CheckForkWarningConditionsOnNewFork(CBlockIndex* pindexNewForkTip) EXCLUSIVE_LOCKS_REQUIRED(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r584307383",
      "id" : 584307383,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDMwNzM4Mw==",
      "original_commit_id" : "0bd83b71afd7cd60bca6870ce9428b9fe5bc120e",
      "original_line" : 777,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 600264722,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T19:56:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584307383",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r584308221"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584308221"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Remove `EXCLUSIVE_LOCKS_REQUIRED(cs_main)` (which is now on the declaration in validation.h)",
      "commit_id" : "e11b6496506246882df450586acf735dabedf731",
      "created_at" : "2021-02-28T14:42:43Z",
      "diff_hunk" : "@@ -4140,11 +4143,12 @@ void BlockManager::Unload() {\n     m_block_index.clear();\n }\n \n-bool static LoadBlockIndexDB(ChainstateManager& chainman, const CChainParams& chainparams) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+bool CChainState::LoadBlockIndexDB(const CChainParams& chainparams) EXCLUSIVE_LOCKS_REQUIRED(cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r584308221",
      "id" : 584308221,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDMwODIyMQ==",
      "original_commit_id" : "0bd83b71afd7cd60bca6870ce9428b9fe5bc120e",
      "original_line" : 4146,
      "original_position" : 271,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 600264722,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T19:56:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584308221",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r584315503"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584315503"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree with @ryanofsky that the use of `BlockManager::GetSpendHeight()` is quite ugly. We can get the height directly from `::ChainstateActive().m_chain.Height() + 1`.\r\n\r\nI also think it'd be preferable to not have net_processing reach inside validation for the various active chainstate fields, just to call a `check()` function (which defaults to a no-op with default `-mempoolcheck`). Could we perhaps move this call to `CTxMemPool.check()` into `AcceptToMemoryPool()`, so that it's done consistently for all callers, and net_processing doesn't need to concern itself with validation internals?",
      "commit_id" : "e11b6496506246882df450586acf735dabedf731",
      "created_at" : "2021-02-28T15:37:40Z",
      "diff_hunk" : "@@ -3201,7 +3203,10 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::list<CTransactionRef> lRemovedTxn;\n \n         if (AcceptToMemoryPool(::ChainstateActive(), m_mempool, state, ptx, &lRemovedTxn, false /* bypass_limits */)) {\n-            m_mempool.check(&::ChainstateActive().CoinsTip());\n+            CChainState& active_chainstate = m_chainman.ActiveChainstate();\n+            CCoinsViewCache& active_coins_tip = active_chainstate.CoinsTip();\n+            m_mempool.check(&active_coins_tip, active_chainstate.m_blockman.GetSpendHeight(active_coins_tip));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r584315503",
      "id" : 584315503,
      "in_reply_to_id" : 568955284,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDMxNTUwMw==",
      "original_commit_id" : "a765747415aebd432d5feffb6cb609be62e2592b",
      "original_line" : 3271,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 600264722,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T19:56:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/584315503",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Pushed 0bd83b71afd7cd60bca6870ce9428b9fe5bc120e -> ef83bb85507ad9e4e6801aa2197f195e9e42a948\r\n- Addressed some of jnewbery's review comments",
      "created_at" : "2021-03-01T22:59:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#issuecomment-788371769",
      "id" : 788371769,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21055",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4ODM3MTc2OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-01T22:59:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/788371769",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r585112131"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585112131"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed in 4bada76237",
      "commit_id" : "e11b6496506246882df450586acf735dabedf731",
      "created_at" : "2021-03-01T23:00:44Z",
      "diff_hunk" : "@@ -2445,7 +2449,9 @@ static void UpdateTip(CTxMemPool& mempool, const CBlockIndex* pindexNew, const C\n     }\n \n     bilingual_str warning_messages;\n-    if (!::ChainstateActive().IsInitialBlockDownload()) {\n+    assert(std::addressof(::ChainstateActive()) == std::addressof(active_chainstate));\n+    if (!active_chainstate.IsInitialBlockDownload())\n+    {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r585112131",
      "id" : 585112131,
      "in_reply_to_id" : 584304639,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTExMjEzMQ==",
      "original_commit_id" : "0bd83b71afd7cd60bca6870ce9428b9fe5bc120e",
      "original_line" : 2454,
      "original_position" : 88,
      "original_start_line" : 2453,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 601245260,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-03T19:56:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585112131",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r585112410"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585112410"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed in ef83bb8550",
      "commit_id" : "e11b6496506246882df450586acf735dabedf731",
      "created_at" : "2021-03-01T23:01:19Z",
      "diff_hunk" : "@@ -4242,15 +4246,16 @@ CVerifyDB::~CVerifyDB()\n     uiInterface.ShowProgress(\"\", 100, false);\n }\n \n-bool CVerifyDB::VerifyDB(const CChainParams& chainparams, CCoinsView *coinsview, int nCheckLevel, int nCheckDepth)\n+bool CVerifyDB::VerifyDB(const CChainParams& chainparams, CChainState& active_chainstate, CCoinsView *coinsview, int nCheckLevel, int nCheckDepth)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r585112410",
      "id" : 585112410,
      "in_reply_to_id" : 584306548,
      "line" : 4246,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTExMjQxMA==",
      "original_commit_id" : "0bd83b71afd7cd60bca6870ce9428b9fe5bc120e",
      "original_line" : 4246,
      "original_position" : 296,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 293,
      "pull_request_review_id" : 601245580,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T19:56:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585112410",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r585112504"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585112504"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed in: 8b99efbcc0",
      "commit_id" : "e11b6496506246882df450586acf735dabedf731",
      "created_at" : "2021-03-01T23:01:34Z",
      "diff_hunk" : "@@ -776,21 +773,14 @@ class CChainState\n     //! Mark a block as not having block data\n     void EraseBlockData(CBlockIndex* index) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n-    friend ChainstateManager;\n-};\n-\n-/** Mark a block as precious and reorganize.\n- *\n- * May not be called in a\n- * validationinterface callback.\n- */\n-bool PreciousBlock(BlockValidationState& state, const CChainParams& params, CBlockIndex *pindex) LOCKS_EXCLUDED(cs_main);\n+    void CheckForkWarningConditions() EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+    void CheckForkWarningConditionsOnNewFork(CBlockIndex* pindexNewForkTip) EXCLUSIVE_LOCKS_REQUIRED(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r585112504",
      "id" : 585112504,
      "in_reply_to_id" : 584307383,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTExMjUwNA==",
      "original_commit_id" : "0bd83b71afd7cd60bca6870ce9428b9fe5bc120e",
      "original_line" : 777,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 601245711,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T19:56:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585112504",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r585112603"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585112603"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed in 8cdb2f7e58",
      "commit_id" : "e11b6496506246882df450586acf735dabedf731",
      "created_at" : "2021-03-01T23:01:50Z",
      "diff_hunk" : "@@ -4140,11 +4143,12 @@ void BlockManager::Unload() {\n     m_block_index.clear();\n }\n \n-bool static LoadBlockIndexDB(ChainstateManager& chainman, const CChainParams& chainparams) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+bool CChainState::LoadBlockIndexDB(const CChainParams& chainparams) EXCLUSIVE_LOCKS_REQUIRED(cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r585112603",
      "id" : 585112603,
      "in_reply_to_id" : 584308221,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTExMjYwMw==",
      "original_commit_id" : "0bd83b71afd7cd60bca6870ce9428b9fe5bc120e",
      "original_line" : 4146,
      "original_position" : 271,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 601245842,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T19:56:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585112603",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r585113995"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585113995"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm not sure I can easily convince myself that moving this check into `ATMP` is completely safe. However, I do see how this is ugly.\r\n\r\nDo you think the following patch would be an acceptable solution?\r\n\r\n```diff\r\ndiff --git a/src/net_processing.cpp b/src/net_processing.cpp\r\nindex 614a3e0791..022f2e0574 100644\r\n--- a/src/net_processing.cpp\r\n+++ b/src/net_processing.cpp\r\n@@ -2301,10 +2301,7 @@ void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\r\n             break;\r\n         }\r\n     }\r\n-    CChainState& active_chainstate = m_chainman.ActiveChainstate();\r\n-    CCoinsViewCache& active_coins_tip = active_chainstate.CoinsTip();\r\n-    assert(std::addressof(::ChainstateActive().CoinsTip()) == std::addressof(active_coins_tip));\r\n-    m_mempool.check(&active_coins_tip, active_chainstate.m_blockman.GetSpendHeight(active_coins_tip));\r\n+    m_mempool.check(m_chainman.ActiveChainstate());\r\n }\r\n \r\n /**\r\n@@ -3265,10 +3262,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\r\n         const TxValidationState& state = result.m_state;\r\n \r\n         if (result.m_result_type == MempoolAcceptResult::ResultType::VALID) {\r\n-            CChainState& active_chainstate = m_chainman.ActiveChainstate();\r\n-            CCoinsViewCache& active_coins_tip = active_chainstate.CoinsTip();\r\n-            assert(std::addressof(::ChainstateActive().CoinsTip()) == std::addressof(active_coins_tip));\r\n-            m_mempool.check(&active_coins_tip, active_chainstate.m_blockman.GetSpendHeight(active_coins_tip));\r\n+            m_mempool.check(m_chainman.ActiveChainstate());\r\n \r\n             // As this version of the transaction was acceptable, we can forget about any\r\n             // requests for it.\r\ndiff --git a/src/txmempool.cpp b/src/txmempool.cpp\r\nindex 4df7017c47..05902a55c3 100644\r\n--- a/src/txmempool.cpp\r\n+++ b/src/txmempool.cpp\r\n@@ -619,7 +619,7 @@ static void CheckInputsAndUpdateCoins(const CTransaction& tx, CCoinsViewCache& m\r\n     UpdateCoins(tx, mempoolDuplicate, std::numeric_limits<int>::max());\r\n }\r\n \r\n-void CTxMemPool::check(const CCoinsViewCache *pcoins, const int64_t spendheight) const\r\n+void CTxMemPool::check(CChainState& active_chainstate) const\r\n {\r\n     if (m_check_ratio == 0) return;\r\n \r\n@@ -633,7 +633,10 @@ void CTxMemPool::check(const CCoinsViewCache *pcoins, const int64_t spendheight)\r\n     CAmount check_total_fee{0};\r\n     uint64_t innerUsage = 0;\r\n \r\n-    CCoinsViewCache mempoolDuplicate(const_cast<CCoinsViewCache*>(pcoins));\r\n+    CCoinsViewCache& active_coins_tip = active_chainstate.CoinsTip();\r\n+    assert(std::addressof(::ChainstateActive().CoinsTip()) == std::addressof(active_coins_tip)); // TODO: REVIEW-ONLY, REMOVE IN FUTURE COMMIT\r\n+    CCoinsViewCache mempoolDuplicate(const_cast<CCoinsViewCache*>(&active_coins_tip));\r\n+    const int64_t spendheight = active_chainstate.m_chain.Height() + 1;\r\n     assert(g_chainman.m_blockman.GetSpendHeight(mempoolDuplicate) == spendheight); // TODO: REVIEW-ONLY, REMOVE IN FUTURE COMMIT\r\n \r\n     std::list<const CTxMemPoolEntry*> waitingOnDependants;\r\n@@ -655,7 +658,7 @@ void CTxMemPool::check(const CCoinsViewCache *pcoins, const int64_t spendheight)\r\n                 fDependsWait = true;\r\n                 setParentCheck.insert(*it2);\r\n             } else {\r\n-                assert(pcoins->HaveCoin(txin.prevout));\r\n+                assert(active_coins_tip.HaveCoin(txin.prevout));\r\n             }\r\n             // Check whether its inputs are marked in mapNextTx.\r\n             auto it3 = mapNextTx.find(txin.prevout);\r\ndiff --git a/src/txmempool.h b/src/txmempool.h\r\nindex dd82d61fc6..001d856e43 100644\r\n--- a/src/txmempool.h\r\n+++ b/src/txmempool.h\r\n@@ -604,7 +604,7 @@ public:\r\n      * all inputs are in the mapNextTx array). If sanity-checking is turned off,\r\n      * check does nothing.\r\n      */\r\n-    void check(const CCoinsViewCache *pcoins, const int64_t spendheight) const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n+    void check(CChainState& active_chainstate) const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n \r\n     // addUnchecked must updated state for all ancestors of a given transaction,\r\n     // to track size/count of descendant transactions.  First version of\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex 325edc5b6a..ac79dce52e 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -2801,8 +2801,7 @@ bool CChainState::ActivateBestChainStep(BlockValidationState& state, const CChai\r\n         UpdateMempoolForReorg(*this, m_mempool, disconnectpool, true);\r\n     }\r\n \r\n-    CCoinsViewCache& active_coins_tip = CoinsTip();\r\n-    m_mempool.check(&active_coins_tip, m_blockman.GetSpendHeight(active_coins_tip));\r\n+    m_mempool.check(*this);\r\n \r\n     CheckForkWarningConditions();\r\n \r\n```",
      "commit_id" : "e11b6496506246882df450586acf735dabedf731",
      "created_at" : "2021-03-01T23:03:56Z",
      "diff_hunk" : "@@ -3201,7 +3203,10 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::list<CTransactionRef> lRemovedTxn;\n \n         if (AcceptToMemoryPool(::ChainstateActive(), m_mempool, state, ptx, &lRemovedTxn, false /* bypass_limits */)) {\n-            m_mempool.check(&::ChainstateActive().CoinsTip());\n+            CChainState& active_chainstate = m_chainman.ActiveChainstate();\n+            CCoinsViewCache& active_coins_tip = active_chainstate.CoinsTip();\n+            m_mempool.check(&active_coins_tip, active_chainstate.m_blockman.GetSpendHeight(active_coins_tip));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r585113995",
      "id" : 585113995,
      "in_reply_to_id" : 568955284,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTExMzk5NQ==",
      "original_commit_id" : "a765747415aebd432d5feffb6cb609be62e2592b",
      "original_line" : 3271,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 601248065,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T19:56:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585113995",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r585535526"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585535526"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps also add `AssertLockHeld(cs_main)` to the top of the function body?",
      "commit_id" : "e11b6496506246882df450586acf735dabedf731",
      "created_at" : "2021-03-02T12:47:59Z",
      "diff_hunk" : "@@ -4242,15 +4246,16 @@ CVerifyDB::~CVerifyDB()\n     uiInterface.ShowProgress(\"\", 100, false);\n }\n \n-bool CVerifyDB::VerifyDB(const CChainParams& chainparams, CCoinsView *coinsview, int nCheckLevel, int nCheckDepth)\n+bool CVerifyDB::VerifyDB(const CChainParams& chainparams, CChainState& active_chainstate, CCoinsView *coinsview, int nCheckLevel, int nCheckDepth)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r585535526",
      "id" : 585535526,
      "in_reply_to_id" : 584306548,
      "line" : 4246,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTUzNTUyNg==",
      "original_commit_id" : "0bd83b71afd7cd60bca6870ce9428b9fe5bc120e",
      "original_line" : 4246,
      "original_position" : 296,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 293,
      "pull_request_review_id" : 601776827,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T19:56:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585535526",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r585543214"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585543214"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> I'm not sure I can easily convince myself that moving this check into ATMP is completely safe.\r\n\r\nI think you're right to be wary. The call to ATMP from UpdateMempoolForReorg probably can't call `check()`.\r\n\r\nI like your proposed change.",
      "commit_id" : "e11b6496506246882df450586acf735dabedf731",
      "created_at" : "2021-03-02T12:59:24Z",
      "diff_hunk" : "@@ -3201,7 +3203,10 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::list<CTransactionRef> lRemovedTxn;\n \n         if (AcceptToMemoryPool(::ChainstateActive(), m_mempool, state, ptx, &lRemovedTxn, false /* bypass_limits */)) {\n-            m_mempool.check(&::ChainstateActive().CoinsTip());\n+            CChainState& active_chainstate = m_chainman.ActiveChainstate();\n+            CCoinsViewCache& active_coins_tip = active_chainstate.CoinsTip();\n+            m_mempool.check(&active_coins_tip, active_chainstate.m_blockman.GetSpendHeight(active_coins_tip));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r585543214",
      "id" : 585543214,
      "in_reply_to_id" : 568955284,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTU0MzIxNA==",
      "original_commit_id" : "a765747415aebd432d5feffb6cb609be62e2592b",
      "original_line" : 3271,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 601786484,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T19:56:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/585543214",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Changes look good, @dongcarl! I've left a couple more comments.",
      "created_at" : "2021-03-02T12:59:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#issuecomment-788890730",
      "id" : 788890730,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21055",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4ODg5MDczMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-02T12:59:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/788890730",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Pushed ef83bb85507ad9e4e6801aa2197f195e9e42a948 -> e11b6496506246882df450586acf735dabedf731\r\n- Applied https://github.com/bitcoin/bitcoin/pull/21055#discussion_r585113995\r\n- Addressed https://github.com/bitcoin/bitcoin/pull/21055#discussion_r585535526\r\n\r\nThanks jnewbery for your diligent review!",
      "created_at" : "2021-03-03T19:58:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#issuecomment-790015129",
      "id" : 790015129,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21055",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MDAxNTEyOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-03T19:58:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/790015129",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r586736886"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586736886"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed in e11b649650",
      "commit_id" : "e11b6496506246882df450586acf735dabedf731",
      "created_at" : "2021-03-03T19:58:43Z",
      "diff_hunk" : "@@ -4242,15 +4246,16 @@ CVerifyDB::~CVerifyDB()\n     uiInterface.ShowProgress(\"\", 100, false);\n }\n \n-bool CVerifyDB::VerifyDB(const CChainParams& chainparams, CCoinsView *coinsview, int nCheckLevel, int nCheckDepth)\n+bool CVerifyDB::VerifyDB(const CChainParams& chainparams, CChainState& active_chainstate, CCoinsView *coinsview, int nCheckLevel, int nCheckDepth)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r586736886",
      "id" : 586736886,
      "in_reply_to_id" : 584306548,
      "line" : 4246,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjczNjg4Ng==",
      "original_commit_id" : "0bd83b71afd7cd60bca6870ce9428b9fe5bc120e",
      "original_line" : 4246,
      "original_position" : 296,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 293,
      "pull_request_review_id" : 603292986,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T19:58:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586736886",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r586737126"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586737126"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed in 4744efc9ba",
      "commit_id" : "e11b6496506246882df450586acf735dabedf731",
      "created_at" : "2021-03-03T19:59:02Z",
      "diff_hunk" : "@@ -3201,7 +3203,10 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         std::list<CTransactionRef> lRemovedTxn;\n \n         if (AcceptToMemoryPool(::ChainstateActive(), m_mempool, state, ptx, &lRemovedTxn, false /* bypass_limits */)) {\n-            m_mempool.check(&::ChainstateActive().CoinsTip());\n+            CChainState& active_chainstate = m_chainman.ActiveChainstate();\n+            CCoinsViewCache& active_coins_tip = active_chainstate.CoinsTip();\n+            m_mempool.check(&active_coins_tip, active_chainstate.m_blockman.GetSpendHeight(active_coins_tip));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r586737126",
      "id" : 586737126,
      "in_reply_to_id" : 568955284,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NjczNzEyNg==",
      "original_commit_id" : "a765747415aebd432d5feffb6cb609be62e2592b",
      "original_line" : 3271,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 603293259,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-03T19:59:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/586737126",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
         "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dongcarl/followers",
         "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dongcarl",
         "id" : 3445290,
         "login" : "dongcarl",
         "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
         "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
         "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
         "repos_url" : "https://api.github.com/users/dongcarl/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dongcarl"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r588558678"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/588558678"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/21055#discussion_r578720086\r\n\r\n> Unfortunately we need `setBlockIndexCandidates` which is a member off `CChainState`... If you think `LoadBlockIndexDB` makes more sense logically as a method of `BlockManager` rather than `CChainState` we can pass in the `setBlockIndexCandidates`. Let me know!\r\n\r\nThanks, I didn't recognize the `setBlockIndexCandidates` access. Proposed change sounds reasonable, but I don't actually know too much about it and it would seem good to tackle as a followup not changing here.",
      "commit_id" : "e11b6496506246882df450586acf735dabedf731",
      "created_at" : "2021-03-05T18:26:23Z",
      "diff_hunk" : "@@ -4112,11 +4112,12 @@ void BlockManager::Unload() {\n     m_block_index.clear();\n }\n \n-bool static LoadBlockIndexDB(ChainstateManager& chainman, const CChainParams& chainparams) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+bool CChainState::LoadBlockIndexDB(const CChainParams& chainparams) EXCLUSIVE_LOCKS_REQUIRED(cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21055#discussion_r588558678",
      "id" : 588558678,
      "in_reply_to_id" : 568938343,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4ODU1ODY3OA==",
      "original_commit_id" : "fa730f7a871c49072e2e899cefbc8275e5f67057",
      "original_line" : 4146,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 605491136,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21055",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-05T18:26:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/588558678",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
