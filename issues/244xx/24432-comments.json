[
   {
      "author_association" : "MEMBER",
      "body" : "The unit test fails, due to a bug in libc++11 and lower:\r\n\r\n```\r\nerror: in \"fs_tests/create_directories\": exception fs::filesystem_error expected but not raised",
      "created_at" : "2022-02-23T18:03:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24432#issuecomment-1049060318",
      "id" : 1049060318,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24432",
      "node_id" : "IC_kwDOABII584-h2Pe",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1049060318/reactions"
      },
      "updated_at" : "2022-02-23T18:03:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1049060318",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've commented out the failing test for now",
      "created_at" : "2022-02-23T18:08:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24432#issuecomment-1049065246",
      "id" : 1049065246,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24432",
      "node_id" : "IC_kwDOABII584-h3ce",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1049065246/reactions"
      },
      "updated_at" : "2022-02-23T18:08:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1049065246",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "(ci is green now)",
      "created_at" : "2022-03-02T09:07:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24432#issuecomment-1056631557",
      "id" : 1056631557,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24432",
      "node_id" : "IC_kwDOABII584--usF",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1056631557/reactions"
      },
      "updated_at" : "2022-03-02T09:07:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1056631557",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Prefer to actually workaround the bug...? Can't we easily check for it and error on our own?",
      "created_at" : "2022-03-07T22:42:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24432#issuecomment-1061215697",
      "id" : 1061215697,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24432",
      "node_id" : "IC_kwDOABII584_QN3R",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1061215697/reactions"
      },
      "updated_at" : "2022-03-07T22:42:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1061215697",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "It might be possible, but this can be done in a follow-up",
      "created_at" : "2022-03-08T09:09:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24432#issuecomment-1061559298",
      "id" : 1061559298,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24432",
      "node_id" : "IC_kwDOABII584_RhwC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1061559298/reactions"
      },
      "updated_at" : "2022-03-08T09:09:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1061559298",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Well, I can't reproduce the bug (w/ Clang and libc++ 11.0 or 11.1), but this should workaround it:\r\n\r\n```diff\r\ndiff --git a/src/fs.h b/src/fs.h\r\nindex 00b786453c4..c4cd5cd2a28 100644\r\n--- a/src/fs.h\r\n+++ b/src/fs.h\r\n@@ -13,6 +13,7 @@\r\n #include <ios>\r\n #include <ostream>\r\n #include <string>\r\n+#include <system_error>\r\n #include <utility>\r\n \r\n /** Filesystem operations and types */\r\n@@ -149,8 +150,12 @@ static inline path PathFromString(const std::string& string)\r\n  */\r\n static inline bool create_directories(const std::filesystem::path& p)\r\n {\r\n-    if (std::filesystem::is_symlink(p) && std::filesystem::is_directory(p)) {\r\n-        return false;\r\n+    if (std::filesystem::is_symlink(p)) {\r\n+        if (std::filesystem::is_directory(p)) {\r\n+            return false;\r\n+        } else if (!std::filesystem::exists(p)) {\r\n+            throw std::filesystem::filesystem_error(\"cannot create directories\", p, std::make_error_code(std::errc::not_a_directory));\r\n+        }\r\n     }\r\n     return std::filesystem::create_directories(p);\r\n }\r\n\r\n```",
      "created_at" : "2022-03-11T06:06:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24432#issuecomment-1064803098",
      "id" : 1064803098,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24432",
      "node_id" : "IC_kwDOABII584_d5sa",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1064803098/reactions"
      },
      "updated_at" : "2022-03-11T06:06:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1064803098",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24432#discussion_r894220461"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24432"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/894220461"
         }
      },
      "author_association" : "MEMBER",
      "body" : "for reference, the bug still exists and can be reproduced on (for example) Ubuntu Jammy clang-11:\r\n\r\n```\r\n# clang-11 --version \r\nUbuntu clang version 11.1.0-6\r\nTarget: x86_64-pc-linux-gnu\r\nThread model: posix\r\nInstalledDir: /usr/bin\r\n\r\n# ./src/test/test_bitcoin -t fs_tests\r\nRunning 5 test cases...\r\ntest/fs_tests.cpp(180): error: in \"fs_tests/create_directories\": exception fs::filesystem_error expected but not raised\r\n\r\n*** 1 failure is detected in the test module \"Bitcoin Core Test Suite\"\r\n",
      "commit_id" : "fa47f9db471dac76c1eebb4ae2c0e7d04acc4365",
      "created_at" : "2022-06-10T07:12:09Z",
      "diff_hunk" : "@@ -171,8 +171,14 @@ BOOST_AUTO_TEST_CASE(create_directories)\n     BOOST_CHECK(fs::is_directory(symlink));\n     BOOST_CHECK(!fs::create_directories(symlink));\n \n-    fs::remove(symlink);\n     fs::remove(dir);\n+    BOOST_CHECK(!fs::exists(symlink));\n+    BOOST_CHECK(fs::is_symlink(symlink));\n+    BOOST_CHECK(!fs::is_directory(symlink));\n+    // Next check is disabled due to a bug in libc++-11\n+    // See https://github.com/bitcoin/bitcoin/pull/24432#issuecomment-1049060318\n+    // BOOST_CHECK_THROW(fs::create_directories(symlink), fs::filesystem_error);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24432#discussion_r894220461",
      "id" : 894220461,
      "line" : 180,
      "node_id" : "PRRC_kwDOABII5841TLit",
      "original_commit_id" : "fa47f9db471dac76c1eebb4ae2c0e7d04acc4365",
      "original_line" : 180,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/test/fs_tests.cpp",
      "position" : 11,
      "pull_request_review_id" : 1002340885,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24432",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/894220461/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-10T07:12:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/894220461",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
