{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "Part of: #24303\r\nDepends on: #24322\r\n\r\nThe `GetUTXOStats` function has 2 codepaths:\r\n  - One which queries the `CoinStatsIndex` for the UTXO hash\r\n  - One which actually performs the hashing\r\n\r\nFor `libbitcoinkernel`, the only place where we call `GetUTXOStats` is in `PopulateAndValidateSnapshots`, which uses the `SHA256D` hash, and is therefore unable to use the `CoinStatsIndex` since that only provides `MuHash` hashes. Not that I think indices necessarily belong in `libbitcoinkernel` anyway.\r\n\r\nThis PR separates these 2 aforementioned codepaths of `GetUTXOStats`, uses the hashing codepath in `PopulateAndValidateSnapshots`, and removes the need to link in `index/coinstatsindex.cpp` and `node/coinstats.cpp`.\r\n\r\n-----\r\n\r\nLogistically, this PR:\r\n- Extracts out the `index_requested` and `hash_type` members of `CoinStats`, which served as \"in-params\" to `GetUTXOStats` embedded within the `CoinStats` struct. This allows `CoinStats` to only consist of \"out-param\" members, and be returned by `GetUTXOStats` without needing to be an \"in-out\" param\r\n- Introduce the purely virtual `UTXOHashers` class, with 3 implementations: `SHA256DHasher`, `MuHashHasher`, and `NullHasher`. These replace the existing template-based polymorphism.\r\n- Split `GetUTXOStats` into:\r\n    - `GetUTXOStatsWithHasher(UTXOHasher&, ...)`, and\r\n    - `GetUTXOStatsWithIndex(CoinStatsIndex&, ...)`\r\n- Use `GetUTXOStatsWithHasher` directly where appropriate (`src/validation.cpp` and `src/fuzz`)\r\n- Move `GetUTXOStats` to `rpc/blockchain`, which is the only place that depends on `GetUTXOStats`'s weird fallback behaviour\r\n- Move `GetUTXOStatsWithIndex` to `index/coinstatsindex`\r\n\r\nCode organization:\r\n- `src/`\r\n  - `kernel/` â only contains the hashing codepath\r\n    - `coinstats.cpp` â hashing codepath implementations\r\n    - `coinstats.h` â internal header (this is what the rest of Bitcoin Core can use)\r\n    - `include/coinstats.h` â \"public header\" (this is what users of libbitcoinkernel can program against)\r\n  - `index/` â only contains the index codepath\r\n    - `coinstatsindex.cpp` â index codepath implementations\r\n    - `coinstatsindex.h`\r\n  - `validation.cpp` â only uses the hashing codepath\r\n  - `rpc/blockchain.cpp` â uses both the hashing and index codepath, old `GetUTXOStats` fallback logic moved here as static\r\n  - `test/fuzz/coins_view.cpp` â only uses the hashing codepath\r\n\r\n\r\nTODOs:\r\n- [ ] Commit messages could be fleshed out more\r\n\r\nWould love any feedback!",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 0,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24410/comments",
   "created_at" : "2022-02-21T22:16:08Z",
   "draft" : true,
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24410/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/24410",
   "id" : 1146268991,
   "labels" : [],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24410/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "PR_kwDOABII584zQLtw",
   "number" : 24410,
   "performed_via_github_app" : null,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/24410.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24410",
      "merged_at" : null,
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/24410.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24410"
   },
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24410/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24410/timeline",
   "title" : "[kernel 2a/n] Split hashing/index `GetUTXOStats` codepaths, decouple from `coinstatsindex`",
   "updated_at" : "2022-02-21T22:23:04Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24410",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/3445290?v=4",
      "events_url" : "https://api.github.com/users/dongcarl/events{/privacy}",
      "followers_url" : "https://api.github.com/users/dongcarl/followers",
      "following_url" : "https://api.github.com/users/dongcarl/following{/other_user}",
      "gists_url" : "https://api.github.com/users/dongcarl/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/dongcarl",
      "id" : 3445290,
      "login" : "dongcarl",
      "node_id" : "MDQ6VXNlcjM0NDUyOTA=",
      "organizations_url" : "https://api.github.com/users/dongcarl/orgs",
      "received_events_url" : "https://api.github.com/users/dongcarl/received_events",
      "repos_url" : "https://api.github.com/users/dongcarl/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/dongcarl/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/dongcarl"
   }
}
