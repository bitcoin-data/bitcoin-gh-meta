[
   {
      "author_association" : "MEMBER",
      "body" : "I would guess that because the signals are subscribed before the rescan (in `CWallet::AttachChain`), when the chain tip changes during rescan,\r\n```\r\nCMainSignals::ChainStateFlushed â CWallet::chainStateFlushed\r\n```\r\nwhich invokes `WriteBestBlock`, even though the rescan doesn't complete.\r\n",
      "created_at" : "2022-03-06T20:06:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/24487#issuecomment-1060030464",
      "id" : 1060030464,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24487",
      "node_id" : "IC_kwDOABII584_LsgA",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1060030464/reactions"
      },
      "updated_at" : "2022-03-06T20:16:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1060030464",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> (...) when the chain tip changes during rescan (...)\r\n\r\nI think that it wouldn't even be necessary that the chain tip changes during the rescan (which would only occasionally cause `chainStateFlushed`), but SIGINT causes the `chainStateFlushed` signal itself during Shutdown.\r\n\r\n",
      "created_at" : "2022-03-06T23:21:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/24487#issuecomment-1060061167",
      "id" : 1060061167,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24487",
      "node_id" : "IC_kwDOABII584_Lz_v",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 1,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1060061167/reactions"
      },
      "updated_at" : "2022-03-06T23:21:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1060061167",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I think that it wouldn't even be necessary that the chain tip changes during the rescan \r\n\r\nGood point! \r\n\r\nI guess, strictly, the signal should only cause a best block update if the last best block matches the last chain tip. But it's more straightforward to implement in terms of a boolean `in_sync` that gets set when already in sync with the chain, or on *successful* rescan. But maybe there's other options as well.\r\n\r\nI haven't looked how the indexes handle this situation.\r\n\r\nEdit: added 23.0 milestone, I think this is a sufficiently serious issue because it might result in perceived (fixable by requesting an explicit rescan) missing funds.",
      "created_at" : "2022-03-07T08:58:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/24487#issuecomment-1060354158",
      "id" : 1060354158,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24487",
      "node_id" : "IC_kwDOABII584_M7hu",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1060354158/reactions"
      },
      "updated_at" : "2022-03-07T09:01:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1060354158",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I haven't looked how the indexes handle this situation.\r\n\r\nI don't know much about the wallet but I recently spent some time looking at index stability in this and similar situations: \r\nThe indexes do pretty much what you suggested, they have a bool `m_synced` and don't process [chainStateFlushed](https://github.com/bitcoin/bitcoin/blob/5e49b2a2529adc737175ebdcbf312635c52b05f6/src/index/base.cpp#L287) or [blockConnected](https://github.com/bitcoin/bitcoin/blob/5e49b2a2529adc737175ebdcbf312635c52b05f6/src/index/base.cpp#L245) callbacks unless synced successfully.\r\n\r\nI could locally reproduce that blocks are skipped if a rescan is aborted and agree that it would be good to fix this.",
      "created_at" : "2022-03-07T14:31:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/24487#issuecomment-1060750175",
      "id" : 1060750175,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24487",
      "node_id" : "IC_kwDOABII584_OcNf",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1060750175/reactions"
      },
      "updated_at" : "2022-03-07T14:31:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1060750175",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Hmm, this is probably a longstanding bug, but worth fixing. It would be good to ignore both flushed and connected notifications while the wallet is syncing. Ignoring connected notifications might be tricky because there could be a race condition where a new block is connected at the of the sync and the notification is ignored. But ignoring flush notifications might be pretty safe and easy since wallet will flush (write best block locator) at the end of rescanning anyway.\r\n\r\nThe best longer term fix for this IMO would be to use `CallFunctionInValidationInterfaceQueue` to register for notifications. Registering for notifications at the correct place in the queue avoids both opposite problems where:\r\n\r\n1. Registering for notifications happens too early so spurious connected and flushed notifications are received during the sync and need to be filtered out.\r\n2. Or registering for notifications happens too late, so connected or flushed notifications are missed at the end of the sync.\r\n\r\n1772a1e4ea9240868efc50ffef46a35078c0da53 from #24230 implements this CallFunctionInValidationInterfaceQueue sync strategy for indexes and #15719 implements it for wallets, but at this point I would probably abandon #15719 or rebase it on #24230.",
      "created_at" : "2022-03-07T19:45:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/24487#issuecomment-1061067584",
      "id" : 1061067584,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24487",
      "node_id" : "IC_kwDOABII584_PptA",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1061067584/reactions"
      },
      "updated_at" : "2022-03-07T19:47:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1061067584",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "While I think we should fix this, it's likely been an issue for a really long time now and so isn't really something that we should try to fix for 23.0.",
      "created_at" : "2022-03-09T16:14:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/24487#issuecomment-1063097325",
      "id" : 1063097325,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24487",
      "node_id" : "IC_kwDOABII584_XZPt",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1063097325/reactions"
      },
      "updated_at" : "2022-03-09T16:14:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1063097325",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Ok, yes, I assumed it was a recent regression, removed the milestone.",
      "created_at" : "2022-03-09T17:47:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/24487#issuecomment-1063193711",
      "id" : 1063193711,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24487",
      "node_id" : "IC_kwDOABII584_Xwxv",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1063193711/reactions"
      },
      "updated_at" : "2022-03-09T17:47:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1063193711",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I opened #24984 to fix this.",
      "created_at" : "2022-04-25T23:59:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/24487#issuecomment-1109152109",
      "id" : 1109152109,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24487",
      "node_id" : "IC_kwDOABII585CHFFt",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1109152109/reactions"
      },
      "updated_at" : "2022-04-25T23:59:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1109152109",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   }
]
