{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "This picks up #19995 in an attempt to solve #21559.\r\n\r\nThe goal of this PR is to mitigate disk filling attacks by temporarily rate limiting `LogPrintf(â¦)`.\r\n\r\nA disk fill attack is an attack where an untrusted party (such as a peer) is able to cheaply make your node log to disk excessively. The excessive logging may fill your disk and thus make your node crash either cleanly (best case: if disk fill rate is relatively slow) or uncleanly (worst case: if disk fill rate is relatively fast).\r\n\r\n## Approach\r\n\r\nThe hourly logging quota is set **per source location**. Every single source location (say net_processing.cpp:418) gets a quota of 1 MB of logging per hour. Logging is only dropped from source locations that exceed the quota.\r\n\r\n- Only logging to disk is rate limited. Logging to console is not rate limited.\r\n- Only `LogPrintf(â¦)` is rate limited. `LogPrint(category, â¦)` (`-debug`) is not rate limited.\r\n- `UpdateTip: new best=[â¦]` is logged using `LogPrintfWithoutRateLimiting(â¦)` to avoid rate limiting. High log volume is expected for that source location during IBD.\r\n- When logging is restarted a tally of how many messages/bytes were dropped is printed.\r\n- Log rate limiting can be disabled with the `-ratelimitlogging` config option.\r\n- All logs will be prefixed with `[*]` if there is at least one source location that is currently being suppressed.\r\n\r\n### Alternatives\r\n\r\nIn a recent [PR Review Club meeting](https://bitcoincore.reviews/21603) we discussed this PR and evaluated alternative approaches.\r\n\r\n<details>\r\n<summary>Global rate limiting </summary>\r\n\r\n#### Global rate limiting\r\n\r\nThere was some discussion around an alternative approach which would be to globally rate limit `LogPrintf(â¦)`.  This approach was implemented in a competing PR #21706. The main point [1] in favor of global rate limiting is that it could be confusing to have incomplete logs when logs from one source location are dropped but not from others. The main point against global rate limiting is that it opens another attack vector where an attacker could trigger rate limiting and then execute a 2. attack which would then not be document in the logs at all. With regard to the attack vector on the global approach and the overall reviews the two approaches have gotten I have chosen to continue with the approach in this PR. \r\n(To address the concern of [1] i have chosen to prefix all logs with `[*]` if there is at least one source location that is currently being suppressed.)\r\n</details>\r\n\r\n<details>\r\n<summary>logrotate</summary>\r\n\r\n#### logrotate\r\n\r\nLarryRuane brought up [logrotate](https://linux.die.net/man/8/logrotate) which can be used on linux to monitor log files and perform actions (delete, compress, send somewhere, etc.) on them when a certain size or point in time is reached. `logrotate` could be used to rate limit log but since we would like log rate limiting to be enabled by default it is not the best solution. Also on windows an alternative would have to be used.\r\n\r\n</details>\r\n\r\n## Testing\r\n\r\nI have a written a unit test which is contained in this PR. (Not the greatest test, it currently does not work on windows thanks to `\\r\\n`. If someone has an idea how to improve the test i would appreciate it)\r\n\r\nFurther more I made a RPC [here](https://github.com/dergoegge/bitcoin/commit/8e6d15d6be06834d1f634f4a54ea646be8bc3491) that can log excessive amounts of \"a\"s from different locations which i have found useful during my own testing.\r\n`bitcoin-cli excessivelog <location (1-5)> <num_bytes>`\r\n\r\nâ ï¸One thing to note with that rpc is that the rate limiting logic still prints the last message that triggered the limiting to disk, so something like `bitcoin-cli excessivelog 1 536870912` would still log ~512MiB to disk. Logging to console is also never suppressed (unless -printtoconsole=0)  â ï¸\r\n\r\nA simple example to use the rpc:\r\n```bash\r\nbitcoin-cli -regtest setmocktime 1\r\nbitcoin-cli -regtest excessivelog 1 1048500 # log just under 1MiB\r\nbitcoin-cli -regtest excessivelog 1 100 # this should get the total amount logged above 1MiB\r\n                                        # and the rate limiting logic should kick in\r\nbitcoin-cli -regtest setmocktime 3602 # let 1 hour pass (only works in regtest)\r\nbitcoin-cli -regtest excessivelog 1 100 # this should trigger logging to resume\r\n```\r\n",
   "closed_at" : "2022-10-07T10:18:05Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
      "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
      "followers_url" : "https://api.github.com/users/dergoegge/followers",
      "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
      "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/dergoegge",
      "id" : 8077169,
      "login" : "dergoegge",
      "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
      "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
      "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
      "repos_url" : "https://api.github.com/users/dergoegge/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/dergoegge"
   },
   "comments" : 41,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21603/comments",
   "created_at" : "2021-04-05T12:47:33Z",
   "draft" : false,
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21603/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/21603",
   "id" : 850343512,
   "labels" : [
      {
         "color" : "5319e7",
         "default" : false,
         "description" : "",
         "id" : 241832923,
         "name" : "Utils/log/libs",
         "node_id" : "MDU6TGFiZWwyNDE4MzI5MjM=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Utils/log/libs"
      },
      {
         "color" : "cccccc",
         "default" : false,
         "description" : "",
         "id" : 955867938,
         "name" : "Needs rebase",
         "node_id" : "MDU6TGFiZWw5NTU4Njc5Mzg=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Needs%20rebase"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21603/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDExOlB1bGxSZXF1ZXN0NjA4OTMyOTkx",
   "number" : 21603,
   "performed_via_github_app" : null,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/21603.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21603",
      "merged_at" : null,
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/21603.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21603"
   },
   "reactions" : {
      "+1" : 1,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 1,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21603/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "state_reason" : null,
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21603/timeline",
   "title" : "log: Mitigate disk filling attacks by rate limiting LogPrintf",
   "updated_at" : "2022-10-07T10:18:05Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21603",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
      "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
      "followers_url" : "https://api.github.com/users/dergoegge/followers",
      "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
      "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/dergoegge",
      "id" : 8077169,
      "login" : "dergoegge",
      "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
      "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
      "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
      "repos_url" : "https://api.github.com/users/dergoegge/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/dergoegge"
   }
}
