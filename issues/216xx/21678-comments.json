[
   {
      "author_association" : "MEMBER",
      "body" : "Looks like your compiler inlined the whole function and thus can not apply the suppression?\r\n\r\ncr ACK f2ef5a8afd5da2fb7775dafdee15e6ac532d8fe4\r\n\r\nAn alternative would be to simply avoid the intentional lock-order-inversion.\r\n\r\n\r\n```diff\r\ndiff --git a/src/test/sync_tests.cpp b/src/test/sync_tests.cpp\r\nindex 3e4d1dac9e..737cf166cd 100644\r\n--- a/src/test/sync_tests.cpp\r\n+++ b/src/test/sync_tests.cpp\r\n@@ -17,6 +17,11 @@ void TestPotentialDeadLockDetected(MutexType& mutex1, MutexType& mutex2)\r\n         LOCK2(mutex1, mutex2);\r\n     }\r\n     BOOST_CHECK(LockStackEmpty());\r\n+#ifndef DEBUG_LOCKORDER\r\n+    // Return early to avoid the lock-order-inversion.\r\n+    // Sanitizers different from our own DEBUG_LOCKORDER sanitizer would otherwise warn about this.\r\n+    return;\r\n+#endif\r\n     bool error_thrown = false;\r\n     try {\r\n         LOCK2(mutex2, mutex1);\r\n@@ -25,11 +30,7 @@ void TestPotentialDeadLockDetected(MutexType& mutex1, MutexType& mutex2)\r\n         error_thrown = true;\r\n     }\r\n     BOOST_CHECK(LockStackEmpty());\r\n-    #ifdef DEBUG_LOCKORDER\r\n     BOOST_CHECK(error_thrown);\r\n-    #else\r\n-    BOOST_CHECK(!error_thrown);\r\n-    #endif\r\n }\r\n \r\n #ifdef DEBUG_LOCKORDER\r\ndiff --git a/test/sanitizer_suppressions/tsan b/test/sanitizer_suppressions/tsan\r\nindex e2c79d56c5..0213dc58fc 100644\r\n--- a/test/sanitizer_suppressions/tsan\r\n+++ b/test/sanitizer_suppressions/tsan\r\n@@ -15,9 +15,6 @@ race:bitcoin-qt\r\n # deadlock (TODO fix)\r\n deadlock:CChainState::ConnectTip\r\n \r\n-# Intentional deadlock in tests\r\n-deadlock:TestPotentialDeadLockDetected\r\n-\r\n # Wildcard for all gui tests, should be replaced with non-wildcard suppressions\r\n race:src/qt/test/*\r\n deadlock:src/qt/test/*\r\n```\r\n\r\n(diff untested and uncompiled)",
      "created_at" : "2021-04-14T12:46:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21678#issuecomment-819490411",
      "id" : 819490411,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21678",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxOTQ5MDQxMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-14T12:46:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/819490411",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The suggested diff skips a part of the test, particularly `BOOST_CHECK(!error_thrown);`, that seems unwanted.",
      "created_at" : "2021-04-14T12:53:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21678#issuecomment-819494285",
      "id" : 819494285,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21678",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxOTQ5NDI4NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-14T12:53:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/819494285",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "What is the value of checking that two locks can be successfully taken both in the order a-b and in the order b-a. We don't use that anywhere, so it seems odd to have a test for it.",
      "created_at" : "2021-04-14T13:17:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21678#issuecomment-819510764",
      "id" : 819510764,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21678",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxOTUxMDc2NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-14T13:17:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/819510764",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ryanofsky @vasild What do you think?",
      "created_at" : "2021-04-14T13:23:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21678#issuecomment-819515074",
      "id" : 819515074,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21678",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxOTUxNTA3NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-14T13:23:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/819515074",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "( Test added by @ryanofsky in commit 41b88e93375d57db12da923f45f87b9a2db8e730 )",
      "created_at" : "2021-04-14T13:55:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21678#issuecomment-819537786",
      "id" : 819537786,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21678",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxOTUzNzc4Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-14T13:55:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/819537786",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm not sure what question's being asked, but I'm happy to review any change.\r\n\r\nIntention of #else clause in the referenced commit is to check that process will not unnecessarily throw an exception and potentially crash when DEBUG_LOCKORDER is disabled. Crashes can be bad, so it is good to verify that a crash won't happen when crashes are supposed to be disabled just because locks are acquired in a theoretically-bad ordering that wouldn't cause an actual problem.\r\n\r\nBut I don't think it's a big deal to drop the check if it's too expensive because it can't be done with sanitizers enabled and would require a separate build. Or any other reason. It's not a very important check.",
      "created_at" : "2021-04-14T14:47:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21678#issuecomment-819576116",
      "id" : 819576116,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21678",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxOTU3NjExNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-14T14:47:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/819576116",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Oh, I understand better now. This PR is fixing a broken suppression, and Marco's saying it is easier to skip the check that requires the suppression instead of fixing the suppression.\r\n\r\nI have no opinion on what's easier. I think the check does serve a purpose, but it's also not very important.",
      "created_at" : "2021-04-14T14:53:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21678#issuecomment-819580777",
      "id" : 819580777,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21678",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxOTU4MDc3Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-14T14:53:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/819580777",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "So, the problem this PR fixed is that `TestPotentialDeadLockDetected()` was inlined and thus did not match the suppression `deadlock:TestPotentialDeadLockDetected`? Why it started happening now?",
      "created_at" : "2021-04-14T16:24:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21678#issuecomment-819648026",
      "id" : 819648026,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21678",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxOTY0ODAyNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-14T16:24:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/819648026",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Why it started happening now?\r\n\r\nclang-12?",
      "created_at" : "2021-04-14T16:25:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21678#issuecomment-819648903",
      "id" : 819648903,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21678",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxOTY0ODkwMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-14T16:25:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/819648903",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   }
]
