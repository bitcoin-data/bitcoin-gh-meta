[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@BradSwain Thanks a lot for reporting!\r\n\r\nI love when our code base is analysed using new static analysis tools: the more the merrier! Did you find any other data race issues? Can you share your results in a gist or similar?\r\n\r\nUnfortunately we're doing CI testing with quite a few ThreadSanitizer suppressions in https://github.com/bitcoin/bitcoin/blob/master/test/sanitizer_suppressions/tsan. Were you able to replicate any of those finds?\r\n\r\nI think we should try to more clearly categorise our suppressions as \"benign\" vs. impactful: currently it is a mix of both which makes it hard to reason about the potential worst-case impact of each case. \r\n\r\nLast week a technical report on related work in the Firefox project was published: [\"Eliminating Data Races in Firefox â A Technical Report\"](https://hacks.mozilla.org/2021/04/eliminating-data-races-in-firefox-a-technical-report/). I think this makes sense:\r\n\r\n> While benign data races do exist, we found (in agreement with previous work on this subject [1] [2]) that data races are very easily misclassified as benign. The reasons for this are clear: It is hard to reason about what compilers can and will optimize, and confirmation for certain âbenignâ data races requires you to look at the assembler code that the compiler finally produces.\r\n> \r\n> Needless to say, this procedure is often much more time consuming than fixing the actual data race and also not future-proof. As a result, we decided that the ultimate goal should be a âno data racesâ policy that declares even benign data races as undesirable due to their risk of misclassification, the required time for investigation and the potential risk from future compilers (with better optimizations) or future platforms (e.g. ARM).\r\n\r\n",
      "created_at" : "2021-04-09T06:05:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/21627#issuecomment-816433376",
      "id" : 816433376,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21627",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxNjQzMzM3Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-09T06:05:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/816433376",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "> Did you find any other data race issues?\r\n> Were you able to replicate any of those finds?\r\n\r\nWe are still going through some of the reports. We will see if our tool can also find those races from the TSan suppression list.  \r\nI will post anything else we find as a comment on this issue.\r\n\r\n> Last week a technical report on related work in the Firefox project was published\r\n\r\nI really like this report and I fully agree.",
      "created_at" : "2021-04-09T17:30:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/21627#issuecomment-816839793",
      "id" : 816839793,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21627",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxNjgzOTc5Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-09T17:30:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/816839793",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25114061?v=4",
         "events_url" : "https://api.github.com/users/BradSwain/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BradSwain/followers",
         "following_url" : "https://api.github.com/users/BradSwain/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BradSwain/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BradSwain",
         "id" : 25114061,
         "login" : "BradSwain",
         "node_id" : "MDQ6VXNlcjI1MTE0MDYx",
         "organizations_url" : "https://api.github.com/users/BradSwain/orgs",
         "received_events_url" : "https://api.github.com/users/BradSwain/received_events",
         "repos_url" : "https://api.github.com/users/BradSwain/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BradSwain/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BradSwain/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BradSwain"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Don't [LoadExternalBlockFile](https://github.com/bitcoin/bitcoin/blob/9be7fe4849310884294669b019dd8300f69bc334/src/validation.cpp#L4700)  and [rest_block](https://github.com/bitcoin/bitcoin/blob/9be7fe4849310884294669b019dd8300f69bc334/src/rest.cpp#L251) both hold the `cs_main` though? ",
      "created_at" : "2021-06-09T19:48:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/21627#issuecomment-858045641",
      "id" : 858045641,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21627",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1ODA0NTY0MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-09T19:48:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/858045641",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/35263201?v=4",
         "events_url" : "https://api.github.com/users/amadeuszpawlik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amadeuszpawlik/followers",
         "following_url" : "https://api.github.com/users/amadeuszpawlik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amadeuszpawlik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amadeuszpawlik",
         "id" : 35263201,
         "login" : "amadeuszpawlik",
         "node_id" : "MDQ6VXNlcjM1MjYzMjAx",
         "organizations_url" : "https://api.github.com/users/amadeuszpawlik/orgs",
         "received_events_url" : "https://api.github.com/users/amadeuszpawlik/received_events",
         "repos_url" : "https://api.github.com/users/amadeuszpawlik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amadeuszpawlik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amadeuszpawlik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amadeuszpawlik"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Thanks for taking a look @amadeuszpawlik \r\n\r\nMy understanding may be wrong, but is the lock released at the end of this block (line 263)?\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/9be7fe4849310884294669b019dd8300f69bc334/src/rest.cpp#L250-L263\r\n",
      "created_at" : "2021-06-09T20:22:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/21627#issuecomment-858075418",
      "id" : 858075418,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21627",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1ODA3NTQxOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-09T20:22:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/858075418",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25114061?v=4",
         "events_url" : "https://api.github.com/users/BradSwain/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BradSwain/followers",
         "following_url" : "https://api.github.com/users/BradSwain/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BradSwain/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BradSwain",
         "id" : 25114061,
         "login" : "BradSwain",
         "node_id" : "MDQ6VXNlcjI1MTE0MDYx",
         "organizations_url" : "https://api.github.com/users/BradSwain/orgs",
         "received_events_url" : "https://api.github.com/users/BradSwain/received_events",
         "repos_url" : "https://api.github.com/users/BradSwain/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BradSwain/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BradSwain/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BradSwain"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@BradSwain Yes it is. `LOCK(cs_main);` locks for the duration of the scope it occurs in (like `std::unique_lock` etc).",
      "created_at" : "2021-06-09T21:07:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/21627#issuecomment-858101968",
      "id" : 858101968,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21627",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1ODEwMTk2OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-09T21:07:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/858101968",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@BradSwain now I see, I was staring at\r\n[`rest_block -> IsBlockPruned`](https://github.com/bitcoin/bitcoin/blob/9be7fe4849310884294669b019dd8300f69bc334/src/rest.cpp#L258)\r\nbut it obviously doesn't hold for\r\n[`rest_block -> blockToJSON -> IsBlockPruned`](https://github.com/bitcoin/bitcoin/blob/9be7fe4849310884294669b019dd8300f69bc334/src/rest.cpp#L285)\r\nThanks!",
      "created_at" : "2021-06-10T08:54:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/21627#issuecomment-858442467",
      "id" : 858442467,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21627",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1ODQ0MjQ2Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-10T08:54:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/858442467",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/35263201?v=4",
         "events_url" : "https://api.github.com/users/amadeuszpawlik/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amadeuszpawlik/followers",
         "following_url" : "https://api.github.com/users/amadeuszpawlik/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amadeuszpawlik/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amadeuszpawlik",
         "id" : 35263201,
         "login" : "amadeuszpawlik",
         "node_id" : "MDQ6VXNlcjM1MjYzMjAx",
         "organizations_url" : "https://api.github.com/users/amadeuszpawlik/orgs",
         "received_events_url" : "https://api.github.com/users/amadeuszpawlik/received_events",
         "repos_url" : "https://api.github.com/users/amadeuszpawlik/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amadeuszpawlik/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amadeuszpawlik/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amadeuszpawlik"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "See also #17161 ",
      "created_at" : "2021-06-10T14:05:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/21627#issuecomment-858652549",
      "id" : 858652549,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21627",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1ODY1MjU0OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-10T14:05:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/858652549",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
