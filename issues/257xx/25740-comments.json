[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [achow101](https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1440601441), [ariard](https://github.com/bitcoin/bitcoin/pull/25740#pullrequestreview-1310290473), [brunoerg](https://github.com/bitcoin/bitcoin/pull/25740#pullrequestreview-1324598396) |\n| Stale ACK | [ryanofsky](https://github.com/bitcoin/bitcoin/pull/25740#pullrequestreview-1178296226) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#26857](https://github.com/bitcoin/bitcoin/pull/26857) (OP_VAULT draft by jamesob)\n* [#25977](https://github.com/bitcoin/bitcoin/pull/25977) (refactor: Replace `std::optional<bilingual_str>` with `util::Result` by ryanofsky)\n* [#25722](https://github.com/bitcoin/bitcoin/pull/25722) (refactor: Use util::Result class for wallet loading by ryanofsky)\n* [#25665](https://github.com/bitcoin/bitcoin/pull/25665) (refactor: Add util::Result failure values, multiple error and warning messages by ryanofsky)\n* [#24008](https://github.com/bitcoin/bitcoin/pull/24008) (assumeutxo: net_processing changes by jamesob)\n* [#15606](https://github.com/bitcoin/bitcoin/pull/15606) (assumeutxo by jamesob)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2022-07-29T21:47:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1199966506",
      "id" : 1199966506,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585Hhgkq",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1199966506/reactions"
      },
      "updated_at" : "2023-03-03T21:11:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1199966506",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "```\r\ntest/validation_chainstatemanager_tests.cpp:418:35: error: calling function 'DisconnectTip' requires holding mutex 'bg_chainstate.m_mempool->cs' exclusively [-Werror,-Wthread-safety-precise]\r\n        BOOST_CHECK(bg_chainstate.DisconnectTip(unused_state, &unused_pool));\r\n                                  ^\r\ntest/validation_chainstatemanager_tests.cpp:418:35: note: found near match 'mempool->cs'\r\n1 error generated.\r\n```\r\n",
      "created_at" : "2022-07-30T08:57:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1200119940",
      "id" : 1200119940,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585HiGCE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1200119940/reactions"
      },
      "updated_at" : "2022-07-30T08:57:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1200119940",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r934711528"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934711528"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"test: add testcases for snapshot initialization\" (5ff0d2f7e78a40225a1eb9aa7bbf5c358d94bf48)\r\n\r\nSomething wonky is going on in this commit. It seems like some rebase error. This is dropping the `chainstatemanager_loadblockindex` test, and replacing it with an exact copy of the `chainstatemanager_snapshot_init` below, which now appears twice (and is edited in later commit 65ad0860ffd9441b005ac4bc240f596d9a81836f to become a different chainstatemanager_snapshot_completion test)",
      "commit_id" : "93e6a234678b98abe1c50b11b1d47cbe266d25fa",
      "created_at" : "2022-08-01T16:26:47Z",
      "diff_hunk" : "@@ -387,82 +387,57 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, SnapshotTestSetup)\n     this->SetupSnapshot();\n }\n \n-//! Test LoadBlockIndex behavior when multiple chainstates are in use.\n-//!\n-//! - First, verfiy that setBlockIndexCandidates is as expected when using a single,\n-//!   fully-validating chainstate.\n-//!\n-//! - Then mark a region of the chain BLOCK_ASSUMED_VALID and introduce a second chainstate\n-//!   that will tolerate assumed-valid blocks. Run LoadBlockIndex() and ensure that the first\n-//!   chainstate only contains fully validated blocks and the other chainstate contains all blocks,\n-//!   even those assumed-valid.\n-//!\n-BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r934711528",
      "id" : 934711528,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5843tpDo",
      "original_commit_id" : "5ff0d2f7e78a40225a1eb9aa7bbf5c358d94bf48",
      "original_line" : 325,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1057565671,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934711528/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-01T16:47:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/934711528",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-08-03T09:23:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1203702766",
      "id" : 1203702766,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585Hvwvu",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1203702766/reactions"
      },
      "updated_at" : "2022-08-03T09:23:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1203702766",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Clang failure on some platforms looks spurious:\r\n\r\n```\r\ntest/validation_chainstatemanager_tests.cpp:501:35: error: calling function 'DisconnectTip' requires holding mutex 'bg_chainstate.m_mempool->cs' exclusively [-Werror,-Wthread-safety-precise]\r\n        BOOST_CHECK(bg_chainstate.DisconnectTip(unused_state, &unused_pool));\r\n                                  ^\r\ntest/validation_chainstatemanager_tests.cpp:501:35: note: found near match 'mempool->cs'\r\n1 error generated.\r\n```\r\nbut lock is taken [here](https://github.com/bitcoin/bitcoin/pull/25740/commits/a9e27d3f242361534a1a50e403ab176b556ba528#diff-dbada1fe3a3d0af884304dd28be8c9df74b592401dec2c6400f6b491aefe6c9bR500). \r\n\r\nAnyone have ideas for workarounds?",
      "created_at" : "2022-09-06T22:47:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1238726951",
      "id" : 1238726951,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585J1Xkn",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1238726951/reactions"
      },
      "updated_at" : "2022-09-06T22:47:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1238726951",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r964236783"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964236783"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@ryanofsky yeah, thanks - not sure what happened there. Should be fixed.",
      "commit_id" : "93e6a234678b98abe1c50b11b1d47cbe266d25fa",
      "created_at" : "2022-09-06T22:47:56Z",
      "diff_hunk" : "@@ -387,82 +387,57 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, SnapshotTestSetup)\n     this->SetupSnapshot();\n }\n \n-//! Test LoadBlockIndex behavior when multiple chainstates are in use.\n-//!\n-//! - First, verfiy that setBlockIndexCandidates is as expected when using a single,\n-//!   fully-validating chainstate.\n-//!\n-//! - Then mark a region of the chain BLOCK_ASSUMED_VALID and introduce a second chainstate\n-//!   that will tolerate assumed-valid blocks. Run LoadBlockIndex() and ensure that the first\n-//!   chainstate only contains fully validated blocks and the other chainstate contains all blocks,\n-//!   even those assumed-valid.\n-//!\n-BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r964236783",
      "id" : 964236783,
      "in_reply_to_id" : 934711528,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5845eRXv",
      "original_commit_id" : "5ff0d2f7e78a40225a1eb9aa7bbf5c358d94bf48",
      "original_line" : 325,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : null,
      "pull_request_review_id" : 1098333048,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964236783/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-09-06T22:47:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/964236783",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "If the lock is for `bg_chainstate.GetMempool()->cs` but the annotation requires `bg_chainstate.m_mempool->cs`, the compiler probably isn't going to know that `GetMempool()` and `m_mempool` are the same. Probably should stick with `m_mempool`",
      "created_at" : "2022-09-06T22:52:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1238729341",
      "id" : 1238729341,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585J1YJ9",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1238729341/reactions"
      },
      "updated_at" : "2022-09-06T22:52:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1238729341",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">  Probably should stick with m_mempool\r\n\r\nIt's protected :grimacing:. But looks like I can use the `RETURNS_LOCK` annotation on `MempoolMutex()`.\r\n\r\nEdit: that's private too, hah.",
      "created_at" : "2022-09-06T23:02:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1238733581",
      "id" : 1238733581,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585J1ZMN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1238733581/reactions"
      },
      "updated_at" : "2022-09-06T23:02:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1238733581",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-09-13T16:34:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1245663156",
      "id" : 1245663156,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585KP0-0",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1245663156/reactions"
      },
      "updated_at" : "2022-09-13T16:34:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1245663156",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Reopening and closing to get Github to deduplicate commits now included on master.",
      "created_at" : "2022-10-13T14:40:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1277723681",
      "id" : 1277723681,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585MKIQh",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1277723681/reactions"
      },
      "updated_at" : "2022-10-13T14:40:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1277723681",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jamesob this PR should probably be added to #15606 now that it's out of draft.",
      "created_at" : "2022-10-13T15:00:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1277755175",
      "id" : 1277755175,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585MKP8n",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1277755175/reactions"
      },
      "updated_at" : "2022-10-13T15:31:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1277755175",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the ping @aureleoules; the parent PR description has been updated.",
      "created_at" : "2022-10-13T17:10:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1277928248",
      "id" : 1277928248,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585MK6M4",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1277928248/reactions"
      },
      "updated_at" : "2022-10-13T17:10:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1277928248",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r997479271"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/997479271"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc \"validation: add ChainMan logic for completing UTXO snapshot validation\"\r\n\r\nSince this is also caused by an invalid snapshot, should this be below and also call `handle_invalid_snapshot`? Otherwise it seems like this would just continue with the IBD chainstate without invalidating the snapshot chainstate which I think would be incorrect?",
      "commit_id" : "50909f0d5dc3a8f15c25ebab756b9a723e2deed3",
      "created_at" : "2022-10-17T20:25:58Z",
      "diff_hunk" : "@@ -5117,6 +5168,146 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+// Currently, this function holds cs_main for its duration, which could be for\n+// multiple minutes due to the GetUTXOStats call. This hold is necessary\n+// because we need to avoid advancing the background validation chainstate\n+// farther than the snapshot base block - and this function is also invoked\n+// from within ConnectTip, i.e. from within ActivateBestChain, so cs_main is\n+// held anyway.\n+//\n+// Eventually (TODO), we could somehow separate this function's runtime from\n+// maintenance of the active chain, but that will either require\n+//\n+//  (i) setting `m_stop_use` immediately and ensuring all chainstate accesses go\n+//      through IsUsable() checks, or\n+//\n+//  (ii) giving each chainstate its own lock instead of using cs_main for everything.\n+SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation(\n+      std::function<void(bilingual_str)> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (m_ibd_chainstate.get() == &this->ActiveChainstate() ||\n+            !this->IsUsable(m_snapshot_chainstate.get()) ||\n+            !this->IsUsable(m_ibd_chainstate.get()) ||\n+            !m_ibd_chainstate->m_chain.Tip()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return SnapshotCompletionResult::SKIPPED;\n+    }\n+    int snapshot_tip_height = this->ActiveHeight();\n+    int snapshot_base_height = *this->GetSnapshotBaseHeight();\n+    CBlockIndex& index_new = *m_ibd_chainstate->m_chain.Tip();\n+\n+    if (index_new.nHeight < snapshot_base_height) {\n+        // Background IBD not complete yet.\n+        return SnapshotCompletionResult::SKIPPED;\n+    }\n+\n+    assert(SnapshotBlockhash());\n+    uint256 snapshot_blockhash = *SnapshotBlockhash();\n+\n+    if (index_new.GetBlockHash() != snapshot_blockhash) {\n+      LogPrintf(\"[snapshot] supposed base block %s does not match the \" /* Continued */\n+          \"snapshot base block %s (height %d). Snapshot is not valid.\",\n+          index_new.ToString(), snapshot_blockhash.ToString(), snapshot_base_height);\n+       return SnapshotCompletionResult::BASE_BLOCKHASH_MISMATCH;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r997479271",
      "id" : 997479271,
      "line" : 5216,
      "node_id" : "PRRC_kwDOABII5847dFNn",
      "original_commit_id" : "a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc",
      "original_line" : 5214,
      "original_position" : 150,
      "original_start_line" : 5209,
      "path" : "src/validation.cpp",
      "position" : 150,
      "pull_request_review_id" : 1144767699,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/997479271/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5211,
      "start_side" : "RIGHT",
      "updated_at" : "2022-10-17T20:53:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/997479271",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r997480620"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/997480620"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc \"validation: add ChainMan logic for completing UTXO snapshot validation\"\r\n\r\nThis only renames the chainstate dir, it's not clear to me if/when the invalid chainstate is deleted. Considering that moving the chainstate dir and deleting it are effectively the same thing here, I think it could just do `fs::remove_all`.",
      "commit_id" : "50909f0d5dc3a8f15c25ebab756b9a723e2deed3",
      "created_at" : "2022-10-17T20:27:37Z",
      "diff_hunk" : "@@ -5213,6 +5404,39 @@ Chainstate& ChainstateManager::ActivateExistingSnapshot(CTxMemPool* mempool, uin\n     return *m_snapshot_chainstate;\n }\n \n+void Chainstate::InvalidateCoinsDBOnDisk()\n+{\n+    AssertLockHeld(::cs_main);\n+    // Should never be called on a non-snapshot chainstate.\n+    assert(m_from_snapshot_blockhash);\n+    auto storage_path_maybe = this->CoinsDB().StoragePath();\n+    // Should never be called with a non-existent storage path.\n+    assert(storage_path_maybe);\n+    fs::path snapshot_datadir = *storage_path_maybe;\n+\n+    // Coins views no longer usable.\n+    m_coins_views.reset();\n+\n+    auto invalid_path = snapshot_datadir + \"_INVALID\";\n+    std::string dbpath = fs::PathToString(snapshot_datadir);\n+    std::string target = fs::PathToString(invalid_path);\n+    LogPrintf(\"[snapshot] renaming snapshot datadir %s to %s\\n\", dbpath, target);\n+\n+    try {\n+        fs::rename(snapshot_datadir, invalid_path);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r997480620",
      "id" : 997480620,
      "line" : 5428,
      "node_id" : "PRRC_kwDOABII5847dFis",
      "original_commit_id" : "a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc",
      "original_line" : 5426,
      "original_position" : 273,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 273,
      "pull_request_review_id" : 1144767699,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/997480620/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-17T20:53:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/997480620",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r997485284"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/997485284"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc \"validation: add ChainMan logic for completing UTXO snapshot validation\"\r\n\r\n```\r\nvalidation.cpp: In member function âbool ChainstateManager::PopulateAndValidateSnapshot(Chainstate&, AutoFile&, const node::SnapshotMetadata&)â:\r\nvalidation.cpp:5103:14: warning: catching polymorphic type âstruct StopHashingExceptionâ by value [-Wcatch-value=]\r\n 5103 |     } catch (StopHashingException) {\r\n      |    \r\n```",
      "commit_id" : "50909f0d5dc3a8f15c25ebab756b9a723e2deed3",
      "created_at" : "2022-10-17T20:33:24Z",
      "diff_hunk" : "@@ -5043,13 +5089,18 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n \n     assert(coins_cache.GetBestBlock() == base_blockhash);\n \n-    auto breakpoint_fnc = [] { /* TODO insert breakpoint here? */ };\n-\n     // As above, okay to immediately release cs_main here since no other context knows\n     // about the snapshot_chainstate.\n     CCoinsViewDB* snapshot_coinsdb = WITH_LOCK(::cs_main, return &snapshot_chainstate.CoinsDB());\n \n-    const std::optional<CCoinsStats> maybe_stats = ComputeUTXOStats(CoinStatsHashType::HASH_SERIALIZED, snapshot_coinsdb, m_blockman, breakpoint_fnc);\n+    std::optional<CCoinsStats> maybe_stats;\n+\n+    try {\n+        maybe_stats = ComputeUTXOStats(\n+            CoinStatsHashType::HASH_SERIALIZED, snapshot_coinsdb, m_blockman, SnapshotUTXOHashBreakpoint);\n+    } catch (StopHashingException) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r997485284",
      "id" : 997485284,
      "line" : 5103,
      "node_id" : "PRRC_kwDOABII5847dGrk",
      "original_commit_id" : "a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc",
      "original_line" : 5101,
      "original_position" : 97,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 97,
      "pull_request_review_id" : 1144767699,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/997485284/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-17T20:53:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/997485284",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r998027021"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998027021"
         }
      },
      "author_association" : "MEMBER",
      "body" : "f7179525b5cb37f010d5e42f41650414e648bf45: can be made const\r\n```diff\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex a6bc06201..eb0799b15 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -5439,16 +5439,16 @@ void Chainstate::InvalidateCoinsDBOnDisk()\r\n     }\r\n }\r\n \r\n-CBlockIndex* ChainstateManager::GetSnapshotBaseBlock()\r\n+const CBlockIndex* ChainstateManager::GetSnapshotBaseBlock() const\r\n {\r\n     auto blockhash_op = this->SnapshotBlockhash();\r\n     if (!blockhash_op) return nullptr;\r\n     return Assert(m_blockman.LookupBlockIndex(*blockhash_op));\r\n }\r\n \r\n-std::optional<int> ChainstateManager::GetSnapshotBaseHeight()\r\n+std::optional<int> ChainstateManager::GetSnapshotBaseHeight() const\r\n {\r\n-    CBlockIndex* base = this->GetSnapshotBaseBlock();\r\n+    const CBlockIndex* base = this->GetSnapshotBaseBlock();\r\n     return base ? std::make_optional(base->nHeight) : std::nullopt;\r\n }\r\n \r\ndiff --git a/src/validation.h b/src/validation.h\r\nindex d435d76b4..7b3498d55 100644\r\n--- a/src/validation.h\r\n+++ b/src/validation.h\r\n@@ -908,11 +908,11 @@ private:\r\n     std::chrono::time_point<std::chrono::steady_clock> m_last_presync_update GUARDED_BY(::cs_main) {};\r\n \r\n     //! Returns nullptr if no snapshot has been loaded.\r\n-    CBlockIndex* GetSnapshotBaseBlock() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n+    const CBlockIndex* GetSnapshotBaseBlock() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n \r\n     //! Return the height of the base block of the snapshot in use, if one exists, else\r\n     //! nullopt.\r\n-    std::optional<int> GetSnapshotBaseHeight() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n+    std::optional<int> GetSnapshotBaseHeight() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n \r\n     //! Return true if a chainstate is considered usable.\r\n     //!\r\n```",
      "commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "created_at" : "2022-10-18T10:33:07Z",
      "diff_hunk" : "@@ -5211,3 +5211,16 @@ Chainstate& ChainstateManager::ActivateExistingSnapshot(CTxMemPool* mempool, uin\n     m_active_chainstate = m_snapshot_chainstate.get();\n     return *m_snapshot_chainstate;\n }\n+\n+CBlockIndex* ChainstateManager::GetSnapshotBaseBlock()\n+{\n+    auto blockhash_op = this->SnapshotBlockhash();\n+    if (!blockhash_op) return nullptr;\n+    return Assert(m_blockman.LookupBlockIndex(*blockhash_op));\n+}\n+\n+std::optional<int> ChainstateManager::GetSnapshotBaseHeight()\n+{\n+    CBlockIndex* base = this->GetSnapshotBaseBlock();\n+    return base ? std::make_optional(base->nHeight) : std::nullopt;\n+}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r998027021",
      "id" : 998027021,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847fK8N",
      "original_commit_id" : "f7179525b5cb37f010d5e42f41650414e648bf45",
      "original_line" : 5459,
      "original_position" : 16,
      "original_start_line" : 5215,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1145532345,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998027021/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-10-18T12:58:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998027021",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r998050396"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998050396"
         }
      },
      "author_association" : "MEMBER",
      "body" : "062c8883da2f32e9b58bb846d37b911f4ac365db\r\nI think it's clearer.\r\n```suggestion\r\n    bool m_disabled GUARDED_BY(::cs_main) {false};\r\n```",
      "commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "created_at" : "2022-10-18T10:58:17Z",
      "diff_hunk" : "@@ -470,6 +470,13 @@ class Chainstate\n     //! Manages the UTXO set, which is a reflection of the contents of `m_chain`.\n     std::unique_ptr<CoinsViews> m_coins_views;\n \n+    //! This toggle exists for use when doing background validation for UTXO\n+    //! snapshots. It is set once the background validation chain reaches the\n+    //! same height as the base of the snapshot, and signals that we should no\n+    //! longer connect blocks to the background chainstate. It may also be set\n+    //! for snapshot chainstates found to be invalid.\n+    bool m_stop_use GUARDED_BY(::cs_main) {false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r998050396",
      "id" : 998050396,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847fQpc",
      "original_commit_id" : "062c8883da2f32e9b58bb846d37b911f4ac365db",
      "original_line" : 478,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 1145532345,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998050396/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-18T12:58:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998050396",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r998054962"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998054962"
         }
      },
      "author_association" : "MEMBER",
      "body" : "236ae38274669ce9fd4dcd2a85ab2c373226457f\r\n```suggestion\r\n    bool HasCoinsViews() const { return m_coins_views != nullptr; }\r\n```",
      "commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "created_at" : "2022-10-18T11:03:21Z",
      "diff_hunk" : "@@ -570,12 +570,14 @@ class Chainstate\n     CCoinsViewErrorCatcher& CoinsErrorCatcher() EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n     {\n         AssertLockHeld(::cs_main);\n-        return m_coins_views->m_catcherview;\n+        return Assert(m_coins_views)->m_catcherview;\n     }\n \n     //! Destructs all objects related to accessing the UTXO set.\n     void ResetCoinsViews() { m_coins_views.reset(); }\n \n+    bool HasCoinsViews() { return (bool)m_coins_views; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r998054962",
      "id" : 998054962,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847fRwy",
      "original_commit_id" : "236ae38274669ce9fd4dcd2a85ab2c373226457f",
      "original_line" : 580,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 1145532345,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998054962/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-18T12:58:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998054962",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r998087278"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998087278"
         }
      },
      "author_association" : "MEMBER",
      "body" : "a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc\r\n```suggestion\r\n```",
      "commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "created_at" : "2022-10-18T11:34:16Z",
      "diff_hunk" : "@@ -25,16 +25,52 @@\n #include <vector>\n \n namespace node {\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r998087278",
      "id" : 998087278,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847fZpu",
      "original_commit_id" : "a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc",
      "original_line" : 28,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : null,
      "pull_request_review_id" : 1145532345,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998087278/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-18T12:58:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998087278",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r998094634"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998094634"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc\r\n```suggestion\r\n        return {ChainstateLoadStatus::FAILURE, _(\"You need to rebuild the database using -reindex to go back to unpruned mode. This will redownload the entire blockchain\")};\r\n```",
      "commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "created_at" : "2022-10-18T11:42:09Z",
      "diff_hunk" : "@@ -25,16 +25,52 @@\n #include <vector>\n \n namespace node {\n+\n // Complete initialization of chainstates after the initial call has been made\n // to ChainstateManager::InitializeChainstate().\n static ChainstateLoadResult CompleteChainstateInitialization(\n     ChainstateManager& chainman,\n     const ChainstateLoadOptions& options) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n {\n+    if (options.check_interrupt && options.check_interrupt()) return {ChainstateLoadStatus::INTERRUPTED, {}};\n+\n+    // LoadBlockIndex will load m_have_pruned if we've ever removed a\n+    // block file from disk.\n+    // Note that it also sets fReindex global based on the disk flag!\n+    // From here on, fReindex and options.reindex values may be different!\n+    if (!chainman.LoadBlockIndex()) {\n+        if (options.check_interrupt && options.check_interrupt()) return {ChainstateLoadStatus::INTERRUPTED, {}};\n+        return {ChainstateLoadStatus::FAILURE, _(\"Error loading block database\")};\n+    }\n+\n+    // Check for changed -prune state.  What we are concerned about is a user who has pruned blocks\n+    // in the past, but is now trying to run unpruned.\n+    if (chainman.m_blockman.m_have_pruned && !options.prune) {\n+        return {ChainstateLoadStatus::FAILURE, _(\"You need to rebuild the database using -reindex to go back to unpruned mode.  This will redownload the entire blockchain\")};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r998094634",
      "id" : 998094634,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847fbcq",
      "original_commit_id" : "a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc",
      "original_line" : 49,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : null,
      "pull_request_review_id" : 1145532345,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998094634/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-18T12:58:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998094634",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r998102475"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998102475"
         }
      },
      "author_association" : "MEMBER",
      "body" : "a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc\r\n```suggestion\r\n        assert(chainman.GetAll().empty());\r\n```",
      "commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "created_at" : "2022-10-18T11:50:30Z",
      "diff_hunk" : "@@ -141,41 +177,46 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n         }\n     }\n \n-    if (options.check_interrupt && options.check_interrupt()) return {ChainstateLoadStatus::INTERRUPTED, {}};\n-\n-    // LoadBlockIndex will load m_have_pruned if we've ever removed a\n-    // block file from disk.\n-    // Note that it also sets fReindex global based on the disk flag!\n-    // From here on, fReindex and options.reindex values may be different!\n-    if (!chainman.LoadBlockIndex()) {\n-        if (options.check_interrupt && options.check_interrupt()) return {ChainstateLoadStatus::INTERRUPTED, {}};\n-        return {ChainstateLoadStatus::FAILURE, _(\"Error loading block database\")};\n+    auto [init_status, init_error] = CompleteChainstateInitialization(chainman, options);\n+    if (init_status != ChainstateLoadStatus::SUCCESS) {\n+        return {init_status, init_error};\n     }\n \n-    if (!chainman.BlockIndex().empty() &&\n-            !chainman.m_blockman.LookupBlockIndex(chainman.GetConsensus().hashGenesisBlock)) {\n-        // If the loaded chain has a wrong genesis, bail out immediately\n-        // (we're likely using a testnet datadir, or the other way around).\n-        return {ChainstateLoadStatus::FAILURE_INCOMPATIBLE_DB, _(\"Incorrect or no genesis block found. Wrong datadir for network?\")};\n-    }\n+    // If a snapshot chainstate was fully validated by a background chainstate during\n+    // the last run, detect it here and clean up the now-unneeded background\n+    // chainstate. This is the expected case during snapshot completion, and\n+    // not just a belt-and-suspenders.\n+    auto snapshot_completion = chainman.MaybeCompleteSnapshotValidation();\n+\n+    if (snapshot_completion == SnapshotCompletionResult::SKIPPED) {\n+        // do nothing; expected case\n+    } else if (snapshot_completion == SnapshotCompletionResult::SUCCESS) {\n+        LogPrintf(\"[snapshot] cleaning up unneeded background chainstate, then reinitializing\\n\");\n+        if (!chainman.ValidatedSnapshotCleanup()) {\n+            AbortNode(\"Background chainstate cleanup failed unexpectedly.\");\n+        }\n \n-    // Check for changed -prune state.  What we are concerned about is a user who has pruned blocks\n-    // in the past, but is now trying to run unpruned.\n-    if (chainman.m_blockman.m_have_pruned && !options.prune) {\n-        return {ChainstateLoadStatus::FAILURE, _(\"You need to rebuild the database using -reindex to go back to unpruned mode.  This will redownload the entire blockchain\")};\n-    }\n+        // Because ValidatedSnapshotCleanup() has torn down chainstates with\n+        // ChainstateManager::ResetChainstates(), reinitialize them here without\n+        // duplicating the blockindex work above.\n+        assert(chainman.GetAll().size() == 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r998102475",
      "id" : 998102475,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847fdXL",
      "original_commit_id" : "a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc",
      "original_line" : 202,
      "original_position" : 99,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : null,
      "pull_request_review_id" : 1145532345,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998102475/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-18T12:58:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998102475",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r998124561"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998124561"
         }
      },
      "author_association" : "MEMBER",
      "body" : "a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc: maybe `Assert` first?",
      "commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "created_at" : "2022-10-18T12:12:46Z",
      "diff_hunk" : "@@ -5117,6 +5168,146 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+// Currently, this function holds cs_main for its duration, which could be for\n+// multiple minutes due to the GetUTXOStats call. This hold is necessary\n+// because we need to avoid advancing the background validation chainstate\n+// farther than the snapshot base block - and this function is also invoked\n+// from within ConnectTip, i.e. from within ActivateBestChain, so cs_main is\n+// held anyway.\n+//\n+// Eventually (TODO), we could somehow separate this function's runtime from\n+// maintenance of the active chain, but that will either require\n+//\n+//  (i) setting `m_stop_use` immediately and ensuring all chainstate accesses go\n+//      through IsUsable() checks, or\n+//\n+//  (ii) giving each chainstate its own lock instead of using cs_main for everything.\n+SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation(\n+      std::function<void(bilingual_str)> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (m_ibd_chainstate.get() == &this->ActiveChainstate() ||\n+            !this->IsUsable(m_snapshot_chainstate.get()) ||\n+            !this->IsUsable(m_ibd_chainstate.get()) ||\n+            !m_ibd_chainstate->m_chain.Tip()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return SnapshotCompletionResult::SKIPPED;\n+    }\n+    int snapshot_tip_height = this->ActiveHeight();\n+    int snapshot_base_height = *this->GetSnapshotBaseHeight();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r998124561",
      "id" : 998124561,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847fiwR",
      "original_commit_id" : "a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc",
      "original_line" : 5198,
      "original_position" : 134,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1145532345,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998124561/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-18T12:58:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998124561",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r998125501"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998125501"
         }
      },
      "author_association" : "MEMBER",
      "body" : "a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc: `Assert` here as well and can be const",
      "commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "created_at" : "2022-10-18T12:13:43Z",
      "diff_hunk" : "@@ -5117,6 +5168,146 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+// Currently, this function holds cs_main for its duration, which could be for\n+// multiple minutes due to the GetUTXOStats call. This hold is necessary\n+// because we need to avoid advancing the background validation chainstate\n+// farther than the snapshot base block - and this function is also invoked\n+// from within ConnectTip, i.e. from within ActivateBestChain, so cs_main is\n+// held anyway.\n+//\n+// Eventually (TODO), we could somehow separate this function's runtime from\n+// maintenance of the active chain, but that will either require\n+//\n+//  (i) setting `m_stop_use` immediately and ensuring all chainstate accesses go\n+//      through IsUsable() checks, or\n+//\n+//  (ii) giving each chainstate its own lock instead of using cs_main for everything.\n+SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation(\n+      std::function<void(bilingual_str)> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (m_ibd_chainstate.get() == &this->ActiveChainstate() ||\n+            !this->IsUsable(m_snapshot_chainstate.get()) ||\n+            !this->IsUsable(m_ibd_chainstate.get()) ||\n+            !m_ibd_chainstate->m_chain.Tip()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return SnapshotCompletionResult::SKIPPED;\n+    }\n+    int snapshot_tip_height = this->ActiveHeight();\n+    int snapshot_base_height = *this->GetSnapshotBaseHeight();\n+    CBlockIndex& index_new = *m_ibd_chainstate->m_chain.Tip();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r998125501",
      "id" : 998125501,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847fi-9",
      "original_commit_id" : "a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc",
      "original_line" : 5199,
      "original_position" : 135,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1145532345,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998125501/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-18T12:58:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998125501",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r998126326"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998126326"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc: can be inlined\r\n```suggestion\r\n\tuint256 snapshot_blockhash{*Assert(SnapshotBlockhash())};",
      "commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "created_at" : "2022-10-18T12:14:33Z",
      "diff_hunk" : "@@ -5117,6 +5168,146 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+// Currently, this function holds cs_main for its duration, which could be for\n+// multiple minutes due to the GetUTXOStats call. This hold is necessary\n+// because we need to avoid advancing the background validation chainstate\n+// farther than the snapshot base block - and this function is also invoked\n+// from within ConnectTip, i.e. from within ActivateBestChain, so cs_main is\n+// held anyway.\n+//\n+// Eventually (TODO), we could somehow separate this function's runtime from\n+// maintenance of the active chain, but that will either require\n+//\n+//  (i) setting `m_stop_use` immediately and ensuring all chainstate accesses go\n+//      through IsUsable() checks, or\n+//\n+//  (ii) giving each chainstate its own lock instead of using cs_main for everything.\n+SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation(\n+      std::function<void(bilingual_str)> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (m_ibd_chainstate.get() == &this->ActiveChainstate() ||\n+            !this->IsUsable(m_snapshot_chainstate.get()) ||\n+            !this->IsUsable(m_ibd_chainstate.get()) ||\n+            !m_ibd_chainstate->m_chain.Tip()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return SnapshotCompletionResult::SKIPPED;\n+    }\n+    int snapshot_tip_height = this->ActiveHeight();\n+    int snapshot_base_height = *this->GetSnapshotBaseHeight();\n+    CBlockIndex& index_new = *m_ibd_chainstate->m_chain.Tip();\n+\n+    if (index_new.nHeight < snapshot_base_height) {\n+        // Background IBD not complete yet.\n+        return SnapshotCompletionResult::SKIPPED;\n+    }\n+\n+    assert(SnapshotBlockhash());\n+    uint256 snapshot_blockhash = *SnapshotBlockhash();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r998126326",
      "id" : 998126326,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847fjL2",
      "original_commit_id" : "a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc",
      "original_line" : 5207,
      "original_position" : 143,
      "original_start_line" : 5206,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1145532345,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998126326/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-10-18T12:58:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998126326",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r998169857"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998169857"
         }
      },
      "author_association" : "MEMBER",
      "body" : "a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc\r\n```suggestion\r\n    const auto& ibd_stats = *maybe_ibd_stats;\r\n```",
      "commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "created_at" : "2022-10-18T12:52:44Z",
      "diff_hunk" : "@@ -5121,6 +5170,146 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+// Currently, this function holds cs_main for its duration, which could be for\n+// multiple minutes due to the GetUTXOStats call. This hold is necessary\n+// because we need to avoid advancing the background validation chainstate\n+// farther than the snapshot base block - and this function is also invoked\n+// from within ConnectTip, i.e. from within ActivateBestChain, so cs_main is\n+// held anyway.\n+//\n+// Eventually (TODO), we could somehow separate this function's runtime from\n+// maintenance of the active chain, but that will either require\n+//\n+//  (i) setting `m_stop_use` immediately and ensuring all chainstate accesses go\n+//      through IsUsable() checks, or\n+//\n+//  (ii) giving each chainstate its own lock instead of using cs_main for everything.\n+SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation(\n+      std::function<void(bilingual_str)> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (m_ibd_chainstate.get() == &this->ActiveChainstate() ||\n+            !this->IsUsable(m_snapshot_chainstate.get()) ||\n+            !this->IsUsable(m_ibd_chainstate.get()) ||\n+            !m_ibd_chainstate->m_chain.Tip()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return SnapshotCompletionResult::SKIPPED;\n+    }\n+    int snapshot_tip_height = this->ActiveHeight();\n+    int snapshot_base_height = *this->GetSnapshotBaseHeight();\n+    CBlockIndex& index_new = *m_ibd_chainstate->m_chain.Tip();\n+\n+    if (index_new.nHeight < snapshot_base_height) {\n+        // Background IBD not complete yet.\n+        return SnapshotCompletionResult::SKIPPED;\n+    }\n+\n+    assert(SnapshotBlockhash());\n+    uint256 snapshot_blockhash = *SnapshotBlockhash();\n+\n+    if (index_new.GetBlockHash() != snapshot_blockhash) {\n+      LogPrintf(\"[snapshot] supposed base block %s does not match the \" /* Continued */\n+          \"snapshot base block %s (height %d). Snapshot is not valid.\",\n+          index_new.ToString(), snapshot_blockhash.ToString(), snapshot_base_height);\n+       return SnapshotCompletionResult::BASE_BLOCKHASH_MISMATCH;\n+    }\n+\n+    assert(index_new.nHeight == snapshot_base_height);\n+\n+    auto handle_invalid_snapshot = [&]() EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        bilingual_str user_error = strprintf(_(\n+            \"%s failed to validate the -assumeutxo snapshot state. \"\n+            \"This indicates a hardware problem, or a bug in the software, or a \"\n+            \"bad software modification that allowed an invalid snapshot to be \"\n+            \"loaded. As a result of this, the node will shut down and stop using any \"\n+            \"state that was built on the snapshot, resetting the chain height \"\n+            \"from %d to %d. On the next \"\n+            \"restart, the node will resume syncing from %d \"\n+            \"without using any snapshot data. \"\n+            \"Please report this incident to %s, including how you obtained the snapshot.\"),\n+            PACKAGE_NAME, snapshot_tip_height, snapshot_base_height, snapshot_base_height, PACKAGE_BUGREPORT\n+        );\n+\n+        LogPrintf(\"[snapshot] !!! %s\\n\", user_error.original);\n+        LogPrintf(\"[snapshot] deleting snapshot, reverting to validated chain, and stopping node\\n\");\n+\n+        m_active_chainstate = m_ibd_chainstate.get();\n+        m_snapshot_chainstate->m_stop_use = true;\n+        assert(!this->IsUsable(m_snapshot_chainstate.get()));\n+        assert(this->IsUsable(m_ibd_chainstate.get()));\n+\n+        m_snapshot_chainstate->InvalidateCoinsDBOnDisk();\n+\n+        shutdown_fnc(user_error);\n+    };\n+\n+    int curr_height = m_ibd_chainstate->m_chain.Height();\n+\n+    assert(snapshot_base_height == curr_height);\n+    assert(snapshot_base_height == index_new.nHeight);\n+    assert(this->IsUsable(m_snapshot_chainstate.get()));\n+    assert(this->GetAll().size() == 2);\n+\n+    CCoinsViewDB& ibd_coins_db = m_ibd_chainstate->CoinsDB();\n+    m_ibd_chainstate->ForceFlushStateToDisk();\n+\n+    auto maybe_au_data = ExpectedAssumeutxo(curr_height, ::Params());\n+    if (!maybe_au_data) {\n+        LogPrintf(\"[snapshot] assumeutxo data not found for height \" /* Continued */\n+            \"(%d) - refusing to validate snapshot\\n\", curr_height);\n+        handle_invalid_snapshot();\n+        return SnapshotCompletionResult::MISSING_CHAINPARAMS;\n+    }\n+\n+    const AssumeutxoData& au_data = *maybe_au_data;\n+    std::optional<CCoinsStats> maybe_ibd_stats;\n+    LogPrintf(\"[snapshot] computing UTXO stats for background chainstate to validate \" /* Continued */\n+        \"snapshot - this could take a few minutes\\n\");\n+    try {\n+        maybe_ibd_stats = ComputeUTXOStats(\n+            CoinStatsHashType::HASH_SERIALIZED,\n+            &ibd_coins_db,\n+            m_blockman,\n+            SnapshotUTXOHashBreakpoint);\n+    } catch (StopHashingException) {\n+        return SnapshotCompletionResult::STATS_FAILED;\n+    }\n+\n+    // XXX note that this function is slow and will hold cs_main for potentially minutes.\n+    if (!maybe_ibd_stats) {\n+        LogPrintf(\"[snapshot] failed to generate stats for validation coins db\\n\");\n+        // While this isn't a problem with the snapshot per se, this condition\n+        // prevents us from validating the snapshot, so we should shut down and let the\n+        // user handle the issue manually.\n+        handle_invalid_snapshot();\n+        return SnapshotCompletionResult::STATS_FAILED;\n+    }\n+    const auto ibd_stats = *maybe_ibd_stats;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r998169857",
      "id" : 998169857,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847ft0B",
      "original_commit_id" : "50909f0d5dc3a8f15c25ebab756b9a723e2deed3",
      "original_line" : 5288,
      "original_position" : 246,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1145532345,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998169857/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-18T12:58:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998169857",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r998170906"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998170906"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc\r\n```suggestion\r\n    const auto& snapshot_chainstate_path = *snapshot_chainstate_path_maybe;\r\n    const auto& ibd_chainstate_path = *ibd_chainstate_path_maybe;\r\n```",
      "commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "created_at" : "2022-10-18T12:53:28Z",
      "diff_hunk" : "@@ -5211,3 +5405,136 @@ Chainstate& ChainstateManager::ActivateExistingSnapshot(CTxMemPool* mempool, uin\n     m_active_chainstate = m_snapshot_chainstate.get();\n     return *m_snapshot_chainstate;\n }\n+\n+void Chainstate::InvalidateCoinsDBOnDisk()\n+{\n+    AssertLockHeld(::cs_main);\n+    // Should never be called on a non-snapshot chainstate.\n+    assert(m_from_snapshot_blockhash);\n+    auto storage_path_maybe = this->CoinsDB().StoragePath();\n+    // Should never be called with a non-existent storage path.\n+    assert(storage_path_maybe);\n+    fs::path snapshot_datadir = *storage_path_maybe;\n+\n+    // Coins views no longer usable.\n+    m_coins_views.reset();\n+\n+    auto invalid_path = snapshot_datadir + \"_INVALID\";\n+    std::string dbpath = fs::PathToString(snapshot_datadir);\n+    std::string target = fs::PathToString(invalid_path);\n+    LogPrintf(\"[snapshot] renaming snapshot datadir %s to %s\\n\", dbpath, target);\n+\n+    try {\n+        fs::rename(snapshot_datadir, invalid_path);\n+    } catch (const fs::filesystem_error& e) {\n+        auto src_str = fs::PathToString(snapshot_datadir);\n+        auto dest_str = fs::PathToString(invalid_path);\n+\n+        LogPrintf(\"%s: error renaming file '%s' -> '%s': %s\\n\",\n+                __func__, src_str, dest_str, e.what());\n+        AbortNode(strprintf(\n+            \"Rename of '%s' -> '%s' failed. \"\n+            \"Do not restart until manually moving or deleting invalid snapshot directory %s.\",\n+            src_str, dest_str, src_str));\n+    }\n+}\n+\n+CBlockIndex* ChainstateManager::GetSnapshotBaseBlock()\n+{\n+    auto blockhash_op = this->SnapshotBlockhash();\n+    if (!blockhash_op) return nullptr;\n+    return Assert(m_blockman.LookupBlockIndex(*blockhash_op));\n+}\n+\n+std::optional<int> ChainstateManager::GetSnapshotBaseHeight()\n+{\n+    CBlockIndex* base = this->GetSnapshotBaseBlock();\n+    return base ? std::make_optional(base->nHeight) : std::nullopt;\n+}\n+\n+bool ChainstateManager::ValidatedSnapshotCleanup()\n+{\n+    AssertLockHeld(::cs_main);\n+    auto get_storage_path = [](auto& chainstate) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) -> std::optional<fs::path> {\n+        if (!(chainstate && chainstate->HasCoinsViews())) {\n+            return {};\n+        }\n+        return chainstate->CoinsDB().StoragePath();\n+    };\n+    std::optional<fs::path> ibd_chainstate_path_maybe = get_storage_path(m_ibd_chainstate);\n+    std::optional<fs::path> snapshot_chainstate_path_maybe = get_storage_path(m_snapshot_chainstate);\n+\n+    if (!this->IsSnapshotValidated()) {\n+        // No need to clean up.\n+        return false;\n+    }\n+    // If either path doesn't exist, that means at least one of the chainstates\n+    // is in-memory, in which case we can't do on-disk cleanup. You'd better be\n+    // in a unittest!\n+    if (!ibd_chainstate_path_maybe || !snapshot_chainstate_path_maybe) {\n+        LogPrintf(\"[snapshot] snapshot chainstate cleanup cannot happen with \" /* Continued */\n+                  \"in-memory chainstates. You are testing, right?\\n\");\n+        return false;\n+    }\n+\n+    auto snapshot_chainstate_path = *snapshot_chainstate_path_maybe;\n+    auto ibd_chainstate_path = *ibd_chainstate_path_maybe;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r998170906",
      "id" : 998170906,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847fuEa",
      "original_commit_id" : "50909f0d5dc3a8f15c25ebab756b9a723e2deed3",
      "original_line" : 5481,
      "original_position" : 377,
      "original_start_line" : 5480,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1145532345,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998170906/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-10-18T12:58:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/998170906",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r999448628"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999448628"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Since unique_ptr has well-defined semantics for the bool operator, I'm going to leave this as is.",
      "commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "created_at" : "2022-10-19T13:28:24Z",
      "diff_hunk" : "@@ -570,12 +570,14 @@ class Chainstate\n     CCoinsViewErrorCatcher& CoinsErrorCatcher() EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n     {\n         AssertLockHeld(::cs_main);\n-        return m_coins_views->m_catcherview;\n+        return Assert(m_coins_views)->m_catcherview;\n     }\n \n     //! Destructs all objects related to accessing the UTXO set.\n     void ResetCoinsViews() { m_coins_views.reset(); }\n \n+    bool HasCoinsViews() { return (bool)m_coins_views; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r999448628",
      "id" : 999448628,
      "in_reply_to_id" : 998054962,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847kmA0",
      "original_commit_id" : "236ae38274669ce9fd4dcd2a85ab2c373226457f",
      "original_line" : 580,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 1147566419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999448628/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-19T14:38:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999448628",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r999530645"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999530645"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed, thanks.",
      "commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "created_at" : "2022-10-19T14:23:19Z",
      "diff_hunk" : "@@ -5043,13 +5089,18 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n \n     assert(coins_cache.GetBestBlock() == base_blockhash);\n \n-    auto breakpoint_fnc = [] { /* TODO insert breakpoint here? */ };\n-\n     // As above, okay to immediately release cs_main here since no other context knows\n     // about the snapshot_chainstate.\n     CCoinsViewDB* snapshot_coinsdb = WITH_LOCK(::cs_main, return &snapshot_chainstate.CoinsDB());\n \n-    const std::optional<CCoinsStats> maybe_stats = ComputeUTXOStats(CoinStatsHashType::HASH_SERIALIZED, snapshot_coinsdb, m_blockman, breakpoint_fnc);\n+    std::optional<CCoinsStats> maybe_stats;\n+\n+    try {\n+        maybe_stats = ComputeUTXOStats(\n+            CoinStatsHashType::HASH_SERIALIZED, snapshot_coinsdb, m_blockman, SnapshotUTXOHashBreakpoint);\n+    } catch (StopHashingException) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r999530645",
      "id" : 999530645,
      "in_reply_to_id" : 997485284,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847k6CV",
      "original_commit_id" : "a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc",
      "original_line" : 5101,
      "original_position" : 97,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1147566419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999530645/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-19T14:38:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999530645",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r999535407"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999535407"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good catch! Fixed.",
      "commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "created_at" : "2022-10-19T14:26:48Z",
      "diff_hunk" : "@@ -5117,6 +5168,146 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+// Currently, this function holds cs_main for its duration, which could be for\n+// multiple minutes due to the GetUTXOStats call. This hold is necessary\n+// because we need to avoid advancing the background validation chainstate\n+// farther than the snapshot base block - and this function is also invoked\n+// from within ConnectTip, i.e. from within ActivateBestChain, so cs_main is\n+// held anyway.\n+//\n+// Eventually (TODO), we could somehow separate this function's runtime from\n+// maintenance of the active chain, but that will either require\n+//\n+//  (i) setting `m_stop_use` immediately and ensuring all chainstate accesses go\n+//      through IsUsable() checks, or\n+//\n+//  (ii) giving each chainstate its own lock instead of using cs_main for everything.\n+SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation(\n+      std::function<void(bilingual_str)> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (m_ibd_chainstate.get() == &this->ActiveChainstate() ||\n+            !this->IsUsable(m_snapshot_chainstate.get()) ||\n+            !this->IsUsable(m_ibd_chainstate.get()) ||\n+            !m_ibd_chainstate->m_chain.Tip()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return SnapshotCompletionResult::SKIPPED;\n+    }\n+    int snapshot_tip_height = this->ActiveHeight();\n+    int snapshot_base_height = *this->GetSnapshotBaseHeight();\n+    CBlockIndex& index_new = *m_ibd_chainstate->m_chain.Tip();\n+\n+    if (index_new.nHeight < snapshot_base_height) {\n+        // Background IBD not complete yet.\n+        return SnapshotCompletionResult::SKIPPED;\n+    }\n+\n+    assert(SnapshotBlockhash());\n+    uint256 snapshot_blockhash = *SnapshotBlockhash();\n+\n+    if (index_new.GetBlockHash() != snapshot_blockhash) {\n+      LogPrintf(\"[snapshot] supposed base block %s does not match the \" /* Continued */\n+          \"snapshot base block %s (height %d). Snapshot is not valid.\",\n+          index_new.ToString(), snapshot_blockhash.ToString(), snapshot_base_height);\n+       return SnapshotCompletionResult::BASE_BLOCKHASH_MISMATCH;\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r999535407",
      "id" : 999535407,
      "in_reply_to_id" : 997479271,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847k7Mv",
      "original_commit_id" : "a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc",
      "original_line" : 5214,
      "original_position" : 150,
      "original_start_line" : 5209,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1147566419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999535407/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-10-19T14:38:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999535407",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r999539875"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999539875"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think the idea is that we may want to preserve the bad snapshot datadir for later analysis or issue filing. I'll make a note in the abort node log message that the user can manually remove the directory if desired or save it for later forensics when filing an issue.",
      "commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "created_at" : "2022-10-19T14:29:31Z",
      "diff_hunk" : "@@ -5213,6 +5404,39 @@ Chainstate& ChainstateManager::ActivateExistingSnapshot(CTxMemPool* mempool, uin\n     return *m_snapshot_chainstate;\n }\n \n+void Chainstate::InvalidateCoinsDBOnDisk()\n+{\n+    AssertLockHeld(::cs_main);\n+    // Should never be called on a non-snapshot chainstate.\n+    assert(m_from_snapshot_blockhash);\n+    auto storage_path_maybe = this->CoinsDB().StoragePath();\n+    // Should never be called with a non-existent storage path.\n+    assert(storage_path_maybe);\n+    fs::path snapshot_datadir = *storage_path_maybe;\n+\n+    // Coins views no longer usable.\n+    m_coins_views.reset();\n+\n+    auto invalid_path = snapshot_datadir + \"_INVALID\";\n+    std::string dbpath = fs::PathToString(snapshot_datadir);\n+    std::string target = fs::PathToString(invalid_path);\n+    LogPrintf(\"[snapshot] renaming snapshot datadir %s to %s\\n\", dbpath, target);\n+\n+    try {\n+        fs::rename(snapshot_datadir, invalid_path);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r999539875",
      "id" : 999539875,
      "in_reply_to_id" : 997480620,
      "line" : 5434,
      "node_id" : "PRRC_kwDOABII5847k8Sj",
      "original_commit_id" : "a65af66bd5a292d0bd0030f0c6b49a3dfab0afcc",
      "original_line" : 5434,
      "original_position" : 273,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 330,
      "pull_request_review_id" : 1147566419,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999539875/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-19T14:38:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999539875",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r999586196"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999586196"
         }
      },
      "author_association" : "MEMBER",
      "body" : "alright, the function can be made const though",
      "commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "created_at" : "2022-10-19T14:59:45Z",
      "diff_hunk" : "@@ -570,12 +570,14 @@ class Chainstate\n     CCoinsViewErrorCatcher& CoinsErrorCatcher() EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n     {\n         AssertLockHeld(::cs_main);\n-        return m_coins_views->m_catcherview;\n+        return Assert(m_coins_views)->m_catcherview;\n     }\n \n     //! Destructs all objects related to accessing the UTXO set.\n     void ResetCoinsViews() { m_coins_views.reset(); }\n \n+    bool HasCoinsViews() { return (bool)m_coins_views; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r999586196",
      "id" : 999586196,
      "in_reply_to_id" : 998054962,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847lHmU",
      "original_commit_id" : "236ae38274669ce9fd4dcd2a85ab2c373226457f",
      "original_line" : 580,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 1147765130,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999586196/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-19T14:59:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999586196",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r999588975"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999588975"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yep, done.",
      "commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "created_at" : "2022-10-19T15:02:01Z",
      "diff_hunk" : "@@ -570,12 +570,14 @@ class Chainstate\n     CCoinsViewErrorCatcher& CoinsErrorCatcher() EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n     {\n         AssertLockHeld(::cs_main);\n-        return m_coins_views->m_catcherview;\n+        return Assert(m_coins_views)->m_catcherview;\n     }\n \n     //! Destructs all objects related to accessing the UTXO set.\n     void ResetCoinsViews() { m_coins_views.reset(); }\n \n+    bool HasCoinsViews() { return (bool)m_coins_views; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r999588975",
      "id" : 999588975,
      "in_reply_to_id" : 998054962,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847lIRv",
      "original_commit_id" : "236ae38274669ce9fd4dcd2a85ab2c373226457f",
      "original_line" : 580,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 1147769381,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999588975/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-19T15:02:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999588975",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r999601495"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999601495"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It hasn't changed :grimacing: ",
      "commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "created_at" : "2022-10-19T15:12:29Z",
      "diff_hunk" : "@@ -570,12 +570,14 @@ class Chainstate\n     CCoinsViewErrorCatcher& CoinsErrorCatcher() EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n     {\n         AssertLockHeld(::cs_main);\n-        return m_coins_views->m_catcherview;\n+        return Assert(m_coins_views)->m_catcherview;\n     }\n \n     //! Destructs all objects related to accessing the UTXO set.\n     void ResetCoinsViews() { m_coins_views.reset(); }\n \n+    bool HasCoinsViews() { return (bool)m_coins_views; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r999601495",
      "id" : 999601495,
      "in_reply_to_id" : 998054962,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847lLVX",
      "original_commit_id" : "236ae38274669ce9fd4dcd2a85ab2c373226457f",
      "original_line" : 580,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 1147788194,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999601495/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-19T15:12:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999601495",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r999722362"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999722362"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ugh oops, my mistake. Fixed.",
      "commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "created_at" : "2022-10-19T16:57:34Z",
      "diff_hunk" : "@@ -570,12 +570,14 @@ class Chainstate\n     CCoinsViewErrorCatcher& CoinsErrorCatcher() EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n     {\n         AssertLockHeld(::cs_main);\n-        return m_coins_views->m_catcherview;\n+        return Assert(m_coins_views)->m_catcherview;\n     }\n \n     //! Destructs all objects related to accessing the UTXO set.\n     void ResetCoinsViews() { m_coins_views.reset(); }\n \n+    bool HasCoinsViews() { return (bool)m_coins_views; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r999722362",
      "id" : 999722362,
      "in_reply_to_id" : 998054962,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5847lo16",
      "original_commit_id" : "236ae38274669ce9fd4dcd2a85ab2c373226457f",
      "original_line" : 580,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 1147968942,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999722362/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-19T16:57:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999722362",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r999975053"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999975053"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think could do a `LookupBlockIndex` to display the block height, as it's more speaking for the node operator.",
      "commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "created_at" : "2022-10-19T22:07:33Z",
      "diff_hunk" : "@@ -167,6 +134,93 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n     return {ChainstateLoadStatus::SUCCESS, {}};\n }\n \n+ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSizes& cache_sizes,\n+                                    const ChainstateLoadOptions& options)\n+{\n+    if (!hashAssumeValid.IsNull()) {\n+        LogPrintf(\"Assuming ancestors of block %s have valid signatures.\\n\", hashAssumeValid.GetHex());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r999975053",
      "id" : 999975053,
      "line" : 141,
      "node_id" : "PRRC_kwDOABII5847mmiN",
      "original_commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "original_line" : 141,
      "original_position" : 106,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : 106,
      "pull_request_review_id" : 1148330864,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999975053/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-19T22:31:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999975053",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r999978823"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999978823"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think you could have a quick log of the chainstate initialization success, as this function has a lot of checks/ops and you can inform the node operator where he is in the initialization sequence.",
      "commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "created_at" : "2022-10-19T22:14:21Z",
      "diff_hunk" : "@@ -167,6 +134,93 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n     return {ChainstateLoadStatus::SUCCESS, {}};\n }\n \n+ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSizes& cache_sizes,\n+                                    const ChainstateLoadOptions& options)\n+{\n+    if (!hashAssumeValid.IsNull()) {\n+        LogPrintf(\"Assuming ancestors of block %s have valid signatures.\\n\", hashAssumeValid.GetHex());\n+    } else {\n+        LogPrintf(\"Validating signatures for all blocks.\\n\");\n+    }\n+    LogPrintf(\"Setting nMinimumChainWork=%s\\n\", nMinimumChainWork.GetHex());\n+    if (nMinimumChainWork < UintToArith256(chainman.GetConsensus().nMinimumChainWork)) {\n+        LogPrintf(\"Warning: nMinimumChainWork set below default value of %s\\n\", chainman.GetConsensus().nMinimumChainWork.GetHex());\n+    }\n+    if (nPruneTarget == std::numeric_limits<uint64_t>::max()) {\n+        LogPrintf(\"Block pruning enabled.  Use RPC call pruneblockchain(height) to manually prune block and undo files.\\n\");\n+    } else if (nPruneTarget) {\n+        LogPrintf(\"Prune configured to target %u MiB on disk for block and undo files.\\n\", nPruneTarget / 1024 / 1024);\n+    }\n+\n+    LOCK(cs_main);\n+    chainman.m_total_coinstip_cache = cache_sizes.coins;\n+    chainman.m_total_coinsdb_cache = cache_sizes.coins_db;\n+\n+    // Load the fully validated chainstate.\n+    chainman.InitializeChainstate(options.mempool);\n+\n+    // Load a chain created from a UTXO snapshot, if any exist.\n+    chainman.DetectSnapshotChainstate(options.mempool);\n+\n+    auto& pblocktree{chainman.m_blockman.m_block_tree_db};\n+    // new CBlockTreeDB tries to delete the existing file, which\n+    // fails if it's still open from the previous loop. Close it first:\n+    pblocktree.reset();\n+    pblocktree.reset(new CBlockTreeDB(cache_sizes.block_tree_db, options.block_tree_db_in_memory, options.reindex));\n+\n+    if (options.reindex) {\n+        pblocktree->WriteReindexing(true);\n+        //If we're reindexing in prune mode, wipe away unusable block files and all undo data files\n+        if (options.prune) {\n+            CleanupBlockRevFiles();\n+        }\n+    }\n+\n+    auto [init_status, init_error] = CompleteChainstateInitialization(chainman, options);\n+    if (init_status != ChainstateLoadStatus::SUCCESS) {\n+        return {init_status, init_error};\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r999978823",
      "id" : 999978823,
      "line" : 182,
      "node_id" : "PRRC_kwDOABII5847mndH",
      "original_commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "original_line" : 182,
      "original_position" : 147,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : 147,
      "pull_request_review_id" : 1148330864,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999978823/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-19T22:31:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999978823",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r999984699"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999984699"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think you could go even further, and invite the node operator to fulfill an issue on the repository or at least indicate a communication process to feedback the bug to us ?",
      "commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "created_at" : "2022-10-19T22:24:57Z",
      "diff_hunk" : "@@ -2973,6 +2985,13 @@ bool Chainstate::ActivateBestChain(BlockValidationState& state, std::shared_ptr<\n     // we use m_chainstate_mutex to enforce mutual exclusion so that only one caller may execute this function at a time\n     LOCK(m_chainstate_mutex);\n \n+    // Belt-and-suspenders check that we aren't attempting to advance the background\n+    // chainstate past the snapshot base block.\n+    if (WITH_LOCK(::cs_main, return m_disabled)) {\n+        LogPrintf(\"m_disabled is set - this chainstate should not be in operation. Bug?.\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r999984699",
      "id" : 999984699,
      "line" : 2991,
      "node_id" : "PRRC_kwDOABII5847mo47",
      "original_commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "original_line" : 2991,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 26,
      "pull_request_review_id" : 1148330864,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999984699/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-19T22:31:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/999984699",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-10-26T11:19:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1291878476",
      "id" : 1291878476,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585NAIBM",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1291878476/reactions"
      },
      "updated_at" : "2022-10-26T11:19:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1291878476",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1009792671"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1009792671"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It looks like there has been a rebase error and two previous commits were combined into one commit that doesn't have a valid commit description. The two previous commits were:\r\n\r\n- \"move-only-ish: init: factor out chainstate initialization\" (aead772a24b1f7759cd756bf6534a70dc41ca080)\r\n- \"validation: add ChainMan logic for completing UTXO snapshot validation\" (863e5f389e08cd2069e4834df82879ec39142aac)\r\n\r\nand the new combined commit is \r\n\r\n - \"move-only-ish: init: factor out chainstate initialization\" (07b9dea9d4e8de2ce22e8ba50172a4af85801931)\r\n\r\nIt would help review to split these up and separate moveonly changes from other changes",
      "commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "created_at" : "2022-10-31T19:38:21Z",
      "diff_hunk" : "@@ -5117,6 +5168,149 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+// Currently, this function holds cs_main for its duration, which could be for\n+// multiple minutes due to the GetUTXOStats call. This hold is necessary\n+// because we need to avoid advancing the background validation chainstate\n+// farther than the snapshot base block - and this function is also invoked\n+// from within ConnectTip, i.e. from within ActivateBestChain, so cs_main is\n+// held anyway.\n+//\n+// Eventually (TODO), we could somehow separate this function's runtime from\n+// maintenance of the active chain, but that will either require\n+//\n+//  (i) setting `m_disabled` immediately and ensuring all chainstate accesses go\n+//      through IsUsable() checks, or\n+//\n+//  (ii) giving each chainstate its own lock instead of using cs_main for everything.\n+SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1009792671",
      "id" : 1009792671,
      "line" : 5187,
      "node_id" : "PRRC_kwDOABII5848MDaf",
      "original_commit_id" : "07b9dea9d4e8de2ce22e8ba50172a4af85801931",
      "original_line" : 5185,
      "original_position" : 121,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 121,
      "pull_request_review_id" : 1162441236,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1009792671/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-31T19:38:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1009792671",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1009927654"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1009927654"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Comment could be updated to reflect snapshot validation implied the ibd chainstate is from now disabled. No ulterior blocks should be connected.",
      "commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "created_at" : "2022-10-31T22:33:14Z",
      "diff_hunk" : "@@ -985,7 +997,10 @@ class ChainstateManager\n     std::optional<uint256> SnapshotBlockhash() const;\n \n     //! Is there a snapshot in use and has it been fully validated?",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1009927654",
      "id" : 1009927654,
      "line" : 1048,
      "node_id" : "PRRC_kwDOABII5848MkXm",
      "original_commit_id" : "1dda5f3f5982c8231b4c122b372e02b9ca7d4994",
      "original_line" : 999,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 44,
      "pull_request_review_id" : 1162638204,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1009927654/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-31T23:02:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1009927654",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1009936620"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1009936620"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Comment is unclear if toggle is setup once \"same-height-of-snapshot' or if it also includes UTXO set hash comparison (`PopulateAndValidateSnapshot()`) ",
      "commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "created_at" : "2022-10-31T22:50:57Z",
      "diff_hunk" : "@@ -470,6 +470,13 @@ class Chainstate\n     //! Manages the UTXO set, which is a reflection of the contents of `m_chain`.\n     std::unique_ptr<CoinsViews> m_coins_views;\n \n+    //! This toggle exists for use when doing background validation for UTXO\n+    //! snapshots. It is set once the background validation chain reaches the\n+    //! same height as the base of the snapshot, and signals that we should no",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1009936620",
      "id" : 1009936620,
      "line" : 476,
      "node_id" : "PRRC_kwDOABII5848Mmjs",
      "original_commit_id" : "1dda5f3f5982c8231b4c122b372e02b9ca7d4994",
      "original_line" : 475,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 6,
      "pull_request_review_id" : 1162638204,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1009936620/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-31T23:02:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1009936620",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1009939365"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1009939365"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can get a one line comment. That way reduces confusion for the next contributor on a quest to refactor `validation.h`/`coins.h`, without introducing odds of weird consensus bugs. ",
      "commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "created_at" : "2022-10-31T22:56:45Z",
      "diff_hunk" : "@@ -570,12 +570,14 @@ class Chainstate\n     CCoinsViewErrorCatcher& CoinsErrorCatcher() EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n     {\n         AssertLockHeld(::cs_main);\n-        return m_coins_views->m_catcherview;\n+        return Assert(m_coins_views)->m_catcherview;\n     }\n \n     //! Destructs all objects related to accessing the UTXO set.\n     void ResetCoinsViews() { m_coins_views.reset(); }\n \n+    bool HasCoinsViews() const { return (bool)m_coins_views; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1009939365",
      "id" : 1009939365,
      "line" : 580,
      "node_id" : "PRRC_kwDOABII5848MnOl",
      "original_commit_id" : "65d2ce6417004350466017893d553d04237f4c12",
      "original_line" : 579,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 30,
      "pull_request_review_id" : 1162638204,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1009939365/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-31T23:02:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1009939365",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1012923414"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1012923414"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Wow, no idea how that got so screwed up. Will fix, thanks.",
      "commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "created_at" : "2022-11-03T13:46:56Z",
      "diff_hunk" : "@@ -5117,6 +5168,149 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+// Currently, this function holds cs_main for its duration, which could be for\n+// multiple minutes due to the GetUTXOStats call. This hold is necessary\n+// because we need to avoid advancing the background validation chainstate\n+// farther than the snapshot base block - and this function is also invoked\n+// from within ConnectTip, i.e. from within ActivateBestChain, so cs_main is\n+// held anyway.\n+//\n+// Eventually (TODO), we could somehow separate this function's runtime from\n+// maintenance of the active chain, but that will either require\n+//\n+//  (i) setting `m_disabled` immediately and ensuring all chainstate accesses go\n+//      through IsUsable() checks, or\n+//\n+//  (ii) giving each chainstate its own lock instead of using cs_main for everything.\n+SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1012923414",
      "id" : 1012923414,
      "in_reply_to_id" : 1009792671,
      "line" : 5187,
      "node_id" : "PRRC_kwDOABII5848X_wW",
      "original_commit_id" : "07b9dea9d4e8de2ce22e8ba50172a4af85801931",
      "original_line" : 5185,
      "original_position" : 121,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 121,
      "pull_request_review_id" : 1166931065,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1012923414/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-03T13:46:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1012923414",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1013346124"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1013346124"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Out of scope for this PR, since this is just code I moved.",
      "commit_id" : "e7dc5e6e52811e2b03c053ab07fc25720e6f1d10",
      "created_at" : "2022-11-03T20:00:54Z",
      "diff_hunk" : "@@ -167,6 +134,93 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n     return {ChainstateLoadStatus::SUCCESS, {}};\n }\n \n+ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSizes& cache_sizes,\n+                                    const ChainstateLoadOptions& options)\n+{\n+    if (!hashAssumeValid.IsNull()) {\n+        LogPrintf(\"Assuming ancestors of block %s have valid signatures.\\n\", hashAssumeValid.GetHex());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1013346124",
      "id" : 1013346124,
      "in_reply_to_id" : 999975053,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5848Zm9M",
      "original_commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "original_line" : 141,
      "original_position" : 106,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : null,
      "pull_request_review_id" : 1167589482,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1013346124/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-03T20:00:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1013346124",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1013346413"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1013346413"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Out of scope or possibly follow-up given this was existing code.",
      "commit_id" : "e7dc5e6e52811e2b03c053ab07fc25720e6f1d10",
      "created_at" : "2022-11-03T20:01:20Z",
      "diff_hunk" : "@@ -167,6 +134,93 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n     return {ChainstateLoadStatus::SUCCESS, {}};\n }\n \n+ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSizes& cache_sizes,\n+                                    const ChainstateLoadOptions& options)\n+{\n+    if (!hashAssumeValid.IsNull()) {\n+        LogPrintf(\"Assuming ancestors of block %s have valid signatures.\\n\", hashAssumeValid.GetHex());\n+    } else {\n+        LogPrintf(\"Validating signatures for all blocks.\\n\");\n+    }\n+    LogPrintf(\"Setting nMinimumChainWork=%s\\n\", nMinimumChainWork.GetHex());\n+    if (nMinimumChainWork < UintToArith256(chainman.GetConsensus().nMinimumChainWork)) {\n+        LogPrintf(\"Warning: nMinimumChainWork set below default value of %s\\n\", chainman.GetConsensus().nMinimumChainWork.GetHex());\n+    }\n+    if (nPruneTarget == std::numeric_limits<uint64_t>::max()) {\n+        LogPrintf(\"Block pruning enabled.  Use RPC call pruneblockchain(height) to manually prune block and undo files.\\n\");\n+    } else if (nPruneTarget) {\n+        LogPrintf(\"Prune configured to target %u MiB on disk for block and undo files.\\n\", nPruneTarget / 1024 / 1024);\n+    }\n+\n+    LOCK(cs_main);\n+    chainman.m_total_coinstip_cache = cache_sizes.coins;\n+    chainman.m_total_coinsdb_cache = cache_sizes.coins_db;\n+\n+    // Load the fully validated chainstate.\n+    chainman.InitializeChainstate(options.mempool);\n+\n+    // Load a chain created from a UTXO snapshot, if any exist.\n+    chainman.DetectSnapshotChainstate(options.mempool);\n+\n+    auto& pblocktree{chainman.m_blockman.m_block_tree_db};\n+    // new CBlockTreeDB tries to delete the existing file, which\n+    // fails if it's still open from the previous loop. Close it first:\n+    pblocktree.reset();\n+    pblocktree.reset(new CBlockTreeDB(cache_sizes.block_tree_db, options.block_tree_db_in_memory, options.reindex));\n+\n+    if (options.reindex) {\n+        pblocktree->WriteReindexing(true);\n+        //If we're reindexing in prune mode, wipe away unusable block files and all undo data files\n+        if (options.prune) {\n+            CleanupBlockRevFiles();\n+        }\n+    }\n+\n+    auto [init_status, init_error] = CompleteChainstateInitialization(chainman, options);\n+    if (init_status != ChainstateLoadStatus::SUCCESS) {\n+        return {init_status, init_error};\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1013346413",
      "id" : 1013346413,
      "in_reply_to_id" : 999978823,
      "line" : 187,
      "node_id" : "PRRC_kwDOABII5848ZnBt",
      "original_commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "original_line" : 187,
      "original_position" : 147,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : 95,
      "pull_request_review_id" : 1167589989,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1013346413/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-03T20:01:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1013346413",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1013360119"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1013360119"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added.",
      "commit_id" : "e7dc5e6e52811e2b03c053ab07fc25720e6f1d10",
      "created_at" : "2022-11-03T20:18:40Z",
      "diff_hunk" : "@@ -570,12 +570,14 @@ class Chainstate\n     CCoinsViewErrorCatcher& CoinsErrorCatcher() EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n     {\n         AssertLockHeld(::cs_main);\n-        return m_coins_views->m_catcherview;\n+        return Assert(m_coins_views)->m_catcherview;\n     }\n \n     //! Destructs all objects related to accessing the UTXO set.\n     void ResetCoinsViews() { m_coins_views.reset(); }\n \n+    bool HasCoinsViews() const { return (bool)m_coins_views; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1013360119",
      "id" : 1013360119,
      "in_reply_to_id" : 1009939365,
      "line" : 560,
      "node_id" : "PRRC_kwDOABII5848ZqX3",
      "original_commit_id" : "65d2ce6417004350466017893d553d04237f4c12",
      "original_line" : 560,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 55,
      "pull_request_review_id" : 1167610304,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1013360119/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-03T20:18:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1013360119",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1013360164"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1013360164"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added.",
      "commit_id" : "e7dc5e6e52811e2b03c053ab07fc25720e6f1d10",
      "created_at" : "2022-11-03T20:18:44Z",
      "diff_hunk" : "@@ -470,6 +470,13 @@ class Chainstate\n     //! Manages the UTXO set, which is a reflection of the contents of `m_chain`.\n     std::unique_ptr<CoinsViews> m_coins_views;\n \n+    //! This toggle exists for use when doing background validation for UTXO\n+    //! snapshots. It is set once the background validation chain reaches the\n+    //! same height as the base of the snapshot, and signals that we should no",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1013360164",
      "id" : 1013360164,
      "in_reply_to_id" : 1009936620,
      "line" : 457,
      "node_id" : "PRRC_kwDOABII5848ZqYk",
      "original_commit_id" : "1dda5f3f5982c8231b4c122b372e02b9ca7d4994",
      "original_line" : 457,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 14,
      "pull_request_review_id" : 1167610376,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1013360164/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-03T20:18:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1013360164",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016039682"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016039682"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add CChainState::m_disabled and ChainMan::isUsable\" (53f9a79c87fff061d7f5232b9c4e829f9380fa01)\r\n\r\nThis definition of `IsSnapshotValidated` seems to contradict earlier comment that m_disabled flag \"does *not* indicate that the background chainstate has been used to fully validate the snapshot\". If this is not a bug it might be useful to add a comment to this function to clarify, or maybe call something like `IsBackgroundChainDownloaded`.",
      "commit_id" : "e7dc5e6e52811e2b03c053ab07fc25720e6f1d10",
      "created_at" : "2022-11-08T00:53:50Z",
      "diff_hunk" : "@@ -962,7 +976,10 @@ class ChainstateManager\n     std::optional<uint256> SnapshotBlockhash() const;\n \n     //! Is there a snapshot in use and has it been fully validated?\n-    bool IsSnapshotValidated() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main) { return m_snapshot_validated; }\n+    bool IsSnapshotValidated() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n+    {\n+        return m_snapshot_chainstate && m_ibd_chainstate && m_ibd_chainstate->m_disabled;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016039682",
      "id" : 1016039682,
      "line" : 1031,
      "node_id" : "PRRC_kwDOABII5848j4kC",
      "original_commit_id" : "53f9a79c87fff061d7f5232b9c4e829f9380fa01",
      "original_line" : 981,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 50,
      "pull_request_review_id" : 1171289324,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016039682/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-08T04:58:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016039682",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016045839"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016045839"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"move-only-ish: init: factor out chainstate initialization\" (15a86a4940777a427d2b1c8c7c1e533de440f951)\r\n\r\nThis is just an aesthetic suggestion, but instead of splitting this function in two and putting the second half below the first, half you could forward declare the second `CompleteChainstateInitialization` function, and keep the first part first and second part second. This would also make the diff a lot smaller because basically no code would have to move.",
      "commit_id" : "e7dc5e6e52811e2b03c053ab07fc25720e6f1d10",
      "created_at" : "2022-11-08T01:07:08Z",
      "diff_hunk" : "@@ -28,38 +28,13 @@\n #include <vector>\n \n namespace node {\n-ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSizes& cache_sizes,\n-                                    const ChainstateLoadOptions& options)\n+// Complete initialization of chainstates after the initial call has been made\n+// to ChainstateManager::InitializeChainstate().\n+static ChainstateLoadResult CompleteChainstateInitialization(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016045839",
      "id" : 1016045839,
      "line" : 33,
      "node_id" : "PRRC_kwDOABII5848j6EP",
      "original_commit_id" : "15a86a4940777a427d2b1c8c7c1e533de440f951",
      "original_line" : 33,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : 8,
      "pull_request_review_id" : 1171289324,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016045839/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-08T04:58:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016045839",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016047755"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016047755"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainMan logic for completing UTXO snapshot validation\" (e17d51768bcf5f7791fdf7d0b2ee4b11cc64d922)\r\n\r\nWhich part of this is TODO? It seems like current code is calling InvalidateCoinsDBOnDisk and shutting down as described",
      "commit_id" : "e7dc5e6e52811e2b03c053ab07fc25720e6f1d10",
      "created_at" : "2022-11-08T01:11:06Z",
      "diff_hunk" : "@@ -955,6 +990,18 @@ class ChainstateManager\n     [[nodiscard]] bool ActivateSnapshot(\n         AutoFile& coins_file, const node::SnapshotMetadata& metadata, bool in_memory);\n \n+    //! Once the background validation chainstate has reached the height which\n+    //! is the base of the UTXO snapshot in use, compare its coins to ensure\n+    //! they match those expected by the snapshot.\n+    //!\n+    //! If the coins match (expected), then mark the validation chainstate for\n+    //! deletion and continue using the snapshot chainstate as active.\n+    //! Otherwise, revert to using the ibd chainstate and shutdown (TODO).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016047755",
      "id" : 1016047755,
      "line" : 999,
      "node_id" : "PRRC_kwDOABII5848j6iL",
      "original_commit_id" : "e17d51768bcf5f7791fdf7d0b2ee4b11cc64d922",
      "original_line" : 999,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 69,
      "pull_request_review_id" : 1171289324,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016047755/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-08T04:58:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016047755",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016053694"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016053694"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainMan logic for completing UTXO snapshot validation\" (e17d51768bcf5f7791fdf7d0b2ee4b11cc64d922)\r\n\r\nYou probably explained this somewhere previously, but I can't remember why this is expected. Could you replace \"This is expected\" sentence with something more specific like \"The background chainstate is only deleted on startup, not while the node is running, because of [reason]\".",
      "commit_id" : "e7dc5e6e52811e2b03c053ab07fc25720e6f1d10",
      "created_at" : "2022-11-08T01:24:04Z",
      "diff_hunk" : "@@ -183,6 +186,43 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n         return {init_status, init_error};\n     }\n \n+    // If a snapshot chainstate was fully validated by a background chainstate during\n+    // the last run, detect it here and clean up the now-unneeded background\n+    // chainstate. This is the expected case during snapshot completion, and\n+    // not just a belt-and-suspenders.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016053694",
      "id" : 1016053694,
      "line" : 192,
      "node_id" : "PRRC_kwDOABII5848j7--",
      "original_commit_id" : "e17d51768bcf5f7791fdf7d0b2ee4b11cc64d922",
      "original_line" : 192,
      "original_position" : 17,
      "original_start_line" : 191,
      "path" : "src/node/chainstate.cpp",
      "position" : 17,
      "pull_request_review_id" : 1171289324,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016053694/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 191,
      "start_side" : "RIGHT",
      "updated_at" : "2022-11-08T04:58:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016053694",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016061460"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016061460"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainMan logic for completing UTXO snapshot validation\" (e17d51768bcf5f7791fdf7d0b2ee4b11cc64d922)\r\n\r\nWhat's the reason not to restart? It seems like if you do restart the snapshot will just fail to validate again which should be safe because it will either succesfully rename, or show the same error message again. Maybe better to say what to do instead of what not to do like \"Rename of invalid chainstate '%s' -> '%s' failed. Node may refuse to start until bad chainstate is manually renamed or deleted.\"",
      "commit_id" : "e7dc5e6e52811e2b03c053ab07fc25720e6f1d10",
      "created_at" : "2022-11-08T01:37:53Z",
      "diff_hunk" : "@@ -5304,6 +5498,42 @@ Chainstate& ChainstateManager::ActivateExistingSnapshot(CTxMemPool* mempool, uin\n     return *m_snapshot_chainstate;\n }\n \n+void Chainstate::InvalidateCoinsDBOnDisk()\n+{\n+    AssertLockHeld(::cs_main);\n+    // Should never be called on a non-snapshot chainstate.\n+    assert(m_from_snapshot_blockhash);\n+    auto storage_path_maybe = this->CoinsDB().StoragePath();\n+    // Should never be called with a non-existent storage path.\n+    assert(storage_path_maybe);\n+    fs::path snapshot_datadir = *storage_path_maybe;\n+\n+    // Coins views no longer usable.\n+    m_coins_views.reset();\n+\n+    auto invalid_path = snapshot_datadir + \"_INVALID\";\n+    std::string dbpath = fs::PathToString(snapshot_datadir);\n+    std::string target = fs::PathToString(invalid_path);\n+    LogPrintf(\"[snapshot] renaming snapshot datadir %s to %s\\n\", dbpath, target);\n+\n+    // The invalid snapshot datadir is simply moved and not deleted because we may\n+    // want to do forensics later during issue investigation. The user is instructed\n+    // accordingly in MaybeCompleteSnapshotValidation().\n+    try {\n+        fs::rename(snapshot_datadir, invalid_path);\n+    } catch (const fs::filesystem_error& e) {\n+        auto src_str = fs::PathToString(snapshot_datadir);\n+        auto dest_str = fs::PathToString(invalid_path);\n+\n+        LogPrintf(\"%s: error renaming file '%s' -> '%s': %s\\n\",\n+                __func__, src_str, dest_str, e.what());\n+        AbortNode(strprintf(\n+            \"Rename of '%s' -> '%s' failed. \"\n+            \"Do not restart until manually moving or deleting invalid snapshot directory %s.\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016061460",
      "id" : 1016061460,
      "line" : 5534,
      "node_id" : "PRRC_kwDOABII5848j94U",
      "original_commit_id" : "e17d51768bcf5f7791fdf7d0b2ee4b11cc64d922",
      "original_line" : 5532,
      "original_position" : 288,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 288,
      "pull_request_review_id" : 1171289324,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016061460/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-08T04:58:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016061460",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016126310"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016126310"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainMan logic for completing UTXO snapshot validation\" (e17d51768bcf5f7791fdf7d0b2ee4b11cc64d922)\r\n\r\nI think it's just renamed `_INVALID`, not removed. In any case, this detail doesn't really seem relevant here. It seems more relevant that the failure is handled internally so no need to check for errors from this function.",
      "commit_id" : "e7dc5e6e52811e2b03c053ab07fc25720e6f1d10",
      "created_at" : "2022-11-08T04:14:26Z",
      "diff_hunk" : "@@ -2810,6 +2810,18 @@ bool Chainstate::ConnectTip(BlockValidationState& state, CBlockIndex* pindexNew,\n              Ticks<SecondsDouble>(time_total),\n              Ticks<MillisecondsDouble>(time_total) / num_blocks_total);\n \n+    // If we are the background validation chainstate, check to see if we are done\n+    // validating the snapshot (i.e. our tip has reached the snapshot's base block).\n+    if (this != &m_chainman.ActiveChainstate()) {\n+        // This call may set `m_disabled`, which is referenced immediately afterwards in\n+        // ActivateBestChain.\n+        //\n+        // If this fails (i.e. if snapshot is invalid), we will have marked the\n+        // snapshot chainstate as unusable, and will have removed its coinsdb from\n+        // disk.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016126310",
      "id" : 1016126310,
      "line" : 2821,
      "node_id" : "PRRC_kwDOABII5848kNtm",
      "original_commit_id" : "e17d51768bcf5f7791fdf7d0b2ee4b11cc64d922",
      "original_line" : 2821,
      "original_position" : 12,
      "original_start_line" : 2819,
      "path" : "src/validation.cpp",
      "position" : 12,
      "pull_request_review_id" : 1171289324,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016126310/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2819,
      "start_side" : "RIGHT",
      "updated_at" : "2022-11-08T04:58:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016126310",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016126823"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016126823"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainMan logic for completing UTXO snapshot validation\" (https://github.com/bitcoin/bitcoin/commit/e17d51768bcf5f7791fdf7d0b2ee4b11cc64d922)\r\n\r\nWould add \"so it will stop connecting new blocks\" to make it clearer what m_disabled is used for.",
      "commit_id" : "e7dc5e6e52811e2b03c053ab07fc25720e6f1d10",
      "created_at" : "2022-11-08T04:15:50Z",
      "diff_hunk" : "@@ -2810,6 +2810,18 @@ bool Chainstate::ConnectTip(BlockValidationState& state, CBlockIndex* pindexNew,\n              Ticks<SecondsDouble>(time_total),\n              Ticks<MillisecondsDouble>(time_total) / num_blocks_total);\n \n+    // If we are the background validation chainstate, check to see if we are done\n+    // validating the snapshot (i.e. our tip has reached the snapshot's base block).\n+    if (this != &m_chainman.ActiveChainstate()) {\n+        // This call may set `m_disabled`, which is referenced immediately afterwards in\n+        // ActivateBestChain.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016126823",
      "id" : 1016126823,
      "line" : 2817,
      "node_id" : "PRRC_kwDOABII5848kN1n",
      "original_commit_id" : "e17d51768bcf5f7791fdf7d0b2ee4b11cc64d922",
      "original_line" : 2817,
      "original_position" : 8,
      "original_start_line" : 2816,
      "path" : "src/validation.cpp",
      "position" : 8,
      "pull_request_review_id" : 1171289324,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016126823/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 2816,
      "start_side" : "RIGHT",
      "updated_at" : "2022-11-08T04:58:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016126823",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016732670"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016732670"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah, yeah, good catch! I moved too fast when addressing Antoine's feedback and forgot that setting `m_disabled` on the IBD chainstate _does_ indicate full snapshot validation. It's a little confusing because setting `m_disabled` on the _snapshot_ chainstate indicates that validation failed, but this definition of `IsSnapshotValidated()` is actually still correct, I just screwed up the comment.",
      "commit_id" : "e7dc5e6e52811e2b03c053ab07fc25720e6f1d10",
      "created_at" : "2022-11-08T14:50:51Z",
      "diff_hunk" : "@@ -962,7 +976,10 @@ class ChainstateManager\n     std::optional<uint256> SnapshotBlockhash() const;\n \n     //! Is there a snapshot in use and has it been fully validated?\n-    bool IsSnapshotValidated() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main) { return m_snapshot_validated; }\n+    bool IsSnapshotValidated() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n+    {\n+        return m_snapshot_chainstate && m_ibd_chainstate && m_ibd_chainstate->m_disabled;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016732670",
      "id" : 1016732670,
      "in_reply_to_id" : 1016039682,
      "line" : 1031,
      "node_id" : "PRRC_kwDOABII5848mhv-",
      "original_commit_id" : "53f9a79c87fff061d7f5232b9c4e829f9380fa01",
      "original_line" : 981,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 50,
      "pull_request_review_id" : 1172272694,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016732670/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-08T14:50:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016732670",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016741292"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016741292"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Oh, that is a helpful clarification that m_disabled is set in different conditions on the different chainstates. It'd be useful to say in doxygen comment for `m_disabled` that it is is only set on background chainstate after it is validated and validation was successful, and only set on snapshot chainstate if it's invalid and needs to be deleted.",
      "commit_id" : "e7dc5e6e52811e2b03c053ab07fc25720e6f1d10",
      "created_at" : "2022-11-08T14:57:21Z",
      "diff_hunk" : "@@ -962,7 +976,10 @@ class ChainstateManager\n     std::optional<uint256> SnapshotBlockhash() const;\n \n     //! Is there a snapshot in use and has it been fully validated?\n-    bool IsSnapshotValidated() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main) { return m_snapshot_validated; }\n+    bool IsSnapshotValidated() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\n+    {\n+        return m_snapshot_chainstate && m_ibd_chainstate && m_ibd_chainstate->m_disabled;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016741292",
      "id" : 1016741292,
      "in_reply_to_id" : 1016039682,
      "line" : 1031,
      "node_id" : "PRRC_kwDOABII5848mj2s",
      "original_commit_id" : "53f9a79c87fff061d7f5232b9c4e829f9380fa01",
      "original_line" : 981,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 50,
      "pull_request_review_id" : 1172285484,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016741292/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-08T14:57:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016741292",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016807732"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016807732"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I *would* do this, but repeating the function signature for a static function for perpetuity just to save on a diff that's pretty easy to read with `--color-moved=dimmed-zebra --color-moved-ws=ignore-space-change` anyway doesn't seem like the right trade to me. Will leave this as-is.\r\n\r\n",
      "commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "created_at" : "2022-11-08T15:46:22Z",
      "diff_hunk" : "@@ -28,38 +28,13 @@\n #include <vector>\n \n namespace node {\n-ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSizes& cache_sizes,\n-                                    const ChainstateLoadOptions& options)\n+// Complete initialization of chainstates after the initial call has been made\n+// to ChainstateManager::InitializeChainstate().\n+static ChainstateLoadResult CompleteChainstateInitialization(",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016807732",
      "id" : 1016807732,
      "in_reply_to_id" : 1016045839,
      "line" : 33,
      "node_id" : "PRRC_kwDOABII5848m0E0",
      "original_commit_id" : "15a86a4940777a427d2b1c8c7c1e533de440f951",
      "original_line" : 33,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : 8,
      "pull_request_review_id" : 1172385371,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016807732/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-08T15:46:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016807732",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016809136"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016809136"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good catch!",
      "commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "created_at" : "2022-11-08T15:47:27Z",
      "diff_hunk" : "@@ -955,6 +990,18 @@ class ChainstateManager\n     [[nodiscard]] bool ActivateSnapshot(\n         AutoFile& coins_file, const node::SnapshotMetadata& metadata, bool in_memory);\n \n+    //! Once the background validation chainstate has reached the height which\n+    //! is the base of the UTXO snapshot in use, compare its coins to ensure\n+    //! they match those expected by the snapshot.\n+    //!\n+    //! If the coins match (expected), then mark the validation chainstate for\n+    //! deletion and continue using the snapshot chainstate as active.\n+    //! Otherwise, revert to using the ibd chainstate and shutdown (TODO).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016809136",
      "id" : 1016809136,
      "in_reply_to_id" : 1016047755,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5848m0aw",
      "original_commit_id" : "e17d51768bcf5f7791fdf7d0b2ee4b11cc64d922",
      "original_line" : 999,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 1172387389,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016809136/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-08T15:47:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016809136",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016814099"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016814099"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point, done.",
      "commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "created_at" : "2022-11-08T15:51:24Z",
      "diff_hunk" : "@@ -183,6 +186,43 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n         return {init_status, init_error};\n     }\n \n+    // If a snapshot chainstate was fully validated by a background chainstate during\n+    // the last run, detect it here and clean up the now-unneeded background\n+    // chainstate. This is the expected case during snapshot completion, and\n+    // not just a belt-and-suspenders.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016814099",
      "id" : 1016814099,
      "in_reply_to_id" : 1016053694,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5848m1oT",
      "original_commit_id" : "e17d51768bcf5f7791fdf7d0b2ee4b11cc64d922",
      "original_line" : 192,
      "original_position" : 17,
      "original_start_line" : 191,
      "path" : "src/node/chainstate.cpp",
      "position" : null,
      "pull_request_review_id" : 1172394735,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016814099/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-11-08T16:01:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016814099",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016816857"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016816857"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "created_at" : "2022-11-08T15:53:30Z",
      "diff_hunk" : "@@ -2810,6 +2810,18 @@ bool Chainstate::ConnectTip(BlockValidationState& state, CBlockIndex* pindexNew,\n              Ticks<SecondsDouble>(time_total),\n              Ticks<MillisecondsDouble>(time_total) / num_blocks_total);\n \n+    // If we are the background validation chainstate, check to see if we are done\n+    // validating the snapshot (i.e. our tip has reached the snapshot's base block).\n+    if (this != &m_chainman.ActiveChainstate()) {\n+        // This call may set `m_disabled`, which is referenced immediately afterwards in\n+        // ActivateBestChain.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016816857",
      "id" : 1016816857,
      "in_reply_to_id" : 1016126823,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5848m2TZ",
      "original_commit_id" : "e17d51768bcf5f7791fdf7d0b2ee4b11cc64d922",
      "original_line" : 2817,
      "original_position" : 8,
      "original_start_line" : 2816,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1172394735,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016816857/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-11-08T16:01:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016816857",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016818067"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016818067"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point, fixed.",
      "commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "created_at" : "2022-11-08T15:54:25Z",
      "diff_hunk" : "@@ -2810,6 +2810,18 @@ bool Chainstate::ConnectTip(BlockValidationState& state, CBlockIndex* pindexNew,\n              Ticks<SecondsDouble>(time_total),\n              Ticks<MillisecondsDouble>(time_total) / num_blocks_total);\n \n+    // If we are the background validation chainstate, check to see if we are done\n+    // validating the snapshot (i.e. our tip has reached the snapshot's base block).\n+    if (this != &m_chainman.ActiveChainstate()) {\n+        // This call may set `m_disabled`, which is referenced immediately afterwards in\n+        // ActivateBestChain.\n+        //\n+        // If this fails (i.e. if snapshot is invalid), we will have marked the\n+        // snapshot chainstate as unusable, and will have removed its coinsdb from\n+        // disk.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016818067",
      "id" : 1016818067,
      "in_reply_to_id" : 1016126310,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5848m2mT",
      "original_commit_id" : "e17d51768bcf5f7791fdf7d0b2ee4b11cc64d922",
      "original_line" : 2821,
      "original_position" : 12,
      "original_start_line" : 2819,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1172394735,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016818067/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-11-08T16:01:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016818067",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016821985"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016821985"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point! Done.",
      "commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "created_at" : "2022-11-08T15:57:17Z",
      "diff_hunk" : "@@ -5304,6 +5498,42 @@ Chainstate& ChainstateManager::ActivateExistingSnapshot(CTxMemPool* mempool, uin\n     return *m_snapshot_chainstate;\n }\n \n+void Chainstate::InvalidateCoinsDBOnDisk()\n+{\n+    AssertLockHeld(::cs_main);\n+    // Should never be called on a non-snapshot chainstate.\n+    assert(m_from_snapshot_blockhash);\n+    auto storage_path_maybe = this->CoinsDB().StoragePath();\n+    // Should never be called with a non-existent storage path.\n+    assert(storage_path_maybe);\n+    fs::path snapshot_datadir = *storage_path_maybe;\n+\n+    // Coins views no longer usable.\n+    m_coins_views.reset();\n+\n+    auto invalid_path = snapshot_datadir + \"_INVALID\";\n+    std::string dbpath = fs::PathToString(snapshot_datadir);\n+    std::string target = fs::PathToString(invalid_path);\n+    LogPrintf(\"[snapshot] renaming snapshot datadir %s to %s\\n\", dbpath, target);\n+\n+    // The invalid snapshot datadir is simply moved and not deleted because we may\n+    // want to do forensics later during issue investigation. The user is instructed\n+    // accordingly in MaybeCompleteSnapshotValidation().\n+    try {\n+        fs::rename(snapshot_datadir, invalid_path);\n+    } catch (const fs::filesystem_error& e) {\n+        auto src_str = fs::PathToString(snapshot_datadir);\n+        auto dest_str = fs::PathToString(invalid_path);\n+\n+        LogPrintf(\"%s: error renaming file '%s' -> '%s': %s\\n\",\n+                __func__, src_str, dest_str, e.what());\n+        AbortNode(strprintf(\n+            \"Rename of '%s' -> '%s' failed. \"\n+            \"Do not restart until manually moving or deleting invalid snapshot directory %s.\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1016821985",
      "id" : 1016821985,
      "in_reply_to_id" : 1016061460,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5848m3jh",
      "original_commit_id" : "e17d51768bcf5f7791fdf7d0b2ee4b11cc64d922",
      "original_line" : 5532,
      "original_position" : 288,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1172394735,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016821985/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-08T16:01:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016821985",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1020962043"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1020962043"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add CChainState::m_disabled and ChainMan::isUsable\" (e07764318ad766ba27dfeafe1ca2345534f81dd5)\r\n\r\nThis last sentence is confusing because it is part of the \"In the expected case\" paragraph, but it is referring to an different unexpected case. It's also not very clear that this sentence is referring to a different chainstate object than the rest of the paragraph.\r\n\r\nWould move this sentence to a separate paragraph and say something like \"In the error case, if the background UTXO hash does not match the expected assumeutxo valid, m_disabled will be set to true on the snapshot chainstate (not the background validation chainstate) indicating that the snapshot chainstate is invalid.\"",
      "commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "created_at" : "2022-11-13T20:50:37Z",
      "diff_hunk" : "@@ -451,6 +451,19 @@ class Chainstate\n     //! Manages the UTXO set, which is a reflection of the contents of `m_chain`.\n     std::unique_ptr<CoinsViews> m_coins_views;\n \n+    //! This toggle exists for use when doing background validation for UTXO\n+    //! snapshots.\n+    //!\n+    //! In the expected case, it is set once the background validation chain reaches the\n+    //! same height as the base of the snapshot and its UTXO set is found to hash to\n+    //! the expected assumeutxo value. It signals that we should no longer connect\n+    //! blocks to the background chainstate. When set on the background validation\n+    //! chainstate, it signifies that we have fully validated the snapshot chainstate.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1020962043",
      "id" : 1020962043,
      "line" : 462,
      "node_id" : "PRRC_kwDOABII58482qT7",
      "original_commit_id" : "e07764318ad766ba27dfeafe1ca2345534f81dd5",
      "original_line" : 461,
      "original_position" : 11,
      "original_start_line" : 460,
      "path" : "src/validation.h",
      "position" : 11,
      "pull_request_review_id" : 1178296226,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1020962043/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 461,
      "start_side" : "RIGHT",
      "updated_at" : "2022-11-13T20:54:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1020962043",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1029633554"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1029633554"
         }
      },
      "author_association" : "MEMBER",
      "body" : "As I understand this sequence of checks verifying the cleanness of our chain validation, I think you could also verify the coin cache rebalancing as done above, i.e `BOOST_CHECK(active_cs.m_coinstip_cache_size_bytes > tip_cache_before_complete)` and the other one.",
      "commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "created_at" : "2022-11-22T17:24:59Z",
      "diff_hunk" : "@@ -518,10 +533,156 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_snapshot_init, SnapshotTestSetup)\n         // chainstate.\n         for (Chainstate* cs : chainman_restarted.GetAll()) {\n             if (cs != &chainman_restarted.ActiveChainstate()) {\n-                BOOST_CHECK_EQUAL(cs->m_chain.Height(), 110);\n+                BOOST_CHECK_EQUAL(cs->m_chain.Height(), 109);\n             }\n         }\n     }\n }\n \n+BOOST_FIXTURE_TEST_CASE(chainstatemanager_snapshot_completion, SnapshotTestSetup)\n+{\n+    this->SetupSnapshot();\n+\n+    ChainstateManager& chainman = *Assert(m_node.chainman);\n+    Chainstate& active_cs = chainman.ActiveChainstate();\n+    auto tip_cache_before_complete = active_cs.m_coinstip_cache_size_bytes;\n+    auto db_cache_before_complete = active_cs.m_coinsdb_cache_size_bytes;\n+\n+    SnapshotCompletionResult res;\n+    auto mock_shutdown = [](bilingual_str msg) {};\n+\n+    fs::path snapshot_chainstate_dir = *node::FindSnapshotChainstateDir();\n+    BOOST_CHECK(fs::exists(snapshot_chainstate_dir));\n+    BOOST_CHECK_EQUAL(snapshot_chainstate_dir, gArgs.GetDataDirNet() / \"chainstate_snapshot\");\n+\n+    BOOST_CHECK(chainman.IsSnapshotActive());\n+    const uint256 snapshot_tip_hash = WITH_LOCK(chainman.GetMutex(),\n+        return chainman.ActiveTip()->GetBlockHash());\n+\n+    res = WITH_LOCK(::cs_main,\n+        return chainman.MaybeCompleteSnapshotValidation(mock_shutdown));\n+    BOOST_CHECK_EQUAL(res, SnapshotCompletionResult::SUCCESS);\n+\n+    WITH_LOCK(::cs_main, BOOST_CHECK(chainman.IsSnapshotValidated()));\n+    BOOST_CHECK(chainman.IsSnapshotActive());\n+\n+    // Cache should have been rebalanced and reallocated to the \"only\" remaining\n+    // chainstate.\n+    BOOST_CHECK(active_cs.m_coinstip_cache_size_bytes > tip_cache_before_complete);\n+    BOOST_CHECK(active_cs.m_coinsdb_cache_size_bytes > db_cache_before_complete);\n+\n+    auto all_chainstates = chainman.GetAll();\n+    BOOST_CHECK_EQUAL(all_chainstates.size(), 1);\n+    BOOST_CHECK_EQUAL(all_chainstates[0], &active_cs);\n+\n+    // Trying completion again should return false.\n+    res = WITH_LOCK(::cs_main,\n+        return chainman.MaybeCompleteSnapshotValidation(mock_shutdown));\n+    BOOST_CHECK_EQUAL(res, SnapshotCompletionResult::SKIPPED);\n+\n+    // The invalid snapshot path should not have been used.\n+    fs::path snapshot_invalid_dir = gArgs.GetDataDirNet() / \"chainstate_snapshot_INVALID\";\n+    BOOST_CHECK(!fs::exists(snapshot_invalid_dir));\n+    // chainstate_snapshot should still exist.\n+    BOOST_CHECK(fs::exists(snapshot_chainstate_dir));\n+\n+    // Test that simulating a shutdown (reseting ChainstateManager) and then performing\n+    // chainstate reinitializing successfully cleans up the background-validation\n+    // chainstate data, and we end up with a single chainstate that is at tip.\n+    ChainstateManager& chainman_restarted = this->SimulateNodeRestart();\n+\n+    BOOST_TEST_MESSAGE(\"Performing Load/Verify/Activate of chainstate\");\n+\n+    // This call reinitializes the chainstates, and should clean up the now unnecessary\n+    // background-validation leveldb contents.\n+    this->LoadVerifyActivateChainstate();\n+\n+    BOOST_CHECK(!fs::exists(snapshot_invalid_dir));\n+    // chainstate_snapshot should now *not* exist.\n+    BOOST_CHECK(!fs::exists(snapshot_chainstate_dir));\n+\n+    {\n+        LOCK(chainman_restarted.GetMutex());\n+        BOOST_CHECK_EQUAL(chainman_restarted.GetAll().size(), 1);\n+        BOOST_CHECK(!chainman_restarted.IsSnapshotActive());\n+        BOOST_CHECK(!chainman_restarted.IsSnapshotValidated());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1029633554",
      "id" : 1029633554,
      "line" : 608,
      "node_id" : "PRRC_kwDOABII5849XvYS",
      "original_commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "original_line" : 608,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 111,
      "pull_request_review_id" : 1190503385,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1029633554/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-22T19:32:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1029633554",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1029641430"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1029641430"
         }
      },
      "author_association" : "MEMBER",
      "body" : "To verify the coinstats logic (`ComputeUTXOStats`) is committing well to all the attributes of the chain tip coin set, I think other variations of tampering could be done, such as picking up a random coin and inflating its `nValue` or tweaking its `scriptPubKey`.",
      "commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "created_at" : "2022-11-22T17:33:22Z",
      "diff_hunk" : "@@ -518,10 +533,156 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_snapshot_init, SnapshotTestSetup)\n         // chainstate.\n         for (Chainstate* cs : chainman_restarted.GetAll()) {\n             if (cs != &chainman_restarted.ActiveChainstate()) {\n-                BOOST_CHECK_EQUAL(cs->m_chain.Height(), 110);\n+                BOOST_CHECK_EQUAL(cs->m_chain.Height(), 109);\n             }\n         }\n     }\n }\n \n+BOOST_FIXTURE_TEST_CASE(chainstatemanager_snapshot_completion, SnapshotTestSetup)\n+{\n+    this->SetupSnapshot();\n+\n+    ChainstateManager& chainman = *Assert(m_node.chainman);\n+    Chainstate& active_cs = chainman.ActiveChainstate();\n+    auto tip_cache_before_complete = active_cs.m_coinstip_cache_size_bytes;\n+    auto db_cache_before_complete = active_cs.m_coinsdb_cache_size_bytes;\n+\n+    SnapshotCompletionResult res;\n+    auto mock_shutdown = [](bilingual_str msg) {};\n+\n+    fs::path snapshot_chainstate_dir = *node::FindSnapshotChainstateDir();\n+    BOOST_CHECK(fs::exists(snapshot_chainstate_dir));\n+    BOOST_CHECK_EQUAL(snapshot_chainstate_dir, gArgs.GetDataDirNet() / \"chainstate_snapshot\");\n+\n+    BOOST_CHECK(chainman.IsSnapshotActive());\n+    const uint256 snapshot_tip_hash = WITH_LOCK(chainman.GetMutex(),\n+        return chainman.ActiveTip()->GetBlockHash());\n+\n+    res = WITH_LOCK(::cs_main,\n+        return chainman.MaybeCompleteSnapshotValidation(mock_shutdown));\n+    BOOST_CHECK_EQUAL(res, SnapshotCompletionResult::SUCCESS);\n+\n+    WITH_LOCK(::cs_main, BOOST_CHECK(chainman.IsSnapshotValidated()));\n+    BOOST_CHECK(chainman.IsSnapshotActive());\n+\n+    // Cache should have been rebalanced and reallocated to the \"only\" remaining\n+    // chainstate.\n+    BOOST_CHECK(active_cs.m_coinstip_cache_size_bytes > tip_cache_before_complete);\n+    BOOST_CHECK(active_cs.m_coinsdb_cache_size_bytes > db_cache_before_complete);\n+\n+    auto all_chainstates = chainman.GetAll();\n+    BOOST_CHECK_EQUAL(all_chainstates.size(), 1);\n+    BOOST_CHECK_EQUAL(all_chainstates[0], &active_cs);\n+\n+    // Trying completion again should return false.\n+    res = WITH_LOCK(::cs_main,\n+        return chainman.MaybeCompleteSnapshotValidation(mock_shutdown));\n+    BOOST_CHECK_EQUAL(res, SnapshotCompletionResult::SKIPPED);\n+\n+    // The invalid snapshot path should not have been used.\n+    fs::path snapshot_invalid_dir = gArgs.GetDataDirNet() / \"chainstate_snapshot_INVALID\";\n+    BOOST_CHECK(!fs::exists(snapshot_invalid_dir));\n+    // chainstate_snapshot should still exist.\n+    BOOST_CHECK(fs::exists(snapshot_chainstate_dir));\n+\n+    // Test that simulating a shutdown (reseting ChainstateManager) and then performing\n+    // chainstate reinitializing successfully cleans up the background-validation\n+    // chainstate data, and we end up with a single chainstate that is at tip.\n+    ChainstateManager& chainman_restarted = this->SimulateNodeRestart();\n+\n+    BOOST_TEST_MESSAGE(\"Performing Load/Verify/Activate of chainstate\");\n+\n+    // This call reinitializes the chainstates, and should clean up the now unnecessary\n+    // background-validation leveldb contents.\n+    this->LoadVerifyActivateChainstate();\n+\n+    BOOST_CHECK(!fs::exists(snapshot_invalid_dir));\n+    // chainstate_snapshot should now *not* exist.\n+    BOOST_CHECK(!fs::exists(snapshot_chainstate_dir));\n+\n+    {\n+        LOCK(chainman_restarted.GetMutex());\n+        BOOST_CHECK_EQUAL(chainman_restarted.GetAll().size(), 1);\n+        BOOST_CHECK(!chainman_restarted.IsSnapshotActive());\n+        BOOST_CHECK(!chainman_restarted.IsSnapshotValidated());\n+\n+        BOOST_CHECK_EQUAL(chainman_restarted.ActiveTip()->GetBlockHash(), snapshot_tip_hash);\n+        BOOST_CHECK_EQUAL(chainman_restarted.ActiveHeight(), 210);\n+    }\n+\n+    BOOST_TEST_MESSAGE(\n+        \"Ensure we can mine blocks on top of the \\\"new\\\" IBD chainstate\");\n+    mineBlocks(10);\n+    {\n+        LOCK(chainman_restarted.GetMutex());\n+        BOOST_CHECK_EQUAL(chainman_restarted.ActiveHeight(), 220);\n+    }\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(chainstatemanager_snapshot_completion_hash_mismatch, SnapshotTestSetup)\n+{\n+    auto chainstates = this->SetupSnapshot();\n+    Chainstate& validation_chainstate = *std::get<0>(chainstates);\n+    ChainstateManager& chainman = *Assert(m_node.chainman);\n+    SnapshotCompletionResult res;\n+    auto mock_shutdown = [](bilingual_str msg) {};\n+\n+    // Test tampering with the IBD UTXO set with an extra coin to ensure it causes\n+    // snapshot completion to fail.\n+    CCoinsViewCache& ibd_coins = WITH_LOCK(::cs_main,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1029641430",
      "id" : 1029641430,
      "line" : 633,
      "node_id" : "PRRC_kwDOABII5849XxTW",
      "original_commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "original_line" : 633,
      "original_position" : 136,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 136,
      "pull_request_review_id" : 1190503385,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1029641430/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-22T19:32:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1029641430",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1029645606"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1029645606"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Note, among the `validation_chainstatemanager_test.cpp` unit tests, I think only `SnapshotCompletionResult::HASH_MISMATCH` is exercised, I don't see checks for `MISSING_CHAINPARAMS, STATS_FAILED, BASE_BLOCKHASH_MISMATCH`. They can be added later.  ",
      "commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "created_at" : "2022-11-22T17:37:33Z",
      "diff_hunk" : "@@ -518,10 +533,156 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_snapshot_init, SnapshotTestSetup)\n         // chainstate.\n         for (Chainstate* cs : chainman_restarted.GetAll()) {\n             if (cs != &chainman_restarted.ActiveChainstate()) {\n-                BOOST_CHECK_EQUAL(cs->m_chain.Height(), 110);\n+                BOOST_CHECK_EQUAL(cs->m_chain.Height(), 109);\n             }\n         }\n     }\n }\n \n+BOOST_FIXTURE_TEST_CASE(chainstatemanager_snapshot_completion, SnapshotTestSetup)\n+{\n+    this->SetupSnapshot();\n+\n+    ChainstateManager& chainman = *Assert(m_node.chainman);\n+    Chainstate& active_cs = chainman.ActiveChainstate();\n+    auto tip_cache_before_complete = active_cs.m_coinstip_cache_size_bytes;\n+    auto db_cache_before_complete = active_cs.m_coinsdb_cache_size_bytes;\n+\n+    SnapshotCompletionResult res;\n+    auto mock_shutdown = [](bilingual_str msg) {};\n+\n+    fs::path snapshot_chainstate_dir = *node::FindSnapshotChainstateDir();\n+    BOOST_CHECK(fs::exists(snapshot_chainstate_dir));\n+    BOOST_CHECK_EQUAL(snapshot_chainstate_dir, gArgs.GetDataDirNet() / \"chainstate_snapshot\");\n+\n+    BOOST_CHECK(chainman.IsSnapshotActive());\n+    const uint256 snapshot_tip_hash = WITH_LOCK(chainman.GetMutex(),\n+        return chainman.ActiveTip()->GetBlockHash());\n+\n+    res = WITH_LOCK(::cs_main,\n+        return chainman.MaybeCompleteSnapshotValidation(mock_shutdown));\n+    BOOST_CHECK_EQUAL(res, SnapshotCompletionResult::SUCCESS);\n+\n+    WITH_LOCK(::cs_main, BOOST_CHECK(chainman.IsSnapshotValidated()));\n+    BOOST_CHECK(chainman.IsSnapshotActive());\n+\n+    // Cache should have been rebalanced and reallocated to the \"only\" remaining\n+    // chainstate.\n+    BOOST_CHECK(active_cs.m_coinstip_cache_size_bytes > tip_cache_before_complete);\n+    BOOST_CHECK(active_cs.m_coinsdb_cache_size_bytes > db_cache_before_complete);\n+\n+    auto all_chainstates = chainman.GetAll();\n+    BOOST_CHECK_EQUAL(all_chainstates.size(), 1);\n+    BOOST_CHECK_EQUAL(all_chainstates[0], &active_cs);\n+\n+    // Trying completion again should return false.\n+    res = WITH_LOCK(::cs_main,\n+        return chainman.MaybeCompleteSnapshotValidation(mock_shutdown));\n+    BOOST_CHECK_EQUAL(res, SnapshotCompletionResult::SKIPPED);\n+\n+    // The invalid snapshot path should not have been used.\n+    fs::path snapshot_invalid_dir = gArgs.GetDataDirNet() / \"chainstate_snapshot_INVALID\";\n+    BOOST_CHECK(!fs::exists(snapshot_invalid_dir));\n+    // chainstate_snapshot should still exist.\n+    BOOST_CHECK(fs::exists(snapshot_chainstate_dir));\n+\n+    // Test that simulating a shutdown (reseting ChainstateManager) and then performing\n+    // chainstate reinitializing successfully cleans up the background-validation\n+    // chainstate data, and we end up with a single chainstate that is at tip.\n+    ChainstateManager& chainman_restarted = this->SimulateNodeRestart();\n+\n+    BOOST_TEST_MESSAGE(\"Performing Load/Verify/Activate of chainstate\");\n+\n+    // This call reinitializes the chainstates, and should clean up the now unnecessary\n+    // background-validation leveldb contents.\n+    this->LoadVerifyActivateChainstate();\n+\n+    BOOST_CHECK(!fs::exists(snapshot_invalid_dir));\n+    // chainstate_snapshot should now *not* exist.\n+    BOOST_CHECK(!fs::exists(snapshot_chainstate_dir));\n+\n+    {\n+        LOCK(chainman_restarted.GetMutex());\n+        BOOST_CHECK_EQUAL(chainman_restarted.GetAll().size(), 1);\n+        BOOST_CHECK(!chainman_restarted.IsSnapshotActive());\n+        BOOST_CHECK(!chainman_restarted.IsSnapshotValidated());\n+\n+        BOOST_CHECK_EQUAL(chainman_restarted.ActiveTip()->GetBlockHash(), snapshot_tip_hash);\n+        BOOST_CHECK_EQUAL(chainman_restarted.ActiveHeight(), 210);\n+    }\n+\n+    BOOST_TEST_MESSAGE(\n+        \"Ensure we can mine blocks on top of the \\\"new\\\" IBD chainstate\");\n+    mineBlocks(10);\n+    {\n+        LOCK(chainman_restarted.GetMutex());\n+        BOOST_CHECK_EQUAL(chainman_restarted.ActiveHeight(), 220);\n+    }\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(chainstatemanager_snapshot_completion_hash_mismatch, SnapshotTestSetup)\n+{\n+    auto chainstates = this->SetupSnapshot();\n+    Chainstate& validation_chainstate = *std::get<0>(chainstates);\n+    ChainstateManager& chainman = *Assert(m_node.chainman);\n+    SnapshotCompletionResult res;\n+    auto mock_shutdown = [](bilingual_str msg) {};\n+\n+    // Test tampering with the IBD UTXO set with an extra coin to ensure it causes\n+    // snapshot completion to fail.\n+    CCoinsViewCache& ibd_coins = WITH_LOCK(::cs_main,\n+        return validation_chainstate.CoinsTip());\n+    Coin badcoin;\n+    badcoin.out.nValue = InsecureRand32();\n+    badcoin.nHeight = 1;\n+    badcoin.out.scriptPubKey.assign(InsecureRandBits(6), 0);\n+    uint256 txid = InsecureRand256();\n+    ibd_coins.AddCoin(COutPoint(txid, 0), std::move(badcoin), false);\n+\n+    fs::path snapshot_chainstate_dir = gArgs.GetDataDirNet() / \"chainstate_snapshot\";\n+    BOOST_CHECK(fs::exists(snapshot_chainstate_dir));\n+\n+    res = WITH_LOCK(::cs_main,\n+        return chainman.MaybeCompleteSnapshotValidation(mock_shutdown));\n+    BOOST_CHECK_EQUAL(res, SnapshotCompletionResult::HASH_MISMATCH);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1029645606",
      "id" : 1029645606,
      "line" : 647,
      "node_id" : "PRRC_kwDOABII5849XyUm",
      "original_commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "original_line" : 647,
      "original_position" : 150,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 150,
      "pull_request_review_id" : 1190503385,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1029645606/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-22T19:32:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1029645606",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1029649960"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1029649960"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I believe here you would like to say `ComputeUTXOStats` (used L5344), the core logic of `GetUTXOStats`.  ",
      "commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "created_at" : "2022-11-22T17:42:13Z",
      "diff_hunk" : "@@ -5196,6 +5241,149 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+// Currently, this function holds cs_main for its duration, which could be for\n+// multiple minutes due to the GetUTXOStats call. This hold is necessary",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1029649960",
      "id" : 1029649960,
      "line" : 5245,
      "node_id" : "PRRC_kwDOABII5849XzYo",
      "original_commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "original_line" : 5245,
      "original_position" : 128,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 128,
      "pull_request_review_id" : 1190503385,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1029649960/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-22T19:32:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1029649960",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1029667346"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1029667346"
         }
      },
      "author_association" : "MEMBER",
      "body" : "One future improvement suggestion: I think here the boolean result of `DetectSnapshotChainstate` to completely skip the call of `MaybeCompleteSnapshotValidation` and remove `SnapshotCompletionResult::SKIPPED`. From my understanding, lack of UTXO snapshot should imply lack of background chainstate, whatever its sync state and the necessity of clean it..",
      "commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "created_at" : "2022-11-22T18:01:13Z",
      "diff_hunk" : "@@ -170,6 +152,84 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n     return {ChainstateLoadStatus::SUCCESS, {}};\n }\n \n+ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSizes& cache_sizes,\n+                                    const ChainstateLoadOptions& options)\n+{\n+    if (!chainman.AssumedValidBlock().IsNull()) {\n+        LogPrintf(\"Assuming ancestors of block %s have valid signatures.\\n\", chainman.AssumedValidBlock().GetHex());\n+    } else {\n+        LogPrintf(\"Validating signatures for all blocks.\\n\");\n+    }\n+    LogPrintf(\"Setting nMinimumChainWork=%s\\n\", chainman.MinimumChainWork().GetHex());\n+    if (chainman.MinimumChainWork() < UintToArith256(chainman.GetConsensus().nMinimumChainWork)) {\n+        LogPrintf(\"Warning: nMinimumChainWork set below default value of %s\\n\", chainman.GetConsensus().nMinimumChainWork.GetHex());\n+    }\n+    if (nPruneTarget == std::numeric_limits<uint64_t>::max()) {\n+        LogPrintf(\"Block pruning enabled.  Use RPC call pruneblockchain(height) to manually prune block and undo files.\\n\");\n+    } else if (nPruneTarget) {\n+        LogPrintf(\"Prune configured to target %u MiB on disk for block and undo files.\\n\", nPruneTarget / 1024 / 1024);\n+    }\n+\n+    LOCK(cs_main);\n+\n+    chainman.m_total_coinstip_cache = cache_sizes.coins;\n+    chainman.m_total_coinsdb_cache = cache_sizes.coins_db;\n+\n+    // Load the fully validated chainstate.\n+    chainman.InitializeChainstate(options.mempool);\n+\n+    // Load a chain created from a UTXO snapshot, if any exist.\n+    chainman.DetectSnapshotChainstate(options.mempool);\n+\n+    auto [init_status, init_error] = CompleteChainstateInitialization(chainman, cache_sizes, options);\n+    if (init_status != ChainstateLoadStatus::SUCCESS) {\n+        return {init_status, init_error};\n+    }\n+\n+    // If a snapshot chainstate was fully validated by a background chainstate during\n+    // the last run, detect it here and clean up the now-unneeded background\n+    // chainstate.\n+    //\n+    // Why is this cleanup done here (on subsequent restart) and not just when the\n+    // snapshot is actually validated? Because this entails unusual\n+    // filesystem operations to move leveldb data directories around, and that seems\n+    // too risky to do in the middle of normal runtime.\n+    auto snapshot_completion = chainman.MaybeCompleteSnapshotValidation();\n+\n+    if (snapshot_completion == SnapshotCompletionResult::SKIPPED) {\n+        // do nothing; expected case",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1029667346",
      "id" : 1029667346,
      "line" : 200,
      "node_id" : "PRRC_kwDOABII5849X3oS",
      "original_commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "original_line" : 200,
      "original_position" : 108,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : 108,
      "pull_request_review_id" : 1190503385,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1029667346/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-22T19:32:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1029667346",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1029672259"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1029672259"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I believe asserting cache sanity could be also done, there is a call to `MaybeRebalanceCaches()` at the end of `MaybeCompleteSnapshotValidation()`. ",
      "commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "created_at" : "2022-11-22T18:06:57Z",
      "diff_hunk" : "@@ -170,6 +152,84 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n     return {ChainstateLoadStatus::SUCCESS, {}};\n }\n \n+ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSizes& cache_sizes,\n+                                    const ChainstateLoadOptions& options)\n+{\n+    if (!chainman.AssumedValidBlock().IsNull()) {\n+        LogPrintf(\"Assuming ancestors of block %s have valid signatures.\\n\", chainman.AssumedValidBlock().GetHex());\n+    } else {\n+        LogPrintf(\"Validating signatures for all blocks.\\n\");\n+    }\n+    LogPrintf(\"Setting nMinimumChainWork=%s\\n\", chainman.MinimumChainWork().GetHex());\n+    if (chainman.MinimumChainWork() < UintToArith256(chainman.GetConsensus().nMinimumChainWork)) {\n+        LogPrintf(\"Warning: nMinimumChainWork set below default value of %s\\n\", chainman.GetConsensus().nMinimumChainWork.GetHex());\n+    }\n+    if (nPruneTarget == std::numeric_limits<uint64_t>::max()) {\n+        LogPrintf(\"Block pruning enabled.  Use RPC call pruneblockchain(height) to manually prune block and undo files.\\n\");\n+    } else if (nPruneTarget) {\n+        LogPrintf(\"Prune configured to target %u MiB on disk for block and undo files.\\n\", nPruneTarget / 1024 / 1024);\n+    }\n+\n+    LOCK(cs_main);\n+\n+    chainman.m_total_coinstip_cache = cache_sizes.coins;\n+    chainman.m_total_coinsdb_cache = cache_sizes.coins_db;\n+\n+    // Load the fully validated chainstate.\n+    chainman.InitializeChainstate(options.mempool);\n+\n+    // Load a chain created from a UTXO snapshot, if any exist.\n+    chainman.DetectSnapshotChainstate(options.mempool);\n+\n+    auto [init_status, init_error] = CompleteChainstateInitialization(chainman, cache_sizes, options);\n+    if (init_status != ChainstateLoadStatus::SUCCESS) {\n+        return {init_status, init_error};\n+    }\n+\n+    // If a snapshot chainstate was fully validated by a background chainstate during\n+    // the last run, detect it here and clean up the now-unneeded background\n+    // chainstate.\n+    //\n+    // Why is this cleanup done here (on subsequent restart) and not just when the\n+    // snapshot is actually validated? Because this entails unusual\n+    // filesystem operations to move leveldb data directories around, and that seems\n+    // too risky to do in the middle of normal runtime.\n+    auto snapshot_completion = chainman.MaybeCompleteSnapshotValidation();\n+\n+    if (snapshot_completion == SnapshotCompletionResult::SKIPPED) {\n+        // do nothing; expected case\n+    } else if (snapshot_completion == SnapshotCompletionResult::SUCCESS) {\n+        LogPrintf(\"[snapshot] cleaning up unneeded background chainstate, then reinitializing\\n\");\n+        if (!chainman.ValidatedSnapshotCleanup()) {\n+            AbortNode(\"Background chainstate cleanup failed unexpectedly.\");\n+        }\n+\n+        // Because ValidatedSnapshotCleanup() has torn down chainstates with\n+        // ChainstateManager::ResetChainstates(), reinitialize them here without\n+        // duplicating the blockindex work above.\n+        assert(chainman.GetAll().empty());\n+        assert(!chainman.IsSnapshotActive());\n+        assert(!chainman.IsSnapshotValidated());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1029672259",
      "id" : 1029672259,
      "line" : 212,
      "node_id" : "PRRC_kwDOABII5849X41D",
      "original_commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "original_line" : 212,
      "original_position" : 120,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : 120,
      "pull_request_review_id" : 1190503385,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1029672259/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-22T19:32:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1029672259",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1029685595"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1029685595"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think `CompleteChainstateInitialization` would deserve to be better documented, notably the functional difference when there is a single chainstate and when multiple are present (background/snapshot). From my understanding, apart of the coin caches balancing, all the other operations are affecting the state of `ChainstateManager` / `BlockManager`, shared between both chainstates. ",
      "commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "created_at" : "2022-11-22T18:22:28Z",
      "diff_hunk" : "@@ -170,6 +152,84 @@ ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSize\n     return {ChainstateLoadStatus::SUCCESS, {}};\n }\n \n+ChainstateLoadResult LoadChainstate(ChainstateManager& chainman, const CacheSizes& cache_sizes,\n+                                    const ChainstateLoadOptions& options)\n+{\n+    if (!chainman.AssumedValidBlock().IsNull()) {\n+        LogPrintf(\"Assuming ancestors of block %s have valid signatures.\\n\", chainman.AssumedValidBlock().GetHex());\n+    } else {\n+        LogPrintf(\"Validating signatures for all blocks.\\n\");\n+    }\n+    LogPrintf(\"Setting nMinimumChainWork=%s\\n\", chainman.MinimumChainWork().GetHex());\n+    if (chainman.MinimumChainWork() < UintToArith256(chainman.GetConsensus().nMinimumChainWork)) {\n+        LogPrintf(\"Warning: nMinimumChainWork set below default value of %s\\n\", chainman.GetConsensus().nMinimumChainWork.GetHex());\n+    }\n+    if (nPruneTarget == std::numeric_limits<uint64_t>::max()) {\n+        LogPrintf(\"Block pruning enabled.  Use RPC call pruneblockchain(height) to manually prune block and undo files.\\n\");\n+    } else if (nPruneTarget) {\n+        LogPrintf(\"Prune configured to target %u MiB on disk for block and undo files.\\n\", nPruneTarget / 1024 / 1024);\n+    }\n+\n+    LOCK(cs_main);\n+\n+    chainman.m_total_coinstip_cache = cache_sizes.coins;\n+    chainman.m_total_coinsdb_cache = cache_sizes.coins_db;\n+\n+    // Load the fully validated chainstate.\n+    chainman.InitializeChainstate(options.mempool);\n+\n+    // Load a chain created from a UTXO snapshot, if any exist.\n+    chainman.DetectSnapshotChainstate(options.mempool);\n+\n+    auto [init_status, init_error] = CompleteChainstateInitialization(chainman, cache_sizes, options);\n+    if (init_status != ChainstateLoadStatus::SUCCESS) {\n+        return {init_status, init_error};\n+    }\n+\n+    // If a snapshot chainstate was fully validated by a background chainstate during\n+    // the last run, detect it here and clean up the now-unneeded background\n+    // chainstate.\n+    //\n+    // Why is this cleanup done here (on subsequent restart) and not just when the\n+    // snapshot is actually validated? Because this entails unusual\n+    // filesystem operations to move leveldb data directories around, and that seems\n+    // too risky to do in the middle of normal runtime.\n+    auto snapshot_completion = chainman.MaybeCompleteSnapshotValidation();\n+\n+    if (snapshot_completion == SnapshotCompletionResult::SKIPPED) {\n+        // do nothing; expected case\n+    } else if (snapshot_completion == SnapshotCompletionResult::SUCCESS) {\n+        LogPrintf(\"[snapshot] cleaning up unneeded background chainstate, then reinitializing\\n\");\n+        if (!chainman.ValidatedSnapshotCleanup()) {\n+            AbortNode(\"Background chainstate cleanup failed unexpectedly.\");\n+        }\n+\n+        // Because ValidatedSnapshotCleanup() has torn down chainstates with\n+        // ChainstateManager::ResetChainstates(), reinitialize them here without\n+        // duplicating the blockindex work above.\n+        assert(chainman.GetAll().empty());\n+        assert(!chainman.IsSnapshotActive());\n+        assert(!chainman.IsSnapshotValidated());\n+\n+        chainman.InitializeChainstate(options.mempool);\n+\n+        // A reload of the block index is required to recompute setBlockIndexCandidates\n+        // for the fully validated chainstate.\n+        chainman.ActiveChainstate().UnloadBlockIndex();\n+\n+        auto [init_status, init_error] = CompleteChainstateInitialization(chainman, cache_sizes, options);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1029685595",
      "id" : 1029685595,
      "line" : 220,
      "node_id" : "PRRC_kwDOABII5849X8Fb",
      "original_commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "original_line" : 220,
      "original_position" : 128,
      "original_start_line" : null,
      "path" : "src/node/chainstate.cpp",
      "position" : 128,
      "pull_request_review_id" : 1190503385,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1029685595/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-22T19:32:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1029685595",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1029697008"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1029697008"
         }
      },
      "author_association" : "MEMBER",
      "body" : "A small note, I think here you could have a `SnapshotCompletionResult::NOT_MATURE_YET` as this usage doesn't really convey the same information of the previons one (i.e the lack of a background validation chainstate). ",
      "commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "created_at" : "2022-11-22T18:33:15Z",
      "diff_hunk" : "@@ -5196,6 +5241,149 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+// Currently, this function holds cs_main for its duration, which could be for\n+// multiple minutes due to the GetUTXOStats call. This hold is necessary\n+// because we need to avoid advancing the background validation chainstate\n+// farther than the snapshot base block - and this function is also invoked\n+// from within ConnectTip, i.e. from within ActivateBestChain, so cs_main is\n+// held anyway.\n+//\n+// Eventually (TODO), we could somehow separate this function's runtime from\n+// maintenance of the active chain, but that will either require\n+//\n+//  (i) setting `m_disabled` immediately and ensuring all chainstate accesses go\n+//      through IsUsable() checks, or\n+//\n+//  (ii) giving each chainstate its own lock instead of using cs_main for everything.\n+SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation(\n+      std::function<void(bilingual_str)> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (m_ibd_chainstate.get() == &this->ActiveChainstate() ||\n+            !this->IsUsable(m_snapshot_chainstate.get()) ||\n+            !this->IsUsable(m_ibd_chainstate.get()) ||\n+            !m_ibd_chainstate->m_chain.Tip()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return SnapshotCompletionResult::SKIPPED;\n+    }\n+    const int snapshot_tip_height = this->ActiveHeight();\n+    const int snapshot_base_height = *Assert(this->GetSnapshotBaseHeight());\n+    const CBlockIndex& index_new = *Assert(m_ibd_chainstate->m_chain.Tip());\n+\n+    if (index_new.nHeight < snapshot_base_height) {\n+        // Background IBD not complete yet.\n+        return SnapshotCompletionResult::SKIPPED;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1029697008",
      "id" : 1029697008,
      "line" : 5276,
      "node_id" : "PRRC_kwDOABII5849X-3w",
      "original_commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "original_line" : 5276,
      "original_position" : 159,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 159,
      "pull_request_review_id" : 1190503385,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1029697008/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-22T19:32:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1029697008",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1029743550"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1029743550"
         }
      },
      "author_association" : "MEMBER",
      "body" : "From my understanding there is a marginal case where this is not *only* a belt-and-suspender. When background chainstate reaches height parity with the snapshot chainstate, the background chainstate is torn down only in `LoadChainstate->ValidatedSnapshotCleanup` by the call to `ResetChainstates()` L5584. Before, ABC could be called as the background chainstate is still `ActiveChainstate()`, at least for the block of the connection sequence, before the remaining one hit the `m_disabled` L3106. If correct, the comment could be more informative.",
      "commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "created_at" : "2022-11-22T19:29:42Z",
      "diff_hunk" : "@@ -3032,6 +3040,13 @@ bool Chainstate::ActivateBestChain(BlockValidationState& state, std::shared_ptr<\n     // we use m_chainstate_mutex to enforce mutual exclusion so that only one caller may execute this function at a time\n     LOCK(m_chainstate_mutex);\n \n+    // Belt-and-suspenders check that we aren't attempting to advance the background\n+    // chainstate past the snapshot base block.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1029743550",
      "id" : 1029743550,
      "line" : 3044,
      "node_id" : "PRRC_kwDOABII5849YKO-",
      "original_commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "original_line" : 3044,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 20,
      "pull_request_review_id" : 1190503385,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1029743550/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-22T19:32:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1029743550",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2022-12-05T22:49:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1338284648",
      "id" : 1338284648,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585PxJpo",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1338284648/reactions"
      },
      "updated_at" : "2022-12-05T22:49:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1338284648",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2022-12-08T16:25:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1342978881",
      "id" : 1342978881,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585QDDtB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1342978881/reactions"
      },
      "updated_at" : "2022-12-08T16:25:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1342978881",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 30e113735ae3b1465d30b2125e7826a7a1527b99\r\n\r\nThe commit message of 287bb3f4ce41341aa0aea97b8176dc790889830d \"validation: add CChainState::m_disabled and ChainMan::isUsable\" still mentions `m_stop_use` rather than `m_disabled`",
      "created_at" : "2023-01-19T21:20:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1397624252",
      "id" : 1397624252,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585TTg28",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1397624252/reactions"
      },
      "updated_at" : "2023-01-19T21:20:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1397624252",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1114701299"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114701299"
         }
      },
      "author_association" : "MEMBER",
      "body" : "For what it's worth, in future PRs I think this possibility is eliminated, since calls like `ActiveChainstate().ActivateBestChain()` in ProcessNewBlock are replaced with specific chainstate references.",
      "commit_id" : "2b373fe49d64f04ceab2309d3f40da7bac6b37d6",
      "created_at" : "2023-02-22T17:34:23Z",
      "diff_hunk" : "@@ -3032,6 +3040,13 @@ bool Chainstate::ActivateBestChain(BlockValidationState& state, std::shared_ptr<\n     // we use m_chainstate_mutex to enforce mutual exclusion so that only one caller may execute this function at a time\n     LOCK(m_chainstate_mutex);\n \n+    // Belt-and-suspenders check that we aren't attempting to advance the background\n+    // chainstate past the snapshot base block.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1114701299",
      "id" : 1114701299,
      "in_reply_to_id" : 1029743550,
      "line" : 3079,
      "node_id" : "PRRC_kwDOABII585CcP3z",
      "original_commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "original_line" : 3079,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 20,
      "pull_request_review_id" : 1309794070,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114701299/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-22T17:34:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114701299",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1114710206"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114710206"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "2b373fe49d64f04ceab2309d3f40da7bac6b37d6",
      "created_at" : "2023-02-22T17:42:42Z",
      "diff_hunk" : "@@ -518,10 +533,156 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_snapshot_init, SnapshotTestSetup)\n         // chainstate.\n         for (Chainstate* cs : chainman_restarted.GetAll()) {\n             if (cs != &chainman_restarted.ActiveChainstate()) {\n-                BOOST_CHECK_EQUAL(cs->m_chain.Height(), 110);\n+                BOOST_CHECK_EQUAL(cs->m_chain.Height(), 109);\n             }\n         }\n     }\n }\n \n+BOOST_FIXTURE_TEST_CASE(chainstatemanager_snapshot_completion, SnapshotTestSetup)\n+{\n+    this->SetupSnapshot();\n+\n+    ChainstateManager& chainman = *Assert(m_node.chainman);\n+    Chainstate& active_cs = chainman.ActiveChainstate();\n+    auto tip_cache_before_complete = active_cs.m_coinstip_cache_size_bytes;\n+    auto db_cache_before_complete = active_cs.m_coinsdb_cache_size_bytes;\n+\n+    SnapshotCompletionResult res;\n+    auto mock_shutdown = [](bilingual_str msg) {};\n+\n+    fs::path snapshot_chainstate_dir = *node::FindSnapshotChainstateDir();\n+    BOOST_CHECK(fs::exists(snapshot_chainstate_dir));\n+    BOOST_CHECK_EQUAL(snapshot_chainstate_dir, gArgs.GetDataDirNet() / \"chainstate_snapshot\");\n+\n+    BOOST_CHECK(chainman.IsSnapshotActive());\n+    const uint256 snapshot_tip_hash = WITH_LOCK(chainman.GetMutex(),\n+        return chainman.ActiveTip()->GetBlockHash());\n+\n+    res = WITH_LOCK(::cs_main,\n+        return chainman.MaybeCompleteSnapshotValidation(mock_shutdown));\n+    BOOST_CHECK_EQUAL(res, SnapshotCompletionResult::SUCCESS);\n+\n+    WITH_LOCK(::cs_main, BOOST_CHECK(chainman.IsSnapshotValidated()));\n+    BOOST_CHECK(chainman.IsSnapshotActive());\n+\n+    // Cache should have been rebalanced and reallocated to the \"only\" remaining\n+    // chainstate.\n+    BOOST_CHECK(active_cs.m_coinstip_cache_size_bytes > tip_cache_before_complete);\n+    BOOST_CHECK(active_cs.m_coinsdb_cache_size_bytes > db_cache_before_complete);\n+\n+    auto all_chainstates = chainman.GetAll();\n+    BOOST_CHECK_EQUAL(all_chainstates.size(), 1);\n+    BOOST_CHECK_EQUAL(all_chainstates[0], &active_cs);\n+\n+    // Trying completion again should return false.\n+    res = WITH_LOCK(::cs_main,\n+        return chainman.MaybeCompleteSnapshotValidation(mock_shutdown));\n+    BOOST_CHECK_EQUAL(res, SnapshotCompletionResult::SKIPPED);\n+\n+    // The invalid snapshot path should not have been used.\n+    fs::path snapshot_invalid_dir = gArgs.GetDataDirNet() / \"chainstate_snapshot_INVALID\";\n+    BOOST_CHECK(!fs::exists(snapshot_invalid_dir));\n+    // chainstate_snapshot should still exist.\n+    BOOST_CHECK(fs::exists(snapshot_chainstate_dir));\n+\n+    // Test that simulating a shutdown (reseting ChainstateManager) and then performing\n+    // chainstate reinitializing successfully cleans up the background-validation\n+    // chainstate data, and we end up with a single chainstate that is at tip.\n+    ChainstateManager& chainman_restarted = this->SimulateNodeRestart();\n+\n+    BOOST_TEST_MESSAGE(\"Performing Load/Verify/Activate of chainstate\");\n+\n+    // This call reinitializes the chainstates, and should clean up the now unnecessary\n+    // background-validation leveldb contents.\n+    this->LoadVerifyActivateChainstate();\n+\n+    BOOST_CHECK(!fs::exists(snapshot_invalid_dir));\n+    // chainstate_snapshot should now *not* exist.\n+    BOOST_CHECK(!fs::exists(snapshot_chainstate_dir));\n+\n+    {\n+        LOCK(chainman_restarted.GetMutex());\n+        BOOST_CHECK_EQUAL(chainman_restarted.GetAll().size(), 1);\n+        BOOST_CHECK(!chainman_restarted.IsSnapshotActive());\n+        BOOST_CHECK(!chainman_restarted.IsSnapshotValidated());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1114710206",
      "id" : 1114710206,
      "in_reply_to_id" : 1029633554,
      "line" : 610,
      "node_id" : "PRRC_kwDOABII585CcSC-",
      "original_commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "original_line" : 610,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 113,
      "pull_request_review_id" : 1309806615,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114710206/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-22T17:51:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114710206",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1114710366"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114710366"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good for a follow-up.",
      "commit_id" : "2b373fe49d64f04ceab2309d3f40da7bac6b37d6",
      "created_at" : "2023-02-22T17:42:52Z",
      "diff_hunk" : "@@ -518,10 +533,156 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_snapshot_init, SnapshotTestSetup)\n         // chainstate.\n         for (Chainstate* cs : chainman_restarted.GetAll()) {\n             if (cs != &chainman_restarted.ActiveChainstate()) {\n-                BOOST_CHECK_EQUAL(cs->m_chain.Height(), 110);\n+                BOOST_CHECK_EQUAL(cs->m_chain.Height(), 109);\n             }\n         }\n     }\n }\n \n+BOOST_FIXTURE_TEST_CASE(chainstatemanager_snapshot_completion, SnapshotTestSetup)\n+{\n+    this->SetupSnapshot();\n+\n+    ChainstateManager& chainman = *Assert(m_node.chainman);\n+    Chainstate& active_cs = chainman.ActiveChainstate();\n+    auto tip_cache_before_complete = active_cs.m_coinstip_cache_size_bytes;\n+    auto db_cache_before_complete = active_cs.m_coinsdb_cache_size_bytes;\n+\n+    SnapshotCompletionResult res;\n+    auto mock_shutdown = [](bilingual_str msg) {};\n+\n+    fs::path snapshot_chainstate_dir = *node::FindSnapshotChainstateDir();\n+    BOOST_CHECK(fs::exists(snapshot_chainstate_dir));\n+    BOOST_CHECK_EQUAL(snapshot_chainstate_dir, gArgs.GetDataDirNet() / \"chainstate_snapshot\");\n+\n+    BOOST_CHECK(chainman.IsSnapshotActive());\n+    const uint256 snapshot_tip_hash = WITH_LOCK(chainman.GetMutex(),\n+        return chainman.ActiveTip()->GetBlockHash());\n+\n+    res = WITH_LOCK(::cs_main,\n+        return chainman.MaybeCompleteSnapshotValidation(mock_shutdown));\n+    BOOST_CHECK_EQUAL(res, SnapshotCompletionResult::SUCCESS);\n+\n+    WITH_LOCK(::cs_main, BOOST_CHECK(chainman.IsSnapshotValidated()));\n+    BOOST_CHECK(chainman.IsSnapshotActive());\n+\n+    // Cache should have been rebalanced and reallocated to the \"only\" remaining\n+    // chainstate.\n+    BOOST_CHECK(active_cs.m_coinstip_cache_size_bytes > tip_cache_before_complete);\n+    BOOST_CHECK(active_cs.m_coinsdb_cache_size_bytes > db_cache_before_complete);\n+\n+    auto all_chainstates = chainman.GetAll();\n+    BOOST_CHECK_EQUAL(all_chainstates.size(), 1);\n+    BOOST_CHECK_EQUAL(all_chainstates[0], &active_cs);\n+\n+    // Trying completion again should return false.\n+    res = WITH_LOCK(::cs_main,\n+        return chainman.MaybeCompleteSnapshotValidation(mock_shutdown));\n+    BOOST_CHECK_EQUAL(res, SnapshotCompletionResult::SKIPPED);\n+\n+    // The invalid snapshot path should not have been used.\n+    fs::path snapshot_invalid_dir = gArgs.GetDataDirNet() / \"chainstate_snapshot_INVALID\";\n+    BOOST_CHECK(!fs::exists(snapshot_invalid_dir));\n+    // chainstate_snapshot should still exist.\n+    BOOST_CHECK(fs::exists(snapshot_chainstate_dir));\n+\n+    // Test that simulating a shutdown (reseting ChainstateManager) and then performing\n+    // chainstate reinitializing successfully cleans up the background-validation\n+    // chainstate data, and we end up with a single chainstate that is at tip.\n+    ChainstateManager& chainman_restarted = this->SimulateNodeRestart();\n+\n+    BOOST_TEST_MESSAGE(\"Performing Load/Verify/Activate of chainstate\");\n+\n+    // This call reinitializes the chainstates, and should clean up the now unnecessary\n+    // background-validation leveldb contents.\n+    this->LoadVerifyActivateChainstate();\n+\n+    BOOST_CHECK(!fs::exists(snapshot_invalid_dir));\n+    // chainstate_snapshot should now *not* exist.\n+    BOOST_CHECK(!fs::exists(snapshot_chainstate_dir));\n+\n+    {\n+        LOCK(chainman_restarted.GetMutex());\n+        BOOST_CHECK_EQUAL(chainman_restarted.GetAll().size(), 1);\n+        BOOST_CHECK(!chainman_restarted.IsSnapshotActive());\n+        BOOST_CHECK(!chainman_restarted.IsSnapshotValidated());\n+\n+        BOOST_CHECK_EQUAL(chainman_restarted.ActiveTip()->GetBlockHash(), snapshot_tip_hash);\n+        BOOST_CHECK_EQUAL(chainman_restarted.ActiveHeight(), 210);\n+    }\n+\n+    BOOST_TEST_MESSAGE(\n+        \"Ensure we can mine blocks on top of the \\\"new\\\" IBD chainstate\");\n+    mineBlocks(10);\n+    {\n+        LOCK(chainman_restarted.GetMutex());\n+        BOOST_CHECK_EQUAL(chainman_restarted.ActiveHeight(), 220);\n+    }\n+}\n+\n+BOOST_FIXTURE_TEST_CASE(chainstatemanager_snapshot_completion_hash_mismatch, SnapshotTestSetup)\n+{\n+    auto chainstates = this->SetupSnapshot();\n+    Chainstate& validation_chainstate = *std::get<0>(chainstates);\n+    ChainstateManager& chainman = *Assert(m_node.chainman);\n+    SnapshotCompletionResult res;\n+    auto mock_shutdown = [](bilingual_str msg) {};\n+\n+    // Test tampering with the IBD UTXO set with an extra coin to ensure it causes\n+    // snapshot completion to fail.\n+    CCoinsViewCache& ibd_coins = WITH_LOCK(::cs_main,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1114710366",
      "id" : 1114710366,
      "in_reply_to_id" : 1029641430,
      "line" : 637,
      "node_id" : "PRRC_kwDOABII585CcSFe",
      "original_commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "original_line" : 637,
      "original_position" : 136,
      "original_start_line" : null,
      "path" : "src/test/validation_chainstatemanager_tests.cpp",
      "position" : 140,
      "pull_request_review_id" : 1309806615,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114710366/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-22T17:51:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114710366",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1114711213"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114711213"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "2b373fe49d64f04ceab2309d3f40da7bac6b37d6",
      "created_at" : "2023-02-22T17:43:44Z",
      "diff_hunk" : "@@ -2973,6 +2985,13 @@ bool Chainstate::ActivateBestChain(BlockValidationState& state, std::shared_ptr<\n     // we use m_chainstate_mutex to enforce mutual exclusion so that only one caller may execute this function at a time\n     LOCK(m_chainstate_mutex);\n \n+    // Belt-and-suspenders check that we aren't attempting to advance the background\n+    // chainstate past the snapshot base block.\n+    if (WITH_LOCK(::cs_main, return m_disabled)) {\n+        LogPrintf(\"m_disabled is set - this chainstate should not be in operation. Bug?.\\n\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1114711213",
      "id" : 1114711213,
      "in_reply_to_id" : 999984699,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585CcSSt",
      "original_commit_id" : "c1767471c1cb6f1b856c22d767c35c18e19045e5",
      "original_line" : 3044,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1309806615,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114711213/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-22T17:51:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114711213",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1114711271"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114711271"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "2b373fe49d64f04ceab2309d3f40da7bac6b37d6",
      "created_at" : "2023-02-22T17:43:48Z",
      "diff_hunk" : "@@ -5196,6 +5241,149 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+// Currently, this function holds cs_main for its duration, which could be for\n+// multiple minutes due to the GetUTXOStats call. This hold is necessary",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1114711271",
      "id" : 1114711271,
      "in_reply_to_id" : 1029649960,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585CcSTn",
      "original_commit_id" : "ab41e8b4093925dc339096c15b33fe8b4726f55a",
      "original_line" : 5253,
      "original_position" : 128,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1309806615,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114711271/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-22T17:51:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1114711271",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased and reworded the commit message that @achow101 pointed out was out of date. Also fixed two minor items that @ariard noted.\r\n\r\nIn attempt to encourage re-ACKers, here is the diff (including rebase items):\r\n\r\n```diff\r\ndiff <(git diff --no-color au.complete.10~9..au.complete.10) <(git diff --no-color au.complete.11~9..au.complete.11)\r\n109c109\r\n< index 60acb614b4..d36184fed7 100644\r\n---\r\n> index ba1024d22e..cd82d8743c 100644\r\n138c138\r\n< -    if (nPruneTarget == std::numeric_limits<uint64_t>::max()) {\r\n---\r\n> -    if (chainman.m_blockman.GetPruneTarget() == std::numeric_limits<uint64_t>::max()) {\r\n140,141c140,141\r\n< -    } else if (nPruneTarget) {\r\n< -        LogPrintf(\"Prune configured to target %u MiB on disk for block and undo files.\\n\", nPruneTarget / 1024 / 1024);\r\n---\r\n> -    } else if (chainman.m_blockman.GetPruneTarget()) {\r\n> -        LogPrintf(\"Prune configured to target %u MiB on disk for block and undo files.\\n\", chainman.m_blockman.GetPruneTarget() / 1024 / 1024);\r\n187c187\r\n< +    if (nPruneTarget == std::numeric_limits<uint64_t>::max()) {\r\n---\r\n> +    if (chainman.m_blockman.GetPruneTarget() == std::numeric_limits<uint64_t>::max()) {\r\n189,190c189,190\r\n< +    } else if (nPruneTarget) {\r\n< +        LogPrintf(\"Prune configured to target %u MiB on disk for block and undo files.\\n\", nPruneTarget / 1024 / 1024);\r\n---\r\n> +    } else if (chainman.m_blockman.GetPruneTarget()) {\r\n> +        LogPrintf(\"Prune configured to target %u MiB on disk for block and undo files.\\n\", chainman.m_blockman.GetPruneTarget() / 1024 / 1024);\r\n257c257\r\n< index 22b9af1201..fd6a9b4c2e 100644\r\n---\r\n> index 56867a584b..45d59b685c 100644\r\n294c294\r\n< @@ -518,10 +533,156 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_snapshot_init, SnapshotTestSetup)\r\n---\r\n> @@ -518,10 +533,160 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_snapshot_init, SnapshotTestSetup)\r\n366a367,368\r\n> +    const Chainstate& active_cs2 = chainman_restarted.ActiveChainstate();\r\n> +\r\n371a374,375\r\n> +        BOOST_CHECK(active_cs2.m_coinstip_cache_size_bytes > tip_cache_before_complete);\r\n> +        BOOST_CHECK(active_cs2.m_coinsdb_cache_size_bytes > db_cache_before_complete);\r\n453c457\r\n< index 76bea97341..0916827710 100644\r\n---\r\n> @@ -3067,6 +3075,14 @@ bool Chainstate::ActivateBestChain(BlockValidationState& state, std::shared_ptr<\r\n478c482,483\r\n< +        LogPrintf(\"m_disabled is set - this chainstate should not be in operation. Bug?.\\n\");\r\n---\r\n> +        LogPrintf(\"m_disabled is set - this chainstate should not be in operation. \" /* Continued */\r\n> +            \"Please report this as a bug. %s\\n\", PACKAGE_BUGREPORT);\r\n485c490\r\n< @@ -3080,6 +3095,15 @@ bool Chainstate::ActivateBestChain(BlockValidationState& state, std::shared_ptr<\r\n---\r\n\r\n\r\n```",
      "created_at" : "2023-02-22T17:50:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1440503591",
      "id" : 1440503591,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585V3Fcn",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1440503591/reactions"
      },
      "updated_at" : "2023-02-22T17:50:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1440503591",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-ACK a00d0e78510d79bc9fc57ec622aec98a65efa8c0",
      "created_at" : "2023-02-22T18:41:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1440601441",
      "id" : 1440601441,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585V3dVh",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1440601441/reactions"
      },
      "updated_at" : "2023-02-22T18:41:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1440601441",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "In the pull description, could drop or update \"Since it's dependent on the commits in https://github.com/bitcoin/bitcoin/pull/25667, I'm opening this as a draft.\"",
      "created_at" : "2023-02-22T19:14:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1440655812",
      "id" : 1440655812,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585V3qnE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1440655812/reactions"
      },
      "updated_at" : "2023-02-22T19:14:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1440655812",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'd like to test this with `loadtxoutset`. I wonder if I can just cherry-pick a few things from #15606 to do that myself, or if a more rigorous rebase is needed...",
      "created_at" : "2023-02-23T18:44:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1442260424",
      "id" : 1442260424,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585V9yXI",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1442260424/reactions"
      },
      "updated_at" : "2023-02-23T18:45:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1442260424",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Maintainers: what else would you like to see for a merge here?",
      "created_at" : "2023-02-28T16:58:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1448527435",
      "id" : 1448527435,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585WVsZL",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1448527435/reactions"
      },
      "updated_at" : "2023-02-28T16:58:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1448527435",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Maintainers: what else would you like to see for a merge here?\r\n\r\nWaiting for a couple more reviews.",
      "created_at" : "2023-02-28T17:43:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1448601870",
      "id" : 1448601870,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585WV-kO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1448601870/reactions"
      },
      "updated_at" : "2023-02-28T17:43:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1448601870",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> In the pull description, could drop or update \"Since it's dependent on the commits in #25667, I'm opening this as a draft.\"\r\n\r\nDone, thanks. ",
      "created_at" : "2023-03-02T19:17:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1452426488",
      "id" : 1452426488,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585WkkT4",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1452426488/reactions"
      },
      "updated_at" : "2023-03-02T19:17:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1452426488",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> The commit message of https://github.com/bitcoin/bitcoin/commit/287bb3f4ce41341aa0aea97b8176dc790889830d \"validation: add CChainState::m_disabled and ChainMan::isUsable\" still mentions m_stop_use rather than m_disabled\r\n\r\nIn the pull description, it still mention `m_stop_use`.",
      "created_at" : "2023-03-03T18:29:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1453928410",
      "id" : 1453928410,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585WqS_a",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1453928410/reactions"
      },
      "updated_at" : "2023-03-03T18:29:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1453928410",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Missed this on last review (sorry):\r\n\r\n```\r\n../../../src/validation.cpp: In member function âSnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation(std::function<void(bilingual_str)>)â:\r\n../../../src/validation.cpp:5450:14: error: catching polymorphic type âstruct StopHashingExceptionâ by value [-Werror=catch-value=]\r\n 5450 |     } catch (StopHashingException) {\r\n      |              ^~~~~~~~~~~~~~~~~~~~\r\n```",
      "created_at" : "2023-03-07T00:45:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#issuecomment-1457287964",
      "id" : 1457287964,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25740",
      "node_id" : "IC_kwDOABII585W3HMc",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1457287964/reactions"
      },
      "updated_at" : "2023-03-07T00:46:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1457287964",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1133279555"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1133279555"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Just catching up... Not sure if intentional or not but maybe the XXX here was something you still wanted to address but missed @jamesob ?",
      "commit_id" : "2b373fe49d64f04ceab2309d3f40da7bac6b37d6",
      "created_at" : "2023-03-12T15:55:06Z",
      "diff_hunk" : "@@ -5243,6 +5291,149 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+// Currently, this function holds cs_main for its duration, which could be for\n+// multiple minutes due to the ComputeUTXOStats call. This hold is necessary\n+// because we need to avoid advancing the background validation chainstate\n+// farther than the snapshot base block - and this function is also invoked\n+// from within ConnectTip, i.e. from within ActivateBestChain, so cs_main is\n+// held anyway.\n+//\n+// Eventually (TODO), we could somehow separate this function's runtime from\n+// maintenance of the active chain, but that will either require\n+//\n+//  (i) setting `m_disabled` immediately and ensuring all chainstate accesses go\n+//      through IsUsable() checks, or\n+//\n+//  (ii) giving each chainstate its own lock instead of using cs_main for everything.\n+SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation(\n+      std::function<void(bilingual_str)> shutdown_fnc)\n+{\n+    AssertLockHeld(cs_main);\n+    if (m_ibd_chainstate.get() == &this->ActiveChainstate() ||\n+            !this->IsUsable(m_snapshot_chainstate.get()) ||\n+            !this->IsUsable(m_ibd_chainstate.get()) ||\n+            !m_ibd_chainstate->m_chain.Tip()) {\n+       // Nothing to do - this function only applies to the background\n+       // validation chainstate.\n+       return SnapshotCompletionResult::SKIPPED;\n+    }\n+    const int snapshot_tip_height = this->ActiveHeight();\n+    const int snapshot_base_height = *Assert(this->GetSnapshotBaseHeight());\n+    const CBlockIndex& index_new = *Assert(m_ibd_chainstate->m_chain.Tip());\n+\n+    if (index_new.nHeight < snapshot_base_height) {\n+        // Background IBD not complete yet.\n+        return SnapshotCompletionResult::SKIPPED;\n+    }\n+\n+    assert(SnapshotBlockhash());\n+    uint256 snapshot_blockhash = *Assert(SnapshotBlockhash());\n+\n+    auto handle_invalid_snapshot = [&]() EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+        bilingual_str user_error = strprintf(_(\n+            \"%s failed to validate the -assumeutxo snapshot state. \"\n+            \"This indicates a hardware problem, or a bug in the software, or a \"\n+            \"bad software modification that allowed an invalid snapshot to be \"\n+            \"loaded. As a result of this, the node will shut down and stop using any \"\n+            \"state that was built on the snapshot, resetting the chain height \"\n+            \"from %d to %d. On the next \"\n+            \"restart, the node will resume syncing from %d \"\n+            \"without using any snapshot data. \"\n+            \"Please report this incident to %s, including how you obtained the snapshot. \"\n+            \"The invalid snapshot chainstate has been left on disk in case it is \"\n+            \"helpful in diagnosing the issue that caused this error.\"),\n+            PACKAGE_NAME, snapshot_tip_height, snapshot_base_height, snapshot_base_height, PACKAGE_BUGREPORT\n+        );\n+\n+        LogPrintf(\"[snapshot] !!! %s\\n\", user_error.original);\n+        LogPrintf(\"[snapshot] deleting snapshot, reverting to validated chain, and stopping node\\n\");\n+\n+        m_active_chainstate = m_ibd_chainstate.get();\n+        m_snapshot_chainstate->m_disabled = true;\n+        assert(!this->IsUsable(m_snapshot_chainstate.get()));\n+        assert(this->IsUsable(m_ibd_chainstate.get()));\n+\n+        m_snapshot_chainstate->InvalidateCoinsDBOnDisk();\n+\n+        shutdown_fnc(user_error);\n+    };\n+\n+    if (index_new.GetBlockHash() != snapshot_blockhash) {\n+        LogPrintf(\"[snapshot] supposed base block %s does not match the \" /* Continued */\n+          \"snapshot base block %s (height %d). Snapshot is not valid.\",\n+          index_new.ToString(), snapshot_blockhash.ToString(), snapshot_base_height);\n+        handle_invalid_snapshot();\n+        return SnapshotCompletionResult::BASE_BLOCKHASH_MISMATCH;\n+    }\n+\n+    assert(index_new.nHeight == snapshot_base_height);\n+\n+    int curr_height = m_ibd_chainstate->m_chain.Height();\n+\n+    assert(snapshot_base_height == curr_height);\n+    assert(snapshot_base_height == index_new.nHeight);\n+    assert(this->IsUsable(m_snapshot_chainstate.get()));\n+    assert(this->GetAll().size() == 2);\n+\n+    CCoinsViewDB& ibd_coins_db = m_ibd_chainstate->CoinsDB();\n+    m_ibd_chainstate->ForceFlushStateToDisk();\n+\n+    auto maybe_au_data = ExpectedAssumeutxo(curr_height, ::Params());\n+    if (!maybe_au_data) {\n+        LogPrintf(\"[snapshot] assumeutxo data not found for height \" /* Continued */\n+            \"(%d) - refusing to validate snapshot\\n\", curr_height);\n+        handle_invalid_snapshot();\n+        return SnapshotCompletionResult::MISSING_CHAINPARAMS;\n+    }\n+\n+    const AssumeutxoData& au_data = *maybe_au_data;\n+    std::optional<CCoinsStats> maybe_ibd_stats;\n+    LogPrintf(\"[snapshot] computing UTXO stats for background chainstate to validate \" /* Continued */\n+        \"snapshot - this could take a few minutes\\n\");\n+    try {\n+        maybe_ibd_stats = ComputeUTXOStats(\n+            CoinStatsHashType::HASH_SERIALIZED,\n+            &ibd_coins_db,\n+            m_blockman,\n+            SnapshotUTXOHashBreakpoint);\n+    } catch (StopHashingException const&) {\n+        return SnapshotCompletionResult::STATS_FAILED;\n+    }\n+\n+    // XXX note that this function is slow and will hold cs_main for potentially minutes.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25740#discussion_r1133279555",
      "id" : 1133279555,
      "line" : 5405,
      "node_id" : "PRRC_kwDOABII585DjHlD",
      "original_commit_id" : "d96c59cc5cd2f73f1f55c133c52208671fe75ef3",
      "original_line" : 5403,
      "original_position" : 213,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 237,
      "pull_request_review_id" : 1336046783,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25740",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1133279555/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-03-12T15:55:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1133279555",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   }
]
