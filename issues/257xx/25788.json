{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "With the release of binutils/ld 2.36, ld swapped to much improved\r\ndefault settings when producing windows binaries with mingw-w64. One of\r\nthese changes was to stop stripping the .reloc section from binaries,\r\nwhich is required for working ASLR.\r\n\r\nWhen we switched to using a newer Guix time-machine in #23778, we begun\r\nusing binutils 2.37 to produce releases. Since then, our windows\r\ninstaller (produced with makensis) has not functioned correctly when run on\r\na Windows system with the \"Force randomization for images (Mandatory ASLR)\"\r\noption enabled. Note that all of our other release binaries, which all\r\ncontain .reloc sections, function fine under the same option, so it\r\ncannot be just the presence of a .reloc section that is the issue.\r\n\r\nThe root cause of the problem is that when we compile NSIS (makensis), a number\r\nof exe installer stubs are produced at the same time, for use later when makensis\r\nis actually run. Given the new linker defaults, the stubs will contain .reloc sections,\r\nwhen previously they would not. It seems that, in combination with how makensis\r\nmutates the stub when it actually builds the installer, causes the problem.\r\n\r\nAccording to upstream, https://sourceforge.net/p/nsis/bugs/1131/#abb6:\r\n> Looks like the problem is the very existance of the .reloc section.\r\n> It's not supposed to be there, and makensis doesn't handle it.\r\n\r\nThe most recent .reloc related upstream activity is in\r\nhttps://sourceforge.net/p/nsis/bugs/1283/, where the conclusion again seemed to\r\nbe that .relo sections are not wanted, but there hasn't been any further follow up.\r\n\r\nFor now, restore pre-binutils-2.36 behaviour, by passing `-Wl,--disable-reloc-section`\r\nto the linker when building the installer stubs, which fixes the produced installer. \r\nThe underlying issue can be further investigated in future.\r\n\r\n.reloc section stripping is something we've accounted for previously,\r\nsee #18702, and related upstream discussion is in this thread:\r\nhttps://sourceware.org/bugzilla/show_bug.cgi?id=19011.\r\n\r\nFixes #25726.\r\n\r\nGuix Build (x86_64):\r\n```bash\r\n7e0723388913ac1ec9f650b943c6b23351ba0cd921c0ec830abf16b16724d503  guix-build-7a0b129c41d9/output/dist-archive/bitcoin-7a0b129c41d9.tar.gz\r\nc3bb9c68895ffafa2900b0d18c1268e299d012a7dc70593f20f9900cf116eb05  guix-build-7a0b129c41d9/output/x86_64-w64-mingw32/SHA256SUMS.part\r\nb57aa99c242b0aae64653c64ada38f6d3f0cbd902bbc096d3dc529fdcf87d681  guix-build-7a0b129c41d9/output/x86_64-w64-mingw32/bitcoin-7a0b129c41d9-win64-debug.zip\r\n341d99afc9961299883be6cd9666e8bc0f3f6296cff758719a32d27419acad36  guix-build-7a0b129c41d9/output/x86_64-w64-mingw32/bitcoin-7a0b129c41d9-win64-setup-unsigned.exe\r\n1d9ef48d3c9ed93a925962356b41cdaeb9d09fd758de193cd4d5f4d1ec6791eb  guix-build-7a0b129c41d9/output/x86_64-w64-mingw32/bitcoin-7a0b129c41d9-win64-unsigned.tar.gz\r\n28c81d99a9a4bd6648449393f91db213369e958add579ba9e9a1721540d2c4f7  guix-build-7a0b129c41d9/output/x86_64-w64-mingw32/bitcoin-7a0b129c41d9-win64.zip\r\n```\r\n\r\nGuix Build (arm64):\r\n```bash\r\n7e0723388913ac1ec9f650b943c6b23351ba0cd921c0ec830abf16b16724d503  guix-build-7a0b129c41d9/output/dist-archive/bitcoin-7a0b129c41d9.tar.gz\r\nc3bb9c68895ffafa2900b0d18c1268e299d012a7dc70593f20f9900cf116eb05  guix-build-7a0b129c41d9/output/x86_64-w64-mingw32/SHA256SUMS.part\r\nb57aa99c242b0aae64653c64ada38f6d3f0cbd902bbc096d3dc529fdcf87d681  guix-build-7a0b129c41d9/output/x86_64-w64-mingw32/bitcoin-7a0b129c41d9-win64-debug.zip\r\n341d99afc9961299883be6cd9666e8bc0f3f6296cff758719a32d27419acad36  guix-build-7a0b129c41d9/output/x86_64-w64-mingw32/bitcoin-7a0b129c41d9-win64-setup-unsigned.exe\r\n1d9ef48d3c9ed93a925962356b41cdaeb9d09fd758de193cd4d5f4d1ec6791eb  guix-build-7a0b129c41d9/output/x86_64-w64-mingw32/bitcoin-7a0b129c41d9-win64-unsigned.tar.gz\r\n28c81d99a9a4bd6648449393f91db213369e958add579ba9e9a1721540d2c4f7  guix-build-7a0b129c41d9/output/x86_64-w64-mingw32/bitcoin-7a0b129c41d9-win64.zip\r\n```",
   "closed_at" : "2022-08-05T19:32:36Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
      "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
      "followers_url" : "https://api.github.com/users/achow101/followers",
      "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/achow101",
      "id" : 3782274,
      "login" : "achow101",
      "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
      "organizations_url" : "https://api.github.com/users/achow101/orgs",
      "received_events_url" : "https://api.github.com/users/achow101/received_events",
      "repos_url" : "https://api.github.com/users/achow101/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/achow101"
   },
   "comments" : 2,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25788/comments",
   "created_at" : "2022-08-05T17:48:29Z",
   "draft" : false,
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25788/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/25788",
   "id" : 1330207169,
   "labels" : [
      {
         "color" : "884400",
         "default" : false,
         "description" : null,
         "id" : 234877,
         "name" : "Windows",
         "node_id" : "MDU6TGFiZWwyMzQ4Nzc=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Windows"
      },
      {
         "color" : "5319e7",
         "default" : false,
         "description" : null,
         "id" : 61889416,
         "name" : "Build system",
         "node_id" : "MDU6TGFiZWw2MTg4OTQxNg==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Build%20system"
      },
      {
         "color" : "bfd4f2",
         "default" : false,
         "description" : "",
         "id" : 1947349437,
         "name" : "DrahtBot Guix build requested",
         "node_id" : "MDU6TGFiZWwxOTQ3MzQ5NDM3",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/DrahtBot%20Guix%20build%20requested"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25788/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "PR_kwDOABII5848u4M1",
   "number" : 25788,
   "performed_via_github_app" : null,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/25788.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/25788",
      "merged_at" : "2022-08-05T19:32:36Z",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/25788.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/25788"
   },
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25788/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "state_reason" : null,
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25788/timeline",
   "title" : "guix: patch NSIS to remove .reloc sections from installer stubs",
   "updated_at" : "2022-08-05T19:32:36Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/25788",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
      "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
      "followers_url" : "https://api.github.com/users/fanquake/followers",
      "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
      "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/fanquake",
      "id" : 863730,
      "login" : "fanquake",
      "node_id" : "MDQ6VXNlcjg2MzczMA==",
      "organizations_url" : "https://api.github.com/users/fanquake/orgs",
      "received_events_url" : "https://api.github.com/users/fanquake/received_events",
      "repos_url" : "https://api.github.com/users/fanquake/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/fanquake"
   }
}
