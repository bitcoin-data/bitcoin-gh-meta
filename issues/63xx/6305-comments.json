[
   {
      "body" : "While there are no other builds in the queue, I'll force-push a few times to try to trigger the NPE",
      "created_at" : "2015-06-19T03:53:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6305#issuecomment-113358870",
      "id" : 113358870,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6305",
      "updated_at" : "2015-06-19T03:53:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/113358870",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "Grr, 7 forced rebuilds and no errors. I'm not sure if that's a good thing or not :)",
      "created_at" : "2015-06-19T05:53:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6305#issuecomment-113383354",
      "id" : 113383354,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6305",
      "updated_at" : "2015-06-19T05:53:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/113383354",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "Well it tends to happen in droves, as if it depends on the load on the Travis server.\r\nI wouldn't applaud yet :)\r\n",
      "created_at" : "2015-06-19T06:27:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6305#issuecomment-113390255",
      "id" : 113390255,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6305",
      "updated_at" : "2015-06-19T06:27:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/113390255",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "Going ahead and merging this for troubleshooting improvement.",
      "created_at" : "2015-06-19T12:58:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6305#issuecomment-113507911",
      "id" : 113507911,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6305",
      "updated_at" : "2015-06-19T12:58:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/113507911",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=3",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "body" : "The issue is still present. I looped it locally, until it failed (took around 30 min):\r\n```\r\n06:34:40 15 BitcoindComparisonTool$1.onPreMessageReceived: Requested 230386124745549b4a14cb801c16c308568fcc5679b5afd9df0d8601cf938f7e\r\n06:34:40 15 Peer.processMessage: Received unhandled message: Reject: block 0f863347c378794f3a04e2899158a2f952c3720159fe71b6e13d23cca538f4d2 for reason 'bad-txns-inputs-missingorspent' (16)\r\n06:34:40 15 Peer.processMessage: Received unhandled message: Reject: block 230386124745549b4a14cb801c16c308568fcc5679b5afd9df0d8601cf938f7e for reason 'bad-blk-sigops' (16)\r\n06:34:40 1 BitcoindComparisonTool.main: Sent inv with block 0f863347c378794f3a04e2899158a2f952c3720159fe71b6e13d23cca538f4d2\r\n06:34:40 15 BitcoindComparisonTool$1.onPreMessageReceived: Got empty header message from bitcoind\r\nException in thread \"main\" java.lang.NullPointerException\r\n\tat com.google.bitcoin.core.BitcoindComparisonTool.main(BitcoindComparisonTool.java:311)\r\n```\r\ndebug.log:\r\n```\r\n2015-06-19 16:34:40 received: getheaders (69 bytes) peer=1\r\n2015-06-19 16:34:40 getheaders -1 to 0000000000000000000000000000000000000000000000000000000000000000 from peer=1\r\n2015-06-19 16:34:40 sending: headers (1 bytes) peer=1\r\n2015-06-19 16:34:40 received: ping (8 bytes) peer=1\r\n2015-06-19 16:34:40 sending: pong (8 bytes) peer=1\r\n2015-06-19 16:34:41 trying connection 0.0.0.0 lastseen=0.0hrs\r\n```\r\n\r\nIt's caused by [BitcoindComparisonTool.java#L311](https://github.com/theuni/bitcoinj/blob/be0eef774462409df277b2a83d71c30451f107c5/core/src/test/java/com/google/bitcoin/core/BitcoindComparisonTool.java#L311):\r\n```java\r\nbitcoind.ping().get();\r\n```\r\nMore specifically, because `future` of `PendingPing` ([Peer.java#L1424](https://github.com/theuni/bitcoinj/blob/be0eef774462409df277b2a83d71c30451f107c5/core/src/main/java/com/google/bitcoin/core/Peer.java#L1424)) was `null`, which was returned by `ping()`, presumably because a pong was received, and processed via `PendingPing#complete()` ([Peer.java#L1383](https://github.com/theuni/bitcoinj/blob/be0eef774462409df277b2a83d71c30451f107c5/core/src/main/java/com/google/bitcoin/core/Peer.java#L1383)), before it went through:\r\n```java\r\n/**\r\n* Sends the peer a ping message and returns a future that will be invoked when the pong is received back.\r\n* The future provides a number which is the number of milliseconds elapsed between the ping and the pong.\r\n* Once the pong is received the value returned by {@link com.google.bitcoin.core.Peer#getLastPingTime()} is\r\n* updated.\r\n* @throws ProtocolException if the peer version is too low to support measurable pings.\r\n*/\r\npublic ListenableFuture<Long> ping()\r\n```\r\n",
      "created_at" : "2015-06-19T17:10:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6305#issuecomment-113578450",
      "id" : 113578450,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6305",
      "updated_at" : "2015-06-19T17:10:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/113578450",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5836089?v=3",
         "events_url" : "https://api.github.com/users/dexX7/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dexX7/followers",
         "following_url" : "https://api.github.com/users/dexX7/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dexX7/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dexX7",
         "id" : 5836089,
         "login" : "dexX7",
         "organizations_url" : "https://api.github.com/users/dexX7/orgs",
         "received_events_url" : "https://api.github.com/users/dexX7/received_events",
         "repos_url" : "https://api.github.com/users/dexX7/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dexX7/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dexX7/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dexX7"
      }
   },
   {
      "body" : "@dexX7 Thanks for having a look. The line numbers didn't change, so it's the same as before.\r\n\r\nI came to the same conclusion when I looked into it last time, but @mikehearn was confident that the issue couldn't be here. My guess was that it could be caused by a non-so-random PRNG causing ping lookups to race. In that case, replacing the bitcoind.ping().get() with bitcoind.ping(counter++).get() would avoid the issue I think.\r\n\r\n@mikehearn Mind having another look, now that we're sure the line#s are good? Even better, since @dexX7 can reproduce locally, maybe he'll be able to test proposed changes more easily.",
      "created_at" : "2015-06-19T17:18:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6305#issuecomment-113580134",
      "id" : 113580134,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6305",
      "updated_at" : "2015-06-19T17:18:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/113580134",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "> My guess was that it could be caused by a non-so-random PRNG causing ping lookups to race.\r\n\r\nAh, just to clarify: I'm not sure, how it's caused, and this was just a guess.\r\n\r\nBut regarding the nonce lookup \"collision\": I gave it a try and it looks like the nonce can be anything, there always seems to be only one ping in the pending pings list (at least in these tests, for what I saw).\r\n\r\nI quickly created a [stripped ping-pong only version](https://github.com/theuni/bitcoinj/commit/97eae8a4c8d0214cd87bce226074b88f3df64f94) of the tool with additional log output, and when running via:\r\n```\r\nqa/pull-tester/run-bitcoind-for-test.sh /usr/bin/java -jar /path/to/bitcoinj/core/target/pull-tests.jar qa/tmp/compTool 0 2>&1\r\n```\r\nThen the flipped created/clearing log entries further indicate the pong was indeed processed, before ping() finished:\r\n```\r\n09:44:37 1 Peer.ping: created ping with nonce: 1102\r\n09:44:37 11 Peer.processPong: clearing pong with nonce: 1102 (pending: 1)\r\n09:44:37 1 Peer.ping: created ping with nonce: 1103\r\n09:44:37 11 Peer.processPong: clearing pong with nonce: 1103 (pending: 1)\r\n09:44:37 1 Peer.ping: created ping with nonce: 1104\r\n09:44:37 11 Peer.processPong: clearing pong with nonce: 1104 (pending: 1)\r\n09:44:37 11 Peer.processPong: clearing pong with nonce: 1105 (pending: 1) <-- uh oh\r\n09:44:37 1 Peer.ping: created ping with nonce: 1105\r\n09:44:37 1 BitcoindComparisonTool.main: ERROR: ping() with nonce 1105 returned null\r\n```\r\n\r\n",
      "created_at" : "2015-06-19T19:51:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6305#issuecomment-113623614",
      "id" : 113623614,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6305",
      "updated_at" : "2015-06-19T19:51:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/113623614",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5836089?v=3",
         "events_url" : "https://api.github.com/users/dexX7/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dexX7/followers",
         "following_url" : "https://api.github.com/users/dexX7/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dexX7/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dexX7",
         "id" : 5836089,
         "login" : "dexX7",
         "organizations_url" : "https://api.github.com/users/dexX7/orgs",
         "received_events_url" : "https://api.github.com/users/dexX7/received_events",
         "repos_url" : "https://api.github.com/users/dexX7/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dexX7/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dexX7/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dexX7"
      }
   },
   {
      "body" : "@dexX7 Ah, great work. Looks like we have an answer :)",
      "created_at" : "2015-06-19T20:36:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6305#issuecomment-113633975",
      "id" : 113633975,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6305",
      "updated_at" : "2015-06-19T20:36:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/113633975",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "@dexX7 Thanks! The race is fixed in this commit:\r\n\r\nhttps://github.com/bitcoinj/bitcoinj/commit/ce50e0b7558d623481c4bb5c18d136de85268b2e\r\n\r\nRunning \"mvn package\" inside a git master checkout of bitcoinj should create a file core/target/pull-tests.jar that contains a fresh pull tester.",
      "created_at" : "2015-06-21T12:45:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6305#issuecomment-113894917",
      "id" : 113894917,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6305",
      "updated_at" : "2015-06-21T12:45:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/113894917",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/971089?v=3",
         "events_url" : "https://api.github.com/users/mikehearn/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mikehearn/followers",
         "following_url" : "https://api.github.com/users/mikehearn/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mikehearn/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mikehearn",
         "id" : 971089,
         "login" : "mikehearn",
         "organizations_url" : "https://api.github.com/users/mikehearn/orgs",
         "received_events_url" : "https://api.github.com/users/mikehearn/received_events",
         "repos_url" : "https://api.github.com/users/mikehearn/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mikehearn/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mikehearn/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mikehearn"
      }
   }
]
