[
   {
      "author_association" : "MEMBER",
      "body" : "This is the final PR in the #18876 series of PRs.\r\n\r\nNote that there are a couple of differences from @jimpo's original PR:\r\n\r\n1. I didn't include the `BlockUntilSyncedToCurrentChain()` call from within `PrepareBlockFilterRequest()` (https://github.com/bitcoin/bitcoin/pull/16442/files#diff-eff7adeaec73a769788bb78858815c91R2068). I wanted to avoid having the message handler thread blocked on the scheduler thread, which is what services the validation interface queue callbacks. If the scheduler thread is doing some heavy work (eg flushing large wallet state to disk) then the message handler thread could be blocked for a long time, during which we don't process or respond to messages from any peers. In such a case, I'd prefer simply to not provide the cfilter or cfheader to the requesting client, since they can just rerequest it after a short delay.\r\n\r\n2. I've removed the logic that prevents `-peerblockfilters` being set if the index isn't synced (https://github.com/bitcoin/bitcoin/pull/16442/files#diff-c865a8939105e6350a50af02766291b7R1791). That code was added in response to review comments that the service bit shouldn't be set dynamically (https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-555256244 and https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-555994220), but it doesn't address my concern, which is that a node on the network will change its service bits. Those service bits are cached by peers on the network and gossiped in `addr` messages, so it's best for them to be as constant as possible. As well as that, it's a pain for the node operator to have to stop-start the node multiple times to enable this feature. The downside of always signaling `NODE_COMPACT_FILTERS` is that clients might request cfilters or cfheaders before our index is ready and we won't be able to respond. There's no `notfound` equivalent message in BIP 157 to communicate that to the peer, so we just drop their request. I think this is acceptable because:\r\n\r\n    - it's a small window after startup\r\n    - clients should be robust to not receiving responses to individual requests.\r\n\r\nOf course, both of those decisions are up for debate. If there's a consensus that my changes aren't desirable, I'll happily revert them.",
      "created_at" : "2020-05-26T16:45:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19070#issuecomment-634142901",
      "id" : 634142901,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19070",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNDE0MjkwMQ==",
      "updated_at" : "2020-05-26T16:45:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/634142901",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18354 (Use shared pointers only in validation interface by bvbfan)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-05-27T19:56:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19070#issuecomment-634906456",
      "id" : 634906456,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19070",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNDkwNjQ1Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-15T20:26:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/634906456",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Both of these changes from the original PR violate BIP 157 as it is currently written. The BIP was designed to expose a consistent interface to clients, which is conceptually simpler, making it easier to implement client code correctly. The guarantee is that if a node has the COMPACT_FILTER service bit on and advertises that some block is in its main chain, then it must be able to serve the block filter and filter header for it in subsequent requests.\r\n\r\n1. This violates the guarantee because now a block could be connected, a client requests its filter header, but it has not been indexed yet and the node doesn't respond. I understand your concern, but from my perspective, changing to this behavior would be complicating the protocol because of an implementation limitation in Bitcoin Core's design. If the networking code had better support for asynchronous/concurrent processing, there would be no need to make this tradeoff. I'm clearly not suggesting waiting until the entire networking stack is rewritten to deploy this, but my objection is that the BIP shouldn't have to change because of the architecture of one (granted, clearly the most significant) implementation.\r\n\r\n2. I just really don't understand why it's preferable to falsely advertise support for some service that you are unable to provide. It seems crazy that a node would say \"I support BIP 157\", then some client says \"hey, give me BIP 157 data\", then radio silence. The addr advertisements are refreshed once per day or something like that IIRC. So assuming these nodes are up for a while, it's not too long before their updated service bits are discoverable. But also, it's not like the service bits are flapping -- they just go from 0 to 1 at some point. If it's a brand new node, then it's on the whole time, and if it's already in sync node then to toggles 0 to 1 once. So why make it toggle before the service is actually available? I should also say that this is different from NODE_NETWORK, which is used as a justification for this change. When you connect to a node, you get their start height in the version message, first of all. And also, if a node can't serve a block, its responses aren't inconsistent with each other as would be the case if you advertise you have a block but don't have the block filter.\r\n\r\nThose are my justifications. But this has been debated before, and if others aren't convinced, then we should at least update the BIP to reflect the more laissez faire behavior.",
      "created_at" : "2020-05-27T21:07:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19070#issuecomment-634940156",
      "id" : 634940156,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19070",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNDk0MDE1Ng==",
      "updated_at" : "2020-05-27T21:07:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/634940156",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "node_id" : "MDQ6VXNlcjg4MTI1Mw==",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for summarising your thoughts @jimpo. As you point out, there's already been debate about this. For the benefit for other reviewers, here are the comments from the original PR relevant to setting the service bits:\r\n\r\n- https://github.com/bitcoin/bitcoin/pull/16442#discussion_r322897395\r\n- https://github.com/bitcoin/bitcoin/pull/16442#discussion_r317867252\r\n- https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-555256244\r\n- https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-555994220\r\n- https://github.com/bitcoin/bitcoin/pull/16442#issuecomment-554537231 (relevant because the `inv` / `getdata` / `notfound` mechanism has a specific `notfound` message. If a similar mechanism existed for cfilters/cfheaders/cfcheckpts, I think that would resolve most of the disagreement here)\r\n- https://github.com/bitcoin/bitcoin/pull/16442#pullrequestreview-339014775\r\n- https://github.com/bitcoin/bitcoin/pull/16442#discussion_r401443707 \r\n\r\nTo summarize my opposition to dynamically setting service bits:\r\n\r\n- it's an abuse of the concept of service bits, which indicate capabilities, not state.\r\n- BIP 157 clients have to be robust to failed requests anyway, so failing in these window conditions shouldn't add much complexity (although a `notfound` equivalent would be preferable).\r\n- the current version of BIP 157 adds some implicit state between the client and server (\"StopHash MUST be known to belong to a block accepted by the receiving peer.\") which it'd be better to avoid.\r\n\r\nIn fact, BIP 157 and BIP 158 seem inconsistent. BIP 158 states \"If enabled, the node MUST respond to all BIP 157 messages for filter type 0x00\", but BIP 157 states \"A node that receives getcfilters with an unknown StopHash SHOULD NOT respond.\" (as well as listing several other conditions where the server shouldn't respond).\r\n\r\nAs I said, if the general consensus is that we should restore the behaviour from #16442, then I can do that. If not, I'm happy to open PRs to modify the BIPs.",
      "created_at" : "2020-05-27T22:22:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19070#issuecomment-634974738",
      "id" : 634974738,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19070",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNDk3NDczOA==",
      "updated_at" : "2020-05-27T22:22:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/634974738",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-05-29T09:48:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19070#issuecomment-635882569",
      "id" : 635882569,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19070",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNTg4MjU2OQ==",
      "updated_at" : "2020-05-29T09:48:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/635882569",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased on master and applied suggested changes by @fjahr (https://github.com/bitcoin/bitcoin/pull/19044#discussion_r432985941) and @jkczyz (https://github.com/bitcoin/bitcoin/pull/19044#discussion_r432201307, https://github.com/bitcoin/bitcoin/pull/19044#discussion_r432204149)",
      "created_at" : "2020-06-01T03:04:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19070#issuecomment-636588390",
      "id" : 636588390,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19070",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNjU4ODM5MA==",
      "updated_at" : "2020-06-01T03:04:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/636588390",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "re-review and Concept ACK f5c003d3ead182335252558c5c6c9b9ca8968065\r\n\r\nChanges since my previous review https://github.com/bitcoin/bitcoin/pull/18876#issuecomment-627322015:\r\n\r\n* Adding back `NODE_COMPACT_FILTERS` test which was temporarily removed for the earlier prs: https://github.com/bitcoin/bitcoin/pull/18876#issuecomment-627354481\r\n* Remove `BlockUntilSyncedToCurrentChain`: I liked the sync, because previously a light client could ask us for a filter if they received the block inv from us. Now it seems they will need to poll in a loop over p2p to achieve the same. And as you mention that loop doesn't have a trivial upper bound. So I am not sure removing this call is the right thing.\r\n\r\n* Remove the call to `IsSynced` when starting the node. This should mostly be relevant for IBD. Some low-powered machines might advertise the service bit days in advance without actually delivering filters. I think we should be nice about this and disconnect light clients as early as possible, since their only choice is to wait and reconnect to us in a few days when we are done with ibd. ",
      "created_at" : "2020-06-01T12:44:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19070#issuecomment-636840238",
      "id" : 636840238,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19070",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNjg0MDIzOA==",
      "updated_at" : "2020-06-01T12:44:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/636840238",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@jnewbery Does a node serve blocks during IBD? If not, would it be reasonable to simply remain in this state until the index is built?\r\n\r\n",
      "created_at" : "2020-06-01T17:50:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19070#issuecomment-637012339",
      "id" : 637012339,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19070",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNzAxMjMzOQ==",
      "updated_at" : "2020-06-01T17:50:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/637012339",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/4015903?v=4",
         "events_url" : "https://api.github.com/users/jkczyz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jkczyz/followers",
         "following_url" : "https://api.github.com/users/jkczyz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jkczyz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jkczyz",
         "id" : 4015903,
         "login" : "jkczyz",
         "node_id" : "MDQ6VXNlcjQwMTU5MDM=",
         "organizations_url" : "https://api.github.com/users/jkczyz/orgs",
         "received_events_url" : "https://api.github.com/users/jkczyz/received_events",
         "repos_url" : "https://api.github.com/users/jkczyz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jkczyz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jkczyz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jkczyz"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Code review ACK f5c003d3ead182335252558c5c6c9b9ca8968065\r\n\r\nConcerning the conceptual changes:\r\n- I prefer to not dynamically change the service bit, as you say they advertise capabilities, not state.\r\n- I am currently not sure about the removal of `BlockUntilSyncedToCurrentChain()`. I see the arguments for both but I am not sure which weighs heavier.",
      "created_at" : "2020-06-01T19:20:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19070#issuecomment-637054024",
      "id" : 637054024,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19070",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNzA1NDAyNA==",
      "updated_at" : "2020-06-01T19:20:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/637054024",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Does a node serve blocks during IBD?\r\n\r\nI believe the behaviour is:\r\n\r\n- we don't relay headers from blocks when we connect them (obviously, since we're not yet at the most work tip): https://github.com/bitcoin/bitcoin/blob/9bc7751cadbd038faf8ac1d62cda23fcf00d4cc2/src/net_processing.cpp#L1311-L1316\r\n- we won't respond if a peer sends us a `getheaders` message: https://github.com/bitcoin/bitcoin/blob/9bc7751cadbd038faf8ac1d62cda23fcf00d4cc2/src/net_processing.cpp#L2746-L2749\r\n- we'll still respond if a peer sends us a `getdata` message for a block that we've fully validated: https://github.com/bitcoin/bitcoin/blob/9bc7751cadbd038faf8ac1d62cda23fcf00d4cc2/src/net_processing.cpp#L1465\r\n\r\n> If not, would it be reasonable to simply remain in this state until the index is built?\r\n\r\nYes that's possible, but I'm not sure if it's desirable. I don't think we want block filter index building to interfere with block relay, even if it's only temporarily.",
      "created_at" : "2020-06-01T19:25:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19070#issuecomment-637056107",
      "id" : 637056107,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19070",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNzA1NjEwNw==",
      "updated_at" : "2020-06-01T21:33:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/637056107",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Concept ACK f5c003d3ead182335252558c5c6c9b9ca8968065\r\n\r\nI agree that service bits should not signal state.\r\n\r\nI'm also unsure on the `BlockUntilSyncedToCurrentChain()` story, as I don't quite understand the implications either way. This seems like an issue that could be addressed in a follow-up PR.\r\n\r\nIf BIPs 157 and 158 conflict with one another, then there should definitely be a clarification.",
      "created_at" : "2020-06-03T22:00:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19070#issuecomment-638484104",
      "id" : 638484104,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19070",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzODQ4NDEwNA==",
      "updated_at" : "2020-06-03T22:00:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/638484104",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1562417?v=4",
         "events_url" : "https://api.github.com/users/clarkmoody/events{/privacy}",
         "followers_url" : "https://api.github.com/users/clarkmoody/followers",
         "following_url" : "https://api.github.com/users/clarkmoody/following{/other_user}",
         "gists_url" : "https://api.github.com/users/clarkmoody/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/clarkmoody",
         "id" : 1562417,
         "login" : "clarkmoody",
         "node_id" : "MDQ6VXNlcjE1NjI0MTc=",
         "organizations_url" : "https://api.github.com/users/clarkmoody/orgs",
         "received_events_url" : "https://api.github.com/users/clarkmoody/received_events",
         "repos_url" : "https://api.github.com/users/clarkmoody/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/clarkmoody/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/clarkmoody/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/clarkmoody"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19070#discussion_r434906014"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19070"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/434906014"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If it's likely implementation will diverge from BIP with regards to error handling, it should be hinted somewhere. Better in release notes than here ?",
      "commit_id" : "f5c003d3ead182335252558c5c6c9b9ca8968065",
      "created_at" : "2020-06-03T23:09:50Z",
      "diff_hunk" : "@@ -285,6 +285,9 @@ enum ServiceFlags : uint64_t {\n     // NODE_WITNESS indicates that a node can be asked for blocks and transactions including\n     // witness data.\n     NODE_WITNESS = (1 << 3),\n+    // NODE_COMPACT_FILTERS means the node will service basic block filter requests.\n+    // See BIP157 and BIP158 for details on how this is implemented.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19070#discussion_r434906014",
      "id" : 434906014,
      "line" : 289,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDkwNjAxNA==",
      "original_commit_id" : "f5c003d3ead182335252558c5c6c9b9ca8968065",
      "original_line" : 289,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : 5,
      "pull_request_review_id" : 423997602,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19070",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-21T17:38:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/434906014",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19070#discussion_r439164089"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19070"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/439164089"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, I'm happy to add release notes describing the behavior. I won't do it in this branch unless I need to retouch it (to not invalidate the three ACKs).",
      "commit_id" : "f5c003d3ead182335252558c5c6c9b9ca8968065",
      "created_at" : "2020-06-12T01:46:37Z",
      "diff_hunk" : "@@ -285,6 +285,9 @@ enum ServiceFlags : uint64_t {\n     // NODE_WITNESS indicates that a node can be asked for blocks and transactions including\n     // witness data.\n     NODE_WITNESS = (1 << 3),\n+    // NODE_COMPACT_FILTERS means the node will service basic block filter requests.\n+    // See BIP157 and BIP158 for details on how this is implemented.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19070#discussion_r439164089",
      "id" : 439164089,
      "in_reply_to_id" : 434906014,
      "line" : 289,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE2NDA4OQ==",
      "original_commit_id" : "f5c003d3ead182335252558c5c6c9b9ca8968065",
      "original_line" : 289,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : 5,
      "pull_request_review_id" : 429410164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19070",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-21T17:38:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/439164089",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "There was some discussion in the PR Review Club about the two questions above (blocking the message handler thread on background tasks and whether to signal NODE_COMPACT_FILTERS before the filter index is built). I still feel strongly that we shouldn't add code in net_processing that blocks on the scheduler thread (and should make a rule that we *never* do that), and I also think we shouldn't flip service bits.\r\n\r\nThis PR currently has 3 ACKs. If anyone feels strongly that it's a mistake, they should speak up here.",
      "created_at" : "2020-06-12T02:08:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19070#issuecomment-643024428",
      "id" : 643024428,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19070",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0MzAyNDQyOA==",
      "updated_at" : "2020-06-12T02:08:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/643024428",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This is an optional service that is offered to light clients to provide them data that is hopefully useful to them. It seems a bit odd to signal support for that, but then degrade the user experience of light clients by making the service more fragile.\r\n\r\nDisconnecting early when the filter is still syncing should be a one-line check in our c++ code that helps light clients save 20 seconds. The added complexity here should be negligible compared to the overall complexity of blockfilters.\r\n\r\nAlso, Bitcoin Core is run on less-than-high-end machines or virtual cloud providers, which are known to have slow storage. Turning all of these nodes that have p2p blockfilters enabled into nodes that might not respond to x% of requests is increasing delay and bandwidth for light clients. Light clients need to repeat and re-repeat requests to different nodes. This is added overhead on top of the overhead caused by redundancy for asking multiple nodes for increased \"security\", if they implement that.",
      "created_at" : "2020-06-12T12:17:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19070#issuecomment-643239985",
      "id" : 643239985,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19070",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0MzIzOTk4NQ==",
      "updated_at" : "2020-06-12T12:17:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/643239985",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@MarcoFalke : what's the request here? Will you be happy if I changed the behavior when a filter can't be served to just disconnect immediately?",
      "created_at" : "2020-06-12T20:15:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19070#issuecomment-643464937",
      "id" : 643464937,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19070",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0MzQ2NDkzNw==",
      "updated_at" : "2020-06-12T20:15:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/643464937",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I haven't written the code, but I am assuming that the disconnect can be done with minimal added complexity and it would indeed make me like the changes here more.\r\n\r\nThough, looking into the future, p2p filters might not only be serviced to random 3rd party clients, but maybe also to your own light client (via a trusted connection), in which case redundancy is neither required nor possible. So a failure to serve a filter can only be answered with a polling loop. So I'd also argue to bring back the block-until-synced call. Note that the block-until-synced call is a noop if the filter is already synced with the chain.",
      "created_at" : "2020-06-12T20:41:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19070#issuecomment-643474746",
      "id" : 643474746,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19070",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0MzQ3NDc0Ng==",
      "updated_at" : "2020-06-12T20:41:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/643474746",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've updated this so that we disconnect immediately if we're not able to service a request. @MarcoFalke - care to rereview?",
      "created_at" : "2020-06-18T21:44:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19070#issuecomment-646321412",
      "id" : 646321412,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19070",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NjMyMTQxMg==",
      "updated_at" : "2020-06-18T21:44:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/646321412",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19070#discussion_r442552811"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19070"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442552811"
         }
      },
      "author_association" : "NONE",
      "body" : "@jnewbery you just requested an ack from MarcoFalke so I dunno if the ACKs have been invalidated?",
      "commit_id" : "f5c003d3ead182335252558c5c6c9b9ca8968065",
      "created_at" : "2020-06-18T23:26:07Z",
      "diff_hunk" : "@@ -285,6 +285,9 @@ enum ServiceFlags : uint64_t {\n     // NODE_WITNESS indicates that a node can be asked for blocks and transactions including\n     // witness data.\n     NODE_WITNESS = (1 << 3),\n+    // NODE_COMPACT_FILTERS means the node will service basic block filter requests.\n+    // See BIP157 and BIP158 for details on how this is implemented.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19070#discussion_r442552811",
      "id" : 442552811,
      "in_reply_to_id" : 434906014,
      "line" : 289,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU1MjgxMQ==",
      "original_commit_id" : "f5c003d3ead182335252558c5c6c9b9ca8968065",
      "original_line" : 289,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : 5,
      "pull_request_review_id" : 433709999,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19070",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-21T17:38:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442552811",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/284023?v=4",
         "events_url" : "https://api.github.com/users/ysangkok/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ysangkok/followers",
         "following_url" : "https://api.github.com/users/ysangkok/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ysangkok/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ysangkok",
         "id" : 284023,
         "login" : "ysangkok",
         "node_id" : "MDQ6VXNlcjI4NDAyMw==",
         "organizations_url" : "https://api.github.com/users/ysangkok/orgs",
         "received_events_url" : "https://api.github.com/users/ysangkok/received_events",
         "repos_url" : "https://api.github.com/users/ysangkok/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ysangkok/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ysangkok/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ysangkok"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19070#discussion_r443225609"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19070"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443225609"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit fe2e6bb06705f72346ed636becc60c45075a451e\r\n\r\nIt looks like this could disconnect a permissioned peer, which is probably unwanted. See the second part of https://github.com/bitcoin/bitcoin/pull/19070#issuecomment-643474746\r\n\r\nI'd prefer to wait until we can reply to the peer with a proper result.",
      "commit_id" : "f5c003d3ead182335252558c5c6c9b9ca8968065",
      "created_at" : "2020-06-21T14:34:25Z",
      "diff_hunk" : "@@ -2131,6 +2131,7 @@ static void ProcessGetCFHeaders(CNode& peer, CDataStream& vRecv, const CChainPar\n         if (!filter_index->LookupFilterHeader(prev_block, prev_header)) {\n             LogPrint(BCLog::NET, \"Failed to find block filter header in index: filter_type=%s, block_hash=%s\\n\",\n                          BlockFilterTypeName(filter_type), prev_block->GetBlockHash().ToString());\n+            peer.fDisconnect = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19070#discussion_r443225609",
      "id" : 443225609,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIyNTYwOQ==",
      "original_commit_id" : "fe2e6bb06705f72346ed636becc60c45075a451e",
      "original_line" : 2134,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 434506589,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19070",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-21T17:38:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443225609",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19070#discussion_r443240823"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19070"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443240823"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Reverted",
      "commit_id" : "f5c003d3ead182335252558c5c6c9b9ca8968065",
      "created_at" : "2020-06-21T17:39:01Z",
      "diff_hunk" : "@@ -2131,6 +2131,7 @@ static void ProcessGetCFHeaders(CNode& peer, CDataStream& vRecv, const CChainPar\n         if (!filter_index->LookupFilterHeader(prev_block, prev_header)) {\n             LogPrint(BCLog::NET, \"Failed to find block filter header in index: filter_type=%s, block_hash=%s\\n\",\n                          BlockFilterTypeName(filter_type), prev_block->GetBlockHash().ToString());\n+            peer.fDisconnect = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19070#discussion_r443240823",
      "id" : 443240823,
      "in_reply_to_id" : 443225609,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI0MDgyMw==",
      "original_commit_id" : "fe2e6bb06705f72346ed636becc60c45075a451e",
      "original_line" : 2134,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 434519609,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19070",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-21T17:39:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443240823",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ok, I've reverted back to the version that has 3 ACKs.",
      "created_at" : "2020-06-21T17:40:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19070#issuecomment-647158749",
      "id" : 647158749,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19070",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NzE1ODc0OQ==",
      "updated_at" : "2020-06-21T17:40:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/647158749",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Yeah, sorry for being unclear in what situations to disconnect. I will create a follow-up pull later this week unless someone beats me to it.\r\n\r\nThis might be ready for merge.",
      "created_at" : "2020-06-22T09:47:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19070#issuecomment-647409624",
      "id" : 647409624,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19070",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NzQwOTYyNA==",
      "updated_at" : "2020-06-22T09:47:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/647409624",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@MarcoFalke ready for merge, or does this require something else?",
      "created_at" : "2020-07-22T20:06:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19070#issuecomment-662669108",
      "id" : 662669108,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19070",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2MjY2OTEwOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-22T20:06:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/662669108",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This PR has ACKs/concept ACKs from:\r\n\r\n- @MarcoFalke (https://github.com/bitcoin/bitcoin/pull/19070#issuecomment-636840238)\r\n- @fjahr (https://github.com/bitcoin/bitcoin/pull/19070#issuecomment-637054024)\r\n- @clarkmoody (https://github.com/bitcoin/bitcoin/pull/19070#issuecomment-638484104)\r\n- @ariard (https://github.com/bitcoin/bitcoin/pull/19070#pullrequestreview-423997602)\r\n- @jonatack (https://github.com/bitcoin/bitcoin/pull/19070#pullrequestreview-424449204)\r\n\r\nI asked for people to speak up if they had any objection two months ago (https://github.com/bitcoin/bitcoin/pull/19070#issuecomment-643024428) and there hasn't been any substantial opposition.\r\n\r\nI think this PR is ready for merge.",
      "created_at" : "2020-08-11T09:36:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19070#issuecomment-671841647",
      "id" : 671841647,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19070",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY3MTg0MTY0Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-08-11T09:36:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/671841647",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
