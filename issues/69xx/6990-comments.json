[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> event_base_loopbreak was not doing what I expected it to. What I expected was that it sets a timeout, given that no other pending events it would exit in N seconds. However, what it does was delay the event loop exit with N seconds, even if nothing is pending.\n\n~~Sounds like you wanted `event_base_loopexit`? Ref:~~\n\n> The next event_base_loop() iteration after the given timer expires will complete normally (handling all queued events) then exit without blocking for events again.\n\n~~In any case, `event_base_loopbreak` should still exit immediately, stopping any `loop`s after the next event:~~\n\n> event_base_loop() will abort the loop after the next event is completed; event_base_loopbreak() is typically invoked from this event's callback. This behavior is analogous to the \"break;\" statement.\n\nAre you sure this isn't symptomatic of something else?\n\nReference: http://www.wangafu.net/~nickm/libevent-2.0/doxygen/html/event_8h.html#a07a7599e478e4031fa8cf52e26d8aa1e\n\n**edit**: Right, never mind, you were using `event_base_loopexit`, hence the confusion.  You're OP (before it was edited) makes it sound like you switched from `event_base_loopbreak`.\n",
      "created_at" : "2015-11-11T21:01:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6990#issuecomment-155908505",
      "id" : 155908505,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6990",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDE1NTkwODUwNQ==",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/155908505/reactions"
      },
      "updated_at" : "2015-11-13T00:57:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/155908505",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=4",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "node_id" : "MDQ6VXNlcjQxMzM5NQ==",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6990#discussion_r44586134"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6990"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44586134"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Out of interest, why do we have to wait [a hard coded timeout]?  Why can't we wait for all events to finish (and maybe just ignore all new incoming connections?)\n",
      "commit_id" : "a264c32e3321ae909ca59cb8ce8bf5d812dbc4e1",
      "created_at" : "2015-11-11T21:06:00Z",
      "diff_hunk" : "@@ -480,6 +475,14 @@ void StopHTTPServer()\n         workQueue->WaitExit();\n         delete workQueue;\n     }\n+    if (eventBase) {\n+        LogPrint(\"http\", \"Waiting for HTTP event thread to exit\\n\");\n+        // Give event loop a few seconds to exit (to send back last RPC responses), then break it\n+        if (!threadHTTP.try_join_for(boost::chrono::milliseconds(2000))) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6990#discussion_r44586134",
      "id" : 44586134,
      "line" : 486,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg2MTM0",
      "original_commit_id" : "856be4fe46bfc4194afc10f424a03a5fb09af76a",
      "original_line" : null,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6990",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44586134/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2015-11-13T10:10:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44586134",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=4",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "node_id" : "MDQ6VXNlcjQxMzM5NQ==",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "utACK\n",
      "created_at" : "2015-11-11T21:06:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6990#issuecomment-155910770",
      "id" : 155910770,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6990",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDE1NTkxMDc3MA==",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/155910770/reactions"
      },
      "updated_at" : "2015-11-11T21:06:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/155910770",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=4",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "node_id" : "MDQ6VXNlcjQxMzM5NQ==",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6990#discussion_r44586809"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6990"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44586809"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> all events to finish\n\nmay take a long time (minutes) depending what was going in in the past?\n",
      "commit_id" : "a264c32e3321ae909ca59cb8ce8bf5d812dbc4e1",
      "created_at" : "2015-11-11T21:11:48Z",
      "diff_hunk" : "@@ -480,6 +475,14 @@ void StopHTTPServer()\n         workQueue->WaitExit();\n         delete workQueue;\n     }\n+    if (eventBase) {\n+        LogPrint(\"http\", \"Waiting for HTTP event thread to exit\\n\");\n+        // Give event loop a few seconds to exit (to send back last RPC responses), then break it\n+        if (!threadHTTP.try_join_for(boost::chrono::milliseconds(2000))) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6990#discussion_r44586809",
      "id" : 44586809,
      "line" : 486,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg2ODA5",
      "original_commit_id" : "856be4fe46bfc4194afc10f424a03a5fb09af76a",
      "original_line" : null,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6990",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44586809/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2015-11-13T10:10:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44586809",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6990#discussion_r44588682"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6990"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44588682"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "@MarcoFalke but this doesn't stop new connections (or is that done elsewhere?) in that waiting time.  So conceptually, the status quo could be the same?\nThat is, new connections coming in, old ones still finishing. \n",
      "commit_id" : "a264c32e3321ae909ca59cb8ce8bf5d812dbc4e1",
      "created_at" : "2015-11-11T21:27:44Z",
      "diff_hunk" : "@@ -480,6 +475,14 @@ void StopHTTPServer()\n         workQueue->WaitExit();\n         delete workQueue;\n     }\n+    if (eventBase) {\n+        LogPrint(\"http\", \"Waiting for HTTP event thread to exit\\n\");\n+        // Give event loop a few seconds to exit (to send back last RPC responses), then break it\n+        if (!threadHTTP.try_join_for(boost::chrono::milliseconds(2000))) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6990#discussion_r44588682",
      "id" : 44588682,
      "line" : 486,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg4Njgy",
      "original_commit_id" : "856be4fe46bfc4194afc10f424a03a5fb09af76a",
      "original_line" : null,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6990",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44588682/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2015-11-13T10:10:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44588682",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=4",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "node_id" : "MDQ6VXNlcjQxMzM5NQ==",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6990#discussion_r44620210"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6990"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44620210"
         }
      },
      "author_association" : "MEMBER",
      "body" : "New connections are stopped just above, see where the accept sockets are torn down.\n\nThough it does look like we should close connected sockets in http_reject_request_cb as well for good measure. @laanwj Is there a reason to keep them open once they've had a req rejected?\n",
      "commit_id" : "a264c32e3321ae909ca59cb8ce8bf5d812dbc4e1",
      "created_at" : "2015-11-12T04:14:29Z",
      "diff_hunk" : "@@ -480,6 +475,14 @@ void StopHTTPServer()\n         workQueue->WaitExit();\n         delete workQueue;\n     }\n+    if (eventBase) {\n+        LogPrint(\"http\", \"Waiting for HTTP event thread to exit\\n\");\n+        // Give event loop a few seconds to exit (to send back last RPC responses), then break it\n+        if (!threadHTTP.try_join_for(boost::chrono::milliseconds(2000))) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6990#discussion_r44620210",
      "id" : 44620210,
      "line" : 486,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjIwMjEw",
      "original_commit_id" : "856be4fe46bfc4194afc10f424a03a5fb09af76a",
      "original_line" : null,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6990",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44620210/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2015-11-13T10:10:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44620210",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "node_id" : "MDQ6VXNlcjQxNzA0Mw==",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6990#discussion_r44625420"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6990"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44625420"
         }
      },
      "author_association" : "MEMBER",
      "body" : "- Waiting for all events to finish could take forever. There's tons of ways that someone could keep a connection option by slowly sending data. Also, timing events (such as the `walletpassphrase` timeout) may hold up the event queue.\n- Just breaking off everything in progress immediately prevents the answer to `stop` from getting back. We could just declare this a feature of course and be done with it... But it was a race condition, sometimes you would get a reply, sometimes not. We could define `stop` to cease all RPC activity immediately. But I think I like this better.\n- There AFAIK is no way to ask libevent, nor libevent_http if the events in the queue are important enough to wait for or not. And specially tagging the connection that sends 'stop' is quite ugly, not sure if even possible without diving into internal data structures.\n\nFor context read #6719.\n\nI'm not 100% happy with this solution either, but I wasn't able to find another way to do it, and it's better than the previous one.\n\n@cfields sure, you can close the connection afterwards there, but that doesn't solve this issue. \n",
      "commit_id" : "a264c32e3321ae909ca59cb8ce8bf5d812dbc4e1",
      "created_at" : "2015-11-12T06:34:22Z",
      "diff_hunk" : "@@ -480,6 +475,14 @@ void StopHTTPServer()\n         workQueue->WaitExit();\n         delete workQueue;\n     }\n+    if (eventBase) {\n+        LogPrint(\"http\", \"Waiting for HTTP event thread to exit\\n\");\n+        // Give event loop a few seconds to exit (to send back last RPC responses), then break it\n+        if (!threadHTTP.try_join_for(boost::chrono::milliseconds(2000))) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6990#discussion_r44625420",
      "id" : 44625420,
      "line" : 486,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI1NDIw",
      "original_commit_id" : "856be4fe46bfc4194afc10f424a03a5fb09af76a",
      "original_line" : null,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6990",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44625420/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2015-11-13T10:10:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44625420",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/6990#discussion_r44625742"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6990"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44625742"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> @MarcoFalke but this doesn't stop new connections (or is that done elsewhere?) in that waiting time.  So conceptually, the status quo could be the same?\n\nIt does:\n\n```\n        // Unlisten sockets\n        BOOST_FOREACH (evhttp_bound_socket *socket, boundSockets) {\n            evhttp_del_accept_socket(eventHTTP, socket);\n        }\n        // Reject requests on current connections\n        evhttp_set_gencb(eventHTTP, http_reject_request_cb, NULL);\n```\n\nThis closes the port and makes new requests error (so that no new work items are created). But that's best-effort. Current connections could still do e.g. a slowloris attack. The two seconds are a belt and suspenders, nothing more.\n",
      "commit_id" : "a264c32e3321ae909ca59cb8ce8bf5d812dbc4e1",
      "created_at" : "2015-11-12T06:42:49Z",
      "diff_hunk" : "@@ -480,6 +475,14 @@ void StopHTTPServer()\n         workQueue->WaitExit();\n         delete workQueue;\n     }\n+    if (eventBase) {\n+        LogPrint(\"http\", \"Waiting for HTTP event thread to exit\\n\");\n+        // Give event loop a few seconds to exit (to send back last RPC responses), then break it\n+        if (!threadHTTP.try_join_for(boost::chrono::milliseconds(2000))) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6990#discussion_r44625742",
      "id" : 44625742,
      "line" : 486,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI1NzQy",
      "original_commit_id" : "856be4fe46bfc4194afc10f424a03a5fb09af76a",
      "original_line" : null,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/httpserver.cpp",
      "position" : null,
      "pull_request_review_id" : null,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/6990",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44625742/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2015-11-13T10:10:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/44625742",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "utACK.\n",
      "created_at" : "2015-11-12T07:46:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6990#issuecomment-156026958",
      "id" : 156026958,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6990",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDE1NjAyNjk1OA==",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/156026958/reactions"
      },
      "updated_at" : "2015-11-12T07:46:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/156026958",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "node_id" : "MDQ6VXNlcjE3ODQ2NA==",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Some more information: it _appears_ that with `libevent` master, this issue doesn't exist.\n`event_base_loopexit` does actually do what I expect it to in the OP. As that is the version I'm normally using, that is why I didn't notice before.\n\nEdit: so I think we should still do this for backward compat, but at least I'm not crazy :)\n",
      "created_at" : "2015-11-12T08:48:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6990#issuecomment-156035713",
      "id" : 156035713,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6990",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDE1NjAzNTcxMw==",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/156035713/reactions"
      },
      "updated_at" : "2015-11-12T08:48:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/156035713",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@laanwj maybe just inline a comment to mention this _might_ be fixed in latest version of libevent?  Could be useful for some future refactoring,  save someone trying to establish whether there was a reason we moved away from it that they aren't aware of.\n",
      "created_at" : "2015-11-13T01:00:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6990#issuecomment-156285416",
      "id" : 156285416,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6990",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDE1NjI4NTQxNg==",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/156285416/reactions"
      },
      "updated_at" : "2015-11-13T01:01:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/156285416",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=4",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "node_id" : "MDQ6VXNlcjQxMzM5NQ==",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Will do\n\nEdit: OK, added comment and updated commit message.\n",
      "created_at" : "2015-11-13T09:14:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6990#issuecomment-156371163",
      "id" : 156371163,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6990",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDE1NjM3MTE2Mw==",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/156371163/reactions"
      },
      "updated_at" : "2015-11-13T09:26:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/156371163",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Huh! I pushed this branch to bitcoin/bitcoin instead of my own repository. Oh well, no harm done, I'll just remove it again when it's merged.\n",
      "created_at" : "2015-11-13T09:14:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6990#issuecomment-156371536",
      "id" : 156371536,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6990",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDE1NjM3MTUzNg==",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/156371536/reactions"
      },
      "updated_at" : "2015-11-13T09:14:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/156371536",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "~~@theuni can you take a look here as well?~~\nEdit: nm, you already did, but didn't ack\n",
      "created_at" : "2015-11-13T11:24:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6990#issuecomment-156402295",
      "id" : 156402295,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6990",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDE1NjQwMjI5NQ==",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/156402295/reactions"
      },
      "updated_at" : "2015-11-13T11:25:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/156402295",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK.\n",
      "created_at" : "2015-11-13T19:32:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6990#issuecomment-156535903",
      "id" : 156535903,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6990",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDE1NjUzNTkwMw==",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/156535903/reactions"
      },
      "updated_at" : "2015-11-13T19:32:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/156535903",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Awesome, thanks @laanwj :)\n",
      "created_at" : "2015-11-14T08:51:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6990#issuecomment-156671746",
      "id" : 156671746,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6990",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDE1NjY3MTc0Ng==",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/156671746/reactions"
      },
      "updated_at" : "2015-11-14T08:51:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/156671746",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/413395?v=4",
         "events_url" : "https://api.github.com/users/dcousens/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dcousens/followers",
         "following_url" : "https://api.github.com/users/dcousens/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dcousens/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dcousens",
         "id" : 413395,
         "login" : "dcousens",
         "node_id" : "MDQ6VXNlcjQxMzM5NQ==",
         "organizations_url" : "https://api.github.com/users/dcousens/orgs",
         "received_events_url" : "https://api.github.com/users/dcousens/received_events",
         "repos_url" : "https://api.github.com/users/dcousens/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dcousens/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dcousens/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dcousens"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Post merge tested ACK!\n\n@laanwj this makes travis a lot faster. (runtime reduced for some rpc tests by 90%)\n\nBefore:\n\n```\n$ time for i in {1..10};do qa/pull-tester/rpc-tests.py disablewallet;done\nreal    1m53.003s\nuser    0m1.135s\nsys 0m0.437s\n\n$ time for i in {1..10};do qa/pull-tester/rpc-tests.py wallet;done\nreal    10m4.888s\nuser    0m21.829s\nsys 0m8.239s\n```\n\nAfter:\n\n```\ndisablewallet:\nreal    0m13.809s\nuser    0m1.166s\nsys 0m0.510s\n\nwallet:\nreal    5m7.703s\nuser    0m22.128s\nsys 0m8.222s\n```\n",
      "created_at" : "2015-11-15T13:05:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/6990#issuecomment-156810422",
      "id" : 156810422,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/6990",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDE1NjgxMDQyMg==",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/156810422/reactions"
      },
      "updated_at" : "2015-11-15T13:05:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/156810422",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
