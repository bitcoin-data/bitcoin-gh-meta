{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "## Problem\r\nIn #18037 I introduced code to mock the scheduler from functional tests. I added a `scheduler#MockForward` method & associated `scheduler_tests#mockforward` unit test. The unit test caused sporadic failures on one of the Travis machines & failures on Bitcoin builds.\r\n\r\nAfter a couple attempts at small fixes [[1]](https://github.com/bitcoin/bitcoin/pull/18174) [[2]](https://github.com/bitcoin/bitcoin/pull/18188), we decided to [disable the test](https://github.com/bitcoin/bitcoin/pull/18211) as we investigate the underlying issue. \r\n\r\n## Failures\r\nSome examples of failing builds \r\n\r\nTravis: [[1]](https://travis-ci.org/bitcoin/bitcoin/jobs/649620800) [[2]](https://travis-ci.org/bitcoin/bitcoin/jobs/651788952)\r\nNote that it is always the travis machine with `x86_64 Linux [GOAL: install] [bionic] [no wallet]`\r\n\r\nBitcoin Builds: [[1]](https://bitcoinbuilds.org/index.php?job=5c006a9e-b8e6-4932-a6a8-3ead3d1fc188) [[2]](https://bitcoinbuilds.org/index.php?job=c1d3a0f5-7d47-40e6-9c9b-cac397c5ff30) [[3]](https://bitcoinbuilds.org/?job=7e61f7cd-ad26-4416-9f04-4e0101e1e8fc)\r\n\r\nThe test always fails in the same way: \r\n```\r\nterminate called after throwing an instance of 'boost::wrapexcept<boost::condition_error>'\r\n  what():  boost::condition_variable::do_wait_until failed in pthread_cond_timedwait: Invalid argument\r\nunknown location(0): fatal error: in \"scheduler_tests/mockforward\": signal: SIGABRT (application abort requested)\r\n```\r\n\r\n## Reproducing the issue \r\nOne of the issues that makes this really difficult to debug is the failure is hard to reproduce. I have not been able to reproduce it myself. In this section, I'm compiling the information from others that were able to reproduce.\r\n\r\n* @jonasschnelli found that enabling ccache meant consistent failure, and clearing ccache meant consistent success. [[1]](https://github.com/bitcoin/bitcoin/pull/18037#issuecomment-588371299) [[2]](https://github.com/bitcoin/bitcoin/pull/18174#issuecomment-588363133) \r\n\r\n* @MarcoFalke was able to reproduce on a single CPU instance, but unable to extract much debugging information. [[1]](https://github.com/bitcoin/bitcoin/pull/18174#issuecomment-588554950).\r\n\r\n## Relevant debugging information \r\nThe `boost:condition_variable` triggers the `SIGABRT` as a result of the `pthread_cond_timedwait` returning an `Invalid argument`, or `EINVAL` error. According to the docs [[1]](https://pubs.opengroup.org/onlinepubs/009695399/functions/pthread_cond_timedwait.html) & [[2]](https://linux.die.net/man/3/pthread_cond_timedwait), this indicates that either `The value specified by cond, mutex, or abstime is invalid` or `Different mutexes were supplied for concurrent pthread_cond_timedwait() or pthread_cond_wait() operations on the same condition variable.` \r\n\r\n## Next steps \r\nThis bug doesn't seem urgent, but should be investigated and resolved. I'm opening this issue to track any relevant comments or findings. \r\n\r\nThank you to everyone who has jumped in to take a look & thanks in advance to anybody willing to help continue the investigation ðð½",
   "closed_at" : "2020-03-06T19:52:53Z",
   "closed_by" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   },
   "comments" : 7,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18227/comments",
   "created_at" : "2020-02-28T20:36:59Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18227/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/18227",
   "id" : 572991496,
   "labels" : [
      {
         "color" : "FBBAAB",
         "default" : false,
         "description" : null,
         "id" : 64585,
         "name" : "Bug",
         "node_id" : "MDU6TGFiZWw2NDU4NQ==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug"
      },
      {
         "color" : "d4c5f9",
         "default" : false,
         "description" : null,
         "id" : 62963516,
         "name" : "Tests",
         "node_id" : "MDU6TGFiZWw2Mjk2MzUxNg==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Tests"
      },
      {
         "color" : "bfd4f2",
         "default" : false,
         "description" : null,
         "id" : 159815356,
         "name" : "Upstream",
         "node_id" : "MDU6TGFiZWwxNTk4MTUzNTY=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Upstream"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18227/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWU1NzI5OTE0OTY=",
   "number" : 18227,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "scheduler test causing pthread_cond_timedwait: Invalid argument error  ",
   "updated_at" : "2020-03-06T19:52:53Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18227",
   "user" : {
      "avatar_url" : "https://avatars3.githubusercontent.com/u/1500952?v=4",
      "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
      "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
      "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
      "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/amitiuttarwar",
      "id" : 1500952,
      "login" : "amitiuttarwar",
      "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
      "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
      "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
      "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/amitiuttarwar"
   }
}
