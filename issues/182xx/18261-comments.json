[
   {
      "author_association" : "MEMBER",
      "body" : "How does it react to diverse network policies?",
      "created_at" : "2020-03-04T20:04:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-594803706",
      "id" : 594803706,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NDgwMzcwNg==",
      "updated_at" : "2020-03-04T20:04:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/594803706",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-03-04T20:13:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-594810354",
      "id" : 594810354,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NDgxMDM1NA==",
      "updated_at" : "2020-03-04T20:13:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/594810354",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5470?v=4",
         "events_url" : "https://api.github.com/users/Empact/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Empact/followers",
         "following_url" : "https://api.github.com/users/Empact/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Empact/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Empact",
         "id" : 5470,
         "login" : "Empact",
         "node_id" : "MDQ6VXNlcjU0NzA=",
         "organizations_url" : "https://api.github.com/users/Empact/orgs",
         "received_events_url" : "https://api.github.com/users/Empact/received_events",
         "repos_url" : "https://api.github.com/users/Empact/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Empact/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Empact/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Empact"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
      "created_at" : "2020-03-04T20:40:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-594823883",
      "id" : 594823883,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NDgyMzg4Mw==",
      "updated_at" : "2020-03-04T20:40:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/594823883",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r387925726"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/387925726"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm afraid `std::to_string` is locale dependent.\r\n\r\n---\r\n\r\nFor those interested in permanently killing the locale dependency bug class, consider reviewing:\r\n* #18124 â init: Clarify C and C++ locale assumptions. Add locale sanity checks to verify assumptions at run-time\r\n* #18126 â tests: Add fuzzing harness testing the locale independence of the `strencodings.h` functions\r\n* #18147 â qt: Kill the locale dependency bug class by not allowing Qt to mess with `LC_NUMERIC`\r\n",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-03-04T20:49:13Z",
      "diff_hunk" : "@@ -3258,6 +3403,331 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n         return true;\n     }\n \n+    // Received from an inbound peer planning to reconcilie transactions with us, or\n+    // from an outgoing peer demonstrating readiness to do reconciliations.\n+    // If received from outgoing, adds the peer to the reconciliation queue.\n+    if (strCommand == NetMsgType::SENDRECON) {\n+        if (!pfrom->m_tx_relay) return true;\n+        if(pfrom->m_recon_state != nullptr) return true; // Do not support reconciliation salt/version updates.\n+\n+        bool recon_sender, recon_responder;\n+        uint64_t remote_salt;\n+        uint32_t recon_version;\n+        vRecv >> recon_sender >> recon_responder >> recon_version >> remote_salt;\n+        if (recon_version != 1) return true;\n+\n+        // According to current erlay spec.\n+        if (recon_sender == recon_responder) return true;\n+\n+        if (pfrom->fInbound) {\n+            if (!recon_sender) return true;\n+            // Do not flood through inbound connections which support reconciliation to save bandwidth.\n+            pfrom->m_flood_to = false;\n+        } else {\n+            if (!recon_responder) return true;\n+            uint64_t outbound_flooding = connman->GetOutboundCountByTxRelayType(true);\n+            if (outbound_flooding > MAX_OUTBOUND_FLOOD_TO)\n+                pfrom->m_flood_to = false;\n+        }\n+\n+        pfrom->m_recon_state = MakeUnique<CNode::ReconState>();\n+        pfrom->m_recon_state->sender = recon_sender;\n+        pfrom->m_recon_state->responder = recon_responder;\n+        pfrom->m_recon_state->local_q = DEFAULT_RECON_Q;\n+\n+        uint64_t local_salt = connman->m_local_recon_salt;\n+\n+        std::string salt1, salt2;\n+        if (remote_salt < local_salt) {\n+            salt1 = std::to_string(remote_salt);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r387925726",
      "id" : 387925726,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkyNTcyNg==",
      "original_commit_id" : "b93eb384cdaeaceaab89f855753bae6231a8ce77",
      "original_line" : 3440,
      "original_position" : 529,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 369111380,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/387925726",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@luke-jr \r\n\r\nWhen it comes to network policies, I'm using the same code originally used by regular gossip (\"Determine transactions to relay\" in net_processing.cpp). So nothing should be lost or sent wastefully as a result of policy discrepancies.",
      "created_at" : "2020-03-07T19:23:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-596129273",
      "id" : 596129273,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NjEyOTI3Mw==",
      "updated_at" : "2020-03-07T19:23:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/596129273",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@luke-jr  I'm understanding your question as being inspired by earlier 'mempool sync' ideas that would bleed bandwidth if there was a long lasting mempool discrepancy.\r\n\r\nErlay isn't a mempool sync. It's uses a way of communicating lists of things you want to relay which only takes bandwidth proportional to the difference rather than the total size.  So there is no on-going bandwidth usage due to differences in *mempool* content. Bandwidth is used is roughly  A*ntx_relayed + B*peers*(difference_in_tx_relayed) + C*peers.  for some constants A,B,C. \r\n\r\nIf a peer has a radically different relay policy than you, it works fine and continues to save bandwidth below what usage would be without erlay even though the erlay savings itself comes largely from eliminating data that both sides would send.\r\n\r\nDoes that answer your question?",
      "created_at" : "2020-03-08T22:57:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-596262994",
      "id" : 596262994,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NjI2Mjk5NA==",
      "updated_at" : "2020-03-08T22:57:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/596262994",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@naumenkogs When trying out this PR I ran in to two small testing issues:\r\n\r\n* The suffix of the functional test `p2p_erlay` is `.p2p` (`p2p_erlay.p2p`) instead of the expected `.py` (`p2p_erlay.py`) :)\r\n* It seems like `make check` runs the `minisketch` binaries `test-exhaust` and `test-exhaust-verify`. The running times of these are quite substantial - is there some way to do a quick sanity check as part of `make check` instead of exhaustive testing? :)\r\n",
      "created_at" : "2020-03-09T19:57:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-596749292",
      "id" : 596749292,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5Njc0OTI5Mg==",
      "updated_at" : "2020-03-09T20:03:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/596749292",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@practicalswift The unit test minisketch binaries actually run forever. I need to fix that.",
      "created_at" : "2020-03-09T20:48:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-596771889",
      "id" : 596771889,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5Njc3MTg4OQ==",
      "updated_at" : "2020-03-09T20:48:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/596771889",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@naumenkogs \r\n\r\nI did some robustness testing of this code by pulling in PRs #17989 (`ProcessMessage(â¦)` fuzzer). and #18288 (MemorySanitizer) and found an use of uninitialized memory (UUM) that is remotely triggerable.\r\n\r\nYou can reproduce the issue by pulling in the commits from those PR:s and simply run:\r\n\r\n```\r\n$ src/test/fuzz/process_message\r\nâ¦\r\n```\r\n\r\nThe issue will be hit within a few seconds: `libFuzzer` is amazing :)\r\n\r\nNotice also how `libFuzzer` will automatically find the newly added message names (`wtxidrelay`, `sendrecon`, `reqrecon`, `sketch`, `reqbisec` and `reconcildiff`) and probe using them all! The fuzzer harness does not need to be teached about the existence of those :)\r\n\r\nPerhaps this UUM is the reason of the intermittent test failure you're seeing?\r\n\r\nI encourage everybody to review (or at least Concept ACK :)) #17989 (`ProcessMessage(â¦)` fuzzer). and #18288 (MemorySanitizer): having them merged would be great for robustness/security.",
      "created_at" : "2020-03-09T22:10:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-596803815",
      "id" : 596803815,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NjgwMzgxNQ==",
      "updated_at" : "2020-03-09T22:10:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/596803815",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Needs rebase :)",
      "created_at" : "2020-03-11T16:45:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-597743053",
      "id" : 597743053,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5Nzc0MzA1Mw==",
      "updated_at" : "2020-03-11T16:45:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/597743053",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I made some latest changes to make sure it can be plugged into a real network.\r\nPlease help with testing this by running a couple inter-connected Erlay nodes, and observing bandwidth (and ideally tx relay latency).\r\n\r\n@practicalswift I was planning to rebase once #18044 is merged.",
      "created_at" : "2020-03-11T19:26:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-597823928",
      "id" : 597823928,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5NzgyMzkyOA==",
      "updated_at" : "2020-03-11T19:26:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/597823928",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I ran 2 non-reachable nodes for around 24 hours, one is regular [wtxid-node](https://github.com/bitcoin/bitcoin/pull/18044) connected to legacy nodes, one is Erlay node connected to reconciliation-supporting nodes on the same host.\r\n\r\nBandwidth breakdown (in megabytes):\r\n\r\n|  | Legacy (sent) | Erlay (sent) | Legacy (received) | Erlay (received) |\r\n|----------------------------------|---------------|--------------|-------------------|------------------|\r\n| inv | 38 | 0.4 | 22 | 5.3 |\r\n| getdata | 6 | 5.7 | 1 | 0 |\r\n| sketch | - | - | - | 1.2 |\r\n| reqrecon, reqbisec, reconcildiff | - | 0.7 | - | - |\r\n| tx, blocktxn | 3 | 0.3 | 75 | 75 |\r\n| total (incl. other) | 48 |  7.1 | 103 | 84 |\r\n\r\nNotice overall 40% bandwidth saving.\r\nPlease help by running similar experiments and sharing bandwidth results :)\r\nHere's the [script](https://gist.github.com/naumenkogs/9bee7178dbe582e47d8db16f1019ddee) I hacked together for bandwidth analysis (run nodes with debug=1)\r\nPlease sanitize your results before publishing: sometimes there's noisy bandwidth like extra blocks due to some reasons I'm not aware of. ",
      "created_at" : "2020-03-15T17:41:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-599241490",
      "id" : 599241490,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDU5OTI0MTQ5MA==",
      "updated_at" : "2020-03-18T02:07:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/599241490",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "More experiments: now I ran the same 2 nodes for 24 hours, but connected to 16 instead of 8 nodes (yeah, all 16 peers of Erlay node support reconciliation).\r\n\r\nLegacy wtxid-relay node spent 150 megabytes for announcements, while Erlay node spent 24 megabytes. Since these 2 days might have had different activity, it makes sense to compare the growth.. Legacy grew 2.23x (I guess due to more INVs in total), Erlay grew 1.8x. So, as expected, not only it's decent savings comparing to legacy, it also grows slower with connectivity.\r\n\r\nBased on the following facts I also make a guess that there's no point in tweaking Erlay forward for better performance:\r\n- only 0.0016 reconciliation failed (fully or partially) âÂ meaning we don't underestimate much\r\n- only 15% of the announcement bandwidth is sketches âÂ meaning we don't overestimate much\r\n- only 15% of the announcement bandwidth is *outbound* invs (which are much more likely to still be a little wasteful, because those peers are better connected than us and likely don't need those announemens)\r\n\r\nFinally, I measured delay in receiving transactions. I take the earliest time I received a transaction, and take latency from there, comparing to:\r\n- an average receiving time at all legacy nodes: 0.92s \r\n- at the Erlay node: 1.47s\r\n\r\nI think this is expected and fine, as we talk in the paper, but let me know if you think differently.",
      "created_at" : "2020-03-18T02:12:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-600388543",
      "id" : 600388543,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwMDM4ODU0Mw==",
      "updated_at" : "2020-03-18T02:39:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/600388543",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21148 (Split orphan handling from net_processing into txorphanage by ajtowns)\n* #21015 (Make all of net_processing (and some of net) use std::chrono types by dhruv)\n* #20892 (tests: Run both descriptor and legacy tests within a single test invocation by achow101)\n* #20758 (net-processing refactoring -- lose globals, move implementation details from .h to .cpp by ajtowns)\n* #20726 (p2p: Add DISABLETX message for negotiating block-relay-only connections by sdaftuar)\n* #20721 (Net: Move ping data to net_processing by jnewbery)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-03-20T01:01:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-601483568",
      "id" : 601483568,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwMTQ4MzU2OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-16T11:41:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/601483568",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-03-30T20:31:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-606232360",
      "id" : 606232360,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYwNjIzMjM2MA==",
      "updated_at" : "2020-03-30T20:31:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/606232360",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@mzumsande thank you for taking a look! I'll do my best to find the cause.\r\n\r\nSome external eyes looking at the code would definitely help to both confirm the approach and troubleshoot issues like this :)",
      "created_at" : "2020-04-19T21:42:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-616229738",
      "id" : 616229738,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNjIyOTczOA==",
      "updated_at" : "2020-04-19T21:42:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/616229738",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r412301986"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/412301986"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think that this is UB (if no wtxid for a shortid is found, there is a LogPrint, but the item is still dereferenced).\r\nWhile this should explain the strange wtxids with lots of 0s, it doesn't explain the why no mapping is found to begin with.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-04-21T16:19:22Z",
      "diff_hunk" : "@@ -628,6 +628,135 @@ int CNode::GetSendVersion() const\n     return nSendVersion;\n }\n \n+void CNode::FinalizeReconciliation(bool clear_local_set, LocalQAction action, uint8_t actual_local_missing, uint8_t actual_remote_missing)\n+{\n+    // According to the erlay spec, reconciliation is initiated by inbound peers.\n+    if (m_recon_state->sender) {\n+        assert(m_recon_state->incoming_recon != CNode::ReconPhase::NONE);\n+        m_recon_state->incoming_recon = CNode::ReconPhase::NONE;\n+    } else {\n+        // When reconciliation initialized by us is done, update local q for future reconciliations.\n+        if (action == LocalQAction::Q_RECOMPUTE) {\n+            assert(m_recon_state->outgoing_recon != CNode::ReconPhase::NONE);\n+            uint8_t local_set_size;\n+            if (m_recon_state->outgoing_recon == CNode::ReconPhase::BISEC_REQUESTED) {\n+                local_set_size = m_recon_state->local_set_snapshot.size();\n+            } else {\n+                local_set_size = m_recon_state->local_set.size();\n+            }\n+            uint8_t remote_set_size = local_set_size + actual_local_missing - actual_remote_missing;\n+            uint8_t set_size_diff = std::abs(local_set_size - remote_set_size);\n+            uint8_t min_size = std::min(local_set_size, remote_set_size);\n+            uint8_t actual_difference = actual_local_missing + actual_remote_missing;\n+            if (min_size != 0)\n+                m_recon_state->local_q = double(actual_difference - set_size_diff) / min_size;\n+        } else if (action == LocalQAction::Q_INCREASE) {\n+            m_recon_state->local_q *= 1.1;\n+        } else if (action == LocalQAction::Q_SET_DEFAULT) {\n+            m_recon_state->local_q = DEFAULT_RECON_Q;\n+        }\n+        m_recon_state->outgoing_recon = CNode::ReconPhase::NONE;\n+    }\n+    if (clear_local_set) m_recon_state->local_set.clear();\n+\n+    m_recon_state->local_short_id_mapping.clear();\n+    // This is currently belt-and-suspenders, as the code should work even without these calls.\n+    m_recon_state->local_set_snapshot.clear();\n+    m_recon_state->capacity_snapshot = 0;\n+    m_recon_state->remote_sketch_snapshot = nullptr;\n+    m_recon_state->local_sketch_snapshot = nullptr;\n+}\n+\n+uint32_t CNode::ComputeShortID(uint256 wtxid)\n+{\n+    uint64_t k0 = m_recon_state->salt.GetUint64(0);\n+    uint64_t k1 = m_recon_state->salt.GetUint64(1);\n+    uint64_t s = SipHashUint256(k0, k1, wtxid);\n+    uint32_t short_txid = 1 + (s & 0xFFFFFFFF);\n+    m_recon_state->local_short_id_mapping.insert(std::pair<uint32_t, uint256>(short_txid, wtxid));\n+    return short_txid;\n+}\n+\n+minisketch* CNode::ComputeSketch(bool use_own_q, BisectionChunk bisection_chunk, uint16_t capacity)\n+{\n+    std::vector<uint32_t> short_ids;\n+    if (m_recon_state->incoming_recon == ReconPhase::BISEC_REQUESTED || m_recon_state->outgoing_recon == ReconPhase::BISEC_REQUESTED) {\n+        // During bisection, all the relevant transactions are stored in the snapshot.\n+        // Original set is used to not miss transactions received during the reconciliation elsewhere.\n+        if (m_recon_state->local_set_snapshot.size() == 0) {\n+            return nullptr;\n+        }\n+        for (uint256 wtxid : m_recon_state->local_set_snapshot) {\n+            short_ids.push_back(ComputeShortID(wtxid));\n+        }\n+\n+        std::vector<uint32_t> bisec_short_ids;\n+        for (uint32_t short_id : short_ids) {\n+            if (bisection_chunk == BISECTION_LOW) {\n+                if (short_id <= BISECTION_MEDIAN) {\n+                    bisec_short_ids.push_back(short_id);\n+                }\n+            } else {\n+                if (short_id > BISECTION_MEDIAN) {\n+                    bisec_short_ids.push_back(short_id);\n+                }\n+            }\n+        }\n+        short_ids = bisec_short_ids;\n+        // For bisection, use capacity used in the initial reconciliation.\n+        capacity = m_recon_state->capacity_snapshot;\n+    } else {\n+        for (uint256 wtxid : m_recon_state->local_set) {\n+            short_ids.push_back(ComputeShortID(wtxid));\n+        }\n+\n+        if (capacity == 0) {\n+            // Estimate locally, as requested by the calling function.\n+            int set_size_diff = m_recon_state->local_set.size() - m_recon_state->remote_set_size;\n+            double q = use_own_q ? m_recon_state->local_q : m_recon_state->remote_q;\n+            capacity = 1 + q * fmin(m_recon_state->local_set.size(), m_recon_state->remote_set_size) +\n+                       abs(set_size_diff);\n+        }\n+        capacity = std::min(capacity, MAX_SKETCH_CAPACITY);\n+        // If bisection is required, we will use this capacity from the initial reconciliation.\n+        m_recon_state->capacity_snapshot = capacity;\n+    }\n+    if (short_ids.size() == 0) return nullptr;\n+    minisketch* sketch = minisketch_create(RECON_FIELD_SIZE, 0, capacity);\n+    for (uint32_t short_id : short_ids) {\n+        minisketch_add_uint64(sketch, short_id);\n+    }\n+    return sketch;\n+}\n+\n+std::vector<uint256> CNode::GetRelevantIDsFromShortIDs(uint64_t diff[], uint8_t diff_size, std::vector<uint32_t>& local_missing, CConnman* connman)\n+{\n+    std::vector<uint256> remote_missing;\n+    for (int i = 0; i < diff_size; ++i) {\n+        auto local_tx = m_recon_state->local_short_id_mapping.find(diff[i]);\n+        if (local_tx != m_recon_state->local_short_id_mapping.end()) {\n+            remote_missing.push_back(local_tx->second);\n+        } else {\n+            local_missing.push_back(diff[i]);\n+        }\n+    }\n+    return remote_missing;\n+}\n+\n+std::vector<uint256> CNode::GetWTXIDsFromShortIDs(const std::vector<uint32_t> remote_missing_short_ids, CConnman* connman)\n+{\n+    std::vector<uint256> remote_missing;\n+    for (size_t i = 0; i < remote_missing_short_ids.size(); ++i) {\n+        auto local_tx = m_recon_state->local_short_id_mapping.find(remote_missing_short_ids[i]);\n+        if (local_tx == m_recon_state->local_short_id_mapping.end()) {\n+            LogPrint(BCLog::NET, \"Unknown transaction requested by short id=%d by peer=%d\\n\", remote_missing_short_ids[i], GetId());\n+        }\n+        remote_missing.push_back(local_tx->second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r412301986",
      "id" : 412301986,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMwMTk4Ng==",
      "original_commit_id" : "1b695eabc2083384596e146ff3da5846be3058e0",
      "original_line" : 760,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 397465590,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/412301986",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r412342381"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/412342381"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I found an issue, will commit the fix later today!\r\nBasically, sometimes reconcil. difference finding gives a false positive: it looks like a success, but some difference elements are missing.\r\nThis is just a natural property of math in minisketch. I'll submit a workaround.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-04-21T17:17:13Z",
      "diff_hunk" : "@@ -628,6 +628,135 @@ int CNode::GetSendVersion() const\n     return nSendVersion;\n }\n \n+void CNode::FinalizeReconciliation(bool clear_local_set, LocalQAction action, uint8_t actual_local_missing, uint8_t actual_remote_missing)\n+{\n+    // According to the erlay spec, reconciliation is initiated by inbound peers.\n+    if (m_recon_state->sender) {\n+        assert(m_recon_state->incoming_recon != CNode::ReconPhase::NONE);\n+        m_recon_state->incoming_recon = CNode::ReconPhase::NONE;\n+    } else {\n+        // When reconciliation initialized by us is done, update local q for future reconciliations.\n+        if (action == LocalQAction::Q_RECOMPUTE) {\n+            assert(m_recon_state->outgoing_recon != CNode::ReconPhase::NONE);\n+            uint8_t local_set_size;\n+            if (m_recon_state->outgoing_recon == CNode::ReconPhase::BISEC_REQUESTED) {\n+                local_set_size = m_recon_state->local_set_snapshot.size();\n+            } else {\n+                local_set_size = m_recon_state->local_set.size();\n+            }\n+            uint8_t remote_set_size = local_set_size + actual_local_missing - actual_remote_missing;\n+            uint8_t set_size_diff = std::abs(local_set_size - remote_set_size);\n+            uint8_t min_size = std::min(local_set_size, remote_set_size);\n+            uint8_t actual_difference = actual_local_missing + actual_remote_missing;\n+            if (min_size != 0)\n+                m_recon_state->local_q = double(actual_difference - set_size_diff) / min_size;\n+        } else if (action == LocalQAction::Q_INCREASE) {\n+            m_recon_state->local_q *= 1.1;\n+        } else if (action == LocalQAction::Q_SET_DEFAULT) {\n+            m_recon_state->local_q = DEFAULT_RECON_Q;\n+        }\n+        m_recon_state->outgoing_recon = CNode::ReconPhase::NONE;\n+    }\n+    if (clear_local_set) m_recon_state->local_set.clear();\n+\n+    m_recon_state->local_short_id_mapping.clear();\n+    // This is currently belt-and-suspenders, as the code should work even without these calls.\n+    m_recon_state->local_set_snapshot.clear();\n+    m_recon_state->capacity_snapshot = 0;\n+    m_recon_state->remote_sketch_snapshot = nullptr;\n+    m_recon_state->local_sketch_snapshot = nullptr;\n+}\n+\n+uint32_t CNode::ComputeShortID(uint256 wtxid)\n+{\n+    uint64_t k0 = m_recon_state->salt.GetUint64(0);\n+    uint64_t k1 = m_recon_state->salt.GetUint64(1);\n+    uint64_t s = SipHashUint256(k0, k1, wtxid);\n+    uint32_t short_txid = 1 + (s & 0xFFFFFFFF);\n+    m_recon_state->local_short_id_mapping.insert(std::pair<uint32_t, uint256>(short_txid, wtxid));\n+    return short_txid;\n+}\n+\n+minisketch* CNode::ComputeSketch(bool use_own_q, BisectionChunk bisection_chunk, uint16_t capacity)\n+{\n+    std::vector<uint32_t> short_ids;\n+    if (m_recon_state->incoming_recon == ReconPhase::BISEC_REQUESTED || m_recon_state->outgoing_recon == ReconPhase::BISEC_REQUESTED) {\n+        // During bisection, all the relevant transactions are stored in the snapshot.\n+        // Original set is used to not miss transactions received during the reconciliation elsewhere.\n+        if (m_recon_state->local_set_snapshot.size() == 0) {\n+            return nullptr;\n+        }\n+        for (uint256 wtxid : m_recon_state->local_set_snapshot) {\n+            short_ids.push_back(ComputeShortID(wtxid));\n+        }\n+\n+        std::vector<uint32_t> bisec_short_ids;\n+        for (uint32_t short_id : short_ids) {\n+            if (bisection_chunk == BISECTION_LOW) {\n+                if (short_id <= BISECTION_MEDIAN) {\n+                    bisec_short_ids.push_back(short_id);\n+                }\n+            } else {\n+                if (short_id > BISECTION_MEDIAN) {\n+                    bisec_short_ids.push_back(short_id);\n+                }\n+            }\n+        }\n+        short_ids = bisec_short_ids;\n+        // For bisection, use capacity used in the initial reconciliation.\n+        capacity = m_recon_state->capacity_snapshot;\n+    } else {\n+        for (uint256 wtxid : m_recon_state->local_set) {\n+            short_ids.push_back(ComputeShortID(wtxid));\n+        }\n+\n+        if (capacity == 0) {\n+            // Estimate locally, as requested by the calling function.\n+            int set_size_diff = m_recon_state->local_set.size() - m_recon_state->remote_set_size;\n+            double q = use_own_q ? m_recon_state->local_q : m_recon_state->remote_q;\n+            capacity = 1 + q * fmin(m_recon_state->local_set.size(), m_recon_state->remote_set_size) +\n+                       abs(set_size_diff);\n+        }\n+        capacity = std::min(capacity, MAX_SKETCH_CAPACITY);\n+        // If bisection is required, we will use this capacity from the initial reconciliation.\n+        m_recon_state->capacity_snapshot = capacity;\n+    }\n+    if (short_ids.size() == 0) return nullptr;\n+    minisketch* sketch = minisketch_create(RECON_FIELD_SIZE, 0, capacity);\n+    for (uint32_t short_id : short_ids) {\n+        minisketch_add_uint64(sketch, short_id);\n+    }\n+    return sketch;\n+}\n+\n+std::vector<uint256> CNode::GetRelevantIDsFromShortIDs(uint64_t diff[], uint8_t diff_size, std::vector<uint32_t>& local_missing, CConnman* connman)\n+{\n+    std::vector<uint256> remote_missing;\n+    for (int i = 0; i < diff_size; ++i) {\n+        auto local_tx = m_recon_state->local_short_id_mapping.find(diff[i]);\n+        if (local_tx != m_recon_state->local_short_id_mapping.end()) {\n+            remote_missing.push_back(local_tx->second);\n+        } else {\n+            local_missing.push_back(diff[i]);\n+        }\n+    }\n+    return remote_missing;\n+}\n+\n+std::vector<uint256> CNode::GetWTXIDsFromShortIDs(const std::vector<uint32_t> remote_missing_short_ids, CConnman* connman)\n+{\n+    std::vector<uint256> remote_missing;\n+    for (size_t i = 0; i < remote_missing_short_ids.size(); ++i) {\n+        auto local_tx = m_recon_state->local_short_id_mapping.find(remote_missing_short_ids[i]);\n+        if (local_tx == m_recon_state->local_short_id_mapping.end()) {\n+            LogPrint(BCLog::NET, \"Unknown transaction requested by short id=%d by peer=%d\\n\", remote_missing_short_ids[i], GetId());\n+        }\n+        remote_missing.push_back(local_tx->second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r412342381",
      "id" : 412342381,
      "in_reply_to_id" : 412301986,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM0MjM4MQ==",
      "original_commit_id" : "1b695eabc2083384596e146ff3da5846be3058e0",
      "original_line" : 760,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 397511447,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/412342381",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r412382710"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/412382710"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Still not sure why it would be UB here? It just accesses the existing array element..",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-04-21T18:13:33Z",
      "diff_hunk" : "@@ -628,6 +628,135 @@ int CNode::GetSendVersion() const\n     return nSendVersion;\n }\n \n+void CNode::FinalizeReconciliation(bool clear_local_set, LocalQAction action, uint8_t actual_local_missing, uint8_t actual_remote_missing)\n+{\n+    // According to the erlay spec, reconciliation is initiated by inbound peers.\n+    if (m_recon_state->sender) {\n+        assert(m_recon_state->incoming_recon != CNode::ReconPhase::NONE);\n+        m_recon_state->incoming_recon = CNode::ReconPhase::NONE;\n+    } else {\n+        // When reconciliation initialized by us is done, update local q for future reconciliations.\n+        if (action == LocalQAction::Q_RECOMPUTE) {\n+            assert(m_recon_state->outgoing_recon != CNode::ReconPhase::NONE);\n+            uint8_t local_set_size;\n+            if (m_recon_state->outgoing_recon == CNode::ReconPhase::BISEC_REQUESTED) {\n+                local_set_size = m_recon_state->local_set_snapshot.size();\n+            } else {\n+                local_set_size = m_recon_state->local_set.size();\n+            }\n+            uint8_t remote_set_size = local_set_size + actual_local_missing - actual_remote_missing;\n+            uint8_t set_size_diff = std::abs(local_set_size - remote_set_size);\n+            uint8_t min_size = std::min(local_set_size, remote_set_size);\n+            uint8_t actual_difference = actual_local_missing + actual_remote_missing;\n+            if (min_size != 0)\n+                m_recon_state->local_q = double(actual_difference - set_size_diff) / min_size;\n+        } else if (action == LocalQAction::Q_INCREASE) {\n+            m_recon_state->local_q *= 1.1;\n+        } else if (action == LocalQAction::Q_SET_DEFAULT) {\n+            m_recon_state->local_q = DEFAULT_RECON_Q;\n+        }\n+        m_recon_state->outgoing_recon = CNode::ReconPhase::NONE;\n+    }\n+    if (clear_local_set) m_recon_state->local_set.clear();\n+\n+    m_recon_state->local_short_id_mapping.clear();\n+    // This is currently belt-and-suspenders, as the code should work even without these calls.\n+    m_recon_state->local_set_snapshot.clear();\n+    m_recon_state->capacity_snapshot = 0;\n+    m_recon_state->remote_sketch_snapshot = nullptr;\n+    m_recon_state->local_sketch_snapshot = nullptr;\n+}\n+\n+uint32_t CNode::ComputeShortID(uint256 wtxid)\n+{\n+    uint64_t k0 = m_recon_state->salt.GetUint64(0);\n+    uint64_t k1 = m_recon_state->salt.GetUint64(1);\n+    uint64_t s = SipHashUint256(k0, k1, wtxid);\n+    uint32_t short_txid = 1 + (s & 0xFFFFFFFF);\n+    m_recon_state->local_short_id_mapping.insert(std::pair<uint32_t, uint256>(short_txid, wtxid));\n+    return short_txid;\n+}\n+\n+minisketch* CNode::ComputeSketch(bool use_own_q, BisectionChunk bisection_chunk, uint16_t capacity)\n+{\n+    std::vector<uint32_t> short_ids;\n+    if (m_recon_state->incoming_recon == ReconPhase::BISEC_REQUESTED || m_recon_state->outgoing_recon == ReconPhase::BISEC_REQUESTED) {\n+        // During bisection, all the relevant transactions are stored in the snapshot.\n+        // Original set is used to not miss transactions received during the reconciliation elsewhere.\n+        if (m_recon_state->local_set_snapshot.size() == 0) {\n+            return nullptr;\n+        }\n+        for (uint256 wtxid : m_recon_state->local_set_snapshot) {\n+            short_ids.push_back(ComputeShortID(wtxid));\n+        }\n+\n+        std::vector<uint32_t> bisec_short_ids;\n+        for (uint32_t short_id : short_ids) {\n+            if (bisection_chunk == BISECTION_LOW) {\n+                if (short_id <= BISECTION_MEDIAN) {\n+                    bisec_short_ids.push_back(short_id);\n+                }\n+            } else {\n+                if (short_id > BISECTION_MEDIAN) {\n+                    bisec_short_ids.push_back(short_id);\n+                }\n+            }\n+        }\n+        short_ids = bisec_short_ids;\n+        // For bisection, use capacity used in the initial reconciliation.\n+        capacity = m_recon_state->capacity_snapshot;\n+    } else {\n+        for (uint256 wtxid : m_recon_state->local_set) {\n+            short_ids.push_back(ComputeShortID(wtxid));\n+        }\n+\n+        if (capacity == 0) {\n+            // Estimate locally, as requested by the calling function.\n+            int set_size_diff = m_recon_state->local_set.size() - m_recon_state->remote_set_size;\n+            double q = use_own_q ? m_recon_state->local_q : m_recon_state->remote_q;\n+            capacity = 1 + q * fmin(m_recon_state->local_set.size(), m_recon_state->remote_set_size) +\n+                       abs(set_size_diff);\n+        }\n+        capacity = std::min(capacity, MAX_SKETCH_CAPACITY);\n+        // If bisection is required, we will use this capacity from the initial reconciliation.\n+        m_recon_state->capacity_snapshot = capacity;\n+    }\n+    if (short_ids.size() == 0) return nullptr;\n+    minisketch* sketch = minisketch_create(RECON_FIELD_SIZE, 0, capacity);\n+    for (uint32_t short_id : short_ids) {\n+        minisketch_add_uint64(sketch, short_id);\n+    }\n+    return sketch;\n+}\n+\n+std::vector<uint256> CNode::GetRelevantIDsFromShortIDs(uint64_t diff[], uint8_t diff_size, std::vector<uint32_t>& local_missing, CConnman* connman)\n+{\n+    std::vector<uint256> remote_missing;\n+    for (int i = 0; i < diff_size; ++i) {\n+        auto local_tx = m_recon_state->local_short_id_mapping.find(diff[i]);\n+        if (local_tx != m_recon_state->local_short_id_mapping.end()) {\n+            remote_missing.push_back(local_tx->second);\n+        } else {\n+            local_missing.push_back(diff[i]);\n+        }\n+    }\n+    return remote_missing;\n+}\n+\n+std::vector<uint256> CNode::GetWTXIDsFromShortIDs(const std::vector<uint32_t> remote_missing_short_ids, CConnman* connman)\n+{\n+    std::vector<uint256> remote_missing;\n+    for (size_t i = 0; i < remote_missing_short_ids.size(); ++i) {\n+        auto local_tx = m_recon_state->local_short_id_mapping.find(remote_missing_short_ids[i]);\n+        if (local_tx == m_recon_state->local_short_id_mapping.end()) {\n+            LogPrint(BCLog::NET, \"Unknown transaction requested by short id=%d by peer=%d\\n\", remote_missing_short_ids[i], GetId());\n+        }\n+        remote_missing.push_back(local_tx->second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r412382710",
      "id" : 412382710,
      "in_reply_to_id" : 412301986,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM4MjcxMA==",
      "original_commit_id" : "1b695eabc2083384596e146ff3da5846be3058e0",
      "original_line" : 760,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 397555862,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/412382710",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r412384640"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/412384640"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You can't dereference local_tx when it is .end().",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-04-21T18:16:16Z",
      "diff_hunk" : "@@ -628,6 +628,135 @@ int CNode::GetSendVersion() const\n     return nSendVersion;\n }\n \n+void CNode::FinalizeReconciliation(bool clear_local_set, LocalQAction action, uint8_t actual_local_missing, uint8_t actual_remote_missing)\n+{\n+    // According to the erlay spec, reconciliation is initiated by inbound peers.\n+    if (m_recon_state->sender) {\n+        assert(m_recon_state->incoming_recon != CNode::ReconPhase::NONE);\n+        m_recon_state->incoming_recon = CNode::ReconPhase::NONE;\n+    } else {\n+        // When reconciliation initialized by us is done, update local q for future reconciliations.\n+        if (action == LocalQAction::Q_RECOMPUTE) {\n+            assert(m_recon_state->outgoing_recon != CNode::ReconPhase::NONE);\n+            uint8_t local_set_size;\n+            if (m_recon_state->outgoing_recon == CNode::ReconPhase::BISEC_REQUESTED) {\n+                local_set_size = m_recon_state->local_set_snapshot.size();\n+            } else {\n+                local_set_size = m_recon_state->local_set.size();\n+            }\n+            uint8_t remote_set_size = local_set_size + actual_local_missing - actual_remote_missing;\n+            uint8_t set_size_diff = std::abs(local_set_size - remote_set_size);\n+            uint8_t min_size = std::min(local_set_size, remote_set_size);\n+            uint8_t actual_difference = actual_local_missing + actual_remote_missing;\n+            if (min_size != 0)\n+                m_recon_state->local_q = double(actual_difference - set_size_diff) / min_size;\n+        } else if (action == LocalQAction::Q_INCREASE) {\n+            m_recon_state->local_q *= 1.1;\n+        } else if (action == LocalQAction::Q_SET_DEFAULT) {\n+            m_recon_state->local_q = DEFAULT_RECON_Q;\n+        }\n+        m_recon_state->outgoing_recon = CNode::ReconPhase::NONE;\n+    }\n+    if (clear_local_set) m_recon_state->local_set.clear();\n+\n+    m_recon_state->local_short_id_mapping.clear();\n+    // This is currently belt-and-suspenders, as the code should work even without these calls.\n+    m_recon_state->local_set_snapshot.clear();\n+    m_recon_state->capacity_snapshot = 0;\n+    m_recon_state->remote_sketch_snapshot = nullptr;\n+    m_recon_state->local_sketch_snapshot = nullptr;\n+}\n+\n+uint32_t CNode::ComputeShortID(uint256 wtxid)\n+{\n+    uint64_t k0 = m_recon_state->salt.GetUint64(0);\n+    uint64_t k1 = m_recon_state->salt.GetUint64(1);\n+    uint64_t s = SipHashUint256(k0, k1, wtxid);\n+    uint32_t short_txid = 1 + (s & 0xFFFFFFFF);\n+    m_recon_state->local_short_id_mapping.insert(std::pair<uint32_t, uint256>(short_txid, wtxid));\n+    return short_txid;\n+}\n+\n+minisketch* CNode::ComputeSketch(bool use_own_q, BisectionChunk bisection_chunk, uint16_t capacity)\n+{\n+    std::vector<uint32_t> short_ids;\n+    if (m_recon_state->incoming_recon == ReconPhase::BISEC_REQUESTED || m_recon_state->outgoing_recon == ReconPhase::BISEC_REQUESTED) {\n+        // During bisection, all the relevant transactions are stored in the snapshot.\n+        // Original set is used to not miss transactions received during the reconciliation elsewhere.\n+        if (m_recon_state->local_set_snapshot.size() == 0) {\n+            return nullptr;\n+        }\n+        for (uint256 wtxid : m_recon_state->local_set_snapshot) {\n+            short_ids.push_back(ComputeShortID(wtxid));\n+        }\n+\n+        std::vector<uint32_t> bisec_short_ids;\n+        for (uint32_t short_id : short_ids) {\n+            if (bisection_chunk == BISECTION_LOW) {\n+                if (short_id <= BISECTION_MEDIAN) {\n+                    bisec_short_ids.push_back(short_id);\n+                }\n+            } else {\n+                if (short_id > BISECTION_MEDIAN) {\n+                    bisec_short_ids.push_back(short_id);\n+                }\n+            }\n+        }\n+        short_ids = bisec_short_ids;\n+        // For bisection, use capacity used in the initial reconciliation.\n+        capacity = m_recon_state->capacity_snapshot;\n+    } else {\n+        for (uint256 wtxid : m_recon_state->local_set) {\n+            short_ids.push_back(ComputeShortID(wtxid));\n+        }\n+\n+        if (capacity == 0) {\n+            // Estimate locally, as requested by the calling function.\n+            int set_size_diff = m_recon_state->local_set.size() - m_recon_state->remote_set_size;\n+            double q = use_own_q ? m_recon_state->local_q : m_recon_state->remote_q;\n+            capacity = 1 + q * fmin(m_recon_state->local_set.size(), m_recon_state->remote_set_size) +\n+                       abs(set_size_diff);\n+        }\n+        capacity = std::min(capacity, MAX_SKETCH_CAPACITY);\n+        // If bisection is required, we will use this capacity from the initial reconciliation.\n+        m_recon_state->capacity_snapshot = capacity;\n+    }\n+    if (short_ids.size() == 0) return nullptr;\n+    minisketch* sketch = minisketch_create(RECON_FIELD_SIZE, 0, capacity);\n+    for (uint32_t short_id : short_ids) {\n+        minisketch_add_uint64(sketch, short_id);\n+    }\n+    return sketch;\n+}\n+\n+std::vector<uint256> CNode::GetRelevantIDsFromShortIDs(uint64_t diff[], uint8_t diff_size, std::vector<uint32_t>& local_missing, CConnman* connman)\n+{\n+    std::vector<uint256> remote_missing;\n+    for (int i = 0; i < diff_size; ++i) {\n+        auto local_tx = m_recon_state->local_short_id_mapping.find(diff[i]);\n+        if (local_tx != m_recon_state->local_short_id_mapping.end()) {\n+            remote_missing.push_back(local_tx->second);\n+        } else {\n+            local_missing.push_back(diff[i]);\n+        }\n+    }\n+    return remote_missing;\n+}\n+\n+std::vector<uint256> CNode::GetWTXIDsFromShortIDs(const std::vector<uint32_t> remote_missing_short_ids, CConnman* connman)\n+{\n+    std::vector<uint256> remote_missing;\n+    for (size_t i = 0; i < remote_missing_short_ids.size(); ++i) {\n+        auto local_tx = m_recon_state->local_short_id_mapping.find(remote_missing_short_ids[i]);\n+        if (local_tx == m_recon_state->local_short_id_mapping.end()) {\n+            LogPrint(BCLog::NET, \"Unknown transaction requested by short id=%d by peer=%d\\n\", remote_missing_short_ids[i], GetId());\n+        }\n+        remote_missing.push_back(local_tx->second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r412384640",
      "id" : 412384640,
      "in_reply_to_id" : 412301986,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM4NDY0MA==",
      "original_commit_id" : "1b695eabc2083384596e146ff3da5846be3058e0",
      "original_line" : 760,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 397557979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/412384640",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r412389472"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/412389472"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I may be off, but if `local_tx == m_recon_state->local_short_id_mapping.end()`, `local_tx->second` is still accessed after the LogPrint - isn't that illegal? ",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-04-21T18:23:20Z",
      "diff_hunk" : "@@ -628,6 +628,135 @@ int CNode::GetSendVersion() const\n     return nSendVersion;\n }\n \n+void CNode::FinalizeReconciliation(bool clear_local_set, LocalQAction action, uint8_t actual_local_missing, uint8_t actual_remote_missing)\n+{\n+    // According to the erlay spec, reconciliation is initiated by inbound peers.\n+    if (m_recon_state->sender) {\n+        assert(m_recon_state->incoming_recon != CNode::ReconPhase::NONE);\n+        m_recon_state->incoming_recon = CNode::ReconPhase::NONE;\n+    } else {\n+        // When reconciliation initialized by us is done, update local q for future reconciliations.\n+        if (action == LocalQAction::Q_RECOMPUTE) {\n+            assert(m_recon_state->outgoing_recon != CNode::ReconPhase::NONE);\n+            uint8_t local_set_size;\n+            if (m_recon_state->outgoing_recon == CNode::ReconPhase::BISEC_REQUESTED) {\n+                local_set_size = m_recon_state->local_set_snapshot.size();\n+            } else {\n+                local_set_size = m_recon_state->local_set.size();\n+            }\n+            uint8_t remote_set_size = local_set_size + actual_local_missing - actual_remote_missing;\n+            uint8_t set_size_diff = std::abs(local_set_size - remote_set_size);\n+            uint8_t min_size = std::min(local_set_size, remote_set_size);\n+            uint8_t actual_difference = actual_local_missing + actual_remote_missing;\n+            if (min_size != 0)\n+                m_recon_state->local_q = double(actual_difference - set_size_diff) / min_size;\n+        } else if (action == LocalQAction::Q_INCREASE) {\n+            m_recon_state->local_q *= 1.1;\n+        } else if (action == LocalQAction::Q_SET_DEFAULT) {\n+            m_recon_state->local_q = DEFAULT_RECON_Q;\n+        }\n+        m_recon_state->outgoing_recon = CNode::ReconPhase::NONE;\n+    }\n+    if (clear_local_set) m_recon_state->local_set.clear();\n+\n+    m_recon_state->local_short_id_mapping.clear();\n+    // This is currently belt-and-suspenders, as the code should work even without these calls.\n+    m_recon_state->local_set_snapshot.clear();\n+    m_recon_state->capacity_snapshot = 0;\n+    m_recon_state->remote_sketch_snapshot = nullptr;\n+    m_recon_state->local_sketch_snapshot = nullptr;\n+}\n+\n+uint32_t CNode::ComputeShortID(uint256 wtxid)\n+{\n+    uint64_t k0 = m_recon_state->salt.GetUint64(0);\n+    uint64_t k1 = m_recon_state->salt.GetUint64(1);\n+    uint64_t s = SipHashUint256(k0, k1, wtxid);\n+    uint32_t short_txid = 1 + (s & 0xFFFFFFFF);\n+    m_recon_state->local_short_id_mapping.insert(std::pair<uint32_t, uint256>(short_txid, wtxid));\n+    return short_txid;\n+}\n+\n+minisketch* CNode::ComputeSketch(bool use_own_q, BisectionChunk bisection_chunk, uint16_t capacity)\n+{\n+    std::vector<uint32_t> short_ids;\n+    if (m_recon_state->incoming_recon == ReconPhase::BISEC_REQUESTED || m_recon_state->outgoing_recon == ReconPhase::BISEC_REQUESTED) {\n+        // During bisection, all the relevant transactions are stored in the snapshot.\n+        // Original set is used to not miss transactions received during the reconciliation elsewhere.\n+        if (m_recon_state->local_set_snapshot.size() == 0) {\n+            return nullptr;\n+        }\n+        for (uint256 wtxid : m_recon_state->local_set_snapshot) {\n+            short_ids.push_back(ComputeShortID(wtxid));\n+        }\n+\n+        std::vector<uint32_t> bisec_short_ids;\n+        for (uint32_t short_id : short_ids) {\n+            if (bisection_chunk == BISECTION_LOW) {\n+                if (short_id <= BISECTION_MEDIAN) {\n+                    bisec_short_ids.push_back(short_id);\n+                }\n+            } else {\n+                if (short_id > BISECTION_MEDIAN) {\n+                    bisec_short_ids.push_back(short_id);\n+                }\n+            }\n+        }\n+        short_ids = bisec_short_ids;\n+        // For bisection, use capacity used in the initial reconciliation.\n+        capacity = m_recon_state->capacity_snapshot;\n+    } else {\n+        for (uint256 wtxid : m_recon_state->local_set) {\n+            short_ids.push_back(ComputeShortID(wtxid));\n+        }\n+\n+        if (capacity == 0) {\n+            // Estimate locally, as requested by the calling function.\n+            int set_size_diff = m_recon_state->local_set.size() - m_recon_state->remote_set_size;\n+            double q = use_own_q ? m_recon_state->local_q : m_recon_state->remote_q;\n+            capacity = 1 + q * fmin(m_recon_state->local_set.size(), m_recon_state->remote_set_size) +\n+                       abs(set_size_diff);\n+        }\n+        capacity = std::min(capacity, MAX_SKETCH_CAPACITY);\n+        // If bisection is required, we will use this capacity from the initial reconciliation.\n+        m_recon_state->capacity_snapshot = capacity;\n+    }\n+    if (short_ids.size() == 0) return nullptr;\n+    minisketch* sketch = minisketch_create(RECON_FIELD_SIZE, 0, capacity);\n+    for (uint32_t short_id : short_ids) {\n+        minisketch_add_uint64(sketch, short_id);\n+    }\n+    return sketch;\n+}\n+\n+std::vector<uint256> CNode::GetRelevantIDsFromShortIDs(uint64_t diff[], uint8_t diff_size, std::vector<uint32_t>& local_missing, CConnman* connman)\n+{\n+    std::vector<uint256> remote_missing;\n+    for (int i = 0; i < diff_size; ++i) {\n+        auto local_tx = m_recon_state->local_short_id_mapping.find(diff[i]);\n+        if (local_tx != m_recon_state->local_short_id_mapping.end()) {\n+            remote_missing.push_back(local_tx->second);\n+        } else {\n+            local_missing.push_back(diff[i]);\n+        }\n+    }\n+    return remote_missing;\n+}\n+\n+std::vector<uint256> CNode::GetWTXIDsFromShortIDs(const std::vector<uint32_t> remote_missing_short_ids, CConnman* connman)\n+{\n+    std::vector<uint256> remote_missing;\n+    for (size_t i = 0; i < remote_missing_short_ids.size(); ++i) {\n+        auto local_tx = m_recon_state->local_short_id_mapping.find(remote_missing_short_ids[i]);\n+        if (local_tx == m_recon_state->local_short_id_mapping.end()) {\n+            LogPrint(BCLog::NET, \"Unknown transaction requested by short id=%d by peer=%d\\n\", remote_missing_short_ids[i], GetId());\n+        }\n+        remote_missing.push_back(local_tx->second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r412389472",
      "id" : 412389472,
      "in_reply_to_id" : 412301986,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM4OTQ3Mg==",
      "original_commit_id" : "1b695eabc2083384596e146ff3da5846be3058e0",
      "original_line" : 760,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 397563221,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/412389472",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r412404625"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/412404625"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oh, i see you are definitely right, it's a bug!",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-04-21T18:46:18Z",
      "diff_hunk" : "@@ -628,6 +628,135 @@ int CNode::GetSendVersion() const\n     return nSendVersion;\n }\n \n+void CNode::FinalizeReconciliation(bool clear_local_set, LocalQAction action, uint8_t actual_local_missing, uint8_t actual_remote_missing)\n+{\n+    // According to the erlay spec, reconciliation is initiated by inbound peers.\n+    if (m_recon_state->sender) {\n+        assert(m_recon_state->incoming_recon != CNode::ReconPhase::NONE);\n+        m_recon_state->incoming_recon = CNode::ReconPhase::NONE;\n+    } else {\n+        // When reconciliation initialized by us is done, update local q for future reconciliations.\n+        if (action == LocalQAction::Q_RECOMPUTE) {\n+            assert(m_recon_state->outgoing_recon != CNode::ReconPhase::NONE);\n+            uint8_t local_set_size;\n+            if (m_recon_state->outgoing_recon == CNode::ReconPhase::BISEC_REQUESTED) {\n+                local_set_size = m_recon_state->local_set_snapshot.size();\n+            } else {\n+                local_set_size = m_recon_state->local_set.size();\n+            }\n+            uint8_t remote_set_size = local_set_size + actual_local_missing - actual_remote_missing;\n+            uint8_t set_size_diff = std::abs(local_set_size - remote_set_size);\n+            uint8_t min_size = std::min(local_set_size, remote_set_size);\n+            uint8_t actual_difference = actual_local_missing + actual_remote_missing;\n+            if (min_size != 0)\n+                m_recon_state->local_q = double(actual_difference - set_size_diff) / min_size;\n+        } else if (action == LocalQAction::Q_INCREASE) {\n+            m_recon_state->local_q *= 1.1;\n+        } else if (action == LocalQAction::Q_SET_DEFAULT) {\n+            m_recon_state->local_q = DEFAULT_RECON_Q;\n+        }\n+        m_recon_state->outgoing_recon = CNode::ReconPhase::NONE;\n+    }\n+    if (clear_local_set) m_recon_state->local_set.clear();\n+\n+    m_recon_state->local_short_id_mapping.clear();\n+    // This is currently belt-and-suspenders, as the code should work even without these calls.\n+    m_recon_state->local_set_snapshot.clear();\n+    m_recon_state->capacity_snapshot = 0;\n+    m_recon_state->remote_sketch_snapshot = nullptr;\n+    m_recon_state->local_sketch_snapshot = nullptr;\n+}\n+\n+uint32_t CNode::ComputeShortID(uint256 wtxid)\n+{\n+    uint64_t k0 = m_recon_state->salt.GetUint64(0);\n+    uint64_t k1 = m_recon_state->salt.GetUint64(1);\n+    uint64_t s = SipHashUint256(k0, k1, wtxid);\n+    uint32_t short_txid = 1 + (s & 0xFFFFFFFF);\n+    m_recon_state->local_short_id_mapping.insert(std::pair<uint32_t, uint256>(short_txid, wtxid));\n+    return short_txid;\n+}\n+\n+minisketch* CNode::ComputeSketch(bool use_own_q, BisectionChunk bisection_chunk, uint16_t capacity)\n+{\n+    std::vector<uint32_t> short_ids;\n+    if (m_recon_state->incoming_recon == ReconPhase::BISEC_REQUESTED || m_recon_state->outgoing_recon == ReconPhase::BISEC_REQUESTED) {\n+        // During bisection, all the relevant transactions are stored in the snapshot.\n+        // Original set is used to not miss transactions received during the reconciliation elsewhere.\n+        if (m_recon_state->local_set_snapshot.size() == 0) {\n+            return nullptr;\n+        }\n+        for (uint256 wtxid : m_recon_state->local_set_snapshot) {\n+            short_ids.push_back(ComputeShortID(wtxid));\n+        }\n+\n+        std::vector<uint32_t> bisec_short_ids;\n+        for (uint32_t short_id : short_ids) {\n+            if (bisection_chunk == BISECTION_LOW) {\n+                if (short_id <= BISECTION_MEDIAN) {\n+                    bisec_short_ids.push_back(short_id);\n+                }\n+            } else {\n+                if (short_id > BISECTION_MEDIAN) {\n+                    bisec_short_ids.push_back(short_id);\n+                }\n+            }\n+        }\n+        short_ids = bisec_short_ids;\n+        // For bisection, use capacity used in the initial reconciliation.\n+        capacity = m_recon_state->capacity_snapshot;\n+    } else {\n+        for (uint256 wtxid : m_recon_state->local_set) {\n+            short_ids.push_back(ComputeShortID(wtxid));\n+        }\n+\n+        if (capacity == 0) {\n+            // Estimate locally, as requested by the calling function.\n+            int set_size_diff = m_recon_state->local_set.size() - m_recon_state->remote_set_size;\n+            double q = use_own_q ? m_recon_state->local_q : m_recon_state->remote_q;\n+            capacity = 1 + q * fmin(m_recon_state->local_set.size(), m_recon_state->remote_set_size) +\n+                       abs(set_size_diff);\n+        }\n+        capacity = std::min(capacity, MAX_SKETCH_CAPACITY);\n+        // If bisection is required, we will use this capacity from the initial reconciliation.\n+        m_recon_state->capacity_snapshot = capacity;\n+    }\n+    if (short_ids.size() == 0) return nullptr;\n+    minisketch* sketch = minisketch_create(RECON_FIELD_SIZE, 0, capacity);\n+    for (uint32_t short_id : short_ids) {\n+        minisketch_add_uint64(sketch, short_id);\n+    }\n+    return sketch;\n+}\n+\n+std::vector<uint256> CNode::GetRelevantIDsFromShortIDs(uint64_t diff[], uint8_t diff_size, std::vector<uint32_t>& local_missing, CConnman* connman)\n+{\n+    std::vector<uint256> remote_missing;\n+    for (int i = 0; i < diff_size; ++i) {\n+        auto local_tx = m_recon_state->local_short_id_mapping.find(diff[i]);\n+        if (local_tx != m_recon_state->local_short_id_mapping.end()) {\n+            remote_missing.push_back(local_tx->second);\n+        } else {\n+            local_missing.push_back(diff[i]);\n+        }\n+    }\n+    return remote_missing;\n+}\n+\n+std::vector<uint256> CNode::GetWTXIDsFromShortIDs(const std::vector<uint32_t> remote_missing_short_ids, CConnman* connman)\n+{\n+    std::vector<uint256> remote_missing;\n+    for (size_t i = 0; i < remote_missing_short_ids.size(); ++i) {\n+        auto local_tx = m_recon_state->local_short_id_mapping.find(remote_missing_short_ids[i]);\n+        if (local_tx == m_recon_state->local_short_id_mapping.end()) {\n+            LogPrint(BCLog::NET, \"Unknown transaction requested by short id=%d by peer=%d\\n\", remote_missing_short_ids[i], GetId());\n+        }\n+        remote_missing.push_back(local_tx->second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r412404625",
      "id" : 412404625,
      "in_reply_to_id" : 412301986,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQwNDYyNQ==",
      "original_commit_id" : "1b695eabc2083384596e146ff3da5846be3058e0",
      "original_line" : 760,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 397579849,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/412404625",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Alright, all the tests should be passing now, also rebased.\r\n\r\nThere's one last test that fails consistently: p2p_segwit.py.\r\nI'll take a look at that, and upgrade the code for recent minisketch (with reconciliation capacity checksum thing) soon.\r\n\r\nOne good idea for the future: test that legacy nodes talk OK alright to erlay nodes (I checked it only manually).\r\n",
      "created_at" : "2020-04-21T20:31:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-617398513",
      "id" : 617398513,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNzM5ODUxMw==",
      "updated_at" : "2020-04-21T20:31:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/617398513",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@naumenkogs Please have a look at this: https://github.com/sipa/minisketch/pull/23",
      "created_at" : "2020-04-21T20:40:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-617402629",
      "id" : 617402629,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNzQwMjYyOQ==",
      "updated_at" : "2020-04-21T20:40:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/617402629",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r412586167"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/412586167"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "One more potential issue: If I understand it correctly, `m_recon_state` is null if our peer does not signal Erlay support. So we should check if `m_recon_state` is non-null before accessing its members here.\r\n\r\nOtherwise an attacker could not signal Erlay but then send Erlay-specific messages to crash our node. Same applies for the other new messages `NetMsgType::SKETCH` etc. below.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-04-22T00:39:24Z",
      "diff_hunk" : "@@ -3417,6 +3447,274 @@ bool ProcessMessage(CNode* pfrom, const std::string& msg_type, CDataStream& vRec\n         return true;\n     }\n \n+    std::chrono::microseconds current_time = GetTime<std::chrono::microseconds>();\n+\n+    // Record an (expected) reconciliation request with parameters to respond when time comes.\n+    // All initial reconciliation responses will be done at the same time to prevent tx-related privacy leaks.\n+    if (strCommand == NetMsgType::REQRECON) {\n+        if (!pfrom->m_recon_state->sender) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r412586167",
      "id" : 412586167,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU4NjE2Nw==",
      "original_commit_id" : "0a262c092f6fe29d6964fe6fd1f1d98d08db44dd",
      "original_line" : 3492,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 397767143,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/412586167",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r412589714"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/412589714"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Definitely an issue, will address!\r\nI had asserts all over, and then was replacing them with returns, but this one requires 2 checks for m_recon_state and for sender :)",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-04-22T00:50:10Z",
      "diff_hunk" : "@@ -3417,6 +3447,274 @@ bool ProcessMessage(CNode* pfrom, const std::string& msg_type, CDataStream& vRec\n         return true;\n     }\n \n+    std::chrono::microseconds current_time = GetTime<std::chrono::microseconds>();\n+\n+    // Record an (expected) reconciliation request with parameters to respond when time comes.\n+    // All initial reconciliation responses will be done at the same time to prevent tx-related privacy leaks.\n+    if (strCommand == NetMsgType::REQRECON) {\n+        if (!pfrom->m_recon_state->sender) return true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r412589714",
      "id" : 412589714,
      "in_reply_to_id" : 412586167,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU4OTcxNA==",
      "original_commit_id" : "0a262c092f6fe29d6964fe6fd1f1d98d08db44dd",
      "original_line" : 3492,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 397770157,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/412589714",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-04-25T13:10:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-619377457",
      "id" : 619377457,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxOTM3NzQ1Nw==",
      "updated_at" : "2020-04-25T13:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/619377457",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-04-29T08:46:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-621070747",
      "id" : 621070747,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMTA3MDc0Nw==",
      "updated_at" : "2020-04-29T08:46:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/621070747",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "This should be in reviewable state now: I split commits more, fixed all the tests, made it more stable, addressed feedback by @mzumsande, updated with new helpers from minisketch.\r\n\r\nTravis failed last time because of the little issue with minisketch release build, but it should work just fine for local testing and experiments!\r\nWill rebase again when #18044 is rebased to not create much discrepancy there.",
      "created_at" : "2020-05-07T14:15:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-625282154",
      "id" : 625282154,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyNTI4MjE1NA==",
      "updated_at" : "2020-05-07T14:15:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/625282154",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r436293837"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436293837"
         }
      },
      "author_association" : "NONE",
      "body" : "this could say BIP 330",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-06-06T19:20:37Z",
      "diff_hunk" : "@@ -362,12 +402,13 @@ const uint32_t MSG_TYPE_MASK    = 0xffffffff >> 2;\n  * These numbers are defined by the protocol. When adding a new value, be sure\n  * to mention it in the respective BIP.\n  */\n-enum GetDataMsg\n+enum GetDataMsg : uint32_t\n {\n     UNDEFINED = 0,\n     MSG_TX = 1,\n     MSG_BLOCK = 2,\n-    // The following can only occur in getdata. Invs always use TX or BLOCK.\n+    MSG_WTX = 5, // Defined in BIP XXX",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r436293837",
      "id" : 436293837,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5MzgzNw==",
      "original_commit_id" : "5f81325bf1d2a32f6dcfb9a9b8c5106af6289b9f",
      "original_line" : 410,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : null,
      "pull_request_review_id" : 425762827,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436293837",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/284023?v=4",
         "events_url" : "https://api.github.com/users/ysangkok/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ysangkok/followers",
         "following_url" : "https://api.github.com/users/ysangkok/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ysangkok/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ysangkok",
         "id" : 284023,
         "login" : "ysangkok",
         "node_id" : "MDQ6VXNlcjI4NDAyMw==",
         "organizations_url" : "https://api.github.com/users/ysangkok/orgs",
         "received_events_url" : "https://api.github.com/users/ysangkok/received_events",
         "repos_url" : "https://api.github.com/users/ysangkok/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ysangkok/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ysangkok/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ysangkok"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r436293867"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436293867"
         }
      },
      "author_association" : "NONE",
      "body" : "also, could say BIP 330",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-06-06T19:20:59Z",
      "diff_hunk" : "@@ -234,6 +234,46 @@ extern const char *GETBLOCKTXN;\n  * @since protocol version 70014 as described by BIP 152\n  */\n extern const char *BLOCKTXN;\n+/**\n+ * Indicates that a node prefers to relay transactions via wtxid, rather than\n+ * txid.\n+ * @since protocol version 70016 as described by BIP XXX.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r436293867",
      "id" : 436293867,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5Mzg2Nw==",
      "original_commit_id" : "5f81325bf1d2a32f6dcfb9a9b8c5106af6289b9f",
      "original_line" : 240,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : null,
      "pull_request_review_id" : 425762847,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436293867",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/284023?v=4",
         "events_url" : "https://api.github.com/users/ysangkok/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ysangkok/followers",
         "following_url" : "https://api.github.com/users/ysangkok/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ysangkok/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ysangkok",
         "id" : 284023,
         "login" : "ysangkok",
         "node_id" : "MDQ6VXNlcjI4NDAyMw==",
         "organizations_url" : "https://api.github.com/users/ysangkok/orgs",
         "received_events_url" : "https://api.github.com/users/ysangkok/received_events",
         "repos_url" : "https://api.github.com/users/ysangkok/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ysangkok/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ysangkok/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ysangkok"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r436294048"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436294048"
         }
      },
      "author_association" : "NONE",
      "body" : "wouldn't it be better to have this guarded by an ifdef?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-06-06T19:23:41Z",
      "diff_hunk" : "@@ -0,0 +1,231 @@\n+/**********************************************************************\n+ * Copyright (c) 2018 Pieter Wuille, Greg Maxwell, Gleb Naumenko      *\n+ * Distributed under the MIT software license, see the accompanying   *\n+ * file LICENSE or http://www.opensource.org/licenses/mit-license.php.*\n+ **********************************************************************/\n+\n+#include \"../include/minisketch.h\"\n+#include <string.h>\n+#include <memory>\n+#include <vector>\n+#include <algorithm>\n+#include <random>\n+#include <iostream>\n+#include <thread>\n+#include \"util.h\"\n+\n+uint64_t Combination(uint64_t n, uint64_t k) {\n+    if (n - k < k) k = n - k;\n+    uint64_t ret = 1;\n+    for (uint64_t i = 1; i <= k; ++i) {\n+        ret = (ret * n) / i;\n+        --n;\n+    }\n+    return ret;\n+}\n+\n+void TestAll(int bits, int impl, int count, uint32_t threadid, uint32_t threads, std::vector<uint64_t>& ret) {\n+    minisketch* state = minisketch_create(bits, impl, count);\n+    if (!state) return;\n+\n+    // Iterate over all (bits)-bit sketches with (count) syndromes.\n+    for (uint64_t x = threadid; (x >> (bits * count)) == 0; x += threads) {\n+        // Construct the serialization and load it.\n+        unsigned char ser[8];\n+        ser[0] = x;\n+        ser[1] = x >> 8;\n+        ser[2] = x >> 16;\n+        ser[3] = x >> 24;\n+        ser[4] = x >> 32;\n+        ser[5] = x >> 40;\n+        ser[6] = x >> 48;\n+        ser[7] = x >> 56;\n+\n+        minisketch_deserialize(state, ser);\n+\n+        // Compute all the solutions.\n+        uint64_t roots[64];\n+        int num_roots = minisketch_decode(state, 64, roots);\n+\n+        // If there are solutions:\n+        if (num_roots >= 0) {\n+            // Asking for one root less should fail.\n+            CHECK(num_roots < 1 || minisketch_decode(state, num_roots - 1, roots) == -1);\n+            // Reconstruct the sketch from the solutions.\n+            minisketch* state2 = minisketch_create(bits, 0, count);\n+            for (int i = 0; i < num_roots; ++i) {\n+                minisketch_add_uint64(state2, roots[i]);\n+            }\n+            // Serialize it.\n+            unsigned char nser[8] = {0};\n+            minisketch_serialize(state2, nser);\n+            // Compare it to the original.\n+            CHECK(memcmp(ser, nser, 8) == 0);\n+            // Count it.\n+            if (num_roots +1 >= (int)ret.size()) ret.resize(num_roots + 2);\n+            ret[num_roots + 1]++;\n+            minisketch_destroy(state2);\n+        } else {\n+            if (ret.size() == 0) ret.resize(1);\n+            ret[0]++;\n+        }\n+    }\n+    minisketch_destroy(state);\n+}\n+\n+std::vector<uint64_t> TestAll(int bits, int impl, int count, uint32_t threads) {\n+    std::vector<std::vector<uint64_t>> outputs;\n+    std::vector<std::thread> thread_list;\n+    thread_list.reserve(threads);\n+    outputs.resize(threads);\n+    for (uint32_t i = 0; i < threads; ++i) {\n+        thread_list.emplace_back([=,&outputs](){ TestAll(bits, impl, count, i, threads, outputs[i]); });\n+    }\n+    std::vector<uint64_t> ret;\n+    for (uint32_t i = 0; i < threads; ++i) {\n+        thread_list[i].join();\n+        if (ret.size() < outputs[i].size()) ret.resize(outputs[i].size());\n+        for (size_t j = 0; j < outputs[i].size(); ++j) {\n+            ret[j] += outputs[i][j];\n+        }\n+    }\n+    if (ret.size()) {\n+        for (int i = 1; i <= count + 1; ++i) {\n+            CHECK(ret[i] == Combination((uint64_t(1) << bits) - 1, i - 1));\n+        }\n+    }\n+    return ret;\n+}\n+\n+void TestRand(int bits, int impl, int count, int iter) {\n+    std::vector<uint64_t> elems(count);\n+    std::vector<uint64_t> roots(count + 1);\n+    std::random_device rnd;\n+    std::uniform_int_distribution<uint64_t> dist(1, bits == 64 ? -1 : ((uint64_t(1) << bits) - 1));\n+\n+    for (int i = 0; i < iter; ++i) {\n+        bool overfill = iter & 1; // Test some cases with overfull sketches that may not decode.\n+        minisketch* state = minisketch_create(bits, impl, count);\n+        if (!state) return;\n+        minisketch* basestate = minisketch_create(bits, 0, count);\n+        for (int j = 0; j < count + 3*overfill; ++j) {\n+            uint64_t r = dist(rnd);\n+            if (!overfill) elems[j] = r;\n+            minisketch_add_uint64(state, r);\n+            minisketch_add_uint64(basestate, r);\n+        }\n+        roots.assign(count + 1, 0);\n+        std::vector<unsigned char> data, basedata;\n+        basedata.resize(((count + 1) * bits + 7) / 8);\n+        data.resize(((count + 1) * bits + 7) / 8);\n+        minisketch_serialize(basestate, basedata.data());\n+        minisketch_serialize(state, data.data());\n+        CHECK(data == basedata);\n+        minisketch_deserialize(state, basedata.data());\n+        int num_roots = minisketch_decode(state, count + 1, roots.data());\n+        CHECK(overfill || num_roots >= 0);\n+        CHECK(num_roots < 1 || minisketch_decode(state, num_roots - 1, roots.data()) == -1); // Decoding with a too-low maximum should fail.\n+        if (!overfill) {\n+            std::sort(roots.begin(), roots.begin() + num_roots);\n+//            fprintf(stderr, \"Solut: \");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r436294048",
      "id" : 436294048,
      "line" : 132,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NDA0OA==",
      "original_commit_id" : "5f81325bf1d2a32f6dcfb9a9b8c5106af6289b9f",
      "original_line" : 132,
      "original_position" : 130,
      "original_start_line" : null,
      "path" : "src/minisketch/src/test-exhaust.cpp",
      "position" : 132,
      "pull_request_review_id" : 425763015,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436294048",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/284023?v=4",
         "events_url" : "https://api.github.com/users/ysangkok/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ysangkok/followers",
         "following_url" : "https://api.github.com/users/ysangkok/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ysangkok/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ysangkok",
         "id" : 284023,
         "login" : "ysangkok",
         "node_id" : "MDQ6VXNlcjI4NDAyMw==",
         "organizations_url" : "https://api.github.com/users/ysangkok/orgs",
         "received_events_url" : "https://api.github.com/users/ysangkok/received_events",
         "repos_url" : "https://api.github.com/users/ysangkok/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ysangkok/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ysangkok/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ysangkok"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r436297436"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436297436"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think https://github.com/sipa/minisketch master branch is a better place for these comments :)",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-06-06T20:14:23Z",
      "diff_hunk" : "@@ -0,0 +1,231 @@\n+/**********************************************************************\n+ * Copyright (c) 2018 Pieter Wuille, Greg Maxwell, Gleb Naumenko      *\n+ * Distributed under the MIT software license, see the accompanying   *\n+ * file LICENSE or http://www.opensource.org/licenses/mit-license.php.*\n+ **********************************************************************/\n+\n+#include \"../include/minisketch.h\"\n+#include <string.h>\n+#include <memory>\n+#include <vector>\n+#include <algorithm>\n+#include <random>\n+#include <iostream>\n+#include <thread>\n+#include \"util.h\"\n+\n+uint64_t Combination(uint64_t n, uint64_t k) {\n+    if (n - k < k) k = n - k;\n+    uint64_t ret = 1;\n+    for (uint64_t i = 1; i <= k; ++i) {\n+        ret = (ret * n) / i;\n+        --n;\n+    }\n+    return ret;\n+}\n+\n+void TestAll(int bits, int impl, int count, uint32_t threadid, uint32_t threads, std::vector<uint64_t>& ret) {\n+    minisketch* state = minisketch_create(bits, impl, count);\n+    if (!state) return;\n+\n+    // Iterate over all (bits)-bit sketches with (count) syndromes.\n+    for (uint64_t x = threadid; (x >> (bits * count)) == 0; x += threads) {\n+        // Construct the serialization and load it.\n+        unsigned char ser[8];\n+        ser[0] = x;\n+        ser[1] = x >> 8;\n+        ser[2] = x >> 16;\n+        ser[3] = x >> 24;\n+        ser[4] = x >> 32;\n+        ser[5] = x >> 40;\n+        ser[6] = x >> 48;\n+        ser[7] = x >> 56;\n+\n+        minisketch_deserialize(state, ser);\n+\n+        // Compute all the solutions.\n+        uint64_t roots[64];\n+        int num_roots = minisketch_decode(state, 64, roots);\n+\n+        // If there are solutions:\n+        if (num_roots >= 0) {\n+            // Asking for one root less should fail.\n+            CHECK(num_roots < 1 || minisketch_decode(state, num_roots - 1, roots) == -1);\n+            // Reconstruct the sketch from the solutions.\n+            minisketch* state2 = minisketch_create(bits, 0, count);\n+            for (int i = 0; i < num_roots; ++i) {\n+                minisketch_add_uint64(state2, roots[i]);\n+            }\n+            // Serialize it.\n+            unsigned char nser[8] = {0};\n+            minisketch_serialize(state2, nser);\n+            // Compare it to the original.\n+            CHECK(memcmp(ser, nser, 8) == 0);\n+            // Count it.\n+            if (num_roots +1 >= (int)ret.size()) ret.resize(num_roots + 2);\n+            ret[num_roots + 1]++;\n+            minisketch_destroy(state2);\n+        } else {\n+            if (ret.size() == 0) ret.resize(1);\n+            ret[0]++;\n+        }\n+    }\n+    minisketch_destroy(state);\n+}\n+\n+std::vector<uint64_t> TestAll(int bits, int impl, int count, uint32_t threads) {\n+    std::vector<std::vector<uint64_t>> outputs;\n+    std::vector<std::thread> thread_list;\n+    thread_list.reserve(threads);\n+    outputs.resize(threads);\n+    for (uint32_t i = 0; i < threads; ++i) {\n+        thread_list.emplace_back([=,&outputs](){ TestAll(bits, impl, count, i, threads, outputs[i]); });\n+    }\n+    std::vector<uint64_t> ret;\n+    for (uint32_t i = 0; i < threads; ++i) {\n+        thread_list[i].join();\n+        if (ret.size() < outputs[i].size()) ret.resize(outputs[i].size());\n+        for (size_t j = 0; j < outputs[i].size(); ++j) {\n+            ret[j] += outputs[i][j];\n+        }\n+    }\n+    if (ret.size()) {\n+        for (int i = 1; i <= count + 1; ++i) {\n+            CHECK(ret[i] == Combination((uint64_t(1) << bits) - 1, i - 1));\n+        }\n+    }\n+    return ret;\n+}\n+\n+void TestRand(int bits, int impl, int count, int iter) {\n+    std::vector<uint64_t> elems(count);\n+    std::vector<uint64_t> roots(count + 1);\n+    std::random_device rnd;\n+    std::uniform_int_distribution<uint64_t> dist(1, bits == 64 ? -1 : ((uint64_t(1) << bits) - 1));\n+\n+    for (int i = 0; i < iter; ++i) {\n+        bool overfill = iter & 1; // Test some cases with overfull sketches that may not decode.\n+        minisketch* state = minisketch_create(bits, impl, count);\n+        if (!state) return;\n+        minisketch* basestate = minisketch_create(bits, 0, count);\n+        for (int j = 0; j < count + 3*overfill; ++j) {\n+            uint64_t r = dist(rnd);\n+            if (!overfill) elems[j] = r;\n+            minisketch_add_uint64(state, r);\n+            minisketch_add_uint64(basestate, r);\n+        }\n+        roots.assign(count + 1, 0);\n+        std::vector<unsigned char> data, basedata;\n+        basedata.resize(((count + 1) * bits + 7) / 8);\n+        data.resize(((count + 1) * bits + 7) / 8);\n+        minisketch_serialize(basestate, basedata.data());\n+        minisketch_serialize(state, data.data());\n+        CHECK(data == basedata);\n+        minisketch_deserialize(state, basedata.data());\n+        int num_roots = minisketch_decode(state, count + 1, roots.data());\n+        CHECK(overfill || num_roots >= 0);\n+        CHECK(num_roots < 1 || minisketch_decode(state, num_roots - 1, roots.data()) == -1); // Decoding with a too-low maximum should fail.\n+        if (!overfill) {\n+            std::sort(roots.begin(), roots.begin() + num_roots);\n+//            fprintf(stderr, \"Solut: \");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r436297436",
      "id" : 436297436,
      "in_reply_to_id" : 436294048,
      "line" : 132,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI5NzQzNg==",
      "original_commit_id" : "5f81325bf1d2a32f6dcfb9a9b8c5106af6289b9f",
      "original_line" : 132,
      "original_position" : 130,
      "original_start_line" : null,
      "path" : "src/minisketch/src/test-exhaust.cpp",
      "position" : 132,
      "pull_request_review_id" : 425765935,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436297436",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased on #18044, but we will probably get #19184 before Erlay first, so please review that first.\r\nAlthough this PR is in a reviewable state right now!\r\n\r\nThis PR currently doesn't pass travis tests because of the minisketch build issue after the recent patch. Should work locally and shouldn't stop people from reviewing this work :)",
      "created_at" : "2020-07-28T07:35:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-664831828",
      "id" : 664831828,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NDgzMTgyOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-28T07:36:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/664831828",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-07-30T14:30:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-666400842",
      "id" : 666400842,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY2NjQwMDg0Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-07-30T14:30:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/666400842",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-02T12:19:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-685695376",
      "id" : 685695376,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4NTY5NTM3Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-02T12:19:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/685695376",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "It seems like the tests are failing and that a rebase is needed.\r\n\r\nI'm super excited about Erlay! :) What is the plan ahead?",
      "created_at" : "2020-10-02T09:08:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-702616037",
      "id" : 702616037,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwMjYxNjAzNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-02T09:08:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/702616037",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@practicalswift we kinda agreed that #19988 is a prerequisite, I hope Erlay becomes a priority right after :)",
      "created_at" : "2020-10-02T11:26:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-702679529",
      "id" : 702679529,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwMjY3OTUyOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-02T11:26:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/702679529",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased, added a bunch of comments and restructured commits for better review.\r\n\r\nMarking it as reviewable now, although my fight with Travis builds is not over yet :)",
      "created_at" : "2020-11-17T13:34:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-728930036",
      "id" : 728930036,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcyODkzMDAzNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-17T13:34:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/728930036",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-11-19T12:21:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-730339345",
      "id" : 730339345,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczMDMzOTM0NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-19T12:21:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/730339345",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Me and @sipa decided to switch to \"extension sketches\": instead of requesting a bisection, someone who failed to decode the difference from the initial sketch, may ask for an extension of the initial sketch.\r\nA responder then have to send syndromes of higher order only.\r\n\r\nThe main motivation is it seems like bisection adds a lot of complexity (see b5c92a41e4cc0599504cf838d20212f1a403e573).\r\nExtensions have all the same properties after all, but they're more CPU-costly. We think it's fine for sketches of small capacity (what we expect to have here) to ignore this disadvantage.\r\n\r\nSo, for now, please review up to a30e861c9cada8fbc400d07255516839480d9e9d (but also feel free to review further if you're curious).\r\n\r\nI will replace bisection with extensions and update the BIP soon.",
      "created_at" : "2020-11-19T17:49:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-730536171",
      "id" : 730536171,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczMDUzNjE3MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-19T17:49:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/730536171",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-11-20T15:49:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-731247466",
      "id" : 731247466,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczMTI0NzQ2Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-20T15:49:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/731247466",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Okay, now the [BIP PR](https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-600388543) is up-to-date with this code, and this stuff is ready for full review again.",
      "created_at" : "2020-11-21T21:39:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-731640683",
      "id" : 731640683,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczMTY0MDY4Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-21T21:39:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/731640683",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-11-25T09:04:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-733568196",
      "id" : 733568196,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczMzU2ODE5Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-25T09:04:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/733568196",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Starting the review by digging into the BIP :)\r\n\r\nFew remarks :\r\n1) \"improves privacy as a side-effect\", it would be great to explain and document this claim, maybe add a section in Rationale ?\r\n2) \"truncated transaction IDs\",  AFAIU, Erlay introduces new shortened transaction identifiers for regular tx-relay, maybe it could be better to call them \"truncated WTXID\" ? If BIP 330 implies BIP 339, it could be better to remove references to transaction ID or at least when it's ambiguous\r\n3) You mentioned switching to extension sketch and mentioned the updated BIP was ready for review, I think you need to update the \"intented protocol flow\" schema, remove `reqbisec` and update Rationale ?\r\n4) You might swap the \"Local State\" section before messages, it could be easier to explain q-coefficient before using them in New messages\r\n",
      "created_at" : "2020-12-01T13:41:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-736558694",
      "id" : 736558694,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNjU1ODY5NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-01T13:41:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/736558694",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-12-02T13:16:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-737224016",
      "id" : 737224016,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczNzIyNDAxNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-02T13:16:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/737224016",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-12-07T13:05:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-739906241",
      "id" : 739906241,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDczOTkwNjI0MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-07T13:05:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/739906241",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540464964"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540464964"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We should probably not send a `sendrecon` message to block-relay only peers?  Here we should just check to see if it's an inbound peer, right?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-10T20:12:07Z",
      "diff_hunk" : "@@ -2360,6 +2369,21 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n \n         if (greatest_common_version >= WTXID_RELAY_VERSION) {\n             m_connman.PushMessage(&pfrom, msg_maker.Make(NetMsgType::WTXIDRELAY));\n+\n+            // Reconciliation is supported only when wtxid relay is supported.\n+            bool be_recon_requestor, be_recon_responder;\n+            // Currently reconciliation requests flow only in one direction inbound->outbound.\n+            if (pfrom.IsFullOutboundConn()) {\n+                be_recon_requestor = true;\n+                be_recon_responder = false;\n+            } else {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540464964",
      "id" : 540464964,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ2NDk2NA==",
      "original_commit_id" : "a6f979194ac31f19cdc46f01b40f48ec889910a9",
      "original_line" : 2379,
      "original_position" : 27,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 549563941,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540464964",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540466709"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540466709"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I believe BIP 330 doesn't reference protocol version 80001, and the code in this commit seems to send it as long as the peer has version 70016 or higher.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-10T20:15:00Z",
      "diff_hunk" : "@@ -260,6 +260,14 @@ extern const char* CFCHECKPT;\n  * @since protocol version 70016 as described by BIP 339.\n  */\n extern const char* WTXIDRELAY;\n+/**\n+ * Contains 2 1-byte bools, a 4-byte version number and an 8-byte salt.\n+ * Indicates that a node is willing to participate in transaction reconciliation,\n+ * either as a sender or a receiver.\n+ * The salt is used to compute short txids needed for efficient reconciliation.\n+ * @since protocol version 80001 as described by BIP 330",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540466709",
      "id" : 540466709,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ2NjcwOQ==",
      "original_commit_id" : "a6f979194ac31f19cdc46f01b40f48ec889910a9",
      "original_line" : 268,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : null,
      "pull_request_review_id" : 549563941,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540466709",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540467865"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540467865"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Just a note, I think the BIP draft refers to a default value of q=0.1. Perhaps if we end up leaving our default at 0.02, then we could update the BIP to have the same default value suggestion.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-10T20:17:01Z",
      "diff_hunk" : "@@ -146,6 +146,10 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** Static component of the salt used to compute short txids for transaction reconciliation. */\n+static const std::string RECON_STATIC_SALT = \"Tx Relay Salting\";\n+/** Default coefficient used to estimate set difference for tx reconciliation. */\n+static constexpr double DEFAULT_RECON_Q = 0.02;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540467865",
      "id" : 540467865,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ2Nzg2NQ==",
      "original_commit_id" : "2ac6f49703abd3293f5d14f20d1eda357b093a6a",
      "original_line" : 162,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 549563941,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540467865",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540469261"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540469261"
         }
      },
      "author_association" : "MEMBER",
      "body" : "spelling nit: should say \"reconcile\"",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-10T20:19:25Z",
      "diff_hunk" : "@@ -2559,6 +2617,62 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    // Received from an inbound peer planning to reconcilie transactions with us, or",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540469261",
      "id" : 540469261,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ2OTI2MQ==",
      "original_commit_id" : "2ac6f49703abd3293f5d14f20d1eda357b093a6a",
      "original_line" : 2620,
      "original_position" : 76,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 549563941,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540469261",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540470196"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540470196"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should we only consider negotiation to have succeeded if we've already received a `wtxidrelay` message from this peer?  If so, I think we need to specify the order in which `wtxidrelay` and `sendrecon` get sent during handshaking in the BIP.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-10T20:21:01Z",
      "diff_hunk" : "@@ -2559,6 +2617,62 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    // Received from an inbound peer planning to reconcilie transactions with us, or\n+    // from an outgoing peer demonstrating readiness to do reconciliations.\n+    // If received from outgoing, adds the peer to the reconciliation queue.\n+    // Feature negotiation of tx reconciliation should happen between VERSION and\n+    // VERACK, to avoid relay problems from switching after a connection is up.\n+    if (msg_type == NetMsgType::SENDRECON) {\n+        if (!pfrom.m_tx_relay) return;\n+        if (peer->m_recon_state != nullptr) return; // Do not support reconciliation salt/version updates.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540470196",
      "id" : 540470196,
      "line" : 2944,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ3MDE5Ng==",
      "original_commit_id" : "2ac6f49703abd3293f5d14f20d1eda357b093a6a",
      "original_line" : 2944,
      "original_position" : 83,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 303,
      "pull_request_review_id" : 549563941,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540470196",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540472620"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540472620"
         }
      },
      "author_association" : "MEMBER",
      "body" : "A comment here explaining this setup for an inbound peer that sends us a SENDRECON with `sender=false` would be helpful.  Here, it seems that we don't set up any reconciliation to occur with an inbound peer that doesn't want to reconcile with us, because we only send reconciliations to our outbound peers, and require that inbounds who want to reconcile be the requestor.\r\n\r\nPerhaps a comment that reminds the reader that if we give up on setting up reconciliation with a peer, that we default to flooding to that peer?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-10T20:25:01Z",
      "diff_hunk" : "@@ -2559,6 +2617,62 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    // Received from an inbound peer planning to reconcilie transactions with us, or\n+    // from an outgoing peer demonstrating readiness to do reconciliations.\n+    // If received from outgoing, adds the peer to the reconciliation queue.\n+    // Feature negotiation of tx reconciliation should happen between VERSION and\n+    // VERACK, to avoid relay problems from switching after a connection is up.\n+    if (msg_type == NetMsgType::SENDRECON) {\n+        if (!pfrom.m_tx_relay) return;\n+        if (peer->m_recon_state != nullptr) return; // Do not support reconciliation salt/version updates.\n+\n+        bool recon_sender, recon_responder;\n+        uint64_t remote_salt;\n+        uint32_t recon_version;\n+        vRecv >> recon_sender >> recon_responder >> recon_version >> remote_salt;\n+        if (recon_version != 1) return;\n+\n+         // Do not flood through inbound connections which support reconciliation to save bandwidth.\n+         bool flood_to = false;\n+         if (pfrom.IsInboundConn()) {\n+             if (!recon_sender) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540472620",
      "id" : 540472620,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ3MjYyMA==",
      "original_commit_id" : "2ac6f49703abd3293f5d14f20d1eda357b093a6a",
      "original_line" : 2987,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 549563941,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540472620",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540481711"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540481711"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think if an inbound peer advertised support for both requesting sketches and responding to sketch requests, that we would then add them to our recon queue, but the comment here says that we are only doing this for outbound peers. Can you clarify the correct behavior in that situation?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-10T20:40:43Z",
      "diff_hunk" : "@@ -2559,6 +2617,62 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    // Received from an inbound peer planning to reconcilie transactions with us, or\n+    // from an outgoing peer demonstrating readiness to do reconciliations.\n+    // If received from outgoing, adds the peer to the reconciliation queue.\n+    // Feature negotiation of tx reconciliation should happen between VERSION and\n+    // VERACK, to avoid relay problems from switching after a connection is up.\n+    if (msg_type == NetMsgType::SENDRECON) {\n+        if (!pfrom.m_tx_relay) return;\n+        if (peer->m_recon_state != nullptr) return; // Do not support reconciliation salt/version updates.\n+\n+        bool recon_sender, recon_responder;\n+        uint64_t remote_salt;\n+        uint32_t recon_version;\n+        vRecv >> recon_sender >> recon_responder >> recon_version >> remote_salt;\n+        if (recon_version != 1) return;\n+\n+         // Do not flood through inbound connections which support reconciliation to save bandwidth.\n+         bool flood_to = false;\n+         if (pfrom.IsInboundConn()) {\n+             if (!recon_sender) return;\n+         } else {\n+             if (!recon_responder) return;\n+             // TODO: Flood only through a limited number of outbound connections.\n+            flood_to = true;\n+         }\n+\n+        peer->m_recon_state = MakeUnique<Peer::ReconState>();\n+        peer->m_recon_state->m_flood_to = flood_to;\n+        peer->m_recon_state->m_sender = recon_sender;\n+        peer->m_recon_state->m_responder = recon_responder;\n+        peer->m_recon_state->m_local_q = DEFAULT_RECON_Q;\n+\n+        uint64_t local_salt = peer->m_local_recon_salt;\n+\n+        std::string salt1, salt2;\n+        if (remote_salt < local_salt) {\n+            salt1 = ToString(remote_salt);\n+            salt2 = ToString(local_salt);\n+        } else {\n+            salt1 = ToString(local_salt);\n+            salt2 = ToString(remote_salt);\n+        }\n+        uint256 full_salt;\n+        CSHA256().Write((unsigned char*)RECON_STATIC_SALT.data(), RECON_STATIC_SALT.size()).\n+            Write((unsigned char*)salt1.data(), salt1.size()).\n+            Write((unsigned char*)salt2.data(), salt2.size()).\n+            Finalize(full_salt.begin());\n+        peer->m_recon_state->m_salt = full_salt;\n+\n+        // Reconcile with all outbound peers supporting reconciliation (even if we flood to them),\n+        // to not miss transactions they have for us but won't flood.\n+        if (peer->m_recon_state->m_responder) {\n+            m_recon_queue.push_back(&pfrom);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540481711",
      "id" : 540481711,
      "line" : 2990,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ4MTcxMQ==",
      "original_commit_id" : "2ac6f49703abd3293f5d14f20d1eda357b093a6a",
      "original_line" : 2990,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 349,
      "pull_request_review_id" : 549563941,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540481711",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540487984"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540487984"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If I read correctly, even in the final version of this PR this function is only invoked with flooding=true.  Can we simplify this function a bit to reflect that?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-10T20:51:43Z",
      "diff_hunk" : "@@ -827,6 +833,30 @@ static void FindNextBlocksToDownload(NodeId nodeid, unsigned int count, std::vec\n \n } // namespace\n \n+size_t PeerManager::GetTxRelayOutboundCountByRelayType(bool flooding) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540487984",
      "id" : 540487984,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ4Nzk4NA==",
      "original_commit_id" : "5db8069b5690905b2588ad3fe77548cdb2d1681e",
      "original_line" : 836,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 549563941,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540487984",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540488569"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540488569"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Style comment: I've noticed in a few places that you have one-line `if` statements; our style guide requires that if the body of the `if` isn't on the same line, then we must use curly braces.  So that's something to fix up throughout the new code.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-10T20:52:44Z",
      "diff_hunk" : "@@ -827,6 +833,30 @@ static void FindNextBlocksToDownload(NodeId nodeid, unsigned int count, std::vec\n \n } // namespace\n \n+size_t PeerManager::GetTxRelayOutboundCountByRelayType(bool flooding) const\n+{\n+    size_t result = 0;\n+    m_connman.ForEachNode([flooding, &result](CNode* pnode) {\n+        if (!pnode->m_tx_relay)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540488569",
      "id" : 540488569,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ4ODU2OQ==",
      "original_commit_id" : "5db8069b5690905b2588ad3fe77548cdb2d1681e",
      "original_line" : 840,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 549563941,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540488569",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540490244"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540490244"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I haven't quite thought through exactly how flooding works in Erlay, but I believe this logic is written so that if we configure a node to have 8 manual outbound peers in addition to the 8 full outbound relay peers, and the 8 manual peers are all assigned to be the flood peers, and then they all go offline, we would be left with 0 flood peers?  Is it a problem if we are using fewer than our 8 flood peers? \r\n\r\nIf it is, perhaps we should be considering whether to enabling flooding on a connection after an existing flood-peer disconnects?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-10T20:55:39Z",
      "diff_hunk" : "@@ -827,6 +833,30 @@ static void FindNextBlocksToDownload(NodeId nodeid, unsigned int count, std::vec\n \n } // namespace\n \n+size_t PeerManager::GetTxRelayOutboundCountByRelayType(bool flooding) const\n+{\n+    size_t result = 0;\n+    m_connman.ForEachNode([flooding, &result](CNode* pnode) {\n+        if (!pnode->m_tx_relay)\n+            return;\n+        if (!pnode->IsFullOutboundConn() && !pnode->IsManualConn())\n+            return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540490244",
      "id" : 540490244,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ5MDI0NA==",
      "original_commit_id" : "5db8069b5690905b2588ad3fe77548cdb2d1681e",
      "original_line" : 843,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 549563941,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540490244",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540493276"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540493276"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I assume you could pass this vector by (const) reference?  (And maybe all the other stuff can be passed by reference too...). ",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-10T21:00:58Z",
      "diff_hunk" : "@@ -2370,6 +2370,28 @@ static void ProcessGetCFCheckPt(CNode& peer, CDataStream& vRecv, const CChainPar\n     connman.PushMessage(&peer, std::move(msg));\n }\n \n+/**\n+ * Announce transactions a peer is missing after reconciliation is done.\n+ * No need to add transactions to peer's filter or do checks\n+ * because it was already done when adding to the reconciliation set.\n+ */\n+void static AnnounceTxs(std::vector<uint256> remote_missing_wtxids, CNode* pto, CNetMsgMaker msgMaker, CConnman* connman)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540493276",
      "id" : 540493276,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ5MzI3Ng==",
      "original_commit_id" : "9347a73f01c13a0187b7a70d5315052726ad65ac",
      "original_line" : 2378,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 549563941,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540493276",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540498519"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540498519"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: Here and in many of the loops in this PR, I think you could make these `const uint256& wtxid : ...`, to save a copy.  Won't point it out in every spot but probably could be cleaned up throughout the PR at some point.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-10T21:10:03Z",
      "diff_hunk" : "@@ -2370,6 +2370,28 @@ static void ProcessGetCFCheckPt(CNode& peer, CDataStream& vRecv, const CChainPar\n     connman.PushMessage(&peer, std::move(msg));\n }\n \n+/**\n+ * Announce transactions a peer is missing after reconciliation is done.\n+ * No need to add transactions to peer's filter or do checks\n+ * because it was already done when adding to the reconciliation set.\n+ */\n+void static AnnounceTxs(std::vector<uint256> remote_missing_wtxids, CNode* pto, CNetMsgMaker msgMaker, CConnman* connman)\n+{\n+    if (remote_missing_wtxids.size() != 0) {\n+        std::vector<CInv> remote_missing_invs;\n+        for (uint256 wtxid: remote_missing_wtxids) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540498519",
      "id" : 540498519,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ5ODUxOQ==",
      "original_commit_id" : "9347a73f01c13a0187b7a70d5315052726ad65ac",
      "original_line" : 2694,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 549563941,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540498519",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540772961"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540772961"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Haha, I was planning to bring this up later in the review cycle. I didn't expect someone to find it that fast :)\r\nYeah, what you describing is possible.\r\nPerhaps we should have a loop checking that we have enough (8) flood outbound peers, and then if not, switch some existing recon peers to flooding.\r\n\r\nWill add a commit for this.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T08:29:36Z",
      "diff_hunk" : "@@ -827,6 +833,30 @@ static void FindNextBlocksToDownload(NodeId nodeid, unsigned int count, std::vec\n \n } // namespace\n \n+size_t PeerManager::GetTxRelayOutboundCountByRelayType(bool flooding) const\n+{\n+    size_t result = 0;\n+    m_connman.ForEachNode([flooding, &result](CNode* pnode) {\n+        if (!pnode->m_tx_relay)\n+            return;\n+        if (!pnode->IsFullOutboundConn() && !pnode->IsManualConn())\n+            return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540772961",
      "id" : 540772961,
      "in_reply_to_id" : 540490244,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc3Mjk2MQ==",
      "original_commit_id" : "5db8069b5690905b2588ad3fe77548cdb2d1681e",
      "original_line" : 843,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 549890220,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540772961",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540940436"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540940436"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think a comment here explaining why we don't flood these transactions would be helpful.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T13:18:30Z",
      "diff_hunk" : "@@ -917,7 +935,7 @@ void PeerManager::ReattemptInitialBroadcast(CScheduler& scheduler) const\n \n         if (tx != nullptr) {\n             LOCK(cs_main);\n-            RelayTransaction(txid, tx->GetWitnessHash(), m_connman);\n+            RelayTransaction(txid, tx->GetWitnessHash(), m_connman, false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540940436",
      "id" : 540940436,
      "line" : 1064,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk0MDQzNg==",
      "original_commit_id" : "e8fd1cb590161e88b64b2e20d3113310390e68a5",
      "original_line" : 1064,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 188,
      "pull_request_review_id" : 550089271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540940436",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540945952"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540945952"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Here, if a peer doesn't support reconciliation, then the `flood` bool doesn't matter, we'll always flood -- right?  If that's correct, perhaps we could either set flood=true for all non-reconciliation peers, or leave a comment that explains that the parameter doesn't matter in this case.\r\n",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T13:27:50Z",
      "diff_hunk" : "@@ -1525,17 +1543,17 @@ bool static AlreadyHaveBlock(const uint256& block_hash) EXCLUSIVE_LOCKS_REQUIRED\n     return LookupBlockIndex(block_hash) != nullptr;\n }\n \n-void RelayTransaction(const uint256& txid, const uint256& wtxid, const CConnman& connman)\n+void RelayTransaction(const uint256& txid, const uint256& wtxid, const CConnman& connman, bool flood)\n {\n-    connman.ForEachNode([&txid, &wtxid](CNode* pnode) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    connman.ForEachNode([&txid, &wtxid, flood](CNode* pnode) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n         AssertLockHeld(::cs_main);\n \n         CNodeState* state = State(pnode->GetId());\n         if (state == nullptr) return;\n         if (state->m_wtxid_relay) {\n-            pnode->PushTxInventory(wtxid);\n+            pnode->PushTxInventory(wtxid, flood);\n         } else {\n-            pnode->PushTxInventory(txid);\n+            pnode->PushTxInventory(txid, flood);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540945952",
      "id" : 540945952,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk0NTk1Mg==",
      "original_commit_id" : "e8fd1cb590161e88b64b2e20d3113310390e68a5",
      "original_line" : 1830,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 550089271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540945952",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540947160"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540947160"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We track where we got the orphan from; should we use that to determine whether to flood (rather than setting `flood=true` for all orphans)?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T13:29:49Z",
      "diff_hunk" : "@@ -2087,7 +2105,7 @@ void PeerManager::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n \n         if (AcceptToMemoryPool(m_mempool, state, porphanTx, &removed_txn, false /* bypass_limits */)) {\n             LogPrint(BCLog::MEMPOOL, \"   accepted orphan tx %s\\n\", orphanHash.ToString());\n-            RelayTransaction(orphanHash, porphanTx->GetWitnessHash(), m_connman);\n+            RelayTransaction(orphanHash, porphanTx->GetWitnessHash(), m_connman, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540947160",
      "id" : 540947160,
      "line" : 2298,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk0NzE2MA==",
      "original_commit_id" : "e8fd1cb590161e88b64b2e20d3113310390e68a5",
      "original_line" : 2298,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 233,
      "pull_request_review_id" : 550089271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540947160",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540951635"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540951635"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can we make this const and just always initialize it when a `Peer` object is created?  Then we could avoid having to worry about locking issues with this (right now it seems like there should be some kind of lock that guards it).",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T13:37:13Z",
      "diff_hunk" : "@@ -452,6 +452,15 @@ struct Peer {\n     std::deque<CInv> m_getdata_requests GUARDED_BY(m_getdata_requests_mutex);\n \n     explicit Peer(NodeId id) : m_id(id) {}\n+\n+    /**\n+     * Salt used to compute short IDs during transaction reconciliation.\n+     * Salt is generated randomly per-connection to prevent linking of\n+     * connections belonging to the same physical node.\n+     * Also, salts should be different per-connection to prevent halting\n+     * of relay of particular transactions due to collisions in short IDs.\n+     */\n+    uint64_t m_local_recon_salt;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540951635",
      "id" : 540951635,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk1MTYzNQ==",
      "original_commit_id" : "ed736b0c3892c50ba0697cad8d8b031b468fe3fd",
      "original_line" : 523,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 550089271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540951635",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540953528"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540953528"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this probably should have a lock that protects access to this object?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T13:40:10Z",
      "diff_hunk" : "@@ -461,6 +465,60 @@ struct Peer {\n      * of relay of particular transactions due to collisions in short IDs.\n      */\n     uint64_t m_local_recon_salt;\n+\n+    /**\n+     * This struct is used to keep track of the reconciliations with a given peer.\n+     * Transaction reconciliation means an efficient synchronization of the known\n+     * transactions between a pair of peers.\n+     * One reconciliation round consists of a sequence of messages. The sequence is\n+     * asymmetrical, there is always a requestor and a responder. At the end of the\n+     * sequence, nodes are supposed to exchange transactions, so that both of them\n+     * have all relevant transactions. For more protocol details, refer to BIP-0330.\n+     */\n+    struct ReconState {\n+        ReconState(){};\n+\n+        /// Whether this peer will send reconciliation requests.\n+        bool m_sender;\n+\n+        /// Whether this peer will respond to reconciliation requests.\n+        bool m_responder;\n+\n+        /**\n+         * Whether we should flood transactions to the peer.\n+         * Reconciliation between two nodes does not prevent these nodes\n+         * from flooding transactions to each other.\n+         * Selective flooding of transactions to only specific peers makes\n+         * transaction relay significantly faster.\n+         */\n+        bool m_flood_to;\n+\n+        /**\n+         * Reconciliation involves computing and transmitting sketches,\n+         * which is a bandwidth-efficient representation of transaction IDs.\n+         * Since computing sketches over full txID is too CPU-expensive,\n+         * they will be computed over shortened IDs instead.\n+         * These short IDs will be salted so that they are not the same\n+         * across all pairs of peers, because otherwise it would enable network-wide\n+         * collisions which may (intentionally or not) halt relay of certain transactions.\n+         * Both of the peers contribute to the salt.\n+         */\n+        uint256 m_salt;\n+\n+        /**\n+         * Computing a set reconciliation sketch involves estimating the difference\n+         * between sets of transactions on two sides of the connection. More specifically,\n+         * a sketch capacity is computed as\n+         * |set_size - local_set_size| + q * (set_size + local_set_size) + c,\n+         * where c is a small constant, and q is a node+connection-specific coefficient.\n+         * This coefficient is recomputed by every node based on its previous reconciliations,\n+         * to better predict future set size differences.\n+         */\n+        double m_local_q;\n+    };\n+\n+    /// nullptr if we're not reconciling (neither passively nor actively) with this peer.\n+    std::unique_ptr<ReconState> m_recon_state;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540953528",
      "id" : 540953528,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk1MzUyOA==",
      "original_commit_id" : "489c98c0778e424ff359dd587ef20fa820e246f4",
      "original_line" : 806,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 550089271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540953528",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540954946"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540954946"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: perhaps the constructor can take initial values for all the members, so there's no risk that the members go uninitialized?  It looks like the way you are currently using this is to instantiate the object and immediately set everything, so I think this would be an easy change.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T13:42:26Z",
      "diff_hunk" : "@@ -461,6 +465,60 @@ struct Peer {\n      * of relay of particular transactions due to collisions in short IDs.\n      */\n     uint64_t m_local_recon_salt;\n+\n+    /**\n+     * This struct is used to keep track of the reconciliations with a given peer.\n+     * Transaction reconciliation means an efficient synchronization of the known\n+     * transactions between a pair of peers.\n+     * One reconciliation round consists of a sequence of messages. The sequence is\n+     * asymmetrical, there is always a requestor and a responder. At the end of the\n+     * sequence, nodes are supposed to exchange transactions, so that both of them\n+     * have all relevant transactions. For more protocol details, refer to BIP-0330.\n+     */\n+    struct ReconState {\n+        ReconState(){};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540954946",
      "id" : 540954946,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk1NDk0Ng==",
      "original_commit_id" : "489c98c0778e424ff359dd587ef20fa820e246f4",
      "original_line" : 535,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 550089271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540954946",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540955695"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540955695"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this probably needs a lock to synchronize access to this?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T13:43:36Z",
      "diff_hunk" : "@@ -143,6 +143,14 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n     TxRequestTracker m_txrequest GUARDED_BY(::cs_main);\n \n     int64_t m_stale_tip_check_time; //!< Next time to check for stale tip\n+\n+    /**\n+     * Transaction reconciliation should happen with peers in the same order,\n+     * because the efficiency gain is the highest when reconciliation set difference\n+     * is predictable. This queue is used to maintain the order of\n+     * peers chosen for reconciliation.\n+     */\n+    std::deque<CNode*> m_recon_queue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r540955695",
      "id" : 540955695,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDk1NTY5NQ==",
      "original_commit_id" : "489c98c0778e424ff359dd587ef20fa820e246f4",
      "original_line" : 162,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 550089271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/540955695",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541017754"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541017754"
         }
      },
      "author_association" : "MEMBER",
      "body" : "So inbound peers that are reconciling with us effectively get their own poisson timer -- can you explain why this is an ok change?  \r\n\r\nIt seems like an inbound peer that constantly tries to reconcile with us could be a more effective spy than before this change, but maybe I'm missing something.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T15:14:13Z",
      "diff_hunk" : "@@ -4504,11 +4528,11 @@ bool PeerManager::SendMessages(CNode* pto)\n                 bool fSendTrickle = pto->HasPermission(PF_NOBAN);\n                 if (pto->m_tx_relay->nNextInvSend < current_time) {\n                     fSendTrickle = true;\n-                    if (pto->IsInboundConn()) {\n-                        pto->m_tx_relay->nNextInvSend = std::chrono::microseconds{m_connman.PoissonNextSendInbound(count_microseconds(current_time), INVENTORY_BROADCAST_INTERVAL)};\n-                    } else {\n-                        // Use half the delay for outbound peers, as there is less privacy concern for them.\n+                    if (peer->m_recon_state || !pto->IsInboundConn()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541017754",
      "id" : 541017754,
      "line" : 4948,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTAxNzc1NA==",
      "original_commit_id" : "e8fd1cb590161e88b64b2e20d3113310390e68a5",
      "original_line" : 4948,
      "original_position" : 125,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 560,
      "pull_request_review_id" : 550089271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541017754",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541019792"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541019792"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Also, it might be helpful for code readers if the way we check to see if we're reconciling with a peer is to call a function that explains that better (`peer->ReconEnabled()` or something), than checking to see if the `m_recon_state` object is a nullptr or not. But that's just a style nit, you can take it or leave it.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T15:17:04Z",
      "diff_hunk" : "@@ -4504,11 +4528,11 @@ bool PeerManager::SendMessages(CNode* pto)\n                 bool fSendTrickle = pto->HasPermission(PF_NOBAN);\n                 if (pto->m_tx_relay->nNextInvSend < current_time) {\n                     fSendTrickle = true;\n-                    if (pto->IsInboundConn()) {\n-                        pto->m_tx_relay->nNextInvSend = std::chrono::microseconds{m_connman.PoissonNextSendInbound(count_microseconds(current_time), INVENTORY_BROADCAST_INTERVAL)};\n-                    } else {\n-                        // Use half the delay for outbound peers, as there is less privacy concern for them.\n+                    if (peer->m_recon_state || !pto->IsInboundConn()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541019792",
      "id" : 541019792,
      "in_reply_to_id" : 541017754,
      "line" : 4948,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTAxOTc5Mg==",
      "original_commit_id" : "e8fd1cb590161e88b64b2e20d3113310390e68a5",
      "original_line" : 4948,
      "original_position" : 125,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 560,
      "pull_request_review_id" : 550089271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541019792",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541025191"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541025191"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If we're reconciling with a peer, does it make sense to limit this loop to `INVENTORY_BROADCAST_MAX` transactions?  That is primarily a bandwidth throttling behavior, not a privacy behavior -- and since reconciliation is already bandwidth reducing itself, it might be beneficial to throw more things into the sketch sooner? \r\n\r\nOn the other hand, maybe it works out just fine if both parties are throttling like this and will have similarly sized sketches anyway...  Depends a bit on how much variation there might be between the number of times each side's poisson timer could fire in the window between reconciliations?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T15:24:37Z",
      "diff_hunk" : "@@ -4598,9 +4623,17 @@ bool PeerManager::SendMessages(CNode* pto)\n                             continue;\n                         }\n                         if (pto->m_tx_relay->pfilter && !pto->m_tx_relay->pfilter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n-                        // Send\n+\n+                        bool flood_tx = it->second;\n+                        if (!peer->m_recon_state || (peer->m_recon_state->m_flood_to && flood_tx))\n+                            // Always flood to non-reconciliation nodes supporting tx relay.\n+                            // For reconciliation nodes, flood if flood_to is set up and transaction is meant for flooding.\n+                            vInv.push_back(inv);\n+                        else {\n+                            // Storing to populate the reconciliation set.\n+                            txs_to_reconcile.push_back(txinfo.tx->GetWitnessHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541025191",
      "id" : 541025191,
      "line" : 5043,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTAyNTE5MQ==",
      "original_commit_id" : "e8fd1cb590161e88b64b2e20d3113310390e68a5",
      "original_line" : 5043,
      "original_position" : 171,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 628,
      "pull_request_review_id" : 550089271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541025191",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541028803"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541028803"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Would it make more sense perhaps to announce the earliest transactions in the queue, rather than the most recent ones?  \r\n\r\nIt's possible this logic is fairly optimal, but here is what I was concerned about:\r\n- an inbound adversary could negotiate erlay support but then never send a reconciliation request, and so this queue fills up until we start just inv'ing them everything new anyway. Since we reduce the poisson timer for peers we think we're reconciling with, this could be a way to game a quicker INV time to be a better spy node.\r\n  * this doesn't seem to actually work because they'd have to wait for 2 poisson timers to go off before getting the prior batch of announcements, which is approximately the same (other than integer division) as the same inv timer that inbound peers normally get. Though perhaps this would get them their own poisson timer, rather than having to use the bucket that all inbounds share?  That seems not great -- an adversary could use multiple inbound connections this way to effectively get a small poisson timer (on average).\r\n\r\n- Countervailing idea is that if the peer is just held up for some reason, the older transactions are more likely to reconcile successfully than the newest ones, so it's probably bandwidth minimizing in the honest case to hang on to the older ones in the reconciliation set.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T15:29:37Z",
      "diff_hunk" : "@@ -4634,6 +4667,28 @@ bool PeerManager::SendMessages(CNode* pto)\n                             pto->m_tx_relay->filterInventoryKnown.insert(txid);\n                         }\n                     }\n+\n+                    // Populating local reconciliation set.\n+                    if (peer->m_recon_state && txs_to_reconcile.size() != 0) {\n+                        assert(peer->m_recon_state->m_sender || peer->m_recon_state->m_responder);\n+                        int64_t recon_set_overflow = peer->m_recon_state->m_local_set.size() + txs_to_reconcile.size() - MAX_RECON_SET;\n+                        if (recon_set_overflow > 0) {\n+                            LogPrint(BCLog::NET, \"Reconciliation set for the peer=%d is at capacity, not adding new transactions. \\n\", pto->GetId());\n+                            // Since we reconcile frequently, it either means:\n+                            // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+                            // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+                            // We don't care about a laggy peer (1) because we probably can't help them even if we flood transactions.\n+                            // However, exploiting (2) should not prevent us from relaying certain transactions.\n+                            // Since computing a sketch over too many elements is too expensive, we will just flood some transactions here.\n+                            std::vector<uint256> txs_to_flood = std::vector<uint256>(txs_to_reconcile.end() - recon_set_overflow, txs_to_reconcile.end());\n+                            txs_to_reconcile.resize(txs_to_reconcile.size() - recon_set_overflow);\n+                            AnnounceTxs(txs_to_flood, *pto, msgMaker, m_connman);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541028803",
      "id" : 541028803,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTAyODgwMw==",
      "original_commit_id" : "e8fd1cb590161e88b64b2e20d3113310390e68a5",
      "original_line" : 4880,
      "original_position" : 197,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 550089271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541028803",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541031015"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541031015"
         }
      },
      "author_association" : "MEMBER",
      "body" : "FYI, I believe that because this number used to be odd, the ratio of announcement delay to inbound versus outbound peers will change from 2.5 in the old code to 2 in the new code.  Not sure if that is cause for any concern though.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T15:32:44Z",
      "diff_hunk" : "@@ -123,12 +123,12 @@ static constexpr std::chrono::hours AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL{24};\n static constexpr std::chrono::seconds AVG_ADDRESS_BROADCAST_INTERVAL{30};\n /** Average delay between trickled inventory transmissions in seconds.\n  *  Blocks and peers with noban permission bypass this, outbound peers get half this delay. */\n-static const unsigned int INVENTORY_BROADCAST_INTERVAL = 5;\n+static const unsigned int INVENTORY_BROADCAST_INTERVAL = 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541031015",
      "id" : 541031015,
      "line" : 135,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTAzMTAxNQ==",
      "original_commit_id" : "9832017da275614664e30532d9ac7882d30f1bb6",
      "original_line" : 135,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 29,
      "pull_request_review_id" : 550089271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541031015",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541032397"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541032397"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can you explain why this needs to change, and how you arrived at multiplying by 4?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T15:34:34Z",
      "diff_hunk" : "@@ -123,12 +123,12 @@ static constexpr std::chrono::hours AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL{24};\n static constexpr std::chrono::seconds AVG_ADDRESS_BROADCAST_INTERVAL{30};\n /** Average delay between trickled inventory transmissions in seconds.\n  *  Blocks and peers with noban permission bypass this, outbound peers get half this delay. */\n-static const unsigned int INVENTORY_BROADCAST_INTERVAL = 5;\n+static const unsigned int INVENTORY_BROADCAST_INTERVAL = 2;\n /** Maximum rate of inventory items to send per second.\n  *  Limits the impact of low-fee transaction floods. */\n static constexpr unsigned int INVENTORY_BROADCAST_PER_SECOND = 7;\n /** Maximum number of inventory items to send per transmission. */\n-static constexpr unsigned int INVENTORY_BROADCAST_MAX = INVENTORY_BROADCAST_PER_SECOND * INVENTORY_BROADCAST_INTERVAL;\n+static constexpr unsigned int INVENTORY_BROADCAST_MAX = INVENTORY_BROADCAST_PER_SECOND * INVENTORY_BROADCAST_INTERVAL * 4;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541032397",
      "id" : 541032397,
      "line" : 140,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTAzMjM5Nw==",
      "original_commit_id" : "9832017da275614664e30532d9ac7882d30f1bb6",
      "original_line" : 140,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 35,
      "pull_request_review_id" : 550089271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541032397",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541041135"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541041135"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah, I didn't realize we respond to these asynchronously. If this isn't already in the BIP, perhaps it would be helpful to specify there that reconciliation responses are not guaranteed to be sent out in sync with other messages peers might send (such as pings, getdata, etc)?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T15:46:24Z",
      "diff_hunk" : "@@ -176,6 +176,12 @@ static const unsigned int MAX_RECON_SET = 10000;\n  * Less frequent reconciliations would introduce high transaction relay latency.\n  */\n static constexpr std::chrono::microseconds RECON_REQUEST_INTERVAL{std::chrono::seconds{16}};\n+/**\n+ * Interval between responding to peers' reconciliation requests.\n+ * We don't respond to reconciliation requests right away because that would enable monitoring\n+ * when we receive transactions (privacy leak).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541041135",
      "id" : 541041135,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA0MTEzNQ==",
      "original_commit_id" : "3fc23c90edec1faaf61714272cc04c69fda811ca",
      "original_line" : 177,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 550089271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541041135",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541044473"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541044473"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should we snapshot our reconciliation set as of when we receive this request?  If we have a fixed delay and no snapshot, then I'm not sure how much privacy we gain by the 2 second delay (other than from throttling reconciliation requests from a single peer).",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T15:51:09Z",
      "diff_hunk" : "@@ -3993,6 +4028,22 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    std::chrono::microseconds current_time = GetTime<std::chrono::microseconds>();\n+\n+    // Record an (expected) reconciliation request with parameters to respond when time comes.\n+    // All initial reconciliation responses will be done at the same time to prevent tx-related privacy leaks.\n+    if (msg_type == NetMsgType::REQRECON) {\n+        if (peer->m_recon_state == nullptr) return;\n+        if (!peer->m_recon_state->m_sender) return;\n+        if (peer->m_recon_state->m_incoming_recon != Peer::ReconState::ReconPhase::NONE) return;\n+        uint16_t peer_recon_set_size, peer_q;\n+        vRecv >> peer_recon_set_size >> peer_q;\n+        peer->m_recon_state->m_incoming_recon = Peer::ReconState::ReconPhase::INIT_REQUESTED;\n+        peer->m_recon_state->m_remote_set_size = peer_recon_set_size;\n+        peer->m_recon_state->m_remote_q = double(peer_q / Q_PRECISION);\n+        peer->m_recon_state->m_next_recon_respond = NextReconRespond(current_time);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541044473",
      "id" : 541044473,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA0NDQ3Mw==",
      "original_commit_id" : "3fc23c90edec1faaf61714272cc04c69fda811ca",
      "original_line" : 4181,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 550089271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541044473",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541049259"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541049259"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We should try to figure out a better way to organize all these constants and the complexity of the logic away from the rest of `net_processing` -- not sure yet what to suggest but wanted to flag that this is now quite a lot of esoteric stuff we're adding to the top of this file.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T15:57:55Z",
      "diff_hunk" : "@@ -182,6 +183,20 @@ static constexpr std::chrono::microseconds RECON_REQUEST_INTERVAL{std::chrono::s\n  * when we receive transactions (privacy leak).\n  */\n static constexpr std::chrono::microseconds RECON_RESPONSE_INTERVAL{std::chrono::seconds{2}};\n+/** The size of the field, used to compute sketches to reconcile transactions (see BIP-330). */\n+static constexpr unsigned int RECON_FIELD_SIZE = 32;\n+static_assert(RECON_FIELD_SIZE % 8 == 0, \"Field size should be divisible by 8\");\n+static constexpr unsigned int BYTES_PER_SKETCH_CAPACITY = RECON_FIELD_SIZE / 8;\n+static constexpr uint16_t MAX_SKETCH_CAPACITY = 2 << 12;\n+/**\n+* It is possible that if sketch encodes more elements than the capacity, or\n+* if it is constructed of random bytes, sketch decoding may \"succeed\",\n+* but the result will be nonsense (false-positive decoding).\n+* Given this coef, a false positive probability will be of 1 in 2**coef.\n+*/\n+static constexpr unsigned int RECON_FALSE_POSITIVE_COEF = 16;\n+static_assert(RECON_FALSE_POSITIVE_COEF <= 256,\n+    \"Reducing reconciliation false positives beyond 1 in 2**256 is not supported\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541049259",
      "id" : 541049259,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA0OTI1OQ==",
      "original_commit_id" : "43f06991b5c2794a81b8f7cca25bf49c1573078c",
      "original_line" : 197,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 550089271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541049259",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541059908"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541059908"
         }
      },
      "author_association" : "MEMBER",
      "body" : "spelling nit: possession ",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T16:14:00Z",
      "diff_hunk" : "@@ -4869,6 +4869,32 @@ bool PeerManager::SendMessages(CNode* pto)\n             }\n         }\n \n+        //\n+        // Message: reconciliation response\n+        //\n+        if (peer->m_recon_state) {\n+            // Respond to a requested reconciliation to enable efficient transaction exchange.\n+            // Respond only periodically to a) limit CPU usage for sketch computation,\n+            // and, b) limit transaction posesssion privacy leak.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541059908",
      "id" : 541059908,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA1OTkwOA==",
      "original_commit_id" : "516251924950287d2bc1ae8d880ac11db077526b",
      "original_line" : 5180,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 550089271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541059908",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541061891"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541061891"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Do we need to invoke `minisketch_destroy` on the `response_sketch` to avoid leaking memory?\r\n\r\nI'm also confused about why we need to serialize the sketch into a temporary array and then move it into another vector before sending our response.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T16:16:53Z",
      "diff_hunk" : "@@ -4869,6 +4869,32 @@ bool PeerManager::SendMessages(CNode* pto)\n             }\n         }\n \n+        //\n+        // Message: reconciliation response\n+        //\n+        if (peer->m_recon_state) {\n+            // Respond to a requested reconciliation to enable efficient transaction exchange.\n+            // Respond only periodically to a) limit CPU usage for sketch computation,\n+            // and, b) limit transaction posesssion privacy leak.\n+            if (peer->m_recon_state->m_incoming_recon == Peer::ReconState::ReconPhase::INIT_REQUESTED && current_time > peer->m_recon_state->m_next_recon_respond) {\n+                std::vector<uint8_t> response_skdata;\n+                uint16_t sketch_capacity = peer->m_recon_state->EstimateSketchCapacity();\n+                minisketch* response_sketch = peer->m_recon_state->ComputeSketch(peer->m_recon_state->m_local_set, sketch_capacity);\n+                if (response_sketch != nullptr) {\n+                    // It is possible to create a sketch if we had at least one transaction to send to the peer.\n+                    size_t ser_size = minisketch_serialized_size(response_sketch);\n+                    uint8_t skdata[MAX_SKETCH_CAPACITY * BYTES_PER_SKETCH_CAPACITY];\n+                    minisketch_serialize(response_sketch, skdata);\n+                    response_skdata.resize(ser_size);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541061891",
      "id" : 541061891,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA2MTg5MQ==",
      "original_commit_id" : "516251924950287d2bc1ae8d880ac11db077526b",
      "original_line" : 4888,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 550089271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541061891",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541063971"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541063971"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I thought we needed to hang on to a snapshot of this in order to respond to sketch-extension requests?\r\n\r\nEDIT: Ah, this happens in a later commit.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T16:20:03Z",
      "diff_hunk" : "@@ -4869,6 +4869,32 @@ bool PeerManager::SendMessages(CNode* pto)\n             }\n         }\n \n+        //\n+        // Message: reconciliation response\n+        //\n+        if (peer->m_recon_state) {\n+            // Respond to a requested reconciliation to enable efficient transaction exchange.\n+            // Respond only periodically to a) limit CPU usage for sketch computation,\n+            // and, b) limit transaction posesssion privacy leak.\n+            if (peer->m_recon_state->m_incoming_recon == Peer::ReconState::ReconPhase::INIT_REQUESTED && current_time > peer->m_recon_state->m_next_recon_respond) {\n+                std::vector<uint8_t> response_skdata;\n+                uint16_t sketch_capacity = peer->m_recon_state->EstimateSketchCapacity();\n+                minisketch* response_sketch = peer->m_recon_state->ComputeSketch(peer->m_recon_state->m_local_set, sketch_capacity);\n+                if (response_sketch != nullptr) {\n+                    // It is possible to create a sketch if we had at least one transaction to send to the peer.\n+                    size_t ser_size = minisketch_serialized_size(response_sketch);\n+                    uint8_t skdata[MAX_SKETCH_CAPACITY * BYTES_PER_SKETCH_CAPACITY];\n+                    minisketch_serialize(response_sketch, skdata);\n+                    response_skdata.resize(ser_size);\n+                    std::copy(skdata, skdata + ser_size, response_skdata.begin());\n+                }\n+                m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::SKETCH, response_skdata));\n+\n+                peer->m_recon_state->m_incoming_recon = Peer::ReconState::ReconPhase::INIT_RESPONDED;\n+                peer->m_recon_state->m_local_set.clear();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541063971",
      "id" : 541063971,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA2Mzk3MQ==",
      "original_commit_id" : "516251924950287d2bc1ae8d880ac11db077526b",
      "original_line" : 4894,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 550089271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541063971",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541097407"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541097407"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed this in the first batch of commits, will also fix for the rest.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T17:10:12Z",
      "diff_hunk" : "@@ -827,6 +833,30 @@ static void FindNextBlocksToDownload(NodeId nodeid, unsigned int count, std::vec\n \n } // namespace\n \n+size_t PeerManager::GetTxRelayOutboundCountByRelayType(bool flooding) const\n+{\n+    size_t result = 0;\n+    m_connman.ForEachNode([flooding, &result](CNode* pnode) {\n+        if (!pnode->m_tx_relay)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541097407",
      "id" : 541097407,
      "in_reply_to_id" : 540488569,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTA5NzQwNw==",
      "original_commit_id" : "5db8069b5690905b2588ad3fe77548cdb2d1681e",
      "original_line" : 840,
      "original_position" : 21,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 550306249,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541097407",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541103154"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541103154"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Probably gonna be restrictive for now.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T17:19:36Z",
      "diff_hunk" : "@@ -2559,6 +2617,62 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    // Received from an inbound peer planning to reconcilie transactions with us, or\n+    // from an outgoing peer demonstrating readiness to do reconciliations.\n+    // If received from outgoing, adds the peer to the reconciliation queue.\n+    // Feature negotiation of tx reconciliation should happen between VERSION and\n+    // VERACK, to avoid relay problems from switching after a connection is up.\n+    if (msg_type == NetMsgType::SENDRECON) {\n+        if (!pfrom.m_tx_relay) return;\n+        if (peer->m_recon_state != nullptr) return; // Do not support reconciliation salt/version updates.\n+\n+        bool recon_sender, recon_responder;\n+        uint64_t remote_salt;\n+        uint32_t recon_version;\n+        vRecv >> recon_sender >> recon_responder >> recon_version >> remote_salt;\n+        if (recon_version != 1) return;\n+\n+         // Do not flood through inbound connections which support reconciliation to save bandwidth.\n+         bool flood_to = false;\n+         if (pfrom.IsInboundConn()) {\n+             if (!recon_sender) return;\n+         } else {\n+             if (!recon_responder) return;\n+             // TODO: Flood only through a limited number of outbound connections.\n+            flood_to = true;\n+         }\n+\n+        peer->m_recon_state = MakeUnique<Peer::ReconState>();\n+        peer->m_recon_state->m_flood_to = flood_to;\n+        peer->m_recon_state->m_sender = recon_sender;\n+        peer->m_recon_state->m_responder = recon_responder;\n+        peer->m_recon_state->m_local_q = DEFAULT_RECON_Q;\n+\n+        uint64_t local_salt = peer->m_local_recon_salt;\n+\n+        std::string salt1, salt2;\n+        if (remote_salt < local_salt) {\n+            salt1 = ToString(remote_salt);\n+            salt2 = ToString(local_salt);\n+        } else {\n+            salt1 = ToString(local_salt);\n+            salt2 = ToString(remote_salt);\n+        }\n+        uint256 full_salt;\n+        CSHA256().Write((unsigned char*)RECON_STATIC_SALT.data(), RECON_STATIC_SALT.size()).\n+            Write((unsigned char*)salt1.data(), salt1.size()).\n+            Write((unsigned char*)salt2.data(), salt2.size()).\n+            Finalize(full_salt.begin());\n+        peer->m_recon_state->m_salt = full_salt;\n+\n+        // Reconcile with all outbound peers supporting reconciliation (even if we flood to them),\n+        // to not miss transactions they have for us but won't flood.\n+        if (peer->m_recon_state->m_responder) {\n+            m_recon_queue.push_back(&pfrom);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541103154",
      "id" : 541103154,
      "in_reply_to_id" : 540481711,
      "line" : 2990,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEwMzE1NA==",
      "original_commit_id" : "2ac6f49703abd3293f5d14f20d1eda357b093a6a",
      "original_line" : 2990,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 349,
      "pull_request_review_id" : 550319793,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541103154",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541103641"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541103641"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Updating the code and the BIP",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T17:20:29Z",
      "diff_hunk" : "@@ -2559,6 +2617,62 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    // Received from an inbound peer planning to reconcilie transactions with us, or\n+    // from an outgoing peer demonstrating readiness to do reconciliations.\n+    // If received from outgoing, adds the peer to the reconciliation queue.\n+    // Feature negotiation of tx reconciliation should happen between VERSION and\n+    // VERACK, to avoid relay problems from switching after a connection is up.\n+    if (msg_type == NetMsgType::SENDRECON) {\n+        if (!pfrom.m_tx_relay) return;\n+        if (peer->m_recon_state != nullptr) return; // Do not support reconciliation salt/version updates.\n+\n+        bool recon_sender, recon_responder;\n+        uint64_t remote_salt;\n+        uint32_t recon_version;\n+        vRecv >> recon_sender >> recon_responder >> recon_version >> remote_salt;\n+        if (recon_version != 1) return;\n+\n+         // Do not flood through inbound connections which support reconciliation to save bandwidth.\n+         bool flood_to = false;\n+         if (pfrom.IsInboundConn()) {\n+             if (!recon_sender) return;\n+         } else {\n+             if (!recon_responder) return;\n+             // TODO: Flood only through a limited number of outbound connections.\n+            flood_to = true;\n+         }\n+\n+        peer->m_recon_state = MakeUnique<Peer::ReconState>();\n+        peer->m_recon_state->m_flood_to = flood_to;\n+        peer->m_recon_state->m_sender = recon_sender;\n+        peer->m_recon_state->m_responder = recon_responder;\n+        peer->m_recon_state->m_local_q = DEFAULT_RECON_Q;\n+\n+        uint64_t local_salt = peer->m_local_recon_salt;\n+\n+        std::string salt1, salt2;\n+        if (remote_salt < local_salt) {\n+            salt1 = ToString(remote_salt);\n+            salt2 = ToString(local_salt);\n+        } else {\n+            salt1 = ToString(local_salt);\n+            salt2 = ToString(remote_salt);\n+        }\n+        uint256 full_salt;\n+        CSHA256().Write((unsigned char*)RECON_STATIC_SALT.data(), RECON_STATIC_SALT.size()).\n+            Write((unsigned char*)salt1.data(), salt1.size()).\n+            Write((unsigned char*)salt2.data(), salt2.size()).\n+            Finalize(full_salt.begin());\n+        peer->m_recon_state->m_salt = full_salt;\n+\n+        // Reconcile with all outbound peers supporting reconciliation (even if we flood to them),\n+        // to not miss transactions they have for us but won't flood.\n+        if (peer->m_recon_state->m_responder) {\n+            m_recon_queue.push_back(&pfrom);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541103641",
      "id" : 541103641,
      "in_reply_to_id" : 540481711,
      "line" : 2990,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEwMzY0MQ==",
      "original_commit_id" : "2ac6f49703abd3293f5d14f20d1eda357b093a6a",
      "original_line" : 2990,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 349,
      "pull_request_review_id" : 550321029,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541103641",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541116815"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541116815"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This assert worried me a bit, since I figured that the `FinalizeReconciliation` could be triggered by a peer with a `reconcildiff` message without having sent a previous `reqreconcil`.  It looks like there is a guard to prevent that from happening, but it's not clear to me that `assert()` is what we want here.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T17:42:01Z",
      "diff_hunk" : "@@ -661,6 +661,58 @@ struct Peer {\n             }\n             return sketch;\n         }\n+\n+        /**\n+         * After a reconciliation round is over, the local q coefficient may be adjusted to enable\n+         * better accuracy of future set difference estimations.\n+         * Recompute q in case of full reconciliation success (both initially or after extension).\n+         * In case reconciliation completely failed (initial and extension), fallback to the default q,\n+         * set to cause an overestimation, but should converge to the reasonable q in the next round.\n+         * Note that accurate recompute in case of complete failure is difficult, because it requires waiting for GETDATA/INV\n+         * the peer would send to us, and find the actual difference from there (also may be inaccurate due to the latencies).\n+         */\n+        enum LocalQAction {\n+            Q_KEEP,\n+            Q_RECOMPUTE,\n+            Q_SET_DEFAULT\n+        };\n+\n+        /**\n+         * Clears the state of the peer when the reconciliation is done.\n+         * If this is a extension finalization, keep the reconciliation set to track\n+         * the transactions received from other peers during the reconciliation.\n+         * Also keep the set if this if finalizing initial incoming reconciliation, because\n+         * there was a time frame when we sent out an initial sketch until peer responded.\n+         * If we're finalizing initial outgoing reconciliation, it is safe to clear the set,\n+         * because we do not use the snapshot, but sketch the original set (which might have received\n+         * few new transactions), and finalize the reconciliation immediately.\n+         */\n+        void FinalizeReconciliation(bool clear_local_set, LocalQAction action, size_t actual_local_missing, size_t actual_remote_missing)\n+        {\n+            // According to the erlay spec, reconciliation is initiated by inbound peers.\n+            if (m_sender) {\n+                assert(m_incoming_recon != ReconPhase::NONE);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541116815",
      "id" : 541116815,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTExNjgxNQ==",
      "original_commit_id" : "e0627a74733bd24f23e506d1e33589155d96c2c0",
      "original_line" : 742,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 550089271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541116815",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541120337"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541120337"
         }
      },
      "author_association" : "MEMBER",
      "body" : "So -- this logic means that we won't do any reconciliation with peers if their sender/responder settings don't match exactly what we expect inbound and outbound peers to do.  Should we add some sort of acknowledgement message so that both sides know whether reconciliation is enabled on the link?\r\n\r\nOur own logic seems to change based on whether we *think* we're reconciling with a peer; if some other implementation turns on both sending and responding (for instance) and then we silently ignore all their reconciliation requests, that seems suboptimal for everyone.  Likewise, if we think we've enabled reconciliation with a peer but it has a different policy, it would be better for our software to know that reconciliation isn't going to actually happen.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T17:47:40Z",
      "diff_hunk" : "@@ -2562,6 +2620,74 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    // Received from an inbound peer planning to reconcile transactions with us, or\n+    // from an outgoing peer demonstrating readiness to do reconciliations.\n+    // If received from outgoing, adds the peer to the reconciliation queue.\n+    // Feature negotiation of tx reconciliation should happen between VERSION and\n+    // VERACK, to avoid relay problems from switching after a connection is up.\n+    if (msg_type == NetMsgType::SENDRECON) {\n+        if (!pfrom.m_tx_relay) return;\n+        if (peer->m_recon_state != nullptr) return; // Do not support reconciliation salt/version updates.\n+        LOCK(cs_main);\n+        if (!State(pfrom.GetId())->m_wtxid_relay) return; // SENDRECON is allowed only after WTXIDRELAY.\n+\n+        bool recon_sender, recon_responder;\n+        uint64_t remote_salt;\n+        uint32_t recon_version;\n+        vRecv >> recon_sender >> recon_responder >> recon_version >> remote_salt;\n+        if (recon_version != 1) return;\n+\n+        // Do not flood through inbound connections which support reconciliation to save bandwidth.\n+        bool flood_to = false;\n+        if (pfrom.IsInboundConn()) {\n+            // We currently don't support reconciliations with inbound peers which\n+            // don't want to be reconciliation senders (request our sketches),\n+            // or want to be reconciliation responders (send us their sketches).\n+            // Just ignore SENDRECON and use normal flooding for transaction relay with them.\n+            if (!recon_sender) return;\n+            if (recon_responder) return;\n+        } else {\n+            // We currently don't support reconciliations with outbound peers which\n+            // don't want to be reconciliation responders (send us their sketches),\n+            // or want to be reconciliation senders (request our sketches).\n+            // Just ignore SENDRECON and use normal flooding for transaction relay with them.\n+            if (recon_sender) return;\n+            if (!recon_responder) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541120337",
      "id" : 541120337,
      "line" : 2970,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEyMDMzNw==",
      "original_commit_id" : "60a723ee676ce4259e0b3177d2fd1b5013dca649",
      "original_line" : 2970,
      "original_position" : 108,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 329,
      "pull_request_review_id" : 550089271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541120337",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541134079"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541134079"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm wondering if this might be better as a poisson-timer, but I don't quite understand the implications of all this yet to reach a conclusion.  Intuition: with a fixed delay like this, an adversary with 2 inbound connections can use set reconciliation to measure the set difference between the node's transactions-to-announce in known and arbitrarily precise time slices.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T18:11:19Z",
      "diff_hunk" : "@@ -899,6 +926,14 @@ void PeerManager::UpdateNextReconRequest(std::chrono::microseconds now)\n     m_next_recon_request = now + RECON_REQUEST_INTERVAL / m_recon_queue.size();\n }\n \n+std::chrono::microseconds PeerManager::NextReconRespond(std::chrono::microseconds now)\n+{\n+    if (m_next_recon_respond < now) {\n+        m_next_recon_respond = now + RECON_RESPONSE_INTERVAL;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541134079",
      "id" : 541134079,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzNDA3OQ==",
      "original_commit_id" : "95a6ab5d2dea0bd4ea4d07fbbeae8ffaa7e53835",
      "original_line" : 779,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 550089271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541134079",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541136948"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541136948"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should the `m_local_short_id_mapping` be cleared out in this function?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T18:16:09Z",
      "diff_hunk" : "@@ -610,6 +625,42 @@ struct Peer {\n             uint32_t short_txid = 1 + (s & 0xFFFFFFFF);\n             return short_txid;\n         }\n+\n+        /**\n+         * Estimate a capacity of a sketch we will send or use locally (to find set difference)\n+         * based on the local set size.\n+         */\n+        uint16_t EstimateSketchCapacity() {\n+            uint16_t set_size_diff = std::abs(uint16_t(m_local_set.size()) - m_remote_set_size);\n+            uint16_t min_size = std::min(uint16_t(m_local_set.size()), m_remote_set_size);\n+            uint16_t weighted_min_size = m_remote_q * min_size;\n+            uint16_t estimated_diff = 1 + weighted_min_size + set_size_diff;\n+            return minisketch_compute_capacity(RECON_FIELD_SIZE, estimated_diff, RECON_FALSE_POSITIVE_COEF);\n+        }\n+\n+        /**\n+         * Reconciliation involves computing a space-efficient representation of transaction identifiers (a sketch).\n+         * A sketch has a capacity meaning it allows reconciling at most a certain number of elements. (see BIP-330).\n+         * Considering whether we are going to send a sketch to a peer or use locally, we estimate the set difference.\n+         */\n+        minisketch* ComputeSketch(const std::set<uint256> local_set, uint16_t& capacity)\n+        {\n+            std::vector<uint32_t> short_ids;\n+            for (uint256 wtxid: local_set) {\n+                uint32_t short_txid = ComputeShortID(wtxid);\n+                short_ids.push_back(short_txid);\n+                m_local_short_id_mapping.insert(std::pair<uint32_t, uint256>(short_txid, wtxid));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541136948",
      "id" : 541136948,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzNjk0OA==",
      "original_commit_id" : "bcade239e25f10ea6e1ac5f1553b5f26ea123282",
      "original_line" : 688,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 550089271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541136948",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541138509"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541138509"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this is a protocol violation and leaves the link in a permanently broken reconciliation state, since a reconcildiff would never be sent. Perhaps we should disconnect the peer if this happens?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T18:19:04Z",
      "diff_hunk" : "@@ -4200,6 +4209,53 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         peer->m_recon_state->m_next_recon_respond = NextReconRespond(current_time);\n         return;\n     }\n+\n+    // Received a response to the reconciliation request.\n+    // May leak tx-related privacy if we announce local transactions right away, if a peer is strategic about sending\n+    // sketches to us via different connections (requires attacker to occupy multiple outgoing connections).\n+    if (msg_type == NetMsgType::SKETCH) {\n+        if (peer->m_recon_state == nullptr) return;\n+        if (peer->m_recon_state->m_outgoing_recon != Peer::ReconState::ReconPhase::INIT_REQUESTED) return;\n+\n+        std::vector<uint8_t> skdata;\n+        vRecv >> skdata;\n+\n+        // Attempt to decode the received sketch with a local sketch.\n+        if (skdata.size() / BYTES_PER_SKETCH_CAPACITY > MAX_SKETCH_CAPACITY) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541138509",
      "id" : 541138509,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzODUwOQ==",
      "original_commit_id" : "19065cb401be011fd4f172658b5f84467abbe085",
      "original_line" : 3987,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 550089271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541138509",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541139881"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541139881"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think we need to call `minisketch_destroy` on these somewhere to avoid a memory leak right?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T18:21:30Z",
      "diff_hunk" : "@@ -4200,6 +4209,53 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         peer->m_recon_state->m_next_recon_respond = NextReconRespond(current_time);\n         return;\n     }\n+\n+    // Received a response to the reconciliation request.\n+    // May leak tx-related privacy if we announce local transactions right away, if a peer is strategic about sending\n+    // sketches to us via different connections (requires attacker to occupy multiple outgoing connections).\n+    if (msg_type == NetMsgType::SKETCH) {\n+        if (peer->m_recon_state == nullptr) return;\n+        if (peer->m_recon_state->m_outgoing_recon != Peer::ReconState::ReconPhase::INIT_REQUESTED) return;\n+\n+        std::vector<uint8_t> skdata;\n+        vRecv >> skdata;\n+\n+        // Attempt to decode the received sketch with a local sketch.\n+        if (skdata.size() / BYTES_PER_SKETCH_CAPACITY > MAX_SKETCH_CAPACITY) return;\n+        uint16_t remote_sketch_capacity = uint16_t(skdata.size() / BYTES_PER_SKETCH_CAPACITY);\n+        minisketch* remote_sketch = minisketch_create(RECON_FIELD_SIZE, 0, remote_sketch_capacity);\n+        uint8_t remote_sketch_serialized[MAX_SKETCH_CAPACITY * BYTES_PER_SKETCH_CAPACITY];\n+        std::copy(skdata.begin(), skdata.end(), remote_sketch_serialized);\n+        minisketch_deserialize(remote_sketch, remote_sketch_serialized);\n+\n+        minisketch* working_sketch; // Contains sketch of the set difference\n+        minisketch* local_sketch = peer->m_recon_state->ComputeSketch(peer->m_recon_state->m_local_set, remote_sketch_capacity);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541139881",
      "id" : 541139881,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzOTg4MQ==",
      "original_commit_id" : "19065cb401be011fd4f172658b5f84467abbe085",
      "original_line" : 4232,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 550089271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541139881",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541149185"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541149185"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is it possible for the peer to send us a message that causes `remote_sketch` to be nullptr here?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-11T18:37:33Z",
      "diff_hunk" : "@@ -4252,6 +4262,16 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             AnnounceTxs(remote_missing, pfrom, msgMaker, m_connman);\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::RECONCILDIFF, uint8_t(RECON_SUCCESS), local_missing));\n             peer->m_recon_state->FinalizeReconciliation(true, Peer::ReconState::LocalQAction::Q_RECOMPUTE, local_missing.size(), remote_missing.size());\n+        } else {\n+            // Initial reconciliation failed.\n+            // Store the received sketch and the local sketch, request extension.\n+\n+            assert(remote_sketch != nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r541149185",
      "id" : 541149185,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTE0OTE4NQ==",
      "original_commit_id" : "c14e819d5f0f0b4869bef62ff0314f8d9538915f",
      "original_line" : 4269,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 550089271,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/541149185",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r544266303"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/544266303"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think you're right, although we should be extra careful to make sure no privacy leak is introduced w.r.t topology.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-16T12:40:06Z",
      "diff_hunk" : "@@ -2087,7 +2105,7 @@ void PeerManager::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n \n         if (AcceptToMemoryPool(m_mempool, state, porphanTx, &removed_txn, false /* bypass_limits */)) {\n             LogPrint(BCLog::MEMPOOL, \"   accepted orphan tx %s\\n\", orphanHash.ToString());\n-            RelayTransaction(orphanHash, porphanTx->GetWitnessHash(), m_connman);\n+            RelayTransaction(orphanHash, porphanTx->GetWitnessHash(), m_connman, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r544266303",
      "id" : 544266303,
      "in_reply_to_id" : 540947160,
      "line" : 2298,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDI2NjMwMw==",
      "original_commit_id" : "e8fd1cb590161e88b64b2e20d3113310390e68a5",
      "original_line" : 2298,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 233,
      "pull_request_review_id" : 553647191,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/544266303",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r544308769"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/544308769"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah, so I think the ratio matters most. It was 2.5 and now it's 2, so a bit different.\r\nBut I'm also not 100% if this difference matters, while preserving 2.5 would require operating with floats now, so I decided to not, at least yet.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-16T13:44:41Z",
      "diff_hunk" : "@@ -123,12 +123,12 @@ static constexpr std::chrono::hours AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL{24};\n static constexpr std::chrono::seconds AVG_ADDRESS_BROADCAST_INTERVAL{30};\n /** Average delay between trickled inventory transmissions in seconds.\n  *  Blocks and peers with noban permission bypass this, outbound peers get half this delay. */\n-static const unsigned int INVENTORY_BROADCAST_INTERVAL = 5;\n+static const unsigned int INVENTORY_BROADCAST_INTERVAL = 2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r544308769",
      "id" : 544308769,
      "in_reply_to_id" : 541031015,
      "line" : 135,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDMwODc2OQ==",
      "original_commit_id" : "9832017da275614664e30532d9ac7882d30f1bb6",
      "original_line" : 135,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 29,
      "pull_request_review_id" : 553697591,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/544308769",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r544319767"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/544319767"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Adding protection for this case.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-16T13:59:58Z",
      "diff_hunk" : "@@ -4252,6 +4262,16 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             AnnounceTxs(remote_missing, pfrom, msgMaker, m_connman);\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::RECONCILDIFF, uint8_t(RECON_SUCCESS), local_missing));\n             peer->m_recon_state->FinalizeReconciliation(true, Peer::ReconState::LocalQAction::Q_RECOMPUTE, local_missing.size(), remote_missing.size());\n+        } else {\n+            // Initial reconciliation failed.\n+            // Store the received sketch and the local sketch, request extension.\n+\n+            assert(remote_sketch != nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r544319767",
      "id" : 544319767,
      "in_reply_to_id" : 541149185,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDMxOTc2Nw==",
      "original_commit_id" : "c14e819d5f0f0b4869bef62ff0314f8d9538915f",
      "original_line" : 4269,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 553711075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/544319767",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r544368199"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/544368199"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not really permanently broken, they still have a chance to send us a proper sketch. But yeah, either finalizing or disconnecting would work. Making it disconnect for now.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-16T15:00:19Z",
      "diff_hunk" : "@@ -4200,6 +4209,53 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         peer->m_recon_state->m_next_recon_respond = NextReconRespond(current_time);\n         return;\n     }\n+\n+    // Received a response to the reconciliation request.\n+    // May leak tx-related privacy if we announce local transactions right away, if a peer is strategic about sending\n+    // sketches to us via different connections (requires attacker to occupy multiple outgoing connections).\n+    if (msg_type == NetMsgType::SKETCH) {\n+        if (peer->m_recon_state == nullptr) return;\n+        if (peer->m_recon_state->m_outgoing_recon != Peer::ReconState::ReconPhase::INIT_REQUESTED) return;\n+\n+        std::vector<uint8_t> skdata;\n+        vRecv >> skdata;\n+\n+        // Attempt to decode the received sketch with a local sketch.\n+        if (skdata.size() / BYTES_PER_SKETCH_CAPACITY > MAX_SKETCH_CAPACITY) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r544368199",
      "id" : 544368199,
      "in_reply_to_id" : 541138509,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM2ODE5OQ==",
      "original_commit_id" : "19065cb401be011fd4f172658b5f84467abbe085",
      "original_line" : 3987,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 553771995,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/544368199",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r544378109"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/544378109"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why so early? The point of it is to refer to it later, when we are requested something by short ID.\r\nThat's why it should be kept until `FinalizeReconciliation`. \r\n\r\nAlthough as currently implemented, I notice there's a bug, because we may lose short IDs of the transactions received during extension when calling this after the extension is over. I need to fix this part.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-16T15:12:42Z",
      "diff_hunk" : "@@ -610,6 +625,42 @@ struct Peer {\n             uint32_t short_txid = 1 + (s & 0xFFFFFFFF);\n             return short_txid;\n         }\n+\n+        /**\n+         * Estimate a capacity of a sketch we will send or use locally (to find set difference)\n+         * based on the local set size.\n+         */\n+        uint16_t EstimateSketchCapacity() {\n+            uint16_t set_size_diff = std::abs(uint16_t(m_local_set.size()) - m_remote_set_size);\n+            uint16_t min_size = std::min(uint16_t(m_local_set.size()), m_remote_set_size);\n+            uint16_t weighted_min_size = m_remote_q * min_size;\n+            uint16_t estimated_diff = 1 + weighted_min_size + set_size_diff;\n+            return minisketch_compute_capacity(RECON_FIELD_SIZE, estimated_diff, RECON_FALSE_POSITIVE_COEF);\n+        }\n+\n+        /**\n+         * Reconciliation involves computing a space-efficient representation of transaction identifiers (a sketch).\n+         * A sketch has a capacity meaning it allows reconciling at most a certain number of elements. (see BIP-330).\n+         * Considering whether we are going to send a sketch to a peer or use locally, we estimate the set difference.\n+         */\n+        minisketch* ComputeSketch(const std::set<uint256> local_set, uint16_t& capacity)\n+        {\n+            std::vector<uint32_t> short_ids;\n+            for (uint256 wtxid: local_set) {\n+                uint32_t short_txid = ComputeShortID(wtxid);\n+                short_ids.push_back(short_txid);\n+                m_local_short_id_mapping.insert(std::pair<uint32_t, uint256>(short_txid, wtxid));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r544378109",
      "id" : 544378109,
      "in_reply_to_id" : 541136948,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM3ODEwOQ==",
      "original_commit_id" : "bcade239e25f10ea6e1ac5f1553b5f26ea123282",
      "original_line" : 688,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 553784751,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/544378109",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r544382513"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/544382513"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I also don't have a good answer, but it's not that simple of an attack: we [have](https://github.com/bitcoin/bitcoin/pull/18261/files#r541017754) Poisson on adding to reconciliation sets.\r\n\r\nHaving another poison here, well, I don't think it makes anything worse. Maybe you're right.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-16T15:18:04Z",
      "diff_hunk" : "@@ -899,6 +926,14 @@ void PeerManager::UpdateNextReconRequest(std::chrono::microseconds now)\n     m_next_recon_request = now + RECON_REQUEST_INTERVAL / m_recon_queue.size();\n }\n \n+std::chrono::microseconds PeerManager::NextReconRespond(std::chrono::microseconds now)\n+{\n+    if (m_next_recon_respond < now) {\n+        m_next_recon_respond = now + RECON_RESPONSE_INTERVAL;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r544382513",
      "id" : 544382513,
      "in_reply_to_id" : 541134079,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM4MjUxMw==",
      "original_commit_id" : "95a6ab5d2dea0bd4ea4d07fbbeae8ffaa7e53835",
      "original_line" : 779,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 553790254,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/544382513",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r544386261"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/544386261"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Right, this implementation prioritized simplicity here.\r\nPerhaps, I should add sending RECONACK, and also think whether at least some of the non-matching scenarios are compatible.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-16T15:22:39Z",
      "diff_hunk" : "@@ -2562,6 +2620,74 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    // Received from an inbound peer planning to reconcile transactions with us, or\n+    // from an outgoing peer demonstrating readiness to do reconciliations.\n+    // If received from outgoing, adds the peer to the reconciliation queue.\n+    // Feature negotiation of tx reconciliation should happen between VERSION and\n+    // VERACK, to avoid relay problems from switching after a connection is up.\n+    if (msg_type == NetMsgType::SENDRECON) {\n+        if (!pfrom.m_tx_relay) return;\n+        if (peer->m_recon_state != nullptr) return; // Do not support reconciliation salt/version updates.\n+        LOCK(cs_main);\n+        if (!State(pfrom.GetId())->m_wtxid_relay) return; // SENDRECON is allowed only after WTXIDRELAY.\n+\n+        bool recon_sender, recon_responder;\n+        uint64_t remote_salt;\n+        uint32_t recon_version;\n+        vRecv >> recon_sender >> recon_responder >> recon_version >> remote_salt;\n+        if (recon_version != 1) return;\n+\n+        // Do not flood through inbound connections which support reconciliation to save bandwidth.\n+        bool flood_to = false;\n+        if (pfrom.IsInboundConn()) {\n+            // We currently don't support reconciliations with inbound peers which\n+            // don't want to be reconciliation senders (request our sketches),\n+            // or want to be reconciliation responders (send us their sketches).\n+            // Just ignore SENDRECON and use normal flooding for transaction relay with them.\n+            if (!recon_sender) return;\n+            if (recon_responder) return;\n+        } else {\n+            // We currently don't support reconciliations with outbound peers which\n+            // don't want to be reconciliation responders (send us their sketches),\n+            // or want to be reconciliation senders (request our sketches).\n+            // Just ignore SENDRECON and use normal flooding for transaction relay with them.\n+            if (recon_sender) return;\n+            if (!recon_responder) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r544386261",
      "id" : 544386261,
      "in_reply_to_id" : 541120337,
      "line" : 2970,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDM4NjI2MQ==",
      "original_commit_id" : "60a723ee676ce4259e0b3177d2fd1b5013dca649",
      "original_line" : 2970,
      "original_position" : 108,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 329,
      "pull_request_review_id" : 553794945,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/544386261",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r544917491"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/544917491"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`INVENTORY_BROADCAST_PER_SECOND` is probably derived from the block size, so it shouldn't be changed.\r\n`INVENTORY_BROADCAST_INTERVAL` is just how long we wait between reconciliations with different peers (say 2 seconds).\r\n\r\nNow, imagine, a non-reachable node (which only learns from reconciliations), reconciled with a dysfunctional peer. So the stack of what it should learn during the next successful reconciliation is twice the regular size.\r\nAnd `INVENTORY_BROADCAST_MAX` should better accommodate for these cases, because otherwise what we'll get is at least inefficiency.\r\n\r\n\"*4\" is just an intuitive amortization for these cases.\r\n\r\nI probably should add the explanation to a commit message once we agree this makes sense.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-17T08:57:47Z",
      "diff_hunk" : "@@ -123,12 +123,12 @@ static constexpr std::chrono::hours AVG_LOCAL_ADDRESS_BROADCAST_INTERVAL{24};\n static constexpr std::chrono::seconds AVG_ADDRESS_BROADCAST_INTERVAL{30};\n /** Average delay between trickled inventory transmissions in seconds.\n  *  Blocks and peers with noban permission bypass this, outbound peers get half this delay. */\n-static const unsigned int INVENTORY_BROADCAST_INTERVAL = 5;\n+static const unsigned int INVENTORY_BROADCAST_INTERVAL = 2;\n /** Maximum rate of inventory items to send per second.\n  *  Limits the impact of low-fee transaction floods. */\n static constexpr unsigned int INVENTORY_BROADCAST_PER_SECOND = 7;\n /** Maximum number of inventory items to send per transmission. */\n-static constexpr unsigned int INVENTORY_BROADCAST_MAX = INVENTORY_BROADCAST_PER_SECOND * INVENTORY_BROADCAST_INTERVAL;\n+static constexpr unsigned int INVENTORY_BROADCAST_MAX = INVENTORY_BROADCAST_PER_SECOND * INVENTORY_BROADCAST_INTERVAL * 4;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r544917491",
      "id" : 544917491,
      "in_reply_to_id" : 541032397,
      "line" : 140,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDkxNzQ5MQ==",
      "original_commit_id" : "9832017da275614664e30532d9ac7882d30f1bb6",
      "original_line" : 140,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 35,
      "pull_request_review_id" : 554394621,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/544917491",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r544932128"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/544932128"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We gain privacy by not allowing 2 peers to monitor our mempool, because we respond to them at the same time (every 2 seconds).\r\n\r\nSnapshoting earlier would hide the transactions received during the last 2 seconds and disable this kind of monitoring, but then reconciliations would not be so \"fresh\" (txs received during last 2s go into the next one).\r\nNot sure this kind of monitoring is that dangerous, especially since we *also* have a Poisson on adding to recon sets.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-17T09:20:01Z",
      "diff_hunk" : "@@ -3993,6 +4028,22 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    std::chrono::microseconds current_time = GetTime<std::chrono::microseconds>();\n+\n+    // Record an (expected) reconciliation request with parameters to respond when time comes.\n+    // All initial reconciliation responses will be done at the same time to prevent tx-related privacy leaks.\n+    if (msg_type == NetMsgType::REQRECON) {\n+        if (peer->m_recon_state == nullptr) return;\n+        if (!peer->m_recon_state->m_sender) return;\n+        if (peer->m_recon_state->m_incoming_recon != Peer::ReconState::ReconPhase::NONE) return;\n+        uint16_t peer_recon_set_size, peer_q;\n+        vRecv >> peer_recon_set_size >> peer_q;\n+        peer->m_recon_state->m_incoming_recon = Peer::ReconState::ReconPhase::INIT_REQUESTED;\n+        peer->m_recon_state->m_remote_set_size = peer_recon_set_size;\n+        peer->m_recon_state->m_remote_q = double(peer_q / Q_PRECISION);\n+        peer->m_recon_state->m_next_recon_respond = NextReconRespond(current_time);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r544932128",
      "id" : 544932128,
      "in_reply_to_id" : 541044473,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDkzMjEyOA==",
      "original_commit_id" : "3fc23c90edec1faaf61714272cc04c69fda811ca",
      "original_line" : 4181,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 554413230,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/544932128",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r544933569"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/544933569"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah, definitely, I have the same feel. Perhaps it better belongs to ReconState{}.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-17T09:22:12Z",
      "diff_hunk" : "@@ -182,6 +183,20 @@ static constexpr std::chrono::microseconds RECON_REQUEST_INTERVAL{std::chrono::s\n  * when we receive transactions (privacy leak).\n  */\n static constexpr std::chrono::microseconds RECON_RESPONSE_INTERVAL{std::chrono::seconds{2}};\n+/** The size of the field, used to compute sketches to reconcile transactions (see BIP-330). */\n+static constexpr unsigned int RECON_FIELD_SIZE = 32;\n+static_assert(RECON_FIELD_SIZE % 8 == 0, \"Field size should be divisible by 8\");\n+static constexpr unsigned int BYTES_PER_SKETCH_CAPACITY = RECON_FIELD_SIZE / 8;\n+static constexpr uint16_t MAX_SKETCH_CAPACITY = 2 << 12;\n+/**\n+* It is possible that if sketch encodes more elements than the capacity, or\n+* if it is constructed of random bytes, sketch decoding may \"succeed\",\n+* but the result will be nonsense (false-positive decoding).\n+* Given this coef, a false positive probability will be of 1 in 2**coef.\n+*/\n+static constexpr unsigned int RECON_FALSE_POSITIVE_COEF = 16;\n+static_assert(RECON_FALSE_POSITIVE_COEF <= 256,\n+    \"Reducing reconciliation false positives beyond 1 in 2**256 is not supported\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r544933569",
      "id" : 544933569,
      "in_reply_to_id" : 541049259,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDkzMzU2OQ==",
      "original_commit_id" : "43f06991b5c2794a81b8f7cca25bf49c1573078c",
      "original_line" : 197,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 554415023,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/544933569",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546120863"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546120863"
         }
      },
      "author_association" : "MEMBER",
      "body" : "BIP comment, and commit \"Handle reconciliation support announcement\":\r\n\r\nShould we use a BIP340 tagged hash here (see `TaggedHash()` in src/hash.h)?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-18T22:28:40Z",
      "diff_hunk" : "@@ -2560,6 +2621,69 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    // Received from an inbound peer planning to reconcile transactions with us, or\n+    // from an outgoing peer demonstrating readiness to do reconciliations.\n+    // If received from outgoing, adds the peer to the reconciliation queue.\n+    // Feature negotiation of tx reconciliation should happen between VERSION and\n+    // VERACK, to avoid relay problems from switching after a connection is up.\n+    if (msg_type == NetMsgType::SENDRECON) {\n+        if (!pfrom.m_tx_relay) return;\n+        LOCK(peer->cs_recon_state);\n+        if (peer->m_recon_state != nullptr) return; // Do not support reconciliation salt/version updates.\n+        LOCK(cs_main);\n+        if (!State(pfrom.GetId())->m_wtxid_relay) return; // SENDRECON is allowed only after WTXIDRELAY.\n+\n+        bool recon_sender, recon_responder;\n+        uint64_t remote_salt;\n+        uint32_t recon_version;\n+        vRecv >> recon_sender >> recon_responder >> recon_version >> remote_salt;\n+        if (recon_version != 1) return;\n+\n+        // Do not flood through inbound connections which support reconciliation to save bandwidth.\n+        bool flood_to = false;\n+        if (pfrom.IsInboundConn()) {\n+            // We currently don't support reconciliations with inbound peers which\n+            // don't want to be reconciliation senders (request our sketches),\n+            // or want to be reconciliation responders (send us their sketches).\n+            // Just ignore SENDRECON and use normal flooding for transaction relay with them.\n+            if (!recon_sender) return;\n+            if (recon_responder) return;\n+        } else {\n+            // We currently don't support reconciliations with outbound peers which\n+            // don't want to be reconciliation responders (send us their sketches),\n+            // or want to be reconciliation senders (request our sketches).\n+            // Just ignore SENDRECON and use normal flooding for transaction relay with them.\n+            if (recon_sender) return;\n+            if (!recon_responder) return;\n+            // TODO: Flood only through a limited number of outbound connections.\n+            flood_to = true;\n+        }\n+\n+        uint64_t local_salt = peer->m_local_recon_salt;\n+        std::string salt1, salt2;\n+        if (remote_salt < local_salt) {\n+            salt1 = ToString(remote_salt);\n+            salt2 = ToString(local_salt);\n+        } else {\n+            salt1 = ToString(local_salt);\n+            salt2 = ToString(remote_salt);\n+        }\n+        uint256 full_salt;\n+        CSHA256().Write((unsigned char*)RECON_STATIC_SALT.data(), RECON_STATIC_SALT.size()).",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546120863",
      "id" : 546120863,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEyMDg2Mw==",
      "original_commit_id" : "9da045b6f563fb5ba2bf369613ab388b0cc8ce73",
      "original_line" : 2672,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 555851251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546120863",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546122011"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546122011"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"Handle reconciliation support announcement\":\r\n\r\nThis comment isn't entirely clear to me. Flood transactions to the peer, as opposed to what (given that in the next line you say it's not in conflict with reconciliation, so it's not clear to me if this means instead of, or in addition to, reconciliation).",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-18T22:32:37Z",
      "diff_hunk" : "@@ -461,6 +465,63 @@ struct Peer {\n      * of relay of particular transactions due to collisions in short IDs.\n      */\n     const uint64_t m_local_recon_salt;\n+\n+    /**\n+     * This struct is used to keep track of the reconciliations with a given peer.\n+     * Transaction reconciliation means an efficient synchronization of the known\n+     * transactions between a pair of peers.\n+     * One reconciliation round consists of a sequence of messages. The sequence is\n+     * asymmetrical, there is always a requestor and a responder. At the end of the\n+     * sequence, nodes are supposed to exchange transactions, so that both of them\n+     * have all relevant transactions. For more protocol details, refer to BIP-0330.\n+     */\n+    struct ReconState {\n+        // ReconState(){};\n+        ReconState(bool sender, bool responder, bool flood_to, uint256 salt) :\n+            m_sender(sender), m_responder(responder), m_flood_to(flood_to), m_salt(salt), m_local_q(DEFAULT_RECON_Q) {}\n+\n+        /// Whether this peer will send reconciliation requests.\n+        bool m_sender;\n+\n+        /// Whether this peer will respond to reconciliation requests.\n+        bool m_responder;\n+\n+        /**\n+         * Whether we should flood transactions to the peer.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546122011",
      "id" : 546122011,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEyMjAxMQ==",
      "original_commit_id" : "9da045b6f563fb5ba2bf369613ab388b0cc8ce73",
      "original_line" : 490,
      "original_position" : 37,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 555851251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546122011",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546122109"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546122109"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"Handle reconciliation support announcement\":\r\n\r\nThe salt is only 128 bits, right? Why uint256? In the codebase we usually call SipHash salts k0 and k1.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-18T22:33:07Z",
      "diff_hunk" : "@@ -461,6 +465,63 @@ struct Peer {\n      * of relay of particular transactions due to collisions in short IDs.\n      */\n     const uint64_t m_local_recon_salt;\n+\n+    /**\n+     * This struct is used to keep track of the reconciliations with a given peer.\n+     * Transaction reconciliation means an efficient synchronization of the known\n+     * transactions between a pair of peers.\n+     * One reconciliation round consists of a sequence of messages. The sequence is\n+     * asymmetrical, there is always a requestor and a responder. At the end of the\n+     * sequence, nodes are supposed to exchange transactions, so that both of them\n+     * have all relevant transactions. For more protocol details, refer to BIP-0330.\n+     */\n+    struct ReconState {\n+        // ReconState(){};\n+        ReconState(bool sender, bool responder, bool flood_to, uint256 salt) :\n+            m_sender(sender), m_responder(responder), m_flood_to(flood_to), m_salt(salt), m_local_q(DEFAULT_RECON_Q) {}\n+\n+        /// Whether this peer will send reconciliation requests.\n+        bool m_sender;\n+\n+        /// Whether this peer will respond to reconciliation requests.\n+        bool m_responder;\n+\n+        /**\n+         * Whether we should flood transactions to the peer.\n+         * Reconciliation between two nodes does not prevent these nodes\n+         * from flooding transactions to each other.\n+         * Selective flooding of transactions to only specific peers makes\n+         * transaction relay significantly faster.\n+         */\n+        bool m_flood_to;\n+\n+        /**\n+         * Reconciliation involves computing and transmitting sketches,\n+         * which is a bandwidth-efficient representation of transaction IDs.\n+         * Since computing sketches over full txID is too CPU-expensive,\n+         * they will be computed over shortened IDs instead.\n+         * These short IDs will be salted so that they are not the same\n+         * across all pairs of peers, because otherwise it would enable network-wide\n+         * collisions which may (intentionally or not) halt relay of certain transactions.\n+         * Both of the peers contribute to the salt.\n+         */\n+        uint256 m_salt;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546122109",
      "id" : 546122109,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEyMjEwOQ==",
      "original_commit_id" : "9da045b6f563fb5ba2bf369613ab388b0cc8ce73",
      "original_line" : 508,
      "original_position" : 55,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 555851251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546122109",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546122819"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546122819"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"Handle reconciliation support announcement\"\r\n\r\nIs it necessary to use a recursive mutex here? If you can avoid them, Mutex is more efficient and easier to reason about.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-18T22:35:24Z",
      "diff_hunk" : "@@ -461,6 +465,63 @@ struct Peer {\n      * of relay of particular transactions due to collisions in short IDs.\n      */\n     const uint64_t m_local_recon_salt;\n+\n+    /**\n+     * This struct is used to keep track of the reconciliations with a given peer.\n+     * Transaction reconciliation means an efficient synchronization of the known\n+     * transactions between a pair of peers.\n+     * One reconciliation round consists of a sequence of messages. The sequence is\n+     * asymmetrical, there is always a requestor and a responder. At the end of the\n+     * sequence, nodes are supposed to exchange transactions, so that both of them\n+     * have all relevant transactions. For more protocol details, refer to BIP-0330.\n+     */\n+    struct ReconState {\n+        // ReconState(){};\n+        ReconState(bool sender, bool responder, bool flood_to, uint256 salt) :\n+            m_sender(sender), m_responder(responder), m_flood_to(flood_to), m_salt(salt), m_local_q(DEFAULT_RECON_Q) {}\n+\n+        /// Whether this peer will send reconciliation requests.\n+        bool m_sender;\n+\n+        /// Whether this peer will respond to reconciliation requests.\n+        bool m_responder;\n+\n+        /**\n+         * Whether we should flood transactions to the peer.\n+         * Reconciliation between two nodes does not prevent these nodes\n+         * from flooding transactions to each other.\n+         * Selective flooding of transactions to only specific peers makes\n+         * transaction relay significantly faster.\n+         */\n+        bool m_flood_to;\n+\n+        /**\n+         * Reconciliation involves computing and transmitting sketches,\n+         * which is a bandwidth-efficient representation of transaction IDs.\n+         * Since computing sketches over full txID is too CPU-expensive,\n+         * they will be computed over shortened IDs instead.\n+         * These short IDs will be salted so that they are not the same\n+         * across all pairs of peers, because otherwise it would enable network-wide\n+         * collisions which may (intentionally or not) halt relay of certain transactions.\n+         * Both of the peers contribute to the salt.\n+         */\n+        uint256 m_salt;\n+\n+        /**\n+         * Computing a set reconciliation sketch involves estimating the difference\n+         * between sets of transactions on two sides of the connection. More specifically,\n+         * a sketch capacity is computed as\n+         * |set_size - local_set_size| + q * (set_size + local_set_size) + c,\n+         * where c is a small constant, and q is a node+connection-specific coefficient.\n+         * This coefficient is recomputed by every node based on its previous reconciliations,\n+         * to better predict future set size differences.\n+         */\n+        double m_local_q;\n+    };\n+\n+    RecursiveMutex cs_recon_state;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546122819",
      "id" : 546122819,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEyMjgxOQ==",
      "original_commit_id" : "9da045b6f563fb5ba2bf369613ab388b0cc8ce73",
      "original_line" : 812,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 555851251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546122819",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546125410"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546125410"
         }
      },
      "author_association" : "MEMBER",
      "body" : "BIP comment:\r\n\r\nI think it's possible to specify the behavior exactly without the need for an ACK message, but perhaps this is a detail you don't actually want in the BIP:\r\n* We send (us_sender, us_responder, us_version)\r\n* We receive (they_sender, they_responder, they_version)\r\n* Define out_recon = us_sender && they_responder\r\n* Define in_recon = they_sender && us_responder\r\n* If !(out_recon || in_recon), reconciliation is disabled.\r\n* If exactly one of out_recon or in_recon, reconciliation (with us as requestor if out_recon, as responder otherwise) is enabled with protocol version min(us_version, they_version).\r\n* If both out_recon and in_recon, reconciliation is enabled with version min(us_version, they_version), in some tie-breaking direction (prefer outbound->inbound for example, or pick the one with the lowest nonce, ...)?\r\n* If no SENDRECON is received by the time VERACK happens, reconciliation is disabled.\r\n\r\nThis also means a new recon protocol can be introduced in a backward-compatible way. If the other party announced recon protocol 2, things will just default to protocol 1 without problems (which means forcing any client that supports protocol 2 to also support protocol 1). If a change would be made that is so incompatible that we don't expect clients to support the old one anymore, a different negotiation message would be used, or 0 could be sent.\r\n\r\nIn commit \"Handle reconciliation support announcement\":\r\n\r\nThe code would be something like this to accomodate that:\r\n\r\n```c++\r\n/* must match announcement logic */\r\nstatic constexpr uint32_t RECON_VERSION = 1;\r\nbool us_sender = !IsInBound(), us_responder = IsInBound(); \r\n\r\nbool they_sender, they_responder;\r\nvRecv >> they_sender >> they_responder >> recon_version >> remote_salt;\r\nrecon_version = std::min(recon_version, RECON_VERSION);\r\nif (recon_version < 1) return;\r\nbool recon_sender = us_sender && they_responder, recon_responder = us_responder && they_sender;\r\n// If we ever announce us_sender && us_responder, this will need tie-breaking (picking the outbound side as sender)\r\nassert(!(recon_sender && recon_responder));\r\n```\r\n",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-18T22:44:13Z",
      "diff_hunk" : "@@ -2562,6 +2620,74 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    // Received from an inbound peer planning to reconcile transactions with us, or\n+    // from an outgoing peer demonstrating readiness to do reconciliations.\n+    // If received from outgoing, adds the peer to the reconciliation queue.\n+    // Feature negotiation of tx reconciliation should happen between VERSION and\n+    // VERACK, to avoid relay problems from switching after a connection is up.\n+    if (msg_type == NetMsgType::SENDRECON) {\n+        if (!pfrom.m_tx_relay) return;\n+        if (peer->m_recon_state != nullptr) return; // Do not support reconciliation salt/version updates.\n+        LOCK(cs_main);\n+        if (!State(pfrom.GetId())->m_wtxid_relay) return; // SENDRECON is allowed only after WTXIDRELAY.\n+\n+        bool recon_sender, recon_responder;\n+        uint64_t remote_salt;\n+        uint32_t recon_version;\n+        vRecv >> recon_sender >> recon_responder >> recon_version >> remote_salt;\n+        if (recon_version != 1) return;\n+\n+        // Do not flood through inbound connections which support reconciliation to save bandwidth.\n+        bool flood_to = false;\n+        if (pfrom.IsInboundConn()) {\n+            // We currently don't support reconciliations with inbound peers which\n+            // don't want to be reconciliation senders (request our sketches),\n+            // or want to be reconciliation responders (send us their sketches).\n+            // Just ignore SENDRECON and use normal flooding for transaction relay with them.\n+            if (!recon_sender) return;\n+            if (recon_responder) return;\n+        } else {\n+            // We currently don't support reconciliations with outbound peers which\n+            // don't want to be reconciliation responders (send us their sketches),\n+            // or want to be reconciliation senders (request our sketches).\n+            // Just ignore SENDRECON and use normal flooding for transaction relay with them.\n+            if (recon_sender) return;\n+            if (!recon_responder) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546125410",
      "id" : 546125410,
      "in_reply_to_id" : 541120337,
      "line" : 2970,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjEyNTQxMA==",
      "original_commit_id" : "60a723ee676ce4259e0b3177d2fd1b5013dca649",
      "original_line" : 2970,
      "original_position" : 108,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 329,
      "pull_request_review_id" : 555851251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546125410",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546141650"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546141650"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"Handle reconciliation support announcement\"\r\n\r\nThis conversion to decimal strings doesn't seem to match the BIP. I would think you'd do:\r\n\r\n```c++\r\nuint64_t salt1 = local_salt, salt2 = remote_salt;\r\nif (salt1 > salt2) std::swap(salt1, salt2);\r\nuint256 full_salt = (CHashWriter(SER_HASH, 0) << MakeSpan(RECON_STATIC_SALT) << salt1 << salt2).GetSHA256();\r\n```\r\n\r\nIf the BIP is changed to use tagged hashes, you'd do\r\n\r\n```c++\r\nstatic const auto RECON_SALT_HASHER = TaggedHash(RECON_STATIC_SALT);\r\nuint256 full_salt = (CHashWriter(RECON_SALT_HASHER) << salt1 << salt2).GetSHA256();\r\n```\r\n\r\ninstead.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-18T23:16:03Z",
      "diff_hunk" : "@@ -2560,6 +2621,69 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    // Received from an inbound peer planning to reconcile transactions with us, or\n+    // from an outgoing peer demonstrating readiness to do reconciliations.\n+    // If received from outgoing, adds the peer to the reconciliation queue.\n+    // Feature negotiation of tx reconciliation should happen between VERSION and\n+    // VERACK, to avoid relay problems from switching after a connection is up.\n+    if (msg_type == NetMsgType::SENDRECON) {\n+        if (!pfrom.m_tx_relay) return;\n+        LOCK(peer->cs_recon_state);\n+        if (peer->m_recon_state != nullptr) return; // Do not support reconciliation salt/version updates.\n+        LOCK(cs_main);\n+        if (!State(pfrom.GetId())->m_wtxid_relay) return; // SENDRECON is allowed only after WTXIDRELAY.\n+\n+        bool recon_sender, recon_responder;\n+        uint64_t remote_salt;\n+        uint32_t recon_version;\n+        vRecv >> recon_sender >> recon_responder >> recon_version >> remote_salt;\n+        if (recon_version != 1) return;\n+\n+        // Do not flood through inbound connections which support reconciliation to save bandwidth.\n+        bool flood_to = false;\n+        if (pfrom.IsInboundConn()) {\n+            // We currently don't support reconciliations with inbound peers which\n+            // don't want to be reconciliation senders (request our sketches),\n+            // or want to be reconciliation responders (send us their sketches).\n+            // Just ignore SENDRECON and use normal flooding for transaction relay with them.\n+            if (!recon_sender) return;\n+            if (recon_responder) return;\n+        } else {\n+            // We currently don't support reconciliations with outbound peers which\n+            // don't want to be reconciliation responders (send us their sketches),\n+            // or want to be reconciliation senders (request our sketches).\n+            // Just ignore SENDRECON and use normal flooding for transaction relay with them.\n+            if (recon_sender) return;\n+            if (!recon_responder) return;\n+            // TODO: Flood only through a limited number of outbound connections.\n+            flood_to = true;\n+        }\n+\n+        uint64_t local_salt = peer->m_local_recon_salt;\n+        std::string salt1, salt2;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546141650",
      "id" : 546141650,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE0MTY1MA==",
      "original_commit_id" : "9da045b6f563fb5ba2bf369613ab388b0cc8ce73",
      "original_line" : 2663,
      "original_position" : 118,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 555851251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546141650",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546142850"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546142850"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"Handle reconciliation support announcement\":\r\n\r\nThe comment of m_recon_queue needing a lock doesn't seem resolved?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-18T23:21:00Z",
      "diff_hunk" : "@@ -143,6 +143,14 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n     TxRequestTracker m_txrequest GUARDED_BY(::cs_main);\n \n     int64_t m_stale_tip_check_time; //!< Next time to check for stale tip\n+\n+    /**\n+     * Transaction reconciliation should happen with peers in the same order,\n+     * because the efficiency gain is the highest when reconciliation set difference\n+     * is predictable. This queue is used to maintain the order of\n+     * peers chosen for reconciliation.\n+     */\n+    std::deque<CNode*> m_recon_queue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546142850",
      "id" : 546142850,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE0Mjg1MA==",
      "original_commit_id" : "9da045b6f563fb5ba2bf369613ab388b0cc8ce73",
      "original_line" : 162,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 555851251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546142850",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546146253"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546146253"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Or even `const auto& wtxid : ...` to be sure no copy is created, regardless of the type of the container.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-18T23:34:57Z",
      "diff_hunk" : "@@ -2370,6 +2370,28 @@ static void ProcessGetCFCheckPt(CNode& peer, CDataStream& vRecv, const CChainPar\n     connman.PushMessage(&peer, std::move(msg));\n }\n \n+/**\n+ * Announce transactions a peer is missing after reconciliation is done.\n+ * No need to add transactions to peer's filter or do checks\n+ * because it was already done when adding to the reconciliation set.\n+ */\n+void static AnnounceTxs(std::vector<uint256> remote_missing_wtxids, CNode* pto, CNetMsgMaker msgMaker, CConnman* connman)\n+{\n+    if (remote_missing_wtxids.size() != 0) {\n+        std::vector<CInv> remote_missing_invs;\n+        for (uint256 wtxid: remote_missing_wtxids) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546146253",
      "id" : 546146253,
      "in_reply_to_id" : 540498519,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE0NjI1Mw==",
      "original_commit_id" : "9347a73f01c13a0187b7a70d5315052726ad65ac",
      "original_line" : 2694,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 555851251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546146253",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546148014"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546148014"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"Distinguish transactions to flood and to reconcile\":\r\n\r\nYou can use\r\n\r\n```c++\r\nm_tx_relay->setInventoryTxToSend.emplace(hash, flood);\r\n```\r\n\r\nhere instead.\r\n\r\n",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-18T23:42:50Z",
      "diff_hunk" : "@@ -1190,12 +1191,12 @@ class CNode\n         }\n     }\n \n-    void PushTxInventory(const uint256& hash)\n+    void PushTxInventory(const uint256& hash, const bool flood)\n     {\n         if (m_tx_relay == nullptr) return;\n         LOCK(m_tx_relay->cs_tx_inventory);\n         if (!m_tx_relay->filterInventoryKnown.contains(hash)) {\n-            m_tx_relay->setInventoryTxToSend.insert(hash);\n+            m_tx_relay->setInventoryTxToSend.insert(std::pair<uint256, bool>(hash, flood));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546148014",
      "id" : 546148014,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE0ODAxNA==",
      "original_commit_id" : "49a18d73df9590e8f0f1b923a768f8f65095bed2",
      "original_line" : 1199,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 555851251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546148014",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546151144"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546151144"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"Distinguish transactions to flood and to reconcile\"\r\n\r\nWould it make sense to reuse `MAX_PEER_TX_ANNOUNCEMENTS` here? It was reduced to 5000 in #19988.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-18T23:48:27Z",
      "diff_hunk" : "@@ -156,6 +156,16 @@ static constexpr double DEFAULT_RECON_Q = 0.02;\n  * It helps to save bandwidth and reduce the privacy leak.\n  */\n static constexpr uint32_t MAX_OUTBOUND_FLOOD_TO = 8;\n+/**\n+ * Maximum number of elements to store in the reconciliation set.\n+ * Used to bound the memory use. If the limit is reached, new transactions are not added and\n+ * forgotten w.r.t. relaying to that peer.\n+ * Sets the bound on the following objects:\n+ * - reconciliation set\n+ * - reconciliation set snapshot\n+ * - reconciliation short-full id mapping\n+ */\n+static const unsigned int MAX_RECON_SET = 10000;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546151144",
      "id" : 546151144,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE1MTE0NA==",
      "original_commit_id" : "49a18d73df9590e8f0f1b923a768f8f65095bed2",
      "original_line" : 171,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 555851251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546151144",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546167320"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546167320"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"Handle reconciliation support announcement\" (and BIP)\r\n\r\nDo we want to ignore or disconnect if this message arrives after VERACK?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-19T01:07:01Z",
      "diff_hunk" : "@@ -2560,6 +2621,69 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    // Received from an inbound peer planning to reconcile transactions with us, or\n+    // from an outgoing peer demonstrating readiness to do reconciliations.\n+    // If received from outgoing, adds the peer to the reconciliation queue.\n+    // Feature negotiation of tx reconciliation should happen between VERSION and\n+    // VERACK, to avoid relay problems from switching after a connection is up.\n+    if (msg_type == NetMsgType::SENDRECON) {\n+        if (!pfrom.m_tx_relay) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546167320",
      "id" : 546167320,
      "line" : 2942,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE2NzMyMA==",
      "original_commit_id" : "9da045b6f563fb5ba2bf369613ab388b0cc8ce73",
      "original_line" : 2942,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 301,
      "pull_request_review_id" : 555851251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546167320",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546170672"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546170672"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"Distinguish transactions to flood and to reconcile\":\r\n\r\nNit: coding style (use { ... } for multi-line ifs).",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-19T01:28:27Z",
      "diff_hunk" : "@@ -4608,9 +4645,17 @@ bool PeerManager::SendMessages(CNode* pto)\n                             continue;\n                         }\n                         if (pto->m_tx_relay->pfilter && !pto->m_tx_relay->pfilter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n-                        // Send\n+\n+                        bool flood_tx = it->second;\n+                        if (!peer->m_recon_state || (peer->m_recon_state->m_flood_to && flood_tx))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546170672",
      "id" : 546170672,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE3MDY3Mg==",
      "original_commit_id" : "49a18d73df9590e8f0f1b923a768f8f65095bed2",
      "original_line" : 5118,
      "original_position" : 181,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 555851251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546170672",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546301880"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546301880"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"Distinguish transactions to flood and to reconcile\"\r\n\r\nPerhaps it's useful to comment on the exact semantics for the bool parameter here. IIRC it is:\r\n* false: use reconciliation if negotiated, flood otherwise\r\n* true: flood unless reconciliation negotiated and this is not a flooding peer\r\n",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-20T00:36:28Z",
      "diff_hunk" : "@@ -1009,9 +1009,10 @@ class CNode\n \n         mutable RecursiveMutex cs_tx_inventory;\n         CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_tx_inventory){50000, 0.000001};\n-        // Set of transaction ids we still have to announce.\n-        // They are sorted by the mempool before relay, so the order is not important.\n-        std::set<uint256> setInventoryTxToSend;\n+        // Set of transaction ids we still have to announce, and whether we may flood them\n+        // in case if peer is meant to receive flooding, as opposed to reconcile.\n+        // Transactions are sorted by the mempool before relay, so the order is not important.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546301880",
      "id" : 546301880,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjMwMTg4MA==",
      "original_commit_id" : "49a18d73df9590e8f0f1b923a768f8f65095bed2",
      "original_line" : 1022,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 555851251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546301880",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546306680"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546306680"
         }
      },
      "author_association" : "MEMBER",
      "body" : "BIP comment: why 12 bits? You could have 16 bits of accuracy with the 2 bytes that it takes.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-20T01:39:59Z",
      "diff_hunk" : "@@ -146,6 +147,65 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** Static component of the salt used to compute short txids for transaction reconciliation. */\n+static const std::string RECON_STATIC_SALT = \"Tx Relay Salting\";\n+/** Used to convert a floating point reconciliation coefficient q to an int for transmission. */\n+static constexpr double Q_PRECISION{2 << 12};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546306680",
      "id" : 546306680,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjMwNjY4MA==",
      "original_commit_id" : "80bde2b1aae6897ba29a6d18ef76cd8990daeff5",
      "original_line" : 160,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 555851251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546306680",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546306755"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546306755"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why is this strictly needed? (apart from the BIP specifying that it is 32, so any other value is protocol breaking).",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-20T01:41:17Z",
      "diff_hunk" : "@@ -146,6 +147,65 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** Static component of the salt used to compute short txids for transaction reconciliation. */\n+static const std::string RECON_STATIC_SALT = \"Tx Relay Salting\";\n+/** Used to convert a floating point reconciliation coefficient q to an int for transmission. */\n+static constexpr double Q_PRECISION{2 << 12};\n+/** Default coefficient used to estimate set difference for tx reconciliation. */\n+static constexpr double DEFAULT_RECON_Q = 0.02;\n+/**\n+ * When considering whether we should flood to an outbound connection supporting reconciliation,\n+ * see how many outbound connections are already used for flooding. Flood only if the limit is not reached.\n+ * It helps to save bandwidth and reduce the privacy leak.\n+ */\n+static constexpr uint32_t MAX_OUTBOUND_FLOOD_TO = 8;\n+/**\n+ * Maximum number of elements to store in the reconciliation set.\n+ * Used to bound the memory use. If the limit is reached, new transactions are not added and\n+ * forgotten w.r.t. relaying to that peer.\n+ * Sets the bound on the following objects:\n+ * - reconciliation set\n+ * - reconciliation set snapshot\n+ * - reconciliation short-full id mapping\n+ */\n+static const unsigned int MAX_RECON_SET = 10000;\n+/**\n+ * Interval between sending reconciliation request to the same peer.\n+ * This value allows to reconcile ~100 transactions (7 tx/s * 16s) during normal system operation at capacity.\n+ * More frequent reconciliations would cause significant constant bandwidth overhead due to\n+ * reconciliation metadata (sketch sizes etc.), which would nullify the efficiency.\n+ * Less frequent reconciliations would introduce high transaction relay latency.\n+ */\n+static constexpr std::chrono::microseconds RECON_REQUEST_INTERVAL{std::chrono::seconds{16}};\n+/**\n+ * Interval between responding to peers' reconciliation requests.\n+ * We don't respond to reconciliation requests right away because that would enable monitoring\n+ * when we receive transactions (privacy leak).\n+ */\n+static constexpr std::chrono::microseconds RECON_RESPONSE_INTERVAL{std::chrono::seconds{2}};\n+/** The size of the field, used to compute sketches to reconcile transactions (see BIP-330). */\n+static constexpr unsigned int RECON_FIELD_SIZE = 32;\n+static_assert(RECON_FIELD_SIZE % 8 == 0, \"Field size should be divisible by 8\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546306755",
      "id" : 546306755,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjMwNjc1NQ==",
      "original_commit_id" : "80bde2b1aae6897ba29a6d18ef76cd8990daeff5",
      "original_line" : 188,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 555851251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546306755",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546306899"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546306899"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've PR'ed https://github.com/sipa/minisketch/pull/28 that adds a safer C++ wrapper around the minisketch* type. You may want to use it instead of doing manual memory management for them. It also adds some convenience functions for dealing with fpbits (CreateFP and DecodeFP).",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-20T01:43:35Z",
      "diff_hunk" : "@@ -451,7 +511,305 @@ struct Peer {\n     /** Work queue of items requested by this peer **/\n     std::deque<CInv> m_getdata_requests GUARDED_BY(m_getdata_requests_mutex);\n \n-    explicit Peer(NodeId id) : m_id(id) {}\n+    explicit Peer(NodeId id) : m_id(id), m_local_recon_salt(GetRand(UINT64_MAX)) {}\n+\n+    /**\n+     * Salt used to compute short IDs during transaction reconciliation.\n+     * Salt is generated randomly per-connection to prevent linking of\n+     * connections belonging to the same physical node.\n+     * Also, salts should be different per-connection to prevent halting\n+     * of relay of particular transactions due to collisions in short IDs.\n+     */\n+    const uint64_t m_local_recon_salt;\n+\n+    /**\n+     * This struct is used to keep track of the reconciliations with a given peer.\n+     * Transaction reconciliation means an efficient synchronization of the known\n+     * transactions between a pair of peers.\n+     * One reconciliation round consists of a sequence of messages. The sequence is\n+     * asymmetrical, there is always a requestor and a responder. At the end of the\n+     * sequence, nodes are supposed to exchange transactions, so that both of them\n+     * have all relevant transactions. For more protocol details, refer to BIP-0330.\n+     */\n+    struct ReconState {\n+        // ReconState(){};\n+        ReconState(bool sender, bool responder, bool flood_to, uint256 salt) :\n+            m_sender(sender), m_responder(responder), m_flood_to(flood_to), m_salt(salt), m_local_q(DEFAULT_RECON_Q) {}\n+\n+        /// Whether this peer will send reconciliation requests.\n+        bool m_sender;\n+\n+        /// Whether this peer will respond to reconciliation requests.\n+        bool m_responder;\n+\n+        /**\n+         * Whether we should flood transactions to the peer.\n+         * Reconciliation between two nodes does not prevent these nodes\n+         * from flooding transactions to each other.\n+         * Selective flooding of transactions to only specific peers makes\n+         * transaction relay significantly faster.\n+         */\n+        bool m_flood_to;\n+\n+        /**\n+         * Reconciliation involves computing and transmitting sketches,\n+         * which is a bandwidth-efficient representation of transaction IDs.\n+         * Since computing sketches over full txID is too CPU-expensive,\n+         * they will be computed over shortened IDs instead.\n+         * These short IDs will be salted so that they are not the same\n+         * across all pairs of peers, because otherwise it would enable network-wide\n+         * collisions which may (intentionally or not) halt relay of certain transactions.\n+         * Both of the peers contribute to the salt.\n+         */\n+        uint256 m_salt;\n+\n+        /**\n+         * Computing a set reconciliation sketch involves estimating the difference\n+         * between sets of transactions on two sides of the connection. More specifically,\n+         * a sketch capacity is computed as\n+         * |set_size - local_set_size| + q * (set_size + local_set_size) + c,\n+         * where c is a small constant, and q is a node+connection-specific coefficient.\n+         * This coefficient is recomputed by every node based on its previous reconciliations,\n+         * to better predict future set size differences.\n+         */\n+        double m_local_q;\n+\n+        /**\n+         * Store all transactions which we would relay to the peer (policy checks passed, etc.) in this set\n+         * instead of announcing them right away. When reconciliation time comes, we will\n+         * compute an efficient representation of this set (\"sketch\") and use it to efficient reconcile\n+         * this set with a similar set on the other side of the connection.\n+         */\n+        std::set<uint256> m_local_set;\n+\n+        /**\n+         * A reconciliation request comes from a peer with a reconciliation set size from their side,\n+         * which is supposed to help us to estimate set difference size. The value is stored here until\n+         * we respond to that request with a sketch.\n+         */\n+        uint16_t m_remote_set_size;\n+\n+        /**\n+         * The use of q coefficients is described above (see local_q comment).\n+         * The value transmitted from the peer with a reconciliation requests is stored here until\n+         * we respond to that request with a sketch.\n+         */\n+        double m_remote_q;\n+\n+        /**\n+         * When a reconciliation request is received, instead of responding to it right away,\n+         * we schedule a response for later, so that a spy can't monitor our reconciliation sets.\n+         */\n+        std::chrono::microseconds m_next_recon_respond{0};\n+\n+        /**\n+         * Used to keep track of the current reconciliation round with a peer.\n+         * Used for both inbound (responded) and outgoing (requested/initiated) reconciliations.\n+         * Currently only one sketch extension request is supported.\n+         */\n+        enum ReconPhase {\n+            NONE,\n+            INIT_REQUESTED,\n+            INIT_RESPONDED,\n+            EXT_REQUESTED,\n+            EXT_RESPONDED,\n+        };\n+        ReconPhase m_outgoing_recon{ReconPhase::NONE};\n+        ReconPhase m_incoming_recon{ReconPhase::NONE};\n+\n+        /**\n+         * Reconciliation sketches are computed over short transaction IDs.\n+         * This is a cache of these IDs enabling faster lookups of full wtxids,\n+         * useful when peer will ask for missing transactions by short IDs\n+         * at the end of a reconciliation round.\n+         */\n+        std::map<uint32_t, uint256> m_local_short_id_mapping;\n+\n+        /**\n+         * A reconciliation round may involve an extension, which is an extra exchange of messages.\n+         * Since it may happen after a delay (at least network latency), new transactions may come\n+         * during that time. To avoid mixing old and new transactions, those which are subject for\n+         * extension of a current reconciliation round are moved to a reconciliation set snapshot\n+         * after an initial (non-extended) sketch is sent.\n+         * New transactions are kept in the regular reconciliation set.\n+         */\n+        std::set<uint256> m_local_set_snapshot;\n+\n+        /**\n+         * A reconciliation round may involve an extension, in which case we should remember\n+         * a capacity of the sketch sent out initially, so that a sketch extension is of the same size.\n+         */\n+        uint16_t m_capacity_snapshot{0};\n+\n+        /**\n+         * In a reconciliation round initiated by us, if we asked for an extension, we want to store\n+         * the sketch computed/transmitted in the initial step, so that we can use it when\n+         * sketch extension arrives.\n+         */\n+        std::vector<uint8_t> m_remote_sketch_snapshot;\n+\n+        /**\n+        * Reconciliation sketches are computed over short transaction IDs.\n+        * Short IDs are salted with a link-specific constant value.\n+        */\n+        uint32_t ComputeShortID(const uint256 wtxid)\n+        {\n+            uint64_t k0 = m_salt.GetUint64(0);\n+            uint64_t k1 = m_salt.GetUint64(1);\n+            uint64_t s = SipHashUint256(k0, k1, wtxid);\n+            uint32_t short_txid = 1 + (s & 0xFFFFFFFF);\n+            return short_txid;\n+        }\n+\n+        /**\n+         * Estimate a capacity of a sketch we will send or use locally (to find set difference)\n+         * based on the local set size.\n+         */\n+        uint16_t EstimateSketchCapacity() {\n+            uint16_t set_size_diff = std::abs(uint16_t(m_local_set.size()) - m_remote_set_size);\n+            uint16_t min_size = std::min(uint16_t(m_local_set.size()), m_remote_set_size);\n+            uint16_t weighted_min_size = m_remote_q * min_size;\n+            uint16_t estimated_diff = 1 + weighted_min_size + set_size_diff;\n+            return minisketch_compute_capacity(RECON_FIELD_SIZE, estimated_diff, RECON_FALSE_POSITIVE_COEF);\n+        }\n+\n+        /**\n+         * Reconciliation involves computing a space-efficient representation of transaction identifiers (a sketch).\n+         * A sketch has a capacity meaning it allows reconciling at most a certain number of elements. (see BIP-330).\n+         * Considering whether we are going to send a sketch to a peer or use locally, we estimate the set difference.\n+         */\n+        minisketch* ComputeSketch(const std::set<uint256> local_set, uint16_t& capacity)\n+        {\n+            std::vector<uint32_t> short_ids;\n+            for (uint256 wtxid: local_set) {\n+                uint32_t short_txid = ComputeShortID(wtxid);\n+                short_ids.push_back(short_txid);\n+                m_local_short_id_mapping.insert(std::pair<uint32_t, uint256>(short_txid, wtxid));\n+            }\n+\n+            capacity = std::min(capacity, MAX_SKETCH_CAPACITY);\n+\n+            if (short_ids.size() == 0) return nullptr;\n+            minisketch* sketch = minisketch_create(RECON_FIELD_SIZE, 0, capacity);\n+            if (sketch == nullptr) {\n+                return nullptr;\n+            }\n+            for (uint32_t short_id: short_ids) {\n+                minisketch_add_uint64(sketch, short_id);\n+            }\n+            return sketch;\n+        }\n+\n+        minisketch* ComputeExtendedSketch() {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546306899",
      "id" : 546306899,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjMwNjg5OQ==",
      "original_commit_id" : "80bde2b1aae6897ba29a6d18ef76cd8990daeff5",
      "original_line" : 704,
      "original_position" : 283,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 555851251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546306899",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546307036"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546307036"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've PR'ed https://github.com/sipa/minisketch/pull/26 which adds a pure Python (slow) full reimplementation of minisketch. You may want to use that instead (it also supports decoding).",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-20T01:44:56Z",
      "diff_hunk" : "@@ -0,0 +1,596 @@\n+#!/usr/bin/env python3\n+# Copyhigh (c) 2016-2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test reconciliation-based transaction relay protocol.\n+\n+\"\"\"\n+\n+from test_framework.p2p import P2PDataStore, p2p_lock\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, hex_str_to_bytes\n+from test_framework.messages import (\n+    msg_inv, msg_getdata,\n+    msg_sendrecon, msg_reqrecon,\n+    msg_sketch, msg_reqsketchext, msg_reconcildiff,\n+    CTransaction, CInv\n+)\n+from test_framework.siphash import siphash256\n+from enum import IntEnum\n+from io import BytesIO\n+import random\n+import hashlib\n+import time\n+\n+MASK64 = 0xffffffffffffffff\n+MSG_WTX = 5\n+\n+# These parameters are specified in the BIP-0330.\n+Q_PRECISION = 2 << 12\n+FIELD_BITS = 32\n+FIELD_MODULUS = (1 << FIELD_BITS) + 0b10001101\n+\n+# These parameters are suggested by the Erlay paper based on analysis and simulations.\n+DEFAULT_Q = 0.02\n+RECON_REQUEST_INTERVAL = 16\n+INVENTORY_BROADCAST_INTERVAL = 2\n+PENALIZED_INVENTORY_BROADCAST_INTERVAL = INVENTORY_BROADCAST_INTERVAL * 2\n+MAX_OUTBOUND_FLOOD_TO = 8\n+\n+BYTES_PER_SKETCH_CAPACITY = FIELD_BITS / 8\n+\n+def mul2(x):\n+    \"\"\"Compute 2*x in GF(2^FIELD_BITS)\"\"\"\n+    return (x << 1) ^ (FIELD_MODULUS if x.bit_length() >= FIELD_BITS else 0)\n+\n+def mul(x, y):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r546307036",
      "id" : 546307036,
      "line" : 45,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjMwNzAzNg==",
      "original_commit_id" : "80bde2b1aae6897ba29a6d18ef76cd8990daeff5",
      "original_line" : 45,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "test/functional/p2p_erlay.py",
      "position" : 45,
      "pull_request_review_id" : 555851251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/546307036",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r547174377"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/547174377"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm not 100% sure how to do it right, but simple Mutex doesn't seem to work when `GetFloodingOutboundsCount` is called in handling `NetMsgType::SENDRECON`. It just hangs.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-22T09:44:20Z",
      "diff_hunk" : "@@ -461,6 +465,63 @@ struct Peer {\n      * of relay of particular transactions due to collisions in short IDs.\n      */\n     const uint64_t m_local_recon_salt;\n+\n+    /**\n+     * This struct is used to keep track of the reconciliations with a given peer.\n+     * Transaction reconciliation means an efficient synchronization of the known\n+     * transactions between a pair of peers.\n+     * One reconciliation round consists of a sequence of messages. The sequence is\n+     * asymmetrical, there is always a requestor and a responder. At the end of the\n+     * sequence, nodes are supposed to exchange transactions, so that both of them\n+     * have all relevant transactions. For more protocol details, refer to BIP-0330.\n+     */\n+    struct ReconState {\n+        // ReconState(){};\n+        ReconState(bool sender, bool responder, bool flood_to, uint256 salt) :\n+            m_sender(sender), m_responder(responder), m_flood_to(flood_to), m_salt(salt), m_local_q(DEFAULT_RECON_Q) {}\n+\n+        /// Whether this peer will send reconciliation requests.\n+        bool m_sender;\n+\n+        /// Whether this peer will respond to reconciliation requests.\n+        bool m_responder;\n+\n+        /**\n+         * Whether we should flood transactions to the peer.\n+         * Reconciliation between two nodes does not prevent these nodes\n+         * from flooding transactions to each other.\n+         * Selective flooding of transactions to only specific peers makes\n+         * transaction relay significantly faster.\n+         */\n+        bool m_flood_to;\n+\n+        /**\n+         * Reconciliation involves computing and transmitting sketches,\n+         * which is a bandwidth-efficient representation of transaction IDs.\n+         * Since computing sketches over full txID is too CPU-expensive,\n+         * they will be computed over shortened IDs instead.\n+         * These short IDs will be salted so that they are not the same\n+         * across all pairs of peers, because otherwise it would enable network-wide\n+         * collisions which may (intentionally or not) halt relay of certain transactions.\n+         * Both of the peers contribute to the salt.\n+         */\n+        uint256 m_salt;\n+\n+        /**\n+         * Computing a set reconciliation sketch involves estimating the difference\n+         * between sets of transactions on two sides of the connection. More specifically,\n+         * a sketch capacity is computed as\n+         * |set_size - local_set_size| + q * (set_size + local_set_size) + c,\n+         * where c is a small constant, and q is a node+connection-specific coefficient.\n+         * This coefficient is recomputed by every node based on its previous reconciliations,\n+         * to better predict future set size differences.\n+         */\n+        double m_local_q;\n+    };\n+\n+    RecursiveMutex cs_recon_state;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r547174377",
      "id" : 547174377,
      "in_reply_to_id" : 546122819,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzE3NDM3Nw==",
      "original_commit_id" : "9da045b6f563fb5ba2bf369613ab388b0cc8ce73",
      "original_line" : 812,
      "original_position" : 69,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 556948203,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/547174377",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r548678244"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548678244"
         }
      },
      "author_association" : "MEMBER",
      "body" : "q is computed as `(total_missing - abs(local_missing - remote_missing)) / min_size`\r\n\r\nSo the bounds on q are [0...2] I think?\r\nif abs = 0, total_missing = 2 * min_size (at most) is an upper bound.\r\nIf abs !=0, well. Ideally, we need to solve this equation properly :)\r\n\r\nSo it should be (2 << 14) - 1 I think assuming [0..2] for now.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2020-12-24T18:23:07Z",
      "diff_hunk" : "@@ -146,6 +147,65 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** Static component of the salt used to compute short txids for transaction reconciliation. */\n+static const std::string RECON_STATIC_SALT = \"Tx Relay Salting\";\n+/** Used to convert a floating point reconciliation coefficient q to an int for transmission. */\n+static constexpr double Q_PRECISION{2 << 12};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r548678244",
      "id" : 548678244,
      "in_reply_to_id" : 546306680,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODY3ODI0NA==",
      "original_commit_id" : "80bde2b1aae6897ba29a6d18ef76cd8990daeff5",
      "original_line" : 160,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 558699086,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/548678244",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-01-11T21:34:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-758239282",
      "id" : 758239282,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1ODIzOTI4Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-11T21:34:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/758239282",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559247494"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559247494"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is no longer a set.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-17T22:24:38Z",
      "diff_hunk" : "@@ -556,9 +556,11 @@ class CNode\n \n         mutable RecursiveMutex cs_tx_inventory;\n         CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_tx_inventory){50000, 0.000001};\n-        // Set of transaction ids we still have to announce.\n-        // They are sorted by the mempool before relay, so the order is not important.\n-        std::set<uint256> setInventoryTxToSend;\n+        // Set of transaction ids we still have to announce, and whether we may flood them:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559247494",
      "id" : 559247494,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTI0NzQ5NA==",
      "original_commit_id" : "f472f3077e6860f2ec6b1ecb3d4b47fc929bccb3",
      "original_line" : 559,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 570100861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559247494",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559247594"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559247594"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\nstatic constexpr std::chrono::microseconds RECON_REQUEST_INTERVAL{16s};\r\n```\r\n\r\nSaves repeating the chrono type",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-17T22:25:32Z",
      "diff_hunk" : "@@ -146,6 +153,37 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** Static component of the salt used to compute short txids for transaction reconciliation. */\n+static const std::string RECON_STATIC_SALT = \"Tx Relay Salting\";\n+/** Used to convert a floating point reconciliation coefficient q to an int for transmission. Specified by BIP-330. */\n+static constexpr uint16_t Q_PRECISION{(2 << 14) - 1};\n+/**\n+ * When considering whether we should flood to an outbound connection supporting reconciliation,\n+ * see how many outbound connections are already used for flooding. Flood only if the limit is not reached.\n+ * It helps to save bandwidth and reduce the privacy leak.\n+ */\n+static constexpr uint32_t MAX_OUTBOUND_FLOOD_TO = 8;\n+/**\n+ * Interval between sending reconciliation request to the same peer.\n+ * This value allows to reconcile ~100 transactions (7 tx/s * 16s) during normal system operation at capacity.\n+ * More frequent reconciliations would cause significant constant bandwidth overhead due to\n+ * reconciliation metadata (sketch sizes etc.), which would nullify the efficiency.\n+ * Less frequent reconciliations would introduce high transaction relay latency.\n+ */\n+static constexpr std::chrono::microseconds RECON_REQUEST_INTERVAL{std::chrono::seconds{16}};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559247594",
      "id" : 559247594,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTI0NzU5NA==",
      "original_commit_id" : "f472f3077e6860f2ec6b1ecb3d4b47fc929bccb3",
      "original_line" : 173,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 570100861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559247594",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559247689"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559247689"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Any reason not to use a bool here?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-17T22:26:15Z",
      "diff_hunk" : "@@ -146,6 +153,37 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** Static component of the salt used to compute short txids for transaction reconciliation. */\n+static const std::string RECON_STATIC_SALT = \"Tx Relay Salting\";\n+/** Used to convert a floating point reconciliation coefficient q to an int for transmission. Specified by BIP-330. */\n+static constexpr uint16_t Q_PRECISION{(2 << 14) - 1};\n+/**\n+ * When considering whether we should flood to an outbound connection supporting reconciliation,\n+ * see how many outbound connections are already used for flooding. Flood only if the limit is not reached.\n+ * It helps to save bandwidth and reduce the privacy leak.\n+ */\n+static constexpr uint32_t MAX_OUTBOUND_FLOOD_TO = 8;\n+/**\n+ * Interval between sending reconciliation request to the same peer.\n+ * This value allows to reconcile ~100 transactions (7 tx/s * 16s) during normal system operation at capacity.\n+ * More frequent reconciliations would cause significant constant bandwidth overhead due to\n+ * reconciliation metadata (sketch sizes etc.), which would nullify the efficiency.\n+ * Less frequent reconciliations would introduce high transaction relay latency.\n+ */\n+static constexpr std::chrono::microseconds RECON_REQUEST_INTERVAL{std::chrono::seconds{16}};\n+/**\n+ * Interval between responding to peers' reconciliation requests.\n+ * We don't respond to reconciliation requests right away because that would enable monitoring\n+ * when we receive transactions (privacy leak).\n+ */\n+static constexpr std::chrono::microseconds RECON_RESPONSE_INTERVAL{std::chrono::seconds{2}};\n+\n+/** Represents a reconciliation result, used to decide what to do when the reconciliation is over. */\n+enum ReconResult {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559247689",
      "id" : 559247689,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTI0NzY4OQ==",
      "original_commit_id" : "f472f3077e6860f2ec6b1ecb3d4b47fc929bccb3",
      "original_line" : 182,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 570100861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559247689",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559248117"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559248117"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's easy enough to instantiate a new `CNetMsgMaker` from the CNode, rather than passing it as an argument. If you make this function a member of `PeerManagerImpl` you can also avoid passing the `CConnman&`.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-17T22:29:12Z",
      "diff_hunk" : "@@ -2267,6 +2355,29 @@ static void ProcessGetCFCheckPt(CNode& peer, CDataStream& vRecv, const CChainPar\n     connman.PushMessage(&peer, std::move(msg));\n }\n \n+/**\n+ * Announce transactions a peer is missing after reconciliation is done.\n+ * No need to add transactions to peer's filter or do checks\n+ * because it was already done when adding to the reconciliation set.\n+ */\n+void static AnnounceTxs(const std::vector<uint256>& remote_missing_wtxids, CNode& pto, const CNetMsgMaker& msgMaker, CConnman& connman)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559248117",
      "id" : 559248117,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTI0ODExNw==",
      "original_commit_id" : "f472f3077e6860f2ec6b1ecb3d4b47fc929bccb3",
      "original_line" : 2363,
      "original_position" : 182,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 570100861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559248117",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559248234"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559248234"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Consider inverting this if condition to make this a guard clause and avoid deep indentations below.\r\n\r\n```suggestion\r\n    if (remote_missing_wtxids.size() == 0) return;\r\n```",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-17T22:30:08Z",
      "diff_hunk" : "@@ -2267,6 +2355,29 @@ static void ProcessGetCFCheckPt(CNode& peer, CDataStream& vRecv, const CChainPar\n     connman.PushMessage(&peer, std::move(msg));\n }\n \n+/**\n+ * Announce transactions a peer is missing after reconciliation is done.\n+ * No need to add transactions to peer's filter or do checks\n+ * because it was already done when adding to the reconciliation set.\n+ */\n+void static AnnounceTxs(const std::vector<uint256>& remote_missing_wtxids, CNode& pto, const CNetMsgMaker& msgMaker, CConnman& connman)\n+{\n+    if (remote_missing_wtxids.size() != 0) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559248234",
      "id" : 559248234,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTI0ODIzNA==",
      "original_commit_id" : "f472f3077e6860f2ec6b1ecb3d4b47fc929bccb3",
      "original_line" : 2365,
      "original_position" : 184,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 570100861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559248234",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559248400"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559248400"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps reserve max(size of remote_missing_wtxids, MAX_INV_SIZE) to avoid reallocations.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-17T22:31:27Z",
      "diff_hunk" : "@@ -2267,6 +2355,29 @@ static void ProcessGetCFCheckPt(CNode& peer, CDataStream& vRecv, const CChainPar\n     connman.PushMessage(&peer, std::move(msg));\n }\n \n+/**\n+ * Announce transactions a peer is missing after reconciliation is done.\n+ * No need to add transactions to peer's filter or do checks\n+ * because it was already done when adding to the reconciliation set.\n+ */\n+void static AnnounceTxs(const std::vector<uint256>& remote_missing_wtxids, CNode& pto, const CNetMsgMaker& msgMaker, CConnman& connman)\n+{\n+    if (remote_missing_wtxids.size() != 0) {\n+        std::vector<CInv> remote_missing_invs;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559248400",
      "id" : 559248400,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTI0ODQwMA==",
      "original_commit_id" : "f472f3077e6860f2ec6b1ecb3d4b47fc929bccb3",
      "original_line" : 2366,
      "original_position" : 185,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 570100861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559248400",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559248515"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559248515"
         }
      },
      "author_association" : "MEMBER",
      "body" : "A bit of space/comments in this code block would make it easier to read.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-17T22:32:39Z",
      "diff_hunk" : "@@ -3751,6 +3943,165 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    std::chrono::microseconds current_time = GetTime<std::chrono::microseconds>();\n+\n+    // Record an (expected) reconciliation request with parameters to respond when time comes.\n+    // All initial reconciliation responses will be done at the same time to prevent tx-related privacy leaks.\n+    if (msg_type == NetMsgType::REQRECON) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559248515",
      "id" : 559248515,
      "line" : 4182,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTI0ODUxNQ==",
      "original_commit_id" : "f472f3077e6860f2ec6b1ecb3d4b47fc929bccb3",
      "original_line" : 4182,
      "original_position" : 324,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 386,
      "pull_request_review_id" : 570100861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559248515",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559248593"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559248593"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Again, spacing/comments would make this more legible.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-17T22:33:24Z",
      "diff_hunk" : "@@ -3751,6 +3943,165 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    std::chrono::microseconds current_time = GetTime<std::chrono::microseconds>();\n+\n+    // Record an (expected) reconciliation request with parameters to respond when time comes.\n+    // All initial reconciliation responses will be done at the same time to prevent tx-related privacy leaks.\n+    if (msg_type == NetMsgType::REQRECON) {\n+        LOCK(peer->cs_recon_state);\n+        if (peer->m_recon_state == nullptr) return;\n+        if (!peer->m_recon_state->m_requestor) return;\n+        if (peer->m_recon_state->m_incoming_recon != Peer::ReconState::ReconPhase::NONE) return;\n+        uint16_t peer_recon_set_size, peer_q;\n+        vRecv >> peer_recon_set_size >> peer_q;\n+        peer->m_recon_state->m_incoming_recon = Peer::ReconState::ReconPhase::INIT_REQUESTED;\n+        peer->m_recon_state->m_remote_set_size = peer_recon_set_size;\n+        peer->m_recon_state->m_remote_q = double(peer_q / Q_PRECISION);\n+        double remote_q = double(peer_q / Q_PRECISION);\n+        assert(remote_q >= 0);\n+        if (remote_q > 2) return;\n+        peer->m_recon_state->m_remote_q = remote_q;\n+        peer->m_recon_state->m_next_recon_respond = NextReconRespond(current_time);\n+        return;\n+    }\n+\n+    // Received a response to the reconciliation request (initial request or request for extension if initial failed).\n+    // May leak tx-related privacy if we announce local transactions right away, if a peer is strategic about sending\n+    // sketches to us via different connections (requires attacker to occupy multiple outgoing connections).\n+    if (msg_type == NetMsgType::SKETCH) {\n+        LOCK(peer->cs_recon_state);\n+        if (peer->m_recon_state == nullptr) return;\n+        if (peer->m_recon_state->m_outgoing_recon != Peer::ReconState::ReconPhase::INIT_REQUESTED &&\n+            peer->m_recon_state->m_outgoing_recon != Peer::ReconState::ReconPhase::EXT_REQUESTED) return;\n+\n+        std::vector<uint8_t> skdata;\n+        vRecv >> skdata;\n+\n+        if (skdata.size() / BYTES_PER_SKETCH_CAPACITY > MAX_SKETCH_CAPACITY) {\n+            pfrom.fDisconnect = true;\n+            return;\n+        }\n+\n+        // Attempt to decode the received sketch with a local sketch.\n+        // Handles both initial reconciliation and extension cases.\n+        if (skdata.size() / BYTES_PER_SKETCH_CAPACITY > MAX_SKETCH_CAPACITY) return;\n+        if (peer->m_recon_state->m_outgoing_recon == Peer::ReconState::ReconPhase::EXT_REQUESTED) {\n+            // A sketch extension is missing the lower elements (to be a valid extended sketch), which we stored on our side at initial reconciliation step.\n+            skdata.insert(skdata.begin(), peer->m_recon_state->m_remote_sketch_snapshot.begin(), peer->m_recon_state->m_remote_sketch_snapshot.end());\n+        }\n+\n+        uint16_t remote_sketch_capacity = uint16_t(skdata.size() / BYTES_PER_SKETCH_CAPACITY);\n+\n+        Minisketch local_sketch, remote_sketch;\n+        if (remote_sketch_capacity != 0) {\n+            remote_sketch = Minisketch(RECON_FIELD_SIZE, 0, remote_sketch_capacity).Deserialize(skdata);\n+        }\n+        if (peer->m_recon_state->m_outgoing_recon == Peer::ReconState::ReconPhase::INIT_REQUESTED) {\n+            local_sketch = peer->m_recon_state->ComputeSketch(peer->m_recon_state->m_local_set, remote_sketch_capacity);\n+            peer->m_recon_state->m_capacity_snapshot = remote_sketch_capacity;\n+        } else {\n+            local_sketch = peer->m_recon_state->ComputeExtendedSketch();\n+        }\n+\n+        if (remote_sketch_capacity == 0 || !remote_sketch || !local_sketch) {\n+            LogPrint(BCLog::NET, \"Outgoing reconciliation with peer=%I failed due to %s \\n\", pfrom.GetId(),\n+                remote_sketch_capacity == 0 ? \"empty sketch\" : \"minisketch API failure\");\n+            std::vector<uint256> remote_missing;\n+            if (peer->m_recon_state->m_outgoing_recon == Peer::ReconState::ReconPhase::INIT_REQUESTED) {\n+                remote_missing = std::vector<uint256>(peer->m_recon_state->m_local_set.begin(), peer->m_recon_state->m_local_set.end());\n+                peer->m_recon_state->FinalizeReconciliation(true, Peer::ReconState::LocalQAction::Q_SET_DEFAULT, 0, 0);\n+            } else {\n+                remote_missing = std::vector<uint256>(peer->m_recon_state->m_local_set_snapshot.begin(), peer->m_recon_state->m_local_set_snapshot.end());\n+                peer->m_recon_state->FinalizeReconciliation(false, Peer::ReconState::LocalQAction::Q_SET_DEFAULT, 0, 0);\n+            }\n+            m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::RECONCILDIFF, uint8_t(RECON_FAILED), std::vector<uint256>()));\n+            AnnounceTxs(remote_missing, pfrom, msgMaker, m_connman);\n+            return;\n+        }\n+\n+        assert(remote_sketch);\n+        assert(local_sketch);\n+        // Attempt to decode the set difference\n+        std::vector<uint64_t> differences(remote_sketch_capacity);\n+        if (local_sketch.Merge(remote_sketch).Decode(differences)) {\n+            // Reconciliation over the current working sketch succeeded\n+            std::vector<uint32_t> local_missing;\n+            if (peer->m_recon_state->m_outgoing_recon == Peer::ReconState::ReconPhase::INIT_REQUESTED) {\n+                // Initial reconciliation succeeded\n+                // Send/request transactions which found to be missing\n+                LogPrint(BCLog::NET, \"Outgoing reconciliation with peer=%i succeeded without extension\\n\", pfrom.GetId());\n+                std::vector<uint256> remote_missing = peer->m_recon_state->GetRelevantIDsFromShortIDs(differences, local_missing);\n+                AnnounceTxs(remote_missing, pfrom, msgMaker, m_connman);\n+                m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::RECONCILDIFF, uint8_t(RECON_SUCCESS), local_missing));\n+                peer->m_recon_state->FinalizeReconciliation(true, Peer::ReconState::LocalQAction::Q_RECOMPUTE, local_missing.size(), remote_missing.size());\n+            } else {\n+                // Reconciliation with extended sketch succeeded.\n+                LogPrint(BCLog::NET, \"Outgoing reconciliation with peer=%I succeeded with extension\\n\", pfrom.GetId());\n+                std::vector<uint256> remote_missing = peer->m_recon_state->GetRelevantIDsFromShortIDs(differences, local_missing);\n+                AnnounceTxs(remote_missing, pfrom, msgMaker, m_connman);\n+                m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::RECONCILDIFF, uint8_t(RECON_SUCCESS), local_missing));\n+                peer->m_recon_state->FinalizeReconciliation(true, Peer::ReconState::LocalQAction::Q_RECOMPUTE, local_missing.size(), remote_missing.size());\n+            }\n+        } else {\n+            // Reconciliation over the current working sketch failed.\n+            if (peer->m_recon_state->m_outgoing_recon == Peer::ReconState::ReconPhase::INIT_REQUESTED) {\n+                // Initial reconciliation failed.\n+                // Store the received sketch and the local sketch, request extension.\n+\n+                // Prepare to process extension.\n+                peer->m_recon_state->m_remote_sketch_snapshot = skdata;\n+                peer->m_recon_state->m_local_set_snapshot = peer->m_recon_state->m_local_set;\n+                peer->m_recon_state->m_local_set.clear();\n+                LogPrint(BCLog::NET, \"Outgoing reconciliation with peer=%i initially failed, requesting extension sketch\\n\", pfrom.GetId());\n+                m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::REQSKETCHEXT));\n+                peer->m_recon_state->m_outgoing_recon = Peer::ReconState::ReconPhase::EXT_REQUESTED;\n+            } else {\n+                // Reconciliation over extended sketch failed.\n+                // Announce all local transactions from the reconciliation set.\n+                // All remote transactions will be announced by peer due to the reconciliation failure flag.\n+\n+                LogPrint(BCLog::NET, \"Outgoing reconciliation with peer=%I failed after extension \\n\", pfrom.GetId());\n+                std::vector<uint256> remote_missing(peer->m_recon_state->m_local_set_snapshot.begin(), peer->m_recon_state->m_local_set_snapshot.end());\n+                m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::RECONCILDIFF, uint8_t(RECON_FAILED), std::vector<uint32_t>()));\n+                peer->m_recon_state->FinalizeReconciliation(false, Peer::ReconState::LocalQAction::Q_SET_DEFAULT, 0, 0);\n+                AnnounceTxs(remote_missing, pfrom, msgMaker, m_connman);\n+            }\n+        }\n+        return;\n+    }\n+\n+    // Peer requesting extension after initial reconciliation failed on their side.\n+    // No privacy leak can happen here because sketch extension is constructed over the snapshot.\n+    if (msg_type == NetMsgType::REQSKETCHEXT) {\n+        LOCK(peer->cs_recon_state);\n+        if (peer->m_recon_state == nullptr) return;\n+        if (peer->m_recon_state->m_incoming_recon != Peer::ReconState::ReconPhase::INIT_RESPONDED) return;\n+        peer->m_recon_state->m_incoming_recon = Peer::ReconState::ReconPhase::EXT_REQUESTED;\n+        return;\n+    }\n+\n+    // Among transactions requested by short ID here, we should send only those transactions\n+    // sketched (stored in local set snapshot), because otherwise we would leak privacy (mempool content).\n+    if (msg_type == NetMsgType::RECONCILDIFF) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559248593",
      "id" : 559248593,
      "line" : 4307,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTI0ODU5Mw==",
      "original_commit_id" : "f472f3077e6860f2ec6b1ecb3d4b47fc929bccb3",
      "original_line" : 4307,
      "original_position" : 459,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 511,
      "pull_request_review_id" : 570100861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559248593",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559248746"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559248746"
         }
      },
      "author_association" : "MEMBER",
      "body" : "sort",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-17T22:34:40Z",
      "diff_hunk" : "@@ -11,6 +11,7 @@\n #include <sync.h>\n #include <txrequest.h>\n #include <validationinterface.h>\n+#include <minisketch/include/minisketch.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559248746",
      "id" : 559248746,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTI0ODc0Ng==",
      "original_commit_id" : "f472f3077e6860f2ec6b1ecb3d4b47fc929bccb3",
      "original_line" : 14,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 570100861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559248746",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559248856"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559248856"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This doesn't need to be in the header, since it's only used inside net_processing.cpp.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-17T22:35:32Z",
      "diff_hunk" : "@@ -31,6 +32,19 @@ static const bool DEFAULT_PEERBLOOMFILTERS = false;\n static const bool DEFAULT_PEERBLOCKFILTERS = false;\n /** Threshold for marking a node to be discouraged, e.g. disconnected and added to the discouragement filter. */\n static const int DISCOURAGEMENT_THRESHOLD{100};\n+/** The size of the field, used to compute sketches to reconcile transactions (see BIP-330). */\n+static constexpr unsigned int RECON_FIELD_SIZE = 32;\n+static constexpr unsigned int BYTES_PER_SKETCH_CAPACITY = RECON_FIELD_SIZE / 8;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559248856",
      "id" : 559248856,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTI0ODg1Ng==",
      "original_commit_id" : "f472f3077e6860f2ec6b1ecb3d4b47fc929bccb3",
      "original_line" : 37,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 570100861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559248856",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559249350"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559249350"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Inside a structure inside `Peer` feels like the wrong place for a lot of this complex logic. I think ideally, `Peer` would continue to be a struct (i.e. data members only) and the logic would be contained in a separate module.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-17T22:38:48Z",
      "diff_hunk" : "@@ -89,7 +103,314 @@ struct Peer {\n     /** Work queue of items requested by this peer **/\n     std::deque<CInv> m_getdata_requests GUARDED_BY(m_getdata_requests_mutex);\n \n-    explicit Peer(NodeId id) : m_id(id) {}\n+    explicit Peer(NodeId id) : m_id(id), m_local_recon_salt(GetRand(UINT64_MAX)) {}\n+\n+    /**\n+     * Salt used to compute short IDs during transaction reconciliation.\n+     * Salt is generated randomly per-connection to prevent linking of\n+     * connections belonging to the same physical node.\n+     * Also, salts should be different per-connection to prevent halting\n+     * of relay of particular transactions due to collisions in short IDs.\n+     */\n+    const uint64_t m_local_recon_salt;\n+\n+    /**\n+     * This struct is used to keep track of the reconciliations with a given peer.\n+     * Transaction reconciliation means an efficient synchronization of the known\n+     * transactions between a pair of peers.\n+     * One reconciliation round consists of a sequence of messages. The sequence is\n+     * asymmetrical, there is always a requestor and a responder. At the end of the\n+     * sequence, nodes are supposed to exchange transactions, so that both of them\n+     * have all relevant transactions. For more protocol details, refer to BIP-0330.\n+     */\n+    struct ReconState {\n+        /** Default coefficient used to estimate set difference for tx reconciliation. */\n+        static constexpr double DEFAULT_RECON_Q = 0.02;\n+\n+        ReconState(bool requestor, bool responder, bool flood_to, uint64_t k0, uint64_t k1) :\n+            m_requestor(requestor), m_responder(responder), m_flood_to(flood_to), m_k0(k0), m_k1(k1), m_local_q(DEFAULT_RECON_Q) {}\n+\n+        /// Whether this peer will send reconciliation requests.\n+        bool m_requestor;\n+\n+        /// Whether this peer will respond to reconciliation requests.\n+        bool m_responder;\n+\n+        /**\n+         * Since reconciliation-only approach makes transaction relay\n+         * significantly slower, we also announce some of the transactions\n+         * (currently, transactions received from inbound links)\n+         * to some of the peers:\n+         * - all pre-reconciliation peers supporting transaction relay;\n+         * - a limited number of outbound reconciling peers *for which this flag is enabled*.\n+         * We enable this flag based on whether we have a\n+         * sufficient number of outbound transaction relay peers.\n+         * This flooding makes transaction relay across the network faster\n+         * without introducing high the bandwidth overhead.\n+         * Transactions announced via flooding should not be added to\n+         * the reconciliation set.\n+         */\n+        bool m_flood_to;\n+\n+        /**\n+         * Reconciliation involves computing and transmitting sketches,\n+         * which is a bandwidth-efficient representation of transaction IDs.\n+         * Since computing sketches over full txID is too CPU-expensive,\n+         * they will be computed over shortened IDs instead.\n+         * These short IDs will be salted so that they are not the same\n+         * across all pairs of peers, because otherwise it would enable network-wide\n+         * collisions which may (intentionally or not) halt relay of certain transactions.\n+         * Both of the peers contribute to the salt.\n+         */\n+        const uint64_t m_k0, m_k1;\n+\n+        /**\n+         * Computing a set reconciliation sketch involves estimating the difference\n+         * between sets of transactions on two sides of the connection. More specifically,\n+         * a sketch capacity is computed as\n+         * |set_size - local_set_size| + q * (set_size + local_set_size) + c,\n+         * where c is a small constant, and q is a node+connection-specific coefficient.\n+         * This coefficient is recomputed by every node based on its previous reconciliations,\n+         * to better predict future set size differences.\n+         */\n+        double m_local_q;\n+\n+        /**\n+         * Store all transactions which we would relay to the peer (policy checks passed, etc.) in this set\n+         * instead of announcing them right away. When reconciliation time comes, we will\n+         * compute an efficient representation of this set (\"sketch\") and use it to efficient reconcile\n+         * this set with a similar set on the other side of the connection.\n+         */\n+        std::set<uint256> m_local_set;\n+\n+        /**\n+         * A reconciliation request comes from a peer with a reconciliation set size from their side,\n+         * which is supposed to help us to estimate set difference size. The value is stored here until\n+         * we respond to that request with a sketch.\n+         */\n+        uint16_t m_remote_set_size;\n+\n+        /**\n+         * The use of q coefficients is described above (see local_q comment).\n+         * The value transmitted from the peer with a reconciliation requests is stored here until\n+         * we respond to that request with a sketch.\n+         */\n+        double m_remote_q;\n+\n+        /**\n+         * When a reconciliation request is received, instead of responding to it right away,\n+         * we schedule a response for later, so that a spy can't monitor our reconciliation sets.\n+         */\n+        std::chrono::microseconds m_next_recon_respond{0};\n+\n+        /**\n+         * Used to keep track of the current reconciliation round with a peer.\n+         * Used for both inbound (responded) and outgoing (requested/initiated) reconciliations.\n+         * Currently only one sketch extension request is supported.\n+         */\n+        enum ReconPhase {\n+            NONE,\n+            INIT_REQUESTED,\n+            INIT_RESPONDED,\n+            EXT_REQUESTED,\n+            EXT_RESPONDED,\n+        };\n+        ReconPhase m_outgoing_recon{ReconPhase::NONE};\n+        ReconPhase m_incoming_recon{ReconPhase::NONE};\n+\n+        /**\n+         * Reconciliation sketches are computed over short transaction IDs.\n+         * This is a cache of these IDs enabling faster lookups of full wtxids,\n+         * useful when peer will ask for missing transactions by short IDs\n+         * at the end of a reconciliation round.\n+         */\n+        std::map<uint32_t, uint256> m_local_short_id_mapping;\n+\n+        /**\n+         * A reconciliation round may involve an extension, which is an extra exchange of messages.\n+         * Since it may happen after a delay (at least network latency), new transactions may come\n+         * during that time. To avoid mixing old and new transactions, those which are subject for\n+         * extension of a current reconciliation round are moved to a reconciliation set snapshot\n+         * after an initial (non-extended) sketch is sent.\n+         * New transactions are kept in the regular reconciliation set.\n+         */\n+        std::set<uint256> m_local_set_snapshot;\n+\n+        /**\n+         * A reconciliation round may involve an extension, in which case we should remember\n+         * a capacity of the sketch sent out initially, so that a sketch extension is of the same size.\n+         */\n+        uint16_t m_capacity_snapshot{0};\n+\n+        /**\n+         * In a reconciliation round initiated by us, if we asked for an extension, we want to store\n+         * the sketch computed/transmitted in the initial step, so that we can use it when\n+         * sketch extension arrives.\n+         */\n+        std::vector<uint8_t> m_remote_sketch_snapshot;\n+\n+        /**\n+        * Reconciliation sketches are computed over short transaction IDs.\n+        * Short IDs are salted with a link-specific constant value.\n+        */\n+        uint32_t ComputeShortID(const uint256 wtxid) const\n+        {\n+            uint64_t s = SipHashUint256(m_k0, m_k1, wtxid);\n+            uint32_t short_txid = 1 + (s & 0xFFFFFFFF);\n+            return short_txid;\n+        }\n+\n+        /**\n+         * Estimate a capacity of a sketch we will send or use locally (to find set difference)\n+         * based on the local set size.\n+         */\n+        uint16_t EstimateSketchCapacity() const\n+        {\n+            uint16_t set_size_diff = std::abs(uint16_t(m_local_set.size()) - m_remote_set_size);\n+            uint16_t min_size = std::min(uint16_t(m_local_set.size()), m_remote_set_size);\n+            uint16_t weighted_min_size = m_remote_q * min_size;\n+            uint16_t estimated_diff = 1 + weighted_min_size + set_size_diff;\n+            return minisketch_compute_capacity(RECON_FIELD_SIZE, estimated_diff, RECON_FALSE_POSITIVE_COEF);\n+        }\n+\n+        /**\n+         * Reconciliation involves computing a space-efficient representation of transaction identifiers (a sketch).\n+         * A sketch has a capacity meaning it allows reconciling at most a certain number of elements. (see BIP-330).\n+         * Considering whether we are going to send a sketch to a peer or use locally, we estimate the set difference.\n+         */\n+        Minisketch ComputeSketch(const std::set<uint256> local_set, uint16_t& capacity)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559249350",
      "id" : 559249350,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTI0OTM1MA==",
      "original_commit_id" : "f472f3077e6860f2ec6b1ecb3d4b47fc929bccb3",
      "original_line" : 280,
      "original_position" : 208,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 570100861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559249350",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559249519"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559249519"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Don't use old cs nomenclature for mutexes:\r\n\r\n```suggestion\r\n    RecursiveMutex m_recon_state_mutex;\r\n```\r\n\r\nAlso prefer to use a `Mutex` over a `RecursiveMutex` in new code.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-17T22:39:50Z",
      "diff_hunk" : "@@ -89,7 +103,314 @@ struct Peer {\n     /** Work queue of items requested by this peer **/\n     std::deque<CInv> m_getdata_requests GUARDED_BY(m_getdata_requests_mutex);\n \n-    explicit Peer(NodeId id) : m_id(id) {}\n+    explicit Peer(NodeId id) : m_id(id), m_local_recon_salt(GetRand(UINT64_MAX)) {}\n+\n+    /**\n+     * Salt used to compute short IDs during transaction reconciliation.\n+     * Salt is generated randomly per-connection to prevent linking of\n+     * connections belonging to the same physical node.\n+     * Also, salts should be different per-connection to prevent halting\n+     * of relay of particular transactions due to collisions in short IDs.\n+     */\n+    const uint64_t m_local_recon_salt;\n+\n+    /**\n+     * This struct is used to keep track of the reconciliations with a given peer.\n+     * Transaction reconciliation means an efficient synchronization of the known\n+     * transactions between a pair of peers.\n+     * One reconciliation round consists of a sequence of messages. The sequence is\n+     * asymmetrical, there is always a requestor and a responder. At the end of the\n+     * sequence, nodes are supposed to exchange transactions, so that both of them\n+     * have all relevant transactions. For more protocol details, refer to BIP-0330.\n+     */\n+    struct ReconState {\n+        /** Default coefficient used to estimate set difference for tx reconciliation. */\n+        static constexpr double DEFAULT_RECON_Q = 0.02;\n+\n+        ReconState(bool requestor, bool responder, bool flood_to, uint64_t k0, uint64_t k1) :\n+            m_requestor(requestor), m_responder(responder), m_flood_to(flood_to), m_k0(k0), m_k1(k1), m_local_q(DEFAULT_RECON_Q) {}\n+\n+        /// Whether this peer will send reconciliation requests.\n+        bool m_requestor;\n+\n+        /// Whether this peer will respond to reconciliation requests.\n+        bool m_responder;\n+\n+        /**\n+         * Since reconciliation-only approach makes transaction relay\n+         * significantly slower, we also announce some of the transactions\n+         * (currently, transactions received from inbound links)\n+         * to some of the peers:\n+         * - all pre-reconciliation peers supporting transaction relay;\n+         * - a limited number of outbound reconciling peers *for which this flag is enabled*.\n+         * We enable this flag based on whether we have a\n+         * sufficient number of outbound transaction relay peers.\n+         * This flooding makes transaction relay across the network faster\n+         * without introducing high the bandwidth overhead.\n+         * Transactions announced via flooding should not be added to\n+         * the reconciliation set.\n+         */\n+        bool m_flood_to;\n+\n+        /**\n+         * Reconciliation involves computing and transmitting sketches,\n+         * which is a bandwidth-efficient representation of transaction IDs.\n+         * Since computing sketches over full txID is too CPU-expensive,\n+         * they will be computed over shortened IDs instead.\n+         * These short IDs will be salted so that they are not the same\n+         * across all pairs of peers, because otherwise it would enable network-wide\n+         * collisions which may (intentionally or not) halt relay of certain transactions.\n+         * Both of the peers contribute to the salt.\n+         */\n+        const uint64_t m_k0, m_k1;\n+\n+        /**\n+         * Computing a set reconciliation sketch involves estimating the difference\n+         * between sets of transactions on two sides of the connection. More specifically,\n+         * a sketch capacity is computed as\n+         * |set_size - local_set_size| + q * (set_size + local_set_size) + c,\n+         * where c is a small constant, and q is a node+connection-specific coefficient.\n+         * This coefficient is recomputed by every node based on its previous reconciliations,\n+         * to better predict future set size differences.\n+         */\n+        double m_local_q;\n+\n+        /**\n+         * Store all transactions which we would relay to the peer (policy checks passed, etc.) in this set\n+         * instead of announcing them right away. When reconciliation time comes, we will\n+         * compute an efficient representation of this set (\"sketch\") and use it to efficient reconcile\n+         * this set with a similar set on the other side of the connection.\n+         */\n+        std::set<uint256> m_local_set;\n+\n+        /**\n+         * A reconciliation request comes from a peer with a reconciliation set size from their side,\n+         * which is supposed to help us to estimate set difference size. The value is stored here until\n+         * we respond to that request with a sketch.\n+         */\n+        uint16_t m_remote_set_size;\n+\n+        /**\n+         * The use of q coefficients is described above (see local_q comment).\n+         * The value transmitted from the peer with a reconciliation requests is stored here until\n+         * we respond to that request with a sketch.\n+         */\n+        double m_remote_q;\n+\n+        /**\n+         * When a reconciliation request is received, instead of responding to it right away,\n+         * we schedule a response for later, so that a spy can't monitor our reconciliation sets.\n+         */\n+        std::chrono::microseconds m_next_recon_respond{0};\n+\n+        /**\n+         * Used to keep track of the current reconciliation round with a peer.\n+         * Used for both inbound (responded) and outgoing (requested/initiated) reconciliations.\n+         * Currently only one sketch extension request is supported.\n+         */\n+        enum ReconPhase {\n+            NONE,\n+            INIT_REQUESTED,\n+            INIT_RESPONDED,\n+            EXT_REQUESTED,\n+            EXT_RESPONDED,\n+        };\n+        ReconPhase m_outgoing_recon{ReconPhase::NONE};\n+        ReconPhase m_incoming_recon{ReconPhase::NONE};\n+\n+        /**\n+         * Reconciliation sketches are computed over short transaction IDs.\n+         * This is a cache of these IDs enabling faster lookups of full wtxids,\n+         * useful when peer will ask for missing transactions by short IDs\n+         * at the end of a reconciliation round.\n+         */\n+        std::map<uint32_t, uint256> m_local_short_id_mapping;\n+\n+        /**\n+         * A reconciliation round may involve an extension, which is an extra exchange of messages.\n+         * Since it may happen after a delay (at least network latency), new transactions may come\n+         * during that time. To avoid mixing old and new transactions, those which are subject for\n+         * extension of a current reconciliation round are moved to a reconciliation set snapshot\n+         * after an initial (non-extended) sketch is sent.\n+         * New transactions are kept in the regular reconciliation set.\n+         */\n+        std::set<uint256> m_local_set_snapshot;\n+\n+        /**\n+         * A reconciliation round may involve an extension, in which case we should remember\n+         * a capacity of the sketch sent out initially, so that a sketch extension is of the same size.\n+         */\n+        uint16_t m_capacity_snapshot{0};\n+\n+        /**\n+         * In a reconciliation round initiated by us, if we asked for an extension, we want to store\n+         * the sketch computed/transmitted in the initial step, so that we can use it when\n+         * sketch extension arrives.\n+         */\n+        std::vector<uint8_t> m_remote_sketch_snapshot;\n+\n+        /**\n+        * Reconciliation sketches are computed over short transaction IDs.\n+        * Short IDs are salted with a link-specific constant value.\n+        */\n+        uint32_t ComputeShortID(const uint256 wtxid) const\n+        {\n+            uint64_t s = SipHashUint256(m_k0, m_k1, wtxid);\n+            uint32_t short_txid = 1 + (s & 0xFFFFFFFF);\n+            return short_txid;\n+        }\n+\n+        /**\n+         * Estimate a capacity of a sketch we will send or use locally (to find set difference)\n+         * based on the local set size.\n+         */\n+        uint16_t EstimateSketchCapacity() const\n+        {\n+            uint16_t set_size_diff = std::abs(uint16_t(m_local_set.size()) - m_remote_set_size);\n+            uint16_t min_size = std::min(uint16_t(m_local_set.size()), m_remote_set_size);\n+            uint16_t weighted_min_size = m_remote_q * min_size;\n+            uint16_t estimated_diff = 1 + weighted_min_size + set_size_diff;\n+            return minisketch_compute_capacity(RECON_FIELD_SIZE, estimated_diff, RECON_FALSE_POSITIVE_COEF);\n+        }\n+\n+        /**\n+         * Reconciliation involves computing a space-efficient representation of transaction identifiers (a sketch).\n+         * A sketch has a capacity meaning it allows reconciling at most a certain number of elements. (see BIP-330).\n+         * Considering whether we are going to send a sketch to a peer or use locally, we estimate the set difference.\n+         */\n+        Minisketch ComputeSketch(const std::set<uint256> local_set, uint16_t& capacity)\n+        {\n+            Minisketch sketch;\n+            if (local_set.size() == 0 || capacity == 0) return sketch; // Avoid serializing/sending an empty sketch.\n+\n+            std::vector<uint32_t> short_ids;\n+            for (const auto& wtxid: local_set) {\n+                uint32_t short_txid = ComputeShortID(wtxid);\n+                short_ids.push_back(short_txid);\n+                m_local_short_id_mapping.emplace(short_txid, wtxid);\n+            }\n+\n+            capacity = std::min(capacity, MAX_SKETCH_CAPACITY);\n+            sketch = Minisketch(RECON_FIELD_SIZE, 0, capacity);\n+            if (sketch) {\n+                for (const uint32_t short_id: short_ids) {\n+                    sketch.Add(short_id);\n+                }\n+            }\n+            return sketch;\n+        }\n+\n+        Minisketch ComputeExtendedSketch() {\n+            // For now, compute a sketch of twice the capacity were computed originally.\n+            // If the sketch is meant to be sent, drop the lower syndromes.\n+            // TODO: optimize by computing the extension *on top* of the existent sketch\n+            // instead of computing the lower order elements again.\n+            uint16_t extended_capacity = m_capacity_snapshot * 2;\n+            return ComputeSketch(m_local_set_snapshot, extended_capacity);\n+        }\n+\n+        /**\n+         * After a reconciliation round is over, the local q coefficient may be adjusted to enable\n+         * better accuracy of future set difference estimations.\n+         * Recompute q in case of full reconciliation success (both initially or after extension).\n+         * In case reconciliation completely failed (initial and extension), fallback to the default q,\n+         * set to cause an overestimation, but should converge to the reasonable q in the next round.\n+         * Note that accurate recompute in case of complete failure is difficult, because it requires waiting for GETDATA/INV\n+         * the peer would send to us, and find the actual difference from there (also may be inaccurate due to the latencies).\n+         */\n+        enum LocalQAction {\n+            Q_KEEP,\n+            Q_RECOMPUTE,\n+            Q_SET_DEFAULT\n+        };\n+\n+        /**\n+         * Clears the state of the peer when the reconciliation is done.\n+         * If this is a extension finalization, keep the reconciliation set to track\n+         * the transactions received from other peers during the reconciliation.\n+         * Also keep the set if this if finalizing initial incoming reconciliation, because\n+         * there was a time frame when we sent out an initial sketch until peer responded.\n+         * If we're finalizing initial outgoing reconciliation, it is safe to clear the set,\n+         * because we do not use the snapshot, but sketch the original set (which might have received\n+         * few new transactions), and finalize the reconciliation immediately.\n+         */\n+        void FinalizeReconciliation(bool clear_local_set, LocalQAction action, size_t actual_local_missing, size_t actual_remote_missing)\n+        {\n+            // According to the erlay spec, reconciliation is initiated by inbound peers.\n+            if (m_requestor) {\n+                assert(m_incoming_recon != ReconPhase::NONE);\n+                m_incoming_recon = ReconPhase::NONE;\n+            } else {\n+                // When reconciliation initialized by us is done, update local q for future reconciliations.\n+                if (action == LocalQAction::Q_RECOMPUTE) {\n+                    assert(m_outgoing_recon != ReconPhase::NONE);\n+                    uint8_t local_set_size;\n+                    if (m_outgoing_recon == ReconPhase::EXT_REQUESTED) {\n+                        local_set_size = m_local_set_snapshot.size();\n+                    } else {\n+                        local_set_size = m_local_set.size();\n+                    }\n+                    uint8_t remote_set_size = local_set_size + actual_local_missing - actual_remote_missing;\n+                    uint8_t set_size_diff = std::abs(local_set_size - remote_set_size);\n+                    uint8_t min_size = std::min(local_set_size, remote_set_size);\n+                    uint8_t actual_difference = actual_local_missing + actual_remote_missing;\n+                    if (min_size != 0) {\n+                        m_local_q = double(actual_difference - set_size_diff) / min_size;\n+                        assert(m_local_q >= 0 && m_local_q <= 2);\n+                    }\n+                } else if (action == LocalQAction::Q_SET_DEFAULT) {\n+                    m_local_q = DEFAULT_RECON_Q;\n+                }\n+                m_outgoing_recon = ReconPhase::NONE;\n+            }\n+            if (clear_local_set) m_local_set.clear();\n+\n+            m_local_short_id_mapping.clear();\n+            // This is currently belt-and-suspenders, as the code should work even without these calls.\n+            m_remote_sketch_snapshot.clear();\n+            m_local_set_snapshot.clear();\n+            m_capacity_snapshot = 0;\n+        }\n+\n+        /**\n+         * When during reconciliation we find a set difference successfully (by combining sketches),\n+         * we want to find which transactions are missing on our and on their side.\n+         * For those missing on our side, we may only find short IDs.\n+         */\n+        std::vector<uint256> GetRelevantIDsFromShortIDs(std::vector<uint64_t> diff, std::vector<uint32_t>& local_missing)\n+        {\n+            std::vector<uint256> remote_missing;\n+            for (const auto& diff_short_id: diff) {\n+                const auto local_tx = m_local_short_id_mapping.find(diff_short_id);\n+                if (local_tx != m_local_short_id_mapping.end()) {\n+                    remote_missing.push_back(local_tx->second);\n+                } else {\n+                    local_missing.push_back(diff_short_id);\n+                }\n+            }\n+            return remote_missing;\n+        }\n+\n+        /**\n+         * After a reconciliation round passed, transactions missing by our peer are known by short ID.\n+         * Look up their full wtxid locally to announce them to the peer.\n+         */\n+        std::vector<uint256> GetWTXIDsFromShortIDs(const std::vector<uint32_t>& remote_missing_short_ids)\n+        {\n+            std::vector<uint256> remote_missing;\n+            for (size_t i = 0; i < remote_missing_short_ids.size(); ++i) {\n+                auto local_tx = m_local_short_id_mapping.find(remote_missing_short_ids[i]);\n+                if (local_tx != m_local_short_id_mapping.end()) {\n+                    remote_missing.push_back(local_tx->second);\n+                }\n+            }\n+            return remote_missing;\n+        }\n+    };\n+\n+    RecursiveMutex cs_recon_state;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559249519",
      "id" : 559249519,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTI0OTUxOQ==",
      "original_commit_id" : "f472f3077e6860f2ec6b1ecb3d4b47fc929bccb3",
      "original_line" : 410,
      "original_position" : 338,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 570100861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559249519",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559249641"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559249641"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Again, prefer a non-reenrant mutex and don't use the cs nomenclature.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-17T22:40:44Z",
      "diff_hunk" : "@@ -232,6 +553,38 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n \n     int64_t m_stale_tip_check_time; //!< Next time to check for stale tip\n \n+    /**\n+     * Return the number of outbound peers we\n+     * relay transactions to by flooding.\n+     * Used to determine whether we should flood to a new peer\n+     * which supports reconciliation, in case we haven't reached\n+     * the outbound flooding bandwidth-conserving limit.\n+     */\n+    size_t GetFloodingOutboundsCount() const;\n+\n+    /**\n+     * Transaction reconciliation should happen with peers in the same order,\n+     * because the efficiency gain is the highest when reconciliation set difference\n+     * is predictable. This queue is used to maintain the order of\n+     * peers chosen for reconciliation.\n+     */\n+    RecursiveMutex cs_recon_queue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559249641",
      "id" : 559249641,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTI0OTY0MQ==",
      "original_commit_id" : "f472f3077e6860f2ec6b1ecb3d4b47fc929bccb3",
      "original_line" : 571,
      "original_position" : 363,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 570100861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559249641",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559249766"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559249766"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why this space?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-17T22:41:45Z",
      "diff_hunk" : "@@ -0,0 +1,595 @@\n+#!/usr/bin/env python3\n+# Copyhigh (c) 2016-2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test reconciliation-based transaction relay protocol.\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559249766",
      "id" : 559249766,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTI0OTc2Ng==",
      "original_commit_id" : "f472f3077e6860f2ec6b1ecb3d4b47fc929bccb3",
      "original_line" : 6,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/p2p_erlay.py",
      "position" : null,
      "pull_request_review_id" : 570100861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559249766",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559249818"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559249818"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Please sort, with standard library imports first.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-17T22:42:06Z",
      "diff_hunk" : "@@ -0,0 +1,595 @@\n+#!/usr/bin/env python3\n+# Copyhigh (c) 2016-2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test reconciliation-based transaction relay protocol.\n+\n+\"\"\"\n+\n+from test_framework.p2p import P2PDataStore, p2p_lock\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, hex_str_to_bytes\n+from test_framework.messages import (\n+    msg_inv, msg_getdata,\n+    msg_sendrecon, msg_reqrecon,\n+    msg_sketch, msg_reqsketchext, msg_reconcildiff,\n+    CTransaction, CInv\n+)\n+from test_framework.siphash import siphash256\n+from test_framework.key import TaggedHash\n+from enum import IntEnum\n+from io import BytesIO\n+import random\n+import hashlib\n+import time\n+import struct",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559249818",
      "id" : 559249818,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTI0OTgxOA==",
      "original_commit_id" : "f472f3077e6860f2ec6b1ecb3d4b47fc929bccb3",
      "original_line" : 25,
      "original_position" : 25,
      "original_start_line" : 9,
      "path" : "test/functional/p2p_erlay.py",
      "position" : null,
      "pull_request_review_id" : 570100861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559249818",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559249883"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559249883"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why not a bool?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-17T22:42:40Z",
      "diff_hunk" : "@@ -0,0 +1,595 @@\n+#!/usr/bin/env python3\n+# Copyhigh (c) 2016-2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test reconciliation-based transaction relay protocol.\n+\n+\"\"\"\n+\n+from test_framework.p2p import P2PDataStore, p2p_lock\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, hex_str_to_bytes\n+from test_framework.messages import (\n+    msg_inv, msg_getdata,\n+    msg_sendrecon, msg_reqrecon,\n+    msg_sketch, msg_reqsketchext, msg_reconcildiff,\n+    CTransaction, CInv\n+)\n+from test_framework.siphash import siphash256\n+from test_framework.key import TaggedHash\n+from enum import IntEnum\n+from io import BytesIO\n+import random\n+import hashlib\n+import time\n+import struct\n+\n+MASK64 = 0xffffffffffffffff\n+MSG_WTX = 5\n+\n+# These parameters are specified in the BIP-0330.\n+Q_PRECISION = (2 << 14) - 1\n+FIELD_BITS = 32\n+FIELD_MODULUS = (1 << FIELD_BITS) + 0b10001101\n+\n+# These parameters are suggested by the Erlay paper based on analysis and simulations.\n+DEFAULT_Q = 0.02\n+RECON_REQUEST_INTERVAL = 16\n+INVENTORY_BROADCAST_INTERVAL = 2\n+PENALIZED_INVENTORY_BROADCAST_INTERVAL = INVENTORY_BROADCAST_INTERVAL * 2\n+MAX_OUTBOUND_FLOOD_TO = 8\n+\n+BYTES_PER_SKETCH_CAPACITY = FIELD_BITS / 8\n+\n+def mul2(x):\n+    \"\"\"Compute 2*x in GF(2^FIELD_BITS)\"\"\"\n+    return (x << 1) ^ (FIELD_MODULUS if x.bit_length() >= FIELD_BITS else 0)\n+\n+def mul(x, y):\n+    \"\"\"Compute x*y in GF(2^FIELD_BITS)\"\"\"\n+    ret = 0\n+    for bit in [(x >> i) & 1 for i in range(x.bit_length())]:\n+        ret, y = ret ^ bit * y, mul2(y)\n+    return ret\n+\n+def create_sketch(shortids, capacity):\n+    \"\"\"Compute the bytes of a sketch for given shortids and given capacity.\"\"\"\n+    odd_sums = [0 for _ in range(capacity)]\n+    for shortid in shortids:\n+        squared = mul(shortid, shortid)\n+        for i in range(capacity):\n+            odd_sums[i] ^= shortid\n+            shortid = mul(shortid, squared)\n+    sketch_bytes = []\n+    for odd_sum in odd_sums:\n+        for i in range(4):\n+            sketch_bytes.append((odd_sum >> (i * 8)) & 0xff)\n+    return sketch_bytes\n+\n+def maybe_add_checksum(capacity):\n+    if capacity < 10:\n+        capacity += 1\n+    return capacity\n+\n+# TestP2PConn: A peer we use to send messages to bitcoind, and store responses.\n+class TestP2PConn(P2PDataStore):\n+    def __init__(self, recon_version, local_salt):\n+        super().__init__()\n+        self.recon_version = recon_version\n+        self.local_salt = local_salt\n+        self.remote_salt = 0\n+        self.last_sendrecon = []\n+        self.last_sketch = []\n+        self.last_inv = []\n+        self.last_tx = []\n+        self.last_reqreconcil = []\n+        self.last_reconcildiff = []\n+        self.last_reqsketchext = []\n+        self.last_getdata = []\n+        self.remote_q = DEFAULT_Q\n+        self.last_wtxidrelay = []\n+\n+    def on_sendrecon(self, message):\n+        self.last_sendrecon.append(message)\n+        self.remote_salt = message.salt\n+\n+    def on_wtxidrelay(self, message):\n+        self.last_wtxidrelay.append(message)\n+\n+    def on_sketch(self, message):\n+        self.last_sketch.append(message)\n+\n+    def on_inv(self, message):\n+        MSG_BLOCK = 2\n+        for inv in message.inv:\n+            if inv.type != MSG_BLOCK: # ignore block invs\n+                self.last_inv.append(inv.hash)\n+\n+    def on_tx(self, message):\n+        self.last_tx.append(message.tx.calc_sha256(True))\n+\n+    def on_reqrecon(self, message):\n+        self.last_reqreconcil.append(message)\n+\n+    def on_reqsketchext(self, message):\n+        self.last_reqsketchext.append(message)\n+\n+    def on_reconcildiff(self, message):\n+        self.last_reconcildiff.append(message)\n+\n+    def send_sendrecon(self, sender, responder):\n+        msg = msg_sendrecon()\n+        msg.salt = self.local_salt\n+        msg.version = self.recon_version\n+        msg.sender = sender\n+        msg.responder = responder\n+        self.send_message(msg)\n+\n+    def send_reqrecon(self, set_size, q):\n+        msg = msg_reqrecon()\n+        msg.set_size = set_size\n+        msg.q = q\n+        self.send_message(msg)\n+\n+    def send_sketch(self, skdata):\n+        msg = msg_sketch()\n+        msg.skdata = skdata\n+        self.send_message(msg)\n+\n+    def send_reqsketchext(self):\n+        msg = msg_reqsketchext()\n+        self.send_message(msg)\n+\n+    def send_reconcildiff(self, success, ask_shortids):\n+        msg = msg_reconcildiff()\n+        msg.success = success\n+        msg.ask_shortids = ask_shortids\n+        self.send_message(msg)\n+\n+    def send_inv(self, inv_wtxids):\n+        msg = msg_inv(inv=[CInv(MSG_WTX, h=wtxid) for wtxid in inv_wtxids])\n+        self.send_message(msg)\n+\n+    def send_getdata(self, ask_wtxids):\n+        msg = msg_getdata(inv=[CInv(MSG_WTX, h=wtxid) for wtxid in ask_wtxids])\n+        self.send_message(msg)\n+\n+class ReconResult(IntEnum):\n+    RECON_FAILED = 0\n+    RECON_SUCCESS = 1",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559249883",
      "id" : 559249883,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTI0OTg4Mw==",
      "original_commit_id" : "f472f3077e6860f2ec6b1ecb3d4b47fc929bccb3",
      "original_line" : 159,
      "original_position" : 159,
      "original_start_line" : 157,
      "path" : "test/functional/p2p_erlay.py",
      "position" : null,
      "pull_request_review_id" : 570100861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559249883",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559249972"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559249972"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think that these are unneeded now that truncated txids aren't used",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-17T22:43:27Z",
      "diff_hunk" : "@@ -121,6 +121,29 @@ def ser_uint256(u):\n     return rs\n \n \n+def deser_uint128(f):\n+    r = 0\n+    for i in range(4):\n+        t = struct.unpack(\"<I\", f.read(4))[0]\n+        r += t << (i * 32)\n+    return r\n+\n+\n+def ser_uint128(u):\n+    rs = b\"\"\n+    for i in range(4):\n+        rs += struct.pack(\"<I\", u & 0xFFFFFFFF)\n+        u >>= 32\n+    return rs",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559249972",
      "id" : 559249972,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTI0OTk3Mg==",
      "original_commit_id" : "f472f3077e6860f2ec6b1ecb3d4b47fc929bccb3",
      "original_line" : 137,
      "original_position" : 17,
      "original_start_line" : 124,
      "path" : "test/functional/test_framework/messages.py",
      "position" : null,
      "pull_request_review_id" : 570100861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559249972",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559250042"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559250042"
         }
      },
      "author_association" : "MEMBER",
      "body" : "why two blank lines?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-17T22:43:55Z",
      "diff_hunk" : "@@ -178,6 +201,49 @@ def ser_uint256_vector(l):\n         r += ser_uint256(i)\n     return r\n \n+def deser_uint128_vector(f):\n+    nit = deser_compact_size(f)\n+    r = []\n+    for i in range(nit):\n+        t = deser_uint128(f)\n+        r.append(t)\n+    return r\n+\n+def ser_uint128_vector(l):\n+    r = ser_compact_size(len(l))\n+    for i in l:\n+        r += ser_uint128(i)\n+    return r\n+\n+def deser_uint32_vector(f):\n+    nit = deser_compact_size(f)\n+    r = []\n+    for i in range(nit):\n+        t = deser_uint32(f)\n+        r.append(t)\n+    return r\n+\n+def ser_uint32_vector(l):\n+    r = ser_compact_size(len(l))\n+    for i in l:\n+        r += ser_uint32(i)\n+    return r\n+\n+def deser_uint8_vector(f):\n+    nit = deser_compact_size(f)\n+    r = []\n+    for i in range(nit):\n+        t = struct.unpack(\"<B\", f.read(1))[0]\n+        r.append(t)\n+    return r\n+\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559250042",
      "id" : 559250042,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTI1MDA0Mg==",
      "original_commit_id" : "f472f3077e6860f2ec6b1ecb3d4b47fc929bccb3",
      "original_line" : 240,
      "original_position" : 70,
      "original_start_line" : 239,
      "path" : "test/functional/test_framework/messages.py",
      "position" : null,
      "pull_request_review_id" : 570100861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559250042",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559250087"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559250087"
         }
      },
      "author_association" : "MEMBER",
      "body" : "sort",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-17T22:44:13Z",
      "diff_hunk" : "@@ -27,6 +27,7 @@\n import struct\n import sys\n import threading\n+import socket",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559250087",
      "id" : 559250087,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTI1MDA4Nw==",
      "original_commit_id" : "f472f3077e6860f2ec6b1ecb3d4b47fc929bccb3",
      "original_line" : 30,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/p2p.py",
      "position" : null,
      "pull_request_review_id" : 570100861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559250087",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559250109"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559250109"
         }
      },
      "author_association" : "MEMBER",
      "body" : "sort",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-17T22:44:21Z",
      "diff_hunk" : "@@ -59,6 +60,11 @@\n     msg_pong,\n     msg_sendaddrv2,\n     msg_sendcmpct,\n+    msg_sendrecon,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559250109",
      "id" : 559250109,
      "line" : 66,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTI1MDEwOQ==",
      "original_commit_id" : "f472f3077e6860f2ec6b1ecb3d4b47fc929bccb3",
      "original_line" : 66,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/p2p.py",
      "position" : 17,
      "pull_request_review_id" : 570100861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559250109",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559250122"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559250122"
         }
      },
      "author_association" : "MEMBER",
      "body" : "sort",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-17T22:44:29Z",
      "diff_hunk" : "@@ -107,6 +113,11 @@\n     b\"verack\": msg_verack,\n     b\"version\": msg_version,\n     b\"wtxidrelay\": msg_wtxidrelay,\n+    b\"sendrecon\": msg_sendrecon,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559250122",
      "id" : 559250122,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTI1MDEyMg==",
      "original_commit_id" : "f472f3077e6860f2ec6b1ecb3d4b47fc929bccb3",
      "original_line" : 116,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/p2p.py",
      "position" : null,
      "pull_request_review_id" : 570100861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559250122",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559250156"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559250156"
         }
      },
      "author_association" : "MEMBER",
      "body" : "sort",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-17T22:44:52Z",
      "diff_hunk" : "@@ -379,6 +408,7 @@ def on_sendaddrv2(self, message): pass\n     def on_sendcmpct(self, message): pass\n     def on_sendheaders(self, message): pass\n     def on_tx(self, message): pass\n+    def on_sendrecon(self, message): pass",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r559250156",
      "id" : 559250156,
      "line" : 429,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTI1MDE1Ng==",
      "original_commit_id" : "f472f3077e6860f2ec6b1ecb3d4b47fc929bccb3",
      "original_line" : 429,
      "original_position" : 74,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/p2p.py",
      "position" : 72,
      "pull_request_review_id" : 570100861,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/559250156",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r560107354"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/560107354"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this should be min, because the vector never exceeds MAX_INV_SIZE.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-19T11:25:54Z",
      "diff_hunk" : "@@ -2267,6 +2355,29 @@ static void ProcessGetCFCheckPt(CNode& peer, CDataStream& vRecv, const CChainPar\n     connman.PushMessage(&peer, std::move(msg));\n }\n \n+/**\n+ * Announce transactions a peer is missing after reconciliation is done.\n+ * No need to add transactions to peer's filter or do checks\n+ * because it was already done when adding to the reconciliation set.\n+ */\n+void static AnnounceTxs(const std::vector<uint256>& remote_missing_wtxids, CNode& pto, const CNetMsgMaker& msgMaker, CConnman& connman)\n+{\n+    if (remote_missing_wtxids.size() != 0) {\n+        std::vector<CInv> remote_missing_invs;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r560107354",
      "id" : 560107354,
      "in_reply_to_id" : 559248400,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDEwNzM1NA==",
      "original_commit_id" : "f472f3077e6860f2ec6b1ecb3d4b47fc929bccb3",
      "original_line" : 2366,
      "original_position" : 185,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 571149947,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/560107354",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r560122958"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/560122958"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yes, you're right. Should be min.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-19T11:54:21Z",
      "diff_hunk" : "@@ -2267,6 +2355,29 @@ static void ProcessGetCFCheckPt(CNode& peer, CDataStream& vRecv, const CChainPar\n     connman.PushMessage(&peer, std::move(msg));\n }\n \n+/**\n+ * Announce transactions a peer is missing after reconciliation is done.\n+ * No need to add transactions to peer's filter or do checks\n+ * because it was already done when adding to the reconciliation set.\n+ */\n+void static AnnounceTxs(const std::vector<uint256>& remote_missing_wtxids, CNode& pto, const CNetMsgMaker& msgMaker, CConnman& connman)\n+{\n+    if (remote_missing_wtxids.size() != 0) {\n+        std::vector<CInv> remote_missing_invs;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r560122958",
      "id" : 560122958,
      "in_reply_to_id" : 559248400,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDEyMjk1OA==",
      "original_commit_id" : "f472f3077e6860f2ec6b1ecb3d4b47fc929bccb3",
      "original_line" : 2366,
      "original_position" : 185,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 571170480,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/560122958",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r560240227"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/560240227"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I can switch to non-recursive if UpdateNextReconRequest() takes `m_recon_queue.size()` as an argument, instead of accessing it inside. Do you think that would be preferable?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-19T15:00:01Z",
      "diff_hunk" : "@@ -232,6 +553,38 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n \n     int64_t m_stale_tip_check_time; //!< Next time to check for stale tip\n \n+    /**\n+     * Return the number of outbound peers we\n+     * relay transactions to by flooding.\n+     * Used to determine whether we should flood to a new peer\n+     * which supports reconciliation, in case we haven't reached\n+     * the outbound flooding bandwidth-conserving limit.\n+     */\n+    size_t GetFloodingOutboundsCount() const;\n+\n+    /**\n+     * Transaction reconciliation should happen with peers in the same order,\n+     * because the efficiency gain is the highest when reconciliation set difference\n+     * is predictable. This queue is used to maintain the order of\n+     * peers chosen for reconciliation.\n+     */\n+    RecursiveMutex cs_recon_queue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r560240227",
      "id" : 560240227,
      "in_reply_to_id" : 559249641,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDI0MDIyNw==",
      "original_commit_id" : "f472f3077e6860f2ec6b1ecb3d4b47fc929bccb3",
      "original_line" : 571,
      "original_position" : 363,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 571328890,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/560240227",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r560259462"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/560259462"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think I can't make it non-recursive because of the call inside `GetFloodingOutboundsCount`. How would you suggest to overcome this issue?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-19T15:24:13Z",
      "diff_hunk" : "@@ -89,7 +103,314 @@ struct Peer {\n     /** Work queue of items requested by this peer **/\n     std::deque<CInv> m_getdata_requests GUARDED_BY(m_getdata_requests_mutex);\n \n-    explicit Peer(NodeId id) : m_id(id) {}\n+    explicit Peer(NodeId id) : m_id(id), m_local_recon_salt(GetRand(UINT64_MAX)) {}\n+\n+    /**\n+     * Salt used to compute short IDs during transaction reconciliation.\n+     * Salt is generated randomly per-connection to prevent linking of\n+     * connections belonging to the same physical node.\n+     * Also, salts should be different per-connection to prevent halting\n+     * of relay of particular transactions due to collisions in short IDs.\n+     */\n+    const uint64_t m_local_recon_salt;\n+\n+    /**\n+     * This struct is used to keep track of the reconciliations with a given peer.\n+     * Transaction reconciliation means an efficient synchronization of the known\n+     * transactions between a pair of peers.\n+     * One reconciliation round consists of a sequence of messages. The sequence is\n+     * asymmetrical, there is always a requestor and a responder. At the end of the\n+     * sequence, nodes are supposed to exchange transactions, so that both of them\n+     * have all relevant transactions. For more protocol details, refer to BIP-0330.\n+     */\n+    struct ReconState {\n+        /** Default coefficient used to estimate set difference for tx reconciliation. */\n+        static constexpr double DEFAULT_RECON_Q = 0.02;\n+\n+        ReconState(bool requestor, bool responder, bool flood_to, uint64_t k0, uint64_t k1) :\n+            m_requestor(requestor), m_responder(responder), m_flood_to(flood_to), m_k0(k0), m_k1(k1), m_local_q(DEFAULT_RECON_Q) {}\n+\n+        /// Whether this peer will send reconciliation requests.\n+        bool m_requestor;\n+\n+        /// Whether this peer will respond to reconciliation requests.\n+        bool m_responder;\n+\n+        /**\n+         * Since reconciliation-only approach makes transaction relay\n+         * significantly slower, we also announce some of the transactions\n+         * (currently, transactions received from inbound links)\n+         * to some of the peers:\n+         * - all pre-reconciliation peers supporting transaction relay;\n+         * - a limited number of outbound reconciling peers *for which this flag is enabled*.\n+         * We enable this flag based on whether we have a\n+         * sufficient number of outbound transaction relay peers.\n+         * This flooding makes transaction relay across the network faster\n+         * without introducing high the bandwidth overhead.\n+         * Transactions announced via flooding should not be added to\n+         * the reconciliation set.\n+         */\n+        bool m_flood_to;\n+\n+        /**\n+         * Reconciliation involves computing and transmitting sketches,\n+         * which is a bandwidth-efficient representation of transaction IDs.\n+         * Since computing sketches over full txID is too CPU-expensive,\n+         * they will be computed over shortened IDs instead.\n+         * These short IDs will be salted so that they are not the same\n+         * across all pairs of peers, because otherwise it would enable network-wide\n+         * collisions which may (intentionally or not) halt relay of certain transactions.\n+         * Both of the peers contribute to the salt.\n+         */\n+        const uint64_t m_k0, m_k1;\n+\n+        /**\n+         * Computing a set reconciliation sketch involves estimating the difference\n+         * between sets of transactions on two sides of the connection. More specifically,\n+         * a sketch capacity is computed as\n+         * |set_size - local_set_size| + q * (set_size + local_set_size) + c,\n+         * where c is a small constant, and q is a node+connection-specific coefficient.\n+         * This coefficient is recomputed by every node based on its previous reconciliations,\n+         * to better predict future set size differences.\n+         */\n+        double m_local_q;\n+\n+        /**\n+         * Store all transactions which we would relay to the peer (policy checks passed, etc.) in this set\n+         * instead of announcing them right away. When reconciliation time comes, we will\n+         * compute an efficient representation of this set (\"sketch\") and use it to efficient reconcile\n+         * this set with a similar set on the other side of the connection.\n+         */\n+        std::set<uint256> m_local_set;\n+\n+        /**\n+         * A reconciliation request comes from a peer with a reconciliation set size from their side,\n+         * which is supposed to help us to estimate set difference size. The value is stored here until\n+         * we respond to that request with a sketch.\n+         */\n+        uint16_t m_remote_set_size;\n+\n+        /**\n+         * The use of q coefficients is described above (see local_q comment).\n+         * The value transmitted from the peer with a reconciliation requests is stored here until\n+         * we respond to that request with a sketch.\n+         */\n+        double m_remote_q;\n+\n+        /**\n+         * When a reconciliation request is received, instead of responding to it right away,\n+         * we schedule a response for later, so that a spy can't monitor our reconciliation sets.\n+         */\n+        std::chrono::microseconds m_next_recon_respond{0};\n+\n+        /**\n+         * Used to keep track of the current reconciliation round with a peer.\n+         * Used for both inbound (responded) and outgoing (requested/initiated) reconciliations.\n+         * Currently only one sketch extension request is supported.\n+         */\n+        enum ReconPhase {\n+            NONE,\n+            INIT_REQUESTED,\n+            INIT_RESPONDED,\n+            EXT_REQUESTED,\n+            EXT_RESPONDED,\n+        };\n+        ReconPhase m_outgoing_recon{ReconPhase::NONE};\n+        ReconPhase m_incoming_recon{ReconPhase::NONE};\n+\n+        /**\n+         * Reconciliation sketches are computed over short transaction IDs.\n+         * This is a cache of these IDs enabling faster lookups of full wtxids,\n+         * useful when peer will ask for missing transactions by short IDs\n+         * at the end of a reconciliation round.\n+         */\n+        std::map<uint32_t, uint256> m_local_short_id_mapping;\n+\n+        /**\n+         * A reconciliation round may involve an extension, which is an extra exchange of messages.\n+         * Since it may happen after a delay (at least network latency), new transactions may come\n+         * during that time. To avoid mixing old and new transactions, those which are subject for\n+         * extension of a current reconciliation round are moved to a reconciliation set snapshot\n+         * after an initial (non-extended) sketch is sent.\n+         * New transactions are kept in the regular reconciliation set.\n+         */\n+        std::set<uint256> m_local_set_snapshot;\n+\n+        /**\n+         * A reconciliation round may involve an extension, in which case we should remember\n+         * a capacity of the sketch sent out initially, so that a sketch extension is of the same size.\n+         */\n+        uint16_t m_capacity_snapshot{0};\n+\n+        /**\n+         * In a reconciliation round initiated by us, if we asked for an extension, we want to store\n+         * the sketch computed/transmitted in the initial step, so that we can use it when\n+         * sketch extension arrives.\n+         */\n+        std::vector<uint8_t> m_remote_sketch_snapshot;\n+\n+        /**\n+        * Reconciliation sketches are computed over short transaction IDs.\n+        * Short IDs are salted with a link-specific constant value.\n+        */\n+        uint32_t ComputeShortID(const uint256 wtxid) const\n+        {\n+            uint64_t s = SipHashUint256(m_k0, m_k1, wtxid);\n+            uint32_t short_txid = 1 + (s & 0xFFFFFFFF);\n+            return short_txid;\n+        }\n+\n+        /**\n+         * Estimate a capacity of a sketch we will send or use locally (to find set difference)\n+         * based on the local set size.\n+         */\n+        uint16_t EstimateSketchCapacity() const\n+        {\n+            uint16_t set_size_diff = std::abs(uint16_t(m_local_set.size()) - m_remote_set_size);\n+            uint16_t min_size = std::min(uint16_t(m_local_set.size()), m_remote_set_size);\n+            uint16_t weighted_min_size = m_remote_q * min_size;\n+            uint16_t estimated_diff = 1 + weighted_min_size + set_size_diff;\n+            return minisketch_compute_capacity(RECON_FIELD_SIZE, estimated_diff, RECON_FALSE_POSITIVE_COEF);\n+        }\n+\n+        /**\n+         * Reconciliation involves computing a space-efficient representation of transaction identifiers (a sketch).\n+         * A sketch has a capacity meaning it allows reconciling at most a certain number of elements. (see BIP-330).\n+         * Considering whether we are going to send a sketch to a peer or use locally, we estimate the set difference.\n+         */\n+        Minisketch ComputeSketch(const std::set<uint256> local_set, uint16_t& capacity)\n+        {\n+            Minisketch sketch;\n+            if (local_set.size() == 0 || capacity == 0) return sketch; // Avoid serializing/sending an empty sketch.\n+\n+            std::vector<uint32_t> short_ids;\n+            for (const auto& wtxid: local_set) {\n+                uint32_t short_txid = ComputeShortID(wtxid);\n+                short_ids.push_back(short_txid);\n+                m_local_short_id_mapping.emplace(short_txid, wtxid);\n+            }\n+\n+            capacity = std::min(capacity, MAX_SKETCH_CAPACITY);\n+            sketch = Minisketch(RECON_FIELD_SIZE, 0, capacity);\n+            if (sketch) {\n+                for (const uint32_t short_id: short_ids) {\n+                    sketch.Add(short_id);\n+                }\n+            }\n+            return sketch;\n+        }\n+\n+        Minisketch ComputeExtendedSketch() {\n+            // For now, compute a sketch of twice the capacity were computed originally.\n+            // If the sketch is meant to be sent, drop the lower syndromes.\n+            // TODO: optimize by computing the extension *on top* of the existent sketch\n+            // instead of computing the lower order elements again.\n+            uint16_t extended_capacity = m_capacity_snapshot * 2;\n+            return ComputeSketch(m_local_set_snapshot, extended_capacity);\n+        }\n+\n+        /**\n+         * After a reconciliation round is over, the local q coefficient may be adjusted to enable\n+         * better accuracy of future set difference estimations.\n+         * Recompute q in case of full reconciliation success (both initially or after extension).\n+         * In case reconciliation completely failed (initial and extension), fallback to the default q,\n+         * set to cause an overestimation, but should converge to the reasonable q in the next round.\n+         * Note that accurate recompute in case of complete failure is difficult, because it requires waiting for GETDATA/INV\n+         * the peer would send to us, and find the actual difference from there (also may be inaccurate due to the latencies).\n+         */\n+        enum LocalQAction {\n+            Q_KEEP,\n+            Q_RECOMPUTE,\n+            Q_SET_DEFAULT\n+        };\n+\n+        /**\n+         * Clears the state of the peer when the reconciliation is done.\n+         * If this is a extension finalization, keep the reconciliation set to track\n+         * the transactions received from other peers during the reconciliation.\n+         * Also keep the set if this if finalizing initial incoming reconciliation, because\n+         * there was a time frame when we sent out an initial sketch until peer responded.\n+         * If we're finalizing initial outgoing reconciliation, it is safe to clear the set,\n+         * because we do not use the snapshot, but sketch the original set (which might have received\n+         * few new transactions), and finalize the reconciliation immediately.\n+         */\n+        void FinalizeReconciliation(bool clear_local_set, LocalQAction action, size_t actual_local_missing, size_t actual_remote_missing)\n+        {\n+            // According to the erlay spec, reconciliation is initiated by inbound peers.\n+            if (m_requestor) {\n+                assert(m_incoming_recon != ReconPhase::NONE);\n+                m_incoming_recon = ReconPhase::NONE;\n+            } else {\n+                // When reconciliation initialized by us is done, update local q for future reconciliations.\n+                if (action == LocalQAction::Q_RECOMPUTE) {\n+                    assert(m_outgoing_recon != ReconPhase::NONE);\n+                    uint8_t local_set_size;\n+                    if (m_outgoing_recon == ReconPhase::EXT_REQUESTED) {\n+                        local_set_size = m_local_set_snapshot.size();\n+                    } else {\n+                        local_set_size = m_local_set.size();\n+                    }\n+                    uint8_t remote_set_size = local_set_size + actual_local_missing - actual_remote_missing;\n+                    uint8_t set_size_diff = std::abs(local_set_size - remote_set_size);\n+                    uint8_t min_size = std::min(local_set_size, remote_set_size);\n+                    uint8_t actual_difference = actual_local_missing + actual_remote_missing;\n+                    if (min_size != 0) {\n+                        m_local_q = double(actual_difference - set_size_diff) / min_size;\n+                        assert(m_local_q >= 0 && m_local_q <= 2);\n+                    }\n+                } else if (action == LocalQAction::Q_SET_DEFAULT) {\n+                    m_local_q = DEFAULT_RECON_Q;\n+                }\n+                m_outgoing_recon = ReconPhase::NONE;\n+            }\n+            if (clear_local_set) m_local_set.clear();\n+\n+            m_local_short_id_mapping.clear();\n+            // This is currently belt-and-suspenders, as the code should work even without these calls.\n+            m_remote_sketch_snapshot.clear();\n+            m_local_set_snapshot.clear();\n+            m_capacity_snapshot = 0;\n+        }\n+\n+        /**\n+         * When during reconciliation we find a set difference successfully (by combining sketches),\n+         * we want to find which transactions are missing on our and on their side.\n+         * For those missing on our side, we may only find short IDs.\n+         */\n+        std::vector<uint256> GetRelevantIDsFromShortIDs(std::vector<uint64_t> diff, std::vector<uint32_t>& local_missing)\n+        {\n+            std::vector<uint256> remote_missing;\n+            for (const auto& diff_short_id: diff) {\n+                const auto local_tx = m_local_short_id_mapping.find(diff_short_id);\n+                if (local_tx != m_local_short_id_mapping.end()) {\n+                    remote_missing.push_back(local_tx->second);\n+                } else {\n+                    local_missing.push_back(diff_short_id);\n+                }\n+            }\n+            return remote_missing;\n+        }\n+\n+        /**\n+         * After a reconciliation round passed, transactions missing by our peer are known by short ID.\n+         * Look up their full wtxid locally to announce them to the peer.\n+         */\n+        std::vector<uint256> GetWTXIDsFromShortIDs(const std::vector<uint32_t>& remote_missing_short_ids)\n+        {\n+            std::vector<uint256> remote_missing;\n+            for (size_t i = 0; i < remote_missing_short_ids.size(); ++i) {\n+                auto local_tx = m_local_short_id_mapping.find(remote_missing_short_ids[i]);\n+                if (local_tx != m_local_short_id_mapping.end()) {\n+                    remote_missing.push_back(local_tx->second);\n+                }\n+            }\n+            return remote_missing;\n+        }\n+    };\n+\n+    RecursiveMutex cs_recon_state;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r560259462",
      "id" : 560259462,
      "in_reply_to_id" : 559249519,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDI1OTQ2Mg==",
      "original_commit_id" : "f472f3077e6860f2ec6b1ecb3d4b47fc929bccb3",
      "original_line" : 410,
      "original_position" : 338,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 571355551,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/560259462",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r560311775"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/560311775"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I haven't looked into your branch in great detail, but it looks like `UpdateNextReconRequest()` is only called in one place, which already holds `m_recon_queue_mutex`. Could you make the function `EXCLUSIVE_LOCKS_REQUIRED(m_recon_queue_mutex)` and not retake the mutex inside?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-19T16:30:37Z",
      "diff_hunk" : "@@ -232,6 +553,38 @@ class PeerManager final : public CValidationInterface, public NetEventsInterface\n \n     int64_t m_stale_tip_check_time; //!< Next time to check for stale tip\n \n+    /**\n+     * Return the number of outbound peers we\n+     * relay transactions to by flooding.\n+     * Used to determine whether we should flood to a new peer\n+     * which supports reconciliation, in case we haven't reached\n+     * the outbound flooding bandwidth-conserving limit.\n+     */\n+    size_t GetFloodingOutboundsCount() const;\n+\n+    /**\n+     * Transaction reconciliation should happen with peers in the same order,\n+     * because the efficiency gain is the highest when reconciliation set difference\n+     * is predictable. This queue is used to maintain the order of\n+     * peers chosen for reconciliation.\n+     */\n+    RecursiveMutex cs_recon_queue;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r560311775",
      "id" : 560311775,
      "in_reply_to_id" : 559249641,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDMxMTc3NQ==",
      "original_commit_id" : "f472f3077e6860f2ec6b1ecb3d4b47fc929bccb3",
      "original_line" : 571,
      "original_position" : 363,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 571424901,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/560311775",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r563557030"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563557030"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Please use doxygen style comments.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-25T09:02:38Z",
      "diff_hunk" : "@@ -219,7 +232,20 @@ struct Peer {\n     /** Work queue of items requested by this peer **/\n     std::deque<CInv> m_getdata_requests GUARDED_BY(m_getdata_requests_mutex);\n \n-    explicit Peer(NodeId id) : m_id(id) {}\n+    /**\n+     * Salt used to compute short IDs during transaction reconciliation.\n+     * Salt is generated randomly per-connection to prevent linking of\n+     * connections belonging to the same physical node.\n+     * Also, salts should be different per-connection to prevent halting\n+     * of relay of particular transactions due to collisions in short IDs.\n+     */\n+    const uint64_t m_local_recon_salt;\n+\n+    Mutex m_recon_state_mutex;\n+    /// nullptr if we're not reconciling (neither passively nor actively) with this peer.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r563557030",
      "id" : 563557030,
      "line" : 246,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzU1NzAzMA==",
      "original_commit_id" : "c452e5dbd6808a76e1f616b1269e5394b8b86cd1",
      "original_line" : 246,
      "original_position" : 59,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 67,
      "pull_request_review_id" : 575183702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563557030",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r563557359"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563557359"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This isn't needed in the header.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-25T09:03:12Z",
      "diff_hunk" : "@@ -7,6 +7,7 @@\n #define BITCOIN_NET_PROCESSING_H\n \n #include <net.h>\n+#include <reconciliation.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r563557359",
      "id" : 563557359,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzU1NzM1OQ==",
      "original_commit_id" : "c452e5dbd6808a76e1f616b1269e5394b8b86cd1",
      "original_line" : 10,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 575183702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563557359",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r563558393"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563558393"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Use a `WITH_LOCK()` macro or code block here to avoid holding the mutex for the rest of this block.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-25T09:04:56Z",
      "diff_hunk" : "@@ -3192,7 +3402,13 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             // requests for it.\n             m_txrequest.ForgetTxHash(tx.GetHash());\n             m_txrequest.ForgetTxHash(tx.GetWitnessHash());\n-            RelayTransaction(tx.GetHash(), tx.GetWitnessHash(), m_connman);\n+\n+            // Flood those transactions which were received either via flooding, or inbound reconciliation,\n+            // but NOT via outbound reconciliation. Flooding then is mainly used for initial propagation\n+            // of new transactions across a network of reachable nodes quickly.\n+            LOCK(peer->m_recon_state_mutex);\n+            bool flood = !(peer->m_recon_state && peer->m_recon_state->m_responder);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r563558393",
      "id" : 563558393,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzU1ODM5Mw==",
      "original_commit_id" : "c452e5dbd6808a76e1f616b1269e5394b8b86cd1",
      "original_line" : 3410,
      "original_position" : 368,
      "original_start_line" : 3409,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 575183702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563558393",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r563559617"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563559617"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Please place this inside the `REQRECON` message handling code block (we probably want to split each message handler into its own function in the future, so we should minimize the use of code outside those code blocks).",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-25T09:06:56Z",
      "diff_hunk" : "@@ -3944,6 +4160,163 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         return;\n     }\n \n+    std::chrono::microseconds current_time = GetTime<std::chrono::microseconds>();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r563559617",
      "id" : 563559617,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzU1OTYxNw==",
      "original_commit_id" : "c452e5dbd6808a76e1f616b1269e5394b8b86cd1",
      "original_line" : 4163,
      "original_position" : 377,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 575183702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563559617",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r563560359"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563560359"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not required. There is already a local `peer` in this function.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-25T09:08:03Z",
      "diff_hunk" : "@@ -4543,6 +4916,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         // Message: inventory\n         //\n         std::vector<CInv> vInv;\n+        PeerRef peer = GetPeerRef(pto->GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r563560359",
      "id" : 563560359,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzU2MDM1OQ==",
      "original_commit_id" : "c452e5dbd6808a76e1f616b1269e5394b8b86cd1",
      "original_line" : 4919,
      "original_position" : 555,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 575183702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563560359",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r563561991"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563561991"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No need to mark pass-by-value arguments as const.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-25T09:10:40Z",
      "diff_hunk" : "@@ -688,12 +690,12 @@ class CNode\n         }\n     }\n \n-    void PushTxInventory(const uint256& hash)\n+    void PushTxInventory(const uint256& hash, const bool flood)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r563561991",
      "id" : 563561991,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzU2MTk5MQ==",
      "original_commit_id" : "c452e5dbd6808a76e1f616b1269e5394b8b86cd1",
      "original_line" : 693,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 575183702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563561991",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r563563608"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563563608"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Consider making `flood=false` the default, so that call sites don't need to be updated for this change.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-25T09:13:18Z",
      "diff_hunk" : "@@ -69,6 +70,6 @@ class PeerManager : public CValidationInterface, public NetEventsInterface\n };\n \n /** Relay transaction to every node */\n-void RelayTransaction(const uint256& txid, const uint256& wtxid, const CConnman& connman) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+void RelayTransaction(const uint256& txid, const uint256& wtxid, const CConnman& connman, bool flood) EXCLUSIVE_LOCKS_REQUIRED(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r563563608",
      "id" : 563563608,
      "line" : 72,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzU2MzYwOA==",
      "original_commit_id" : "c452e5dbd6808a76e1f616b1269e5394b8b86cd1",
      "original_line" : 72,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 5,
      "pull_request_review_id" : 575183702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563563608",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r563564589"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563564589"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Add copyright boilerplate",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-25T09:14:53Z",
      "diff_hunk" : "@@ -0,0 +1,335 @@\n+#include <minisketch/include/minisketch.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r563564589",
      "id" : 563564589,
      "line" : 6,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzU2NDU4OQ==",
      "original_commit_id" : "c452e5dbd6808a76e1f616b1269e5394b8b86cd1",
      "original_line" : 6,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/reconciliation.h",
      "position" : 6,
      "pull_request_review_id" : 575183702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563564589",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r563565058"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563565058"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can you try to limit these lines to 80 or 100 chars to avoid wrapping.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-25T09:15:37Z",
      "diff_hunk" : "@@ -0,0 +1,335 @@\n+#include <minisketch/include/minisketch.h>\n+\n+/** Static component of the salt used to compute short txids for transaction reconciliation. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r563565058",
      "id" : 563565058,
      "line" : 14,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzU2NTA1OA==",
      "original_commit_id" : "c452e5dbd6808a76e1f616b1269e5394b8b86cd1",
      "original_line" : 14,
      "original_position" : 3,
      "original_start_line" : null,
      "path" : "src/reconciliation.h",
      "position" : 14,
      "pull_request_review_id" : 575183702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563565058",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r563565500"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563565500"
         }
      },
      "author_association" : "MEMBER",
      "body" : "doxygen",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-25T09:16:16Z",
      "diff_hunk" : "@@ -0,0 +1,335 @@\n+#include <minisketch/include/minisketch.h>\n+\n+/** Static component of the salt used to compute short txids for transaction reconciliation. */\n+static const std::string RECON_STATIC_SALT = \"Tx Relay Salting\";\n+/** Used to convert a floating point reconciliation coefficient q to an int for transmission. Specified by BIP-330. */\n+static constexpr uint16_t Q_PRECISION{(2 << 14) - 1};\n+/**\n+ * Interval between sending reconciliation request to the same peer.\n+ * This value allows to reconcile ~100 transactions (7 tx/s * 16s) during normal system operation at capacity.\n+ * More frequent reconciliations would cause significant constant bandwidth overhead due to\n+ * reconciliation metadata (sketch sizes etc.), which would nullify the efficiency.\n+ * Less frequent reconciliations would introduce high transaction relay latency.\n+ */\n+static constexpr std::chrono::microseconds RECON_REQUEST_INTERVAL{16s};\n+/**\n+ * Interval between responding to peers' reconciliation requests.\n+ * We don't respond to reconciliation requests right away because that would enable monitoring\n+ * when we receive transactions (privacy leak).\n+ */\n+static constexpr std::chrono::microseconds RECON_RESPONSE_INTERVAL{2s};\n+/** The size of the field, used to compute sketches to reconcile transactions (see BIP-330). */\n+static constexpr unsigned int RECON_FIELD_SIZE = 32;\n+/**\n+ * Allows to infer capacity of a reconciliation sketch based on it's char[] representation,\n+ * which is necessary to deserealize a received sketch.\n+ */\n+static constexpr unsigned int BYTES_PER_SKETCH_CAPACITY = RECON_FIELD_SIZE / 8;\n+/** Limit sketch capacity to avoid DoS. */\n+static constexpr uint16_t MAX_SKETCH_CAPACITY = 2 << 12;\n+/**\n+* It is possible that if sketch encodes more elements than the capacity, or\n+* if it is constructed of random bytes, sketch decoding may \"succeed\",\n+* but the result will be nonsense (false-positive decoding).\n+* Given this coef, a false positive probability will be of 1 in 2**coef.\n+*/\n+static constexpr unsigned int RECON_FALSE_POSITIVE_COEF = 16;\n+static_assert(RECON_FALSE_POSITIVE_COEF <= 256,\n+    \"Reducing reconciliation false positives beyond 1 in 2**256 is not supported\");\n+\n+/**\n+ * Used to keep track of the current reconciliation round with a peer.\n+ * Used for both inbound (responded) and outgoing (requested/initiated) reconciliations.\n+ * Currently only one sketch extension request is supported.\n+ */\n+enum ReconPhase {\n+    RECON_NONE,\n+    RECON_INIT_REQUESTED,\n+    RECON_INIT_RESPONDED,\n+    RECON_EXT_REQUESTED,\n+    RECON_EXT_RESPONDED,\n+};\n+\n+/**\n+ * After a reconciliation round is over, the local q coefficient may be adjusted to enable\n+ * better accuracy of future set difference estimations.\n+ * Recompute q in case of full reconciliation success (both initially or after extension).\n+ * In case reconciliation completely failed (initial and extension), fallback to the default q,\n+ * set to cause an overestimation, but should converge to the reasonable q in the next round.\n+ * Note that accurate recompute in case of complete failure is difficult, because it requires waiting for GETDATA/INV\n+ * the peer would send to us, and find the actual difference from there (also may be inaccurate due to the latencies).\n+ */\n+enum ReconLocalQAction {\n+    Q_KEEP,\n+    Q_RECOMPUTE,\n+    Q_SET_DEFAULT\n+};\n+\n+/**\n+ * This struct is used to keep track of the reconciliations with a given peer,\n+ * and also short transaction IDs for the next reconciliation round.\n+ * Transaction reconciliation means an efficient synchronization of the known\n+ * transactions between a pair of peers.\n+ * One reconciliation round consists of a sequence of messages. The sequence is\n+ * asymmetrical, there is always a requestor and a responder. At the end of the\n+ * sequence, nodes are supposed to exchange transactions, so that both of them\n+ * have all relevant transactions. For more protocol details, refer to BIP-0330.\n+ */\n+struct ReconState {\n+    /** Default coefficient used to estimate set difference for tx reconciliation. */\n+    static constexpr double DEFAULT_RECON_Q = 0.02;\n+\n+    ReconState(bool requestor, bool responder, bool flood_to, uint64_t k0, uint64_t k1) :\n+        m_requestor(requestor), m_responder(responder), m_flood_to(flood_to), m_k0(k0), m_k1(k1), m_local_q(DEFAULT_RECON_Q) {}\n+\n+    /// Whether this peer will send reconciliation requests.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r563565500",
      "id" : 563565500,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzU2NTUwMA==",
      "original_commit_id" : "c452e5dbd6808a76e1f616b1269e5394b8b86cd1",
      "original_line" : 85,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/reconciliation.h",
      "position" : null,
      "pull_request_review_id" : 575183702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563565500",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r563566154"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563566154"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This file should include all the standard library headers that it uses (eg chrono, set, etc)",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-25T09:17:20Z",
      "diff_hunk" : "@@ -0,0 +1,335 @@\n+#include <minisketch/include/minisketch.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r563566154",
      "id" : 563566154,
      "line" : 6,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzU2NjE1NA==",
      "original_commit_id" : "c452e5dbd6808a76e1f616b1269e5394b8b86cd1",
      "original_line" : 6,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/reconciliation.h",
      "position" : 6,
      "pull_request_review_id" : 575183702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563566154",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r563566739"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563566739"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Add include guards",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-25T09:18:10Z",
      "diff_hunk" : "@@ -0,0 +1,335 @@\n+#include <minisketch/include/minisketch.h>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r563566739",
      "id" : 563566739,
      "line" : 6,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzU2NjczOQ==",
      "original_commit_id" : "c452e5dbd6808a76e1f616b1269e5394b8b86cd1",
      "original_line" : 6,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/reconciliation.h",
      "position" : 6,
      "pull_request_review_id" : 575183702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563566739",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r563568993"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563568993"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This should really be a class since it has function members.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-01-25T09:21:37Z",
      "diff_hunk" : "@@ -0,0 +1,335 @@\n+#include <minisketch/include/minisketch.h>\n+\n+/** Static component of the salt used to compute short txids for transaction reconciliation. */\n+static const std::string RECON_STATIC_SALT = \"Tx Relay Salting\";\n+/** Used to convert a floating point reconciliation coefficient q to an int for transmission. Specified by BIP-330. */\n+static constexpr uint16_t Q_PRECISION{(2 << 14) - 1};\n+/**\n+ * Interval between sending reconciliation request to the same peer.\n+ * This value allows to reconcile ~100 transactions (7 tx/s * 16s) during normal system operation at capacity.\n+ * More frequent reconciliations would cause significant constant bandwidth overhead due to\n+ * reconciliation metadata (sketch sizes etc.), which would nullify the efficiency.\n+ * Less frequent reconciliations would introduce high transaction relay latency.\n+ */\n+static constexpr std::chrono::microseconds RECON_REQUEST_INTERVAL{16s};\n+/**\n+ * Interval between responding to peers' reconciliation requests.\n+ * We don't respond to reconciliation requests right away because that would enable monitoring\n+ * when we receive transactions (privacy leak).\n+ */\n+static constexpr std::chrono::microseconds RECON_RESPONSE_INTERVAL{2s};\n+/** The size of the field, used to compute sketches to reconcile transactions (see BIP-330). */\n+static constexpr unsigned int RECON_FIELD_SIZE = 32;\n+/**\n+ * Allows to infer capacity of a reconciliation sketch based on it's char[] representation,\n+ * which is necessary to deserealize a received sketch.\n+ */\n+static constexpr unsigned int BYTES_PER_SKETCH_CAPACITY = RECON_FIELD_SIZE / 8;\n+/** Limit sketch capacity to avoid DoS. */\n+static constexpr uint16_t MAX_SKETCH_CAPACITY = 2 << 12;\n+/**\n+* It is possible that if sketch encodes more elements than the capacity, or\n+* if it is constructed of random bytes, sketch decoding may \"succeed\",\n+* but the result will be nonsense (false-positive decoding).\n+* Given this coef, a false positive probability will be of 1 in 2**coef.\n+*/\n+static constexpr unsigned int RECON_FALSE_POSITIVE_COEF = 16;\n+static_assert(RECON_FALSE_POSITIVE_COEF <= 256,\n+    \"Reducing reconciliation false positives beyond 1 in 2**256 is not supported\");\n+\n+/**\n+ * Used to keep track of the current reconciliation round with a peer.\n+ * Used for both inbound (responded) and outgoing (requested/initiated) reconciliations.\n+ * Currently only one sketch extension request is supported.\n+ */\n+enum ReconPhase {\n+    RECON_NONE,\n+    RECON_INIT_REQUESTED,\n+    RECON_INIT_RESPONDED,\n+    RECON_EXT_REQUESTED,\n+    RECON_EXT_RESPONDED,\n+};\n+\n+/**\n+ * After a reconciliation round is over, the local q coefficient may be adjusted to enable\n+ * better accuracy of future set difference estimations.\n+ * Recompute q in case of full reconciliation success (both initially or after extension).\n+ * In case reconciliation completely failed (initial and extension), fallback to the default q,\n+ * set to cause an overestimation, but should converge to the reasonable q in the next round.\n+ * Note that accurate recompute in case of complete failure is difficult, because it requires waiting for GETDATA/INV\n+ * the peer would send to us, and find the actual difference from there (also may be inaccurate due to the latencies).\n+ */\n+enum ReconLocalQAction {\n+    Q_KEEP,\n+    Q_RECOMPUTE,\n+    Q_SET_DEFAULT\n+};\n+\n+/**\n+ * This struct is used to keep track of the reconciliations with a given peer,\n+ * and also short transaction IDs for the next reconciliation round.\n+ * Transaction reconciliation means an efficient synchronization of the known\n+ * transactions between a pair of peers.\n+ * One reconciliation round consists of a sequence of messages. The sequence is\n+ * asymmetrical, there is always a requestor and a responder. At the end of the\n+ * sequence, nodes are supposed to exchange transactions, so that both of them\n+ * have all relevant transactions. For more protocol details, refer to BIP-0330.\n+ */\n+struct ReconState {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r563568993",
      "id" : 563568993,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzU2ODk5Mw==",
      "original_commit_id" : "c452e5dbd6808a76e1f616b1269e5394b8b86cd1",
      "original_line" : 78,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/reconciliation.h",
      "position" : null,
      "pull_request_review_id" : 575183702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563568993",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r571236196"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571236196"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Does this work as intended in the intermediate stage where not all of our peers support Erlay? If we are a non-reachable node that supports Erlay but has just one older pre-Erlay outbound peer - wouldn't we flood all of its transactions also to our Erlay-supporting peers because `flood == true` here? (Considering the goal that \"only well-connected publicly reachable nodes flood transactions to other publicly reachable nodes via outbound connections\").",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-02-05T20:37:29Z",
      "diff_hunk" : "@@ -3358,7 +3375,13 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             // requests for it.\n             m_txrequest.ForgetTxHash(tx.GetHash());\n             m_txrequest.ForgetTxHash(tx.GetWitnessHash());\n-            RelayTransaction(tx.GetHash(), tx.GetWitnessHash(), m_connman);\n+\n+            // Flood those transactions which were received either via flooding, or inbound reconciliation,\n+            // but NOT via outbound reconciliation. Flooding then is mainly used for initial propagation\n+            // of new transactions across a network of reachable nodes quickly.\n+            LOCK(peer->m_recon_state_mutex);\n+            bool flood = !(peer->m_recon_state && peer->m_recon_state->m_responder);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r571236196",
      "id" : 571236196,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTIzNjE5Ng==",
      "original_commit_id" : "ce83d3fbcc0f09808d15a7d2155223430fa45735",
      "original_line" : 3383,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 584688731,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571236196",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r571238532"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571238532"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This message is called \"reqrecon**cil**\" in the BIP.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-02-05T20:42:04Z",
      "diff_hunk" : "@@ -267,6 +267,13 @@ extern const char* WTXIDRELAY;\n  * The salt is used to compute short txids needed for efficient reconciliation.\n  */\n extern const char *SENDRECON;\n+/**\n+ * Requests a reconciliation, and provides local reconciliation set size\n+ * and coefficient used to accurately estimate reconciliation set difference\n+ * for a peer to construct a set sketch.\n+ * Peer should respond with \"sketch\" message.\n+ */\n+extern const char *REQRECON;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r571238532",
      "id" : 571238532,
      "line" : 276,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTIzODUzMg==",
      "original_commit_id" : "f63ad154266307b9d1d28a8c5df7ef1eb74bd76a",
      "original_line" : 276,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/protocol.h",
      "position" : 17,
      "pull_request_review_id" : 584688731,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571238532",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r571310901"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571310901"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Question: is it possible for `peer->m_recon_state->m_outgoing_recon != RECON_NONE`, i.e. we sent them a `REQRECON` around the same time they sent us one?",
      "commit_id" : "c452e5dbd6808a76e1f616b1269e5394b8b86cd1",
      "created_at" : "2021-02-05T23:47:58Z",
      "diff_hunk" : "@@ -3944,6 +4160,163 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         return;\n     }\n \n+    std::chrono::microseconds current_time = GetTime<std::chrono::microseconds>();\n+\n+    // Record an (expected) reconciliation request with parameters to respond when time comes.\n+    // All initial reconciliation responses will be done at the same time to prevent tx-related privacy leaks.\n+    if (msg_type == NetMsgType::REQRECON) {\n+        LOCK(peer->m_recon_state_mutex);\n+        if (peer->m_recon_state == nullptr) return;\n+        if (!peer->m_recon_state->m_requestor) return;\n+        if (peer->m_recon_state->m_incoming_recon != RECON_NONE) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r571310901",
      "id" : 571310901,
      "line" : 4171,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTMxMDkwMQ==",
      "original_commit_id" : "c452e5dbd6808a76e1f616b1269e5394b8b86cd1",
      "original_line" : 4171,
      "original_position" : 385,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 385,
      "pull_request_review_id" : 584780321,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-05T23:47:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/571310901",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573021963"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573021963"
         }
      },
      "author_association" : "MEMBER",
      "body" : "094c4ed\r\n\r\nThis comment is really unclear. What about :\r\n\"Transactions ids and their associated announcement protocols :\r\n- true, use flooding\r\n- false, use reconciliation\"\r\n\r\nI think it's easier to use this map if it stays blind w.r.t to protocol negotiations and flooding-peers selection.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-02-09T16:12:56Z",
      "diff_hunk" : "@@ -551,9 +551,11 @@ class CNode\n \n         mutable RecursiveMutex cs_tx_inventory;\n         CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_tx_inventory){50000, 0.000001};\n-        // Set of transaction ids we still have to announce.\n-        // They are sorted by the mempool before relay, so the order is not important.\n-        std::set<uint256> setInventoryTxToSend;\n+        // Transaction ids we still have to announce, and whether we may flood them:\n+        // - true: flood unless peer correctly negotiated reconciliation and we didn't choose that peer for flooding.\n+        // - false: use reconciliation unless it's not supported by the peer, flood otherwise.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573021963",
      "id" : 573021963,
      "line" : 561,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzAyMTk2Mw==",
      "original_commit_id" : "094c4ed8cb8558c8fdb99b26a2d41d435a4d28bc",
      "original_line" : 561,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 9,
      "pull_request_review_id" : 586724683,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573021963",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573047513"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573047513"
         }
      },
      "author_association" : "MEMBER",
      "body" : "aff98fc\r\n\r\nMaybe precise \"Count how many outbound connections are already used for flooding, including the ones not supporting reconciliation at all\". Until I read `GetFloodingOutboundsCount` I did have a doubt on whether or not this limit was scoping outbound peers not-supporting reconciliation.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-02-09T16:44:17Z",
      "diff_hunk" : "@@ -147,6 +147,12 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/**\n+ * When considering whether we should flood to an outbound connection supporting reconciliation,\n+ * see how many outbound connections are already used for flooding. Flood only if the limit is not reached.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573047513",
      "id" : 573047513,
      "line" : 160,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzA0NzUxMw==",
      "original_commit_id" : "aff98fcc1e83615b9bdff4a240898d15231d5f94",
      "original_line" : 160,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 45,
      "pull_request_review_id" : 586724683,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573047513",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573056635"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573056635"
         }
      },
      "author_association" : "MEMBER",
      "body" : "34a485e\r\n\r\n`m_recon_resp_queue` better ?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-02-09T16:55:08Z",
      "diff_hunk" : "@@ -344,6 +348,15 @@ class PeerManagerImpl final : public PeerManager\n       * on extra block-relay-only peers. */\n     bool m_initial_sync_finished{false};\n \n+    /**\n+     * Transaction reconciliation should happen with peers in the same order,\n+     * because the efficiency gain is the highest when reconciliation set difference\n+     * is predictable. This queue is used to maintain the order of\n+     * peers chosen for reconciliation.\n+     */\n+    Mutex m_recon_queue_mutex;\n+    std::deque<CNode*> m_recon_queue GUARDED_BY(m_recon_queue_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573056635",
      "id" : 573056635,
      "line" : 398,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzA1NjYzNQ==",
      "original_commit_id" : "34a485e0f1c9511fbd18cc6c0d60b6ca8929ccd9",
      "original_line" : 398,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 121,
      "pull_request_review_id" : 586724683,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573056635",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573066725"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573066725"
         }
      },
      "author_association" : "MEMBER",
      "body" : "f63ad15\r\n\r\nLooking on `UpdateNextReconRequest` implementation, I think this should mention the delay is decreasing linearly with the number of reconciliation responders available. \r\n\r\nIIUC, you assume that more we have reconciliation peers, better the propagation of our local transactions set is. Thus we should space our requests to save bandwidth ? If this is correct, maybe link the section or the Erlay paper or anywhere else where it's documented?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-02-09T17:07:22Z",
      "diff_hunk" : "@@ -353,6 +353,13 @@ class PeerManagerImpl final : public PeerManager\n     /** Send a version message to a peer */\n     void PushNodeVersion(CNode& pnode, int64_t nTime);\n \n+    /**\n+     * Reconciliations are requested periodically:\n+     * every RECON_REQUEST_INTERVAL seconds we pick a peer from the queue.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573066725",
      "id" : 573066725,
      "line" : 359,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzA2NjcyNQ==",
      "original_commit_id" : "f63ad154266307b9d1d28a8c5df7ef1eb74bd76a",
      "original_line" : 359,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 95,
      "pull_request_review_id" : 586724683,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573066725",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573094798"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573094798"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ce83d3fb\r\n\r\nThanks for the comment but I don't think the non-reachability is a source of leak for the present scenario. Non-reachable nodes may open connections to outbound not supporting reconciliations, thus relying on flooding for transaction announcements, at least until Erlay is well-deployed. \r\n\r\nI think the leak would be constituted by a differential tx-announcement protocol selection for re-broadcast tx rather than the usual one previously negotiated with the peer. Doesn't matter if it's flooding or reconciliation.\r\n\r\n`inbound->outbound` better to say \"flooding is initiated by inbound towards outbound peers\". Not sure that `->` to signify initiation is well-understood as a comment notation...",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-02-09T17:44:14Z",
      "diff_hunk" : "@@ -1017,7 +1024,15 @@ void PeerManagerImpl::ReattemptInitialBroadcast(CScheduler& scheduler) const\n \n         if (tx != nullptr) {\n             LOCK(cs_main);\n-            RelayTransaction(txid, tx->GetWitnessHash(), m_connman);\n+            // We re-relay these transactions via reconciliation (same as for initial broadcast),\n+            // instead of flooding, to hide the origin of transactions.\n+            // Since in Erlay transactions are flooded only inbound->outbound,\n+            // non-reachable nodes never flood transactions from other nodes (they have no inbounds).\n+            // Thus, making them flood these would tell a receiver that these indeed belong to the\n+            // flooding non-reachable nodes. Instead, we relay them via reconciliation,\n+            // in which case a receiver can't distinguish them from transactions we reconciled\n+            // with some other peer.\n+            RelayTransaction(txid, tx->GetWitnessHash(), m_connman, false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573094798",
      "id" : 573094798,
      "line" : 1064,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzA5NDc5OA==",
      "original_commit_id" : "ce83d3fbcc0f09808d15a7d2155223430fa45735",
      "original_line" : 1064,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 188,
      "pull_request_review_id" : 586724683,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573094798",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573107239"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573107239"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ce83d3fb\r\n\r\nIs the tx-announcement protocol marker is really required `m_transactions_to_announce` given that ultimately you will check peer's `m_recon_state` and `m_flood` to fan out between `vInv`/`txs_to_reconcile` ? A non-wtxid peer should be `m_recon_state==null` anyway.\r\n\r\nI think it's better to remove this notion of announcement protocol selection attached to tx itself and instead only consider the link.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-02-09T17:57:41Z",
      "diff_hunk" : "@@ -1665,17 +1680,19 @@ bool static AlreadyHaveBlock(const uint256& block_hash) EXCLUSIVE_LOCKS_REQUIRED\n     return LookupBlockIndex(block_hash) != nullptr;\n }\n \n-void RelayTransaction(const uint256& txid, const uint256& wtxid, const CConnman& connman)\n+void RelayTransaction(const uint256& txid, const uint256& wtxid, const CConnman& connman, bool flood)\n {\n-    connman.ForEachNode([&txid, &wtxid](CNode* pnode) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    connman.ForEachNode([&txid, &wtxid, flood](CNode* pnode) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n         AssertLockHeld(::cs_main);\n \n         CNodeState* state = State(pnode->GetId());\n         if (state == nullptr) return;\n         if (state->m_wtxid_relay) {\n-            pnode->PushTxInventory(wtxid);\n+            pnode->PushTxInventory(wtxid, flood);\n         } else {\n-            pnode->PushTxInventory(txid);\n+            // Reconciliations are not supported for non-wtxid peers,\n+            // so we always use flooding.\n+            pnode->PushTxInventory(txid, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573107239",
      "id" : 573107239,
      "line" : 1724,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzEwNzIzOQ==",
      "original_commit_id" : "ce83d3fbcc0f09808d15a7d2155223430fa45735",
      "original_line" : 1724,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 224,
      "pull_request_review_id" : 586724683,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573107239",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573184729"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573184729"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Should we disconnect the peer instead of ignoring the message? In all three cases the peer \"misbehaved\" and sent an unsolicited `REQRECON` message.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-02-09T19:41:35Z",
      "diff_hunk" : "@@ -4145,6 +4160,28 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         return;\n     }\n \n+    std::chrono::microseconds current_time = GetTime<std::chrono::microseconds>();\n+\n+    // Record an (expected) reconciliation request with parameters to respond when time comes.\n+    // All initial reconciliation responses will be done at the same time to prevent tx-related privacy leaks.\n+    if (msg_type == NetMsgType::REQRECON) {\n+        LOCK(peer->m_recon_state_mutex);\n+        if (peer->m_recon_state == nullptr) return;\n+        if (!peer->m_recon_state->m_requestor) return;\n+        if (peer->m_recon_state->m_incoming_recon != RECON_NONE) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573184729",
      "id" : 573184729,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzE4NDcyOQ==",
      "original_commit_id" : "7e5d826532ff541266377eb89dc62e1b5f8747cc",
      "original_line" : 4171,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 586937542,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573184729",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573373989"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573373989"
         }
      },
      "author_association" : "NONE",
      "body" : "nit: since order is not important, maybe std::unordered_map for efficiency?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-02-10T01:23:08Z",
      "diff_hunk" : "@@ -551,9 +551,11 @@ class CNode\n \n         mutable RecursiveMutex cs_tx_inventory;\n         CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_tx_inventory){50000, 0.000001};\n-        // Set of transaction ids we still have to announce.\n-        // They are sorted by the mempool before relay, so the order is not important.\n-        std::set<uint256> setInventoryTxToSend;\n+        // Transaction ids we still have to announce, and whether we may flood them:\n+        // - true: flood unless peer correctly negotiated reconciliation and we didn't choose that peer for flooding.\n+        // - false: use reconciliation unless it's not supported by the peer, flood otherwise.\n+        // Transactions are sorted by the mempool before relay, so the order is not important.\n+        std::map<uint256, bool> m_transactions_to_announce;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573373989",
      "id" : 573373989,
      "line" : 563,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzM3Mzk4OQ==",
      "original_commit_id" : "c452e5dbd6808a76e1f616b1269e5394b8b86cd1",
      "original_line" : 563,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 11,
      "pull_request_review_id" : 587168578,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573373989",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/64070857?v=4",
         "events_url" : "https://api.github.com/users/unseddd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/unseddd/followers",
         "following_url" : "https://api.github.com/users/unseddd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/unseddd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/unseddd",
         "id" : 64070857,
         "login" : "unseddd",
         "node_id" : "MDQ6VXNlcjY0MDcwODU3",
         "organizations_url" : "https://api.github.com/users/unseddd/orgs",
         "received_events_url" : "https://api.github.com/users/unseddd/received_events",
         "repos_url" : "https://api.github.com/users/unseddd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/unseddd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/unseddd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/unseddd"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573400775"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573400775"
         }
      },
      "author_association" : "NONE",
      "body" : "nit: consider using smth like:\r\n\r\n```\r\nstatic constexpr std::chrono::microseconds RECON_REQUEST_INTERVAL{16000000};\r\n```\r\n\r\nusing the `\"\" s` operator requires a `using namespace std::chrono_literals` or similar: [https://en.cppreference.com/w/cpp/chrono/operator%22%22s](https://en.cppreference.com/w/cpp/chrono/operator%22%22s).\r\n\r\nSame for `RECON_RESPONSE_INTERVAL`.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-02-10T02:24:04Z",
      "diff_hunk" : "@@ -0,0 +1,335 @@\n+#include <minisketch/include/minisketch.h>\n+\n+/** Static component of the salt used to compute short txids for transaction reconciliation. */\n+static const std::string RECON_STATIC_SALT = \"Tx Relay Salting\";\n+/** Used to convert a floating point reconciliation coefficient q to an int for transmission. Specified by BIP-330. */\n+static constexpr uint16_t Q_PRECISION{(2 << 14) - 1};\n+/**\n+ * Interval between sending reconciliation request to the same peer.\n+ * This value allows to reconcile ~100 transactions (7 tx/s * 16s) during normal system operation at capacity.\n+ * More frequent reconciliations would cause significant constant bandwidth overhead due to\n+ * reconciliation metadata (sketch sizes etc.), which would nullify the efficiency.\n+ * Less frequent reconciliations would introduce high transaction relay latency.\n+ */\n+static constexpr std::chrono::microseconds RECON_REQUEST_INTERVAL{16s};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573400775",
      "id" : 573400775,
      "line" : 27,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzQwMDc3NQ==",
      "original_commit_id" : "c452e5dbd6808a76e1f616b1269e5394b8b86cd1",
      "original_line" : 27,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/reconciliation.h",
      "position" : 27,
      "pull_request_review_id" : 587200668,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573400775",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/64070857?v=4",
         "events_url" : "https://api.github.com/users/unseddd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/unseddd/followers",
         "following_url" : "https://api.github.com/users/unseddd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/unseddd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/unseddd",
         "id" : 64070857,
         "login" : "unseddd",
         "node_id" : "MDQ6VXNlcjY0MDcwODU3",
         "organizations_url" : "https://api.github.com/users/unseddd/orgs",
         "received_events_url" : "https://api.github.com/users/unseddd/received_events",
         "repos_url" : "https://api.github.com/users/unseddd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/unseddd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/unseddd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/unseddd"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Added a couple fuzz harnesses in my [erlay](https://github.com/unseddd/bitcoin/tree/erlay) branch, if you want them.\r\n\r\nAlso contains some other minor fixups, like a change for [src/test/fuzz/net.cpp](https://github.com/bitcoin/bitcoin/blob/master/src/test/fuzz/net.cpp#L89) (for the `flood` param):\r\n\r\n```diff\r\ndiff --git a/src/test/fuzz/net.cpp b/src/test/fuzz/net.cpp\r\nindex 31b99600e..7d48a7ec3 100644\r\n--- a/src/test/fuzz/net.cpp\r\n+++ b/src/test/fuzz/net.cpp\r\n@@ -86,7 +86,8 @@ FUZZ_TARGET_INIT(net, initialize_net)\r\n                 node.AddKnownTx(inv_opt->hash);\r\n             },\r\n             [&] {\r\n-                node.PushTxInventory(ConsumeUInt256(fuzzed_data_provider));\r\n+                node.PushTxInventory(ConsumeUInt256(fuzzed_data_provider), false);\r\n+                node.PushTxInventory(ConsumeUInt256(fuzzed_data_provider), true);\r\n             },\r\n             [&] {\r\n                 const std::optional<CService> service_opt = ConsumeDeserializable<CService>(fuzzed_data_provider);\r\n```",
      "created_at" : "2021-02-10T04:21:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-776429091",
      "id" : 776429091,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NjQyOTA5MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-10T04:21:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/776429091",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/64070857?v=4",
         "events_url" : "https://api.github.com/users/unseddd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/unseddd/followers",
         "following_url" : "https://api.github.com/users/unseddd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/unseddd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/unseddd",
         "id" : 64070857,
         "login" : "unseddd",
         "node_id" : "MDQ6VXNlcjY0MDcwODU3",
         "organizations_url" : "https://api.github.com/users/unseddd/orgs",
         "received_events_url" : "https://api.github.com/users/unseddd/received_events",
         "repos_url" : "https://api.github.com/users/unseddd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/unseddd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/unseddd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/unseddd"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Concept ACK\r\n\r\nI understand that the requestor being the one to compute the sketches protects public nodes against potential DoS. Are there any protections for requestor(s)?\r\n\r\nThinking about the scenario where one public node requests a sketch from a malicious public node who returns parameters for high diff sketches as a DoS.",
      "created_at" : "2021-02-10T04:31:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-776431981",
      "id" : 776431981,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NjQzMTk4MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-10T04:35:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/776431981",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/64070857?v=4",
         "events_url" : "https://api.github.com/users/unseddd/events{/privacy}",
         "followers_url" : "https://api.github.com/users/unseddd/followers",
         "following_url" : "https://api.github.com/users/unseddd/following{/other_user}",
         "gists_url" : "https://api.github.com/users/unseddd/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/unseddd",
         "id" : 64070857,
         "login" : "unseddd",
         "node_id" : "MDQ6VXNlcjY0MDcwODU3",
         "organizations_url" : "https://api.github.com/users/unseddd/orgs",
         "received_events_url" : "https://api.github.com/users/unseddd/received_events",
         "repos_url" : "https://api.github.com/users/unseddd/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/unseddd/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/unseddd/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/unseddd"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think the approach needs rethinking for the reasons stated here: https://github.com/bitcoin/bitcoin/pull/18261#pullrequestreview-570100861. The Erlay logic in this PR is spread across many functions in net_processing.cpp and reconcilliation.h, which means that it's impossible to test that logic in isolation. I suppose that's why there aren't any unit tests included in this PR.\r\n\r\nI think it would be much cleaner to have a fully separate module, similar to how txrequest was separated from the rest of net_processing. That module maintains its own private state and exposes a limited number of interface methods to net_processing. That means that it's possible to very thoroughly unit test and fuzz test that module in isolation.",
      "created_at" : "2021-02-10T10:27:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-776608307",
      "id" : 776608307,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NjYwODMwNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-10T10:27:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/776608307",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Needs rebase.\r\n\r\nEdit: This has 166 hidden comments, so apologies if I missed something, but are there any special build steps or flags to pass? With gcc 10.2.1 I'm seeing 16 occurrences of the same build warning (see comment below) and the functional tests are all failing for me with `detected inconsistent lock order for 'peer->m_recon_state_mutex' in net_processing.cpp:4936 (in thread 'msghand')`. Trying with clang now.\r\n\r\nEdit: no warnings with clang 9 but the functional tests fail for the same reason. \r\n\r\nEdit: updated, rebooted, cleared build cache, made distclean, rinse, repeat...same result.\r\n\r\nEdit: the unit tests also hang for me at `Entering directory '/home/jon/projects/bitcoin/bitcoin/src/minisketch'`\r\n\r\nEdit: if the minisketch unit tests run indefinitely, it may be good to not include them in `make check` (or a bounded run time version)",
      "created_at" : "2021-02-10T10:43:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-776618414",
      "id" : 776618414,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NjYxODQxNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-10T15:14:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/776618414",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573627435"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573627435"
         }
      },
      "author_association" : "MEMBER",
      "body" : "with gcc 10.2.1\r\n```\r\nIn file included from ./reconciliation.h:1,\r\n                 from ./net_processing.h:10,\r\n                 from rpc/net.cpp:13:\r\n./minisketch/include/minisketch.h: In member function âstd::optional<std::vector<long unsigned int> > Minisketch::Decode(size_t) constâ:\r\n./minisketch/include/minisketch.h:293:25: warning: redundant move in return statement [-Wredundant-move]\r\n  293 |         return std::move(result);\r\n      |                ~~~~~~~~~^~~~~~~~\r\n./minisketch/include/minisketch.h:293:25: note: remove âstd::moveâ call\r\n```\r\n",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-02-10T10:49:02Z",
      "diff_hunk" : "@@ -0,0 +1,306 @@\n+#ifndef _MINISKETCH_H_\n+#define _MINISKETCH_H_ 1\n+\n+#ifdef __cplusplus\n+extern \"C\" {\n+#endif\n+\n+#include <stdint.h>\n+#include <stdlib.h>\n+#include <unistd.h>\n+\n+/** Opaque type for decoded sketches. */\n+typedef struct minisketch minisketch;\n+\n+/** Determine whether support for elements of `bits` bits was compiled in. */\n+int minisketch_bits_supported(uint32_t bits);\n+\n+/** Determine the maximum number of implementations available.\n+ *\n+ * Multiple implementations may be available for a given element size, with\n+ * different performance characteristics on different hardware.\n+ *\n+ * Each implementation is identified by a number from 0 to the output of this\n+ * function call, inclusive. Note that not every combination of implementation\n+ * and element size may exist (see further).\n+*/\n+uint32_t minisketch_implementation_max(void);\n+\n+/** Construct a sketch for a given element size, implementation and capacity.\n+ *\n+ * If the combination of `bits` and `implementation` is unavailable, or if\n+ * `capacity` is 0, NULL is returned.\n+ * If the result is not NULL, it must be destroyed using minisketch_destroy.\n+ */\n+minisketch* minisketch_create(uint32_t bits, uint32_t implementation, size_t capacity);\n+\n+/** Get the element size of a sketch in bits. */\n+uint32_t minisketch_bits(const minisketch* sketch);\n+\n+/** Get the capacity of a sketch. */\n+size_t minisketch_capacity(const minisketch* sketch);\n+\n+/** Get the implementation of a sketch. */\n+uint32_t minisketch_implementation(const minisketch* sketch);\n+\n+/** Set the seed for randomizing algorithm choices to a fixed value.\n+ *\n+ * By default, sketches are initialized with a random seed. This is important\n+ * to avoid scenarios where an attacker could force worst-case behavior.\n+ *\n+ * This function initializes the seed to a user-provided value (any 64-bit\n+ * integer is acceptable, regardless of field size).\n+ *\n+ * When seed is -1, a fixed internal value with predictable behavior is\n+ * used. It is only intended for testing.\n+ */\n+void minisketch_set_seed(minisketch* sketch, uint64_t seed);\n+\n+/** Clone a sketch.\n+ *\n+ * The result must be destroyed using minisketch_destroy.\n+ */\n+minisketch* minisketch_clone(const minisketch* sketch);\n+\n+/** Destroy a sketch.\n+ *\n+ * The pointer that was passed in may not be used anymore afterwards.\n+ */\n+void minisketch_destroy(minisketch* sketch);\n+\n+/** Compute the size in bytes for serializing a given sketch. */\n+size_t minisketch_serialized_size(const minisketch* sketch);\n+\n+/** Serialize a sketch to bytes. */\n+void minisketch_serialize(const minisketch* sketch, unsigned char* output);\n+\n+/** Deserialize a sketch from bytes. */\n+void minisketch_deserialize(minisketch* sketch, const unsigned char* input);\n+\n+/** Add an element to a sketch.\n+ * \n+ * If the element to be added is too large for the sketch, the most significant\n+ * bits of the element are dropped. More precisely, if the element size of\n+ * `sketch` is b bits, then this function adds the unsigned integer represented\n+ * by the b least significant bits of `element` to `sketch`.\n+ * \n+ * If the element to be added is 0 (after potentially dropping the most significant\n+ * bits), then this function is a no-op. Sketches cannot contain an element with\n+ * the value 0.\n+ */\n+void minisketch_add_uint64(minisketch* sketch, uint64_t element);\n+\n+/** Merge the elements of another sketch into this sketch.\n+ *\n+ * After merging, `sketch` will contain every element that existed in one but not\n+ * both of the input sketches. It can be seen as an exclusive or operation on\n+ * the set elements.  If the capacity of `other_sketch` is lower than `sketch`'s,\n+ * merging reduces the capacity of `sketch` to that of `other_sketch`.\n+ *\n+ * This function returns the capacity of `sketch` after merging has been performed\n+ * (where this capacity is at least 1), or 0 to indicate that merging has failed because\n+ * the two input sketches differ in their element size or implementation. If 0 is\n+ * returned, `sketch` (and its capacity) have not been modified.\n+ *\n+ * It is also possible to perform this operation directly on the serializations\n+ * of two sketches with the same element size and capacity by performing a bitwise XOR\n+ * of the serializations.\n+ */\n+size_t minisketch_merge(minisketch* sketch, const minisketch* other_sketch);\n+\n+/** Decode a sketch.\n+ *\n+ * `output` is a pointer to an array of `max_element` uint64_t's, which will be\n+ * filled with the elements in this sketch.\n+ *\n+ * The return value is the number of decoded elements, or -1 if decoding failed.\n+ */\n+ssize_t minisketch_decode(const minisketch* sketch, size_t max_elements, uint64_t* output);\n+\n+/** Compute the capacity needed to achieve a certain rate of false positives.\n+ *\n+ * A sketch with capacity c and no more than c elements can always be decoded\n+ * correctly. However, if it has more than c elements, or contains just random\n+ * bytes, it is possible that it will still decode, but the result will be\n+ * nonsense. This can be counteracted by increasing the capacity slightly.\n+ *\n+ * Given a field size bits, an intended number of elements that can be decoded\n+ * max_elements, and a false positive probability of 1 in 2**fpbits, this\n+ * function computes the necessary capacity. It is only guaranteed to be\n+ * accurate up to fpbits=256.\n+ */\n+size_t minisketch_compute_capacity(uint32_t bits, size_t max_elements, uint32_t fpbits);\n+\n+/** Compute what max_elements can be decoded for a certain rate of false positives.\n+ *\n+ * This is the inverse operation of minisketch_compute_capacity. It determines,\n+ * given a field size bits, a capacity of a sketch, and an acceptable false\n+ * positive probability of 1 in 2**fpbits, what the maximum allowed\n+ * max_elements value is. If no value of max_elements would give the desired\n+ * false positive probability, 0 is returned.\n+ *\n+ * Note that this is not an exact inverse of minisketch_compute_capacity. For\n+ * example, with bits=32, fpbits=16, and max_elements=8,\n+ * minisketch_compute_capacity will return 9, as capacity 8 would only have a\n+ * false positive chance of 1 in 2^15.3. Increasing the capacity to 9 however\n+ * decreases the fp chance to 1 in 2^47.3, enough for max_elements=9 (with fp\n+ * chance of 1 in 2^18.5). Therefore, minisketch_compute_max_elements with\n+ * capacity=9 will return 9.\n+ */\n+size_t minisketch_compute_max_elements(uint32_t bits, size_t capacity, uint32_t fpbits);\n+\n+#ifdef __cplusplus\n+}\n+\n+#if __cplusplus >= 201103L\n+#include <memory>\n+#include <vector>\n+#if __cplusplus >= 201703L\n+#include <optional>\n+#endif // __cplusplus >= 201703L\n+#include <cassert>\n+\n+/** Simple RAII C++11 wrapper around the minisketch API. */\n+class Minisketch\n+{\n+    struct Deleter\n+    {\n+        void operator()(minisketch* ptr) const\n+        {\n+            minisketch_destroy(ptr);\n+        }\n+    };\n+\n+    std::unique_ptr<minisketch, Deleter> m_minisketch;\n+\n+public:\n+    /** See minisketch_bits_supported(). */\n+    static bool BitsSupported(uint32_t bits) noexcept { return minisketch_bits_supported(bits); }\n+\n+    /** See minisketch_implementation_max(). */\n+    static uint32_t MaxImplementation() noexcept { return minisketch_implementation_max(); }\n+\n+    /** See minisketch_compute_capacity(). */\n+    static size_t ComputeCapacity(uint32_t bits, size_t max_elements, uint32_t fpbits) noexcept { return minisketch_compute_capacity(bits, max_elements, fpbits); }\n+\n+    /** See minisketch_compute_max_elements(). */\n+    static size_t ComputeMaxElements(uint32_t bits, size_t capacity, uint32_t fpbits) noexcept { return minisketch_compute_max_elements(bits, capacity, fpbits); }\n+\n+    /** Construct a clone of the specified sketch. */\n+    Minisketch(const Minisketch& sketch) noexcept\n+    {\n+        m_minisketch = std::unique_ptr<minisketch, Deleter>(minisketch_clone(sketch.m_minisketch.get()));\n+    }\n+\n+    /** Make this Minisketch a clone of the specified one. */\n+    Minisketch& operator=(const Minisketch& sketch) noexcept\n+    {\n+        m_minisketch = std::unique_ptr<minisketch, Deleter>(minisketch_clone(sketch.m_minisketch.get()));\n+        return *this;\n+    }\n+\n+    explicit operator bool() const noexcept { return bool{m_minisketch}; }\n+\n+    Minisketch() noexcept = default;\n+    Minisketch(Minisketch&&) noexcept = default;\n+    Minisketch& operator=(Minisketch&&) noexcept = default;\n+\n+    /** Construct a Minisketch object with the specified parameters. */\n+    Minisketch(uint32_t bits, uint32_t implementation, size_t capacity) noexcept\n+    {\n+        m_minisketch = std::unique_ptr<minisketch, Deleter>(minisketch_create(bits, implementation, capacity));\n+    }\n+\n+    /** Create a Minisketch object sufficiently large for the specified number of elements at given fpbits. */\n+    static Minisketch CreateFP(uint32_t bits, uint32_t implementation, size_t max_elements, uint32_t fpbits) noexcept\n+    {\n+        return Minisketch(bits, implementation, ComputeCapacity(bits, max_elements, fpbits));\n+    }\n+\n+    /** See minisketch_get_bits(). */\n+    uint32_t GetBits() const noexcept { return minisketch_bits(m_minisketch.get()); }\n+\n+    /** See minisketch_get_capacity(). */\n+    size_t GetCapacity() const noexcept { return minisketch_capacity(m_minisketch.get()); }\n+\n+    /** See minisketch_get_implementation(). */\n+    uint32_t GetImplementation() const noexcept { return minisketch_implementation(m_minisketch.get()); }\n+\n+    /** See minisketch_set_seed(). */\n+    Minisketch& SetSeed(uint64_t seed) noexcept\n+    {\n+        minisketch_set_seed(m_minisketch.get(), seed);\n+        return *this;\n+    }\n+\n+    /** See miniksetch_add_element(). */\n+    Minisketch& Add(uint64_t element) noexcept\n+    {\n+        minisketch_add_uint64(m_minisketch.get(), element);\n+        return *this;\n+    }\n+\n+    /** See minisketch_merge(). */\n+    Minisketch& Merge(const Minisketch& sketch) noexcept\n+    {\n+        minisketch_merge(m_minisketch.get(), sketch.m_minisketch.get());\n+        return *this;\n+    }\n+\n+    /** Decode this sketch into the result vector, which must have a size equal to the maximum allowed elements. */\n+    bool Decode(std::vector<uint64_t>& result) const noexcept\n+    {\n+        ssize_t ret = minisketch_decode(m_minisketch.get(), result.size(), result.data());\n+        if (ret == -1) return false;\n+        result.resize(ret);\n+        return true;\n+    }\n+\n+    /** See minisketch_serialized_size(). */\n+    size_t GetSerializedSize() const noexcept { return minisketch_serialized_size(m_minisketch.get()); }\n+\n+    /** Serialize the sketch as a byte vector. */\n+    std::vector<unsigned char> Serialize() const noexcept\n+    {\n+        std::vector<unsigned char> result(GetSerializedSize());\n+        minisketch_serialize(m_minisketch.get(), result.data());\n+        return result;\n+    }\n+\n+    /** Deserialize into this sketch from an object containing its bytes (which has data() and size() members). */\n+    template<typename T>\n+    Minisketch& Deserialize(\n+        const T& obj,\n+        typename std::enable_if<\n+            std::is_convertible<typename std::remove_pointer<decltype(obj.data())>::type (*)[], const unsigned char (*)[]>::value &&\n+            std::is_convertible<decltype(obj.size()), std::size_t>::value,\n+            std::nullptr_t\n+        >::type = nullptr) noexcept\n+    {\n+        assert(GetSerializedSize() == obj.size());\n+        minisketch_deserialize(m_minisketch.get(), obj.data());\n+        return *this;\n+    }\n+\n+#if __cplusplus >= 201703L\n+    /** C++17 only: decode with a specified number of max elements into an optional vector. */\n+    std::optional<std::vector<uint64_t>> Decode(size_t max_elements) const noexcept\n+    {\n+        std::vector<uint64_t> result(max_elements);\n+        ssize_t ret = minisketch_decode(m_minisketch.get(), max_elements, result.data());\n+        if (ret == -1) return {};\n+        result.resize(ret);\n+        return std::move(result);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573627435",
      "id" : 573627435,
      "line" : 306,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzYyNzQzNQ==",
      "original_commit_id" : "c452e5dbd6808a76e1f616b1269e5394b8b86cd1",
      "original_line" : 306,
      "original_position" : 293,
      "original_start_line" : null,
      "path" : "src/minisketch/include/minisketch.h",
      "position" : 306,
      "pull_request_review_id" : 587476349,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573627435",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573646650"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573646650"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\"only well-connected publicly reachable nodes flood transactions to other publicly reachable nodes via outbound connections\" only is an end-goal when most of the network implement Erlay.\r\n\r\nIn the meanwhile, I think this behavior is better because it's most intuitive: for legacy peers, we support legacy behavior (flood).\r\nTechnically, changing this condition wouldn't break stuff, but I think it's just less intuitive.\r\n\r\nI probably should expand the comment to address this misunderstanding though.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-02-10T11:18:51Z",
      "diff_hunk" : "@@ -3358,7 +3375,13 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             // requests for it.\n             m_txrequest.ForgetTxHash(tx.GetHash());\n             m_txrequest.ForgetTxHash(tx.GetWitnessHash());\n-            RelayTransaction(tx.GetHash(), tx.GetWitnessHash(), m_connman);\n+\n+            // Flood those transactions which were received either via flooding, or inbound reconciliation,\n+            // but NOT via outbound reconciliation. Flooding then is mainly used for initial propagation\n+            // of new transactions across a network of reachable nodes quickly.\n+            LOCK(peer->m_recon_state_mutex);\n+            bool flood = !(peer->m_recon_state && peer->m_recon_state->m_responder);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573646650",
      "id" : 573646650,
      "in_reply_to_id" : 571236196,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzY0NjY1MA==",
      "original_commit_id" : "ce83d3fbcc0f09808d15a7d2155223430fa45735",
      "original_line" : 3383,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 587500539,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573646650",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573655499"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573655499"
         }
      },
      "author_association" : "MEMBER",
      "body" : "How to reflect that if it's \"false, use reconciliation\", it still can be flooded, in case if reconciliation is not supported for a given peer?\r\n",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-02-10T11:33:09Z",
      "diff_hunk" : "@@ -551,9 +551,11 @@ class CNode\n \n         mutable RecursiveMutex cs_tx_inventory;\n         CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_tx_inventory){50000, 0.000001};\n-        // Set of transaction ids we still have to announce.\n-        // They are sorted by the mempool before relay, so the order is not important.\n-        std::set<uint256> setInventoryTxToSend;\n+        // Transaction ids we still have to announce, and whether we may flood them:\n+        // - true: flood unless peer correctly negotiated reconciliation and we didn't choose that peer for flooding.\n+        // - false: use reconciliation unless it's not supported by the peer, flood otherwise.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573655499",
      "id" : 573655499,
      "in_reply_to_id" : 573021963,
      "line" : 561,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzY1NTQ5OQ==",
      "original_commit_id" : "094c4ed8cb8558c8fdb99b26a2d41d435a4d28bc",
      "original_line" : 561,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 9,
      "pull_request_review_id" : 587512207,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573655499",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573668001"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573668001"
         }
      },
      "author_association" : "MEMBER",
      "body" : "After building with both gcc 10.2.1 and clang 9, functional tests are failing with `AssertionError: Unexpected stderr Assertion failed: detected inconsistent lock order for 'peer->m_recon_state_mutex' in net_processing.cpp:4936 (in thread 'msghand')`",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-02-10T11:54:37Z",
      "diff_hunk" : "@@ -4559,22 +4933,23 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n \n             if (pto->m_tx_relay != nullptr) {\n                 LOCK(pto->m_tx_relay->cs_tx_inventory);\n+                LOCK(peer->m_recon_state_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573668001",
      "id" : 573668001,
      "line" : 4943,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzY2ODAwMQ==",
      "original_commit_id" : "c452e5dbd6808a76e1f616b1269e5394b8b86cd1",
      "original_line" : 4943,
      "original_position" : 563,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 551,
      "pull_request_review_id" : 587528209,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573668001",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573739993"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573739993"
         }
      },
      "author_association" : "MEMBER",
      "body" : "See this [comment](https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573107239) which I believe is superseding this discussion. ",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-02-10T13:49:19Z",
      "diff_hunk" : "@@ -551,9 +551,11 @@ class CNode\n \n         mutable RecursiveMutex cs_tx_inventory;\n         CRollingBloomFilter filterInventoryKnown GUARDED_BY(cs_tx_inventory){50000, 0.000001};\n-        // Set of transaction ids we still have to announce.\n-        // They are sorted by the mempool before relay, so the order is not important.\n-        std::set<uint256> setInventoryTxToSend;\n+        // Transaction ids we still have to announce, and whether we may flood them:\n+        // - true: flood unless peer correctly negotiated reconciliation and we didn't choose that peer for flooding.\n+        // - false: use reconciliation unless it's not supported by the peer, flood otherwise.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573739993",
      "id" : 573739993,
      "in_reply_to_id" : 573021963,
      "line" : 561,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzczOTk5Mw==",
      "original_commit_id" : "094c4ed8cb8558c8fdb99b26a2d41d435a4d28bc",
      "original_line" : 561,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 9,
      "pull_request_review_id" : 587617960,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573739993",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573743726"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573743726"
         }
      },
      "author_association" : "MEMBER",
      "body" : "34a485e\r\n\r\nThis checks sounds to assume we may have in the future a new reconciliation protocol for which we would reuse `ReconState` but with a earlier signaling mechanism. Given `SENDRECON` is versioned, I would expect a version-bump to introduce this hypothetical reconciliation protocol instead of new message already spawning `ReconState` allocation.\r\n\r\nThus I think this check can be removed.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-02-10T13:54:30Z",
      "diff_hunk" : "@@ -2795,6 +2808,61 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         return;\n     }\n \n+    // Received from an inbound peer planning to reconcile transactions with us, or\n+    // from an outgoing peer demonstrating readiness to do reconciliations.\n+    // If received from outgoing, adds the peer to the reconciliation queue.\n+    // Feature negotiation of tx reconciliation should happen between VERSION and\n+    // VERACK, to avoid relay problems from switching after a connection is up.\n+    if (msg_type == NetMsgType::SENDRECON) {\n+        if (!pfrom.m_tx_relay) return;\n+        LOCK(peer->m_recon_state_mutex);\n+        if (peer->m_recon_state != nullptr) return; // Do not support reconciliation salt/version updates.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573743726",
      "id" : 573743726,
      "line" : 2944,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Mzc0MzcyNg==",
      "original_commit_id" : "34a485e0f1c9511fbd18cc6c0d60b6ca8929ccd9",
      "original_line" : 2944,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 303,
      "pull_request_review_id" : 587627896,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573743726",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573794642"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573794642"
         }
      },
      "author_association" : "MEMBER",
      "body" : "34a485e\r\n\r\nI don't find the section in the paper where you're detailing the purpose of reconciliation as a redundant tx-announcement for strategic peers ? Given `RECON_REQUEST_INTERVAL` is superior to `INVENTORY_BROADCAST_INTERVAL`, I guess the motivation isn't about improving latency of transactions discovered during floods round towards strategic peers. ",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-02-10T14:56:49Z",
      "diff_hunk" : "@@ -2795,6 +2808,61 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         return;\n     }\n \n+    // Received from an inbound peer planning to reconcile transactions with us, or\n+    // from an outgoing peer demonstrating readiness to do reconciliations.\n+    // If received from outgoing, adds the peer to the reconciliation queue.\n+    // Feature negotiation of tx reconciliation should happen between VERSION and\n+    // VERACK, to avoid relay problems from switching after a connection is up.\n+    if (msg_type == NetMsgType::SENDRECON) {\n+        if (!pfrom.m_tx_relay) return;\n+        LOCK(peer->m_recon_state_mutex);\n+        if (peer->m_recon_state != nullptr) return; // Do not support reconciliation salt/version updates.\n+        LOCK(cs_main);\n+        if (!State(pfrom.GetId())->m_wtxid_relay) return; // SENDRECON is allowed only after WTXIDRELAY.\n+\n+        bool recon_requestor, recon_responder;\n+        uint64_t remote_salt;\n+        uint32_t recon_version;\n+        vRecv >> recon_requestor >> recon_responder >> recon_version >> remote_salt;\n+        if (recon_version != 1) return;\n+\n+        // Do not flood through inbound connections which support reconciliation to save bandwidth.\n+        bool flood_to = false;\n+        if (pfrom.IsInboundConn()) {\n+            // We currently don't support reconciliations with inbound peers which\n+            // don't want to be reconciliation senders (request our sketches),\n+            // or want to be reconciliation responders (send us their sketches).\n+            // Just ignore SENDRECON and use normal flooding for transaction relay with them.\n+            if (!recon_requestor) return;\n+            if (recon_responder) return;\n+        } else {\n+            // We currently don't support reconciliations with outbound peers which\n+            // don't want to be reconciliation responders (send us their sketches),\n+            // or want to be reconciliation senders (request our sketches).\n+            // Just ignore SENDRECON and use normal flooding for transaction relay with them.\n+            if (recon_requestor) return;\n+            if (!recon_responder) return;\n+            // TODO: Flood only through a limited number of outbound connections.\n+            flood_to = true;\n+        }\n+\n+        uint64_t local_salt = peer->m_local_recon_salt;\n+        uint64_t salt1 = local_salt, salt2 = remote_salt;\n+        if (salt1 > salt2) std::swap(salt1, salt2);\n+        static const auto RECON_SALT_HASHER = TaggedHash(RECON_STATIC_SALT);\n+        uint256 full_salt = (CHashWriter(RECON_SALT_HASHER) << salt1 << salt2).GetSHA256();\n+\n+        peer->m_recon_state = MakeUnique<ReconState>(recon_requestor, recon_responder, flood_to, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+\n+        // Reconcile with all outbound peers supporting reconciliation (even if we flood to them),\n+        // to not miss transactions they have for us but won't flood.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573794642",
      "id" : 573794642,
      "line" : 2987,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Mzc5NDY0Mg==",
      "original_commit_id" : "34a485e0f1c9511fbd18cc6c0d60b6ca8929ccd9",
      "original_line" : 2987,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 346,
      "pull_request_review_id" : 587627896,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573794642",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Update: With a  `make clean`, branch compiled fine. Sorry Gleb!\r\n\r\nI had issues compiling this branch as well. Full error: https://pastebin.com/6mc9eRed\r\n\r\nMostly errors like this:\r\n```\r\n  CXXLD    libbitcoinconsensus.la\r\n\r\nUndefined symbols for architecture x86_64:\r\n  \"ChaCha20::ChaCha20(unsigned char const*, unsigned long)\", referenced from:\r\n```\r\n\r\nCommand: ` ./autogen.sh && ./configure && make && make check` \r\n\r\nI didn't git clean or anything, probably had another PR branch up in my local repo before attempting to compile, looked good up until  `libbitcoinconsensus.la`\r\n\r\nSystem info:\r\n\r\n```\r\n--> uname -a\r\nDarwin   18.7.0 Darwin Kernel Version 18.7.0: Tue Aug 20 16:57:14 PDT 2019; root:xnu-4903.271.2~2/RELEASE_X86_64 x86_64\r\n--> gcc -v\r\nConfigured with: --prefix=/Applications/Xcode.app/Contents/Developer/usr --with-gxx-include-dir=/usr/include/c++/4.2.1\r\nApple clang version 11.0.0 (clang-1100.0.33.8)\r\nTarget: x86_64-apple-darwin18.7.0\r\nThread model: posix\r\nInstalledDir: /Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin\r\n```",
      "created_at" : "2021-02-10T15:19:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-776779899",
      "id" : 776779899,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3Njc3OTg5OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-10T15:28:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/776779899",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573824646"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573824646"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ce83d3fb\r\n\r\nIIUC, this comment correctly, you mean that a transaction discovered through an accepted-reconciliation will be marked for reconciliation for its future announcements, no matter the peer type (strategic outbound/non-strategic outbound/inbound).\r\n\r\nI don't get the rational of such approach, propagation of such transactions could be accelerated if we were flooding them for our outbound peers.\r\n\r\nAlso you may consider \"inbound reconciliation\" -> \"initiated reconciliation\", \"outbound reconciliation\" -> \"accepted reconciliation\". Even if reconciliation roles are decided in function of our peer selection, they should be clearly dissociated as orthogonal.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-02-10T15:27:26Z",
      "diff_hunk" : "@@ -3358,7 +3375,13 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             // requests for it.\n             m_txrequest.ForgetTxHash(tx.GetHash());\n             m_txrequest.ForgetTxHash(tx.GetWitnessHash());\n-            RelayTransaction(tx.GetHash(), tx.GetWitnessHash(), m_connman);\n+\n+            // Flood those transactions which were received either via flooding, or inbound reconciliation,\n+            // but NOT via outbound reconciliation. Flooding then is mainly used for initial propagation\n+            // of new transactions across a network of reachable nodes quickly.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573824646",
      "id" : 573824646,
      "line" : 3423,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzgyNDY0Ng==",
      "original_commit_id" : "ce83d3fbcc0f09808d15a7d2155223430fa45735",
      "original_line" : 3423,
      "original_position" : 83,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 374,
      "pull_request_review_id" : 587627896,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573824646",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@naumenkogs the new test I think has the wrong permissions:\r\n\r\n```\r\n-rwxr-xr-x    1 matthewzipkin  staff    5718 Feb  3 10:10 p2p_disconnect_ban.py\r\n-rwxr-xr-x    1 matthewzipkin  staff    3833 Dec  3 15:09 p2p_dos_header_tree.py\r\n-rw-r--r--    1 matthewzipkin  staff   28920 Feb 10 09:34 p2p_erlay.py\r\n-rwxr-xr-x    1 matthewzipkin  staff    5741 Feb  3 10:10 p2p_eviction.py\r\n-rwxr-xr-x    1 matthewzipkin  staff    5185 Feb  3 10:10 p2p_feefilter.py\r\n```\r\n\r\n```\r\n$ test/functional/p2p_erlay.py\r\n-bash: test/functional/p2p_erlay.py: Permission denied\r\n```",
      "created_at" : "2021-02-10T15:59:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-776813912",
      "id" : 776813912,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NjgxMzkxMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-10T15:59:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/776813912",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573861905"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573861905"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ce83d3fb\r\n\r\nI think we should have this discussion about just throwing away transactions under some `SKETCH_MAX_SIZE`. Sort them by feerate, keep the ones above the mark, discard the others.\r\n\r\nWe're already doing the same assumptions if a a transaction is under mempool min fee, we won't relay it further. That can be the same with reconciliation, we don't allocate sketch resources for low-fee transactions. \r\n\r\nThat said, I feel it should be part of a wider conversation about how we price better network resources while still flowing through the network what is \"near confirmation\".",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-02-10T16:10:25Z",
      "diff_hunk" : "@@ -4851,6 +4885,28 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                             pto->m_tx_relay->filterInventoryKnown.insert(txid);\n                         }\n                     }\n+\n+                    // Populating local reconciliation set.\n+                    if (peer->m_recon_state && txs_to_reconcile.size() != 0) {\n+                        assert(peer->m_recon_state->m_requestor || peer->m_recon_state->m_responder);\n+                        int64_t recon_set_overflow = peer->m_recon_state->m_local_set.size() + txs_to_reconcile.size() - MAX_PEER_TX_ANNOUNCEMENTS;\n+                        if (recon_set_overflow > 0) {\n+                            LogPrint(BCLog::NET, \"Reconciliation set for the peer=%d is at capacity, not adding new transactions. \\n\", pto->GetId());\n+                            // Since we reconcile frequently, it either means:\n+                            // (1) a peer for some reason does not request reconciliations from us for a long while, or\n+                            // (2) really a lot of valid fee-paying transactions were dumped on us at once.\n+                            // We don't care about a laggy peer (1) because we probably can't help them even if we flood transactions.\n+                            // However, exploiting (2) should not prevent us from relaying certain transactions.\n+                            // Since computing a sketch over too many elements is too expensive, we will just flood some transactions here.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573861905",
      "id" : 573861905,
      "line" : 5090,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Mzg2MTkwNQ==",
      "original_commit_id" : "ce83d3fbcc0f09808d15a7d2155223430fa45735",
      "original_line" : 5090,
      "original_position" : 163,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 650,
      "pull_request_review_id" : 587627896,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573861905",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> @naumenkogs the new test I think has the wrong permissions:\r\n> -bash: test/functional/p2p_erlay.py: Permission denied\r\n\r\nConfirming @pinheadmz' comment, I needed to run `chmod 755 test/functional/p2p_erlay.py` on the file. The test then fails with `Assertion failed: detected inconsistent lock order for 'cs_main' in net_processing.cpp:2933 (in thread 'msghand')`\r\n\r\n<details><summary>traceback</summary><p>\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"/home/jon/projects/bitcoin/bitcoin/test/functional/p2p_erlay.py\", line 583, in <module>\r\n    ReconciliationTest().main()\r\n  File \"/home/jon/projects/bitcoin/bitcoin/test/functional/test_framework/test_framework.py\", line 149, in main\r\n    exit_code = self.shutdown()\r\n  File \"/home/jon/projects/bitcoin/bitcoin/test/functional/test_framework/test_framework.py\", line 278, in shutdown\r\n    self.stop_nodes()\r\n  File \"/home/jon/projects/bitcoin/bitcoin/test/functional/test_framework/test_framework.py\", line 525, in stop_nodes\r\n    node.stop_node(wait=wait, wait_until_stopped=False)\r\n  File \"/home/jon/projects/bitcoin/bitcoin/test/functional/test_framework/test_node.py\", line 334, in stop_node\r\n    raise AssertionError(\"Unexpected stderr {} != {}\".format(stderr, expected_stderr))\r\nAssertionError: Unexpected stderr Assertion failed: detected inconsistent lock order for 'cs_main' in net_processing.cpp:2933 (in thread 'msghand'), details in debug log. != \r\n[node 0] Cleaning up leftover process\r\n```\r\n</p></details>\r\n",
      "created_at" : "2021-02-11T00:02:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-777122712",
      "id" : 777122712,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NzEyMjcxMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-11T00:02:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/777122712",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r574391119"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574391119"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This particular line is less than 100 chars, so I assume you referred to the other ones which are longer than 100. I see a couple, gonna limit them.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-02-11T10:27:56Z",
      "diff_hunk" : "@@ -0,0 +1,335 @@\n+#include <minisketch/include/minisketch.h>\n+\n+/** Static component of the salt used to compute short txids for transaction reconciliation. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r574391119",
      "id" : 574391119,
      "in_reply_to_id" : 563565058,
      "line" : 14,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDM5MTExOQ==",
      "original_commit_id" : "c452e5dbd6808a76e1f616b1269e5394b8b86cd1",
      "original_line" : 14,
      "original_position" : 3,
      "original_start_line" : null,
      "path" : "src/reconciliation.h",
      "position" : 14,
      "pull_request_review_id" : 588414762,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-13T14:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574391119",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@jonasnick I `chmod a+x` and the test ran and passed.",
      "created_at" : "2021-02-11T14:20:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-777493335",
      "id" : 777493335,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NzQ5MzMzNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-11T14:20:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/777493335",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2084648?v=4",
         "events_url" : "https://api.github.com/users/pinheadmz/events{/privacy}",
         "followers_url" : "https://api.github.com/users/pinheadmz/followers",
         "following_url" : "https://api.github.com/users/pinheadmz/following{/other_user}",
         "gists_url" : "https://api.github.com/users/pinheadmz/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/pinheadmz",
         "id" : 2084648,
         "login" : "pinheadmz",
         "node_id" : "MDQ6VXNlcjIwODQ2NDg=",
         "organizations_url" : "https://api.github.com/users/pinheadmz/orgs",
         "received_events_url" : "https://api.github.com/users/pinheadmz/received_events",
         "repos_url" : "https://api.github.com/users/pinheadmz/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/pinheadmz/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/pinheadmz/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/pinheadmz"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> the test ran and passed.\r\n\r\nBuilding with `--enable-debug`? The lock order errors seem pertinent to these changes. I even rebuilt again a few hours later yesterday after updating my depends; same thing. It's odd if no one else is seeing them.",
      "created_at" : "2021-02-11T14:58:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-777537174",
      "id" : 777537174,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NzUzNzE3NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-11T14:58:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/777537174",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I suppose if no one is seeing the issues, I'll wait until the next push here and look at what the CI says.",
      "created_at" : "2021-02-11T15:00:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-777541288",
      "id" : 777541288,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc3NzU0MTI4OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-02-11T15:00:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/777541288",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r575758305"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575758305"
         }
      },
      "author_association" : "MEMBER",
      "body" : "can you extract this into its own `CNode` function with a name that captures the intent & a case statement for all the connection types? you can see `ExpectServicesFromConn` as an example. ",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-02-14T05:53:27Z",
      "diff_hunk" : "@@ -2546,6 +2555,22 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n \n         if (greatest_common_version >= WTXID_RELAY_VERSION) {\n             m_connman.PushMessage(&pfrom, msg_maker.Make(NetMsgType::WTXIDRELAY));\n+\n+            // Reconciliation is supported only when wtxid relay is supported for only\n+            // those connections which (at least might) support transaction relay.\n+            if (pfrom.IsFullOutboundConn() || pfrom.IsInboundConn() || pfrom.IsManualConn()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r575758305",
      "id" : 575758305,
      "line" : 2688,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTc1ODMwNQ==",
      "original_commit_id" : "01bf7ee3d263be099ba53fb9f6635a9775e45d88",
      "original_line" : 2561,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 275,
      "pull_request_review_id" : 590017307,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-14T06:43:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575758305",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r575761033"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575761033"
         }
      },
      "author_association" : "MEMBER",
      "body" : "this salt calculation (and probably also the flood_to logic) seems like an example of code that can be extracted into the reconciliation module rather than added to `ProcessMessage`.\r\n\r\nit would make sense to me for the flow to be something like: \r\n- `ProcessMessage` does internal state checks (`m_tx_relay` exists, wtxid is enabled)\r\n- extract the message from `vRecv`\r\n- pass it along into the module to handle \r\n- module returns saying \"no-op\" or \"here is a ReconState object\" \r\n- if it exists, `ProcessMessage` stores the object on the peer\r\n\r\nI suspect we could go even further, but this would be a start. Ideally the module would abstract this nuanced erlay specific logic away from net processing, even if its per-peer. The txrequest module is a good example for this, eg. `PeerInfo` struct and how its applied within the module to make choices, and the decisions are surfaced to `net_processing`. ",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-02-14T06:26:25Z",
      "diff_hunk" : "@@ -2806,6 +2820,61 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         return;\n     }\n \n+    // Received from an inbound peer planning to reconcile transactions with us, or\n+    // from an outgoing peer demonstrating readiness to do reconciliations.\n+    // If received from outgoing, adds the peer to the reconciliation queue.\n+    // Feature negotiation of tx reconciliation should happen between VERSION and\n+    // VERACK, to avoid relay problems from switching after a connection is up.\n+    if (msg_type == NetMsgType::SENDRECON) {\n+        if (!pfrom.m_tx_relay) return;\n+        LOCK(peer->m_recon_state_mutex);\n+        if (peer->m_recon_state != nullptr) return; // Do not support reconciliation salt/version updates.\n+        LOCK(cs_main);\n+        if (!State(pfrom.GetId())->m_wtxid_relay) return; // SENDRECON is allowed only after WTXIDRELAY.\n+\n+        bool recon_requestor, recon_responder;\n+        uint64_t remote_salt;\n+        uint32_t recon_version;\n+        vRecv >> recon_requestor >> recon_responder >> recon_version >> remote_salt;\n+        if (recon_version != 1) return;\n+\n+        // Do not flood through inbound connections which support reconciliation to save bandwidth.\n+        bool flood_to = false;\n+        if (pfrom.IsInboundConn()) {\n+            // We currently don't support reconciliations with inbound peers which\n+            // don't want to be reconciliation senders (request our sketches),\n+            // or want to be reconciliation responders (send us their sketches).\n+            // Just ignore SENDRECON and use normal flooding for transaction relay with them.\n+            if (!recon_requestor) return;\n+            if (recon_responder) return;\n+        } else {\n+            // We currently don't support reconciliations with outbound peers which\n+            // don't want to be reconciliation responders (send us their sketches),\n+            // or want to be reconciliation senders (request our sketches).\n+            // Just ignore SENDRECON and use normal flooding for transaction relay with them.\n+            if (recon_requestor) return;\n+            if (!recon_responder) return;\n+            // TODO: Flood only through a limited number of outbound connections.\n+            flood_to = true;\n+        }\n+\n+        uint64_t local_salt = peer->m_local_recon_salt;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r575761033",
      "id" : 575761033,
      "line" : 2978,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTc2MTAzMw==",
      "original_commit_id" : "fb0d2575bfb577e6c66ca90a32344f6f74ff640a",
      "original_line" : 2861,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 337,
      "pull_request_review_id" : 590017307,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-14T06:43:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575761033",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r575761493"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575761493"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I find (!A && !B) to be very confusing. Again, would be good to extract into its own function with switch statement. ",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-02-14T06:31:09Z",
      "diff_hunk" : "@@ -914,6 +929,28 @@ void PeerManagerImpl::PushNodeVersion(CNode& pnode, int64_t nTime)\n     }\n }\n \n+size_t PeerManagerImpl::GetFloodingOutboundsCount(const CNode& skip_node) const\n+{\n+    size_t result = 0;\n+    m_connman.ForEachNode([this, &result, &skip_node](const CNode* pnode) {\n+        if (!pnode->m_tx_relay) return;\n+        if (pnode->GetId() == skip_node.GetId()) return;\n+        if (!pnode->IsFullOutboundConn() && !pnode->IsManualConn()) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r575761493",
      "id" : 575761493,
      "line" : 962,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTc2MTQ5Mw==",
      "original_commit_id" : "86ee3c6235842efb23dd52ef59d3efbf491be6b2",
      "original_line" : 938,
      "original_position" : 39,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 136,
      "pull_request_review_id" : 590017307,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-14T06:43:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575761493",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r575762526"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575762526"
         }
      },
      "author_association" : "MEMBER",
      "body" : "instead of recalculating whenever we get a `SENDRECON` message, could this logic be significantly simplified by just storing a count that gets updated when nodes do something to change their state? the characteristics being checked are all established early in the connection (connection type, m_tx_relay struct, flood_to being set) \r\n\r\nI think this should remove the need for the \"skip node\" logic in this function, but if not, the node being processed can be checked and then subtract one if needed. ",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-02-14T06:42:59Z",
      "diff_hunk" : "@@ -914,6 +929,28 @@ void PeerManagerImpl::PushNodeVersion(CNode& pnode, int64_t nTime)\n     }\n }\n \n+size_t PeerManagerImpl::GetFloodingOutboundsCount(const CNode& skip_node) const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r575762526",
      "id" : 575762526,
      "line" : 956,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTc2MjUyNg==",
      "original_commit_id" : "86ee3c6235842efb23dd52ef59d3efbf491be6b2",
      "original_line" : 932,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 130,
      "pull_request_review_id" : 590017307,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-14T06:43:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575762526",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r575781038"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575781038"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah, I'm planning to do something similar in the next couple days. That's why I marked the PR draft for now :)\r\n\r\nThank you for the design suggestion!",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-02-14T09:33:33Z",
      "diff_hunk" : "@@ -2806,6 +2820,61 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         return;\n     }\n \n+    // Received from an inbound peer planning to reconcile transactions with us, or\n+    // from an outgoing peer demonstrating readiness to do reconciliations.\n+    // If received from outgoing, adds the peer to the reconciliation queue.\n+    // Feature negotiation of tx reconciliation should happen between VERSION and\n+    // VERACK, to avoid relay problems from switching after a connection is up.\n+    if (msg_type == NetMsgType::SENDRECON) {\n+        if (!pfrom.m_tx_relay) return;\n+        LOCK(peer->m_recon_state_mutex);\n+        if (peer->m_recon_state != nullptr) return; // Do not support reconciliation salt/version updates.\n+        LOCK(cs_main);\n+        if (!State(pfrom.GetId())->m_wtxid_relay) return; // SENDRECON is allowed only after WTXIDRELAY.\n+\n+        bool recon_requestor, recon_responder;\n+        uint64_t remote_salt;\n+        uint32_t recon_version;\n+        vRecv >> recon_requestor >> recon_responder >> recon_version >> remote_salt;\n+        if (recon_version != 1) return;\n+\n+        // Do not flood through inbound connections which support reconciliation to save bandwidth.\n+        bool flood_to = false;\n+        if (pfrom.IsInboundConn()) {\n+            // We currently don't support reconciliations with inbound peers which\n+            // don't want to be reconciliation senders (request our sketches),\n+            // or want to be reconciliation responders (send us their sketches).\n+            // Just ignore SENDRECON and use normal flooding for transaction relay with them.\n+            if (!recon_requestor) return;\n+            if (recon_responder) return;\n+        } else {\n+            // We currently don't support reconciliations with outbound peers which\n+            // don't want to be reconciliation responders (send us their sketches),\n+            // or want to be reconciliation senders (request our sketches).\n+            // Just ignore SENDRECON and use normal flooding for transaction relay with them.\n+            if (recon_requestor) return;\n+            if (!recon_responder) return;\n+            // TODO: Flood only through a limited number of outbound connections.\n+            flood_to = true;\n+        }\n+\n+        uint64_t local_salt = peer->m_local_recon_salt;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r575781038",
      "id" : 575781038,
      "in_reply_to_id" : 575761033,
      "line" : 2978,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTc4MTAzOA==",
      "original_commit_id" : "fb0d2575bfb577e6c66ca90a32344f6f74ff640a",
      "original_line" : 2861,
      "original_position" : 77,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 337,
      "pull_request_review_id" : 590029949,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-14T09:33:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575781038",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r580595369"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/580595369"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "But the legacy behavior also affects Erlay peers (because if a non-reachable node received transactions from legacy  peers, it would act as if it was a reachable hub and forward them via flooding to other outbound peers, including Erlay ones).\r\n\r\nApart from this specific spot that could easily be adjusted if needed, I think that when there are two relay mechanisms with different time scales existing in parallel, this could lead to some non-intuitive consequences - such as legacy relay being dominant and cannibalizing Erlay relay way into the regime when the majority of nodes already support Erlay.\r\n \r\nWould it maybe be worth doing a mixed-network simulation run and measuring the respective contributions at different ratios of Erlay to legacy nodes, if this is possible within the existing simulation framework?",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-02-22T21:14:25Z",
      "diff_hunk" : "@@ -3358,7 +3375,13 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             // requests for it.\n             m_txrequest.ForgetTxHash(tx.GetHash());\n             m_txrequest.ForgetTxHash(tx.GetWitnessHash());\n-            RelayTransaction(tx.GetHash(), tx.GetWitnessHash(), m_connman);\n+\n+            // Flood those transactions which were received either via flooding, or inbound reconciliation,\n+            // but NOT via outbound reconciliation. Flooding then is mainly used for initial propagation\n+            // of new transactions across a network of reachable nodes quickly.\n+            LOCK(peer->m_recon_state_mutex);\n+            bool flood = !(peer->m_recon_state && peer->m_recon_state->m_responder);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r580595369",
      "id" : 580595369,
      "in_reply_to_id" : 571236196,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MDU5NTM2OQ==",
      "original_commit_id" : "ce83d3fbcc0f09808d15a7d2155223430fa45735",
      "original_line" : 3383,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 595788347,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-02-22T21:14:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/580595369",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "An update here.\r\nBased on some suggestions, I moved reconciliation to a separate module.\r\nI suggest doing some initial review of that in [the PR in my repo](https://github.com/naumenkogs/bitcoin/pull/2). Could you folks help to evaluate my new approach? @jnewbery @amitiuttarwar @sipa @jonatack (everyone else is welcome too)\r\n\r\nThis way we could save the review efforts of those contributors who are less concerned about the modularity? First do that, then proceed to other questions.\r\n\r\nOnce that is done, I'll get back here and welcome full review again.",
      "created_at" : "2021-03-02T13:24:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-788906220",
      "id" : 788906220,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc4ODkwNjIyMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-02T13:24:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/788906220",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@naumenkogs I took a first look and I see that most of the comments I've left here are still applicable. I'm happy to do a deeper dive on the branch one you've addressed the outstanding comments.",
      "created_at" : "2021-03-08T19:42:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-793022594",
      "id" : 793022594,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc5MzAyMjU5NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-08T19:42:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/793022594",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r592830262"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592830262"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Please [use `std::make_unique` in new code](https://github.com/bitcoin/bitcoin/blob/master/src/util/memory.h#L13).",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-03-12T00:39:58Z",
      "diff_hunk" : "@@ -2781,6 +2933,65 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         return;\n     }\n \n+    // Received from an inbound peer planning to reconcile transactions with us, or\n+    // from an outgoing peer demonstrating readiness to do reconciliations.\n+    // If received from outgoing, adds the peer to the reconciliation queue.\n+    // Feature negotiation of tx reconciliation should happen between VERSION and\n+    // VERACK, to avoid relay problems from switching after a connection is up.\n+    if (msg_type == NetMsgType::SENDRECON) {\n+        if (!pfrom.m_tx_relay) return;\n+        LOCK(peer->m_recon_state_mutex);\n+        if (peer->m_recon_state != nullptr) return; // Do not support reconciliation salt/version updates.\n+        LOCK(cs_main);\n+        if (!State(pfrom.GetId())->m_wtxid_relay) return; // SENDRECON is allowed only after WTXIDRELAY.\n+\n+        bool recon_requestor, recon_responder;\n+        uint64_t remote_salt;\n+        uint32_t recon_version;\n+        vRecv >> recon_requestor >> recon_responder >> recon_version >> remote_salt;\n+        if (recon_version != 1) return;\n+\n+        // Do not flood through inbound connections which support reconciliation to save bandwidth.\n+        // Flood only through a limited number of outbound connections.\n+        bool flood_to = false;\n+        if (pfrom.IsInboundConn()) {\n+            // We currently don't support reconciliations with inbound peers which\n+            // don't want to be reconciliation senders (request our sketches),\n+            // or want to be reconciliation responders (send us their sketches).\n+            // Just ignore SENDRECON and use normal flooding for transaction relay with them.\n+            if (!recon_requestor) return;\n+            if (recon_responder) return;\n+        } else {\n+            // We currently don't support reconciliations with outbound peers which\n+            // don't want to be reconciliation responders (send us their sketches),\n+            // or want to be reconciliation senders (request our sketches).\n+            // Just ignore SENDRECON and use normal flooding for transaction relay with them.\n+            if (recon_requestor) return;\n+            if (!recon_responder) return;\n+\n+            uint64_t outbound_flooding_peers = GetFloodingOutboundsCount(pfrom);\n+            if (outbound_flooding_peers < MAX_OUTBOUND_FLOOD_TO) {\n+                flood_to = true;\n+            }\n+        }\n+\n+        uint64_t local_salt = peer->m_local_recon_salt;\n+        uint64_t salt1 = local_salt, salt2 = remote_salt;\n+        if (salt1 > salt2) std::swap(salt1, salt2);\n+        static const auto RECON_SALT_HASHER = TaggedHash(RECON_STATIC_SALT);\n+        uint256 full_salt = (CHashWriter(RECON_SALT_HASHER) << salt1 << salt2).GetSHA256();\n+\n+        peer->m_recon_state = MakeUnique<ReconState>(recon_requestor, recon_responder, flood_to, full_salt.GetUint64(0), full_salt.GetUint64(1));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r592830262",
      "id" : 592830262,
      "line" : 2984,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MjgzMDI2Mg==",
      "original_commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "original_line" : 2984,
      "original_position" : 343,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 343,
      "pull_request_review_id" : 610360092,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-12T00:39:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592830262",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r594350238"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594350238"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I know it's more complicated logic, but think it's necessary.\r\nm_flood inside peer's ReconState is one factor, but it's not sufficient, because we can't flood *all* transactions to them.\r\n\r\nIf we did so, there will be too much flooding. A non-reachable node always sets m_flood for its 8 outbound peers to true. In that case, it will flood all transactions it gets for them, too much bandwidth.\r\n\r\nI suggest flooding only transactions received via inbound flooding, so this is never the case for non-reachable nodes.\r\n\r\nI'm open to suggestions on other ways how to limit flooding, but I think this one makes the most sense.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-03-15T13:49:08Z",
      "diff_hunk" : "@@ -1665,17 +1680,19 @@ bool static AlreadyHaveBlock(const uint256& block_hash) EXCLUSIVE_LOCKS_REQUIRED\n     return LookupBlockIndex(block_hash) != nullptr;\n }\n \n-void RelayTransaction(const uint256& txid, const uint256& wtxid, const CConnman& connman)\n+void RelayTransaction(const uint256& txid, const uint256& wtxid, const CConnman& connman, bool flood)\n {\n-    connman.ForEachNode([&txid, &wtxid](CNode* pnode) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n+    connman.ForEachNode([&txid, &wtxid, flood](CNode* pnode) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n         AssertLockHeld(::cs_main);\n \n         CNodeState* state = State(pnode->GetId());\n         if (state == nullptr) return;\n         if (state->m_wtxid_relay) {\n-            pnode->PushTxInventory(wtxid);\n+            pnode->PushTxInventory(wtxid, flood);\n         } else {\n-            pnode->PushTxInventory(txid);\n+            // Reconciliations are not supported for non-wtxid peers,\n+            // so we always use flooding.\n+            pnode->PushTxInventory(txid, true);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r594350238",
      "id" : 594350238,
      "in_reply_to_id" : 573107239,
      "line" : 1724,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDM1MDIzOA==",
      "original_commit_id" : "ce83d3fbcc0f09808d15a7d2155223430fa45735",
      "original_line" : 1724,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 224,
      "pull_request_review_id" : 612210832,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-15T13:49:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594350238",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r594369245"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594369245"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\"strategic\" is not a bidirectional link property, it's decided on every peer locally.\r\nWe might flood stuff to them, but they won't flood to us (because they only flood outbound). \r\n\r\nIn that case, we will never get their transactions, if we don't reconcile.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-03-15T14:11:41Z",
      "diff_hunk" : "@@ -2795,6 +2808,61 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         return;\n     }\n \n+    // Received from an inbound peer planning to reconcile transactions with us, or\n+    // from an outgoing peer demonstrating readiness to do reconciliations.\n+    // If received from outgoing, adds the peer to the reconciliation queue.\n+    // Feature negotiation of tx reconciliation should happen between VERSION and\n+    // VERACK, to avoid relay problems from switching after a connection is up.\n+    if (msg_type == NetMsgType::SENDRECON) {\n+        if (!pfrom.m_tx_relay) return;\n+        LOCK(peer->m_recon_state_mutex);\n+        if (peer->m_recon_state != nullptr) return; // Do not support reconciliation salt/version updates.\n+        LOCK(cs_main);\n+        if (!State(pfrom.GetId())->m_wtxid_relay) return; // SENDRECON is allowed only after WTXIDRELAY.\n+\n+        bool recon_requestor, recon_responder;\n+        uint64_t remote_salt;\n+        uint32_t recon_version;\n+        vRecv >> recon_requestor >> recon_responder >> recon_version >> remote_salt;\n+        if (recon_version != 1) return;\n+\n+        // Do not flood through inbound connections which support reconciliation to save bandwidth.\n+        bool flood_to = false;\n+        if (pfrom.IsInboundConn()) {\n+            // We currently don't support reconciliations with inbound peers which\n+            // don't want to be reconciliation senders (request our sketches),\n+            // or want to be reconciliation responders (send us their sketches).\n+            // Just ignore SENDRECON and use normal flooding for transaction relay with them.\n+            if (!recon_requestor) return;\n+            if (recon_responder) return;\n+        } else {\n+            // We currently don't support reconciliations with outbound peers which\n+            // don't want to be reconciliation responders (send us their sketches),\n+            // or want to be reconciliation senders (request our sketches).\n+            // Just ignore SENDRECON and use normal flooding for transaction relay with them.\n+            if (recon_requestor) return;\n+            if (!recon_responder) return;\n+            // TODO: Flood only through a limited number of outbound connections.\n+            flood_to = true;\n+        }\n+\n+        uint64_t local_salt = peer->m_local_recon_salt;\n+        uint64_t salt1 = local_salt, salt2 = remote_salt;\n+        if (salt1 > salt2) std::swap(salt1, salt2);\n+        static const auto RECON_SALT_HASHER = TaggedHash(RECON_STATIC_SALT);\n+        uint256 full_salt = (CHashWriter(RECON_SALT_HASHER) << salt1 << salt2).GetSHA256();\n+\n+        peer->m_recon_state = MakeUnique<ReconState>(recon_requestor, recon_responder, flood_to, full_salt.GetUint64(0), full_salt.GetUint64(1));\n+\n+        // Reconcile with all outbound peers supporting reconciliation (even if we flood to them),\n+        // to not miss transactions they have for us but won't flood.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r594369245",
      "id" : 594369245,
      "in_reply_to_id" : 573794642,
      "line" : 2987,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDM2OTI0NQ==",
      "original_commit_id" : "34a485e0f1c9511fbd18cc6c0d60b6ca8929ccd9",
      "original_line" : 2987,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 346,
      "pull_request_review_id" : 612236207,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-15T14:11:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594369245",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r594371856"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594371856"
         }
      },
      "author_association" : "MEMBER",
      "body" : ">Non-reachable nodes may open connections to outbound not supporting reconciliations, thus relying on flooding for transaction announcements, at least until Erlay is well-deployed.\r\n\r\nSure. But for reconciliation conns, the current policy is to flood only what was received via inbound. So if we rebroadcast to a reconciling peer via flooding, they will know it's rebroadcast, because non-reachable never receive any stuff via inbound (by definition)\r\n\r\nContinue [here](https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573107239)",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-03-15T14:14:51Z",
      "diff_hunk" : "@@ -1017,7 +1024,15 @@ void PeerManagerImpl::ReattemptInitialBroadcast(CScheduler& scheduler) const\n \n         if (tx != nullptr) {\n             LOCK(cs_main);\n-            RelayTransaction(txid, tx->GetWitnessHash(), m_connman);\n+            // We re-relay these transactions via reconciliation (same as for initial broadcast),\n+            // instead of flooding, to hide the origin of transactions.\n+            // Since in Erlay transactions are flooded only inbound->outbound,\n+            // non-reachable nodes never flood transactions from other nodes (they have no inbounds).\n+            // Thus, making them flood these would tell a receiver that these indeed belong to the\n+            // flooding non-reachable nodes. Instead, we relay them via reconciliation,\n+            // in which case a receiver can't distinguish them from transactions we reconciled\n+            // with some other peer.\n+            RelayTransaction(txid, tx->GetWitnessHash(), m_connman, false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r594371856",
      "id" : 594371856,
      "in_reply_to_id" : 573094798,
      "line" : 1064,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDM3MTg1Ng==",
      "original_commit_id" : "ce83d3fbcc0f09808d15a7d2155223430fa45735",
      "original_line" : 1064,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 188,
      "pull_request_review_id" : 612239819,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-15T14:55:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594371856",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r594380974"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594380974"
         }
      },
      "author_association" : "MEMBER",
      "body" : ">It seems like an inbound peer that constantly tries to reconcile with us could be a more effective spy than before this change, but maybe I'm missing something.\r\n\r\nWe don't respond to reconciliations right away, there is a shared timer for those responses. That's why I thought it's fine to reduce the delay here.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-03-15T14:25:12Z",
      "diff_hunk" : "@@ -4504,11 +4528,11 @@ bool PeerManager::SendMessages(CNode* pto)\n                 bool fSendTrickle = pto->HasPermission(PF_NOBAN);\n                 if (pto->m_tx_relay->nNextInvSend < current_time) {\n                     fSendTrickle = true;\n-                    if (pto->IsInboundConn()) {\n-                        pto->m_tx_relay->nNextInvSend = std::chrono::microseconds{m_connman.PoissonNextSendInbound(count_microseconds(current_time), INVENTORY_BROADCAST_INTERVAL)};\n-                    } else {\n-                        // Use half the delay for outbound peers, as there is less privacy concern for them.\n+                    if (peer->m_recon_state || !pto->IsInboundConn()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r594380974",
      "id" : 594380974,
      "in_reply_to_id" : 541017754,
      "line" : 4948,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDM4MDk3NA==",
      "original_commit_id" : "e8fd1cb590161e88b64b2e20d3113310390e68a5",
      "original_line" : 4948,
      "original_position" : 125,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 560,
      "pull_request_review_id" : 612252887,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-15T14:25:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594380974",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r594402754"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594402754"
         }
      },
      "author_association" : "MEMBER",
      "body" : ">IIUC, this comment correctly, you mean that a transaction discovered through an accepted-reconciliation will be marked for reconciliation for its future announcements, no matter the peer type (strategic outbound/non-strategic outbound/inbound).\r\n\r\nCorrect if you mean accepted=outbound (see confusion below)\r\n\r\n> I don't get the rational of such approach, propagation of such transactions could be accelerated if we were flooding them for our outbound peers.\r\n\r\nDiscuss [here](https://github.com/bitcoin/bitcoin/pull/18261#discussion_r573107239)\r\n\r\n>Also you may consider \"inbound reconciliation\" -> \"initiated reconciliation\", \"outbound reconciliation\" -> \"accepted reconciliation\". Even if reconciliation roles are decided in function of our peer selection, they should be clearly dissociated as orthogonal.\r\n\r\nACK, although I think \"inbound\" is not initiated, but it's accepted.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-03-15T14:49:13Z",
      "diff_hunk" : "@@ -3358,7 +3375,13 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             // requests for it.\n             m_txrequest.ForgetTxHash(tx.GetHash());\n             m_txrequest.ForgetTxHash(tx.GetWitnessHash());\n-            RelayTransaction(tx.GetHash(), tx.GetWitnessHash(), m_connman);\n+\n+            // Flood those transactions which were received either via flooding, or inbound reconciliation,\n+            // but NOT via outbound reconciliation. Flooding then is mainly used for initial propagation\n+            // of new transactions across a network of reachable nodes quickly.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r594402754",
      "id" : 594402754,
      "in_reply_to_id" : 573824646,
      "line" : 3423,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDQwMjc1NA==",
      "original_commit_id" : "ce83d3fbcc0f09808d15a7d2155223430fa45735",
      "original_line" : 3423,
      "original_position" : 83,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 374,
      "pull_request_review_id" : 612282162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-15T14:55:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594402754",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r594407099"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594407099"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@mzumsande sorry I just saw this question. Yeah, that might be useful, once I'm done with big refactor for this...\r\nIntuitively, I think this shouldn't be the case legacy peers cannibalize efficiency I think.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-03-15T14:54:04Z",
      "diff_hunk" : "@@ -3358,7 +3375,13 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             // requests for it.\n             m_txrequest.ForgetTxHash(tx.GetHash());\n             m_txrequest.ForgetTxHash(tx.GetWitnessHash());\n-            RelayTransaction(tx.GetHash(), tx.GetWitnessHash(), m_connman);\n+\n+            // Flood those transactions which were received either via flooding, or inbound reconciliation,\n+            // but NOT via outbound reconciliation. Flooding then is mainly used for initial propagation\n+            // of new transactions across a network of reachable nodes quickly.\n+            LOCK(peer->m_recon_state_mutex);\n+            bool flood = !(peer->m_recon_state && peer->m_recon_state->m_responder);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r594407099",
      "id" : 594407099,
      "in_reply_to_id" : 571236196,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDQwNzA5OQ==",
      "original_commit_id" : "ce83d3fbcc0f09808d15a7d2155223430fa45735",
      "original_line" : 3383,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 612288034,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-15T14:54:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594407099",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r595075917"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595075917"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@sipa good idea, ack.",
      "commit_id" : "c5389c20b8f4278351c42ff9b6cd7f723c906603",
      "created_at" : "2021-03-16T11:19:24Z",
      "diff_hunk" : "@@ -2562,6 +2620,74 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    // Received from an inbound peer planning to reconcile transactions with us, or\n+    // from an outgoing peer demonstrating readiness to do reconciliations.\n+    // If received from outgoing, adds the peer to the reconciliation queue.\n+    // Feature negotiation of tx reconciliation should happen between VERSION and\n+    // VERACK, to avoid relay problems from switching after a connection is up.\n+    if (msg_type == NetMsgType::SENDRECON) {\n+        if (!pfrom.m_tx_relay) return;\n+        if (peer->m_recon_state != nullptr) return; // Do not support reconciliation salt/version updates.\n+        LOCK(cs_main);\n+        if (!State(pfrom.GetId())->m_wtxid_relay) return; // SENDRECON is allowed only after WTXIDRELAY.\n+\n+        bool recon_sender, recon_responder;\n+        uint64_t remote_salt;\n+        uint32_t recon_version;\n+        vRecv >> recon_sender >> recon_responder >> recon_version >> remote_salt;\n+        if (recon_version != 1) return;\n+\n+        // Do not flood through inbound connections which support reconciliation to save bandwidth.\n+        bool flood_to = false;\n+        if (pfrom.IsInboundConn()) {\n+            // We currently don't support reconciliations with inbound peers which\n+            // don't want to be reconciliation senders (request our sketches),\n+            // or want to be reconciliation responders (send us their sketches).\n+            // Just ignore SENDRECON and use normal flooding for transaction relay with them.\n+            if (!recon_sender) return;\n+            if (recon_responder) return;\n+        } else {\n+            // We currently don't support reconciliations with outbound peers which\n+            // don't want to be reconciliation responders (send us their sketches),\n+            // or want to be reconciliation senders (request our sketches).\n+            // Just ignore SENDRECON and use normal flooding for transaction relay with them.\n+            if (recon_sender) return;\n+            if (!recon_responder) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#discussion_r595075917",
      "id" : 595075917,
      "in_reply_to_id" : 541120337,
      "line" : 2970,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTA3NTkxNw==",
      "original_commit_id" : "60a723ee676ce4259e0b3177d2fd1b5013dca649",
      "original_line" : 2970,
      "original_position" : 108,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 329,
      "pull_request_review_id" : 613122802,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18261",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-16T11:19:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/595075917",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Closing in favor of #21515. I believe I addressed most of the comments from here.",
      "created_at" : "2021-03-23T21:00:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-805256489",
      "id" : 805256489,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwNTI1NjQ4OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-23T21:00:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/805256489",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "#21515 is ready for review now",
      "created_at" : "2021-03-28T08:08:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18261#issuecomment-808863278",
      "id" : 808863278,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18261",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwODg2MzI3OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-28T08:08:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/808863278",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   }
]
