[
   {
      "author_association" : "MEMBER",
      "body" : "Could you please add a benchmark to `./src/bench/checkblock.cpp`, so it is easier to see how much this improves?",
      "created_at" : "2018-05-02T12:34:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-385962450",
      "id" : 385962450,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13151",
      "updated_at" : "2018-05-02T12:34:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/385962450",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "Sure, though I'm not sure how to do that; none of the benches actually uses `ReadBlockFromDisk`, I would have to set up a fake block index or such.\r\n\r\n(I also don't think it will work on `block413567` as-is because it has no magic/size header, and is not a file on disk, though it's easy enough to write a temporary file of course). [When doing this from memory there's effectively nothing to benchmark, too.]",
      "created_at" : "2018-05-02T12:38:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-385963284",
      "id" : 385963284,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13151",
      "updated_at" : "2018-05-02T12:53:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/385963284",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185505648"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185505648"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Just to throw out the idea, `mmap` wouldn't pay off right?",
      "commit_id" : "9893e712e9e04e8b9478e36e0b5d843899540bd2",
      "created_at" : "2018-05-02T14:00:40Z",
      "diff_hunk" : "@@ -1125,6 +1125,47 @@ bool ReadBlockFromDisk(CBlock& block, const CBlockIndex* pindex, const Consensus\n     return true;\n }\n \n+bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const CDiskBlockPos& pos, const CMessageHeader::MessageStartChars& messageStart)\n+{\n+    // Open history file to read\n+    CDiskBlockPos hpos = pos;\n+    hpos.nPos -= 8; // Seek back 8 bytes to validate header\n+    CAutoFile filein(OpenBlockFile(hpos, true), SER_DISK, CLIENT_VERSION);\n+    if (filein.IsNull()) {\n+        return error(\"%s: OpenBlockFile failed for %s\", __func__, pos.ToString());\n+    }\n+\n+    CMessageHeader::MessageStartChars msg_start_in;\n+    unsigned int nSize;\n+    filein >> msg_start_in >> nSize;\n+\n+    if (memcmp(msg_start_in, messageStart, CMessageHeader::MESSAGE_START_SIZE)) {\n+        return error(\"%s: Block magic mismatch for %s: %s versus expected %s\", __func__, pos.ToString(),\n+                HexStr(msg_start_in, msg_start_in + CMessageHeader::MESSAGE_START_SIZE),\n+                HexStr(messageStart, messageStart + CMessageHeader::MESSAGE_START_SIZE));\n+    }\n+\n+    try {\n+        block.resize(nSize);\n+        filein.read((char*)block.data(), nSize);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185505648",
      "id" : 185505648,
      "original_commit_id" : "4c790dff7481d1464a906ad6b17a3179a7da3431",
      "original_position" : 26,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 116907566,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151",
      "updated_at" : "2018-05-07T12:28:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185505648",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185507798"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185507798"
         }
      },
      "author_association" : "OWNER",
      "body" : "I don't think that's a win here, as the entire block is read consecutively - could even be slower as it'd have to create and destroy the mapping. Also it's not portable.",
      "commit_id" : "9893e712e9e04e8b9478e36e0b5d843899540bd2",
      "created_at" : "2018-05-02T14:07:09Z",
      "diff_hunk" : "@@ -1125,6 +1125,47 @@ bool ReadBlockFromDisk(CBlock& block, const CBlockIndex* pindex, const Consensus\n     return true;\n }\n \n+bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const CDiskBlockPos& pos, const CMessageHeader::MessageStartChars& messageStart)\n+{\n+    // Open history file to read\n+    CDiskBlockPos hpos = pos;\n+    hpos.nPos -= 8; // Seek back 8 bytes to validate header\n+    CAutoFile filein(OpenBlockFile(hpos, true), SER_DISK, CLIENT_VERSION);\n+    if (filein.IsNull()) {\n+        return error(\"%s: OpenBlockFile failed for %s\", __func__, pos.ToString());\n+    }\n+\n+    CMessageHeader::MessageStartChars msg_start_in;\n+    unsigned int nSize;\n+    filein >> msg_start_in >> nSize;\n+\n+    if (memcmp(msg_start_in, messageStart, CMessageHeader::MESSAGE_START_SIZE)) {\n+        return error(\"%s: Block magic mismatch for %s: %s versus expected %s\", __func__, pos.ToString(),\n+                HexStr(msg_start_in, msg_start_in + CMessageHeader::MESSAGE_START_SIZE),\n+                HexStr(messageStart, messageStart + CMessageHeader::MESSAGE_START_SIZE));\n+    }\n+\n+    try {\n+        block.resize(nSize);\n+        filein.read((char*)block.data(), nSize);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185507798",
      "id" : 185507798,
      "in_reply_to_id" : 185505648,
      "original_commit_id" : "4c790dff7481d1464a906ad6b17a3179a7da3431",
      "original_position" : 26,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 116910324,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151",
      "updated_at" : "2018-05-07T12:28:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185507798",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185513478"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185513478"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Shouldn't this compare against the serialization flags of the block on disk? Currently you are assuming that all blocks are serialized as witness blocks on disk, but this is not true for all \"early\" blocks. ",
      "commit_id" : "9893e712e9e04e8b9478e36e0b5d843899540bd2",
      "created_at" : "2018-05-02T14:23:43Z",
      "diff_hunk" : "@@ -1142,60 +1143,71 @@ void static ProcessGetBlockData(CNode* pfrom, const Consensus::Params& consensus\n         std::shared_ptr<const CBlock> pblock;\n         if (a_recent_block && a_recent_block->GetHash() == pindex->GetBlockHash()) {\n             pblock = a_recent_block;\n+        } else if (inv.type == MSG_WITNESS_BLOCK) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185513478",
      "id" : 185513478,
      "original_commit_id" : "4c790dff7481d1464a906ad6b17a3179a7da3431",
      "original_position" : 19,
      "path" : "src/net_processing.cpp",
      "position" : 19,
      "pull_request_review_id" : 116917399,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151",
      "updated_at" : "2018-05-07T12:28:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185513478",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. Would be nice to see how much the additional savings are on top of #13098.",
      "created_at" : "2018-05-02T14:24:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-385995721",
      "id" : 385995721,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13151",
      "updated_at" : "2018-05-02T14:24:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/385995721",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "> Concept ACK. Would be nice to see how much the additional savings are on top of #13098.\r\n\r\nAt least it's a lot simpler.",
      "created_at" : "2018-05-02T14:28:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-385997120",
      "id" : 385997120,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13151",
      "updated_at" : "2018-05-02T14:28:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/385997120",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185516723"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185516723"
         }
      },
      "author_association" : "OWNER",
      "body" : "Yes I'm not convinced this logic is correct. It seems to work, though, even for the initial blocks.\r\n\r\nEdit: What is the operation to convert from a non-witness block to witness block with no witnesses? I suppose this could still be done without a full round-trip?",
      "commit_id" : "9893e712e9e04e8b9478e36e0b5d843899540bd2",
      "created_at" : "2018-05-02T14:32:02Z",
      "diff_hunk" : "@@ -1142,60 +1143,71 @@ void static ProcessGetBlockData(CNode* pfrom, const Consensus::Params& consensus\n         std::shared_ptr<const CBlock> pblock;\n         if (a_recent_block && a_recent_block->GetHash() == pindex->GetBlockHash()) {\n             pblock = a_recent_block;\n+        } else if (inv.type == MSG_WITNESS_BLOCK) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185516723",
      "id" : 185516723,
      "in_reply_to_id" : 185513478,
      "original_commit_id" : "4c790dff7481d1464a906ad6b17a3179a7da3431",
      "original_position" : 19,
      "path" : "src/net_processing.cpp",
      "position" : 19,
      "pull_request_review_id" : 116921330,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151",
      "updated_at" : "2018-05-07T12:28:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185516723",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185531193"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185531193"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I guess the only thing required would be to squeeze in the 0x0001 (\"marker\"+\"flag\"). This is identical to the serialization when calculating the hash (see https://github.com/bitcoin/bips/blob/master/bip-0141.mediawiki#transaction-id)",
      "commit_id" : "e0223ebf0c58f7beedea91df48e9586154cd4436",
      "created_at" : "2018-05-02T15:08:50Z",
      "diff_hunk" : "@@ -1142,60 +1143,71 @@ void static ProcessGetBlockData(CNode* pfrom, const Consensus::Params& consensus\n         std::shared_ptr<const CBlock> pblock;\n         if (a_recent_block && a_recent_block->GetHash() == pindex->GetBlockHash()) {\n             pblock = a_recent_block;\n+        } else if (inv.type == MSG_WITNESS_BLOCK) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185531193",
      "id" : 185531193,
      "in_reply_to_id" : 185513478,
      "original_commit_id" : "4c790dff7481d1464a906ad6b17a3179a7da3431",
      "original_position" : 19,
      "path" : "src/net_processing.cpp",
      "position" : 19,
      "pull_request_review_id" : 116938686,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151",
      "updated_at" : "2018-05-03T08:55:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185531193",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185553215"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185553215"
         }
      },
      "author_association" : "OWNER",
      "body" : "@laanwj It's always correct to give the raw blocks we store to peers that ask for witnesses (even if the block does not have a witness).\n\nConverting extended format to basic format is a lot more complicated. You could have a special CTransaction which skips the witness fields instead of reading/deserializing them, but I don't see how to do it without going through some form of serialization code. ",
      "commit_id" : "9893e712e9e04e8b9478e36e0b5d843899540bd2",
      "created_at" : "2018-05-02T16:12:15Z",
      "diff_hunk" : "@@ -1142,60 +1143,71 @@ void static ProcessGetBlockData(CNode* pfrom, const Consensus::Params& consensus\n         std::shared_ptr<const CBlock> pblock;\n         if (a_recent_block && a_recent_block->GetHash() == pindex->GetBlockHash()) {\n             pblock = a_recent_block;\n+        } else if (inv.type == MSG_WITNESS_BLOCK) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185553215",
      "id" : 185553215,
      "in_reply_to_id" : 185513478,
      "original_commit_id" : "4c790dff7481d1464a906ad6b17a3179a7da3431",
      "original_position" : 19,
      "path" : "src/net_processing.cpp",
      "position" : 19,
      "pull_request_review_id" : 116965809,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151",
      "updated_at" : "2018-05-07T12:28:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185553215",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185556438"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185556438"
         }
      },
      "author_association" : "OWNER",
      "body" : "@sipa Thanks.\r\n\r\n> Converting extended format to basic format is a lot more complicated. You could have a special CTransaction which skips the witness fields instead of reading/deserializing them, but I don't see how to do it without going through some form of serialization code.\r\n\r\nRight, that case should fall back to deserialization->serialization right now. I don't think we can do much better there. Not sure it's even worth optimizing, there won't be many new clients being synced with pre-segwit versions.",
      "commit_id" : "9893e712e9e04e8b9478e36e0b5d843899540bd2",
      "created_at" : "2018-05-02T16:22:47Z",
      "diff_hunk" : "@@ -1142,60 +1143,71 @@ void static ProcessGetBlockData(CNode* pfrom, const Consensus::Params& consensus\n         std::shared_ptr<const CBlock> pblock;\n         if (a_recent_block && a_recent_block->GetHash() == pindex->GetBlockHash()) {\n             pblock = a_recent_block;\n+        } else if (inv.type == MSG_WITNESS_BLOCK) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185556438",
      "id" : 185556438,
      "in_reply_to_id" : 185513478,
      "original_commit_id" : "4c790dff7481d1464a906ad6b17a3179a7da3431",
      "original_position" : 19,
      "path" : "src/net_processing.cpp",
      "position" : 19,
      "pull_request_review_id" : 116969819,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151",
      "updated_at" : "2018-05-07T12:28:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185556438",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "> Couldn't we serve corrupted blocks?\r\n\r\nYes, that's a possibility, though only if the underlying storage is corrupted. I've posited the idea to add a CRC32C to the on-disk blocks at some point (which is quick to verify, especially with specialized instructions, and should protect against accidental corruptions), but that's quite an invasive change. It's something that could be done later.\r\n\r\nThe only option to verify with the current information would be to do a Merkle tree check - which could be done without deserialization but it's not pretty... (and a serious overhead SHA256-hashing)",
      "created_at" : "2018-05-02T16:25:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-386037456",
      "id" : 386037456,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13151",
      "updated_at" : "2018-05-02T16:31:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/386037456",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> The only option to verify with the current information would be to do a Merkle tree check\r\n\r\nI don't see that we currently do this, so it wouldn't make anything worse here.",
      "created_at" : "2018-05-02T16:46:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-386043952",
      "id" : 386043952,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13151",
      "updated_at" : "2018-05-02T16:46:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/386043952",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think serving a corrupted block if our state is corrupted is fine, the peer will just disconnect us and go get the block from someone else, seems pretty harmless!\r\n\r\nThis is a much smaller change than I was expecting-- in particular I forgot there was a size, light review ACK. ",
      "created_at" : "2018-05-02T17:53:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-386064649",
      "id" : 386064649,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13151",
      "updated_at" : "2018-05-02T17:53:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/386064649",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185618019"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185618019"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Probably want to check the size is sane before we do this.",
      "commit_id" : "9893e712e9e04e8b9478e36e0b5d843899540bd2",
      "created_at" : "2018-05-02T19:49:45Z",
      "diff_hunk" : "@@ -1125,6 +1125,47 @@ bool ReadBlockFromDisk(CBlock& block, const CBlockIndex* pindex, const Consensus\n     return true;\n }\n \n+bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const CDiskBlockPos& pos, const CMessageHeader::MessageStartChars& messageStart)\n+{\n+    // Open history file to read\n+    CDiskBlockPos hpos = pos;\n+    hpos.nPos -= 8; // Seek back 8 bytes to validate header\n+    CAutoFile filein(OpenBlockFile(hpos, true), SER_DISK, CLIENT_VERSION);\n+    if (filein.IsNull()) {\n+        return error(\"%s: OpenBlockFile failed for %s\", __func__, pos.ToString());\n+    }\n+\n+    CMessageHeader::MessageStartChars msg_start_in;\n+    unsigned int nSize;\n+    filein >> msg_start_in >> nSize;\n+\n+    if (memcmp(msg_start_in, messageStart, CMessageHeader::MESSAGE_START_SIZE)) {\n+        return error(\"%s: Block magic mismatch for %s: %s versus expected %s\", __func__, pos.ToString(),\n+                HexStr(msg_start_in, msg_start_in + CMessageHeader::MESSAGE_START_SIZE),\n+                HexStr(messageStart, messageStart + CMessageHeader::MESSAGE_START_SIZE));\n+    }\n+\n+    try {\n+        block.resize(nSize);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185618019",
      "id" : 185618019,
      "original_commit_id" : "4c790dff7481d1464a906ad6b17a3179a7da3431",
      "original_position" : 25,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 117043685,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151",
      "updated_at" : "2018-05-07T12:28:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185618019",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185626068"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185626068"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Should probably remove this debug logging",
      "commit_id" : "9893e712e9e04e8b9478e36e0b5d843899540bd2",
      "created_at" : "2018-05-02T20:20:13Z",
      "diff_hunk" : "@@ -1142,60 +1143,71 @@ void static ProcessGetBlockData(CNode* pfrom, const Consensus::Params& consensus\n         std::shared_ptr<const CBlock> pblock;\n         if (a_recent_block && a_recent_block->GetHash() == pindex->GetBlockHash()) {\n             pblock = a_recent_block;\n+        } else if (inv.type == MSG_WITNESS_BLOCK) {\n+            // Fast-path: in this case it is possible to serve the block directly from disk,\n+            // as the network format matches the format on disk\n+            LogPrintf(\"debug: Serving raw block directly from disk: %s\\n\", pindex->ToString());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185626068",
      "id" : 185626068,
      "original_commit_id" : "4c790dff7481d1464a906ad6b17a3179a7da3431",
      "original_position" : 22,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 117053821,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151",
      "updated_at" : "2018-05-07T12:28:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185626068",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185627336"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185627336"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Leaving out the less common edge case (non-witness peers) seems fine for now.",
      "commit_id" : "9893e712e9e04e8b9478e36e0b5d843899540bd2",
      "created_at" : "2018-05-02T20:24:19Z",
      "diff_hunk" : "@@ -1142,60 +1143,71 @@ void static ProcessGetBlockData(CNode* pfrom, const Consensus::Params& consensus\n         std::shared_ptr<const CBlock> pblock;\n         if (a_recent_block && a_recent_block->GetHash() == pindex->GetBlockHash()) {\n             pblock = a_recent_block;\n+        } else if (inv.type == MSG_WITNESS_BLOCK) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185627336",
      "id" : 185627336,
      "in_reply_to_id" : 185513478,
      "original_commit_id" : "4c790dff7481d1464a906ad6b17a3179a7da3431",
      "original_position" : 19,
      "path" : "src/net_processing.cpp",
      "position" : 19,
      "pull_request_review_id" : 117053821,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151",
      "updated_at" : "2018-05-07T12:28:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185627336",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185700387"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185700387"
         }
      },
      "author_association" : "OWNER",
      "body" : "Yes, definitely. I added it while WIP so that people testing this can be sure that the code actually triggers and they're testing the right thing.",
      "commit_id" : "9893e712e9e04e8b9478e36e0b5d843899540bd2",
      "created_at" : "2018-05-03T05:41:25Z",
      "diff_hunk" : "@@ -1142,60 +1143,71 @@ void static ProcessGetBlockData(CNode* pfrom, const Consensus::Params& consensus\n         std::shared_ptr<const CBlock> pblock;\n         if (a_recent_block && a_recent_block->GetHash() == pindex->GetBlockHash()) {\n             pblock = a_recent_block;\n+        } else if (inv.type == MSG_WITNESS_BLOCK) {\n+            // Fast-path: in this case it is possible to serve the block directly from disk,\n+            // as the network format matches the format on disk\n+            LogPrintf(\"debug: Serving raw block directly from disk: %s\\n\", pindex->ToString());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185700387",
      "id" : 185700387,
      "in_reply_to_id" : 185626068,
      "original_commit_id" : "4c790dff7481d1464a906ad6b17a3179a7da3431",
      "original_position" : 22,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 117140984,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151",
      "updated_at" : "2018-05-07T12:28:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185700387",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185700508"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185700508"
         }
      },
      "author_association" : "OWNER",
      "body" : "Good point. What constant would be appropriate here? \r\nEdit: I'll go with MAX_SIZE from serialize.h.",
      "commit_id" : "9893e712e9e04e8b9478e36e0b5d843899540bd2",
      "created_at" : "2018-05-03T05:42:59Z",
      "diff_hunk" : "@@ -1125,6 +1125,47 @@ bool ReadBlockFromDisk(CBlock& block, const CBlockIndex* pindex, const Consensus\n     return true;\n }\n \n+bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const CDiskBlockPos& pos, const CMessageHeader::MessageStartChars& messageStart)\n+{\n+    // Open history file to read\n+    CDiskBlockPos hpos = pos;\n+    hpos.nPos -= 8; // Seek back 8 bytes to validate header\n+    CAutoFile filein(OpenBlockFile(hpos, true), SER_DISK, CLIENT_VERSION);\n+    if (filein.IsNull()) {\n+        return error(\"%s: OpenBlockFile failed for %s\", __func__, pos.ToString());\n+    }\n+\n+    CMessageHeader::MessageStartChars msg_start_in;\n+    unsigned int nSize;\n+    filein >> msg_start_in >> nSize;\n+\n+    if (memcmp(msg_start_in, messageStart, CMessageHeader::MESSAGE_START_SIZE)) {\n+        return error(\"%s: Block magic mismatch for %s: %s versus expected %s\", __func__, pos.ToString(),\n+                HexStr(msg_start_in, msg_start_in + CMessageHeader::MESSAGE_START_SIZE),\n+                HexStr(messageStart, messageStart + CMessageHeader::MESSAGE_START_SIZE));\n+    }\n+\n+    try {\n+        block.resize(nSize);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185700508",
      "id" : 185700508,
      "in_reply_to_id" : 185618019,
      "original_commit_id" : "4c790dff7481d1464a906ad6b17a3179a7da3431",
      "original_position" : 25,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 117141119,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151",
      "updated_at" : "2018-05-07T12:28:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185700508",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185700927"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185700927"
         }
      },
      "author_association" : "OWNER",
      "body" : "~~Another thing I wondered here: what is the C++11 proper way to allocate a vector (or a RAII memory area) without zeroing it? I think that's unnecessary here.~~\r\nThat was a bad idea: even though we handle errors while reading, as this data is sent directly over P2P, zeroing is defense-in-depth against heartbleed-style issues here",
      "commit_id" : "9893e712e9e04e8b9478e36e0b5d843899540bd2",
      "created_at" : "2018-05-03T05:47:37Z",
      "diff_hunk" : "@@ -1125,6 +1125,47 @@ bool ReadBlockFromDisk(CBlock& block, const CBlockIndex* pindex, const Consensus\n     return true;\n }\n \n+bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const CDiskBlockPos& pos, const CMessageHeader::MessageStartChars& messageStart)\n+{\n+    // Open history file to read\n+    CDiskBlockPos hpos = pos;\n+    hpos.nPos -= 8; // Seek back 8 bytes to validate header\n+    CAutoFile filein(OpenBlockFile(hpos, true), SER_DISK, CLIENT_VERSION);\n+    if (filein.IsNull()) {\n+        return error(\"%s: OpenBlockFile failed for %s\", __func__, pos.ToString());\n+    }\n+\n+    CMessageHeader::MessageStartChars msg_start_in;\n+    unsigned int nSize;\n+    filein >> msg_start_in >> nSize;\n+\n+    if (memcmp(msg_start_in, messageStart, CMessageHeader::MESSAGE_START_SIZE)) {\n+        return error(\"%s: Block magic mismatch for %s: %s versus expected %s\", __func__, pos.ToString(),\n+                HexStr(msg_start_in, msg_start_in + CMessageHeader::MESSAGE_START_SIZE),\n+                HexStr(messageStart, messageStart + CMessageHeader::MESSAGE_START_SIZE));\n+    }\n+\n+    try {\n+        block.resize(nSize);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185700927",
      "id" : 185700927,
      "in_reply_to_id" : 185618019,
      "original_commit_id" : "4c790dff7481d1464a906ad6b17a3179a7da3431",
      "original_position" : 25,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 117141587,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151",
      "updated_at" : "2018-05-07T12:28:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185700927",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 4c790dff7481d1464a906ad6b17a3179a7da3431\r\n\r\nThis would probably also speedup an external indexing daemon via p2p (see experiment in https://github.com/jonasschnelli/bitcoincore-indexd [**very WIP**])\r\n\r\nHere a flamegraph of serving the first 200k blocks via p2p localhost (though the real deser/ser starts probably at higher up in the chain).",
      "created_at" : "2018-05-03T06:44:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-386204255",
      "id" : 386204255,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13151",
      "updated_at" : "2018-05-03T06:44:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/386204255",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185725419"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185725419"
         }
      },
      "author_association" : "OWNER",
      "body" : "I guess this deserialization logic should be within the try {}.",
      "commit_id" : "9893e712e9e04e8b9478e36e0b5d843899540bd2",
      "created_at" : "2018-05-03T08:25:23Z",
      "diff_hunk" : "@@ -1125,6 +1125,47 @@ bool ReadBlockFromDisk(CBlock& block, const CBlockIndex* pindex, const Consensus\n     return true;\n }\n \n+bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const CDiskBlockPos& pos, const CMessageHeader::MessageStartChars& messageStart)\n+{\n+    // Open history file to read\n+    CDiskBlockPos hpos = pos;\n+    hpos.nPos -= 8; // Seek back 8 bytes to validate header\n+    CAutoFile filein(OpenBlockFile(hpos, true), SER_DISK, CLIENT_VERSION);\n+    if (filein.IsNull()) {\n+        return error(\"%s: OpenBlockFile failed for %s\", __func__, pos.ToString());\n+    }\n+\n+    CMessageHeader::MessageStartChars msg_start_in;\n+    unsigned int nSize;\n+    filein >> msg_start_in >> nSize;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185725419",
      "id" : 185725419,
      "original_commit_id" : "4c790dff7481d1464a906ad6b17a3179a7da3431",
      "original_position" : 16,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 117170952,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151",
      "updated_at" : "2018-05-07T12:28:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185725419",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "OK, thanks for review everyone, removed WIP tag and pushed commits with the following changes:\r\n- Remove extraneous debug log message\r\n- Check nSize against MAX_SIZE\r\n- Move deserialization of msg_start_in, and size into exception try\r\n- Improved variable and parameter naming\r\n\r\nWill squash if no further issues.\r\n\r\n> This would probably also speedup an external indexing daemon via p2p (see experiment in https://github.com/jonasschnelli/bitcoincore-indexd [very WIP])\r\n\r\nYeah - I saw in #13098 that @MarcoFalke had also optimized the zmq full-block notification part. I'm not sure that is any critical path performance-wise (maybe for your indexer?) but if so I'll leave that for a later PR.\r\n\r\n> Here a flamegraph of serving the first 200k blocks via p2p localhost (though the real deser/ser starts probably at higher up in the chain).\r\n\r\nDid you forget to post the link?\r\n",
      "created_at" : "2018-05-03T08:49:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-386229535",
      "id" : 386229535,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13151",
      "updated_at" : "2018-05-03T08:56:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/386229535",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185962354"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185962354"
         }
      },
      "author_association" : "OWNER",
      "body" : "Nit: braces around then-branch if on a separate line.",
      "commit_id" : "9893e712e9e04e8b9478e36e0b5d843899540bd2",
      "created_at" : "2018-05-03T23:25:33Z",
      "diff_hunk" : "@@ -1142,60 +1143,70 @@ void static ProcessGetBlockData(CNode* pfrom, const Consensus::Params& consensus\n         std::shared_ptr<const CBlock> pblock;\n         if (a_recent_block && a_recent_block->GetHash() == pindex->GetBlockHash()) {\n             pblock = a_recent_block;\n+        } else if (inv.type == MSG_WITNESS_BLOCK) {\n+            // Fast-path: in this case it is possible to serve the block directly from disk,\n+            // as the network format matches the format on disk\n+            std::vector<uint8_t> block_data;\n+            if (!ReadRawBlockFromDisk(block_data, pindex, chainparams.MessageStart()))\n+                assert(!\"cannot load block from disk\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r185962354",
      "id" : 185962354,
      "original_commit_id" : "e0223ebf0c58f7beedea91df48e9586154cd4436",
      "original_position" : 24,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 117461781,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151",
      "updated_at" : "2018-05-07T12:28:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185962354",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Running with e0223ebf0c58f7beedea91df48e9586154cd4436 and just looking at the wall clock time for reading+optional deserialization shows for me on an ssd:\r\n\r\n![ssd](https://user-images.githubusercontent.com/6399679/39608643-e4666006-4f10-11e8-8f98-4de0b2765f16.png)\r\n\r\nEdit: Note that this was done with full fake blocks and not real blocks from the network.\r\n\r\n",
      "created_at" : "2018-05-04T00:33:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-386476909",
      "id" : 386476909,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13151",
      "updated_at" : "2018-05-04T14:50:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/386476909",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "Thanks for benchmarking @MarcoFalke.\r\n\r\nI used [a patched version](https://github.com/laanwj/bitcoincore-indexd/tree/bench) of @jonasschnelli's bitcoincore-indexd to benchmark the time for fetching block 0..473600 through P2P, with no processing client-side. The result is:\r\n```\r\nWith patch:\r\nreal    63m51.273s\r\n\r\nWithout patch:\r\nreal    70m28.956s\r\n```\r\n10% speedup. And in my case is the blocks are on a slow harddisk. I expect the gains to be more significant in case of a faster storage medium, or slower CPU.",
      "created_at" : "2018-05-04T15:53:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-386644732",
      "id" : 386644732,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13151",
      "updated_at" : "2018-05-04T15:53:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/386644732",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r186425140"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/186425140"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit, space after catch `} catch (...`.",
      "commit_id" : "9893e712e9e04e8b9478e36e0b5d843899540bd2",
      "created_at" : "2018-05-07T13:39:41Z",
      "diff_hunk" : "@@ -1125,6 +1125,52 @@ bool ReadBlockFromDisk(CBlock& block, const CBlockIndex* pindex, const Consensus\n     return true;\n }\n \n+bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const CDiskBlockPos& pos, const CMessageHeader::MessageStartChars& message_start)\n+{\n+    CDiskBlockPos hpos = pos;\n+    hpos.nPos -= 8; // Seek back 8 bytes for meta header\n+    CAutoFile filein(OpenBlockFile(hpos, true), SER_DISK, CLIENT_VERSION);\n+    if (filein.IsNull()) {\n+        return error(\"%s: OpenBlockFile failed for %s\", __func__, pos.ToString());\n+    }\n+\n+    try {\n+        CMessageHeader::MessageStartChars blk_start;\n+        unsigned int blk_size;\n+\n+        filein >> blk_start >> blk_size;\n+\n+        if (memcmp(blk_start, message_start, CMessageHeader::MESSAGE_START_SIZE)) {\n+            return error(\"%s: Block magic mismatch for %s: %s versus expected %s\", __func__, pos.ToString(),\n+                    HexStr(blk_start, blk_start + CMessageHeader::MESSAGE_START_SIZE),\n+                    HexStr(message_start, message_start + CMessageHeader::MESSAGE_START_SIZE));\n+        }\n+\n+        if (blk_size > MAX_SIZE) {\n+            return error(\"%s: Block data is larger than maximum deserialization size for %s: %s versus %s\", __func__, pos.ToString(),\n+                    blk_size, MAX_SIZE);\n+        }\n+\n+        block.resize(blk_size); // Zeroing of memory is intentional here\n+        filein.read((char*)block.data(), blk_size);\n+    } catch(const std::exception& e) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r186425140",
      "id" : 186425140,
      "original_commit_id" : "9893e712e9e04e8b9478e36e0b5d843899540bd2",
      "original_position" : 32,
      "path" : "src/validation.cpp",
      "position" : 32,
      "pull_request_review_id" : 117999243,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151",
      "updated_at" : "2018-05-07T13:44:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/186425140",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r186426186"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/186426186"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Zeroing of memory is intentional \r\n\r\nWhy?",
      "commit_id" : "9893e712e9e04e8b9478e36e0b5d843899540bd2",
      "created_at" : "2018-05-07T13:43:20Z",
      "diff_hunk" : "@@ -1125,6 +1125,52 @@ bool ReadBlockFromDisk(CBlock& block, const CBlockIndex* pindex, const Consensus\n     return true;\n }\n \n+bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const CDiskBlockPos& pos, const CMessageHeader::MessageStartChars& message_start)\n+{\n+    CDiskBlockPos hpos = pos;\n+    hpos.nPos -= 8; // Seek back 8 bytes for meta header\n+    CAutoFile filein(OpenBlockFile(hpos, true), SER_DISK, CLIENT_VERSION);\n+    if (filein.IsNull()) {\n+        return error(\"%s: OpenBlockFile failed for %s\", __func__, pos.ToString());\n+    }\n+\n+    try {\n+        CMessageHeader::MessageStartChars blk_start;\n+        unsigned int blk_size;\n+\n+        filein >> blk_start >> blk_size;\n+\n+        if (memcmp(blk_start, message_start, CMessageHeader::MESSAGE_START_SIZE)) {\n+            return error(\"%s: Block magic mismatch for %s: %s versus expected %s\", __func__, pos.ToString(),\n+                    HexStr(blk_start, blk_start + CMessageHeader::MESSAGE_START_SIZE),\n+                    HexStr(message_start, message_start + CMessageHeader::MESSAGE_START_SIZE));\n+        }\n+\n+        if (blk_size > MAX_SIZE) {\n+            return error(\"%s: Block data is larger than maximum deserialization size for %s: %s versus %s\", __func__, pos.ToString(),\n+                    blk_size, MAX_SIZE);\n+        }\n+\n+        block.resize(blk_size); // Zeroing of memory is intentional here",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r186426186",
      "id" : 186426186,
      "original_commit_id" : "9893e712e9e04e8b9478e36e0b5d843899540bd2",
      "original_position" : 30,
      "path" : "src/validation.cpp",
      "position" : 30,
      "pull_request_review_id" : 117999243,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151",
      "updated_at" : "2018-05-07T13:44:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/186426186",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r186431924"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/186431924"
         }
      },
      "author_association" : "OWNER",
      "body" : "To avoid heartbleed-type leaks as this data goes directly over the network.",
      "commit_id" : "9893e712e9e04e8b9478e36e0b5d843899540bd2",
      "created_at" : "2018-05-07T14:01:55Z",
      "diff_hunk" : "@@ -1125,6 +1125,52 @@ bool ReadBlockFromDisk(CBlock& block, const CBlockIndex* pindex, const Consensus\n     return true;\n }\n \n+bool ReadRawBlockFromDisk(std::vector<uint8_t>& block, const CDiskBlockPos& pos, const CMessageHeader::MessageStartChars& message_start)\n+{\n+    CDiskBlockPos hpos = pos;\n+    hpos.nPos -= 8; // Seek back 8 bytes for meta header\n+    CAutoFile filein(OpenBlockFile(hpos, true), SER_DISK, CLIENT_VERSION);\n+    if (filein.IsNull()) {\n+        return error(\"%s: OpenBlockFile failed for %s\", __func__, pos.ToString());\n+    }\n+\n+    try {\n+        CMessageHeader::MessageStartChars blk_start;\n+        unsigned int blk_size;\n+\n+        filein >> blk_start >> blk_size;\n+\n+        if (memcmp(blk_start, message_start, CMessageHeader::MESSAGE_START_SIZE)) {\n+            return error(\"%s: Block magic mismatch for %s: %s versus expected %s\", __func__, pos.ToString(),\n+                    HexStr(blk_start, blk_start + CMessageHeader::MESSAGE_START_SIZE),\n+                    HexStr(message_start, message_start + CMessageHeader::MESSAGE_START_SIZE));\n+        }\n+\n+        if (blk_size > MAX_SIZE) {\n+            return error(\"%s: Block data is larger than maximum deserialization size for %s: %s versus %s\", __func__, pos.ToString(),\n+                    blk_size, MAX_SIZE);\n+        }\n+\n+        block.resize(blk_size); // Zeroing of memory is intentional here",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r186431924",
      "id" : 186431924,
      "in_reply_to_id" : 186426186,
      "original_commit_id" : "9893e712e9e04e8b9478e36e0b5d843899540bd2",
      "original_position" : 30,
      "path" : "src/validation.cpp",
      "position" : 30,
      "pull_request_review_id" : 118007306,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151",
      "updated_at" : "2018-05-07T14:01:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/186431924",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Did 10 rounds of requesting blocks in range 490'000 up to 500'000 on master and got.\r\nSetup:\r\n- Non VM machine\r\n- SSD 1400MB/s\r\n- Intel(R) Xeon(R) CPU E3-1275 v5 @ 3.60GHz\r\n- txindex was enabled\r\n- connect=0 --whitebind=127.0.0.1:8333\r\n- no other resource intense applications where running on that system\r\n- used a modified version of `https://github.com/laanwj/bitcoincore-indexd`\r\n\r\n### Master (`-g -O2`):\r\n`95211ms` in avg. (all rounds where very similar and there was no need to exclude the first round)\r\nexemption\r\n\r\n### This PR (`-g O2`):\r\n`101051ms` in avg.\r\n\r\nI can't figure out why this PR performs ~6% slower and I double checked the comparison by manually rolling back from the head of this PR to 598db389c33e5e90783ef1223df2eeab095ed622 and back to head. Also added the `LogPrintfs` back to ensure I'm using the \"fast track\" (removed again during benchmarking).\r\n\r\nsidenode: found out that `-debug=net` (which was disabled during the rounds reported above) account for a 3% slowdown for the above test-scenario.",
      "created_at" : "2018-05-07T15:10:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-387096890",
      "id" : 387096890,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13151",
      "updated_at" : "2018-05-07T15:10:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/387096890",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "@jonasschnelli That's really strange. As reported, I did see some actual speed-ups where using this.\r\nMaybe someone else can try some measurements, or we should just close, I don't know.",
      "created_at" : "2018-05-09T05:35:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-387625250",
      "id" : 387625250,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13151",
      "updated_at" : "2018-05-09T05:35:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/387625250",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "If someone wants to compare master against this PR built in the same environment:\r\n\r\nPR: https://bitcoin.jonasschnelli.ch/build/600\r\nmaster: https://bitcoin.jonasschnelli.ch/build/599",
      "created_at" : "2018-05-09T08:47:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-387668563",
      "id" : 387668563,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13151",
      "updated_at" : "2018-05-09T08:47:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/387668563",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I updated my benchmark to also include the time it takes to `Make` (serialize) the net message:\r\n\r\n![net message serialization times](https://user-images.githubusercontent.com/6399679/39831568-e6e2cda2-5392-11e8-9fb0-784b4052d2fe.png)\r\n\r\n",
      "created_at" : "2018-05-09T18:12:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-387827645",
      "id" : 387827645,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13151",
      "updated_at" : "2018-05-09T18:12:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/387827645",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think we should definitively look into why it is *slower* to sync, since that indicates a problem (potentially in our code) exists elsewhere.",
      "created_at" : "2018-05-09T18:15:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-387828680",
      "id" : 387828680,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13151",
      "updated_at" : "2018-05-09T18:15:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/387828680",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "I did the same experiment as @jonasschnelli, a modified `bitcoincore-indexd` that requests block 490000..500000 (https://github.com/laanwj/bitcoincore-indexd/tree/bench). Tried both cases 5 times;\r\n```\r\nwith patch:\r\nreal    0m55.928s\r\nreal    0m55.986s\r\nreal    0m55.913s\r\nreal    0m55.844s\r\nreal    0m55.790s\r\n\r\nwithout patch (using the commit before):\r\nreal    2m47.673s\r\nreal    2m46.329s\r\nreal    2m46.634s\r\nreal    2m46.413s\r\nreal    2m46.458s\r\n```\r\n~66% speedup. This is with a spinning rust disk not a SSD. This was done on a different computer than my previous test.",
      "created_at" : "2018-05-13T17:45:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-388643795",
      "id" : 388643795,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13151",
      "updated_at" : "2018-05-13T18:43:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/388643795",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r187811270"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/187811270"
         }
      },
      "author_association" : "OWNER",
      "body" : "Unsure if we care, but we could also check whether SegWit was active for the requested block, and if not, we can serve without deserialization even when witnesses are not requested.",
      "commit_id" : "9893e712e9e04e8b9478e36e0b5d843899540bd2",
      "created_at" : "2018-05-13T19:39:49Z",
      "diff_hunk" : "@@ -1142,60 +1143,71 @@ void static ProcessGetBlockData(CNode* pfrom, const Consensus::Params& consensus\n         std::shared_ptr<const CBlock> pblock;\n         if (a_recent_block && a_recent_block->GetHash() == pindex->GetBlockHash()) {\n             pblock = a_recent_block;\n+        } else if (inv.type == MSG_WITNESS_BLOCK) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r187811270",
      "id" : 187811270,
      "in_reply_to_id" : 185513478,
      "original_commit_id" : "4c790dff7481d1464a906ad6b17a3179a7da3431",
      "original_position" : 19,
      "path" : "src/net_processing.cpp",
      "position" : 19,
      "pull_request_review_id" : 119664646,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151",
      "updated_at" : "2018-05-13T19:39:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/187811270",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r187985516"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/187985516"
         }
      },
      "author_association" : "OWNER",
      "body" : "@sipa Yes, that would be something that could be done here.",
      "commit_id" : "9893e712e9e04e8b9478e36e0b5d843899540bd2",
      "created_at" : "2018-05-14T14:58:54Z",
      "diff_hunk" : "@@ -1142,60 +1143,71 @@ void static ProcessGetBlockData(CNode* pfrom, const Consensus::Params& consensus\n         std::shared_ptr<const CBlock> pblock;\n         if (a_recent_block && a_recent_block->GetHash() == pindex->GetBlockHash()) {\n             pblock = a_recent_block;\n+        } else if (inv.type == MSG_WITNESS_BLOCK) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#discussion_r187985516",
      "id" : 187985516,
      "in_reply_to_id" : 185513478,
      "original_commit_id" : "4c790dff7481d1464a906ad6b17a3179a7da3431",
      "original_position" : 19,
      "path" : "src/net_processing.cpp",
      "position" : 19,
      "pull_request_review_id" : 119873073,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13151",
      "updated_at" : "2018-05-14T14:58:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/187985516",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think this is a clear benefit for spinning disk and probably also for ssd in non absurd localhost cases.\r\n\r\nutACK\r\n\r\n",
      "created_at" : "2018-05-14T15:19:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-388855548",
      "id" : 388855548,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13151",
      "updated_at" : "2018-05-14T15:19:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/388855548",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jonasschnelli Did you have a chance to look into why your result was unexpected?",
      "created_at" : "2018-05-14T15:27:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-388858562",
      "id" : 388858562,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13151",
      "updated_at" : "2018-05-14T15:27:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/388858562",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@Marcofalke: no. I haven't but I'm willing to do as soon as someone could confirm my results (SSD test).",
      "created_at" : "2018-05-14T15:40:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-388863028",
      "id" : 388863028,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13151",
      "updated_at" : "2018-05-14T15:40:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/388863028",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Sure, will do\n\nOn Mon, May 14, 2018, 11:41 Jonas Schnelli <notifications@github.com> wrote:\n\n> @MarcoFalke <https://github.com/MarcoFalke>: no. I haven't but I'm\n> willing to do as soon as someone could confirm my results (SSD test).\n>\n> Ã¢ÂÂ\n> You are receiving this because you were mentioned.\n> Reply to this email directly, view it on GitHub\n> <https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-388863028>,\n> or mute the thread\n> <https://github.com/notifications/unsubscribe-auth/AGGmv9-r1eVW0U-ZpIGMl9OABHCU7k27ks5tyaWYgaJpZM4TvWjI>\n> .\n>\n",
      "created_at" : "2018-05-14T16:04:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-388871401",
      "id" : 388871401,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13151",
      "updated_at" : "2018-05-14T16:04:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/388871401",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "For clarity: 598db means master@598db and 9893e means this pull request. I used @laanwj's branch of bitcoincore-indexd.\r\n\r\n![10k block fetch times 490k-500k](https://user-images.githubusercontent.com/6399679/40023302-9b7d7786-5798-11e8-84a6-1ec1ab632353.png)\r\n",
      "created_at" : "2018-05-14T21:04:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-388962412",
      "id" : 388962412,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13151",
      "updated_at" : "2018-05-14T21:04:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/388962412",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jonasschnelli I coulnd't find the branch you were using. Mind to share, otherwise I can't reproduce?",
      "created_at" : "2018-05-14T21:06:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-388962821",
      "id" : 388962821,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13151",
      "updated_at" : "2018-05-14T21:06:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/388962821",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Same experiment as https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-388643795 on i.MX6Q ARM board w/ USB2 spinning disk:\r\n```\r\nwith patch:\r\nreal    10m18.368s\r\nreal    11m14.600s\r\nreal    10m12.006s\r\nreal    10m21.668s\r\nreal    10m11.070s\r\n\r\nwithout patch (using the commit before):\r\nreal    27m30.574s\r\nreal    26m27.591s\r\nreal    25m38.311s\r\nreal    25m36.661s\r\nreal    25m40.902s\r\n```\r\nSeems to help even with a slow CPU and slow I/O.",
      "created_at" : "2018-05-15T06:05:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-389052920",
      "id" : 389052920,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13151",
      "updated_at" : "2018-05-15T07:15:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/389052920",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "squashed, no other changes --\r\n9893e712e9e04e8b9478e36e0b5d843899540bd2 Ã¢ÂÂ 0bf431870e45d8e20c4671e51a782ebf97b75fac",
      "created_at" : "2018-05-15T06:13:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-389054434",
      "id" : 389054434,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13151",
      "updated_at" : "2018-05-15T06:13:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/389054434",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I guess my setup was either faulty or there is a performance loss with that particular setup (>1000MB/s IO r&w on very fast CPUs).\r\nHowever, this PR is a clear and significant win!",
      "created_at" : "2018-05-15T18:23:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-389265594",
      "id" : 389265594,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13151",
      "updated_at" : "2018-05-15T18:23:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/389265594",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jonasschnelli I can't explain why, but you might want to try to drop the files cached in memory with `sync && sudo sh -c 'echo 3 > /proc/sys/vm/drop_caches'`. For me this was *speeding up* the sync on an ssd.",
      "created_at" : "2018-05-15T18:57:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13151#issuecomment-389276281",
      "id" : 389276281,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13151",
      "updated_at" : "2018-05-15T18:57:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/389276281",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
