[
   {
      "author_association" : "MEMBER",
      "body" : "Is this reproducible? Does it happens at the same level of progress if you try to rescan again?",
      "created_at" : "2018-03-09T04:53:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/12646#issuecomment-371713113",
      "id" : 371713113,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12646",
      "updated_at" : "2018-03-09T04:53:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/371713113",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/178464?v=4",
         "events_url" : "https://api.github.com/users/jonasschnelli/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonasschnelli/followers",
         "following_url" : "https://api.github.com/users/jonasschnelli/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonasschnelli",
         "id" : 178464,
         "login" : "jonasschnelli",
         "organizations_url" : "https://api.github.com/users/jonasschnelli/orgs",
         "received_events_url" : "https://api.github.com/users/jonasschnelli/received_events",
         "repos_url" : "https://api.github.com/users/jonasschnelli/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonasschnelli/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonasschnelli"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Yes it's reproducible and happens at the same level of progress.",
      "created_at" : "2018-03-10T11:07:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/12646#issuecomment-372021787",
      "id" : 372021787,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12646",
      "updated_at" : "2018-03-10T11:07:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/372021787",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/12032350?v=4",
         "events_url" : "https://api.github.com/users/GSPP/events{/privacy}",
         "followers_url" : "https://api.github.com/users/GSPP/followers",
         "following_url" : "https://api.github.com/users/GSPP/following{/other_user}",
         "gists_url" : "https://api.github.com/users/GSPP/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/GSPP",
         "id" : 12032350,
         "login" : "GSPP",
         "organizations_url" : "https://api.github.com/users/GSPP/orgs",
         "received_events_url" : "https://api.github.com/users/GSPP/received_events",
         "repos_url" : "https://api.github.com/users/GSPP/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/GSPP/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/GSPP/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/GSPP"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This is an assert in `MarkReserveKeysAsUsed()`, introduced in https://github.com/bitcoin/bitcoin/commit/095142d1f93f39ad2b88dbe8d40140223a1b3900 (#11022)",
      "created_at" : "2018-04-02T21:13:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/12646#issuecomment-378048488",
      "id" : 378048488,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12646",
      "updated_at" : "2018-04-02T21:13:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/378048488",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've dug into this a bit, but I haven't been able to identify the bug yet.\r\n\r\nThe first assert is in `MarkReserveKeysAsUsed()`. This is called by `AddToWalletIfInvolvingMe()` if a transaction is seen which involves a keypool key in `m_pool_key_to_index`. `MarkReserveKeysAsUsed()` asserts that the keypool entry is either in `setInternalKeyPool` or `setExternalKeyPool`. This assertion failure indicates that the keypool is in an inconsistent state where a keypool entry isn't in the external keypool set or the internal keypool set.\r\n\r\nI've gone through all the places where `m_pool_key_to_index`, `setInternalKeyPool` and `setExternalKeyPool` are updated, and I can't see anywhere obvious that adds to `m_pool_key_to_index` without inserting into `set{In,Ex}ternalKeyPool` (or conversely deletes from `set{In,Ex}ternalKeyPool` without deleting from `m_pool_key_to_index`), except if `ReserveKeyFromKeyPool()` threw one of the `std::runtime_error`s, caught and continued:\r\n\r\n```\r\n        auto it = setKeyPool.begin();\r\n        nIndex = *it;\r\n        setKeyPool.erase(it);\r\n        if (!walletdb.ReadPool(nIndex, keypool)) {\r\n            throw std::runtime_error(std::string(__func__) + \": read failed\");\r\n        }\r\n        if (!HaveKey(keypool.vchPubKey.GetID())) {\r\n            throw std::runtime_error(std::string(__func__) + \": unknown key in key pool\");\r\n        }\r\n        if (keypool.fInternal != fReturningInternal) {\r\n            throw std::runtime_error(std::string(__func__) + \": keypool entry misclassified\");\r\n        }\r\n\r\n        assert(keypool.vchPubKey.IsValid());\r\n        m_pool_key_to_index.erase(keypool.vchPubKey.GetID());\r\n```\r\n\r\nOnce the assert is hit in `MarkReserveKeysAsUsed()` and you continued, I wouldn't be surprised if the wallet's internal data was corrupted further.\r\n\r\n@GSPP - a few questions:\r\n\r\n- have you managed to restore this wallet yet? I suspect trying on V0.15.1 will allow you to `dumpwallet`\r\n- you say this is an 'old' wallet. I presume that's before from V0.15? (ie before the HD wallet split which split the keypool into internal/external)\r\n- How large is your debug.log. Are you able to upload the full file somewhere?",
      "created_at" : "2018-05-24T21:51:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/12646#issuecomment-391876717",
      "id" : 391876717,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12646",
      "updated_at" : "2018-05-24T21:51:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/391876717",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "I'd be willing to send the wallet to someone on the team. It's not a very important wallet. When you're done working on it I'd swipe the funds if there are any.",
      "created_at" : "2018-05-25T08:47:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/12646#issuecomment-391985779",
      "id" : 391985779,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12646",
      "updated_at" : "2018-05-25T08:47:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/391985779",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/12032350?v=4",
         "events_url" : "https://api.github.com/users/GSPP/events{/privacy}",
         "followers_url" : "https://api.github.com/users/GSPP/followers",
         "following_url" : "https://api.github.com/users/GSPP/following{/other_user}",
         "gists_url" : "https://api.github.com/users/GSPP/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/GSPP",
         "id" : 12032350,
         "login" : "GSPP",
         "organizations_url" : "https://api.github.com/users/GSPP/orgs",
         "received_events_url" : "https://api.github.com/users/GSPP/received_events",
         "repos_url" : "https://api.github.com/users/GSPP/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/GSPP/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/GSPP/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/GSPP"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "~I'm happy to take a look at the wallet.dat file, with the understanding that I can't be responsible for any funds in there. I won't take them, but I can't be responsible for them :)~\r\n\r\nEDIT: On second thoughts, I think this isn't a great idea. Please don't send the wallet file to me!\r\n\r\nInstead, I recommend you try restoring the wallet in v0.15 and sweep the funds to a new address.",
      "created_at" : "2018-05-25T15:23:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/12646#issuecomment-392092906",
      "id" : 392092906,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/12646",
      "updated_at" : "2018-05-25T15:43:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/392092906",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   }
]
