[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r506750526"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/506750526"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can you make the changes to the test framework in a separate commit?",
      "commit_id" : "bc4a23008762702ffcd6868bcdb8fe2a732640ba",
      "created_at" : "2020-10-16T22:40:09Z",
      "diff_hunk" : "@@ -148,7 +148,7 @@ def test_witness_block(node, p2p, block, accepted, with_witness=True, reason=Non\n \n class TestP2PConn(P2PInterface):\n     def __init__(self, wtxidrelay=False):\n-        super().__init__()\n+        super().__init__(wtxidrelay=wtxidrelay)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r506750526",
      "id" : 506750526,
      "line" : 150,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc1MDUyNg==",
      "original_commit_id" : "637d7a128e379153d14f7427c9d7a31a35ed1a94",
      "original_line" : 150,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "test/functional/p2p_segwit.py",
      "position" : 13,
      "pull_request_review_id" : 510833902,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-02T23:37:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/506750526",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r506750652"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/506750652"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Wouldn't it be better to start mocking before the inv is sent? So that local timing doesn't matter?",
      "commit_id" : "bc4a23008762702ffcd6868bcdb8fe2a732640ba",
      "created_at" : "2020-10-16T22:40:42Z",
      "diff_hunk" : "@@ -216,6 +216,24 @@ def test_preferred_inv(self):\n         with p2p_lock:\n             assert_equal(peer.tx_getdata_count, 1)\n \n+    def test_txid_inv_delay(self):\n+        self.log.info('Check that inv from a txid-relay peers are delayed by {} s'.format(TXID_RELAY_DELAY))\n+        self.restart_node(0, extra_args=['-whitelist=noban@127.0.0.1'])\n+        mock_time = int(time.time() + 1)\n+        self.nodes[0].setmocktime(mock_time)\n+        peer = self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=False))\n+        # Add a second wtxid-relay connection otherwise TXID_RELAY_DELAY is waived in\n+        # lack of wtxid-relay peers\n+        self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=True))\n+        peer.send_message(msg_inv([CInv(t=MSG_TX, h=0xff11ff11)]))\n+        peer.sync_with_ping()\n+        with p2p_lock:\n+            assert_equal(peer.tx_getdata_count, 0)\n+        self.nodes[0].setmocktime(mock_time + TXID_RELAY_DELAY)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r506750652",
      "id" : 506750652,
      "line" : 238,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc1MDY1Mg==",
      "original_commit_id" : "637d7a128e379153d14f7427c9d7a31a35ed1a94",
      "original_line" : 238,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_tx_download.py",
      "position" : 82,
      "pull_request_review_id" : 510833902,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-02T23:37:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/506750652",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r506953789"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/506953789"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sure, I did it at first before to squash. Split in two.",
      "commit_id" : "bc4a23008762702ffcd6868bcdb8fe2a732640ba",
      "created_at" : "2020-10-17T15:26:14Z",
      "diff_hunk" : "@@ -148,7 +148,7 @@ def test_witness_block(node, p2p, block, accepted, with_witness=True, reason=Non\n \n class TestP2PConn(P2PInterface):\n     def __init__(self, wtxidrelay=False):\n-        super().__init__()\n+        super().__init__(wtxidrelay=wtxidrelay)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r506953789",
      "id" : 506953789,
      "in_reply_to_id" : 506750526,
      "line" : 150,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk1Mzc4OQ==",
      "original_commit_id" : "637d7a128e379153d14f7427c9d7a31a35ed1a94",
      "original_line" : 150,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "test/functional/p2p_segwit.py",
      "position" : 13,
      "pull_request_review_id" : 510993295,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-02T23:37:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/506953789",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r506953932"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/506953932"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think that's already done L223, we set mocktime for nodes 0 before it's even connected to the first p2p connection. Or do you have a more constraining definition of mocktime in mind ?",
      "commit_id" : "bc4a23008762702ffcd6868bcdb8fe2a732640ba",
      "created_at" : "2020-10-17T15:27:50Z",
      "diff_hunk" : "@@ -216,6 +216,24 @@ def test_preferred_inv(self):\n         with p2p_lock:\n             assert_equal(peer.tx_getdata_count, 1)\n \n+    def test_txid_inv_delay(self):\n+        self.log.info('Check that inv from a txid-relay peers are delayed by {} s'.format(TXID_RELAY_DELAY))\n+        self.restart_node(0, extra_args=['-whitelist=noban@127.0.0.1'])\n+        mock_time = int(time.time() + 1)\n+        self.nodes[0].setmocktime(mock_time)\n+        peer = self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=False))\n+        # Add a second wtxid-relay connection otherwise TXID_RELAY_DELAY is waived in\n+        # lack of wtxid-relay peers\n+        self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=True))\n+        peer.send_message(msg_inv([CInv(t=MSG_TX, h=0xff11ff11)]))\n+        peer.sync_with_ping()\n+        with p2p_lock:\n+            assert_equal(peer.tx_getdata_count, 0)\n+        self.nodes[0].setmocktime(mock_time + TXID_RELAY_DELAY)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r506953932",
      "id" : 506953932,
      "in_reply_to_id" : 506750652,
      "line" : 238,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk1MzkzMg==",
      "original_commit_id" : "637d7a128e379153d14f7427c9d7a31a35ed1a94",
      "original_line" : 238,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_tx_download.py",
      "position" : 82,
      "pull_request_review_id" : 510993409,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-02T23:37:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/506953932",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks, updated at f0fe840. See if this [comment](https://github.com/bitcoin/bitcoin/pull/20171#discussion_r506750652) needs further modification.",
      "created_at" : "2020-10-17T15:33:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20171#issuecomment-711030614",
      "id" : 711030614,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20171",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxMTAzMDYxNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-17T15:33:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/711030614",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r507519684"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/507519684"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`wait until` right above wouldn't allow this line to happen if `tx_getdata_count == 0`. So we're checking it's NOT more than 1? Is it a worthy check?... It has nothing to do with delays.",
      "commit_id" : "bc4a23008762702ffcd6868bcdb8fe2a732640ba",
      "created_at" : "2020-10-19T07:11:13Z",
      "diff_hunk" : "@@ -216,6 +216,24 @@ def test_preferred_inv(self):\n         with p2p_lock:\n             assert_equal(peer.tx_getdata_count, 1)\n \n+    def test_txid_inv_delay(self):\n+        self.log.info('Check that inv from a txid-relay peers are delayed by {} s'.format(TXID_RELAY_DELAY))\n+        self.restart_node(0, extra_args=['-whitelist=noban@127.0.0.1'])\n+        mock_time = int(time.time() + 1)\n+        self.nodes[0].setmocktime(mock_time)\n+        peer = self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=False))\n+        # Add a second wtxid-relay connection otherwise TXID_RELAY_DELAY is waived in\n+        # lack of wtxid-relay peers\n+        self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=True))\n+        peer.send_message(msg_inv([CInv(t=MSG_TX, h=0xff11ff11)]))\n+        peer.sync_with_ping()\n+        with p2p_lock:\n+            assert_equal(peer.tx_getdata_count, 0)\n+        self.nodes[0].setmocktime(mock_time + TXID_RELAY_DELAY)\n+        peer.wait_until(lambda: peer.tx_getdata_count >= 1, timeout=1)\n+        with p2p_lock:\n+            assert_equal(peer.tx_getdata_count, 1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r507519684",
      "id" : 507519684,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzUxOTY4NA==",
      "original_commit_id" : "f0fe840ace0d317dcde48d1f21554f884accbbf9",
      "original_line" : 235,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "test/functional/p2p_tx_download.py",
      "position" : null,
      "pull_request_review_id" : 511466445,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-02T23:37:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/507519684",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r507520694"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/507520694"
         }
      },
      "author_association" : "MEMBER",
      "body" : "perhaps also worth testing?",
      "commit_id" : "bc4a23008762702ffcd6868bcdb8fe2a732640ba",
      "created_at" : "2020-10-19T07:13:16Z",
      "diff_hunk" : "@@ -216,6 +216,24 @@ def test_preferred_inv(self):\n         with p2p_lock:\n             assert_equal(peer.tx_getdata_count, 1)\n \n+    def test_txid_inv_delay(self):\n+        self.log.info('Check that inv from a txid-relay peers are delayed by {} s'.format(TXID_RELAY_DELAY))\n+        self.restart_node(0, extra_args=['-whitelist=noban@127.0.0.1'])\n+        mock_time = int(time.time() + 1)\n+        self.nodes[0].setmocktime(mock_time)\n+        peer = self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=False))\n+        # Add a second wtxid-relay connection otherwise TXID_RELAY_DELAY is waived in",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r507520694",
      "id" : 507520694,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzUyMDY5NA==",
      "original_commit_id" : "f0fe840ace0d317dcde48d1f21554f884accbbf9",
      "original_line" : 225,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "test/functional/p2p_tx_download.py",
      "position" : null,
      "pull_request_review_id" : 511467794,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-02T23:37:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/507520694",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r507522374"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/507522374"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Shouldn't `NONPREF_PEER_TX_DELAY` also be applied here?\r\n\r\nAnyway, I'd first jump in `NONPREF_PEER_TX_DELAY` to see that it's not enough time passed, and then jump `TXID_RELAY_DELAY` again to see that enough time passed? I think that's what is supposed to happen..",
      "commit_id" : "bc4a23008762702ffcd6868bcdb8fe2a732640ba",
      "created_at" : "2020-10-19T07:16:38Z",
      "diff_hunk" : "@@ -216,6 +216,24 @@ def test_preferred_inv(self):\n         with p2p_lock:\n             assert_equal(peer.tx_getdata_count, 1)\n \n+    def test_txid_inv_delay(self):\n+        self.log.info('Check that inv from a txid-relay peers are delayed by {} s'.format(TXID_RELAY_DELAY))\n+        self.restart_node(0, extra_args=['-whitelist=noban@127.0.0.1'])\n+        mock_time = int(time.time() + 1)\n+        self.nodes[0].setmocktime(mock_time)\n+        peer = self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=False))\n+        # Add a second wtxid-relay connection otherwise TXID_RELAY_DELAY is waived in\n+        # lack of wtxid-relay peers\n+        self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=True))\n+        peer.send_message(msg_inv([CInv(t=MSG_TX, h=0xff11ff11)]))\n+        peer.sync_with_ping()\n+        with p2p_lock:\n+            assert_equal(peer.tx_getdata_count, 0)\n+        self.nodes[0].setmocktime(mock_time + TXID_RELAY_DELAY)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r507522374",
      "id" : 507522374,
      "line" : 238,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzUyMjM3NA==",
      "original_commit_id" : "f0fe840ace0d317dcde48d1f21554f884accbbf9",
      "original_line" : 238,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "test/functional/p2p_tx_download.py",
      "position" : 82,
      "pull_request_review_id" : 511470010,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-02T23:37:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/507522374",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-10-19T07:16:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20171#issuecomment-711731413",
      "id" : 711731413,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20171",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxMTczMTQxMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-19T07:16:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/711731413",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r508638848"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/508638848"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "yeh, testnode `wait_until` grabs `p2p_lock` so this is redundant with L233",
      "commit_id" : "bc4a23008762702ffcd6868bcdb8fe2a732640ba",
      "created_at" : "2020-10-20T15:52:27Z",
      "diff_hunk" : "@@ -216,6 +216,24 @@ def test_preferred_inv(self):\n         with p2p_lock:\n             assert_equal(peer.tx_getdata_count, 1)\n \n+    def test_txid_inv_delay(self):\n+        self.log.info('Check that inv from a txid-relay peers are delayed by {} s'.format(TXID_RELAY_DELAY))\n+        self.restart_node(0, extra_args=['-whitelist=noban@127.0.0.1'])\n+        mock_time = int(time.time() + 1)\n+        self.nodes[0].setmocktime(mock_time)\n+        peer = self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=False))\n+        # Add a second wtxid-relay connection otherwise TXID_RELAY_DELAY is waived in\n+        # lack of wtxid-relay peers\n+        self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=True))\n+        peer.send_message(msg_inv([CInv(t=MSG_TX, h=0xff11ff11)]))\n+        peer.sync_with_ping()\n+        with p2p_lock:\n+            assert_equal(peer.tx_getdata_count, 0)\n+        self.nodes[0].setmocktime(mock_time + TXID_RELAY_DELAY)\n+        peer.wait_until(lambda: peer.tx_getdata_count >= 1, timeout=1)\n+        with p2p_lock:\n+            assert_equal(peer.tx_getdata_count, 1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r508638848",
      "id" : 508638848,
      "in_reply_to_id" : 507519684,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODYzODg0OA==",
      "original_commit_id" : "f0fe840ace0d317dcde48d1f21554f884accbbf9",
      "original_line" : 235,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "test/functional/p2p_tx_download.py",
      "position" : null,
      "pull_request_review_id" : 512886863,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-02T23:37:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/508638848",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r508646124"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/508646124"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is this supposed to test that the node waits for the duration of `TXID_RELAY_DELAY`? Seems like it just confirms that the node doesn't send a getdata immediately, then sends it ~`TXID_RELAY_DELAY` later? I had imagined making `TestP2PConn` record the time at which it receives getdatas, then asserting that the time difference from sending the inv is at least `TXID_RELAY_DELAY`... don't think it could use setmocktime though so idk",
      "commit_id" : "bc4a23008762702ffcd6868bcdb8fe2a732640ba",
      "created_at" : "2020-10-20T15:58:55Z",
      "diff_hunk" : "@@ -216,6 +216,24 @@ def test_preferred_inv(self):\n         with p2p_lock:\n             assert_equal(peer.tx_getdata_count, 1)\n \n+    def test_txid_inv_delay(self):\n+        self.log.info('Check that inv from a txid-relay peers are delayed by {} s'.format(TXID_RELAY_DELAY))\n+        self.restart_node(0, extra_args=['-whitelist=noban@127.0.0.1'])\n+        mock_time = int(time.time() + 1)\n+        self.nodes[0].setmocktime(mock_time)\n+        peer = self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=False))\n+        # Add a second wtxid-relay connection otherwise TXID_RELAY_DELAY is waived in\n+        # lack of wtxid-relay peers\n+        self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=True))\n+        peer.send_message(msg_inv([CInv(t=MSG_TX, h=0xff11ff11)]))\n+        peer.sync_with_ping()\n+        with p2p_lock:\n+            assert_equal(peer.tx_getdata_count, 0)\n+        self.nodes[0].setmocktime(mock_time + TXID_RELAY_DELAY)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r508646124",
      "id" : 508646124,
      "line" : 238,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODY0NjEyNA==",
      "original_commit_id" : "f0fe840ace0d317dcde48d1f21554f884accbbf9",
      "original_line" : 238,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_tx_download.py",
      "position" : 82,
      "pull_request_review_id" : 512886863,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-02T23:37:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/508646124",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK f0fe840ace0d317dcde48d1f21554f884accbbf9",
      "created_at" : "2020-10-21T08:54:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20171#issuecomment-713417582",
      "id" : 713417582,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20171",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxMzQxNzU4Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-21T08:54:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/713417582",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r510165294"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/510165294"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Right, in fact it sounds other new functional tests added with #19988 have a redundant p2p lock tacking so added a new commit to remove this oversight. Unless @MarcoFalke they serve something else ?",
      "commit_id" : "bc4a23008762702ffcd6868bcdb8fe2a732640ba",
      "created_at" : "2020-10-22T13:34:03Z",
      "diff_hunk" : "@@ -216,6 +216,24 @@ def test_preferred_inv(self):\n         with p2p_lock:\n             assert_equal(peer.tx_getdata_count, 1)\n \n+    def test_txid_inv_delay(self):\n+        self.log.info('Check that inv from a txid-relay peers are delayed by {} s'.format(TXID_RELAY_DELAY))\n+        self.restart_node(0, extra_args=['-whitelist=noban@127.0.0.1'])\n+        mock_time = int(time.time() + 1)\n+        self.nodes[0].setmocktime(mock_time)\n+        peer = self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=False))\n+        # Add a second wtxid-relay connection otherwise TXID_RELAY_DELAY is waived in\n+        # lack of wtxid-relay peers\n+        self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=True))\n+        peer.send_message(msg_inv([CInv(t=MSG_TX, h=0xff11ff11)]))\n+        peer.sync_with_ping()\n+        with p2p_lock:\n+            assert_equal(peer.tx_getdata_count, 0)\n+        self.nodes[0].setmocktime(mock_time + TXID_RELAY_DELAY)\n+        peer.wait_until(lambda: peer.tx_getdata_count >= 1, timeout=1)\n+        with p2p_lock:\n+            assert_equal(peer.tx_getdata_count, 1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r510165294",
      "id" : 510165294,
      "in_reply_to_id" : 507519684,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDE2NTI5NA==",
      "original_commit_id" : "f0fe840ace0d317dcde48d1f21554f884accbbf9",
      "original_line" : 235,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "test/functional/p2p_tx_download.py",
      "position" : null,
      "pull_request_review_id" : 514730896,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-02T23:37:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/510165294",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r510165388"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/510165388"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Added a test mutation.",
      "commit_id" : "bc4a23008762702ffcd6868bcdb8fe2a732640ba",
      "created_at" : "2020-10-22T13:34:11Z",
      "diff_hunk" : "@@ -216,6 +216,24 @@ def test_preferred_inv(self):\n         with p2p_lock:\n             assert_equal(peer.tx_getdata_count, 1)\n \n+    def test_txid_inv_delay(self):\n+        self.log.info('Check that inv from a txid-relay peers are delayed by {} s'.format(TXID_RELAY_DELAY))\n+        self.restart_node(0, extra_args=['-whitelist=noban@127.0.0.1'])\n+        mock_time = int(time.time() + 1)\n+        self.nodes[0].setmocktime(mock_time)\n+        peer = self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=False))\n+        # Add a second wtxid-relay connection otherwise TXID_RELAY_DELAY is waived in",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r510165388",
      "id" : 510165388,
      "in_reply_to_id" : 507520694,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDE2NTM4OA==",
      "original_commit_id" : "f0fe840ace0d317dcde48d1f21554f884accbbf9",
      "original_line" : 225,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "test/functional/p2p_tx_download.py",
      "position" : null,
      "pull_request_review_id" : 514731026,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-02T23:37:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/510165388",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r510166460"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/510166460"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The positive case was already tested in `test_preferred_inv` but added a mutation to cover the negative one, i.e applying `NONPREF_PEER_TX_DELAY` on non-preferred peers.",
      "commit_id" : "bc4a23008762702ffcd6868bcdb8fe2a732640ba",
      "created_at" : "2020-10-22T13:35:34Z",
      "diff_hunk" : "@@ -216,6 +216,24 @@ def test_preferred_inv(self):\n         with p2p_lock:\n             assert_equal(peer.tx_getdata_count, 1)\n \n+    def test_txid_inv_delay(self):\n+        self.log.info('Check that inv from a txid-relay peers are delayed by {} s'.format(TXID_RELAY_DELAY))\n+        self.restart_node(0, extra_args=['-whitelist=noban@127.0.0.1'])\n+        mock_time = int(time.time() + 1)\n+        self.nodes[0].setmocktime(mock_time)\n+        peer = self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=False))\n+        # Add a second wtxid-relay connection otherwise TXID_RELAY_DELAY is waived in\n+        # lack of wtxid-relay peers\n+        self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=True))\n+        peer.send_message(msg_inv([CInv(t=MSG_TX, h=0xff11ff11)]))\n+        peer.sync_with_ping()\n+        with p2p_lock:\n+            assert_equal(peer.tx_getdata_count, 0)\n+        self.nodes[0].setmocktime(mock_time + TXID_RELAY_DELAY)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r510166460",
      "id" : 510166460,
      "in_reply_to_id" : 507522374,
      "line" : 238,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDE2NjQ2MA==",
      "original_commit_id" : "f0fe840ace0d317dcde48d1f21554f884accbbf9",
      "original_line" : 238,
      "original_position" : 17,
      "original_start_line" : null,
      "path" : "test/functional/p2p_tx_download.py",
      "position" : 82,
      "pull_request_review_id" : 514732405,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-02T23:37:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/510166460",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r510167728"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/510167728"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think you can achieve this with current p2p framework, we can write to the mocktime but can we read it from it ? A quick look, I don't find test doing it so not sure that's a feature of our current test framework. Note that was already the way done by legacy (pre-#19988) tx-download tests. But lmk if there is way to do so I don't see",
      "commit_id" : "bc4a23008762702ffcd6868bcdb8fe2a732640ba",
      "created_at" : "2020-10-22T13:37:16Z",
      "diff_hunk" : "@@ -216,6 +216,24 @@ def test_preferred_inv(self):\n         with p2p_lock:\n             assert_equal(peer.tx_getdata_count, 1)\n \n+    def test_txid_inv_delay(self):\n+        self.log.info('Check that inv from a txid-relay peers are delayed by {} s'.format(TXID_RELAY_DELAY))\n+        self.restart_node(0, extra_args=['-whitelist=noban@127.0.0.1'])\n+        mock_time = int(time.time() + 1)\n+        self.nodes[0].setmocktime(mock_time)\n+        peer = self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=False))\n+        # Add a second wtxid-relay connection otherwise TXID_RELAY_DELAY is waived in\n+        # lack of wtxid-relay peers\n+        self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=True))\n+        peer.send_message(msg_inv([CInv(t=MSG_TX, h=0xff11ff11)]))\n+        peer.sync_with_ping()\n+        with p2p_lock:\n+            assert_equal(peer.tx_getdata_count, 0)\n+        self.nodes[0].setmocktime(mock_time + TXID_RELAY_DELAY)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r510167728",
      "id" : 510167728,
      "in_reply_to_id" : 508646124,
      "line" : 238,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDE2NzcyOA==",
      "original_commit_id" : "f0fe840ace0d317dcde48d1f21554f884accbbf9",
      "original_line" : 238,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_tx_download.py",
      "position" : 82,
      "pull_request_review_id" : 514734200,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-02T23:37:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/510167728",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks @naumenkogs, @glozow for reviews, updated addressing your comments at c55ce67",
      "created_at" : "2020-10-22T13:37:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20171#issuecomment-714499928",
      "id" : 714499928,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20171",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxNDQ5OTkyOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-22T13:37:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/714499928",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r510509388"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/510509388"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oh, of course!",
      "commit_id" : "bc4a23008762702ffcd6868bcdb8fe2a732640ba",
      "created_at" : "2020-10-22T23:17:22Z",
      "diff_hunk" : "@@ -216,6 +216,24 @@ def test_preferred_inv(self):\n         with p2p_lock:\n             assert_equal(peer.tx_getdata_count, 1)\n \n+    def test_txid_inv_delay(self):\n+        self.log.info('Check that inv from a txid-relay peers are delayed by {} s'.format(TXID_RELAY_DELAY))\n+        self.restart_node(0, extra_args=['-whitelist=noban@127.0.0.1'])\n+        mock_time = int(time.time() + 1)\n+        self.nodes[0].setmocktime(mock_time)\n+        peer = self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=False))\n+        # Add a second wtxid-relay connection otherwise TXID_RELAY_DELAY is waived in\n+        # lack of wtxid-relay peers\n+        self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=True))\n+        peer.send_message(msg_inv([CInv(t=MSG_TX, h=0xff11ff11)]))\n+        peer.sync_with_ping()\n+        with p2p_lock:\n+            assert_equal(peer.tx_getdata_count, 0)\n+        self.nodes[0].setmocktime(mock_time + TXID_RELAY_DELAY)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r510509388",
      "id" : 510509388,
      "in_reply_to_id" : 506750652,
      "line" : 238,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUwOTM4OA==",
      "original_commit_id" : "637d7a128e379153d14f7427c9d7a31a35ed1a94",
      "original_line" : 238,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_tx_download.py",
      "position" : 82,
      "pull_request_review_id" : 515182102,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-02T23:37:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/510509388",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r510581011"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/510581011"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> I don't find test doing it so not sure that's a feature of our current test framework\r\n\r\nYeah, I haven't seen an example either. The way I'd do it is just use `sleep()` instead of setmocktime... 2 seconds isn't too bad when the tests are running in parallel, but fosho not ideal.",
      "commit_id" : "bc4a23008762702ffcd6868bcdb8fe2a732640ba",
      "created_at" : "2020-10-23T04:02:30Z",
      "diff_hunk" : "@@ -216,6 +216,24 @@ def test_preferred_inv(self):\n         with p2p_lock:\n             assert_equal(peer.tx_getdata_count, 1)\n \n+    def test_txid_inv_delay(self):\n+        self.log.info('Check that inv from a txid-relay peers are delayed by {} s'.format(TXID_RELAY_DELAY))\n+        self.restart_node(0, extra_args=['-whitelist=noban@127.0.0.1'])\n+        mock_time = int(time.time() + 1)\n+        self.nodes[0].setmocktime(mock_time)\n+        peer = self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=False))\n+        # Add a second wtxid-relay connection otherwise TXID_RELAY_DELAY is waived in\n+        # lack of wtxid-relay peers\n+        self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=True))\n+        peer.send_message(msg_inv([CInv(t=MSG_TX, h=0xff11ff11)]))\n+        peer.sync_with_ping()\n+        with p2p_lock:\n+            assert_equal(peer.tx_getdata_count, 0)\n+        self.nodes[0].setmocktime(mock_time + TXID_RELAY_DELAY)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r510581011",
      "id" : 510581011,
      "in_reply_to_id" : 508646124,
      "line" : 238,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDU4MTAxMQ==",
      "original_commit_id" : "f0fe840ace0d317dcde48d1f21554f884accbbf9",
      "original_line" : 238,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_tx_download.py",
      "position" : 82,
      "pull_request_review_id" : 515260991,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-02T23:37:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/510581011",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #20524 (test: Move MIN_VERSION_SUPPORTED to p2p.py by jnewbery)\n* #20277 (p2p: Stop processing unrequested transactions during IBD and extend p2p_ibd_txrelay.py coverage by ariard)\n* #19315 ([tests] Allow outbound & block-relay-only connections in functional tests. by amitiuttarwar)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-10-28T11:58:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20171#issuecomment-717885891",
      "id" : 717885891,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20171",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxNzg4NTg5MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-12T22:19:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/717885891",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r515666481"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/515666481"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\nNONPREF_PEER_TX_DELAY = 2\r\n```",
      "commit_id" : "bc4a23008762702ffcd6868bcdb8fe2a732640ba",
      "created_at" : "2020-11-01T20:14:17Z",
      "diff_hunk" : "@@ -47,6 +47,7 @@ def on_getdata(self, message):\n OVERLOADED_PEER_DELAY = 2 # seconds\n MAX_GETDATA_IN_FLIGHT = 100\n MAX_PEER_TX_ANNOUNCEMENTS = 5000\n+NONPREF_PEER_TX_DELAY=2",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r515666481",
      "id" : 515666481,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY2NjQ4MQ==",
      "original_commit_id" : "c55ce67f2c526043d194cd2edd791ad88b697558",
      "original_line" : 50,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "test/functional/p2p_tx_download.py",
      "position" : null,
      "pull_request_review_id" : 521256907,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-02T23:37:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/515666481",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r515666639"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/515666639"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Tabs 4 spaces instead of 8, but you could also simplify here with\r\n```diff\r\n-            if glob_wtxid:\r\n-                    assert_equal(peer.tx_getdata_count, 0)\r\n-            else:\r\n-                    assert_equal(peer.tx_getdata_count, 1)\r\n+            assert_equal(peer.tx_getdata_count, 0 if glob_wtxid else 1)\r\n```\r\n",
      "commit_id" : "bc4a23008762702ffcd6868bcdb8fe2a732640ba",
      "created_at" : "2020-11-01T20:15:30Z",
      "diff_hunk" : "@@ -204,17 +201,45 @@ def test_notfound_fallback(self):\n             assert_equal(peer_fallback.tx_getdata_count, 0)\n         peer_notfound.send_and_ping(msg_notfound(vec=[CInv(MSG_WTX, WTXID)]))  # Send notfound, so that fallback peer is selected\n         peer_fallback.wait_until(lambda: peer_fallback.tx_getdata_count >= 1, timeout=1)\n-        with p2p_lock:\n-            assert_equal(peer_fallback.tx_getdata_count, 1)\n \n-    def test_preferred_inv(self):\n-        self.log.info('Check that invs from preferred peers are downloaded immediately')\n-        self.restart_node(0, extra_args=['-whitelist=noban@127.0.0.1'])\n+    def test_preferred_inv(self, preferred=False):\n+        if preferred:\n+            self.log.info('Check invs from preferred peers are downloaded immediately')\n+            self.restart_node(0, extra_args=['-whitelist=noban@127.0.0.1'])\n+        else:\n+            self.log.info('Check invs from non-preferred peers are downloaded after {} s'.format(NONPREF_PEER_TX_DELAY))\n+        mock_time = int(time.time() + 1)\n+        self.nodes[0].setmocktime(mock_time)\n         peer = self.nodes[0].add_p2p_connection(TestP2PConn())\n         peer.send_message(msg_inv([CInv(t=MSG_WTX, h=0xff00ff00)]))\n-        peer.wait_until(lambda: peer.tx_getdata_count >= 1, timeout=1)\n+        peer.sync_with_ping()\n+        if preferred:\n+            peer.wait_until(lambda: peer.tx_getdata_count >= 1, timeout=1)\n+        else:\n+            with p2p_lock:\n+                assert_equal(peer.tx_getdata_count, 0)\n+            self.nodes[0].setmocktime(mock_time + NONPREF_PEER_TX_DELAY)\n+            peer.wait_until(lambda: peer.tx_getdata_count >= 1, timeout=1)\n+\n+    def test_txid_inv_delay(self, glob_wtxid=False):\n+        self.log.info('Check that inv from a txid-relay peers are delayed by {} s, with a wtxid peer {}'.format(TXID_RELAY_DELAY, glob_wtxid))\n+        self.restart_node(0, extra_args=['-whitelist=noban@127.0.0.1'])\n+        mock_time = int(time.time() + 1)\n+        self.nodes[0].setmocktime(mock_time)\n+        peer = self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=False))\n+        if glob_wtxid:\n+            # Add a second wtxid-relay connection otherwise TXID_RELAY_DELAY is waived in\n+            # lack of wtxid-relay peers\n+            self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=True))\n+        peer.send_message(msg_inv([CInv(t=MSG_TX, h=0xff11ff11)]))\n+        peer.sync_with_ping()\n         with p2p_lock:\n-            assert_equal(peer.tx_getdata_count, 1)\n+            if glob_wtxid:\n+                    assert_equal(peer.tx_getdata_count, 0)\n+            else:\n+                    assert_equal(peer.tx_getdata_count, 1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r515666639",
      "id" : 515666639,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY2NjYzOQ==",
      "original_commit_id" : "c55ce67f2c526043d194cd2edd791ad88b697558",
      "original_line" : 240,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "test/functional/p2p_tx_download.py",
      "position" : null,
      "pull_request_review_id" : 521256907,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-02T23:37:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/515666639",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r515666688"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/515666688"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        if message.nVersion >= 70016 and self.wtxidrelay:\r\n```",
      "commit_id" : "bc4a23008762702ffcd6868bcdb8fe2a732640ba",
      "created_at" : "2020-11-01T20:16:11Z",
      "diff_hunk" : "@@ -394,7 +397,7 @@ def on_verack(self, message):\n \n     def on_version(self, message):\n         assert message.nVersion >= MIN_VERSION_SUPPORTED, \"Version {} received. Test framework only supports versions greater than {}\".format(message.nVersion, MIN_VERSION_SUPPORTED)\n-        if message.nVersion >= 70016:\n+        if message.nVersion >= 70016 and self.wtxidrelay :",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r515666688",
      "id" : 515666688,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY2NjY4OA==",
      "original_commit_id" : "c55ce67f2c526043d194cd2edd791ad88b697558",
      "original_line" : 400,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/p2p.py",
      "position" : null,
      "pull_request_review_id" : 521256907,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-02T23:37:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/515666688",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r515669749"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/515669749"
         }
      },
      "author_association" : "NONE",
      "body" : "Gut",
      "commit_id" : "c55ce67f2c526043d194cd2edd791ad88b697558",
      "created_at" : "2020-11-01T20:44:45Z",
      "diff_hunk" : "@@ -394,7 +397,7 @@ def on_verack(self, message):\n \n     def on_version(self, message):\n         assert message.nVersion >= MIN_VERSION_SUPPORTED, \"Version {} received. Test framework only supports versions greater than {}\".format(message.nVersion, MIN_VERSION_SUPPORTED)\n-        if message.nVersion >= 70016:\n+        if message.nVersion >= 70016 and self.wtxidrelay :",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r515669749",
      "id" : 515669749,
      "in_reply_to_id" : 515666688,
      "line" : 400,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTY2OTc0OQ==",
      "original_commit_id" : "c55ce67f2c526043d194cd2edd791ad88b697558",
      "original_line" : 400,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/p2p.py",
      "position" : 24,
      "pull_request_review_id" : 521259423,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-01T20:44:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/515669749",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/73768599?v=4",
         "events_url" : "https://api.github.com/users/BARMOLEY007/events{/privacy}",
         "followers_url" : "https://api.github.com/users/BARMOLEY007/followers",
         "following_url" : "https://api.github.com/users/BARMOLEY007/following{/other_user}",
         "gists_url" : "https://api.github.com/users/BARMOLEY007/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/BARMOLEY007",
         "id" : 73768599,
         "login" : "BARMOLEY007",
         "node_id" : "MDQ6VXNlcjczNzY4NTk5",
         "organizations_url" : "https://api.github.com/users/BARMOLEY007/orgs",
         "received_events_url" : "https://api.github.com/users/BARMOLEY007/received_events",
         "repos_url" : "https://api.github.com/users/BARMOLEY007/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/BARMOLEY007/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/BARMOLEY007/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/BARMOLEY007"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r516332767"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/516332767"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Taking it. Less is better.",
      "commit_id" : "bc4a23008762702ffcd6868bcdb8fe2a732640ba",
      "created_at" : "2020-11-02T23:34:13Z",
      "diff_hunk" : "@@ -204,17 +201,45 @@ def test_notfound_fallback(self):\n             assert_equal(peer_fallback.tx_getdata_count, 0)\n         peer_notfound.send_and_ping(msg_notfound(vec=[CInv(MSG_WTX, WTXID)]))  # Send notfound, so that fallback peer is selected\n         peer_fallback.wait_until(lambda: peer_fallback.tx_getdata_count >= 1, timeout=1)\n-        with p2p_lock:\n-            assert_equal(peer_fallback.tx_getdata_count, 1)\n \n-    def test_preferred_inv(self):\n-        self.log.info('Check that invs from preferred peers are downloaded immediately')\n-        self.restart_node(0, extra_args=['-whitelist=noban@127.0.0.1'])\n+    def test_preferred_inv(self, preferred=False):\n+        if preferred:\n+            self.log.info('Check invs from preferred peers are downloaded immediately')\n+            self.restart_node(0, extra_args=['-whitelist=noban@127.0.0.1'])\n+        else:\n+            self.log.info('Check invs from non-preferred peers are downloaded after {} s'.format(NONPREF_PEER_TX_DELAY))\n+        mock_time = int(time.time() + 1)\n+        self.nodes[0].setmocktime(mock_time)\n         peer = self.nodes[0].add_p2p_connection(TestP2PConn())\n         peer.send_message(msg_inv([CInv(t=MSG_WTX, h=0xff00ff00)]))\n-        peer.wait_until(lambda: peer.tx_getdata_count >= 1, timeout=1)\n+        peer.sync_with_ping()\n+        if preferred:\n+            peer.wait_until(lambda: peer.tx_getdata_count >= 1, timeout=1)\n+        else:\n+            with p2p_lock:\n+                assert_equal(peer.tx_getdata_count, 0)\n+            self.nodes[0].setmocktime(mock_time + NONPREF_PEER_TX_DELAY)\n+            peer.wait_until(lambda: peer.tx_getdata_count >= 1, timeout=1)\n+\n+    def test_txid_inv_delay(self, glob_wtxid=False):\n+        self.log.info('Check that inv from a txid-relay peers are delayed by {} s, with a wtxid peer {}'.format(TXID_RELAY_DELAY, glob_wtxid))\n+        self.restart_node(0, extra_args=['-whitelist=noban@127.0.0.1'])\n+        mock_time = int(time.time() + 1)\n+        self.nodes[0].setmocktime(mock_time)\n+        peer = self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=False))\n+        if glob_wtxid:\n+            # Add a second wtxid-relay connection otherwise TXID_RELAY_DELAY is waived in\n+            # lack of wtxid-relay peers\n+            self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=True))\n+        peer.send_message(msg_inv([CInv(t=MSG_TX, h=0xff11ff11)]))\n+        peer.sync_with_ping()\n         with p2p_lock:\n-            assert_equal(peer.tx_getdata_count, 1)\n+            if glob_wtxid:\n+                    assert_equal(peer.tx_getdata_count, 0)\n+            else:\n+                    assert_equal(peer.tx_getdata_count, 1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20171#discussion_r516332767",
      "id" : 516332767,
      "in_reply_to_id" : 515666639,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjMzMjc2Nw==",
      "original_commit_id" : "c55ce67f2c526043d194cd2edd791ad88b697558",
      "original_line" : 240,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "test/functional/p2p_tx_download.py",
      "position" : null,
      "pull_request_review_id" : 522106130,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20171",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-11-02T23:37:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/516332767",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks @jonatack. I think I took everything at bc4a230",
      "created_at" : "2020-11-02T23:39:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20171#issuecomment-720787559",
      "id" : 720787559,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20171",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcyMDc4NzU1OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-02T23:39:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/720787559",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@naumenkogs @jonatack @glozow @MarcoFalke if you have few minutes to review again this PR, it hasn't changed and I think all previous considerations have been addressed.",
      "created_at" : "2020-12-10T16:25:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20171#issuecomment-742628449",
      "id" : 742628449,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20171",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0MjYyODQ0OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-10T16:25:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/742628449",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK bc4a23008762702ffcd6868bcdb8fe2a732640ba\r\nThanks for adding a test for this.",
      "created_at" : "2020-12-16T17:27:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20171#issuecomment-746681603",
      "id" : 746681603,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20171",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc0NjY4MTYwMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-12-16T17:27:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/746681603",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   }
]
