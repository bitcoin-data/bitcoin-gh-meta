[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [sdaftuar](https://github.com/bitcoin/bitcoin/pull/27626#issuecomment-1553177921), [dergoegge](https://github.com/bitcoin/bitcoin/pull/27626#pullrequestreview-1433928913) |\n| Concept ACK | [mzumsande](https://github.com/bitcoin/bitcoin/pull/27626#pullrequestreview-1435468460) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#27052](https://github.com/bitcoin/bitcoin/pull/27052) (test: rpc: add last block announcement time to getpeerinfo result by LarryRuane)\n* [#26969](https://github.com/bitcoin/bitcoin/pull/26969) (net, refactor: net_processing, add `ProcessCompactBlockTxns` by brunoerg)\n* [#26812](https://github.com/bitcoin/bitcoin/pull/26812) (test: add end-to-end tests for CConnman and PeerManager by vasild)\n* [#26621](https://github.com/bitcoin/bitcoin/pull/26621) (refactor: Continue moving application data from CNode to Peer by dergoegge)\n* [#24008](https://github.com/bitcoin/bitcoin/pull/24008) (assumeutxo: net_processing changes by jamesob)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-05-11T14:05:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#issuecomment-1544049487",
      "id" : 1544049487,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27626",
      "node_id" : "IC_kwDOABII585cCFNP",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544049487/reactions"
      },
      "updated_at" : "2023-05-21T21:21:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544049487",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191251631"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191251631"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Would this be better as a `map<uint256, map<NodeId, list<>::iterator>>` ? Seems like it'd make some of the `FIXME`s easier.",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T14:24:31Z",
      "diff_hunk" : "@@ -901,7 +901,7 @@ class PeerManagerImpl final : public PeerManager\n      */\n     void FindNextBlocksToDownload(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, NodeId& nodeStaller) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n-    typedef std::map<uint256, std::pair<NodeId, std::list<QueuedBlock>::iterator>> BlockDownloadMap;\n+    typedef std::multimap<uint256, std::pair<NodeId, std::list<QueuedBlock>::iterator>> BlockDownloadMap;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191251631",
      "id" : 1191251631,
      "line" : 904,
      "node_id" : "PRRC_kwDOABII585HAQ6v",
      "original_commit_id" : "e85fa404627430094c1e25f96af156b0de9d3605",
      "original_line" : 904,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 13,
      "pull_request_review_id" : 1422727983,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 1,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191251631/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T15:47:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191251631",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191307770"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191307770"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this case is (mostly) for when a non-high-bandwidth peer tells us about a block, we request it via a compact block, and then we get a different block from some other peer, UpdateTip to that, and only afterwards see the CMPCTBLOCK response from the original peer. But now that response is probably useless, so replace it with a GETDATA.\r\n\r\nI wonder if that might be better expressed as: `if (in_flight_same_peer && pindex->pprev != ActiveChain().Tip())` ?",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T14:55:20Z",
      "diff_hunk" : "@@ -4300,7 +4300,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n \n         if (pindex->nChainWork <= m_chainman.ActiveChain().Tip()->nChainWork || // We know something better\n                 pindex->nTx != 0) { // We had this block at some point, but pruned it\n-            if (fAlreadyInFlight) {\n+            if (in_flight_same_peer) {\n                 // We requested this block for some reason, but our mempool will probably be useless\n                 // so we just grab the block via normal getdata",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191307770",
      "id" : 1191307770,
      "line" : 4306,
      "node_id" : "PRRC_kwDOABII585HAen6",
      "original_commit_id" : "e7911fd8901bc2093e1194dc62e11123592f14f5",
      "original_line" : 4306,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 185,
      "pull_request_review_id" : 1422727983,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191307770/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T15:47:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191307770",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191313364"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191313364"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Might be better to name this `requested_block_from_this_peer` ? (I think for new code we prefer `bool x{false};` so we get errors if we're accidently narrowing values?)",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T14:58:03Z",
      "diff_hunk" : "@@ -4275,12 +4283,21 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             nodestate->m_last_block_announcement = GetTime();\n         }\n \n-        BlockDownloadMap::iterator blockInFlightIt = mapBlocksInFlight.find(pindex->GetBlockHash());\n-        bool fAlreadyInFlight = blockInFlightIt != mapBlocksInFlight.end();\n-\n         if (pindex->nStatus & BLOCK_HAVE_DATA) // Nothing to do here\n             return;\n \n+        auto range_flight = mapBlocksInFlight.equal_range(pindex->GetBlockHash());\n+        bool fAlreadyInFlight = range_flight.first != range_flight.second;\n+        bool in_flight_same_peer = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191313364",
      "id" : 1191313364,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HAf_U",
      "original_commit_id" : "e85fa404627430094c1e25f96af156b0de9d3605",
      "original_line" : 4291,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1422727983,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191313364/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T15:47:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191313364",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191320979"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191320979"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`already_in_flight == 0 || (already_in_flight == 1 && in_flight_same_peer)` ?",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T15:03:31Z",
      "diff_hunk" : "@@ -4297,6 +4297,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             }\n             range_flight.first++;\n         }\n+        bool first_in_flight = !already_in_flight || in_flight_same_peer;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191320979",
      "id" : 1191320979,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HAh2T",
      "original_commit_id" : "1cde8b4862182571cde493cbceb612f321c6c3ef",
      "original_line" : 4300,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1422727983,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191320979/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T15:47:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191320979",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191323390"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191323390"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "(Test the bool first?)",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T15:05:16Z",
      "diff_hunk" : "@@ -4357,8 +4363,15 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                     blockTxnMsg << txn;\n                     fProcessBLOCKTXN = true;\n                 } else {\n-                    req.blockhash = pindex->GetBlockHash();\n-                    m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::GETBLOCKTXN, req));\n+                    // We will try to round-trip any compact blocks we get on failure,\n+                    // as long as it's first, or not too large\n+                    if (req.indexes.size() <= MAX_GETBLOCKTXN_TXN_AFTER_FIRST_IN_FLIGHT || first_in_flight) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191323390",
      "id" : 1191323390,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HAib-",
      "original_commit_id" : "1cde8b4862182571cde493cbceb612f321c6c3ef",
      "original_line" : 4368,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1422727983,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191323390/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T15:47:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191323390",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191357478"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191357478"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Out of the last 612 compact blocks my node's reconstructed that required requesting transactions, 277 needed 10 or fewer (45%), 441 needed 50 or fewer (72%), 488 needed 100 or fewer (80%), 548 needed 500 or fewer (90%). I'd probably prefer 50 or 100 than 10, I guess?\r\n\r\n(In simpler times, 1086/1162 (93%) need 10 or fewer, 1140/1162 (98%) needed 50 or fewer, 1144/1162 (98.5%) needed 100 or fewer. Again, I'm not including blocks that requested 0 txs in those denominators)",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T15:30:25Z",
      "diff_hunk" : "@@ -22,6 +22,11 @@ static const bool DEFAULT_PEERBLOOMFILTERS = false;\n static const bool DEFAULT_PEERBLOCKFILTERS = false;\n /** Threshold for marking a node to be discouraged, e.g. disconnected and added to the discouragement filter. */\n static const int DISCOURAGEMENT_THRESHOLD{100};\n+/** Maximum number of outstanding CMPCTBLOCK requests for the same block. */\n+/** Greg: Setting to 3 to match number of high bandwidth peers... ~ensures one is outbound */\n+static const unsigned int MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK = 3;\n+/** Maximum number of missing transactions for a non-first getblocktxn request */\n+static const unsigned int MAX_GETBLOCKTXN_TXN_AFTER_FIRST_IN_FLIGHT = 10;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191357478",
      "id" : 1191357478,
      "line" : 29,
      "node_id" : "PRRC_kwDOABII585HAqwm",
      "original_commit_id" : "1cde8b4862182571cde493cbceb612f321c6c3ef",
      "original_line" : 29,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 8,
      "pull_request_review_id" : 1422727983,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191357478/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T15:47:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191357478",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191369251"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191369251"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This logic is different to the previous `first_in_flight`; probably should be the same?",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T15:39:18Z",
      "diff_hunk" : "@@ -4452,13 +4465,15 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             LOCK(cs_main);\n \n             bool expected_blocktxn = false;\n+            bool first_in_flight = true;\n             auto range_flight = mapBlocksInFlight.equal_range(resp.blockhash);\n             while (range_flight.first != range_flight.second) {\n                 auto [node_id, block_it] = range_flight.first->second;\n                 if (node_id == pfrom.GetId() && block_it->partialBlock) {\n                     expected_blocktxn = true;\n                     break;\n                 }\n+                first_in_flight = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191369251",
      "id" : 1191369251,
      "line" : 4478,
      "node_id" : "PRRC_kwDOABII585HAtoj",
      "original_commit_id" : "1cde8b4862182571cde493cbceb612f321c6c3ef",
      "original_line" : 4478,
      "original_position" : 100,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 273,
      "pull_request_review_id" : 1422727983,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191369251/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T15:47:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191369251",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191418745"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191418745"
         }
      },
      "author_association" : "MEMBER",
      "body" : "sounds right, I'll sit on this for a bit",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T16:17:34Z",
      "diff_hunk" : "@@ -4300,7 +4300,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n \n         if (pindex->nChainWork <= m_chainman.ActiveChain().Tip()->nChainWork || // We know something better\n                 pindex->nTx != 0) { // We had this block at some point, but pruned it\n-            if (fAlreadyInFlight) {\n+            if (in_flight_same_peer) {\n                 // We requested this block for some reason, but our mempool will probably be useless\n                 // so we just grab the block via normal getdata",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191418745",
      "id" : 1191418745,
      "in_reply_to_id" : 1191307770,
      "line" : 4306,
      "node_id" : "PRRC_kwDOABII585HA5t5",
      "original_commit_id" : "e7911fd8901bc2093e1194dc62e11123592f14f5",
      "original_line" : 4306,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 185,
      "pull_request_review_id" : 1422991579,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191418745/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T16:17:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191418745",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191426977"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191426977"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could use `pfrom.m_bip152_highbandwidth_to`?",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T16:24:43Z",
      "diff_hunk" : "@@ -4364,8 +4364,11 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                     fProcessBLOCKTXN = true;\n                 } else {\n                     // We will try to round-trip any compact blocks we get on failure,\n-                    // as long as it's first, or not too large\n-                    if (req.indexes.size() <= MAX_GETBLOCKTXN_TXN_AFTER_FIRST_IN_FLIGHT || first_in_flight) {\n+                    // as long as it's first, or not too large, and as long as we chose\n+                    // the peer for high-bandwidth relay.\n+                    auto hb_peer = std::find(lNodesAnnouncingHeaderAndIDs.begin(), lNodesAnnouncingHeaderAndIDs.end(), pfrom.GetId());\n+                    if ((hb_peer != lNodesAnnouncingHeaderAndIDs.end() && req.indexes.size() <= MAX_GETBLOCKTXN_TXN_AFTER_FIRST_IN_FLIGHT) ||",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191426977",
      "id" : 1191426977,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HA7uh",
      "original_commit_id" : "df1218b447aabfc54f86406d4813057df1ddf216",
      "original_line" : 4370,
      "original_position" : 9,
      "original_start_line" : 4369,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1423003852,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 1,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191426977/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-05-11T16:24:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191426977",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191435827"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191435827"
         }
      },
      "author_association" : "MEMBER",
      "body" : "what if we just removed the limit, since it's not much of a protection, especially if the missing 10 txns are *nscriptions",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T16:32:57Z",
      "diff_hunk" : "@@ -22,6 +22,11 @@ static const bool DEFAULT_PEERBLOOMFILTERS = false;\n static const bool DEFAULT_PEERBLOCKFILTERS = false;\n /** Threshold for marking a node to be discouraged, e.g. disconnected and added to the discouragement filter. */\n static const int DISCOURAGEMENT_THRESHOLD{100};\n+/** Maximum number of outstanding CMPCTBLOCK requests for the same block. */\n+/** Greg: Setting to 3 to match number of high bandwidth peers... ~ensures one is outbound */\n+static const unsigned int MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK = 3;\n+/** Maximum number of missing transactions for a non-first getblocktxn request */\n+static const unsigned int MAX_GETBLOCKTXN_TXN_AFTER_FIRST_IN_FLIGHT = 10;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191435827",
      "id" : 1191435827,
      "in_reply_to_id" : 1191357478,
      "line" : 29,
      "node_id" : "PRRC_kwDOABII585HA94z",
      "original_commit_id" : "1cde8b4862182571cde493cbceb612f321c6c3ef",
      "original_line" : 29,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 8,
      "pull_request_review_id" : 1423017870,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191435827/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T16:32:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191435827",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191441529"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191441529"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Probably better to defer it as an unrelated change anyway?",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T16:38:28Z",
      "diff_hunk" : "@@ -4300,7 +4300,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n \n         if (pindex->nChainWork <= m_chainman.ActiveChain().Tip()->nChainWork || // We know something better\n                 pindex->nTx != 0) { // We had this block at some point, but pruned it\n-            if (fAlreadyInFlight) {\n+            if (in_flight_same_peer) {\n                 // We requested this block for some reason, but our mempool will probably be useless\n                 // so we just grab the block via normal getdata",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191441529",
      "id" : 1191441529,
      "in_reply_to_id" : 1191307770,
      "line" : 4306,
      "node_id" : "PRRC_kwDOABII585HA_R5",
      "original_commit_id" : "e7911fd8901bc2093e1194dc62e11123592f14f5",
      "original_line" : 4306,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 185,
      "pull_request_review_id" : 1423026354,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191441529/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T16:38:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191441529",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191449571"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191449571"
         }
      },
      "author_association" : "MEMBER",
      "body" : "don't love your name suggestion; changed the initialization though",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T16:46:14Z",
      "diff_hunk" : "@@ -4275,12 +4283,21 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             nodestate->m_last_block_announcement = GetTime();\n         }\n \n-        BlockDownloadMap::iterator blockInFlightIt = mapBlocksInFlight.find(pindex->GetBlockHash());\n-        bool fAlreadyInFlight = blockInFlightIt != mapBlocksInFlight.end();\n-\n         if (pindex->nStatus & BLOCK_HAVE_DATA) // Nothing to do here\n             return;\n \n+        auto range_flight = mapBlocksInFlight.equal_range(pindex->GetBlockHash());\n+        bool fAlreadyInFlight = range_flight.first != range_flight.second;\n+        bool in_flight_same_peer = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191449571",
      "id" : 1191449571,
      "in_reply_to_id" : 1191313364,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HBBPj",
      "original_commit_id" : "e85fa404627430094c1e25f96af156b0de9d3605",
      "original_line" : 4291,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1423038359,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191449571/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T16:46:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191449571",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191449589"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191449589"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think the limit's fine; when you start up with an empty mempool, you'll be requesting most of the transactions in the block because your mempool's empty, and there's no need to do that three times in parallel. Could perhaps have the limit work the other way: if you've already got N txs and need K txs, and `0 < K <= N/4 + 10`; then if the block just has ten 100kvB txs, you won't request them multiple times.",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T16:46:16Z",
      "diff_hunk" : "@@ -22,6 +22,11 @@ static const bool DEFAULT_PEERBLOOMFILTERS = false;\n static const bool DEFAULT_PEERBLOCKFILTERS = false;\n /** Threshold for marking a node to be discouraged, e.g. disconnected and added to the discouragement filter. */\n static const int DISCOURAGEMENT_THRESHOLD{100};\n+/** Maximum number of outstanding CMPCTBLOCK requests for the same block. */\n+/** Greg: Setting to 3 to match number of high bandwidth peers... ~ensures one is outbound */\n+static const unsigned int MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK = 3;\n+/** Maximum number of missing transactions for a non-first getblocktxn request */\n+static const unsigned int MAX_GETBLOCKTXN_TXN_AFTER_FIRST_IN_FLIGHT = 10;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191449589",
      "id" : 1191449589,
      "in_reply_to_id" : 1191357478,
      "line" : 29,
      "node_id" : "PRRC_kwDOABII585HBBP1",
      "original_commit_id" : "1cde8b4862182571cde493cbceb612f321c6c3ef",
      "original_line" : 29,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 8,
      "pull_request_review_id" : 1423038391,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 1,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191449589/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T16:46:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191449589",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191458103"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191458103"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T16:54:47Z",
      "diff_hunk" : "@@ -4364,8 +4364,11 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                     fProcessBLOCKTXN = true;\n                 } else {\n                     // We will try to round-trip any compact blocks we get on failure,\n-                    // as long as it's first, or not too large\n-                    if (req.indexes.size() <= MAX_GETBLOCKTXN_TXN_AFTER_FIRST_IN_FLIGHT || first_in_flight) {\n+                    // as long as it's first, or not too large, and as long as we chose\n+                    // the peer for high-bandwidth relay.\n+                    auto hb_peer = std::find(lNodesAnnouncingHeaderAndIDs.begin(), lNodesAnnouncingHeaderAndIDs.end(), pfrom.GetId());\n+                    if ((hb_peer != lNodesAnnouncingHeaderAndIDs.end() && req.indexes.size() <= MAX_GETBLOCKTXN_TXN_AFTER_FIRST_IN_FLIGHT) ||",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191458103",
      "id" : 1191458103,
      "in_reply_to_id" : 1191426977,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HBDU3",
      "original_commit_id" : "df1218b447aabfc54f86406d4813057df1ddf216",
      "original_line" : 4370,
      "original_position" : 9,
      "original_start_line" : 4369,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1423054145,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191458103/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-05-11T16:54:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191458103",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191480873"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191480873"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Let me rephrase. What I meant was that `in_flight_same_peer` confused me: \"we just received the block from this peer, of course it was in flight, how else would it get to us?\". But what the bool is actually telling us is that we had deliberately asked this peer for this block, it wasn't just spontaneously sent to us.",
      "commit_id" : "1dc948eb32933572dc32a3e2de4cd67d16043d95",
      "created_at" : "2023-05-11T17:16:56Z",
      "diff_hunk" : "@@ -4275,12 +4283,21 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             nodestate->m_last_block_announcement = GetTime();\n         }\n \n-        BlockDownloadMap::iterator blockInFlightIt = mapBlocksInFlight.find(pindex->GetBlockHash());\n-        bool fAlreadyInFlight = blockInFlightIt != mapBlocksInFlight.end();\n-\n         if (pindex->nStatus & BLOCK_HAVE_DATA) // Nothing to do here\n             return;\n \n+        auto range_flight = mapBlocksInFlight.equal_range(pindex->GetBlockHash());\n+        bool fAlreadyInFlight = range_flight.first != range_flight.second;\n+        bool in_flight_same_peer = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191480873",
      "id" : 1191480873,
      "in_reply_to_id" : 1191313364,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HBI4p",
      "original_commit_id" : "e85fa404627430094c1e25f96af156b0de9d3605",
      "original_line" : 4291,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1423093314,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191480873/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T17:16:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191480873",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191523726"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191523726"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Imo, it doesn't seem worthwhile to have the limit:\r\n* the good case (small K) should be far more common than the bad one (large K)\r\n* the limit makes relay of blocks with large K less reliable w.r.t to stalling (reduces to what we have now)\r\n* the limit adds code complexity and a maintenance burden. 10 is not a good value according to your data and if #10984 had been merged then we would need to re-evaluate now. Who's to say this won't change again.",
      "commit_id" : "ceded96265fbf3528dbb2a845d599ecbbae1bdb7",
      "created_at" : "2023-05-11T18:01:25Z",
      "diff_hunk" : "@@ -22,6 +22,11 @@ static const bool DEFAULT_PEERBLOOMFILTERS = false;\n static const bool DEFAULT_PEERBLOCKFILTERS = false;\n /** Threshold for marking a node to be discouraged, e.g. disconnected and added to the discouragement filter. */\n static const int DISCOURAGEMENT_THRESHOLD{100};\n+/** Maximum number of outstanding CMPCTBLOCK requests for the same block. */\n+/** Greg: Setting to 3 to match number of high bandwidth peers... ~ensures one is outbound */\n+static const unsigned int MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK = 3;\n+/** Maximum number of missing transactions for a non-first getblocktxn request */\n+static const unsigned int MAX_GETBLOCKTXN_TXN_AFTER_FIRST_IN_FLIGHT = 10;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191523726",
      "id" : 1191523726,
      "in_reply_to_id" : 1191357478,
      "line" : 28,
      "node_id" : "PRRC_kwDOABII585HBTWO",
      "original_commit_id" : "1cde8b4862182571cde493cbceb612f321c6c3ef",
      "original_line" : 28,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 7,
      "pull_request_review_id" : 1423160189,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191523726/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T18:01:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191523726",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191541721"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191541721"
         }
      },
      "author_association" : "MEMBER",
      "body" : "after attempting the change, I think that would violate https://github.com/bitcoin/bitcoin/pull/27626/commits/e424dcba60e61f014b19a3e2f59238ca3b91f3db#diff-6875de769e90cec84d2e8a9c1b962cdbcda44d870d42e4215827e599e11e90e3R1394 which requires insertion ordering to know which is the stalling peer.\r\n\r\ntotally forgot about the FIXME...",
      "commit_id" : "ceded96265fbf3528dbb2a845d599ecbbae1bdb7",
      "created_at" : "2023-05-11T18:21:34Z",
      "diff_hunk" : "@@ -901,7 +901,7 @@ class PeerManagerImpl final : public PeerManager\n      */\n     void FindNextBlocksToDownload(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, NodeId& nodeStaller) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n-    typedef std::map<uint256, std::pair<NodeId, std::list<QueuedBlock>::iterator>> BlockDownloadMap;\n+    typedef std::multimap<uint256, std::pair<NodeId, std::list<QueuedBlock>::iterator>> BlockDownloadMap;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191541721",
      "id" : 1191541721,
      "in_reply_to_id" : 1191251631,
      "line" : 905,
      "node_id" : "PRRC_kwDOABII585HBXvZ",
      "original_commit_id" : "e85fa404627430094c1e25f96af156b0de9d3605",
      "original_line" : 905,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 14,
      "pull_request_review_id" : 1423187928,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191541721/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T18:21:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191541721",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191560489"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191560489"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ok, I can see that and how it reads cleaner, changed",
      "commit_id" : "ceded96265fbf3528dbb2a845d599ecbbae1bdb7",
      "created_at" : "2023-05-11T18:42:17Z",
      "diff_hunk" : "@@ -4275,12 +4283,21 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             nodestate->m_last_block_announcement = GetTime();\n         }\n \n-        BlockDownloadMap::iterator blockInFlightIt = mapBlocksInFlight.find(pindex->GetBlockHash());\n-        bool fAlreadyInFlight = blockInFlightIt != mapBlocksInFlight.end();\n-\n         if (pindex->nStatus & BLOCK_HAVE_DATA) // Nothing to do here\n             return;\n \n+        auto range_flight = mapBlocksInFlight.equal_range(pindex->GetBlockHash());\n+        bool fAlreadyInFlight = range_flight.first != range_flight.second;\n+        bool in_flight_same_peer = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191560489",
      "id" : 1191560489,
      "in_reply_to_id" : 1191313364,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HBcUp",
      "original_commit_id" : "e85fa404627430094c1e25f96af156b0de9d3605",
      "original_line" : 4291,
      "original_position" : 127,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1423217956,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191560489/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T18:42:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191560489",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191569820"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191569820"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done, cleaner thank you",
      "commit_id" : "ceded96265fbf3528dbb2a845d599ecbbae1bdb7",
      "created_at" : "2023-05-11T18:51:29Z",
      "diff_hunk" : "@@ -4452,13 +4465,15 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             LOCK(cs_main);\n \n             bool expected_blocktxn = false;\n+            bool first_in_flight = true;\n             auto range_flight = mapBlocksInFlight.equal_range(resp.blockhash);\n             while (range_flight.first != range_flight.second) {\n                 auto [node_id, block_it] = range_flight.first->second;\n                 if (node_id == pfrom.GetId() && block_it->partialBlock) {\n                     expected_blocktxn = true;\n                     break;\n                 }\n+                first_in_flight = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191569820",
      "id" : 1191569820,
      "in_reply_to_id" : 1191369251,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HBemc",
      "original_commit_id" : "1cde8b4862182571cde493cbceb612f321c6c3ef",
      "original_line" : 4487,
      "original_position" : 100,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1423234162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191569820/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T18:51:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191569820",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191650786"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191650786"
         }
      },
      "author_association" : "MEMBER",
      "body" : "if the issue is during warmup, that's a pretty small window, and typically won't actually do parallel fetching, 3 seems rare even when warmed up with limit of 10. I'll gather some more stats on that front, seeing how many parallel blocks are initialized.",
      "commit_id" : "ceded96265fbf3528dbb2a845d599ecbbae1bdb7",
      "created_at" : "2023-05-11T20:19:33Z",
      "diff_hunk" : "@@ -22,6 +22,11 @@ static const bool DEFAULT_PEERBLOOMFILTERS = false;\n static const bool DEFAULT_PEERBLOCKFILTERS = false;\n /** Threshold for marking a node to be discouraged, e.g. disconnected and added to the discouragement filter. */\n static const int DISCOURAGEMENT_THRESHOLD{100};\n+/** Maximum number of outstanding CMPCTBLOCK requests for the same block. */\n+/** Greg: Setting to 3 to match number of high bandwidth peers... ~ensures one is outbound */\n+static const unsigned int MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK = 3;\n+/** Maximum number of missing transactions for a non-first getblocktxn request */\n+static const unsigned int MAX_GETBLOCKTXN_TXN_AFTER_FIRST_IN_FLIGHT = 10;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1191650786",
      "id" : 1191650786,
      "in_reply_to_id" : 1191357478,
      "line" : 28,
      "node_id" : "PRRC_kwDOABII585HByXi",
      "original_commit_id" : "1cde8b4862182571cde493cbceb612f321c6c3ef",
      "original_line" : 28,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 7,
      "pull_request_review_id" : 1423375759,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191650786/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T20:19:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191650786",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1192138027"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192138027"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This could be a `else if` of the outer if statement. That would avoid the nesting here.",
      "commit_id" : "ceded96265fbf3528dbb2a845d599ecbbae1bdb7",
      "created_at" : "2023-05-12T09:28:46Z",
      "diff_hunk" : "@@ -4342,8 +4372,17 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                     blockTxnMsg << txn;\n                     fProcessBLOCKTXN = true;\n                 } else {\n-                    req.blockhash = pindex->GetBlockHash();\n-                    m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::GETBLOCKTXN, req));\n+                    // We will try to round-trip any compact blocks we get on failure,\n+                    // as long as it's first, or not too large and as long as we chose\n+                    // the peer for high-bandwidth relay.\n+                    if (first_in_flight ||\n+                        (pfrom.m_bip152_highbandwidth_to && req.indexes.size() <= MAX_GETBLOCKTXN_TXN_AFTER_FIRST_IN_FLIGHT)) {\n+                        req.blockhash = pindex->GetBlockHash();\n+                        m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::GETBLOCKTXN, req));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1192138027",
      "id" : 1192138027,
      "line" : 4381,
      "node_id" : "PRRC_kwDOABII585HDpUr",
      "original_commit_id" : "ceded96265fbf3528dbb2a845d599ecbbae1bdb7",
      "original_line" : 4381,
      "original_position" : 249,
      "original_start_line" : 4378,
      "path" : "src/net_processing.cpp",
      "position" : 249,
      "pull_request_review_id" : 1424128109,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192138027/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 4378,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-05-12T09:28:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192138027",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1192388557"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192388557"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "03e8c7046776890a74a29b343f4e0355748945c3",
      "created_at" : "2023-05-12T13:35:28Z",
      "diff_hunk" : "@@ -4342,8 +4372,17 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                     blockTxnMsg << txn;\n                     fProcessBLOCKTXN = true;\n                 } else {\n-                    req.blockhash = pindex->GetBlockHash();\n-                    m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::GETBLOCKTXN, req));\n+                    // We will try to round-trip any compact blocks we get on failure,\n+                    // as long as it's first, or not too large and as long as we chose\n+                    // the peer for high-bandwidth relay.\n+                    if (first_in_flight ||\n+                        (pfrom.m_bip152_highbandwidth_to && req.indexes.size() <= MAX_GETBLOCKTXN_TXN_AFTER_FIRST_IN_FLIGHT)) {\n+                        req.blockhash = pindex->GetBlockHash();\n+                        m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::GETBLOCKTXN, req));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1192388557",
      "id" : 1192388557,
      "in_reply_to_id" : 1192138027,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HEmfN",
      "original_commit_id" : "ceded96265fbf3528dbb2a845d599ecbbae1bdb7",
      "original_line" : 4381,
      "original_position" : 249,
      "original_start_line" : 4378,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1424529964,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192388557/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-05-12T13:35:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192388557",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'll clean up history later when we're closer to ACKs",
      "created_at" : "2023-05-12T13:38:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#issuecomment-1545766429",
      "id" : 1545766429,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27626",
      "node_id" : "IC_kwDOABII585cIoYd",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1545766429/reactions"
      },
      "updated_at" : "2023-05-12T13:42:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1545766429",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1192406738"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192406738"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This \"warmup\" should really only be an issue after we've seen new blocks from 3+ peers since we don't persist hb peers across restarts and we have to wait for `MaybeSetPeerAsAnnouncingHeaderAndIDs` to be called on multiple unique peers. I now suspect the warmup period handles itself? My logs show 4+ blocks per node with only one partial block.",
      "commit_id" : "03e8c7046776890a74a29b343f4e0355748945c3",
      "created_at" : "2023-05-12T13:50:40Z",
      "diff_hunk" : "@@ -22,6 +22,11 @@ static const bool DEFAULT_PEERBLOOMFILTERS = false;\n static const bool DEFAULT_PEERBLOCKFILTERS = false;\n /** Threshold for marking a node to be discouraged, e.g. disconnected and added to the discouragement filter. */\n static const int DISCOURAGEMENT_THRESHOLD{100};\n+/** Maximum number of outstanding CMPCTBLOCK requests for the same block. */\n+/** Greg: Setting to 3 to match number of high bandwidth peers... ~ensures one is outbound */\n+static const unsigned int MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK = 3;\n+/** Maximum number of missing transactions for a non-first getblocktxn request */\n+static const unsigned int MAX_GETBLOCKTXN_TXN_AFTER_FIRST_IN_FLIGHT = 10;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1192406738",
      "id" : 1192406738,
      "in_reply_to_id" : 1191357478,
      "line" : 28,
      "node_id" : "PRRC_kwDOABII585HEq7S",
      "original_commit_id" : "1cde8b4862182571cde493cbceb612f321c6c3ef",
      "original_line" : 28,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 7,
      "pull_request_review_id" : 1424559087,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192406738/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-12T13:50:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1192406738",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> In contrast to previous effort, it will not help if subsequent peers send block headers only\r\n\r\nCan you elaborate on this? Are you saying that falling back to full block download is pointless?\r\n",
      "created_at" : "2023-05-12T17:47:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#issuecomment-1546082245",
      "id" : 1546082245,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27626",
      "node_id" : "IC_kwDOABII585cJ1fF",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1546082245/reactions"
      },
      "updated_at" : "2023-05-12T17:47:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1546082245",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@Sjors Basically previous efforts would allow the peer to send a header, not a compact block, and we would fire off an additional `getdata` for the compact block. See this block of code: https://github.com/bitcoin/bitcoin/pull/10984/files#diff-6875de769e90cec84d2e8a9c1b962cdbcda44d870d42e4215827e599e11e90e3R1411\r\n\r\nIMO it's unlikely to make an impact, as high-bandwidth peers are already demonstrably fast, and allows us to control better who takes up the additional slots.",
      "created_at" : "2023-05-12T17:56:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#issuecomment-1546091957",
      "id" : 1546091957,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27626",
      "node_id" : "IC_kwDOABII585cJ321",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1546091957/reactions"
      },
      "updated_at" : "2023-05-12T17:56:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1546091957",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "So that earlier attempt would solicit a compact block from a (BIP 152) low-bandwidth mode peer, in response to it announcing a header. That's similar to what we already do in `HeadersDirectFetchBlocks`, but allowing more than 1 in transit?\r\n\r\nWhereas in this PR we focus on the high-bandwidth mode peers, which are [allowed to send us](https://github.com/bitcoin/bips/blob/master/bip-0152.mediawiki#intended-protocol-flow) a `cmpctblock` message straight away (rather than waiting for us to ask). Right now we can only have one `cmpctblock` -> `getblocktxn` -> `blocktxn` \"session\" in progress. This PR makes that 3.\r\n\r\nThis approach seems fine, but the other attempts were never merged, which is why I am confused by the \"it will not help\" phrase. Are you saying these earlier attempts failed in some experiment, are they useless in general or is this new approach just better (and less complex?)?",
      "created_at" : "2023-05-12T19:13:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#issuecomment-1546170005",
      "id" : 1546170005,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27626",
      "node_id" : "IC_kwDOABII585cKK6V",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1546170005/reactions"
      },
      "updated_at" : "2023-05-12T19:13:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1546170005",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> This PR makes that 3.\r\n\r\nMakes it 3 parallel block downloads, first can be of any kind, the 2nd and 3rd must be compact block announcements from high badwidth peers. \r\n\r\n> I am confused by the \"it will not help\" phrase\r\n\r\nThis PR does not take advantage of low-bandwidth compact block peers message patterns, in other words.",
      "created_at" : "2023-05-12T19:17:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#issuecomment-1546173220",
      "id" : 1546173220,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27626",
      "node_id" : "IC_kwDOABII585cKLsk",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1546173220/reactions"
      },
      "updated_at" : "2023-05-12T19:17:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1546173220",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I was getting some sybil-stalls above the missing txn <=10 limit, so for now uncapped it.\r\n\r\nI also added in logic to ensure that at least one of the 3 slots is taken by an outbound peer. This should be more robust against sybils that are able to take up all inbound hb slots. e.g.,:\r\n\r\n1) uses fresh connection to announce, then stall\r\n2) uses both inbound hb peers to take up 2nd and 3rd slots, but never gives txns\r\n3) fresh peer times out, gets disconnected\r\n4) repeat 1-3\r\n\r\nAdded more extensive tests.",
      "created_at" : "2023-05-15T15:13:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#issuecomment-1548057302",
      "id" : 1548057302,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27626",
      "node_id" : "IC_kwDOABII585cRXrW",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1548057302/reactions"
      },
      "updated_at" : "2023-05-15T15:23:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1548057302",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196575479"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196575479"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: This comment is not right, should say something like \"was not requested from any peer\".",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-17T14:02:52Z",
      "diff_hunk" : "@@ -1125,34 +1126,40 @@ bool PeerManagerImpl::IsBlockRequested(const uint256& hash)\n \n void PeerManagerImpl::RemoveBlockRequest(const uint256& hash, std::optional<NodeId> from_peer)\n {\n-    auto it = mapBlocksInFlight.find(hash);\n-    if (it == mapBlocksInFlight.end()) {\n-        // Block was not requested\n+    auto range = mapBlocksInFlight.equal_range(hash);\n+    if (range.first == range.second) {\n+        // Block was not requested by any peer",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196575479",
      "id" : 1196575479,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HUkr3",
      "original_commit_id" : "ffc0aa03903a57fdcf66111e7874f17f390414eb",
      "original_line" : 1131,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1430785565,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196575479/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-17T15:52:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196575479",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196640876"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196640876"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Doesn't this line need to be removed here?",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-17T14:47:26Z",
      "diff_hunk" : "@@ -1514,6 +1522,15 @@ void PeerManagerImpl::FinalizeNode(const CNode& node)\n         nSyncStarted--;\n \n     for (const QueuedBlock& entry : state->vBlocksInFlight) {\n+        auto range = mapBlocksInFlight.equal_range(entry.pindex->GetBlockHash());\n+        while (range.first != range.second) {\n+            auto [node_id, list_it] = range.first->second;\n+            if (node_id != nodeid) {\n+                range.first++;\n+            } else {\n+                range.first = mapBlocksInFlight.erase(range.first);\n+            }\n+        }\n         mapBlocksInFlight.erase(entry.pindex->GetBlockHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196640876",
      "id" : 1196640876,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HU0ps",
      "original_commit_id" : "ffc0aa03903a57fdcf66111e7874f17f390414eb",
      "original_line" : 1534,
      "original_position" : 121,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1430785565,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196640876/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-17T15:52:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196640876",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196669983"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196669983"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What's the justification for this change?  It seems like this changes things so that in edge-case scenarios, we wouldn't allow the opportunistic compact block reconstruction to take place, and I don't see why we need to do that.",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-17T15:05:45Z",
      "diff_hunk" : "@@ -4320,7 +4320,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n \n         // If we're not close to tip yet, give up and let parallel block fetch work its magic\n-        if (!fAlreadyInFlight && !CanDirectFetch()) {\n+        if (!in_flight_same_peer && !CanDirectFetch()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196669983",
      "id" : 1196669983,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HU7wf",
      "original_commit_id" : "999a123082a21aae5c2cecfa7b7e4b9ee67e66ae",
      "original_line" : 4323,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1430785565,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196669983/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-17T15:52:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196669983",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196679410"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196679410"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: perhaps \"We should not have requested too many of this block\"",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-17T15:10:51Z",
      "diff_hunk" : "@@ -1132,8 +1147,8 @@ void PeerManagerImpl::RemoveBlockRequest(const uint256& hash, std::optional<Node\n         return;\n     }\n \n-    // Currently we don't request more than one peer for same block\n-    Assume(mapBlocksInFlight.count(hash) == 1);\n+    // We should never requested too many of this block",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196679410",
      "id" : 1196679410,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HU-Dy",
      "original_commit_id" : "e54f2d3680ad79ce8652fcdc37bf8331b9e892b5",
      "original_line" : 1150,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1430785565,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196679410/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-17T15:52:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196679410",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196683873"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196683873"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is it worth adding an `Assume()` here that we have strictly less than MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK requests outstanding?",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-17T15:13:21Z",
      "diff_hunk" : "@@ -1179,8 +1194,8 @@ bool PeerManagerImpl::BlockRequested(NodeId nodeid, const CBlockIndex& block, st\n         }\n     }\n \n-    // Make sure it's not listed somewhere already.\n-    RemoveBlockRequest(hash, std::nullopt);\n+    // Make sure it's not being fetched already from same peer.\n+    RemoveBlockRequest(hash, nodeid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196683873",
      "id" : 1196683873,
      "line" : 1197,
      "node_id" : "PRRC_kwDOABII585HU_Jh",
      "original_commit_id" : "e54f2d3680ad79ce8652fcdc37bf8331b9e892b5",
      "original_line" : 1197,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 133,
      "pull_request_review_id" : 1430785565,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196683873/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-17T15:52:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196683873",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196713707"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196713707"
         }
      },
      "author_association" : "MEMBER",
      "body" : "So if we get 3 compact block announcements from 3 peers, and we then send 3 getblocktxn messages to them, and then the first blocktxn comes back and reconstruction fails, we will wait until we get the third blocktxn message back before we send out a getdata message for the full block, I think?\r\n\r\nThat seems suboptimal, though I don't have a fix in mind yet.",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-17T15:34:22Z",
      "diff_hunk" : "@@ -4460,33 +4496,43 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         {\n             LOCK(cs_main);\n \n-            bool expected_blocktxn = false;\n             auto range_flight = mapBlocksInFlight.equal_range(resp.blockhash);\n+            size_t already_in_flight = std::distance(range_flight.first, range_flight.second);\n+            bool requested_block_from_this_peer{false};\n+\n             while (range_flight.first != range_flight.second) {\n                 auto [node_id, block_it] = range_flight.first->second;\n                 if (node_id == pfrom.GetId() && block_it->partialBlock) {\n-                    expected_blocktxn = true;\n+                    requested_block_from_this_peer = true;\n                     break;\n                 }\n                 range_flight.first++;\n             }\n \n-            if (!expected_blocktxn) {\n+            if (!requested_block_from_this_peer) {\n                 LogPrint(BCLog::NET, \"Peer %d sent us block transactions for block we weren't expecting\\n\", pfrom.GetId());\n                 return;\n             }\n \n+            bool first_in_flight = already_in_flight == 0 || (already_in_flight == 1 && requested_block_from_this_peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196713707",
      "id" : 1196713707,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HVGbr",
      "original_commit_id" : "e54f2d3680ad79ce8652fcdc37bf8331b9e892b5",
      "original_line" : 4518,
      "original_position" : 178,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1430785565,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196713707/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-17T15:52:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196713707",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196715533"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196715533"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: this comment doesn't seem right",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-17T15:35:57Z",
      "diff_hunk" : "@@ -4460,33 +4496,43 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         {\n             LOCK(cs_main);\n \n-            bool expected_blocktxn = false;\n             auto range_flight = mapBlocksInFlight.equal_range(resp.blockhash);\n+            size_t already_in_flight = std::distance(range_flight.first, range_flight.second);\n+            bool requested_block_from_this_peer{false};\n+\n             while (range_flight.first != range_flight.second) {\n                 auto [node_id, block_it] = range_flight.first->second;\n                 if (node_id == pfrom.GetId() && block_it->partialBlock) {\n-                    expected_blocktxn = true;\n+                    requested_block_from_this_peer = true;\n                     break;\n                 }\n                 range_flight.first++;\n             }\n \n-            if (!expected_blocktxn) {\n+            if (!requested_block_from_this_peer) {\n                 LogPrint(BCLog::NET, \"Peer %d sent us block transactions for block we weren't expecting\\n\", pfrom.GetId());\n                 return;\n             }\n \n+            bool first_in_flight = already_in_flight == 0 || (already_in_flight == 1 && requested_block_from_this_peer);\n+\n             PartiallyDownloadedBlock& partialBlock = *range_flight.first->second.second->partialBlock;\n             ReadStatus status = partialBlock.FillBlock(*pblock, resp.txn);\n             if (status == READ_STATUS_INVALID) {\n                 RemoveBlockRequest(resp.blockhash, pfrom.GetId()); // Reset in-flight state in case Misbehaving does not result in a disconnect\n                 Misbehaving(*peer, 100, \"invalid compact block/non-matching block transactions\");\n                 return;\n             } else if (status == READ_STATUS_FAILED) {\n-                // Might have collided, fall back to getdata now :(\n-                std::vector<CInv> invs;\n-                invs.push_back(CInv(MSG_BLOCK | GetFetchFlags(*peer), resp.blockhash));\n-                m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::GETDATA, invs));\n+                if (first_in_flight) {\n+                    // Might have collided, fall back to getdata now :(\n+                    std::vector<CInv> invs;\n+                    invs.push_back(CInv(MSG_BLOCK | GetFetchFlags(*peer), resp.blockhash));\n+                    m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::GETDATA, invs));\n+                } else {\n+                    RemoveBlockRequest(resp.blockhash, pfrom.GetId()); // Reset in-flight state in case of whitelist",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196715533",
      "id" : 1196715533,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HVG4N",
      "original_commit_id" : "e54f2d3680ad79ce8652fcdc37bf8331b9e892b5",
      "original_line" : 4532,
      "original_position" : 197,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1430785565,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196715533/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-17T15:52:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196715533",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196732363"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196732363"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This notion of `first_in_flight` is not correct, I think.  Imagine we get a headers announcement from an outbound (non-hb) peer, and so we send a getdata(cmpctblock).  In the meantime, we get a compact block announcement from an inbound peer which fails to reconstruct.  Then the compact block comes back from the outbound peer; `first_in_flight` will be false because we think we have two requests outstanding.\r\n\r\nFurther down, when we decide whether to send a GETBLOCKTXN message to this non-HB outbound peer, we will choose not to, because `first_in_flight` is false and the peer is not already HB.  This seems like it would be a regression, as inbound HB peers would gain the ability to interfere with compact block relay happening with other peers just by making a compactblock announcement.",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-17T15:49:30Z",
      "diff_hunk" : "@@ -4277,15 +4307,25 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             nodestate->m_last_block_announcement = GetTime();\n         }\n \n-        std::map<uint256, std::pair<NodeId, std::list<QueuedBlock>::iterator> >::iterator blockInFlightIt = mapBlocksInFlight.find(pindex->GetBlockHash());\n-        bool fAlreadyInFlight = blockInFlightIt != mapBlocksInFlight.end();\n-\n         if (pindex->nStatus & BLOCK_HAVE_DATA) // Nothing to do here\n             return;\n \n+        auto range_flight = mapBlocksInFlight.equal_range(pindex->GetBlockHash());\n+        size_t already_in_flight = std::distance(range_flight.first, range_flight.second);\n+        bool requested_block_from_this_peer{false};\n+\n+        while (range_flight.first != range_flight.second) {\n+            if (range_flight.first->second.first == pfrom.GetId()) {\n+                requested_block_from_this_peer = true;\n+                break;\n+            }\n+            range_flight.first++;\n+        }\n+        bool first_in_flight = already_in_flight == 0 || (already_in_flight == 1 && requested_block_from_this_peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196732363",
      "id" : 1196732363,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HVK_L",
      "original_commit_id" : "324af0fd5c64a91780c7beaf9c2023dcf4df90da",
      "original_line" : 4325,
      "original_position" : 209,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1430785565,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196732363/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-17T16:04:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196732363",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> However, it is possible that a peer starting up for the first time could have all its slots taken by inbounds.\r\n\r\nYeah, goes without saying, but maybe it doesn't. This PR offers no protection on fresh restart(no hb peers), and only offers 3 parallel downloads when an outbound is selected as hb and offers a block",
      "created_at" : "2023-05-17T16:15:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#issuecomment-1551697808",
      "id" : 1551697808,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27626",
      "node_id" : "IC_kwDOABII585cfQeQ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1551697808/reactions"
      },
      "updated_at" : "2023-05-17T16:15:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1551697808",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196773469"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196773469"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Actually, can we use the insertion order guarantees of multimap to solve this?",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-17T16:16:39Z",
      "diff_hunk" : "@@ -4460,33 +4496,43 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         {\n             LOCK(cs_main);\n \n-            bool expected_blocktxn = false;\n             auto range_flight = mapBlocksInFlight.equal_range(resp.blockhash);\n+            size_t already_in_flight = std::distance(range_flight.first, range_flight.second);\n+            bool requested_block_from_this_peer{false};\n+\n             while (range_flight.first != range_flight.second) {\n                 auto [node_id, block_it] = range_flight.first->second;\n                 if (node_id == pfrom.GetId() && block_it->partialBlock) {\n-                    expected_blocktxn = true;\n+                    requested_block_from_this_peer = true;\n                     break;\n                 }\n                 range_flight.first++;\n             }\n \n-            if (!expected_blocktxn) {\n+            if (!requested_block_from_this_peer) {\n                 LogPrint(BCLog::NET, \"Peer %d sent us block transactions for block we weren't expecting\\n\", pfrom.GetId());\n                 return;\n             }\n \n+            bool first_in_flight = already_in_flight == 0 || (already_in_flight == 1 && requested_block_from_this_peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196773469",
      "id" : 1196773469,
      "in_reply_to_id" : 1196713707,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HVVBd",
      "original_commit_id" : "e54f2d3680ad79ce8652fcdc37bf8331b9e892b5",
      "original_line" : 4518,
      "original_position" : 178,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1431106216,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196773469/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-17T16:16:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196773469",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196774969"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196774969"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Similarly here, can we use the insertion order of multimap to determine which peer was actually first to make the announcement?  If in the situation where an outbound (non-hb) peer is the first to announce that we still always send the getblocktxn if compact blocks fail, then this new logic would not be making anything worse, which seems sufficient to me.",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-17T16:18:03Z",
      "diff_hunk" : "@@ -4277,15 +4307,25 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             nodestate->m_last_block_announcement = GetTime();\n         }\n \n-        std::map<uint256, std::pair<NodeId, std::list<QueuedBlock>::iterator> >::iterator blockInFlightIt = mapBlocksInFlight.find(pindex->GetBlockHash());\n-        bool fAlreadyInFlight = blockInFlightIt != mapBlocksInFlight.end();\n-\n         if (pindex->nStatus & BLOCK_HAVE_DATA) // Nothing to do here\n             return;\n \n+        auto range_flight = mapBlocksInFlight.equal_range(pindex->GetBlockHash());\n+        size_t already_in_flight = std::distance(range_flight.first, range_flight.second);\n+        bool requested_block_from_this_peer{false};\n+\n+        while (range_flight.first != range_flight.second) {\n+            if (range_flight.first->second.first == pfrom.GetId()) {\n+                requested_block_from_this_peer = true;\n+                break;\n+            }\n+            range_flight.first++;\n+        }\n+        bool first_in_flight = already_in_flight == 0 || (already_in_flight == 1 && requested_block_from_this_peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196774969",
      "id" : 1196774969,
      "in_reply_to_id" : 1196732363,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HVVY5",
      "original_commit_id" : "324af0fd5c64a91780c7beaf9c2023dcf4df90da",
      "original_line" : 4325,
      "original_position" : 209,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1431108455,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196774969/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-17T16:18:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196774969",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196823777"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196823777"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-17T17:04:59Z",
      "diff_hunk" : "@@ -1125,34 +1126,40 @@ bool PeerManagerImpl::IsBlockRequested(const uint256& hash)\n \n void PeerManagerImpl::RemoveBlockRequest(const uint256& hash, std::optional<NodeId> from_peer)\n {\n-    auto it = mapBlocksInFlight.find(hash);\n-    if (it == mapBlocksInFlight.end()) {\n-        // Block was not requested\n+    auto range = mapBlocksInFlight.equal_range(hash);\n+    if (range.first == range.second) {\n+        // Block was not requested by any peer",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196823777",
      "id" : 1196823777,
      "in_reply_to_id" : 1196575479,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HVhTh",
      "original_commit_id" : "ffc0aa03903a57fdcf66111e7874f17f390414eb",
      "original_line" : 1131,
      "original_position" : 19,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1431182979,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196823777/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-17T17:04:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196823777",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196823829"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196823829"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-17T17:05:02Z",
      "diff_hunk" : "@@ -1514,6 +1522,15 @@ void PeerManagerImpl::FinalizeNode(const CNode& node)\n         nSyncStarted--;\n \n     for (const QueuedBlock& entry : state->vBlocksInFlight) {\n+        auto range = mapBlocksInFlight.equal_range(entry.pindex->GetBlockHash());\n+        while (range.first != range.second) {\n+            auto [node_id, list_it] = range.first->second;\n+            if (node_id != nodeid) {\n+                range.first++;\n+            } else {\n+                range.first = mapBlocksInFlight.erase(range.first);\n+            }\n+        }\n         mapBlocksInFlight.erase(entry.pindex->GetBlockHash());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196823829",
      "id" : 1196823829,
      "in_reply_to_id" : 1196640876,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HVhUV",
      "original_commit_id" : "ffc0aa03903a57fdcf66111e7874f17f390414eb",
      "original_line" : 1534,
      "original_position" : 121,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1431183061,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196823829/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-17T17:05:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196823829",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196823878"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196823878"
         }
      },
      "author_association" : "MEMBER",
      "body" : "hmm yeah, this is old code, doesn't make sense to me either. removed the change.",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-17T17:05:05Z",
      "diff_hunk" : "@@ -4320,7 +4320,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n \n         // If we're not close to tip yet, give up and let parallel block fetch work its magic\n-        if (!fAlreadyInFlight && !CanDirectFetch()) {\n+        if (!in_flight_same_peer && !CanDirectFetch()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196823878",
      "id" : 1196823878,
      "in_reply_to_id" : 1196669983,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HVhVG",
      "original_commit_id" : "999a123082a21aae5c2cecfa7b7e4b9ee67e66ae",
      "original_line" : 4323,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1431183147,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196823878/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-17T17:05:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196823878",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196823938"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196823938"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-17T17:05:09Z",
      "diff_hunk" : "@@ -1132,8 +1147,8 @@ void PeerManagerImpl::RemoveBlockRequest(const uint256& hash, std::optional<Node\n         return;\n     }\n \n-    // Currently we don't request more than one peer for same block\n-    Assume(mapBlocksInFlight.count(hash) == 1);\n+    // We should never requested too many of this block",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196823938",
      "id" : 1196823938,
      "in_reply_to_id" : 1196679410,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HVhWC",
      "original_commit_id" : "e54f2d3680ad79ce8652fcdc37bf8331b9e892b5",
      "original_line" : 1150,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1431183239,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196823938/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-17T17:05:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196823938",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196823999"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196823999"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-17T17:05:13Z",
      "diff_hunk" : "@@ -1179,8 +1194,8 @@ bool PeerManagerImpl::BlockRequested(NodeId nodeid, const CBlockIndex& block, st\n         }\n     }\n \n-    // Make sure it's not listed somewhere already.\n-    RemoveBlockRequest(hash, std::nullopt);\n+    // Make sure it's not being fetched already from same peer.\n+    RemoveBlockRequest(hash, nodeid);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196823999",
      "id" : 1196823999,
      "in_reply_to_id" : 1196683873,
      "line" : 1197,
      "node_id" : "PRRC_kwDOABII585HVhW_",
      "original_commit_id" : "e54f2d3680ad79ce8652fcdc37bf8331b9e892b5",
      "original_line" : 1197,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 133,
      "pull_request_review_id" : 1431183360,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196823999/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-17T17:05:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196823999",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196824091"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196824091"
         }
      },
      "author_association" : "MEMBER",
      "body" : "removed nonsense copy/paste",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-17T17:05:18Z",
      "diff_hunk" : "@@ -4460,33 +4496,43 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         {\n             LOCK(cs_main);\n \n-            bool expected_blocktxn = false;\n             auto range_flight = mapBlocksInFlight.equal_range(resp.blockhash);\n+            size_t already_in_flight = std::distance(range_flight.first, range_flight.second);\n+            bool requested_block_from_this_peer{false};\n+\n             while (range_flight.first != range_flight.second) {\n                 auto [node_id, block_it] = range_flight.first->second;\n                 if (node_id == pfrom.GetId() && block_it->partialBlock) {\n-                    expected_blocktxn = true;\n+                    requested_block_from_this_peer = true;\n                     break;\n                 }\n                 range_flight.first++;\n             }\n \n-            if (!expected_blocktxn) {\n+            if (!requested_block_from_this_peer) {\n                 LogPrint(BCLog::NET, \"Peer %d sent us block transactions for block we weren't expecting\\n\", pfrom.GetId());\n                 return;\n             }\n \n+            bool first_in_flight = already_in_flight == 0 || (already_in_flight == 1 && requested_block_from_this_peer);\n+\n             PartiallyDownloadedBlock& partialBlock = *range_flight.first->second.second->partialBlock;\n             ReadStatus status = partialBlock.FillBlock(*pblock, resp.txn);\n             if (status == READ_STATUS_INVALID) {\n                 RemoveBlockRequest(resp.blockhash, pfrom.GetId()); // Reset in-flight state in case Misbehaving does not result in a disconnect\n                 Misbehaving(*peer, 100, \"invalid compact block/non-matching block transactions\");\n                 return;\n             } else if (status == READ_STATUS_FAILED) {\n-                // Might have collided, fall back to getdata now :(\n-                std::vector<CInv> invs;\n-                invs.push_back(CInv(MSG_BLOCK | GetFetchFlags(*peer), resp.blockhash));\n-                m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::GETDATA, invs));\n+                if (first_in_flight) {\n+                    // Might have collided, fall back to getdata now :(\n+                    std::vector<CInv> invs;\n+                    invs.push_back(CInv(MSG_BLOCK | GetFetchFlags(*peer), resp.blockhash));\n+                    m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::GETDATA, invs));\n+                } else {\n+                    RemoveBlockRequest(resp.blockhash, pfrom.GetId()); // Reset in-flight state in case of whitelist",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196824091",
      "id" : 1196824091,
      "in_reply_to_id" : 1196715533,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HVhYb",
      "original_commit_id" : "e54f2d3680ad79ce8652fcdc37bf8331b9e892b5",
      "original_line" : 4532,
      "original_position" : 197,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1431183498,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196824091/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-17T17:05:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196824091",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196858330"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196858330"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> If in the situation where an outbound (non-hb) peer is the first to announce that we still always send the getblocktxn if compact blocks fail, then this new logic would not be making anything worse, which seems sufficient to me.\r\n\r\nExactly. Fixed, I think!",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-17T17:35:57Z",
      "diff_hunk" : "@@ -4277,15 +4307,25 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             nodestate->m_last_block_announcement = GetTime();\n         }\n \n-        std::map<uint256, std::pair<NodeId, std::list<QueuedBlock>::iterator> >::iterator blockInFlightIt = mapBlocksInFlight.find(pindex->GetBlockHash());\n-        bool fAlreadyInFlight = blockInFlightIt != mapBlocksInFlight.end();\n-\n         if (pindex->nStatus & BLOCK_HAVE_DATA) // Nothing to do here\n             return;\n \n+        auto range_flight = mapBlocksInFlight.equal_range(pindex->GetBlockHash());\n+        size_t already_in_flight = std::distance(range_flight.first, range_flight.second);\n+        bool requested_block_from_this_peer{false};\n+\n+        while (range_flight.first != range_flight.second) {\n+            if (range_flight.first->second.first == pfrom.GetId()) {\n+                requested_block_from_this_peer = true;\n+                break;\n+            }\n+            range_flight.first++;\n+        }\n+        bool first_in_flight = already_in_flight == 0 || (already_in_flight == 1 && requested_block_from_this_peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196858330",
      "id" : 1196858330,
      "in_reply_to_id" : 1196732363,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HVpva",
      "original_commit_id" : "324af0fd5c64a91780c7beaf9c2023dcf4df90da",
      "original_line" : 4325,
      "original_position" : 209,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1431235703,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196858330/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-17T17:35:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196858330",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196858467"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196858467"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Looks like some lost in translation logic from prior PRs. Indeed, we can just peek at the first entry, if it exists. Fixed, I think.",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-17T17:36:05Z",
      "diff_hunk" : "@@ -4460,33 +4496,43 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         {\n             LOCK(cs_main);\n \n-            bool expected_blocktxn = false;\n             auto range_flight = mapBlocksInFlight.equal_range(resp.blockhash);\n+            size_t already_in_flight = std::distance(range_flight.first, range_flight.second);\n+            bool requested_block_from_this_peer{false};\n+\n             while (range_flight.first != range_flight.second) {\n                 auto [node_id, block_it] = range_flight.first->second;\n                 if (node_id == pfrom.GetId() && block_it->partialBlock) {\n-                    expected_blocktxn = true;\n+                    requested_block_from_this_peer = true;\n                     break;\n                 }\n                 range_flight.first++;\n             }\n \n-            if (!expected_blocktxn) {\n+            if (!requested_block_from_this_peer) {\n                 LogPrint(BCLog::NET, \"Peer %d sent us block transactions for block we weren't expecting\\n\", pfrom.GetId());\n                 return;\n             }\n \n+            bool first_in_flight = already_in_flight == 0 || (already_in_flight == 1 && requested_block_from_this_peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1196858467",
      "id" : 1196858467,
      "in_reply_to_id" : 1196713707,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HVpxj",
      "original_commit_id" : "e54f2d3680ad79ce8652fcdc37bf8331b9e892b5",
      "original_line" : 4518,
      "original_position" : 178,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1431235897,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196858467/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-17T17:36:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1196858467",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the quick updates -- the code looks right to me now; will test. ",
      "created_at" : "2023-05-17T17:47:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#issuecomment-1551819825",
      "id" : 1551819825,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27626",
      "node_id" : "IC_kwDOABII585cfuQx",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1551819825/reactions"
      },
      "updated_at" : "2023-05-17T17:47:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1551819825",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 2d12fab42cc0f11d5ede96c7eb71a496931df0b5. I've reviewed the test as well and have been running this branch live, and it looks good to me.\r\n\r\nI think it'd be good to merge this sooner than later so we can get some experience running this in master before it appears in a release, so that we can get a sense of whether we want to institute any better bandwidth management before deploying.\r\n\r\nEDIT: not sure what's up with the CI failure?",
      "created_at" : "2023-05-18T13:52:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#issuecomment-1553089898",
      "id" : 1553089898,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27626",
      "node_id" : "IC_kwDOABII585ckkVq",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1553089898/reactions"
      },
      "updated_at" : "2023-05-18T13:57:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1553089898",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "\"jq: command not found\" weird one, probably just restart?",
      "created_at" : "2023-05-18T13:59:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#issuecomment-1553102278",
      "id" : 1553102278,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27626",
      "node_id" : "IC_kwDOABII585cknXG",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1553102278/reactions"
      },
      "updated_at" : "2023-05-18T13:59:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1553102278",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> \"jq: command not found\" weird one, probably just restart?\r\n\r\nRebase should do it. Added recently for IWYU in the tidy job.",
      "created_at" : "2023-05-18T14:03:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#issuecomment-1553108896",
      "id" : 1553108896,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27626",
      "node_id" : "IC_kwDOABII585cko-g",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 1,
         "eyes" : 1,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 2,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1553108896/reactions"
      },
      "updated_at" : "2023-05-18T14:03:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1553108896",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2023-05-18T14:04:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#issuecomment-1553109478",
      "id" : 1553109478,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27626",
      "node_id" : "IC_kwDOABII585ckpHm",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1553109478/reactions"
      },
      "updated_at" : "2023-05-18T14:04:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1553109478",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-18T14:48:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#issuecomment-1553177921",
      "id" : 1553177921,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27626",
      "node_id" : "IC_kwDOABII585ck51B",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1553177921/reactions"
      },
      "updated_at" : "2023-05-18T14:48:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1553177921",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1198247881"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1198247881"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Suggestion to simplify it, in case you touch it again:\r\n```diff\r\nindex 50cce9318..cd9268f6b 100755\r\n--- a/test/functional/p2p_compactblocks.py\r\n+++ b/test/functional/p2p_compactblocks.py\r\n@@ -847,29 +847,14 @@ class CompactBlocksTest(BitcoinTestFramework):\r\n             return block, cmpct_block\r\n \r\n         # First, make delivery_peer, inbound_peer, and outbound_peer high \r\nbandwidth\r\n-        block, cmpct_block = announce_cmpct_block(node, delivery_peer, 1)\r\n-        msg = msg_blocktxn()\r\n-        msg.block_transactions.blockhash = block.sha256\r\n-        msg.block_transactions.transactions = block.vtx[1:]\r\n-        delivery_peer.send_and_ping(msg)\r\n-        assert_equal(int(node.getbestblockhash(), 16), block.sha256)\r\n-        delivery_peer.clear_getblocktxn()\r\n-\r\n-        block, cmpct_block = announce_cmpct_block(node, inbound_peer, 1)\r\n-        msg = msg_blocktxn()\r\n-        msg.block_transactions.blockhash = block.sha256\r\n-        msg.block_transactions.transactions = block.vtx[1:]\r\n-        inbound_peer.send_and_ping(msg)\r\n-        assert_equal(int(node.getbestblockhash(), 16), block.sha256)\r\n-        inbound_peer.clear_getblocktxn()\r\n-\r\n-        block, cmpct_block = announce_cmpct_block(node, outbound_peer, 1)\r\n-        msg = msg_blocktxn()\r\n-        msg.block_transactions.blockhash = block.sha256\r\n-        msg.block_transactions.transactions = block.vtx[1:]\r\n-        outbound_peer.send_and_ping(msg)\r\n-        assert_equal(int(node.getbestblockhash(), 16), block.sha256)\r\n-        outbound_peer.clear_getblocktxn()\r\n+        for peer in [delivery_peer, inbound_peer, outbound_peer]:\r\n+            block, _ = announce_cmpct_block(node, peer, 1)\r\n+            msg = msg_blocktxn()\r\n+            msg.block_transactions.blockhash = block.sha256\r\n+            msg.block_transactions.transactions = block.vtx[1:]\r\n+            peer.send_and_ping(msg)\r\n+            assert_equal(int(node.getbestblockhash(), 16), block.sha256)\r\n+            peer.clear_getblocktxn()\r\n \r\n         # Test the simple parallel download case...\r\n         for num_missing in [1, 5, 20]:\r\n```",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-18T19:55:58Z",
      "diff_hunk" : "@@ -823,12 +827,100 @@ def assert_highbandwidth_states(node, hb_to, hb_from):\n         hb_test_node.send_and_ping(msg_sendcmpct(announce=False, version=2))\n         assert_highbandwidth_states(self.nodes[0], hb_to=True, hb_from=False)\n \n+    def test_compactblock_reconstruction_parallel_reconstruction(self, stalling_peer, delivery_peer, inbound_peer, outbound_peer):\n+        \"\"\" All p2p connections are inbound except outbound_peer. We test that ultimate parallel slot\n+            can only be taken by an outbound node unless prior attempts were done by an outbound\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert len(self.utxos)\n+\n+        def announce_cmpct_block(node, peer, txn_count):\n+            utxo = self.utxos.pop(0)\n+            block = self.build_block_with_transactions(node, utxo, txn_count)\n+\n+            cmpct_block = HeaderAndShortIDs()\n+            cmpct_block.initialize_from_block(block)\n+            msg = msg_cmpctblock(cmpct_block.to_p2p())\n+            peer.send_and_ping(msg)\n+            with p2p_lock:\n+                assert \"getblocktxn\" in peer.last_message\n+            return block, cmpct_block\n+\n+        # First, make delivery_peer, inbound_peer, and outbound_peer high bandwidth\n+        block, cmpct_block = announce_cmpct_block(node, delivery_peer, 1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1198247881",
      "id" : 1198247881,
      "line" : 850,
      "node_id" : "PRRC_kwDOABII585Ha8_J",
      "original_commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "original_line" : 850,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks.py",
      "position" : 44,
      "pull_request_review_id" : 1433364121,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1198247881/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-18T19:55:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1198247881",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/19480819?v=4",
         "events_url" : "https://api.github.com/users/brunoerg/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brunoerg/followers",
         "following_url" : "https://api.github.com/users/brunoerg/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brunoerg/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brunoerg",
         "id" : 19480819,
         "login" : "brunoerg",
         "node_id" : "MDQ6VXNlcjE5NDgwODE5",
         "organizations_url" : "https://api.github.com/users/brunoerg/orgs",
         "received_events_url" : "https://api.github.com/users/brunoerg/received_events",
         "repos_url" : "https://api.github.com/users/brunoerg/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brunoerg/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brunoerg/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brunoerg"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1198642367"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1198642367"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n                    (pfrom.IsOutboundOrBlockRelayConn() ||\r\n```\r\nI would avoid using CNodeState when possible.",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-19T07:33:57Z",
      "diff_hunk" : "@@ -4338,9 +4386,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                     txn.blockhash = blockhash;\n                     blockTxnMsg << txn;\n                     fProcessBLOCKTXN = true;\n-                } else {\n+                } else if (first_in_flight) {\n+                    // We will try to round-trip any compact blocks we get on failure,\n+                    // as long as it's first...\n                     req.blockhash = pindex->GetBlockHash();\n                     m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::GETBLOCKTXN, req));\n+                } else if (pfrom.m_bip152_highbandwidth_to &&\n+                    (!nodestate->m_is_inbound ||",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1198642367",
      "id" : 1198642367,
      "line" : 4395,
      "node_id" : "PRRC_kwDOABII585HcdS_",
      "original_commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "original_line" : 4395,
      "original_position" : 275,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 275,
      "pull_request_review_id" : 1433928913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1198642367/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-19T08:01:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1198642367",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1198645480"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1198645480"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        CNodeState& nodestate = *Assert(State(nodeid));\r\n```",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-19T07:37:26Z",
      "diff_hunk" : "@@ -1117,40 +1121,57 @@ std::chrono::microseconds PeerManagerImpl::NextInvToInbounds(std::chrono::micros\n \n bool PeerManagerImpl::IsBlockRequested(const uint256& hash)\n {\n-    return mapBlocksInFlight.find(hash) != mapBlocksInFlight.end();\n+    return mapBlocksInFlight.count(hash);\n }\n \n-void PeerManagerImpl::RemoveBlockRequest(const uint256& hash, std::optional<NodeId> from_peer)\n+bool PeerManagerImpl::IsBlockRequestedFromOutbound(const uint256& hash)\n {\n-    auto it = mapBlocksInFlight.find(hash);\n-    if (it == mapBlocksInFlight.end()) {\n-        // Block was not requested\n-        return;\n+    for (auto range = mapBlocksInFlight.equal_range(hash); range.first != range.second; range.first++) {\n+        auto [nodeid, block_it] = range.first->second;\n+        CNodeState *nodestate = State(nodeid);\n+        assert(nodestate);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1198645480",
      "id" : 1198645480,
      "line" : 1132,
      "node_id" : "PRRC_kwDOABII585HceDo",
      "original_commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "original_line" : 1132,
      "original_position" : 47,
      "original_start_line" : 1131,
      "path" : "src/net_processing.cpp",
      "position" : 47,
      "pull_request_review_id" : 1433928913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1198645480/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1131,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-05-19T08:01:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1198645480",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1198646710"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1198646710"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        CNodeState& state = *Assert(State(node_id));\r\n```",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-19T07:38:52Z",
      "diff_hunk" : "@@ -1117,40 +1121,57 @@ std::chrono::microseconds PeerManagerImpl::NextInvToInbounds(std::chrono::micros\n \n bool PeerManagerImpl::IsBlockRequested(const uint256& hash)\n {\n-    return mapBlocksInFlight.find(hash) != mapBlocksInFlight.end();\n+    return mapBlocksInFlight.count(hash);\n }\n \n-void PeerManagerImpl::RemoveBlockRequest(const uint256& hash, std::optional<NodeId> from_peer)\n+bool PeerManagerImpl::IsBlockRequestedFromOutbound(const uint256& hash)\n {\n-    auto it = mapBlocksInFlight.find(hash);\n-    if (it == mapBlocksInFlight.end()) {\n-        // Block was not requested\n-        return;\n+    for (auto range = mapBlocksInFlight.equal_range(hash); range.first != range.second; range.first++) {\n+        auto [nodeid, block_it] = range.first->second;\n+        CNodeState *nodestate = State(nodeid);\n+        assert(nodestate);\n+        if (!nodestate->m_is_inbound) return true;\n     }\n \n-    auto [node_id, list_it] = it->second;\n+    return false;\n+}\n \n-    if (from_peer && node_id != *from_peer) {\n-        // Block was requested by another peer\n+void PeerManagerImpl::RemoveBlockRequest(const uint256& hash, std::optional<NodeId> from_peer)\n+{\n+    auto range = mapBlocksInFlight.equal_range(hash);\n+    if (range.first == range.second) {\n+        // Block was not requested from any peer\n         return;\n     }\n \n-    CNodeState *state = State(node_id);\n-    assert(state != nullptr);\n+    // We should not have requested too many of this block\n+    Assume(mapBlocksInFlight.count(hash) <= MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK);\n \n-    if (state->vBlocksInFlight.begin() == list_it) {\n-        // First block on the queue was received, update the start download time for the next one\n-        state->m_downloading_since = std::max(state->m_downloading_since, GetTime<std::chrono::microseconds>());\n-    }\n-    state->vBlocksInFlight.erase(list_it);\n+    while (range.first != range.second) {\n+        auto [node_id, list_it] = range.first->second;\n+\n+        if (from_peer && *from_peer != node_id) {\n+            range.first++;\n+            continue;\n+        }\n \n-    state->nBlocksInFlight--;\n-    if (state->nBlocksInFlight == 0) {\n-        // Last validated block on the queue was received.\n-        m_peers_downloading_from--;\n+        CNodeState *state = State(node_id);\n+        assert(state != nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1198646710",
      "id" : 1198646710,
      "line" : 1159,
      "node_id" : "PRRC_kwDOABII585HceW2",
      "original_commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "original_line" : 1159,
      "original_position" : 88,
      "original_start_line" : 1158,
      "path" : "src/net_processing.cpp",
      "position" : 88,
      "pull_request_review_id" : 1433928913,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1198646710/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 1158,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-05-19T08:01:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1198646710",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "holding off on touching for nits, can do in follow-up",
      "created_at" : "2023-05-19T11:06:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#issuecomment-1554410798",
      "id" : 1554410798,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27626",
      "node_id" : "IC_kwDOABII585cpm0u",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1554410798/reactions"
      },
      "updated_at" : "2023-05-19T11:06:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1554410798",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1198846834"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1198846834"
         }
      },
      "author_association" : "MEMBER",
      "body" : "(If this nit is taken, it would also be good to add a log statement, so that if the loop is failing, one can derive easily in which iteration it failed. Generally I think any, or almost any comment in a functional test case can be a (debug)log statement to aid debugging in case of failure)",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-19T11:15:16Z",
      "diff_hunk" : "@@ -823,12 +827,100 @@ def assert_highbandwidth_states(node, hb_to, hb_from):\n         hb_test_node.send_and_ping(msg_sendcmpct(announce=False, version=2))\n         assert_highbandwidth_states(self.nodes[0], hb_to=True, hb_from=False)\n \n+    def test_compactblock_reconstruction_parallel_reconstruction(self, stalling_peer, delivery_peer, inbound_peer, outbound_peer):\n+        \"\"\" All p2p connections are inbound except outbound_peer. We test that ultimate parallel slot\n+            can only be taken by an outbound node unless prior attempts were done by an outbound\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert len(self.utxos)\n+\n+        def announce_cmpct_block(node, peer, txn_count):\n+            utxo = self.utxos.pop(0)\n+            block = self.build_block_with_transactions(node, utxo, txn_count)\n+\n+            cmpct_block = HeaderAndShortIDs()\n+            cmpct_block.initialize_from_block(block)\n+            msg = msg_cmpctblock(cmpct_block.to_p2p())\n+            peer.send_and_ping(msg)\n+            with p2p_lock:\n+                assert \"getblocktxn\" in peer.last_message\n+            return block, cmpct_block\n+\n+        # First, make delivery_peer, inbound_peer, and outbound_peer high bandwidth\n+        block, cmpct_block = announce_cmpct_block(node, delivery_peer, 1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1198846834",
      "id" : 1198846834,
      "in_reply_to_id" : 1198247881,
      "line" : 850,
      "node_id" : "PRRC_kwDOABII585HdPNy",
      "original_commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "original_line" : 850,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks.py",
      "position" : 44,
      "pull_request_review_id" : 1434245421,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1198846834/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-19T11:15:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1198846834",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1199687717"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1199687717"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Should be `!pfrom.IsInboundConn()` presumably, to include manual connections at least.",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-21T03:05:17Z",
      "diff_hunk" : "@@ -4338,9 +4386,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                     txn.blockhash = blockhash;\n                     blockTxnMsg << txn;\n                     fProcessBLOCKTXN = true;\n-                } else {\n+                } else if (first_in_flight) {\n+                    // We will try to round-trip any compact blocks we get on failure,\n+                    // as long as it's first...\n                     req.blockhash = pindex->GetBlockHash();\n                     m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::GETBLOCKTXN, req));\n+                } else if (pfrom.m_bip152_highbandwidth_to &&\n+                    (!nodestate->m_is_inbound ||",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1199687717",
      "id" : 1199687717,
      "in_reply_to_id" : 1198642367,
      "line" : 4395,
      "node_id" : "PRRC_kwDOABII585Hgcgl",
      "original_commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "original_line" : 4395,
      "original_position" : 275,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 275,
      "pull_request_review_id" : 1435466960,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1199687717/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-21T03:05:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1199687717",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1199689963"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1199689963"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "missing `assert` here",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-21T03:36:01Z",
      "diff_hunk" : "@@ -823,12 +827,100 @@ def assert_highbandwidth_states(node, hb_to, hb_from):\n         hb_test_node.send_and_ping(msg_sendcmpct(announce=False, version=2))\n         assert_highbandwidth_states(self.nodes[0], hb_to=True, hb_from=False)\n \n+    def test_compactblock_reconstruction_parallel_reconstruction(self, stalling_peer, delivery_peer, inbound_peer, outbound_peer):\n+        \"\"\" All p2p connections are inbound except outbound_peer. We test that ultimate parallel slot\n+            can only be taken by an outbound node unless prior attempts were done by an outbound\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert len(self.utxos)\n+\n+        def announce_cmpct_block(node, peer, txn_count):\n+            utxo = self.utxos.pop(0)\n+            block = self.build_block_with_transactions(node, utxo, txn_count)\n+\n+            cmpct_block = HeaderAndShortIDs()\n+            cmpct_block.initialize_from_block(block)\n+            msg = msg_cmpctblock(cmpct_block.to_p2p())\n+            peer.send_and_ping(msg)\n+            with p2p_lock:\n+                assert \"getblocktxn\" in peer.last_message\n+            return block, cmpct_block\n+\n+        # First, make delivery_peer, inbound_peer, and outbound_peer high bandwidth\n+        block, cmpct_block = announce_cmpct_block(node, delivery_peer, 1)\n+        msg = msg_blocktxn()\n+        msg.block_transactions.blockhash = block.sha256\n+        msg.block_transactions.transactions = block.vtx[1:]\n+        delivery_peer.send_and_ping(msg)\n+        assert_equal(int(node.getbestblockhash(), 16), block.sha256)\n+        delivery_peer.clear_getblocktxn()\n+\n+        block, cmpct_block = announce_cmpct_block(node, inbound_peer, 1)\n+        msg = msg_blocktxn()\n+        msg.block_transactions.blockhash = block.sha256\n+        msg.block_transactions.transactions = block.vtx[1:]\n+        inbound_peer.send_and_ping(msg)\n+        assert_equal(int(node.getbestblockhash(), 16), block.sha256)\n+        inbound_peer.clear_getblocktxn()\n+\n+        block, cmpct_block = announce_cmpct_block(node, outbound_peer, 1)\n+        msg = msg_blocktxn()\n+        msg.block_transactions.blockhash = block.sha256\n+        msg.block_transactions.transactions = block.vtx[1:]\n+        outbound_peer.send_and_ping(msg)\n+        assert_equal(int(node.getbestblockhash(), 16), block.sha256)\n+        outbound_peer.clear_getblocktxn()\n+\n+        # Test the simple parallel download case...\n+        for num_missing in [1, 5, 20]:\n+\n+            # Remaining low-bandwidth peer is stalling_peer, who announces first\n+            [peer['bip152_hb_to'] for peer in node.getpeerinfo()] == [False, True, True, True]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1199689963",
      "id" : 1199689963,
      "line" : 878,
      "node_id" : "PRRC_kwDOABII585HgdDr",
      "original_commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "original_line" : 878,
      "original_position" : 72,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks.py",
      "position" : 72,
      "pull_request_review_id" : 1435468460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1199689963/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-21T21:21:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1199689963",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1199822582"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1199822582"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: `already_in_flight` could be just a bool here",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-21T20:23:30Z",
      "diff_hunk" : "@@ -4456,18 +4496,23 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         {\n             LOCK(cs_main);\n \n-            bool expected_blocktxn = false;\n             auto range_flight = mapBlocksInFlight.equal_range(resp.blockhash);\n+            size_t already_in_flight = std::distance(range_flight.first, range_flight.second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1199822582",
      "id" : 1199822582,
      "line" : 4500,
      "node_id" : "PRRC_kwDOABII585Hg9b2",
      "original_commit_id" : "620b3f54830579ef48a2374e5b0bc4b2fba9dcc4",
      "original_line" : 4500,
      "original_position" : 170,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 307,
      "pull_request_review_id" : 1435468460,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1199822582/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-21T21:21:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1199822582",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> In particular, I wonder if the fact that we'll now try additional peers will lead to redundancies / increased traffic under non-adversarial conditions where there's no staller but delivering the block just needs some time - especially when blocks contain a large number of txns that weren't in our mempool, or on slower networks like Tor. Did you consider the possibility of giving the original peer a few seconds to deliver before requesting from additional peers?\r\n\r\nYeah, this is the behaviour I'm seeing --\r\n\r\n```\r\n# peer=3 first reports it\r\n2023-05-22T03:13:48.490251Z Saw new header hash=000000000000000000028a6e01ad99705343eea1ff85e43aa580bbae52a3a8ab height=790827\r\n2023-05-22T03:13:48.490389Z [net] Saw new cmpctblock header hash=000000000000000000028a6e01ad99705343eea1ff85e43aa580bbae52a3a8ab peer=3\r\n2023-05-22T03:13:48.512908Z [cmpctblock] Initialized PartiallyDownloadedBlock for block 000000000000000000028a6e01ad99705343eea1ff85e43aa580bbae52a3a8ab using a cmpctblock of size 18890\r\n2023-05-22T03:13:48.513282Z [net] sending getblocktxn (35 bytes) peer=3\r\n\r\n# peer=11 0.2s later\r\n2023-05-22T03:13:48.740077Z [net] received: cmpctblock (18890 bytes) peer=11\r\n2023-05-22T03:13:48.761214Z [cmpctblock] Initialized PartiallyDownloadedBlock for block 000000000000000000028a6e01ad99705343eea1ff85e43aa580bbae52a3a8ab using a cmpctblock of size 18890\r\n2023-05-22T03:13:48.761562Z [net] sending getblocktxn (35 bytes) peer=11\r\n\r\n# peer=9 another 0.2s later\r\n2023-05-22T03:13:48.946673Z [net] received: cmpctblock (18890 bytes) peer=9\r\n2023-05-22T03:13:48.968735Z [cmpctblock] Initialized PartiallyDownloadedBlock for block 000000000000000000028a6e01ad99705343eea1ff85e43aa580bbae52a3a8ab using a cmpctblock of size 18890\r\n2023-05-22T03:13:48.969097Z [net] sending getblocktxn (35 bytes) peer=9\r\n\r\n# peer=11 responds first\r\n2023-05-22T03:13:49.051028Z [net] received: blocktxn (97486 bytes) peer=11\r\n2023-05-22T03:13:49.055872Z [cmpctblock]   blocktxn peer=11 tx=f401366ed3a40be59923388aa5e58d90c921ac162a92d14a573d24553ba0ce65\r\n2023-05-22T03:13:49.055891Z [cmpctblock]   blocktxn peer=11 tx=5ebf80ab6ac479bd3568cf9d1575c62b94aaf8bace4058970ca5e3e35a3b0ab1\r\n2023-05-22T03:13:49.081909Z [cmpctblock] Successfully reconstructed block 000000000000000000028a6e01ad99705343eea1ff85e43aa580bbae52a3a8ab with 1 txn prefilled, 3078 txn from mempool (incl at least 0 from extra pool) and 2 txn requested\r\n\r\n# then peer=3 about 0.4s later\r\n2023-05-22T03:13:49.457226Z [net] received: blocktxn (97486 bytes) peer=3\r\n2023-05-22T03:13:49.461365Z [net] Peer 3 sent us block transactions for block we weren't expecting\r\n\r\n# then peer=9 about 0.14s later\r\n2023-05-22T03:13:49.600309Z [net] received: blocktxn (97486 bytes) peer=9\r\n2023-05-22T03:13:49.604364Z [net] Peer 9 sent us block transactions for block we weren't expecting\r\n```\r\n\r\nFor block 790788 I received two 1.5MB blocktxn messages:\r\n\r\n```\r\n2023-05-21T20:02:38.285186Z Saw new header hash=000000000000000000023a845351079f13015d10aa55003d30e7589e597caa2a height=790788\r\n2023-05-21T20:02:38.285264Z [net] Saw new cmpctblock header hash=000000000000000000023a845351079f13015d10aa55003d30e7589e597caa2a peer=3\r\n\r\n# peer=9 announces 0.3s later\r\n2023-05-21T20:02:38.659630Z [net] received: cmpctblock (4129 bytes) peer=9\r\n2023-05-21T20:02:38.679677Z [cmpctblock] Initialized PartiallyDownloadedBlock for block 000000000000000000023a845351079f13015d10aa55003d30e7589e597caa2a using a cmpctblock of size 4129\r\n\r\n# peer=3 took ~2s to respond\r\n2023-05-21T20:02:40.240719Z [net] received: blocktxn (1541605 bytes) peer=3\r\n2023-05-21T20:02:43.332966Z UpdateTip: new best=000000000000000000023a845351079f13015d10aa55003d30e7589e597caa2a height=790788 version=0x20014000 log2_work=94.193595 tx=841476965 date='2023-05-21T20:01:57Z' progress=1.000000 cache=26.9MiB(224222txo)\r\n\r\n# peer=9 took ~7s to respond\r\n2023-05-21T20:02:45.830208Z [net] received: blocktxn (1541605 bytes) peer=9\r\n2023-05-21T20:02:45.893063Z [net] Peer 9 sent us block transactions for block we weren't expecting\r\n```\r\n\r\n(EDIT: that [block](https://mempool.space/block/000000000000000000023a845351079f13015d10aa55003d30e7589e597caa2a) had a bunch of large, low feerate consolidation txs that are below mempool minfee so aren't eligible for cpfp. One I looked at seems to have been first broadcast around 4th May, perhaps)\r\n\r\nIn that case, if peer=9 had announced first, and I'd waited 5s before requesting for peer=3, I'd still have doubled up the 1.5MB response, and not gotten either respond until 7s after the announcement. But at least there would have been a maybe 50% chance of avoiding the second request entirely.\r\n\r\nTripling the outgoing bandwidth load for peers selected for hb compact block relay seems concerning; not sure if I'd call it a blocker though.",
      "created_at" : "2023-05-22T05:18:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#issuecomment-1556553095",
      "id" : 1556553095,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27626",
      "node_id" : "IC_kwDOABII585cxx2H",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1556553095/reactions"
      },
      "updated_at" : "2023-05-22T05:35:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1556553095",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1200117089"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200117089"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't understand this logic -- why is having an outbound attempt in flight so terrible that we'll query all subsequent hb peers, even to the point of exceeding the parallel download limit? If outbound attempts are terrible, why do we also have an exception to immediately query hb outbound peers, also to the point of potentially exceeding the parallel download limit?\r\n\r\nI would have expected logic more like:\r\n * is this the first attempt?\r\n * otherwise, is this a hb peer, and `already_in_flight < MAX-1` ? \r\n * otherwise, is this an outbound peer, and `already_in_flight < MAX` ? (ie, reserving the last slot for an outbound peer, possibly additional to one-or-more existing outbound peers)\r\n\r\nOr alternatively:\r\n * is this the first attempt?\r\n * is this a hb inbound peer, and `already_in_flight < MAX` ?\r\n * is this an outbound peer, are there no other outbound peers in flight? (ie request from all the hb inbound peers, and one outbound peer hb or not, avoiding putting an increased load on outbound peers)",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-22T08:04:53Z",
      "diff_hunk" : "@@ -4338,9 +4386,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                     txn.blockhash = blockhash;\n                     blockTxnMsg << txn;\n                     fProcessBLOCKTXN = true;\n-                } else {\n+                } else if (first_in_flight) {\n+                    // We will try to round-trip any compact blocks we get on failure,\n+                    // as long as it's first...\n                     req.blockhash = pindex->GetBlockHash();\n                     m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::GETBLOCKTXN, req));\n+                } else if (pfrom.m_bip152_highbandwidth_to &&\n+                    (!nodestate->m_is_inbound ||\n+                    IsBlockRequestedFromOutbound(blockhash) ||\n+                    already_in_flight < MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK - 1)) {\n+                    // ... or it's a hb relay peer and:\n+                    // - peer is outbound, or\n+                    // - we already have an outbound attempt in flight(so we'll take what we can get), or\n+                    // - it's not the final parallel download slot (which we may reserve for first outbound)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1200117089",
      "id" : 1200117089,
      "line" : 4401,
      "node_id" : "PRRC_kwDOABII585HiFVh",
      "original_commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "original_line" : 4401,
      "original_position" : 281,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 281,
      "pull_request_review_id" : 1436019702,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200117089/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-22T09:10:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200117089",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@mzumsande  This is a delicate trade-off as you're aware.\r\n\r\n> delivering the block just needs some time \r\n\r\nThere's a lot of mix and match we can likely do to improve the bandwidth usage, probably with only a small delay in block propagation. There are block timeouts, yes, but we also care about block prop speed for mining fairness(e.g., selfish mining attacks). So maybe there can be 2 buckets for each type of issue.\r\n\r\ne.g.,\r\n1) first or second slot must have outbound peer (best effort to keep blocks fast)\r\n2) third request is only dispatched after 5s delay (don't let node get unduly timed out)\r\n\r\nObviously a bit more complexity, but the linked issue can stay open and discussion continue with metrics?\r\n\r\nIn other words, I don't want a trivial sybil attacker to be able to slow down blocks at all listening nodes by 5 seconds each hop. That would be pretty bad for mining fairness. ",
      "created_at" : "2023-05-22T10:54:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#issuecomment-1557002308",
      "id" : 1557002308,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27626",
      "node_id" : "IC_kwDOABII585czfhE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1557002308/reactions"
      },
      "updated_at" : "2023-05-22T11:04:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1557002308",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1200353306"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200353306"
         }
      },
      "author_association" : "MEMBER",
      "body" : "https://github.com/bitcoin/bitcoin/pull/27626/files#diff-6875de769e90cec84d2e8a9c1b962cdbcda44d870d42e4215827e599e11e90e3R4346 <--- this line will filter out any attempts beyond 3.\r\n\r\nSo implicitly each of these conditions in this block hold with `already_in_flight < MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK`\r\n\r\nI could touch up my comments, add some `Assume`s to make things clearer, if indeed the code is doing what I think it is.",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-22T11:01:44Z",
      "diff_hunk" : "@@ -4338,9 +4386,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                     txn.blockhash = blockhash;\n                     blockTxnMsg << txn;\n                     fProcessBLOCKTXN = true;\n-                } else {\n+                } else if (first_in_flight) {\n+                    // We will try to round-trip any compact blocks we get on failure,\n+                    // as long as it's first...\n                     req.blockhash = pindex->GetBlockHash();\n                     m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::GETBLOCKTXN, req));\n+                } else if (pfrom.m_bip152_highbandwidth_to &&\n+                    (!nodestate->m_is_inbound ||\n+                    IsBlockRequestedFromOutbound(blockhash) ||\n+                    already_in_flight < MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK - 1)) {\n+                    // ... or it's a hb relay peer and:\n+                    // - peer is outbound, or\n+                    // - we already have an outbound attempt in flight(so we'll take what we can get), or\n+                    // - it's not the final parallel download slot (which we may reserve for first outbound)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1200353306",
      "id" : 1200353306,
      "in_reply_to_id" : 1200117089,
      "line" : 4401,
      "node_id" : "PRRC_kwDOABII585Hi_Aa",
      "original_commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "original_line" : 4401,
      "original_position" : 281,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 281,
      "pull_request_review_id" : 1436374948,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200353306/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-22T11:01:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200353306",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1200362883"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200362883"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Well I was right in saying \"I don't understand this logic\" -- it's just about reserving the \"final\" slot for the outbound peer.",
      "commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "created_at" : "2023-05-22T11:09:16Z",
      "diff_hunk" : "@@ -4338,9 +4386,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                     txn.blockhash = blockhash;\n                     blockTxnMsg << txn;\n                     fProcessBLOCKTXN = true;\n-                } else {\n+                } else if (first_in_flight) {\n+                    // We will try to round-trip any compact blocks we get on failure,\n+                    // as long as it's first...\n                     req.blockhash = pindex->GetBlockHash();\n                     m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::GETBLOCKTXN, req));\n+                } else if (pfrom.m_bip152_highbandwidth_to &&\n+                    (!nodestate->m_is_inbound ||\n+                    IsBlockRequestedFromOutbound(blockhash) ||\n+                    already_in_flight < MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK - 1)) {\n+                    // ... or it's a hb relay peer and:\n+                    // - peer is outbound, or\n+                    // - we already have an outbound attempt in flight(so we'll take what we can get), or\n+                    // - it's not the final parallel download slot (which we may reserve for first outbound)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1200362883",
      "id" : 1200362883,
      "in_reply_to_id" : 1200117089,
      "line" : 4401,
      "node_id" : "PRRC_kwDOABII585HjBWD",
      "original_commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "original_line" : 4401,
      "original_position" : 281,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 281,
      "pull_request_review_id" : 1436387814,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200362883/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-22T11:09:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200362883",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1200426349"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200426349"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I guess I think it might be better to not do multiple parallel requests to outbound peers (on the one hand hopefully your outbounds are trustworthy and will respond quickly; on the other hand it's undesirable if listening nodes end up having to send up to 3x as much data when non-listening nodes request blocktxns from all their hb peers), but otherwise this makes sense.",
      "commit_id" : "3b57b2b8d958871bec9a33953be051a75d8bf07c",
      "created_at" : "2023-05-22T12:08:42Z",
      "diff_hunk" : "@@ -4338,9 +4386,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                     txn.blockhash = blockhash;\n                     blockTxnMsg << txn;\n                     fProcessBLOCKTXN = true;\n-                } else {\n+                } else if (first_in_flight) {\n+                    // We will try to round-trip any compact blocks we get on failure,\n+                    // as long as it's first...\n                     req.blockhash = pindex->GetBlockHash();\n                     m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::GETBLOCKTXN, req));\n+                } else if (pfrom.m_bip152_highbandwidth_to &&\n+                    (!nodestate->m_is_inbound ||\n+                    IsBlockRequestedFromOutbound(blockhash) ||\n+                    already_in_flight < MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK - 1)) {\n+                    // ... or it's a hb relay peer and:\n+                    // - peer is outbound, or\n+                    // - we already have an outbound attempt in flight(so we'll take what we can get), or\n+                    // - it's not the final parallel download slot (which we may reserve for first outbound)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1200426349",
      "id" : 1200426349,
      "in_reply_to_id" : 1200117089,
      "line" : 4399,
      "node_id" : "PRRC_kwDOABII585HjQ1t",
      "original_commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "original_line" : 4399,
      "original_position" : 281,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 279,
      "pull_request_review_id" : 1436489956,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200426349/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-22T12:08:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200426349",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1200499146"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200499146"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "3b57b2b8d958871bec9a33953be051a75d8bf07c",
      "created_at" : "2023-05-22T13:11:40Z",
      "diff_hunk" : "@@ -823,12 +827,100 @@ def assert_highbandwidth_states(node, hb_to, hb_from):\n         hb_test_node.send_and_ping(msg_sendcmpct(announce=False, version=2))\n         assert_highbandwidth_states(self.nodes[0], hb_to=True, hb_from=False)\n \n+    def test_compactblock_reconstruction_parallel_reconstruction(self, stalling_peer, delivery_peer, inbound_peer, outbound_peer):\n+        \"\"\" All p2p connections are inbound except outbound_peer. We test that ultimate parallel slot\n+            can only be taken by an outbound node unless prior attempts were done by an outbound\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert len(self.utxos)\n+\n+        def announce_cmpct_block(node, peer, txn_count):\n+            utxo = self.utxos.pop(0)\n+            block = self.build_block_with_transactions(node, utxo, txn_count)\n+\n+            cmpct_block = HeaderAndShortIDs()\n+            cmpct_block.initialize_from_block(block)\n+            msg = msg_cmpctblock(cmpct_block.to_p2p())\n+            peer.send_and_ping(msg)\n+            with p2p_lock:\n+                assert \"getblocktxn\" in peer.last_message\n+            return block, cmpct_block\n+\n+        # First, make delivery_peer, inbound_peer, and outbound_peer high bandwidth\n+        block, cmpct_block = announce_cmpct_block(node, delivery_peer, 1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1200499146",
      "id" : 1200499146,
      "in_reply_to_id" : 1198247881,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HjinK",
      "original_commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "original_line" : 850,
      "original_position" : 44,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks.py",
      "position" : null,
      "pull_request_review_id" : 1436604617,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200499146/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-22T13:11:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200499146",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1200499309"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200499309"
         }
      },
      "author_association" : "MEMBER",
      "body" : "took @ajtowns suggestion",
      "commit_id" : "3b57b2b8d958871bec9a33953be051a75d8bf07c",
      "created_at" : "2023-05-22T13:11:48Z",
      "diff_hunk" : "@@ -4338,9 +4386,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                     txn.blockhash = blockhash;\n                     blockTxnMsg << txn;\n                     fProcessBLOCKTXN = true;\n-                } else {\n+                } else if (first_in_flight) {\n+                    // We will try to round-trip any compact blocks we get on failure,\n+                    // as long as it's first...\n                     req.blockhash = pindex->GetBlockHash();\n                     m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::GETBLOCKTXN, req));\n+                } else if (pfrom.m_bip152_highbandwidth_to &&\n+                    (!nodestate->m_is_inbound ||",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1200499309",
      "id" : 1200499309,
      "in_reply_to_id" : 1198642367,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Hjipt",
      "original_commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "original_line" : 4395,
      "original_position" : 275,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1436604864,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200499309/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-22T13:11:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200499309",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1200499376"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200499376"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "3b57b2b8d958871bec9a33953be051a75d8bf07c",
      "created_at" : "2023-05-22T13:11:52Z",
      "diff_hunk" : "@@ -1117,40 +1121,57 @@ std::chrono::microseconds PeerManagerImpl::NextInvToInbounds(std::chrono::micros\n \n bool PeerManagerImpl::IsBlockRequested(const uint256& hash)\n {\n-    return mapBlocksInFlight.find(hash) != mapBlocksInFlight.end();\n+    return mapBlocksInFlight.count(hash);\n }\n \n-void PeerManagerImpl::RemoveBlockRequest(const uint256& hash, std::optional<NodeId> from_peer)\n+bool PeerManagerImpl::IsBlockRequestedFromOutbound(const uint256& hash)\n {\n-    auto it = mapBlocksInFlight.find(hash);\n-    if (it == mapBlocksInFlight.end()) {\n-        // Block was not requested\n-        return;\n+    for (auto range = mapBlocksInFlight.equal_range(hash); range.first != range.second; range.first++) {\n+        auto [nodeid, block_it] = range.first->second;\n+        CNodeState *nodestate = State(nodeid);\n+        assert(nodestate);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1200499376",
      "id" : 1200499376,
      "in_reply_to_id" : 1198645480,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Hjiqw",
      "original_commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "original_line" : 1132,
      "original_position" : 47,
      "original_start_line" : 1131,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1436604974,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200499376/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-05-22T13:11:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200499376",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1200499431"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200499431"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "3b57b2b8d958871bec9a33953be051a75d8bf07c",
      "created_at" : "2023-05-22T13:11:54Z",
      "diff_hunk" : "@@ -1117,40 +1121,57 @@ std::chrono::microseconds PeerManagerImpl::NextInvToInbounds(std::chrono::micros\n \n bool PeerManagerImpl::IsBlockRequested(const uint256& hash)\n {\n-    return mapBlocksInFlight.find(hash) != mapBlocksInFlight.end();\n+    return mapBlocksInFlight.count(hash);\n }\n \n-void PeerManagerImpl::RemoveBlockRequest(const uint256& hash, std::optional<NodeId> from_peer)\n+bool PeerManagerImpl::IsBlockRequestedFromOutbound(const uint256& hash)\n {\n-    auto it = mapBlocksInFlight.find(hash);\n-    if (it == mapBlocksInFlight.end()) {\n-        // Block was not requested\n-        return;\n+    for (auto range = mapBlocksInFlight.equal_range(hash); range.first != range.second; range.first++) {\n+        auto [nodeid, block_it] = range.first->second;\n+        CNodeState *nodestate = State(nodeid);\n+        assert(nodestate);\n+        if (!nodestate->m_is_inbound) return true;\n     }\n \n-    auto [node_id, list_it] = it->second;\n+    return false;\n+}\n \n-    if (from_peer && node_id != *from_peer) {\n-        // Block was requested by another peer\n+void PeerManagerImpl::RemoveBlockRequest(const uint256& hash, std::optional<NodeId> from_peer)\n+{\n+    auto range = mapBlocksInFlight.equal_range(hash);\n+    if (range.first == range.second) {\n+        // Block was not requested from any peer\n         return;\n     }\n \n-    CNodeState *state = State(node_id);\n-    assert(state != nullptr);\n+    // We should not have requested too many of this block\n+    Assume(mapBlocksInFlight.count(hash) <= MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK);\n \n-    if (state->vBlocksInFlight.begin() == list_it) {\n-        // First block on the queue was received, update the start download time for the next one\n-        state->m_downloading_since = std::max(state->m_downloading_since, GetTime<std::chrono::microseconds>());\n-    }\n-    state->vBlocksInFlight.erase(list_it);\n+    while (range.first != range.second) {\n+        auto [node_id, list_it] = range.first->second;\n+\n+        if (from_peer && *from_peer != node_id) {\n+            range.first++;\n+            continue;\n+        }\n \n-    state->nBlocksInFlight--;\n-    if (state->nBlocksInFlight == 0) {\n-        // Last validated block on the queue was received.\n-        m_peers_downloading_from--;\n+        CNodeState *state = State(node_id);\n+        assert(state != nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1200499431",
      "id" : 1200499431,
      "in_reply_to_id" : 1198646710,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Hjirn",
      "original_commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "original_line" : 1159,
      "original_position" : 88,
      "original_start_line" : 1158,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1436605069,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200499431/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-05-22T13:11:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200499431",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1200499502"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200499502"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed",
      "commit_id" : "3b57b2b8d958871bec9a33953be051a75d8bf07c",
      "created_at" : "2023-05-22T13:11:58Z",
      "diff_hunk" : "@@ -823,12 +827,100 @@ def assert_highbandwidth_states(node, hb_to, hb_from):\n         hb_test_node.send_and_ping(msg_sendcmpct(announce=False, version=2))\n         assert_highbandwidth_states(self.nodes[0], hb_to=True, hb_from=False)\n \n+    def test_compactblock_reconstruction_parallel_reconstruction(self, stalling_peer, delivery_peer, inbound_peer, outbound_peer):\n+        \"\"\" All p2p connections are inbound except outbound_peer. We test that ultimate parallel slot\n+            can only be taken by an outbound node unless prior attempts were done by an outbound\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert len(self.utxos)\n+\n+        def announce_cmpct_block(node, peer, txn_count):\n+            utxo = self.utxos.pop(0)\n+            block = self.build_block_with_transactions(node, utxo, txn_count)\n+\n+            cmpct_block = HeaderAndShortIDs()\n+            cmpct_block.initialize_from_block(block)\n+            msg = msg_cmpctblock(cmpct_block.to_p2p())\n+            peer.send_and_ping(msg)\n+            with p2p_lock:\n+                assert \"getblocktxn\" in peer.last_message\n+            return block, cmpct_block\n+\n+        # First, make delivery_peer, inbound_peer, and outbound_peer high bandwidth\n+        block, cmpct_block = announce_cmpct_block(node, delivery_peer, 1)\n+        msg = msg_blocktxn()\n+        msg.block_transactions.blockhash = block.sha256\n+        msg.block_transactions.transactions = block.vtx[1:]\n+        delivery_peer.send_and_ping(msg)\n+        assert_equal(int(node.getbestblockhash(), 16), block.sha256)\n+        delivery_peer.clear_getblocktxn()\n+\n+        block, cmpct_block = announce_cmpct_block(node, inbound_peer, 1)\n+        msg = msg_blocktxn()\n+        msg.block_transactions.blockhash = block.sha256\n+        msg.block_transactions.transactions = block.vtx[1:]\n+        inbound_peer.send_and_ping(msg)\n+        assert_equal(int(node.getbestblockhash(), 16), block.sha256)\n+        inbound_peer.clear_getblocktxn()\n+\n+        block, cmpct_block = announce_cmpct_block(node, outbound_peer, 1)\n+        msg = msg_blocktxn()\n+        msg.block_transactions.blockhash = block.sha256\n+        msg.block_transactions.transactions = block.vtx[1:]\n+        outbound_peer.send_and_ping(msg)\n+        assert_equal(int(node.getbestblockhash(), 16), block.sha256)\n+        outbound_peer.clear_getblocktxn()\n+\n+        # Test the simple parallel download case...\n+        for num_missing in [1, 5, 20]:\n+\n+            # Remaining low-bandwidth peer is stalling_peer, who announces first\n+            [peer['bip152_hb_to'] for peer in node.getpeerinfo()] == [False, True, True, True]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1200499502",
      "id" : 1200499502,
      "in_reply_to_id" : 1199689963,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Hjisu",
      "original_commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "original_line" : 878,
      "original_position" : 72,
      "original_start_line" : null,
      "path" : "test/functional/p2p_compactblocks.py",
      "position" : null,
      "pull_request_review_id" : 1436605199,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200499502/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-22T13:11:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200499502",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1200499579"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200499579"
         }
      },
      "author_association" : "MEMBER",
      "body" : "leaving as-is, reads more naturally to me",
      "commit_id" : "3b57b2b8d958871bec9a33953be051a75d8bf07c",
      "created_at" : "2023-05-22T13:12:01Z",
      "diff_hunk" : "@@ -4456,18 +4496,23 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         {\n             LOCK(cs_main);\n \n-            bool expected_blocktxn = false;\n             auto range_flight = mapBlocksInFlight.equal_range(resp.blockhash);\n+            size_t already_in_flight = std::distance(range_flight.first, range_flight.second);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1200499579",
      "id" : 1200499579,
      "in_reply_to_id" : 1199822582,
      "line" : 4498,
      "node_id" : "PRRC_kwDOABII585Hjit7",
      "original_commit_id" : "620b3f54830579ef48a2374e5b0bc4b2fba9dcc4",
      "original_line" : 4498,
      "original_position" : 170,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 305,
      "pull_request_review_id" : 1436605315,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200499579/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-22T13:12:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200499579",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1200500047"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200500047"
         }
      },
      "author_association" : "MEMBER",
      "body" : "added more clarifying comment and an `Assume` for now",
      "commit_id" : "3b57b2b8d958871bec9a33953be051a75d8bf07c",
      "created_at" : "2023-05-22T13:12:26Z",
      "diff_hunk" : "@@ -4338,9 +4386,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                     txn.blockhash = blockhash;\n                     blockTxnMsg << txn;\n                     fProcessBLOCKTXN = true;\n-                } else {\n+                } else if (first_in_flight) {\n+                    // We will try to round-trip any compact blocks we get on failure,\n+                    // as long as it's first...\n                     req.blockhash = pindex->GetBlockHash();\n                     m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::GETBLOCKTXN, req));\n+                } else if (pfrom.m_bip152_highbandwidth_to &&\n+                    (!nodestate->m_is_inbound ||\n+                    IsBlockRequestedFromOutbound(blockhash) ||\n+                    already_in_flight < MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK - 1)) {\n+                    // ... or it's a hb relay peer and:\n+                    // - peer is outbound, or\n+                    // - we already have an outbound attempt in flight(so we'll take what we can get), or\n+                    // - it's not the final parallel download slot (which we may reserve for first outbound)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1200500047",
      "id" : 1200500047,
      "in_reply_to_id" : 1200117089,
      "line" : 4399,
      "node_id" : "PRRC_kwDOABII585Hji1P",
      "original_commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "original_line" : 4399,
      "original_position" : 281,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 279,
      "pull_request_review_id" : 1436606101,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200500047/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-22T13:12:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200500047",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1200509401"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200509401"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> I guess I think it might be better to not do multiple parallel requests to outbound peers\r\n\r\nThat makes some sense since using an outbound is mostly for the anti-sybil portion of the reasoning. Once we have an outbound hb peer, they're likely highly reliable, and we probably don't need to try so hard for other connections. Maybe even allow only up to two attempts if we already have an outbound in flight.",
      "commit_id" : "3b57b2b8d958871bec9a33953be051a75d8bf07c",
      "created_at" : "2023-05-22T13:20:12Z",
      "diff_hunk" : "@@ -4338,9 +4386,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                     txn.blockhash = blockhash;\n                     blockTxnMsg << txn;\n                     fProcessBLOCKTXN = true;\n-                } else {\n+                } else if (first_in_flight) {\n+                    // We will try to round-trip any compact blocks we get on failure,\n+                    // as long as it's first...\n                     req.blockhash = pindex->GetBlockHash();\n                     m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::GETBLOCKTXN, req));\n+                } else if (pfrom.m_bip152_highbandwidth_to &&\n+                    (!nodestate->m_is_inbound ||\n+                    IsBlockRequestedFromOutbound(blockhash) ||\n+                    already_in_flight < MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK - 1)) {\n+                    // ... or it's a hb relay peer and:\n+                    // - peer is outbound, or\n+                    // - we already have an outbound attempt in flight(so we'll take what we can get), or\n+                    // - it's not the final parallel download slot (which we may reserve for first outbound)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27626#discussion_r1200509401",
      "id" : 1200509401,
      "in_reply_to_id" : 1200117089,
      "line" : 4399,
      "node_id" : "PRRC_kwDOABII585HjlHZ",
      "original_commit_id" : "42c2696ae58e07de005edf1dda952761f8c9008e",
      "original_line" : 4399,
      "original_position" : 281,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 279,
      "pull_request_review_id" : 1436621880,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27626",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200509401/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-22T13:20:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1200509401",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   }
]
