[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [dergoegge](https://github.com/bitcoin/bitcoin/pull/27630#issuecomment-1545662869) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n",
      "created_at" : "2023-05-11T16:58:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27630#issuecomment-1544349717",
      "id" : 1544349717,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27630",
      "node_id" : "IC_kwDOABII585cDOgV",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544349717/reactions"
      },
      "updated_at" : "2023-05-12T12:25:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1544349717",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK - 7 tx/s seems outdated\r\n\r\nIt would be nice if we had a proper simulation framework for stuff like this. For example, what would happen during a mempool storm like we had this past week, if only a portion (e.g. 50%) of the network upgrades to this patch? Would that increase the load on the nodes that are still clearing their relay queues at only 7 tx/s (ignoring #27610 here)?",
      "created_at" : "2023-05-12T12:25:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27630#issuecomment-1545662869",
      "id" : 1545662869,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27630",
      "node_id" : "IC_kwDOABII585cIPGV",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1545662869/reactions"
      },
      "updated_at" : "2023-05-12T12:25:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1545662869",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "When this limit was introduced in https://github.com/bitcoin/bitcoin/commit/f2d3ba73860e875972738d1da1507124d0971ae5 it was pointed out that the _per-peer_ rate doesn't have to be that high:\r\n\r\n> Limits the amount of transactions sent in a single INV to\r\n  7tx/sec (and twice that for outbound); this limits the\r\n  harm of low fee transaction floods, gives faster relay\r\n  service to higher fee transactions. The 7 sounds lower\r\n  than it really is because received advertisements need\r\n  not be sent, and because the aggregate rate is multipled\r\n  by the number of peers.\r\n\r\n\r\nAn alternative - or complimentary; it's not incompatible - approach I had in mind was to randomly drop half of `m_recently_announced_invs` if it exceeds some maximum size (e.g. 30 minutes at max throughput). This essentially splits the load between peers during moments of peak throughput, without permanently dropping much. This could be done _after_ we constructed the next `INV` (which already filters some stuff we don't need anymore).\r\n\r\n\r\nWhat worries me about just increasing the tx relay rate is that it increases the total worst-case bandwidth on the network.\r\n\r\nOn the other hand, not increasing it could mean that your mempool can't keep up with the next block if it only has a single peer. That in turn would hurt (compact) block relay. But for outbound we already allow double the rate, and we always try to have 8+ of those. So I'm not sure if that's really a problem.",
      "created_at" : "2023-05-12T16:27:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27630#issuecomment-1545997858",
      "id" : 1545997858,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27630",
      "node_id" : "IC_kwDOABII585cJg4i",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1545997858/reactions"
      },
      "updated_at" : "2023-05-12T16:34:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1545997858",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : ">  randomly drop half of `m_recently_announced_invs` if it exceeds some maximum size\r\n\r\nI just realized this would act as a shredder on clusters. Some peers would only get the parent (that's fine), but (for n > 2 clusters) most would get children for which they don't have the parent yet.\r\n\r\nSo any kind of load distribution between peers would have to be done per cluster. Perhaps by randomly dropping clusters until the queue is at an acceptable size. Or by coordinating the distribution globally for all peers. This sound a lot more complicated.\r\n\r\nWe could also drop the lower half of the queue. This gives preferential relay treatment to things at the top of the mempool; I don't know if that's bad or not.",
      "created_at" : "2023-05-13T07:07:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27630#issuecomment-1546551585",
      "id" : 1546551585,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27630",
      "node_id" : "IC_kwDOABII585cLoEh",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1546551585/reactions"
      },
      "updated_at" : "2023-05-13T07:07:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1546551585",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> In the presence of smaller transactions on the network, blocks can sustain a higher relay rate than 7tx/second. \r\n \r\nI agree this limit is too small after segwit. I think plausible datapoints for the rate at which we can sustain confirmable txs across the network might be:\r\n\r\n * pre-segwit, 2-in, 2-out p2pkh: 374 vb, ~4.5 tx/s\r\n * 2-in, 2-out p2wpkh: 208.5 vb, ~8 tx/s\r\n\r\n * pre-segwit, 1-in, 1-out p2pkh: 192 vb, ~8.5 tx/s\r\n * 1-in, 1-out p2wpkh: 109.5 vb, ~15 tx/s\r\n * 1-in p2tr, 1-out p2wpkh: 99 vb, ~16.5 tx/s\r\n\r\n(The 1-in/1-out cases seems the closest justification for the original 7tx/s, and 7:18.5 is pretty similar to 14:16.5, so I'd have just doubled what we have)\r\n\r\nRBF increases these rates by an arbitrary multiple, depending on the difference between the feerate at the top vs bottom of the mempool.\r\n\r\n> In this event, the per-peer inventory queues can grow too large.\r\n\r\nPost #27610 I'm not seeing queues grow excessively large. During bursts where there is a queue (ie I'm sending out invs with 35+ txs), I'm seeing queues of >1000 txs about 20% of the time, and I'm sending out invs in batches of 55 or more (ie >= 11tx/s) about 3% of the time. I think that data probably also suggests a bump would be worthwhile.\r\n\r\n> Using 11 tx/second as an estimate for the max network throughput, this commit bumps the rate up to 22 tx/s (for inbound peers), providing a factor of 2 safety margin.\r\n\r\nI'm not sure this actually provides a safety margin though? I think the queues grow large because of the difference between your inbound tx rate and your outbound tx rate; but if you're operating a listening node, and have other honest peers running the same version of Bitcoin Core, your inbound rate will be up to 2.5x this rate (ie 55 tx/s), which means (some of) your queues might grow at a rate of 33 tx/s instead of 11 tx/s due to the difference between the rate at which you receive txs from one set of inbound peers and the rate at which you send txs to another set of inbound peers. And if you're connected to peers which don't limit the rate they send txs to you, that can again be arbitrarily larger.\r\n\r\nIf we have a good idea of what \"too large\" means for these queues, a better approach to getting a safety margin might be changing the mechanism in #27610 to instead target a specific maximum queue size, and send something along the lines of `35 + q**2/(10m))` txs per inv, where `q` is the queue size and `m` is our specified maximum.\r\n\r\nSo I guess I'd suggest dropping the factor of 2, and just setting it to 11 or 14 tx/s (a 60% or 100% increase on what we currently have), with the corresponding bump for recent invs.",
      "created_at" : "2023-05-15T01:35:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27630#issuecomment-1547072913",
      "id" : 1547072913,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27630",
      "node_id" : "IC_kwDOABII585cNnWR",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1547072913/reactions"
      },
      "updated_at" : "2023-05-15T01:35:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1547072913",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   }
]
