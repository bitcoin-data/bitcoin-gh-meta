[
   {
      "author_association" : "MEMBER",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| Concept ACK | [sdaftuar](https://github.com/bitcoin/bitcoin/pull/27675#issuecomment-1553249207) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#27630](https://github.com/bitcoin/bitcoin/pull/27630) (p2p: Increase tx relay rate by sdaftuar)\n* [#27602](https://github.com/bitcoin/bitcoin/pull/27602) (net processing: avoid serving non-announced txs as a result of a MEMPOOL message by sr-gi)\n* [#27509](https://github.com/bitcoin/bitcoin/pull/27509) (Relay own transactions only via short-lived Tor or I2P connections by vasild)\n* [#26969](https://github.com/bitcoin/bitcoin/pull/26969) (net, refactor: net_processing, add `ProcessCompactBlockTxns` by brunoerg)\n* [#26711](https://github.com/bitcoin/bitcoin/pull/26711) (validate package transactions with their in-package ancestor sets by glozow)\n* [#23962](https://github.com/bitcoin/bitcoin/pull/23962) (Use `int32_t` type for most transaction size/weight values by hebasto)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-05-16T13:45:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27675#issuecomment-1549705895",
      "id" : 1549705895,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27675",
      "node_id" : "IC_kwDOABII585cXqKn",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1549705895/reactions"
      },
      "updated_at" : "2023-05-22T23:06:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1549705895",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "As justification for ignoring the privacy benefits of rate limiting INV messages, consider the following approach: an attacker makes multiple inbound connections to our peer, and upon receiving an INV of txs a,b,c,d,... via one connection immediately announces the same txs on each of its other connections. In that case the next INV we send on some other connection to the attacker will skip those transactions, providing a new unique set. With this approach, the attacker should be able to receive tx announcements from us at many times the 7tx/s limit we originally set.",
      "created_at" : "2023-05-16T13:48:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27675#issuecomment-1549711784",
      "id" : 1549711784,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27675",
      "node_id" : "IC_kwDOABII585cXrmo",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1549711784/reactions"
      },
      "updated_at" : "2023-05-16T13:48:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1549711784",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27675#discussion_r1195220741"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1195220741"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: Looks like this will make inbound peers be treated identical to outbound ones for the purposes of getdata, as long as mapRelay is still around. For in-mempool txs it may be possible to fix by moving the time check outside of `info_for_relay` into this function and returning a nullptr early if the tx is known to not be announced. For non-mempool txs, I don't know.",
      "commit_id" : "71078b35eff1e43dc88203bb4d558b1706210a7d",
      "created_at" : "2023-05-16T14:04:22Z",
      "diff_hunk" : "@@ -2261,26 +2253,17 @@ void PeerManagerImpl::ProcessGetBlockData(CNode& pfrom, Peer& peer, const CInv&\n     }\n }\n \n-CTransactionRef PeerManagerImpl::FindTxForGetData(const Peer::TxRelay& tx_relay, const GenTxid& gtxid, const std::chrono::seconds mempool_req, const std::chrono::seconds now)\n+CTransactionRef PeerManagerImpl::FindTxForGetData(const Peer::TxRelay& tx_relay, const GenTxid& gtxid)\n {\n-    auto txinfo = m_mempool.info(gtxid);\n+    auto txinfo = m_mempool.info_for_relay(gtxid, tx_relay.m_last_inv_send_time);\n     if (txinfo.tx) {\n-        // If a TX could have been INVed in reply to a MEMPOOL request,\n-        // or is older than UNCONDITIONAL_RELAY_DELAY, permit the request\n-        // unconditionally.\n-        if ((mempool_req.count() && txinfo.m_time <= mempool_req) || txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY) {\n-            return std::move(txinfo.tx);\n-        }\n+        return std::move(txinfo.tx);\n     }\n \n-    // Otherwise, the transaction must have been announced recently.\n-    if (tx_relay.m_recently_announced_invs.contains(gtxid.GetHash())) {\n-        // If it was, it can be relayed from either the mempool...\n-        if (txinfo.tx) return std::move(txinfo.tx);\n-        // ... or the relay pool.\n-        auto mi = mapRelay.find(gtxid.GetHash());\n-        if (mi != mapRelay.end()) return mi->second;\n-    }\n+    // Otherwise, the transaction must have been announced recently or removed from the mempool.\n+    // If the latter, maybe it's in mapRelay!",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27675#discussion_r1195220741",
      "id" : 1195220741,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HPZ8F",
      "original_commit_id" : "9607a5078dbb6a65913055cf36a14c6e07229309",
      "original_line" : 2264,
      "original_position" : 91,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1428669748,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27675",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1195220741/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-16T15:44:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1195220741",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27675#discussion_r1195225774"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1195225774"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: My recommendation would be to not rename the method, or if you want, to pick `GetEntryTime()` over `GetNodeTime()`, because the function doesn't return the current node time but the time of transaction entry.",
      "commit_id" : "71078b35eff1e43dc88203bb4d558b1706210a7d",
      "created_at" : "2023-05-16T14:07:57Z",
      "diff_hunk" : "@@ -126,7 +126,7 @@ class CTxMemPoolEntry\n         return GetVirtualTransactionSize(nTxWeight, sigOpCost, ::nBytesPerSigOp);\n     }\n     size_t GetTxWeight() const { return nTxWeight; }\n-    std::chrono::seconds GetTime() const { return std::chrono::seconds{nTime}; }\n+    NodeClock::time_point GetNodeTime() const { return nTime; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27675#discussion_r1195225774",
      "id" : 1195225774,
      "line" : 129,
      "node_id" : "PRRC_kwDOABII585HPbKu",
      "original_commit_id" : "9607a5078dbb6a65913055cf36a14c6e07229309",
      "original_line" : 129,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/kernel/mempool_entry.h",
      "position" : 23,
      "pull_request_review_id" : 1428669748,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27675",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1195225774/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-16T15:44:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1195225774",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27675#discussion_r1195879972"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1195879972"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I mostly renamed it to make sure there'd be compiler errors anywhere that it didn't get updated, just in case some type conversion happened automatically.",
      "commit_id" : "71078b35eff1e43dc88203bb4d558b1706210a7d",
      "created_at" : "2023-05-17T03:09:33Z",
      "diff_hunk" : "@@ -126,7 +126,7 @@ class CTxMemPoolEntry\n         return GetVirtualTransactionSize(nTxWeight, sigOpCost, ::nBytesPerSigOp);\n     }\n     size_t GetTxWeight() const { return nTxWeight; }\n-    std::chrono::seconds GetTime() const { return std::chrono::seconds{nTime}; }\n+    NodeClock::time_point GetNodeTime() const { return nTime; }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27675#discussion_r1195879972",
      "id" : 1195879972,
      "in_reply_to_id" : 1195225774,
      "line" : 129,
      "node_id" : "PRRC_kwDOABII585HR64k",
      "original_commit_id" : "9607a5078dbb6a65913055cf36a14c6e07229309",
      "original_line" : 129,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/kernel/mempool_entry.h",
      "position" : 23,
      "pull_request_review_id" : 1429722989,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27675",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1195879972/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-17T03:09:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1195879972",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27675#discussion_r1195881028"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1195881028"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah, this is broken as-is. My original idea was to add a timestamp to the `mapRelay` entries too, then it was to drop `mapRelay` and add `vExtraTxnForCompact`-relay, then I compromised by just doing it wrong...",
      "commit_id" : "71078b35eff1e43dc88203bb4d558b1706210a7d",
      "created_at" : "2023-05-17T03:11:57Z",
      "diff_hunk" : "@@ -2261,26 +2253,17 @@ void PeerManagerImpl::ProcessGetBlockData(CNode& pfrom, Peer& peer, const CInv&\n     }\n }\n \n-CTransactionRef PeerManagerImpl::FindTxForGetData(const Peer::TxRelay& tx_relay, const GenTxid& gtxid, const std::chrono::seconds mempool_req, const std::chrono::seconds now)\n+CTransactionRef PeerManagerImpl::FindTxForGetData(const Peer::TxRelay& tx_relay, const GenTxid& gtxid)\n {\n-    auto txinfo = m_mempool.info(gtxid);\n+    auto txinfo = m_mempool.info_for_relay(gtxid, tx_relay.m_last_inv_send_time);\n     if (txinfo.tx) {\n-        // If a TX could have been INVed in reply to a MEMPOOL request,\n-        // or is older than UNCONDITIONAL_RELAY_DELAY, permit the request\n-        // unconditionally.\n-        if ((mempool_req.count() && txinfo.m_time <= mempool_req) || txinfo.m_time <= now - UNCONDITIONAL_RELAY_DELAY) {\n-            return std::move(txinfo.tx);\n-        }\n+        return std::move(txinfo.tx);\n     }\n \n-    // Otherwise, the transaction must have been announced recently.\n-    if (tx_relay.m_recently_announced_invs.contains(gtxid.GetHash())) {\n-        // If it was, it can be relayed from either the mempool...\n-        if (txinfo.tx) return std::move(txinfo.tx);\n-        // ... or the relay pool.\n-        auto mi = mapRelay.find(gtxid.GetHash());\n-        if (mi != mapRelay.end()) return mi->second;\n-    }\n+    // Otherwise, the transaction must have been announced recently or removed from the mempool.\n+    // If the latter, maybe it's in mapRelay!",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27675#discussion_r1195881028",
      "id" : 1195881028,
      "in_reply_to_id" : 1195220741,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HR7JE",
      "original_commit_id" : "9607a5078dbb6a65913055cf36a14c6e07229309",
      "original_line" : 2264,
      "original_position" : 91,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1429724356,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27675",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1195881028/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-17T03:11:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1195881028",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27675#discussion_r1197968591"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1197968591"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The `NodeClock::now()` time can go backwards, right?  If so I think that could pose some issues if we're primarily relying on system time in order to determine whether transactions should be available for relay. Can we use a steady clock instead?",
      "commit_id" : "71078b35eff1e43dc88203bb4d558b1706210a7d",
      "created_at" : "2023-05-18T15:31:02Z",
      "diff_hunk" : "@@ -2299,7 +2299,7 @@ void PeerManagerImpl::ProcessGetData(CNode& pfrom, Peer& peer, const std::atomic\n     std::vector<CInv> vNotFound;\n     const CNetMsgMaker msgMaker(pfrom.GetCommonVersion());\n \n-    const auto now{GetTime<std::chrono::seconds>()};\n+    const NodeClock::time_point now = NodeClock::now();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27675#discussion_r1197968591",
      "id" : 1197968591,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585HZ4zP",
      "original_commit_id" : "023d0503ffdd91d408f10b34905b58f68edcc056",
      "original_line" : 2302,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1432933993,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27675",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1197968591/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-18T15:31:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1197968591",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK on getting rid of the recently announced filter.  I think we'd need to use a steady clock to avoid random failures for no good reason, is that easy to do?",
      "created_at" : "2023-05-18T15:41:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27675#issuecomment-1553249207",
      "id" : 1553249207,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27675",
      "node_id" : "IC_kwDOABII585clLO3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1553249207/reactions"
      },
      "updated_at" : "2023-05-18T15:41:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1553249207",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27675#discussion_r1202129704"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1202129704"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We could; it'd mean adding an extra field to the mempool, and using both mockable time and steady time for dealing with next invs (mockable time so we can skip over delays in sending invs; steady time for this purpose).",
      "commit_id" : "71078b35eff1e43dc88203bb4d558b1706210a7d",
      "created_at" : "2023-05-23T11:29:51Z",
      "diff_hunk" : "@@ -2299,7 +2299,7 @@ void PeerManagerImpl::ProcessGetData(CNode& pfrom, Peer& peer, const std::atomic\n     std::vector<CInv> vNotFound;\n     const CNetMsgMaker msgMaker(pfrom.GetCommonVersion());\n \n-    const auto now{GetTime<std::chrono::seconds>()};\n+    const NodeClock::time_point now = NodeClock::now();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27675#discussion_r1202129704",
      "id" : 1202129704,
      "in_reply_to_id" : 1197968591,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585Hpwso",
      "original_commit_id" : "023d0503ffdd91d408f10b34905b58f68edcc056",
      "original_line" : 2302,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1439442345,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27675",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1202129704/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-23T11:29:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1202129704",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27675#discussion_r1202222611"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27675"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1202222611"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Might have to use `LossyChronoFormatter` to avoid the fuzz crash?",
      "commit_id" : "71078b35eff1e43dc88203bb4d558b1706210a7d",
      "created_at" : "2023-05-23T12:20:03Z",
      "diff_hunk" : "@@ -78,7 +78,7 @@ bool LoadMempool(CTxMemPool& pool, const fs::path& load_path, Chainstate& active\n             }\n             if (nTime > TicksSinceEpoch<std::chrono::seconds>(now - pool.m_expiry)) {\n                 LOCK(cs_main);\n-                const auto& accepted = AcceptToMemoryPool(active_chainstate, tx, nTime, /*bypass_limits=*/false, /*test_accept=*/false);\n+                const auto& accepted = AcceptToMemoryPool(active_chainstate, tx, NodeClock::time_point{std::chrono::seconds{nTime}}, /*bypass_limits=*/false, /*test_accept=*/false);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27675#discussion_r1202222611",
      "id" : 1202222611,
      "line" : 81,
      "node_id" : "PRRC_kwDOABII585HqHYT",
      "original_commit_id" : "71078b35eff1e43dc88203bb4d558b1706210a7d",
      "original_line" : 81,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/kernel/mempool_persist.cpp",
      "position" : 5,
      "pull_request_review_id" : 1439563203,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27675",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1202222611/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-23T12:20:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1202222611",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "What's the rationale regarding optimizing for memory instead of privacy here? I can see how this simplifies the design, however, I fail to see this being an obvious pick given we'd be potentially even more exposed to fingerprinting than before (as is now it is trivial for every connection to probe data on the node's mempool).",
      "created_at" : "2023-05-23T18:22:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27675#issuecomment-1559935656",
      "id" : 1559935656,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27675",
      "node_id" : "IC_kwDOABII585c-rqo",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1559935656/reactions"
      },
      "updated_at" : "2023-05-23T18:22:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1559935656",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6665628?v=4",
         "events_url" : "https://api.github.com/users/sr-gi/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sr-gi/followers",
         "following_url" : "https://api.github.com/users/sr-gi/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sr-gi/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sr-gi",
         "id" : 6665628,
         "login" : "sr-gi",
         "node_id" : "MDQ6VXNlcjY2NjU2Mjg=",
         "organizations_url" : "https://api.github.com/users/sr-gi/orgs",
         "received_events_url" : "https://api.github.com/users/sr-gi/received_events",
         "repos_url" : "https://api.github.com/users/sr-gi/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sr-gi/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sr-gi/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sr-gi"
      }
   }
]
