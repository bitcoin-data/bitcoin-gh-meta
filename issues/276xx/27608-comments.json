[
   {
      "author_association" : "MEMBER",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [jamesob](https://github.com/bitcoin/bitcoin/pull/27608#pullrequestreview-1419260615), [instagibbs](https://github.com/bitcoin/bitcoin/pull/27608#pullrequestreview-1419317015), [fjahr](https://github.com/bitcoin/bitcoin/pull/27608#pullrequestreview-1419469898), [mzumsande](https://github.com/bitcoin/bitcoin/pull/27608#pullrequestreview-1419557634) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#26969](https://github.com/bitcoin/bitcoin/pull/26969) (net, refactor: net_processing, add `ProcessCompactBlockTxns` by brunoerg)\n* [#25572](https://github.com/bitcoin/bitcoin/pull/25572) (refactor: Introduce EvictionManager and use it for the inbound eviction logic by dergoegge)\n* [#25268](https://github.com/bitcoin/bitcoin/pull/25268) (refactor: Introduce EvictionManager by dergoegge)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2023-05-09T17:37:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27608#issuecomment-1540593104",
      "id" : 1540593104,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27608",
      "node_id" : "IC_kwDOABII585b05XQ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1540593104/reactions"
      },
      "updated_at" : "2023-05-09T23:39:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1540593104",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27608#discussion_r1188940525"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27608"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188940525"
         }
      },
      "author_association" : "MEMBER",
      "body" : "should describe what the argument does and when it should be used",
      "commit_id" : "52e52071e01f4e98d87a47e1d5f3c5c3cc6dbaf4",
      "created_at" : "2023-05-09T17:45:46Z",
      "diff_hunk" : "@@ -884,7 +884,7 @@ class PeerManagerImpl final : public PeerManager\n      *  - the block has been received from a peer\n      *  - the request for the block has timed out\n      */\n-    void RemoveBlockRequest(const uint256& hash) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+    void RemoveBlockRequest(const uint256& hash, std::optional<NodeId> from_peer) EXCLUSIVE_LOCKS_REQUIRED(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27608#discussion_r1188940525",
      "id" : 1188940525,
      "line" : 890,
      "node_id" : "PRRC_kwDOABII585G3crt",
      "original_commit_id" : "6857b1be52c2ba5c33cd39250ebef89cea0351c4",
      "original_line" : 890,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 9,
      "pull_request_review_id" : 1419160203,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27608",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188940525/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T18:00:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188940525",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. Will start running this when CI checks out.",
      "created_at" : "2023-05-09T17:56:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27608#issuecomment-1540617108",
      "id" : 1540617108,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27608",
      "node_id" : "IC_kwDOABII585b0_OU",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1540617108/reactions"
      },
      "updated_at" : "2023-05-09T17:56:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1540617108",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27608#discussion_r1188968159"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27608"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188968159"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Consider it done.",
      "commit_id" : "52e52071e01f4e98d87a47e1d5f3c5c3cc6dbaf4",
      "created_at" : "2023-05-09T18:12:27Z",
      "diff_hunk" : "@@ -884,7 +884,7 @@ class PeerManagerImpl final : public PeerManager\n      *  - the block has been received from a peer\n      *  - the request for the block has timed out\n      */\n-    void RemoveBlockRequest(const uint256& hash) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+    void RemoveBlockRequest(const uint256& hash, std::optional<NodeId> from_peer) EXCLUSIVE_LOCKS_REQUIRED(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27608#discussion_r1188968159",
      "id" : 1188968159,
      "in_reply_to_id" : 1188940525,
      "line" : 890,
      "node_id" : "PRRC_kwDOABII585G3jbf",
      "original_commit_id" : "6857b1be52c2ba5c33cd39250ebef89cea0351c4",
      "original_line" : 890,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 9,
      "pull_request_review_id" : 1419204091,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27608",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188968159/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T18:12:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188968159",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27608#discussion_r1189141220"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27608"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189141220"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: Could have moved the lock outside the `if..else` and removed the duplicate line in the `else` below.",
      "commit_id" : "52e52071e01f4e98d87a47e1d5f3c5c3cc6dbaf4",
      "created_at" : "2023-05-09T21:18:39Z",
      "diff_hunk" : "@@ -3155,6 +3164,11 @@ void PeerManagerImpl::ProcessBlock(CNode& node, const std::shared_ptr<const CBlo\n     m_chainman.ProcessNewBlock(block, force_processing, min_pow_checked, &new_block);\n     if (new_block) {\n         node.m_last_block_time = GetTime<std::chrono::seconds>();\n+        // In case this block came from a different peer than we requested\n+        // from, we can erase the block request now anyway (as we just stored\n+        // this block to disk).\n+        LOCK(cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27608#discussion_r1189141220",
      "id" : 1189141220,
      "line" : 3170,
      "node_id" : "PRRC_kwDOABII585G4Nrk",
      "original_commit_id" : "52e52071e01f4e98d87a47e1d5f3c5c3cc6dbaf4",
      "original_line" : 3170,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 51,
      "pull_request_review_id" : 1419469898,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27608",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189141220/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T22:54:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189141220",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27608#discussion_r1189204222"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27608"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189204222"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: requested **from** another peer",
      "commit_id" : "52e52071e01f4e98d87a47e1d5f3c5c3cc6dbaf4",
      "created_at" : "2023-05-09T23:00:08Z",
      "diff_hunk" : "@@ -1129,6 +1132,12 @@ void PeerManagerImpl::RemoveBlockRequest(const uint256& hash)\n     }\n \n     auto [node_id, list_it] = it->second;\n+\n+    if (from_peer && node_id != *from_peer) {\n+        // Block was requested by another peer",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27608#discussion_r1189204222",
      "id" : 1189204222,
      "line" : 1137,
      "node_id" : "PRRC_kwDOABII585G4dD-",
      "original_commit_id" : "52e52071e01f4e98d87a47e1d5f3c5c3cc6dbaf4",
      "original_line" : 1137,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 28,
      "pull_request_review_id" : 1419557634,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27608",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189204222/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T23:39:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189204222",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27608#discussion_r1189926154"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27608"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189926154"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oops -- will fix in a followup. Thanks for catching.",
      "commit_id" : "52e52071e01f4e98d87a47e1d5f3c5c3cc6dbaf4",
      "created_at" : "2023-05-10T13:37:43Z",
      "diff_hunk" : "@@ -1129,6 +1132,12 @@ void PeerManagerImpl::RemoveBlockRequest(const uint256& hash)\n     }\n \n     auto [node_id, list_it] = it->second;\n+\n+    if (from_peer && node_id != *from_peer) {\n+        // Block was requested by another peer",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27608#discussion_r1189926154",
      "id" : 1189926154,
      "in_reply_to_id" : 1189204222,
      "line" : 1137,
      "node_id" : "PRRC_kwDOABII585G7NUK",
      "original_commit_id" : "52e52071e01f4e98d87a47e1d5f3c5c3cc6dbaf4",
      "original_line" : 1137,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 28,
      "pull_request_review_id" : 1420669871,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27608",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189926154/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-10T13:37:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189926154",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27608#discussion_r1190051098"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27608"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190051098"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is this block required anymore now that `ProcessBlock` will call it for us the first time when it's new?",
      "commit_id" : "52e52071e01f4e98d87a47e1d5f3c5c3cc6dbaf4",
      "created_at" : "2023-05-10T15:06:28Z",
      "diff_hunk" : "@@ -4400,7 +4414,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                 // process from some other peer.  We do this after calling\n                 // ProcessNewBlock so that a malleated cmpctblock announcement\n                 // can't be used to interfere with block relay.\n-                RemoveBlockRequest(pblock->GetHash());\n+                RemoveBlockRequest(pblock->GetHash(), std::nullopt);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27608#discussion_r1190051098",
      "id" : 1190051098,
      "line" : 4417,
      "node_id" : "PRRC_kwDOABII585G7r0a",
      "original_commit_id" : "52e52071e01f4e98d87a47e1d5f3c5c3cc6dbaf4",
      "original_line" : 4417,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 70,
      "pull_request_review_id" : 1420862891,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27608",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190051098/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-10T15:08:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190051098",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27608#discussion_r1190059834"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27608"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190059834"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\"by another peer\" reads fine to me?",
      "commit_id" : "52e52071e01f4e98d87a47e1d5f3c5c3cc6dbaf4",
      "created_at" : "2023-05-10T15:12:42Z",
      "diff_hunk" : "@@ -1129,6 +1132,12 @@ void PeerManagerImpl::RemoveBlockRequest(const uint256& hash)\n     }\n \n     auto [node_id, list_it] = it->second;\n+\n+    if (from_peer && node_id != *from_peer) {\n+        // Block was requested by another peer",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27608#discussion_r1190059834",
      "id" : 1190059834,
      "in_reply_to_id" : 1189204222,
      "line" : 1137,
      "node_id" : "PRRC_kwDOABII585G7t86",
      "original_commit_id" : "52e52071e01f4e98d87a47e1d5f3c5c3cc6dbaf4",
      "original_line" : 1137,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 28,
      "pull_request_review_id" : 1420876153,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27608",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190059834/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-10T15:12:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190059834",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27608#discussion_r1190062712"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27608"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190062712"
         }
      },
      "author_association" : "MEMBER",
      "body" : "peer didn't request, WE requested that peer",
      "commit_id" : "52e52071e01f4e98d87a47e1d5f3c5c3cc6dbaf4",
      "created_at" : "2023-05-10T15:14:48Z",
      "diff_hunk" : "@@ -1129,6 +1132,12 @@ void PeerManagerImpl::RemoveBlockRequest(const uint256& hash)\n     }\n \n     auto [node_id, list_it] = it->second;\n+\n+    if (from_peer && node_id != *from_peer) {\n+        // Block was requested by another peer",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27608#discussion_r1190062712",
      "id" : 1190062712,
      "in_reply_to_id" : 1189204222,
      "line" : 1137,
      "node_id" : "PRRC_kwDOABII585G7up4",
      "original_commit_id" : "52e52071e01f4e98d87a47e1d5f3c5c3cc6dbaf4",
      "original_line" : 1137,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 28,
      "pull_request_review_id" : 1420880369,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27608",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190062712/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-10T15:14:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190062712",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27608#discussion_r1190063736"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27608"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190063736"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ah right, suggested text is also ambiguous....\r\n\r\n\"Block was requested by us from another peer\" ?",
      "commit_id" : "52e52071e01f4e98d87a47e1d5f3c5c3cc6dbaf4",
      "created_at" : "2023-05-10T15:15:28Z",
      "diff_hunk" : "@@ -1129,6 +1132,12 @@ void PeerManagerImpl::RemoveBlockRequest(const uint256& hash)\n     }\n \n     auto [node_id, list_it] = it->second;\n+\n+    if (from_peer && node_id != *from_peer) {\n+        // Block was requested by another peer",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27608#discussion_r1190063736",
      "id" : 1190063736,
      "in_reply_to_id" : 1189204222,
      "line" : 1137,
      "node_id" : "PRRC_kwDOABII585G7u54",
      "original_commit_id" : "52e52071e01f4e98d87a47e1d5f3c5c3cc6dbaf4",
      "original_line" : 1137,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 28,
      "pull_request_review_id" : 1420881698,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27608",
      "reactions" : {
         "+1" : 2,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 2,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190063736/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-10T15:15:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190063736",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27608#discussion_r1190909435"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27608"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190909435"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This comment could be improved:\r\n\r\n```cpp\r\n// When processing block related messages from our peers,\r\n// we treat requested blocks different from unsolicited ones.\r\n// When making this distinction we only keep track of the\r\n// last peer we requested from.\r\n```",
      "commit_id" : "52e52071e01f4e98d87a47e1d5f3c5c3cc6dbaf4",
      "created_at" : "2023-05-11T09:39:33Z",
      "diff_hunk" : "@@ -1164,7 +1173,7 @@ bool PeerManagerImpl::BlockRequested(NodeId nodeid, const CBlockIndex& block, st\n     }\n \n     // Make sure it's not listed somewhere already.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27608#discussion_r1190909435",
      "id" : 1190909435,
      "line" : 1175,
      "node_id" : "PRRC_kwDOABII585G-9X7",
      "original_commit_id" : "52e52071e01f4e98d87a47e1d5f3c5c3cc6dbaf4",
      "original_line" : 1175,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 38,
      "pull_request_review_id" : 1422180036,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27608",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190909435/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T14:41:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1190909435",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "post-merge Code review ACK 52e52071e01f4e98d87a47e1d5f3c5c3cc6dbaf4",
      "created_at" : "2023-05-11T10:54:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27608#issuecomment-1543775838",
      "id" : 1543775838,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27608",
      "node_id" : "IC_kwDOABII585cBCZe",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1543775838/reactions"
      },
      "updated_at" : "2023-05-11T10:54:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1543775838",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/27608#discussion_r1191267648"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27608"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191267648"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Can't we have a race condition where the block is not `new`? In any case this function is extremely fast if called twice.",
      "commit_id" : "52e52071e01f4e98d87a47e1d5f3c5c3cc6dbaf4",
      "created_at" : "2023-05-11T14:34:28Z",
      "diff_hunk" : "@@ -4400,7 +4414,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n                 // process from some other peer.  We do this after calling\n                 // ProcessNewBlock so that a malleated cmpctblock announcement\n                 // can't be used to interfere with block relay.\n-                RemoveBlockRequest(pblock->GetHash());\n+                RemoveBlockRequest(pblock->GetHash(), std::nullopt);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/27608#discussion_r1191267648",
      "id" : 1191267648,
      "in_reply_to_id" : 1190051098,
      "line" : 4417,
      "node_id" : "PRRC_kwDOABII585HAU1A",
      "original_commit_id" : "52e52071e01f4e98d87a47e1d5f3c5c3cc6dbaf4",
      "original_line" : 4417,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 70,
      "pull_request_review_id" : 1422180036,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/27608",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191267648/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-11T14:41:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1191267648",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   }
]
