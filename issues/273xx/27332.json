{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "### Is there an existing issue for this?\r\n\r\n- [X] I have searched the existing issues\r\n\r\n### Current behaviour\r\n\r\nWhen running `msbuild build_msvc\\bitcoin.sln -property:Configuration=Release -maxCpuCount -verbosity:minimal` I get the following two errors in the build.\r\n\r\n`C:\\Users\\e0\\Documents\\GitHub\\bitcoin\\src\\httpserver.cpp(637,9): error C2664: 'void evhttp_connection_get_peer(evhttp_connection *,const char **,uint16_t *)': cannot convert argument 2 from 'char **' to 'const char **' [C:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\libbitcoin_node\\libbitcoin_node\r\n.vcxproj]`\r\n\r\n`event.lib(evutil_rand.c.obj) : error LNK2019: unresolved external symbol BCryptGenRandom referenced in function arc4_seed [C:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\bitcoin-cli\\bitcoin-cli.vcxproj]`\r\nC:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\x64\\Release\\bitcoin-cli.exe : fatal error LNK1120: 1 unresolved externals [C:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\bitcoin-cli\\bitcoin-cli.vcxproj]`\r\n\r\nNote that vcpkg believes that the latest stable version of libevent is installed\r\n\r\n```\r\nPS C:\\Users\\e0\\Documents\\GitHub\\bitcoin> vcpkg install libevent                                                                        \r\nwarning: Starting with the September 2023 release, the default triplet for vcpkg libraries will change from x86-windows to the detected host triplet (x64-windows). To resolve this message, add --triplet x86-windows to keep the same behavior.\r\nComputing installation plan...\r\nThe following packages are already installed:\r\n    libevent[core,thread]:x86-windows -> 2.1.12+20230128\r\nlibevent:x86-windows is already installed\r\nRestored 0 package(s) from C:\\Users\\e0\\AppData\\Local\\vcpkg\\archives in 98.5 us. Use --debug to see more details.\r\n```\r\n\r\nThe error message is very similar to this issue https://github.com/bitcoin/bitcoin/issues/23606 which was resolved last year (Jan 13, 2022) with this PR: https://github.com/bitcoin/bitcoin/pull/23607\r\n\r\n\r\n**A theory:** Given that the PR #23607 solves the issue by redefining `evhttp_connection` in configure.ac. I am speculating the configure.ac is not run for MSVC and thus PR #23607 does not solve this issue for MSCV. Further confirming this is if I add the line `#define HAVE_EVHTTP_CONNECTION_GET_PEER_CONST_CHAR` to httpserver.cpp this evhttp_connection error no longer appears in the compiler out. However the `BCryptGenRandom` error still occurs.\r\n\r\n**Update-1:**\r\nI have solved the bcrypt errors by adding bcrypt as a dependency to the common.init.vcxproj with the following edit:\r\n\r\n```xml\r\n    <Link>\r\n      <SubSystem>Console</SubSystem>\r\n      <AdditionalDependencies>bcrypt.lib;Iphlpapi.lib;ws2_32.lib;Shlwapi.lib;kernel32.lib;user32.lib;gdi32.lib;comdlg32.lib;advapi32.lib;shell32.lib;ole32.lib;oleaut32.lib;uuid.lib;odbc32.lib;odbccp32.lib;%(AdditionalDependencies)</AdditionalDependencies>\r\n      <RandomizedBaseAddress>true</RandomizedBaseAddress>\r\n    </Link>\r\n```\r\n\r\nSo at minimum this should be added to common.init.vcxproj.in so that `python .\\build_msvc\\msvc-autogen.py` will add this lib when it builds common.init.vcxproj.\r\n\r\nWith regards to to the `evhttp_connection` errors, `msvc-autogen.py` does not attempt to define `HAVE_EVHTTP_CONNECTION_GET_PEER_CONST_CHAR` when it reads configure.ac. It might be reasonable to just assume that anyone doing an MSVC build will use vcpk and get the latest version of libevent and thus hardcode `HAVE_EVHTTP_CONNECTION_GET_PEER_CONST_CHAR` in the config for msvc.\r\n\r\n**Update-2:** I have created a PR to fix this.\r\n\r\n### Expected behaviour\r\n\r\nBitcoin compiles successfully\r\n\r\n### Steps to reproduce\r\n\r\nI'm following the build instructions here: https://github.com/bitcoin/bitcoin/tree/master/build_msvc\r\n\r\n1. Download Bitcoin source code from master branch\r\n2. Install vcpkg and add vcpkg to path so that it actually works,\r\n3. Skip installing QT step and delete QT build targets from bitcoin.sln\r\n4. Run `python build_msvc\\msvc-autogen.py`\r\n5. Run `msbuild build_msvc\\bitcoin.sln -property:Configuration=Release -maxCpuCount -verbosity:minimal`\r\n6. Build fails with errors shown above\r\n\r\n### Relevant log output\r\n\r\n```\r\nPS C:\\Users\\e0\\Documents\\GitHub\\bitcoin> msbuild build_msvc\\bitcoin.sln -property:Configuration=Release -maxCpuCount -verbosity:minimal\r\nMSBuild version 17.5.1+f6fdcf537 for .NET Framework\r\n\r\n  libunivalue.vcxproj -> C:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\x64\\Release\\libunivalue\\libunivalue.lib\r\n  libbitcoin_cli.vcxproj -> C:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\x64\\Release\\libbitcoin_cli\\libbitcoin_cli.lib\r\n  libbitcoin_zmq.vcxproj -> C:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\x64\\Release\\libbitcoin_zmq\\libbitcoin_zmq.lib\r\n  libsecp256k1.vcxproj -> C:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\x64\\Release\\libsecp256k1\\libsecp256k1.lib\r\n  libbitcoin_crypto.vcxproj -> C:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\x64\\Release\\libbitcoin_crypto\\libbitcoin_crypto.lib\r\n  libminisketch.vcxproj -> C:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\x64\\Release\\libminisketch\\libminisketch.lib\r\n  libbitcoin_wallet_tool.vcxproj -> C:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\x64\\Release\\libbitcoin_wallet_tool\\libbitcoin_wallet_tool.lib\r\n  libleveldb.vcxproj -> C:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\x64\\Release\\libleveldb\\libleveldb.lib\r\n  libbitcoinconsensus.vcxproj -> C:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\x64\\Release\\libbitcoinconsensus\\libbitcoinconsensus.lib\r\n  libbitcoin_util.vcxproj -> C:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\x64\\Release\\libbitcoin_util\\libbitcoin_util.lib\r\n  libtest_util.vcxproj -> C:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\x64\\Release\\libtest_util\\libtest_util.lib\r\n  httpserver.cpp\r\n  libbitcoin_common.vcxproj -> C:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\x64\\Release\\libbitcoin_common\\libbitcoin_common.lib\r\n  libbitcoin_wallet.vcxproj -> C:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\x64\\Release\\libbitcoin_wallet\\libbitcoin_wallet.lib\r\n  bitcoin-tx.vcxproj -> C:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\x64\\Release\\bitcoin-tx.exe\r\n  bitcoin-util.vcxproj -> C:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\x64\\Release\\bitcoin-util.exe\r\nC:\\Users\\e0\\Documents\\GitHub\\bitcoin\\src\\httpserver.cpp(637,9): error C2664: 'void evhttp_connection_get_peer(evhttp_connection *,const char **,uint16_t *)': cannot convert argument 2 from 'char **' to 'const char **' [C:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\libbitcoin_node\\libbitcoin_node\r\n.vcxproj]\r\nC:\\Users\\e0\\Documents\\GitHub\\bitcoin\\src\\httpserver.cpp(637,49): message : Conversion loses qualifiers [C:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\libbitcoin_node\\libbitcoin_node.vcxproj]\r\nC:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\vcpkg_installed\\x64-windows-static\\x64-windows-static\\include\\event2\\http.h(1001,6): message : see declaration of 'evhttp_connection_get_peer' [C:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\libbitcoin_node\\libbitcoin_node.vcxproj]\r\nC:\\Users\\e0\\Documents\\GitHub\\bitcoin\\src\\httpserver.cpp(637,9): message : while trying to match the argument list '(evhttp_connection *, char **, uint16_t *)' [C:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\libbitcoin_node\\libbitcoin_node.vcxproj]\r\n     Creating library C:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\x64\\Release\\bitcoin-cli.lib and object C:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\x64\\Release\\bitcoin-cli.exp\r\nevent.lib(evutil_rand.c.obj) : error LNK2019: unresolved external symbol BCryptGenRandom referenced in function arc4_seed [C:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\bitcoin-cli\\bitcoin-cli.vcxproj]\r\nC:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\x64\\Release\\bitcoin-cli.exe : fatal error LNK1120: 1 unresolved externals [C:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\bitcoin-cli\\bitcoin-cli.vcxproj]\r\n  bitcoin-wallet.vcxproj -> C:\\Users\\e0\\Documents\\GitHub\\bitcoin\\build_msvc\\x64\\Release\\bitcoin-wallet.exe\r\n```\r\n\r\n### How did you obtain Bitcoin Core\r\n\r\nCompiled from source\r\n\r\n### What version of Bitcoin Core are you using?\r\n\r\nbitcoin master branch at commit 4c6b7d330a4e80460dcce19b1a0a47d77a0b99ea\r\n\r\n### Operating system and version\r\n\r\nWindows 11 Pro Version\t22H2 Installed on â2/â18/â2023 OS build\t22621.1413 Experience\tWindows Feature Experience Pack 1000.22639.1000.0\r\n\r\n### Machine specifications\r\n\r\nProcessor\t11th Gen Intel(R) Core(TM) i7-11700F @ 2.50GHz   2.50 GHz\r\nInstalled RAM\t16.0 GB (15.9 GB usable)\r\nSystem type\t64-bit operating system, x64-based processor\r\nPen and touch\tNo pen or touch input is available for this display\r\n",
   "closed_at" : "2023-04-06T08:37:47Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
      "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
      "followers_url" : "https://api.github.com/users/fanquake/followers",
      "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
      "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/fanquake",
      "id" : 863730,
      "login" : "fanquake",
      "node_id" : "MDQ6VXNlcjg2MzczMA==",
      "organizations_url" : "https://api.github.com/users/fanquake/orgs",
      "received_events_url" : "https://api.github.com/users/fanquake/received_events",
      "repos_url" : "https://api.github.com/users/fanquake/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/fanquake"
   },
   "comments" : 0,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27332/comments",
   "created_at" : "2023-03-26T03:41:49Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27332/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/27332",
   "id" : 1640758028,
   "labels" : [
      {
         "color" : "884400",
         "default" : false,
         "description" : null,
         "id" : 234877,
         "name" : "Windows",
         "node_id" : "MDU6TGFiZWwyMzQ4Nzc=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Windows"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27332/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "I_kwDOABII585hy_sM",
   "number" : 27332,
   "performed_via_github_app" : null,
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27332/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "state_reason" : "completed",
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27332/timeline",
   "title" : "Bitcoin fails to build on MSVC: Libevent and BCryptGenRandom errors ",
   "updated_at" : "2023-04-06T08:37:47Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/27332",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/274814?v=4",
      "events_url" : "https://api.github.com/users/EthanHeilman/events{/privacy}",
      "followers_url" : "https://api.github.com/users/EthanHeilman/followers",
      "following_url" : "https://api.github.com/users/EthanHeilman/following{/other_user}",
      "gists_url" : "https://api.github.com/users/EthanHeilman/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/EthanHeilman",
      "id" : 274814,
      "login" : "EthanHeilman",
      "node_id" : "MDQ6VXNlcjI3NDgxNA==",
      "organizations_url" : "https://api.github.com/users/EthanHeilman/orgs",
      "received_events_url" : "https://api.github.com/users/EthanHeilman/received_events",
      "repos_url" : "https://api.github.com/users/EthanHeilman/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/EthanHeilman/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/EthanHeilman/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/EthanHeilman"
   }
}
