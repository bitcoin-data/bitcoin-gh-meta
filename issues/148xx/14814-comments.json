[
   {
      "author_association" : "NONE",
      "body" : "You say the memory check that needs `before_memory_usage` and `after_memory_usage` to be set? Could you please explain better? ",
      "created_at" : "2018-11-29T17:04:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14814#issuecomment-442913150",
      "id" : 442913150,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14814",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0MjkxMzE1MA==",
      "updated_at" : "2018-11-29T17:19:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/442913150",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/13356774?v=4",
         "events_url" : "https://api.github.com/users/agnjunio/events{/privacy}",
         "followers_url" : "https://api.github.com/users/agnjunio/followers",
         "following_url" : "https://api.github.com/users/agnjunio/following{/other_user}",
         "gists_url" : "https://api.github.com/users/agnjunio/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/agnjunio",
         "id" : 13356774,
         "login" : "agnjunio",
         "node_id" : "MDQ6VXNlcjEzMzU2Nzc0",
         "organizations_url" : "https://api.github.com/users/agnjunio/orgs",
         "received_events_url" : "https://api.github.com/users/agnjunio/received_events",
         "repos_url" : "https://api.github.com/users/agnjunio/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/agnjunio/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/agnjunio/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/agnjunio"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The memory usage shouldn't increase, but it is (at least temporarily) even after the messages are flushed. So the check was effectively removed in a4eaaa6 by raising the threshold.\r\n\r\nMaybe some of valgrinds tools could help to debug this issue?",
      "created_at" : "2018-11-29T18:10:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14814#issuecomment-442935787",
      "id" : 442935787,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14814",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0MjkzNTc4Nw==",
      "updated_at" : "2018-11-29T18:10:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/442935787",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Acknowledging #15400 is still unsolved,  I've done some testing on comparing the memory footprint for ```p2p_invalid_messages``` on Ubuntu 18.04 vs macOS.\r\n\r\nChecking the size of the transport buffer and rss memory after each ```msg_at_size``` shows that after the second message is sent, on macOS, the rss memory increases dramatically. Additional there are leftover bytes in the transport output buffer. ```tracemalloc``` shows that a large memory block is allocated in the call ```self._buffer.extend(data)```  in ```/asyncio/selector_events.py:882``` where the output buffer is extended because not everything was able to be sent.\r\n\r\n```\r\n============= Before Sending Message =============\r\nMessage #1, memory footprint: 77088\r\nCurrent output buffer size 1735312\r\n\r\n============= After Sending Message =============\r\nMessage #1, memory footprint: 83544\r\nCurrent output buffer size 2609568\r\n\r\n[ TraceMalloc Output ]\r\n/usr/local/Cellar/python/3.7.0/Frameworks/Python.framework/Versions/3.7/lib/python3.7/asyncio/selector_events.py:882: size=2548 KiB, count=1, average=2548 KiB\r\n/usr/local/Cellar/python/3.7.0/Frameworks/Python.framework/Versions/3.7/lib/python3.7/subprocess.py:1420: size=736 B, count=4, average=184 B\r\n/usr/local/Cellar/python/3.7.0/Frameworks/Python.framework/Versions/3.7/lib/python3.7/asyncio/selector_events.py:883: size=496 B, count=1, average=496 B\r\n/usr/local/Cellar/python/3.7.0/Frameworks/Python.framework/Versions/3.7/lib/python3.7/asyncio/selector_events.py:305: size=496 B, count=1, average=496 B\r\n/usr/local/Cellar/python/3.7.0/Frameworks/Python.framework/Versions/3.7/lib/python3.7/asyncio/events.py:88: size=496 B, count=1, average=496 B\r\n/usr/local/Cellar/python/3.7.0/Frameworks/Python.framework/Versions/3.7/lib/python3.7/asyncio/selector_events.py:903: size=488 B, count=1, average=488 B\r\n```\r\nThe increase in memory from this step (~13%) accounts for most (~99%) of the overall memory increase in this test. I.e. this step is the reason for the need for https://github.com/bitcoin/bitcoin/commit/a4eaaa6ac53606a1533b56050af77961d8c27dc7\r\n\r\nIn Ubuntu, the buffer is always emptied after each send and there is a minimal spike in memory footprint.\r\n```\r\n============= Before Sending Message =============\r\nMessage #1, memory footprint: 51532\r\nCurrent output buffer size 0\r\n\r\n============= After Sending Message =============\r\nMessage #1, memory footprint: 52884\r\nCurrent output buffer size 0\r\n```\r\n\r\nAny thoughts on approaches to solving this would be appreciated. It seems to mainly be an initial overhead penalty in macOS as the memory footprint plateaus for the remaining 78 messages. So perhaps it is a macOS specific quirk?",
      "created_at" : "2019-02-21T07:17:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/14814#issuecomment-465888879",
      "id" : 465888879,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14814",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ2NTg4ODg3OQ==",
      "updated_at" : "2019-02-21T07:17:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/465888879",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/9293647?v=4",
         "events_url" : "https://api.github.com/users/IlyasRidhuan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/IlyasRidhuan/followers",
         "following_url" : "https://api.github.com/users/IlyasRidhuan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/IlyasRidhuan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/IlyasRidhuan",
         "id" : 9293647,
         "login" : "IlyasRidhuan",
         "node_id" : "MDQ6VXNlcjkyOTM2NDc=",
         "organizations_url" : "https://api.github.com/users/IlyasRidhuan/orgs",
         "received_events_url" : "https://api.github.com/users/IlyasRidhuan/received_events",
         "repos_url" : "https://api.github.com/users/IlyasRidhuan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/IlyasRidhuan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/IlyasRidhuan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/IlyasRidhuan"
      }
   }
]
