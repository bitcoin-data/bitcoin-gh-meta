[
   {
      "author_association" : "MEMBER",
      "body" : "@hebasto Can you also link to #14058 from the PR description, as that is the issue #14072 was solving.",
      "created_at" : "2018-11-25T23:28:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14803#issuecomment-441483714",
      "id" : 441483714,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14803",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0MTQ4MzcxNA==",
      "updated_at" : "2018-11-25T23:28:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/441483714",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@fanquake Done.",
      "created_at" : "2018-11-25T23:32:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14803#issuecomment-441483944",
      "id" : 441483944,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14803",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0MTQ4Mzk0NA==",
      "updated_at" : "2018-11-25T23:32:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/441483944",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK\r\n\r\nThanks for fighting UB (data race is UB) :-)",
      "created_at" : "2018-11-25T23:33:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14803#issuecomment-441483997",
      "id" : 441483997,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14803",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0MTQ4Mzk5Nw==",
      "updated_at" : "2018-11-25T23:33:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/441483997",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for working on this.\r\n\r\nSimply making the check flag atomic doesn't really seem correct to me-- why would we be checking the same block object twice concurrently?  Just making the test atomic prevents the that particular bit of UB but it doesn't mean that there isn't wasted work, or even the potential of a deadlock.\r\n\r\nCan someone please summarize how the same block can get checked in parallel and why it makes sense for that to happen? 14058 simply states the test fail with thread sanitizing enabled, but don't explain the sequence of events that lead to the race. I want to make sure that we're not bandaging over a structural flaw that should be fixed with a lock someplace or some other change.  ",
      "created_at" : "2018-11-26T02:01:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14803#issuecomment-441497316",
      "id" : 441497316,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14803",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0MTQ5NzMxNg==",
      "updated_at" : "2018-11-26T02:03:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/441497316",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#14829](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/14829.html) (travis: Enable functional tests in the ThreadSanitizer (TSan) build job by practicalswift)\n* [#10785](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/10785.html) (Serialization improvements by sipa)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2018-11-26T02:44:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14803#issuecomment-441503000",
      "id" : 441503000,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14803",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0MTUwMzAwMA==",
      "updated_at" : "2018-11-28T23:29:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/441503000",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I agree with @gmaxwell, why make data structure thread safe?\r\n\r\nBeside, `CBlock::operator=` doesn't look thread safe to me, can't `m_checked` change between load and store?",
      "created_at" : "2018-11-26T11:49:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14803#issuecomment-441612405",
      "id" : 441612405,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14803",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0MTYxMjQwNQ==",
      "updated_at" : "2018-11-26T11:50:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/441612405",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The race happens because we run 10 threads in parallel that check 1000 random blocks in sequence. With only about 100 blocks in total, it is unlikely that every thread picks blocks that have not yet been picked by another thread.\r\nSo I think there are at least two alternative solutions:\r\n\r\n* Assume that we only ever call `ProcessNewBlock` for each block once, so we'd rewrite the unit test to not pick a random block, but pop (remove and return) a random block from the list. But this assumption seems unlikely, since a block could arrive on the p2p and rpc interface at the same time, which then both call `ProcessNewBlock`.\r\n* Assume that `ProcessNewBlock` avoids checking the same block twice, which could be fixed by guarding the read-write of fChecked on a larger scope, instead of just fixing the symptom that the member variable is racy.\r\n* something else?",
      "created_at" : "2018-11-26T17:28:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14803#issuecomment-441725508",
      "id" : 441725508,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14803",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0MTcyNTUwOA==",
      "updated_at" : "2018-11-26T17:28:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/441725508",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think 2nd option is the most reasonable.",
      "created_at" : "2018-11-26T17:37:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14803#issuecomment-441728415",
      "id" : 441728415,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14803",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0MTcyODQxNQ==",
      "updated_at" : "2018-11-26T17:37:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/441728415",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "My preference is avoid adding synchronization primitives to structures that don't need it. Here it seems the case that the validation logic doesn't actually supported multi-threaded block validation, but the unit tests verify (a small) part of it regardless. That seems overkill. ",
      "created_at" : "2018-11-26T18:09:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14803#issuecomment-441739553",
      "id" : 441739553,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14803",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0MTczOTU1Mw==",
      "updated_at" : "2018-11-26T18:13:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/441739553",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "If it doesn't support multi-threaded block validation, it should still be fixed to avoid multiple threads calling it at the same time, because that is a thing that can happen in practice with the rpc thread running along the \"main thread\".",
      "created_at" : "2018-11-26T20:27:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14803#issuecomment-441785930",
      "id" : 441785930,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14803",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0MTc4NTkzMA==",
      "updated_at" : "2018-11-26T20:27:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/441785930",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "It doesn't support multithreaded validation and there are lot of things that prevent that, which is why I was concerned.  Why doesn't the lock on the block index or even cs main prevent concurrency here?\r\n\r\nI'd missed that the original case was a unit test.",
      "created_at" : "2018-11-27T21:58:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14803#issuecomment-442233211",
      "id" : 442233211,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14803",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0MjIzMzIxMQ==",
      "updated_at" : "2018-11-27T21:58:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/442233211",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Why doesn't the lock on the block index or even cs main prevent concurrency here?\r\n\r\nThe cs main lock was moved down in this change \"Harden against mistakes handling invalid blocks\" #9765  by @sdaftuar \r\n\r\nSo unless there was a reason to not put it before `CheckBlock`, I suggest to move it up by one line.\r\n",
      "created_at" : "2018-11-27T22:12:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/14803#issuecomment-442237566",
      "id" : 442237566,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/14803",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ0MjIzNzU2Ng==",
      "updated_at" : "2018-11-27T22:12:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/442237566",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
