[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r276046301"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/276046301"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Does the use of 10 here imply that-- assuming all peers INV a transaction to us at roughly the same time-- that we get no more robustness to transaction suppression than if we only had ten peers?  If so, perhaps this should be equal to the maximum number of peers times the interval",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-04-17T01:01:07Z",
      "diff_hunk" : "@@ -75,6 +75,8 @@ static constexpr int64_t INBOUND_PEER_TX_DELAY = 2 * 1000000;\n static constexpr int64_t GETDATA_TX_INTERVAL = 60 * 1000000;\n /** Maximum delay (in microseconds) for transaction requests to avoid biasing some peers over others. */\n static constexpr int64_t MAX_GETDATA_RANDOM_DELAY = 2 * 1000000;\n+/** How long to wait (in microseconds) before expiring a getdata request to a peer */\n+static constexpr int64_t TX_EXPIRY_INTERVAL = 10 * GETDATA_TX_INTERVAL;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r276046301",
      "id" : 276046301,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NjA0NjMwMQ==",
      "original_commit_id" : "7c4e69c6dcde13c572888fa7d00f70157b1f32aa",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : 13,
      "pull_request_review_id" : 227510630,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-05-28T20:28:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/276046301",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r276049783"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/276049783"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Doesn't erase invalidate the iterator at and after the point of the erasure? ",
      "commit_id" : "7c4e69c6dcde13c572888fa7d00f70157b1f32aa",
      "created_at" : "2019-04-17T01:25:41Z",
      "diff_hunk" : "@@ -3922,6 +3927,27 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n         //\n         // Message: getdata (non-blocks)\n         //\n+\n+        // For robustness, expire old requests after a long timeout, so that\n+        // we can resume downloading transactions from a peer even if they\n+        // were unresponsive in the past.\n+        // Eventually we should consider disconnecting peers, but this is\n+        // conservative.\n+        if (state.m_tx_download.m_check_expiry_timer <= nNow) {\n+            for (auto it=state.m_tx_download.m_tx_in_flight.begin(); it != state.m_tx_download.m_tx_in_flight.end();) {\n+                if (it->second <= nNow - TX_EXPIRY_INTERVAL) {\n+                    LogPrint(BCLog::NET, \"timeout of inflight tx %s from peer %d\\n\", it->first.ToString(), pto->GetId());\n+                    state.m_tx_download.m_tx_announced.erase(it->first);\n+                    state.m_tx_download.m_tx_in_flight.erase(it++);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r276049783",
      "id" : 276049783,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NjA0OTc4Mw==",
      "original_commit_id" : "7c4e69c6dcde13c572888fa7d00f70157b1f32aa",
      "original_position" : 38,
      "path" : "src/net_processing.cpp",
      "position" : 60,
      "pull_request_review_id" : 227514892,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-04-17T01:25:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/276049783",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r276049961"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/276049961"
         }
      },
      "author_association" : "MEMBER",
      "body" : "oh nevermind thats a map.",
      "commit_id" : "7c4e69c6dcde13c572888fa7d00f70157b1f32aa",
      "created_at" : "2019-04-17T01:26:51Z",
      "diff_hunk" : "@@ -3922,6 +3927,27 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n         //\n         // Message: getdata (non-blocks)\n         //\n+\n+        // For robustness, expire old requests after a long timeout, so that\n+        // we can resume downloading transactions from a peer even if they\n+        // were unresponsive in the past.\n+        // Eventually we should consider disconnecting peers, but this is\n+        // conservative.\n+        if (state.m_tx_download.m_check_expiry_timer <= nNow) {\n+            for (auto it=state.m_tx_download.m_tx_in_flight.begin(); it != state.m_tx_download.m_tx_in_flight.end();) {\n+                if (it->second <= nNow - TX_EXPIRY_INTERVAL) {\n+                    LogPrint(BCLog::NET, \"timeout of inflight tx %s from peer %d\\n\", it->first.ToString(), pto->GetId());\n+                    state.m_tx_download.m_tx_announced.erase(it->first);\n+                    state.m_tx_download.m_tx_in_flight.erase(it++);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r276049961",
      "id" : 276049961,
      "in_reply_to_id" : 276049783,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NjA0OTk2MQ==",
      "original_commit_id" : "7c4e69c6dcde13c572888fa7d00f70157b1f32aa",
      "original_position" : 38,
      "path" : "src/net_processing.cpp",
      "position" : 60,
      "pull_request_review_id" : 227515101,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-04-17T01:26:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/276049961",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r276062747"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/276062747"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "No, `TX_EXPIRY_INTERVAL` only removes tx's that are already in the `in_flight` list, which means we've already sent a GETDATA for them at least `TX_EXPIRY_INTERVAL` microseconds ago. EDIT: (And doesn't remove them from other peers' queues, whether they've been sent a GETDATA already, or that's still pending)",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-04-17T02:54:05Z",
      "diff_hunk" : "@@ -75,6 +75,8 @@ static constexpr int64_t INBOUND_PEER_TX_DELAY = 2 * 1000000;\n static constexpr int64_t GETDATA_TX_INTERVAL = 60 * 1000000;\n /** Maximum delay (in microseconds) for transaction requests to avoid biasing some peers over others. */\n static constexpr int64_t MAX_GETDATA_RANDOM_DELAY = 2 * 1000000;\n+/** How long to wait (in microseconds) before expiring a getdata request to a peer */\n+static constexpr int64_t TX_EXPIRY_INTERVAL = 10 * GETDATA_TX_INTERVAL;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r276062747",
      "id" : 276062747,
      "in_reply_to_id" : 276046301,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NjA2Mjc0Nw==",
      "original_commit_id" : "7c4e69c6dcde13c572888fa7d00f70157b1f32aa",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : 13,
      "pull_request_review_id" : 227530426,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-05-28T20:28:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/276062747",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r276065900"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/276065900"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe:\r\n\r\n    if (m_tx_in_flight.erase(hash)) {\r\n        m_tx_announced.erase(hash);\r\n    }\r\n\r\nOtherwise sending `INV x1 x2 .. x100`, then looping `INV x; NOTFOUND x` (without ever sending the corresponding `TX` message) will grow `m_tx_process_time` unboundedly, I think.",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-04-17T03:16:22Z",
      "diff_hunk" : "@@ -3111,8 +3116,19 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     }\n \n     if (strCommand == NetMsgType::NOTFOUND) {\n-        // We do not care about the NOTFOUND message, but logging an Unknown Command\n-        // message would be undesirable as we transmit it ourselves.\n+        // Remove the NOTFOUND transactions from the peer\n+        LOCK(cs_main);\n+        CNodeState *state = State(pfrom->GetId());\n+        std::vector<CInv> vInv;\n+        vRecv >> vInv;\n+        if (vInv.size() <= MAX_PEER_TX_IN_FLIGHT + MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n+            for (CInv &inv : vInv) {\n+                if (inv.type == MSG_TX || inv.type == MSG_WITNESS_TX) {\n+                    state->m_tx_download.m_tx_announced.erase(inv.hash);\n+                    state->m_tx_download.m_tx_in_flight.erase(inv.hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r276065900",
      "id" : 276065900,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NjA2NTkwMA==",
      "original_commit_id" : "7c4e69c6dcde13c572888fa7d00f70157b1f32aa",
      "original_position" : 38,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 227534135,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-05-28T20:28:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/276065900",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r276073773"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/276073773"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "That's a bit unpredictable, maybe `nNow + TX_EXPIRY_INTERVAL/2 + GetRand(TX_EXPIRY_INTERVAL)` ? Also kind of a pain to test 10 minute delays that don't consider mocktime, but whatever.",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-04-17T04:17:58Z",
      "diff_hunk" : "@@ -3911,6 +3927,27 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n         //\n         // Message: getdata (non-blocks)\n         //\n+\n+        // For robustness, expire old requests after a long timeout, so that\n+        // we can resume downloading transactions from a peer even if they\n+        // were unresponsive in the past.\n+        // Eventually we should consider disconnecting peers, but this is\n+        // conservative.\n+        if (state.m_tx_download.m_check_expiry_timer <= nNow) {\n+            for (auto it=state.m_tx_download.m_tx_in_flight.begin(); it != state.m_tx_download.m_tx_in_flight.end();) {\n+                if (it->second <= nNow - TX_EXPIRY_INTERVAL) {\n+                    LogPrint(BCLog::NET, \"timeout of inflight tx %s from peer %d\\n\", it->first.ToString(), pto->GetId());\n+                    state.m_tx_download.m_tx_announced.erase(it->first);\n+                    state.m_tx_download.m_tx_in_flight.erase(it++);\n+                } else {\n+                    ++it;\n+                }\n+            }\n+            // On average, we do this check every TX_EXPIRY_INTERVAL. Randomize\n+            // so that we're not doing this for all peers at the same time.\n+            state.m_tx_download.m_check_expiry_timer = nNow + GetRand(2*TX_EXPIRY_INTERVAL);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r276073773",
      "id" : 276073773,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NjA3Mzc3Mw==",
      "original_commit_id" : "7c4e69c6dcde13c572888fa7d00f70157b1f32aa",
      "original_position" : 67,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 227543798,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-05-28T20:28:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/276073773",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r276078275"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/276078275"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, testing confirms we can get a memory leak this way -- test node gets from 60M to 1GB resident size after about 1M `INV y1..y100; NOTFOUND y1..y100` pairs, after pre-filling in_flight and process with `INV x1..x5000`, and suggested change keeps resident size stable at 60M.\r\n\r\n`INV y; TX ytx` also unconditionally clears `m_tx_announced`, but that's okay because redoing `INV y` won't re-add it to `m_tx_announced` because of the `AlreadyHave()` check. However, doing `INV y1; TX y1; INV y2; TX y2; ..; INV yN; TX yN` can still cause m_tx_process_time to have N entries, though. That's a lot harder to exploit, especially with the timeout this patch adds that constrains the y1..yN to be within the 20minute period, but still maybe worth doing the same fix?",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-04-17T04:51:12Z",
      "diff_hunk" : "@@ -3111,8 +3116,19 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     }\n \n     if (strCommand == NetMsgType::NOTFOUND) {\n-        // We do not care about the NOTFOUND message, but logging an Unknown Command\n-        // message would be undesirable as we transmit it ourselves.\n+        // Remove the NOTFOUND transactions from the peer\n+        LOCK(cs_main);\n+        CNodeState *state = State(pfrom->GetId());\n+        std::vector<CInv> vInv;\n+        vRecv >> vInv;\n+        if (vInv.size() <= MAX_PEER_TX_IN_FLIGHT + MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n+            for (CInv &inv : vInv) {\n+                if (inv.type == MSG_TX || inv.type == MSG_WITNESS_TX) {\n+                    state->m_tx_download.m_tx_announced.erase(inv.hash);\n+                    state->m_tx_download.m_tx_in_flight.erase(inv.hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r276078275",
      "id" : 276078275,
      "in_reply_to_id" : 276065900,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NjA3ODI3NQ==",
      "original_commit_id" : "7c4e69c6dcde13c572888fa7d00f70157b1f32aa",
      "original_position" : 38,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 227549172,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-05-28T20:28:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/276078275",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Are we failing to dequeue txn for non-witness peers that send us witness txn that we drop?",
      "created_at" : "2019-04-17T06:24:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#issuecomment-483953736",
      "id" : 483953736,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15834",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4Mzk1MzczNg==",
      "updated_at" : "2019-04-17T06:24:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/483953736",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r276112938"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/276112938"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "However, I think there's another bug that causes problems here -- if you have two offers with nearby `m_process_time` values, then you'll hit the `else` clause of `last_request_Time <= nNow - GETDATA_TX_INTERVAL` and call `RequestTx(txid)` which will just return because it's already present in `m_tx_announced`, and then you'll clear `inv.hash` (ie `txid`) from `tx_process_time`, and never actually request it from that peer. So I think this also needs:\r\n\r\n                } else {\r\n                    // This transaction is in flight from someone else; queue\r\n                    // up processing to happen after the download times out\r\n                    // (with a slight delay for inbound peers, to prefer\r\n                    // requests to outbound peers).\r\n    +               state.m_tx_download.m_tx_announced.erase(inv.hash);\r\n                    RequestTx(&state, txid, nNow);\r\n                }\r\n",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-04-17T07:34:20Z",
      "diff_hunk" : "@@ -75,6 +75,8 @@ static constexpr int64_t INBOUND_PEER_TX_DELAY = 2 * 1000000;\n static constexpr int64_t GETDATA_TX_INTERVAL = 60 * 1000000;\n /** Maximum delay (in microseconds) for transaction requests to avoid biasing some peers over others. */\n static constexpr int64_t MAX_GETDATA_RANDOM_DELAY = 2 * 1000000;\n+/** How long to wait (in microseconds) before expiring a getdata request to a peer */\n+static constexpr int64_t TX_EXPIRY_INTERVAL = 10 * GETDATA_TX_INTERVAL;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r276112938",
      "id" : 276112938,
      "in_reply_to_id" : 276046301,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NjExMjkzOA==",
      "original_commit_id" : "7c4e69c6dcde13c572888fa7d00f70157b1f32aa",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : 13,
      "pull_request_review_id" : 227591378,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-05-28T20:28:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/276112938",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r276120894"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/276120894"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Might be good to call `EraseTxRequest(hash);` inside the `if` as well, so that we don't delay requesting from other peers when we've already received a NOTFOUND. Could leave that for #15505 though.",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-04-17T07:58:36Z",
      "diff_hunk" : "@@ -3111,8 +3116,19 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     }\n \n     if (strCommand == NetMsgType::NOTFOUND) {\n-        // We do not care about the NOTFOUND message, but logging an Unknown Command\n-        // message would be undesirable as we transmit it ourselves.\n+        // Remove the NOTFOUND transactions from the peer\n+        LOCK(cs_main);\n+        CNodeState *state = State(pfrom->GetId());\n+        std::vector<CInv> vInv;\n+        vRecv >> vInv;\n+        if (vInv.size() <= MAX_PEER_TX_IN_FLIGHT + MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n+            for (CInv &inv : vInv) {\n+                if (inv.type == MSG_TX || inv.type == MSG_WITNESS_TX) {\n+                    state->m_tx_download.m_tx_announced.erase(inv.hash);\n+                    state->m_tx_download.m_tx_in_flight.erase(inv.hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r276120894",
      "id" : 276120894,
      "in_reply_to_id" : 276065900,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NjEyMDg5NA==",
      "original_commit_id" : "7c4e69c6dcde13c572888fa7d00f70157b1f32aa",
      "original_position" : 38,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 227601240,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-05-28T20:28:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/276120894",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK\r\n\r\nCould you please update the comment in \r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/7c4e69c6dcde13c572888fa7d00f70157b1f32aa/src/net_processing.cpp#L1462-L1469\r\n\r\nto say:\r\n* Why we send so many notfound. (Because of orphan handling, see https://github.com/bitcoin/bitcoin/pull/15776#issuecomment-483916240)\r\n* Remove the phrase \"Currently only SPV clients actually care...\"",
      "created_at" : "2019-04-17T12:06:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#issuecomment-484055268",
      "id" : 484055268,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15834",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4NDA1NTI2OA==",
      "updated_at" : "2019-04-17T12:06:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/484055268",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ajtowns Thanks for the review and good catch on those additional issues you spotted.  I'll continue to work on this PR for master but I now think that we should revert this for 0.18 rather than try to make a fix and backport.  Please see #15839. ",
      "created_at" : "2019-04-17T17:19:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#issuecomment-484182749",
      "id" : 484182749,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15834",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4NDE4Mjc0OQ==",
      "updated_at" : "2019-04-17T17:19:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/484182749",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Are we failing to dequeue txn for non-witness peers that send us witness txn that we drop?\r\n\r\n@gmaxwell Not that I can see.  It looks to me like the only way a peer could \"send\" us a transaction that doesn't get dequeued is if it fails to deserialize successfully; once we've deserialized I don't think there's a code path that would not result in updating the data structures.",
      "created_at" : "2019-04-17T18:38:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#issuecomment-484211888",
      "id" : 484211888,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15834",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4NDIxMTg4OA==",
      "updated_at" : "2019-04-17T18:38:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/484211888",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "So I don't forget: Instead of disconnecting we can make the ordering in the random fetching biased based on the size() of the INVs outstanding queue and the number of expired entries.... so hosts that INV dos us just end up de-preferred for fetching.",
      "created_at" : "2019-04-17T21:51:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#issuecomment-484274900",
      "id" : 484274900,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15834",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4NDI3NDkwMA==",
      "updated_at" : "2019-04-17T21:51:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/484274900",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r276518533"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/276518533"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Oh, that only works for the request side. If we get:\r\n\r\n     0s peer A: INV deadbeef...\r\n     1s peer B: INV deadbeef...\r\n     ...\r\n     5s peer Z: INV deadbeef\r\n\r\nand then we happen to query some unresponsive peers, we'll see:\r\n\r\n    10s: -> peer D: GETDATA deadbeef...\r\n    610s: [expired]\r\n    611s: -> peer Q: GETDATA deadbeef...\r\n    1211s: [expired]\r\n\r\nAt which point every peer will have decided \"it's been >15m, I'll expire the deadbeef... tx from mapRelay, and then every node will respond with NOTFOUND for that tx...",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-04-18T05:05:22Z",
      "diff_hunk" : "@@ -75,6 +75,8 @@ static constexpr int64_t INBOUND_PEER_TX_DELAY = 2 * 1000000;\n static constexpr int64_t GETDATA_TX_INTERVAL = 60 * 1000000;\n /** Maximum delay (in microseconds) for transaction requests to avoid biasing some peers over others. */\n static constexpr int64_t MAX_GETDATA_RANDOM_DELAY = 2 * 1000000;\n+/** How long to wait (in microseconds) before expiring a getdata request to a peer */\n+static constexpr int64_t TX_EXPIRY_INTERVAL = 10 * GETDATA_TX_INTERVAL;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r276518533",
      "id" : 276518533,
      "in_reply_to_id" : 276046301,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NjUxODUzMw==",
      "original_commit_id" : "7c4e69c6dcde13c572888fa7d00f70157b1f32aa",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : 13,
      "pull_request_review_id" : 228102122,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-05-28T20:28:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/276518533",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.",
      "created_at" : "2019-04-18T15:15:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#issuecomment-484552990",
      "id" : 484552990,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15834",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4NDU1Mjk5MA==",
      "updated_at" : "2019-05-04T13:41:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/484552990",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Removing this from 0.18.0 because of #14897",
      "created_at" : "2019-04-18T15:38:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#issuecomment-484565270",
      "id" : 484565270,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15834",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4NDU2NTI3MA==",
      "updated_at" : "2019-04-18T15:38:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/484565270",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r277335337"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/277335337"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The code in #15505 is checking for entries being in the in-flight map, so I'll take that suggestion here.  But I think the best way to close the door on this would be to just bound the `m_tx_process_time` map explicitly, so I'll do that too.\r\n\r\nI'll leave the `EraseTxRequest()` call for #15505.",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-04-22T15:57:15Z",
      "diff_hunk" : "@@ -3111,8 +3116,19 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     }\n \n     if (strCommand == NetMsgType::NOTFOUND) {\n-        // We do not care about the NOTFOUND message, but logging an Unknown Command\n-        // message would be undesirable as we transmit it ourselves.\n+        // Remove the NOTFOUND transactions from the peer\n+        LOCK(cs_main);\n+        CNodeState *state = State(pfrom->GetId());\n+        std::vector<CInv> vInv;\n+        vRecv >> vInv;\n+        if (vInv.size() <= MAX_PEER_TX_IN_FLIGHT + MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n+            for (CInv &inv : vInv) {\n+                if (inv.type == MSG_TX || inv.type == MSG_WITNESS_TX) {\n+                    state->m_tx_download.m_tx_announced.erase(inv.hash);\n+                    state->m_tx_download.m_tx_in_flight.erase(inv.hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r277335337",
      "id" : 277335337,
      "in_reply_to_id" : 276065900,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NzMzNTMzNw==",
      "original_commit_id" : "7c4e69c6dcde13c572888fa7d00f70157b1f32aa",
      "original_position" : 38,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 229119731,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-05-28T20:28:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/277335337",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r277387561"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/277387561"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Does the use of 10 here imply that-- assuming all peers INV a transaction to us at roughly the same time-- that we get no more robustness to transaction suppression than if we only had ten peers?\r\n\r\n@gmaxwell I'm not sure I understand the question -- is the concern that an adversary could keep re-announcing a transaction to us, and every 10 minutes we'll retry that adversary instead of going to our other peers?\r\n\r\nI think that does seem problematic, but since we prefer outbound peers over inbound ones, we should at least be able to query all our outbound peers before an adversary would be able to cause us to re-cycle back to them.  I could, as you suggest, raise this to 125 minutes to eliminate this problem, but that seemed like an excessive time to me that we might (potentially) stop transaction relay.  Of course in theory this code shouldn't really kick in except for misbehaving peers, so I don't have a strong intuition of where to set it.... Thoughts?",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-04-22T18:35:53Z",
      "diff_hunk" : "@@ -75,6 +75,8 @@ static constexpr int64_t INBOUND_PEER_TX_DELAY = 2 * 1000000;\n static constexpr int64_t GETDATA_TX_INTERVAL = 60 * 1000000;\n /** Maximum delay (in microseconds) for transaction requests to avoid biasing some peers over others. */\n static constexpr int64_t MAX_GETDATA_RANDOM_DELAY = 2 * 1000000;\n+/** How long to wait (in microseconds) before expiring a getdata request to a peer */\n+static constexpr int64_t TX_EXPIRY_INTERVAL = 10 * GETDATA_TX_INTERVAL;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r277387561",
      "id" : 277387561,
      "in_reply_to_id" : 276046301,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NzM4NzU2MQ==",
      "original_commit_id" : "7c4e69c6dcde13c572888fa7d00f70157b1f32aa",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : 13,
      "pull_request_review_id" : 229185870,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-05-28T20:28:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/277387561",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r277390154"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/277390154"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@ajtowns Thanks for catching that bug around `RequestTx()`.  I'll be including a fix the next time I update this PR.\r\n\r\n> Oh, that only works for the request side. If we get:\r\n> \r\n> ```\r\n>  0s peer A: INV deadbeef...\r\n>  1s peer B: INV deadbeef...\r\n>  ...\r\n>  5s peer Z: INV deadbeef\r\n> ```\r\n> and then we happen to query some unresponsive peers, we'll see:\r\n> \r\n> ```\r\n> 10s: -> peer D: GETDATA deadbeef...\r\n> 610s: [expired]\r\n> 611s: -> peer Q: GETDATA deadbeef...\r\n> 1211s: [expired]\r\n> ```\r\n> At which point every peer will have decided \"it's been >15m, I'll expire the deadbeef... tx from mapRelay, and then every node will respond with NOTFOUND for that tx...\r\n\r\nI think there's a misunderstanding here.  The design here is supposed to be that every 1 minute (GETDATA_TX_INTERVAL), we will send a GETDATA for a txid that we want to a new peer, while every 10 minutes (TX_EXPIRY_INTERVAL) we'll clear out the in-flight request to a peer we've asked for a given txid, to make room for asking that peer for other txid's (since we cap the in-flight size to 100).  Your example makes me think that you were looking at the 10-minute timer as applying to both new requests and expiring from the data structure, which should not be the case...?",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-04-22T18:43:18Z",
      "diff_hunk" : "@@ -75,6 +75,8 @@ static constexpr int64_t INBOUND_PEER_TX_DELAY = 2 * 1000000;\n static constexpr int64_t GETDATA_TX_INTERVAL = 60 * 1000000;\n /** Maximum delay (in microseconds) for transaction requests to avoid biasing some peers over others. */\n static constexpr int64_t MAX_GETDATA_RANDOM_DELAY = 2 * 1000000;\n+/** How long to wait (in microseconds) before expiring a getdata request to a peer */\n+static constexpr int64_t TX_EXPIRY_INTERVAL = 10 * GETDATA_TX_INTERVAL;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r277390154",
      "id" : 277390154,
      "in_reply_to_id" : 276046301,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NzM5MDE1NA==",
      "original_commit_id" : "7c4e69c6dcde13c572888fa7d00f70157b1f32aa",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : 13,
      "pull_request_review_id" : 229189158,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-05-28T20:28:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/277390154",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r277390327"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/277390327"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sounds good, thanks.",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-04-22T18:43:43Z",
      "diff_hunk" : "@@ -3911,6 +3927,27 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n         //\n         // Message: getdata (non-blocks)\n         //\n+\n+        // For robustness, expire old requests after a long timeout, so that\n+        // we can resume downloading transactions from a peer even if they\n+        // were unresponsive in the past.\n+        // Eventually we should consider disconnecting peers, but this is\n+        // conservative.\n+        if (state.m_tx_download.m_check_expiry_timer <= nNow) {\n+            for (auto it=state.m_tx_download.m_tx_in_flight.begin(); it != state.m_tx_download.m_tx_in_flight.end();) {\n+                if (it->second <= nNow - TX_EXPIRY_INTERVAL) {\n+                    LogPrint(BCLog::NET, \"timeout of inflight tx %s from peer %d\\n\", it->first.ToString(), pto->GetId());\n+                    state.m_tx_download.m_tx_announced.erase(it->first);\n+                    state.m_tx_download.m_tx_in_flight.erase(it++);\n+                } else {\n+                    ++it;\n+                }\n+            }\n+            // On average, we do this check every TX_EXPIRY_INTERVAL. Randomize\n+            // so that we're not doing this for all peers at the same time.\n+            state.m_tx_download.m_check_expiry_timer = nNow + GetRand(2*TX_EXPIRY_INTERVAL);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r277390327",
      "id" : 277390327,
      "in_reply_to_id" : 276073773,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NzM5MDMyNw==",
      "original_commit_id" : "7c4e69c6dcde13c572888fa7d00f70157b1f32aa",
      "original_position" : 67,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 229189390,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-05-28T20:28:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/277390327",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r277530762"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/277530762"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yeah, I think I got the `GetTxRequestTime` check confused with checking whether it was inflight via another node at all, rather than just hadn't been asked for for a while.",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-04-23T06:20:26Z",
      "diff_hunk" : "@@ -75,6 +75,8 @@ static constexpr int64_t INBOUND_PEER_TX_DELAY = 2 * 1000000;\n static constexpr int64_t GETDATA_TX_INTERVAL = 60 * 1000000;\n /** Maximum delay (in microseconds) for transaction requests to avoid biasing some peers over others. */\n static constexpr int64_t MAX_GETDATA_RANDOM_DELAY = 2 * 1000000;\n+/** How long to wait (in microseconds) before expiring a getdata request to a peer */\n+static constexpr int64_t TX_EXPIRY_INTERVAL = 10 * GETDATA_TX_INTERVAL;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r277530762",
      "id" : 277530762,
      "in_reply_to_id" : 276046301,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI3NzUzMDc2Mg==",
      "original_commit_id" : "7c4e69c6dcde13c572888fa7d00f70157b1f32aa",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : 13,
      "pull_request_review_id" : 229364684,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-05-28T20:28:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/277530762",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've updated this PR and believe the bugs have now been fixed.  I've also got a test, but with the delays involved it takes a very long time to run (ie the test has to sit around and wait for various timeouts).  I'm guessing people don't want to include a test in the test suite (even an extended test) that would take tens of minutes to complete.\r\n\r\nWould reviewers prefer me to switch the uses of GetTimeMicros() in the logic to GetTime() so that we can mock it, and then include a functional test that uses mocktime?  If such tests are viewed as too contrived then I'll skip it and leave this PR as is.",
      "created_at" : "2019-05-03T20:17:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#issuecomment-489226513",
      "id" : 489226513,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15834",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ4OTIyNjUxMw==",
      "updated_at" : "2019-05-03T20:17:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/489226513",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for making progress here. Testing now.",
      "created_at" : "2019-05-11T20:12:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#issuecomment-491540511",
      "id" : 491540511,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15834",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5MTU0MDUxMQ==",
      "updated_at" : "2019-05-11T20:12:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/491540511",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r283110423"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/283110423"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "we use peer= almost everwhere in our net logs, you're messing up my log grepping. ",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-05-11T20:25:10Z",
      "diff_hunk" : "@@ -3911,9 +3952,33 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n         //\n         // Message: getdata (non-blocks)\n         //\n+\n+        // For robustness, expire old requests after a long timeout, so that\n+        // we can resume downloading transactions from a peer even if they\n+        // were unresponsive in the past.\n+        // Eventually we should consider disconnecting peers, but this is\n+        // conservative.\n+        if (state.m_tx_download.m_check_expiry_timer <= nNow) {\n+            for (auto it=state.m_tx_download.m_tx_in_flight.begin(); it != state.m_tx_download.m_tx_in_flight.end();) {\n+                if (it->second <= nNow - TX_EXPIRY_INTERVAL) {\n+                    LogPrint(BCLog::NET, \"timeout of inflight tx %s from peer %d\\n\", it->first.ToString(), pto->GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r283110423",
      "id" : 283110423,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MzExMDQyMw==",
      "original_commit_id" : "25f710929aa15904189587647b2a52254960ecd8",
      "original_position" : 146,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 236391412,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-05-28T20:28:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/283110423",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r283110646"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/283110646"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "My comment on the interval was mostly that we'll expire all past the first ten to offer to us before we ever get to them. The discussion with AJ sorted out my confusion.",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-05-11T20:33:37Z",
      "diff_hunk" : "@@ -75,6 +75,8 @@ static constexpr int64_t INBOUND_PEER_TX_DELAY = 2 * 1000000;\n static constexpr int64_t GETDATA_TX_INTERVAL = 60 * 1000000;\n /** Maximum delay (in microseconds) for transaction requests to avoid biasing some peers over others. */\n static constexpr int64_t MAX_GETDATA_RANDOM_DELAY = 2 * 1000000;\n+/** How long to wait (in microseconds) before expiring a getdata request to a peer */\n+static constexpr int64_t TX_EXPIRY_INTERVAL = 10 * GETDATA_TX_INTERVAL;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r283110646",
      "id" : 283110646,
      "in_reply_to_id" : 276046301,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MzExMDY0Ng==",
      "original_commit_id" : "7c4e69c6dcde13c572888fa7d00f70157b1f32aa",
      "original_position" : 5,
      "path" : "src/net_processing.cpp",
      "position" : 13,
      "pull_request_review_id" : 236391638,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-05-28T20:28:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/283110646",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/858454?v=4",
         "events_url" : "https://api.github.com/users/gmaxwell/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gmaxwell/followers",
         "following_url" : "https://api.github.com/users/gmaxwell/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gmaxwell/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gmaxwell",
         "id" : 858454,
         "login" : "gmaxwell",
         "node_id" : "MDQ6VXNlcjg1ODQ1NA==",
         "organizations_url" : "https://api.github.com/users/gmaxwell/orgs",
         "received_events_url" : "https://api.github.com/users/gmaxwell/received_events",
         "repos_url" : "https://api.github.com/users/gmaxwell/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gmaxwell/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gmaxwell"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r283913008"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/283913008"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`it = m_tx_in_flight.erase(it)` should do the same thing fwiw",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-05-14T17:23:23Z",
      "diff_hunk" : "@@ -3911,9 +3952,33 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n         //\n         // Message: getdata (non-blocks)\n         //\n+\n+        // For robustness, expire old requests after a long timeout, so that\n+        // we can resume downloading transactions from a peer even if they\n+        // were unresponsive in the past.\n+        // Eventually we should consider disconnecting peers, but this is\n+        // conservative.\n+        if (state.m_tx_download.m_check_expiry_timer <= nNow) {\n+            for (auto it=state.m_tx_download.m_tx_in_flight.begin(); it != state.m_tx_download.m_tx_in_flight.end();) {\n+                if (it->second <= nNow - TX_EXPIRY_INTERVAL) {\n+                    LogPrint(BCLog::NET, \"timeout of inflight tx %s from peer %d\\n\", it->first.ToString(), pto->GetId());\n+                    state.m_tx_download.m_tx_announced.erase(it->first);\n+                    state.m_tx_download.m_tx_in_flight.erase(it++);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r283913008",
      "id" : 283913008,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MzkxMzAwOA==",
      "original_commit_id" : "25f710929aa15904189587647b2a52254960ecd8",
      "original_position" : 148,
      "path" : "src/net_processing.cpp",
      "position" : 156,
      "pull_request_review_id" : 237391774,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-05-28T20:28:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/283913008",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r284352320"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284352320"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Worth mentioning this applies to inflight txns?",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-05-15T16:48:30Z",
      "diff_hunk" : "@@ -75,6 +75,8 @@ static constexpr int64_t INBOUND_PEER_TX_DELAY = 2 * 1000000;\n static constexpr int64_t GETDATA_TX_INTERVAL = 60 * 1000000;\n /** Maximum delay (in microseconds) for transaction requests to avoid biasing some peers over others. */\n static constexpr int64_t MAX_GETDATA_RANDOM_DELAY = 2 * 1000000;\n+/** How long to wait (in microseconds) before expiring a getdata request to a peer */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r284352320",
      "id" : 284352320,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4NDM1MjMyMA==",
      "original_commit_id" : "25f710929aa15904189587647b2a52254960ecd8",
      "original_position" : 4,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 237946231,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-05-28T20:28:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284352320",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r284353335"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284353335"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Nit: While reviewing I found myself annotating with comments, then saw similar comments existed a few lines higher up... perhaps do the same, at least for values that don't depend on other constants?\r\n\r\n```diff\r\n /** Maximum number of announced transactions from a peer */\r\n-static constexpr int32_t MAX_PEER_TX_ANNOUNCEMENTS = 2 * MAX_INV_SZ;\r\n+static constexpr int32_t MAX_PEER_TX_ANNOUNCEMENTS = 2 * MAX_INV_SZ; // 2 * 50,000 = 100,000\r\n /** How many microseconds to delay requesting transactions from inbound peers */\r\n-static constexpr int64_t INBOUND_PEER_TX_DELAY = 2 * 1000000;\r\n+static constexpr int64_t INBOUND_PEER_TX_DELAY = 2 * 1000000; // 2 seconds\r\n /** How long to wait (in microseconds) before downloading a transaction from an additional peer */\r\n-static constexpr int64_t GETDATA_TX_INTERVAL = 60 * 1000000;\r\n+static constexpr int64_t GETDATA_TX_INTERVAL = 60 * 1000000; // 1 minute\r\n /** Maximum delay (in microseconds) for transaction requests to avoid biasing some peers over others. */\r\n-static constexpr int64_t MAX_GETDATA_RANDOM_DELAY = 2 * 1000000;\r\n+static constexpr int64_t MAX_GETDATA_RANDOM_DELAY = 2 * 1000000; // 2 seconds\r\n /** How long to wait (in microseconds) before expiring a getdata request to a peer */\r\n-static constexpr int64_t TX_EXPIRY_INTERVAL = 10 * GETDATA_TX_INTERVAL;\r\n+static constexpr int64_t TX_EXPIRY_INTERVAL = 10 * GETDATA_TX_INTERVAL; // 10 minutes\r\n```\r\n",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-05-15T16:51:09Z",
      "diff_hunk" : "@@ -75,6 +75,8 @@ static constexpr int64_t INBOUND_PEER_TX_DELAY = 2 * 1000000;\n static constexpr int64_t GETDATA_TX_INTERVAL = 60 * 1000000;\n /** Maximum delay (in microseconds) for transaction requests to avoid biasing some peers over others. */\n static constexpr int64_t MAX_GETDATA_RANDOM_DELAY = 2 * 1000000;\n+/** How long to wait (in microseconds) before expiring a getdata request to a peer */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r284353335",
      "id" : 284353335,
      "in_reply_to_id" : 284352320,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4NDM1MzMzNQ==",
      "original_commit_id" : "25f710929aa15904189587647b2a52254960ecd8",
      "original_position" : 4,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 237946231,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-05-28T20:28:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284353335",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r284437333"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284437333"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`CalculateTxGetDataTime()` recalculates `last_request_time` and tests it against 0 via this path which seems a bit useless, but probably cleaner this way than trying to change it.",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-05-15T20:29:40Z",
      "diff_hunk" : "@@ -3987,14 +3998,14 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n                     // up processing to happen after the download times out\n                     // (with a slight delay for inbound peers, to prefer\n                     // requests to outbound peers).\n-                    RequestTx(&state, txid, nNow);\n+                    int64_t next_process_time = CalculateTxGetDataTime(txid, nNow, !state.fPreferredDownload);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r284437333",
      "id" : 284437333,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4NDQzNzMzMw==",
      "original_commit_id" : "25f710929aa15904189587647b2a52254960ecd8",
      "original_position" : 65,
      "path" : "src/net_processing.cpp",
      "position" : 188,
      "pull_request_review_id" : 238053807,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-05-28T20:28:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/284437333",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Addressed some nits.  Old version is [15834.1](https://github.com/sdaftuar/bitcoin/commits/15834.1)",
      "created_at" : "2019-05-28T20:30:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#issuecomment-496677188",
      "id" : 496677188,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15834",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5NjY3NzE4OA==",
      "updated_at" : "2019-05-28T20:30:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/496677188",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r288288766"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/288288766"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-05-28T20:30:14Z",
      "diff_hunk" : "@@ -3911,9 +3952,33 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n         //\n         // Message: getdata (non-blocks)\n         //\n+\n+        // For robustness, expire old requests after a long timeout, so that\n+        // we can resume downloading transactions from a peer even if they\n+        // were unresponsive in the past.\n+        // Eventually we should consider disconnecting peers, but this is\n+        // conservative.\n+        if (state.m_tx_download.m_check_expiry_timer <= nNow) {\n+            for (auto it=state.m_tx_download.m_tx_in_flight.begin(); it != state.m_tx_download.m_tx_in_flight.end();) {\n+                if (it->second <= nNow - TX_EXPIRY_INTERVAL) {\n+                    LogPrint(BCLog::NET, \"timeout of inflight tx %s from peer %d\\n\", it->first.ToString(), pto->GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r288288766",
      "id" : 288288766,
      "in_reply_to_id" : 283110423,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4ODI4ODc2Ng==",
      "original_commit_id" : "25f710929aa15904189587647b2a52254960ecd8",
      "original_position" : 146,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 242904505,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-05-28T20:30:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/288288766",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r288288895"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/288288895"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks for the tip, but leaving this alone.",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-05-28T20:30:33Z",
      "diff_hunk" : "@@ -3911,9 +3952,33 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n         //\n         // Message: getdata (non-blocks)\n         //\n+\n+        // For robustness, expire old requests after a long timeout, so that\n+        // we can resume downloading transactions from a peer even if they\n+        // were unresponsive in the past.\n+        // Eventually we should consider disconnecting peers, but this is\n+        // conservative.\n+        if (state.m_tx_download.m_check_expiry_timer <= nNow) {\n+            for (auto it=state.m_tx_download.m_tx_in_flight.begin(); it != state.m_tx_download.m_tx_in_flight.end();) {\n+                if (it->second <= nNow - TX_EXPIRY_INTERVAL) {\n+                    LogPrint(BCLog::NET, \"timeout of inflight tx %s from peer %d\\n\", it->first.ToString(), pto->GetId());\n+                    state.m_tx_download.m_tx_announced.erase(it->first);\n+                    state.m_tx_download.m_tx_in_flight.erase(it++);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r288288895",
      "id" : 288288895,
      "in_reply_to_id" : 283913008,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4ODI4ODg5NQ==",
      "original_commit_id" : "25f710929aa15904189587647b2a52254960ecd8",
      "original_position" : 148,
      "path" : "src/net_processing.cpp",
      "position" : 156,
      "pull_request_review_id" : 242904653,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-05-28T20:30:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/288288895",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r288288978"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/288288978"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done and done.",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-05-28T20:30:44Z",
      "diff_hunk" : "@@ -75,6 +75,8 @@ static constexpr int64_t INBOUND_PEER_TX_DELAY = 2 * 1000000;\n static constexpr int64_t GETDATA_TX_INTERVAL = 60 * 1000000;\n /** Maximum delay (in microseconds) for transaction requests to avoid biasing some peers over others. */\n static constexpr int64_t MAX_GETDATA_RANDOM_DELAY = 2 * 1000000;\n+/** How long to wait (in microseconds) before expiring a getdata request to a peer */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r288288978",
      "id" : 288288978,
      "in_reply_to_id" : 284352320,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4ODI4ODk3OA==",
      "original_commit_id" : "25f710929aa15904189587647b2a52254960ecd8",
      "original_position" : 4,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 242904752,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-05-28T20:30:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/288288978",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> If the functional test is already written, I'd run it and certainly review it as an exercise to understand it.\r\n\r\n@jonatack You can take a look at this if you'd like: https://github.com/sdaftuar/bitcoin/commit/db8fc5a2e25b6fcb08924e57f3a3a1acef6611ea\r\n\r\nTook a bit over 30 minutes the last time I ran it.\r\n",
      "created_at" : "2019-05-28T21:11:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#issuecomment-496691710",
      "id" : 496691710,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15834",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5NjY5MTcxMA==",
      "updated_at" : "2019-05-28T21:11:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/496691710",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "utACK 308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-05-29T03:36:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#issuecomment-496771040",
      "id" : 496771040,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15834",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5Njc3MTA0MA==",
      "updated_at" : "2019-05-29T03:36:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/496771040",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> @jonatack You can take a look at this if you'd like: [sdaftuar@db8fc5a](https://github.com/sdaftuar/bitcoin/commit/db8fc5a2e25b6fcb08924e57f3a3a1acef6611ea)\r\n> \r\n> Took a bit over 30 minutes the last time I ran it.\r\n\r\nThanks @sdaftuar. Initial run passed in ~23 minutes.\r\n\r\n```\r\n((HEAD detached at sdaftuar/test-15834))$  test/functional/feature_tx_download.py\r\n2019-05-30T12:38:57.455000Z TestFramework (INFO): Initializing test directory /tmp/bitcoin_func_test_gtfeuu95\r\n2019-05-30T12:39:07.025000Z TestFramework (INFO): Nodes are setup with balances\r\n2019-05-30T12:52:10.085000Z TestFramework (INFO): ---> Generated txid c9d4f3abccaef1315b216a9300efb64d2c91c37dc25fa451ce8af70dae7794b0\r\n2019-05-30T12:52:11.170000Z TestFramework (INFO): ---> Mempools synced\r\n2019-05-30T12:52:11.171000Z TestFramework (INFO): Testing transaction requests\r\n2019-05-30T13:01:36.534000Z TestFramework (INFO): Stopping nodes\r\n2019-05-30T13:01:36.847000Z TestFramework (INFO): Cleaning up /tmp/bitcoin_func_test_gtfeuu95 on exit\r\n2019-05-30T13:01:36.848000Z TestFramework (INFO): Tests successful\r\n```\r\n(Edit: 2 more runs clocked in at 23 and 22 minutes. Am reviewing code and test.)",
      "created_at" : "2019-05-30T13:09:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#issuecomment-497323434",
      "id" : 497323434,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15834",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5NzMyMzQzNA==",
      "updated_at" : "2019-05-30T15:36:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/497323434",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r291253714"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/291253714"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This comment is slightly confusing in this PR, but I think the code logic is correct.  The idea is that if the tx isn't in_flight from you then there is no reason to try erasing it from `m_tx_announced`, because if its in there you are still going to deal with it at some later point via `m_tx_process_time`",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-06-06T15:53:45Z",
      "diff_hunk" : "@@ -3120,8 +3120,27 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     }\n \n     if (strCommand == NetMsgType::NOTFOUND) {\n-        // We do not care about the NOTFOUND message, but logging an Unknown Command\n-        // message would be undesirable as we transmit it ourselves.\n+        // Remove the NOTFOUND transactions from the peer\n+        LOCK(cs_main);\n+        CNodeState *state = State(pfrom->GetId());\n+        std::vector<CInv> vInv;\n+        vRecv >> vInv;\n+        if (vInv.size() <= MAX_PEER_TX_IN_FLIGHT + MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n+            for (CInv &inv : vInv) {\n+                if (inv.type == MSG_TX || inv.type == MSG_WITNESS_TX) {\n+                    // If we receive a NOTFOUND message for a txid we requested, erase\n+                    // it from our data structures for this peer.\n+                    auto in_flight_it = state->m_tx_download.m_tx_in_flight.find(inv.hash);\n+                    if (in_flight_it == state->m_tx_download.m_tx_in_flight.end()) {\n+                        // Skip any further work if this is a spurious NOTFOUND",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r291253714",
      "id" : 291253714,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MTI1MzcxNA==",
      "original_commit_id" : "e32e08407e2781d881b9da92aa06494525ddd085",
      "original_position" : 18,
      "path" : "src/net_processing.cpp",
      "position" : 129,
      "pull_request_review_id" : 246662432,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-06-06T15:53:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/291253714",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/4360349?v=4",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "node_id" : "MDQ6VXNlcjQzNjAzNDk=",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I reviewed the logic and tried to think through various failure modes and did a light review of the code.\r\nlight ACK 308b767",
      "created_at" : "2019-06-06T15:53:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#issuecomment-499555837",
      "id" : 499555837,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15834",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQ5OTU1NTgzNw==",
      "updated_at" : "2019-06-06T15:53:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/499555837",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/4360349?v=4",
         "events_url" : "https://api.github.com/users/morcos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/morcos/followers",
         "following_url" : "https://api.github.com/users/morcos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/morcos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/morcos",
         "id" : 4360349,
         "login" : "morcos",
         "node_id" : "MDQ6VXNlcjQzNjAzNDk=",
         "organizations_url" : "https://api.github.com/users/morcos/orgs",
         "received_events_url" : "https://api.github.com/users/morcos/received_events",
         "repos_url" : "https://api.github.com/users/morcos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/morcos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/morcos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/morcos"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r291899918"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/291899918"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Was confused about why we're consulting `MAX_BLOCKS_IN_TRANSIT_PER_PEER` for tx-based logic, but I guess this is just to avoid wasting time reading too-long DoSy INVs?",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-06-10T07:01:30Z",
      "diff_hunk" : "@@ -3120,8 +3120,27 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     }\n \n     if (strCommand == NetMsgType::NOTFOUND) {\n-        // We do not care about the NOTFOUND message, but logging an Unknown Command\n-        // message would be undesirable as we transmit it ourselves.\n+        // Remove the NOTFOUND transactions from the peer\n+        LOCK(cs_main);\n+        CNodeState *state = State(pfrom->GetId());\n+        std::vector<CInv> vInv;\n+        vRecv >> vInv;\n+        if (vInv.size() <= MAX_PEER_TX_IN_FLIGHT + MAX_BLOCKS_IN_TRANSIT_PER_PEER) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r291899918",
      "id" : 291899918,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MTg5OTkxOA==",
      "original_commit_id" : "e32e08407e2781d881b9da92aa06494525ddd085",
      "original_position" : 11,
      "path" : "src/net_processing.cpp",
      "position" : 122,
      "pull_request_review_id" : 247473556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-06-11T01:49:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/291899918",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r291901132"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/291901132"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If you care to, I think the body of this loop can be written more simply as\r\n```cpp\r\nif (inv.type == MSG_TX || inv.type == MSG_WITNESS_TX) {\r\n    // If we receive a NOTFOUND message for a txid we requested, erase\r\n    // it from our data structures for this peer.\r\n    if (state->m_tx_download.m_tx_in_flight.erase(inv.hash) > 0) {\r\n        state->m_tx_download.m_tx_announced.erase(inv.hash);\r\n   }\r\n}\r\n    \r\n```",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-06-10T07:08:02Z",
      "diff_hunk" : "@@ -3120,8 +3120,27 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     }\n \n     if (strCommand == NetMsgType::NOTFOUND) {\n-        // We do not care about the NOTFOUND message, but logging an Unknown Command\n-        // message would be undesirable as we transmit it ourselves.\n+        // Remove the NOTFOUND transactions from the peer\n+        LOCK(cs_main);\n+        CNodeState *state = State(pfrom->GetId());\n+        std::vector<CInv> vInv;\n+        vRecv >> vInv;\n+        if (vInv.size() <= MAX_PEER_TX_IN_FLIGHT + MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n+            for (CInv &inv : vInv) {\n+                if (inv.type == MSG_TX || inv.type == MSG_WITNESS_TX) {\n+                    // If we receive a NOTFOUND message for a txid we requested, erase\n+                    // it from our data structures for this peer.\n+                    auto in_flight_it = state->m_tx_download.m_tx_in_flight.find(inv.hash);\n+                    if (in_flight_it == state->m_tx_download.m_tx_in_flight.end()) {\n+                        // Skip any further work if this is a spurious NOTFOUND\n+                        // message.\n+                        continue;\n+                    }\n+                    state->m_tx_download.m_tx_in_flight.erase(in_flight_it);\n+                    state->m_tx_download.m_tx_announced.erase(inv.hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r291901132",
      "id" : 291901132,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MTkwMTEzMg==",
      "original_commit_id" : "e32e08407e2781d881b9da92aa06494525ddd085",
      "original_position" : 23,
      "path" : "src/net_processing.cpp",
      "position" : 134,
      "pull_request_review_id" : 247473556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-06-11T01:49:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/291901132",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review ACK 308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-06-10T10:26:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#issuecomment-500368449",
      "id" : 500368449,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15834",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwMDM2ODQ0OQ==",
      "updated_at" : "2019-06-10T10:26:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/500368449",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r292248655"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292248655"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`RequestTx()` does the same as the two lines below, but performs `.size()` checks on the tx maps and ensures the txid is in `m_tx_announced`. Are we not just calling that because we don't care to do those checks as belt-and-suspenders, or do we specifically want to avoid populating `m_tx_announced`? I guess those checks are safe to avoid given txid was already in `tx_process_time`, but seems like it wouldn't hurt to do them anyway.",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-06-11T01:32:24Z",
      "diff_hunk" : "@@ -3987,14 +3998,14 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n                     // up processing to happen after the download times out\n                     // (with a slight delay for inbound peers, to prefer\n                     // requests to outbound peers).\n-                    RequestTx(&state, txid, nNow);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r292248655",
      "id" : 292248655,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MjI0ODY1NQ==",
      "original_commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "original_position" : 64,
      "path" : "src/net_processing.cpp",
      "position" : 187,
      "pull_request_review_id" : 247473556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-06-11T01:49:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292248655",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r292250774"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292250774"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe worth noting that I *think* `m_tx_process_time` is liable to outgrow `m_tx_announced` temporarily (e.g. we ask peer for txid, get back NOTFOUND, `m_tx_announced` entry immediately erased but `m_tx_process_time` entry hangs around until next `SendMessages()`) but I think this is negligible.",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-06-11T01:45:48Z",
      "diff_hunk" : "@@ -699,7 +699,9 @@ void UpdateTxRequestTime(const uint256& txid, int64_t request_time) EXCLUSIVE_LO\n void RequestTx(CNodeState* state, const uint256& txid, int64_t nNow) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n {\n     CNodeState::TxDownloadState& peer_download_state = state->m_tx_download;\n-    if (peer_download_state.m_tx_announced.size() >= MAX_PEER_TX_ANNOUNCEMENTS || peer_download_state.m_tx_announced.count(txid)) {\n+    if (peer_download_state.m_tx_announced.size() >= MAX_PEER_TX_ANNOUNCEMENTS ||\n+            peer_download_state.m_tx_process_time.size() >= MAX_PEER_TX_ANNOUNCEMENTS ||",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r292250774",
      "id" : 292250774,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MjI1MDc3NA==",
      "original_commit_id" : "23163b759354b84c5a076e3e2ae6ae6338106035",
      "original_position" : 6,
      "path" : "src/net_processing.cpp",
      "position" : 71,
      "pull_request_review_id" : 247473556,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-06-11T01:49:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292250774",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r292379043"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292379043"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit 23163b7593 Add an explicit memory bound to m_tx_process_time:\r\n\r\nstyle-nit: Could remove the `.count()` here and add the check below: `if(!insert().second) return; // already have`. (This is how the code looked like in previous versions of Bitcoin Core)",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-06-11T10:10:05Z",
      "diff_hunk" : "@@ -699,7 +699,9 @@ void UpdateTxRequestTime(const uint256& txid, int64_t request_time) EXCLUSIVE_LO\n void RequestTx(CNodeState* state, const uint256& txid, int64_t nNow) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n {\n     CNodeState::TxDownloadState& peer_download_state = state->m_tx_download;\n-    if (peer_download_state.m_tx_announced.size() >= MAX_PEER_TX_ANNOUNCEMENTS || peer_download_state.m_tx_announced.count(txid)) {\n+    if (peer_download_state.m_tx_announced.size() >= MAX_PEER_TX_ANNOUNCEMENTS ||\n+            peer_download_state.m_tx_process_time.size() >= MAX_PEER_TX_ANNOUNCEMENTS ||\n+            peer_download_state.m_tx_announced.count(txid)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r292379043",
      "id" : 292379043,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MjM3OTA0Mw==",
      "original_commit_id" : "23163b759354b84c5a076e3e2ae6ae6338106035",
      "original_position" : 7,
      "path" : "src/net_processing.cpp",
      "position" : 72,
      "pull_request_review_id" : 248077649,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-06-11T11:31:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292379043",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r292388169"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292388169"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Re https://github.com/bitcoin/bitcoin/pull/15834/commits/23163b759354b84c5a076e3e2ae6ae6338106035#r292250774:\r\n\r\nThat shouldn't matter, since something else must have gone horribly wrong when there are more than `MAX_PEER_TX_ANNOUNCEMENTS` == 100k.",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-06-11T10:34:58Z",
      "diff_hunk" : "@@ -699,7 +699,9 @@ void UpdateTxRequestTime(const uint256& txid, int64_t request_time) EXCLUSIVE_LO\n void RequestTx(CNodeState* state, const uint256& txid, int64_t nNow) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n {\n     CNodeState::TxDownloadState& peer_download_state = state->m_tx_download;\n-    if (peer_download_state.m_tx_announced.size() >= MAX_PEER_TX_ANNOUNCEMENTS || peer_download_state.m_tx_announced.count(txid)) {\n+    if (peer_download_state.m_tx_announced.size() >= MAX_PEER_TX_ANNOUNCEMENTS ||\n+            peer_download_state.m_tx_process_time.size() >= MAX_PEER_TX_ANNOUNCEMENTS ||",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r292388169",
      "id" : 292388169,
      "in_reply_to_id" : 292250774,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MjM4ODE2OQ==",
      "original_commit_id" : "23163b759354b84c5a076e3e2ae6ae6338106035",
      "original_position" : 6,
      "path" : "src/net_processing.cpp",
      "position" : 71,
      "pull_request_review_id" : 248077649,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-06-11T11:31:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292388169",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r292390278"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292390278"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit e32e08407e Remove NOTFOUND transactions from in-flight data structures:\r\n\r\ndoc-nit: Maybe add a comment `// We only send NOTFOUNDs for transactions, but for any peer, this message should never be larger than all in-flight inventory items`?",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-06-11T10:41:14Z",
      "diff_hunk" : "@@ -3120,8 +3120,27 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     }\n \n     if (strCommand == NetMsgType::NOTFOUND) {\n-        // We do not care about the NOTFOUND message, but logging an Unknown Command\n-        // message would be undesirable as we transmit it ourselves.\n+        // Remove the NOTFOUND transactions from the peer\n+        LOCK(cs_main);\n+        CNodeState *state = State(pfrom->GetId());\n+        std::vector<CInv> vInv;\n+        vRecv >> vInv;\n+        if (vInv.size() <= MAX_PEER_TX_IN_FLIGHT + MAX_BLOCKS_IN_TRANSIT_PER_PEER) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r292390278",
      "id" : 292390278,
      "in_reply_to_id" : 291899918,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MjM5MDI3OA==",
      "original_commit_id" : "e32e08407e2781d881b9da92aa06494525ddd085",
      "original_position" : 11,
      "path" : "src/net_processing.cpp",
      "position" : 122,
      "pull_request_review_id" : 248077649,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-06-11T11:31:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292390278",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r292397647"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292397647"
         }
      },
      "author_association" : "MEMBER",
      "body" : "re https://github.com/bitcoin/bitcoin/pull/15834/commits/e32e08407e2781d881b9da92aa06494525ddd085#r291253714:\r\n\r\nI think \"spurious\" is still fine. Why would a node announce you a tx and then follow up with a NOTFOUND without any further communication with you.",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-06-11T11:00:57Z",
      "diff_hunk" : "@@ -3120,8 +3120,27 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     }\n \n     if (strCommand == NetMsgType::NOTFOUND) {\n-        // We do not care about the NOTFOUND message, but logging an Unknown Command\n-        // message would be undesirable as we transmit it ourselves.\n+        // Remove the NOTFOUND transactions from the peer\n+        LOCK(cs_main);\n+        CNodeState *state = State(pfrom->GetId());\n+        std::vector<CInv> vInv;\n+        vRecv >> vInv;\n+        if (vInv.size() <= MAX_PEER_TX_IN_FLIGHT + MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n+            for (CInv &inv : vInv) {\n+                if (inv.type == MSG_TX || inv.type == MSG_WITNESS_TX) {\n+                    // If we receive a NOTFOUND message for a txid we requested, erase\n+                    // it from our data structures for this peer.\n+                    auto in_flight_it = state->m_tx_download.m_tx_in_flight.find(inv.hash);\n+                    if (in_flight_it == state->m_tx_download.m_tx_in_flight.end()) {\n+                        // Skip any further work if this is a spurious NOTFOUND",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r292397647",
      "id" : 292397647,
      "in_reply_to_id" : 291253714,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MjM5NzY0Nw==",
      "original_commit_id" : "e32e08407e2781d881b9da92aa06494525ddd085",
      "original_position" : 18,
      "path" : "src/net_processing.cpp",
      "position" : 129,
      "pull_request_review_id" : 248077649,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-06-11T11:31:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292397647",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r292398250"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292398250"
         }
      },
      "author_association" : "MEMBER",
      "body" : "re https://github.com/bitcoin/bitcoin/pull/15834/commits/e32e08407e2781d881b9da92aa06494525ddd085#r291901132:\r\n\r\nLooks fine, but should keep the \"spurious\" comment ofc.",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-06-11T11:02:37Z",
      "diff_hunk" : "@@ -3120,8 +3120,27 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     }\n \n     if (strCommand == NetMsgType::NOTFOUND) {\n-        // We do not care about the NOTFOUND message, but logging an Unknown Command\n-        // message would be undesirable as we transmit it ourselves.\n+        // Remove the NOTFOUND transactions from the peer\n+        LOCK(cs_main);\n+        CNodeState *state = State(pfrom->GetId());\n+        std::vector<CInv> vInv;\n+        vRecv >> vInv;\n+        if (vInv.size() <= MAX_PEER_TX_IN_FLIGHT + MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n+            for (CInv &inv : vInv) {\n+                if (inv.type == MSG_TX || inv.type == MSG_WITNESS_TX) {\n+                    // If we receive a NOTFOUND message for a txid we requested, erase\n+                    // it from our data structures for this peer.\n+                    auto in_flight_it = state->m_tx_download.m_tx_in_flight.find(inv.hash);\n+                    if (in_flight_it == state->m_tx_download.m_tx_in_flight.end()) {\n+                        // Skip any further work if this is a spurious NOTFOUND\n+                        // message.\n+                        continue;\n+                    }\n+                    state->m_tx_download.m_tx_in_flight.erase(in_flight_it);\n+                    state->m_tx_download.m_tx_announced.erase(inv.hash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r292398250",
      "id" : 292398250,
      "in_reply_to_id" : 291901132,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MjM5ODI1MA==",
      "original_commit_id" : "e32e08407e2781d881b9da92aa06494525ddd085",
      "original_position" : 23,
      "path" : "src/net_processing.cpp",
      "position" : 134,
      "pull_request_review_id" : 248077649,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-06-11T11:31:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292398250",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r292403792"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292403792"
         }
      },
      "author_association" : "MEMBER",
      "body" : "in commit f635a3ba11 Expire old entries from the in-flight tx map:\r\n\r\nstyle-nit: Is it required to guard the iterator increment behind some conditions? It seems less fragile and less code to just remove both in-body iterator mangling and do a normal for-loop, by putting the increment in the for-loop header?",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-06-11T11:19:25Z",
      "diff_hunk" : "@@ -3939,6 +3944,27 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n         //\n         // Message: getdata (non-blocks)\n         //\n+\n+        // For robustness, expire old requests after a long timeout, so that\n+        // we can resume downloading transactions from a peer even if they\n+        // were unresponsive in the past.\n+        // Eventually we should consider disconnecting peers, but this is\n+        // conservative.\n+        if (state.m_tx_download.m_check_expiry_timer <= nNow) {\n+            for (auto it=state.m_tx_download.m_tx_in_flight.begin(); it != state.m_tx_download.m_tx_in_flight.end();) {\n+                if (it->second <= nNow - TX_EXPIRY_INTERVAL) {\n+                    LogPrint(BCLog::NET, \"timeout of inflight tx %s from peer=%d\\n\", it->first.ToString(), pto->GetId());\n+                    state.m_tx_download.m_tx_announced.erase(it->first);\n+                    state.m_tx_download.m_tx_in_flight.erase(it++);\n+                } else {\n+                    ++it;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r292403792",
      "id" : 292403792,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MjQwMzc5Mg==",
      "original_commit_id" : "f635a3ba118aeaf172534f9f802721a6ef07cafc",
      "original_position" : 48,
      "path" : "src/net_processing.cpp",
      "position" : 158,
      "pull_request_review_id" : 248077649,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-06-11T11:31:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292403792",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r292518156"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292518156"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think the questions around why I [structured the loop this way](https://github.com/bitcoin/bitcoin/pull/15834/files/23163b759354b84c5a076e3e2ae6ae6338106035..e32e08407e2781d881b9da92aa06494525ddd085#r291901132) (and why I made a comment about skipping \"any further work\") is motivated by the additional code I plan to add in #15505.  See for instance: https://github.com/bitcoin/bitcoin/pull/15505/commits/f5dbb49c8922cb26d05862b7aacf161bde8ffc5a",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-06-11T15:27:35Z",
      "diff_hunk" : "@@ -3120,8 +3120,27 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     }\n \n     if (strCommand == NetMsgType::NOTFOUND) {\n-        // We do not care about the NOTFOUND message, but logging an Unknown Command\n-        // message would be undesirable as we transmit it ourselves.\n+        // Remove the NOTFOUND transactions from the peer\n+        LOCK(cs_main);\n+        CNodeState *state = State(pfrom->GetId());\n+        std::vector<CInv> vInv;\n+        vRecv >> vInv;\n+        if (vInv.size() <= MAX_PEER_TX_IN_FLIGHT + MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n+            for (CInv &inv : vInv) {\n+                if (inv.type == MSG_TX || inv.type == MSG_WITNESS_TX) {\n+                    // If we receive a NOTFOUND message for a txid we requested, erase\n+                    // it from our data structures for this peer.\n+                    auto in_flight_it = state->m_tx_download.m_tx_in_flight.find(inv.hash);\n+                    if (in_flight_it == state->m_tx_download.m_tx_in_flight.end()) {\n+                        // Skip any further work if this is a spurious NOTFOUND",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r292518156",
      "id" : 292518156,
      "in_reply_to_id" : 291253714,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MjUxODE1Ng==",
      "original_commit_id" : "e32e08407e2781d881b9da92aa06494525ddd085",
      "original_position" : 18,
      "path" : "src/net_processing.cpp",
      "position" : 129,
      "pull_request_review_id" : 248257379,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-06-11T15:34:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292518156",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r292518862"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292518862"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yep that is the reason I had in mind -- a peer might reasonably send us a NOTFOUND for something we sent a GETDATA for, but not more than that. ",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-06-11T15:28:53Z",
      "diff_hunk" : "@@ -3120,8 +3120,27 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     }\n \n     if (strCommand == NetMsgType::NOTFOUND) {\n-        // We do not care about the NOTFOUND message, but logging an Unknown Command\n-        // message would be undesirable as we transmit it ourselves.\n+        // Remove the NOTFOUND transactions from the peer\n+        LOCK(cs_main);\n+        CNodeState *state = State(pfrom->GetId());\n+        std::vector<CInv> vInv;\n+        vRecv >> vInv;\n+        if (vInv.size() <= MAX_PEER_TX_IN_FLIGHT + MAX_BLOCKS_IN_TRANSIT_PER_PEER) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r292518862",
      "id" : 292518862,
      "in_reply_to_id" : 291899918,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MjUxODg2Mg==",
      "original_commit_id" : "e32e08407e2781d881b9da92aa06494525ddd085",
      "original_position" : 11,
      "path" : "src/net_processing.cpp",
      "position" : 122,
      "pull_request_review_id" : 248257379,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-06-11T15:34:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292518862",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r292519963"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292519963"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`RequestTx()` is inappropriate here and was a bug -- see @ajtowns' comment at https://github.com/bitcoin/bitcoin/pull/15834#discussion_r276112938",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-06-11T15:30:53Z",
      "diff_hunk" : "@@ -3987,14 +3998,14 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n                     // up processing to happen after the download times out\n                     // (with a slight delay for inbound peers, to prefer\n                     // requests to outbound peers).\n-                    RequestTx(&state, txid, nNow);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r292519963",
      "id" : 292519963,
      "in_reply_to_id" : 292248655,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MjUxOTk2Mw==",
      "original_commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "original_position" : 64,
      "path" : "src/net_processing.cpp",
      "position" : 187,
      "pull_request_review_id" : 248257379,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-06-11T15:34:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292519963",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r292521468"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292521468"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not sure if I'm misunderstanding your question, but erasing the iterator invalidates it, so we must increment it first -- so we can't just put this in the for-loop header if on some loop iterations we erase and on others we don't.",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-06-11T15:34:00Z",
      "diff_hunk" : "@@ -3939,6 +3944,27 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n         //\n         // Message: getdata (non-blocks)\n         //\n+\n+        // For robustness, expire old requests after a long timeout, so that\n+        // we can resume downloading transactions from a peer even if they\n+        // were unresponsive in the past.\n+        // Eventually we should consider disconnecting peers, but this is\n+        // conservative.\n+        if (state.m_tx_download.m_check_expiry_timer <= nNow) {\n+            for (auto it=state.m_tx_download.m_tx_in_flight.begin(); it != state.m_tx_download.m_tx_in_flight.end();) {\n+                if (it->second <= nNow - TX_EXPIRY_INTERVAL) {\n+                    LogPrint(BCLog::NET, \"timeout of inflight tx %s from peer=%d\\n\", it->first.ToString(), pto->GetId());\n+                    state.m_tx_download.m_tx_announced.erase(it->first);\n+                    state.m_tx_download.m_tx_in_flight.erase(it++);\n+                } else {\n+                    ++it;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r292521468",
      "id" : 292521468,
      "in_reply_to_id" : 292403792,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MjUyMTQ2OA==",
      "original_commit_id" : "f635a3ba118aeaf172534f9f802721a6ef07cafc",
      "original_position" : 48,
      "path" : "src/net_processing.cpp",
      "position" : 158,
      "pull_request_review_id" : 248257379,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-06-11T15:34:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292521468",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @jamesob and @marcofalke.  I'm going to leave the nits alone for now, and if I end up having to update this PR again I'll consider taking the nits at that point.\r\n\r\nTo other reviewers, I think what this PR needs most is additional testing (eg on mainnet).",
      "created_at" : "2019-06-11T15:37:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#issuecomment-500898341",
      "id" : 500898341,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15834",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwMDg5ODM0MQ==",
      "updated_at" : "2019-06-11T15:37:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/500898341",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Light ACK 308b76732f97020c86977e29c854e8e27262cf7c.\r\n\r\nAgree with additional testing. I've been looking at mainnet logs and the functional tests at https://github.com/sdaftuar/bitcoin/commit/db8fc5a2e25b6fcb08924e57f3a3a1acef6611ea to see how they might be improved or run more quickly.\r\n\r\nRough breakdown of current test run times in `feature_tx_download.py`:\r\n- `test_in_flight_max` in particular is a bottleneck at generally 13-15 (up to 25) minutes\r\n- `test_inv_block`:  between 1 and 75 seconds\r\n- `test_tx_requests`: also a hotspot at 9-10 minutes\r\n\r\nAfter the Chaincode seminars these next couple weeks, will hopefully propose tests here or in a follow-up.",
      "created_at" : "2019-06-11T16:43:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#issuecomment-500926520",
      "id" : 500926520,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15834",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwMDkyNjUyMA==",
      "updated_at" : "2019-06-11T16:43:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/500926520",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r292593317"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292593317"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Oops, sorry I missed that. Thanks for the pointer.",
      "commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "created_at" : "2019-06-11T18:11:37Z",
      "diff_hunk" : "@@ -3987,14 +3998,14 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n                     // up processing to happen after the download times out\n                     // (with a slight delay for inbound peers, to prefer\n                     // requests to outbound peers).\n-                    RequestTx(&state, txid, nNow);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#discussion_r292593317",
      "id" : 292593317,
      "in_reply_to_id" : 292248655,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI5MjU5MzMxNw==",
      "original_commit_id" : "308b76732f97020c86977e29c854e8e27262cf7c",
      "original_position" : 64,
      "path" : "src/net_processing.cpp",
      "position" : 187,
      "pull_request_review_id" : 248351728,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15834",
      "updated_at" : "2019-06-11T18:11:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/292593317",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "One other thought for reviewers -- one thing I think we didn't consider very well when #14897 was merged is the effect this change has on the relay of dependent transactions.\r\n\r\nAs a reminder, when a batch of transactions is to be announced to a peer, bitcoind will sort the batch so that parents appear before children in the INV message.  Before #14897, transactions announced by a given peer would be requested in the same order as the announcement (but it was possible for transactions announced by multiple peers to be received in an arbitrary order, of course).\r\n\r\nWhen a parent arrives after a child, we must rely on the orphan map to reconstruct the chain, which is inefficient and error-prone (for anti-DoS reasons we limit the size of the orphan map, so too many orphans could lead to relay failures).  Given that #14897 tries to randomize getdata requests, there is an increased potential for transactions to be fetched out of order, which could be problematic.\r\n\r\nMy understanding of this issue is that we don't randomize the order of getdata's for transactions announced for the first time by outbound peers.  Consequently, my guess is that this is not too big a deal.  But note that (a) our inbound peers will generally announce to us faster than our outbounds (because of the way our software biases to sending with lower poisson delays to outbound peers over inbound ones), and (b) in the future, proposals like Erlay might mean we do much more flooding over outbound links than inbound ones.\r\n\r\nIf we think this is in fact a problem, or will be in the future, then I think the easiest fix would be to not put any delay on transaction requests from an inbound peers when we're learning of a transaction for the first time.  I would like to hold off on addressing this issue in this PR, which I think is a strict improvement over where we are now, but I'm mentioning it in case others are more concerned about the potential severity.",
      "created_at" : "2019-06-11T20:10:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#issuecomment-501003776",
      "id" : 501003776,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15834",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwMTAwMzc3Ng==",
      "updated_at" : "2019-06-11T20:10:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/501003776",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Looks like this has about 6 ACKs. Unless there are objections, this will be merged within the next couple of weeks.\r\n\r\nI am running a node with extended logging for corner cases to see if anything obvious breaks.",
      "created_at" : "2019-06-11T20:22:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#issuecomment-501008051",
      "id" : 501008051,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15834",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwMTAwODA1MQ==",
      "updated_at" : "2019-06-11T20:22:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/501008051",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 308b76732f\r\n\r\nI've run the functional test @sdaftuar wrote (https://github.com/sdaftuar/bitcoin/commit/db8fc5a2e25b6fcb08924e57f3a3a1acef6611ea) and verified that if fails before these changes and passes when cherry-picked on top of this branch.\r\n\r\nI compiled and ran this on mainnet for a few hours. My datadir was somewhat out of date, so this code was tested in both IBD and at tip. I watched `getmempoolinfo` to verify its tx count looked normal and varied within reason. \r\n\r\nParsing debug.log shows robust tx transmission from a variety of peers during testing. Below, the message count and peer ID are shown:\r\n```bash\r\nTue 11 16:51 james/src/bitcoin 308b76732f* (308b76732f) btc\r\n$ grep -E \"got inv.*peer=\" /data/bitcoin/debug.log | cut -d= -f2 | sort | uniq -c\r\n\r\n  26258 0\r\n   5473 1\r\n  16966 12\r\n  25632 2\r\n  23609 3\r\n  25232 6\r\n  24553 7\r\n  25578 8\r\n  25732 9\r\n\r\nTue 11 16:51 james/src/bitcoin 308b76732f* (308b76732f) btc\r\n$ grep -E \"sending getdata.*peer=\" /data/bitcoin/debug.log | cut -d= -f2 | sort | uniq -c\r\n\r\n   2513 0\r\n    200 1\r\n   1010 12\r\n   2967 2\r\n   2124 3\r\n   2417 6\r\n   1761 7\r\n   2712 8\r\n   2661 9\r\n```\r\n\r\nTesting for a few hours doesn't rule out weird edge cases, but gives me pretty good confidence this change is fine.",
      "created_at" : "2019-06-11T20:57:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#issuecomment-501019977",
      "id" : 501019977,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15834",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwMTAxOTk3Nw==",
      "updated_at" : "2019-06-11T20:57:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/501019977",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@MarcoFalke isn't there an argument for merging this sooner rather than later so that it gets wider (if not incidental) test usage before 0.19 is released?",
      "created_at" : "2019-06-11T21:04:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#issuecomment-501022322",
      "id" : 501022322,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15834",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwMTAyMjMyMg==",
      "updated_at" : "2019-06-11T21:04:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/501022322",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Did some tests:\r\n\r\n* :heavy_check_mark: Race between a tx and the same tx in a block is correctly timed out:\r\n\r\nThe excerpt of the debug log shows that peer 7 relays us a tx, which is included in a block shortly after. Then peer 400 announces the tx to us, and we think it is `new` based on our heuristic tests. Peer 400 won't send us the tx anymore (for whatever reason), and it correctly times out on our side.\r\n\r\n```\r\n$ cat ~/.bitcoin/debug.log  | grep --extended-regexp '(98a4959bf387f385b66e81e3ee7e8d6900cd31567cbc90048eb44597540a988d|00000000000000000007f6557ae653c28b86f6346f411981b0618ea423ed5ec0 height)'\r\n2019-06-11T20:06:14Z got inv: tx 98a4959bf387f385b66e81e3ee7e8d6900cd31567cbc90048eb44597540a988d  new peer=7\r\n2019-06-11T20:06:14Z Requesting witness-tx 98a4959bf387f385b66e81e3ee7e8d6900cd31567cbc90048eb44597540a988d peer=7\r\n2019-06-11T20:06:14Z AcceptToMemoryPool: peer=7: accepted 98a4959bf387f385b66e81e3ee7e8d6900cd31567cbc90048eb44597540a988d (poolsz 20531 txn, 43706 kB)\r\n2019-06-11T20:06:16Z got inv: tx 98a4959bf387f385b66e81e3ee7e8d6900cd31567cbc90048eb44597540a988d  have peer=2\r\n2019-06-11T20:06:17Z got inv: tx 98a4959bf387f385b66e81e3ee7e8d6900cd31567cbc90048eb44597540a988d  have peer=306\r\n2019-06-11T20:06:17Z got inv: tx 98a4959bf387f385b66e81e3ee7e8d6900cd31567cbc90048eb44597540a988d  have peer=321\r\n2019-06-11T20:06:18Z got inv: tx 98a4959bf387f385b66e81e3ee7e8d6900cd31567cbc90048eb44597540a988d  have peer=57\r\n2019-06-11T20:09:52Z UpdateTip: new best=00000000000000000007f6557ae653c28b86f6346f411981b0618ea423ed5ec0 height=580289 version=0x3fffe000 log2_work=90.730011 tx=423305186 date='2019-06-11T20:09:29Z' progress=1.000000 cache=20.7MiB(155741txo) warning='39 of last 100 blocks have unexpected version'\r\n2019-06-11T20:10:13Z received getdata for: witness-tx 98a4959bf387f385b66e81e3ee7e8d6900cd31567cbc90048eb44597540a988d peer=0\r\n2019-06-11T20:13:34Z got inv: tx 98a4959bf387f385b66e81e3ee7e8d6900cd31567cbc90048eb44597540a988d  new peer=400\r\n2019-06-11T20:13:36Z Requesting witness-tx 98a4959bf387f385b66e81e3ee7e8d6900cd31567cbc90048eb44597540a988d peer=400\r\n2019-06-11T20:29:04Z timeout of inflight tx 98a4959bf387f385b66e81e3ee7e8d6900cd31567cbc90048eb44597540a988d; id 400, ua /Satoshi:0.17.1/, version 70015, addr 111.37.183.111:9685, tx_relay 1, tx_sendmempool 0, fee_filter 1000, services 000000000000040d, time_connected 972, last_tx 0, last_block 0, last_mempool 0\r\n```\r\n\r\n\r\n* :heavy_check_mark:  A transaction is requested after it was accepted to the mempool (and later mined into a block), due to broken orphan handling (e.g. \" Improve AlreadyHave #7874 \"). Those cases are then at least correctly handled via NOTFOUNDs.\r\n\r\n```\r\n$ cat ~/.bitcoin/debug.log  | grep --extended-regexp '(13f15e0e6e0e0f19b3aa84a7c6d9715991ea5b8ccf8dad9002bee7c25b596aa7|00000000000000000024c923fe8873778e437290e4958234922df101956fa4f4 height|e6dcc6451e35996ce4d823781196830d1731c01d9d3e0fe1683b6e38675c4bf6)'\r\n2019-06-12T10:00:54Z got inv: tx 13f15e0e6e0e0f19b3aa84a7c6d9715991ea5b8ccf8dad9002bee7c25b596aa7  new peer=15\r\n2019-06-12T10:00:54Z Requesting witness-tx 13f15e0e6e0e0f19b3aa84a7c6d9715991ea5b8ccf8dad9002bee7c25b596aa7 peer=15\r\n2019-06-12T10:00:54Z AcceptToMemoryPool: peer=15: accepted 13f15e0e6e0e0f19b3aa84a7c6d9715991ea5b8ccf8dad9002bee7c25b596aa7 (poolsz 20535 txn, 41033 kB)\r\n2019-06-12T10:00:55Z got inv: tx 13f15e0e6e0e0f19b3aa84a7c6d9715991ea5b8ccf8dad9002bee7c25b596aa7  have peer=2596\r\n2019-06-12T10:00:55Z got inv: tx 13f15e0e6e0e0f19b3aa84a7c6d9715991ea5b8ccf8dad9002bee7c25b596aa7  have peer=3747\r\n2019-06-12T10:00:55Z got inv: tx 13f15e0e6e0e0f19b3aa84a7c6d9715991ea5b8ccf8dad9002bee7c25b596aa7  have peer=57\r\n2019-06-12T10:00:56Z got inv: tx 13f15e0e6e0e0f19b3aa84a7c6d9715991ea5b8ccf8dad9002bee7c25b596aa7  have peer=2963\r\n2019-06-12T10:00:56Z got inv: tx 13f15e0e6e0e0f19b3aa84a7c6d9715991ea5b8ccf8dad9002bee7c25b596aa7  have peer=3616\r\n2019-06-12T10:00:56Z got inv: tx 13f15e0e6e0e0f19b3aa84a7c6d9715991ea5b8ccf8dad9002bee7c25b596aa7  have peer=124\r\n2019-06-12T10:00:56Z got inv: tx 13f15e0e6e0e0f19b3aa84a7c6d9715991ea5b8ccf8dad9002bee7c25b596aa7  have peer=3957\r\n2019-06-12T10:00:56Z got inv: tx 13f15e0e6e0e0f19b3aa84a7c6d9715991ea5b8ccf8dad9002bee7c25b596aa7  have peer=1206\r\n2019-06-12T10:00:57Z got inv: tx 13f15e0e6e0e0f19b3aa84a7c6d9715991ea5b8ccf8dad9002bee7c25b596aa7  have peer=4655\r\n2019-06-12T10:00:57Z got inv: tx 13f15e0e6e0e0f19b3aa84a7c6d9715991ea5b8ccf8dad9002bee7c25b596aa7  have peer=4769\r\n2019-06-12T10:00:57Z got inv: tx 13f15e0e6e0e0f19b3aa84a7c6d9715991ea5b8ccf8dad9002bee7c25b596aa7  have peer=4269\r\n2019-06-12T10:00:57Z got inv: tx 13f15e0e6e0e0f19b3aa84a7c6d9715991ea5b8ccf8dad9002bee7c25b596aa7  have peer=4983\r\n2019-06-12T10:00:58Z got inv: tx 13f15e0e6e0e0f19b3aa84a7c6d9715991ea5b8ccf8dad9002bee7c25b596aa7  have peer=4258\r\n2019-06-12T10:00:58Z got inv: tx 13f15e0e6e0e0f19b3aa84a7c6d9715991ea5b8ccf8dad9002bee7c25b596aa7  have peer=4391\r\n2019-06-12T10:00:59Z got inv: tx 13f15e0e6e0e0f19b3aa84a7c6d9715991ea5b8ccf8dad9002bee7c25b596aa7  have peer=4576\r\n2019-06-12T10:00:59Z got inv: tx 13f15e0e6e0e0f19b3aa84a7c6d9715991ea5b8ccf8dad9002bee7c25b596aa7  have peer=1281\r\n2019-06-12T10:01:01Z received getdata for: tx 13f15e0e6e0e0f19b3aa84a7c6d9715991ea5b8ccf8dad9002bee7c25b596aa7 peer=995\r\n2019-06-12T10:01:01Z received getdata for: tx 13f15e0e6e0e0f19b3aa84a7c6d9715991ea5b8ccf8dad9002bee7c25b596aa7 peer=4068\r\n2019-06-12T10:16:04Z UpdateTip: new best=00000000000000000024c923fe8873778e437290e4958234922df101956fa4f4 height=580366 version=0x20800000 log2_work=90.731743 tx=423489088 date='2019-06-12T10:15:54Z' progress=1.000000 cache=78.5MiB(585276txo) warning='36 of last 100 blocks have unexpected version'\r\n2019-06-12T10:35:10Z got inv: tx e6dcc6451e35996ce4d823781196830d1731c01d9d3e0fe1683b6e38675c4bf6  new peer=5226\r\n2019-06-12T10:35:11Z got inv: tx e6dcc6451e35996ce4d823781196830d1731c01d9d3e0fe1683b6e38675c4bf6  new peer=3396\r\n2019-06-12T10:35:11Z got inv: tx e6dcc6451e35996ce4d823781196830d1731c01d9d3e0fe1683b6e38675c4bf6  new peer=3384\r\n2019-06-12T10:35:11Z got inv: tx e6dcc6451e35996ce4d823781196830d1731c01d9d3e0fe1683b6e38675c4bf6  new peer=4576\r\n2019-06-12T10:35:11Z got inv: tx e6dcc6451e35996ce4d823781196830d1731c01d9d3e0fe1683b6e38675c4bf6  new peer=1281\r\n2019-06-12T10:35:12Z got inv: tx e6dcc6451e35996ce4d823781196830d1731c01d9d3e0fe1683b6e38675c4bf6  new peer=19\r\n2019-06-12T10:35:12Z Requesting witness-tx e6dcc6451e35996ce4d823781196830d1731c01d9d3e0fe1683b6e38675c4bf6 peer=19\r\n2019-06-12T10:35:12Z got inv: tx e6dcc6451e35996ce4d823781196830d1731c01d9d3e0fe1683b6e38675c4bf6  new peer=124\r\n2019-06-12T10:35:12Z got inv: tx e6dcc6451e35996ce4d823781196830d1731c01d9d3e0fe1683b6e38675c4bf6  new peer=7\r\n2019-06-12T10:35:12Z got inv: tx e6dcc6451e35996ce4d823781196830d1731c01d9d3e0fe1683b6e38675c4bf6  new peer=15\r\n2019-06-12T10:35:12Z AcceptToMemoryPool: peer=19: accepted e6dcc6451e35996ce4d823781196830d1731c01d9d3e0fe1683b6e38675c4bf6 (poolsz 13361 txn, 29469 kB)\r\n2019-06-12T10:35:12Z got inv: tx e6dcc6451e35996ce4d823781196830d1731c01d9d3e0fe1683b6e38675c4bf6  have peer=3747\r\n2019-06-12T10:35:13Z got inv: tx e6dcc6451e35996ce4d823781196830d1731c01d9d3e0fe1683b6e38675c4bf6  have peer=4391\r\n2019-06-12T10:35:13Z got inv: tx e6dcc6451e35996ce4d823781196830d1731c01d9d3e0fe1683b6e38675c4bf6  have peer=4655\r\n2019-06-12T10:35:13Z got inv: tx e6dcc6451e35996ce4d823781196830d1731c01d9d3e0fe1683b6e38675c4bf6  have peer=3616\r\n2019-06-12T10:35:13Z got inv: tx e6dcc6451e35996ce4d823781196830d1731c01d9d3e0fe1683b6e38675c4bf6  have peer=4269\r\n2019-06-12T10:35:14Z got inv: tx e6dcc6451e35996ce4d823781196830d1731c01d9d3e0fe1683b6e38675c4bf6  have peer=5201\r\n2019-06-12T10:35:14Z got inv: tx e6dcc6451e35996ce4d823781196830d1731c01d9d3e0fe1683b6e38675c4bf6  have peer=2963\r\n2019-06-12T10:35:14Z got inv: tx e6dcc6451e35996ce4d823781196830d1731c01d9d3e0fe1683b6e38675c4bf6  have peer=1206\r\n2019-06-12T10:35:15Z got inv: tx e6dcc6451e35996ce4d823781196830d1731c01d9d3e0fe1683b6e38675c4bf6  have peer=57\r\n2019-06-12T10:35:16Z got inv: tx e6dcc6451e35996ce4d823781196830d1731c01d9d3e0fe1683b6e38675c4bf6  have peer=2596\r\n2019-06-12T10:35:23Z got inv: tx e6dcc6451e35996ce4d823781196830d1731c01d9d3e0fe1683b6e38675c4bf6  have peer=4258\r\n2019-06-12T10:36:12Z Requesting witness-tx e6dcc6451e35996ce4d823781196830d1731c01d9d3e0fe1683b6e38675c4bf6 peer=15\r\n2019-06-12T10:36:12Z stored orphan tx e6dcc6451e35996ce4d823781196830d1731c01d9d3e0fe1683b6e38675c4bf6 (mapsz 39 outsz 80)\r\n2019-06-12T10:36:12Z Requesting witness-tx 13f15e0e6e0e0f19b3aa84a7c6d9715991ea5b8ccf8dad9002bee7c25b596aa7 peer=15\r\n2019-06-12T10:36:12Z Process NOTFOUND for 13f15e0e6e0e0f19b3aa84a7c6d9715991ea5b8ccf8dad9002bee7c25b596aa7 id 15, ua /Satoshi:0.17.0.1/, version 70015, addr 34.222.37.152:8333, tx_relay 1, tx_sendmempool 0, fee_filter 1000, services 000000000000040d, time_connected 56403, last_tx 21, last_block 133, last_mempool 0\r\n```",
      "created_at" : "2019-06-12T11:12:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#issuecomment-501227739",
      "id" : 501227739,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15834",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwMTIyNzczOQ==",
      "updated_at" : "2019-06-12T11:42:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/501227739",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 308b76732f97020c86977e29c854e8e27262cf7c (Tested two of the three bugs this pull fixes, see comment above)\r\n\r\n<details><summary>Show signature and timestamp</summary>\r\n\r\nSignature:\r\n\r\n```\r\n-----BEGIN PGP SIGNED MESSAGE-----\r\nHash: SHA512\r\n\r\nACK 308b76732f97020c86977e29c854e8e27262cf7c (Tested two of the three bugs this pull fixes, see comment above)\r\n-----BEGIN PGP SIGNATURE-----\r\n\r\niQGzBAEBCgAdFiEE+rVPoUahrI9sLGYTzit1aX5ppUgFAlwqrYAACgkQzit1aX5p\r\npUgNywv9G066MMLt0dJFLrlz/RnlG/XSMMKGfvre21cWg7EvE4NURpf+DYVbcwm8\r\nbNzSEvl3kLoZLCdW5SJjZkC/v/Shly9nKVpvDtS1APDZe1JbPjKrfEuCREPg/14S\r\nIMRP1AkcJYpcs9CEsRLa3R4f+I+mYlhV9m0pAvaAXhl1HU2TwLL6RbJEpAKhMu5j\r\n3TsU+1abFXEp8dRDOeHlIax6gqYiNBzILICrkMsgBEgyyufQ6EUlyJ4bjAzuuc2b\r\nQHiig338kfnBjYJH/wKjn7KYERB908n370sXJd9j5clpGBQRvTVKLCU8xl81dPeV\r\ngYvYieewzvap+Pcu5rxK9p0v+5xi+4qrzSpQTksfjYKgtYr7+lfoq3LLlMPB4A1k\r\noFbnXqGsKbYTybfO4THzX9uEekfASOGyKin2XLA2txSXfBfMUlzPo3S0EodjuIjj\r\nzcZ18ST42SXfGagistp9lvVmtOirpz2pNhp8oARLUZAfRf+HaqE6pApcWuo3BO6g\r\n6vz0Bzs+\r\n=ddt0\r\n-----END PGP SIGNATURE-----\r\n```\r\n\r\n[Timestamp of file with hash `3ce687f87901b51b245d165509f0c12661c46cd7d1e956e5b93c607795664650  -`](https://opentimestamps.org/info/?004f70656e54696d657374616d7073000050726f6f6600bf89e2e884e8929401083ce687f87901b51b245d165509f0c12661c46cd7d1e956e5b93c607795664650f0108cff60d9e43556daafee7f719b763ea608fff0100f6318ac1b2754a702a1f75849dabea108f1045d00e591f008ca274d812d2aff170083dfe30d2ef90c8e2c2b68747470733a2f2f626f622e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267fff0108777e33abbe9d415fad2c43b449c853e08f010800436d7eb175b2804fd108c19c0462f08f1045d00e592f00822d1a29f73da83680083dfe30d2ef90c8e292868747470733a2f2f66696e6e65792e63616c656e6461722e657465726e69747977616c6c2e636f6df010a9f8421a0b90774c8d02555b5588f13908f1201a8a1fca83310bf2bb1627c15be82255a5c6e9673af4306731cbe17464245b9108f1045d00e591f0083ba1a42f303c9a280083dfe30d2ef90c8e2e2d68747470733a2f2f616c6963652e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267)\r\n\r\n</details>\r\n",
      "created_at" : "2019-06-12T11:44:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15834#issuecomment-501237294",
      "id" : 501237294,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15834",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDUwMTIzNzI5NA==",
      "updated_at" : "2019-06-12T11:44:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/501237294",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
