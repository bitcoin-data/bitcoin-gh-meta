{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "`mmap(...)` returns `MAP_FAILED` (`(void *) -1`) in case of allocation failure.\r\n\r\n`PosixLockedPageAllocator::AllocateLocked(...)` did not check for allocation failures prior to this PR.\r\n\r\nInstead the invalid memory address `(void *) -1` (`0xffffffffffffffff`) was passed to the caller as if it was a valid address.\r\n\r\nAfter some operations the address is wrapped around from `0xffffffffffffffff` to `0x00000003ffdf` (`0xffffffffffffffff + 262112 == 0x00000003ffdf`);\r\n\r\nThe resulting address `0x00000003ffdf` is then written to.\r\n\r\nBefore this patch (with failing `mmap` call):\r\n\r\n```\r\n$ src/bitcoind\r\nâ¦\r\n2019-01-06T16:28:14Z Using the 'sse4(1way),sse41(4way)' SHA256 implementation\r\n2019-01-06T16:28:14Z Using RdRand as an additional entropy source\r\nSegmentation fault (core dumped)\r\n```\r\n\r\nBefore this patch (under `valgrind` with failing `mmap` call):\r\n\r\n```\r\n$ valgrind src/bitcoind\r\nâ¦\r\n2019-01-06T16:28:51Z Using the 'sse4(1way),sse41(4way)' SHA256 implementation\r\n==17812== Invalid write of size 1\r\n==17812==    at 0x500B7E: void __gnu_cxx::new_allocator<unsigned char>::construct<unsigned char>(unsigned char*) (new_allocator.h:136)\r\n==17812==    by 0x500B52: _ZNSt16allocator_traitsI16secure_allocatorIhEE12_S_constructIhJEEENSt9enable_ifIXsr6__and_INS2_18__construct_helperIT_JDpT0_EE4typeEEE5valueEvE4typeERS1_PS6_DpOS7_ (alloc_traits.h:243)\r\n==17812==    by 0x500B22: _ZNSt16allocator_traitsI16secure_allocatorIhEE9constructIhJEEEDTcl12_S_constructfp_fp0_spclsr3stdE7forwardIT0_Efp1_EEERS1_PT_DpOS4_ (alloc_traits.h:344)\r\n==17812==    by 0x500982: unsigned char* std::__uninitialized_default_n_a<unsigned char*, unsigned long, secure_allocator<unsigned char> >(unsigned char*, unsigned long, secure_allocator<unsigned char>&) (stl_uninitialized.h:631)\r\n==17812==    by 0x60BFC2: std::vector<unsigned char, secure_allocator<unsigned char> >::_M_default_initialize(unsigned long) (stl_vector.h:1347)\r\n==17812==    by 0x60BD86: std::vector<unsigned char, secure_allocator<unsigned char> >::vector(unsigned long, secure_allocator<unsigned char> const&) (stl_vector.h:285)\r\n==17812==    by 0x60BB55: ECC_Start() (key.cpp:351)\r\n==17812==    by 0x16AC90: AppInitSanityChecks() (init.cpp:1162)\r\n==17812==    by 0x15BAC9: AppInit(int, char**) (bitcoind.cpp:138)\r\n==17812==    by 0x15B6C8: main (bitcoind.cpp:201)\r\n==17812==  Address 0x3ffdf is not stack'd, malloc'd or (recently) free'd\r\nâ¦\r\nSegmentation fault (core dumped)\r\n```\r\n\r\nAfter this patch (with failing `mmap` call):\r\n\r\n```\r\n$ src/bitcoind\r\nâ¦\r\n2019-01-06T15:50:18Z Using the 'sse4(1way),sse41(4way)' SHA256 implementation\r\n2019-01-06T15:50:18Z Using RdRand as an additional entropy source\r\n2019-01-06T15:50:18Z\r\n\r\n************************\r\nEXCEPTION: St9bad_alloc\r\nstd::bad_alloc\r\nbitcoin in AppInit()\r\n\r\n\r\n\r\n************************\r\nEXCEPTION: St9bad_alloc\r\nstd::bad_alloc\r\nbitcoin in AppInit()\r\n\r\n2019-01-06T15:50:18Z Shutdown: In progress...\r\n2019-01-06T15:50:18Z Shutdown: done\r\n```\r\n\r\nTo simulate the failing `mmap` call apply the following to `master`:\r\n\r\n```diff\r\ndiff --git a/src/support/lockedpool.cpp b/src/support/lockedpool.cpp\r\nindex 8d577cf52..ce79e569b 100644\r\n--- a/src/support/lockedpool.cpp\r\n+++ b/src/support/lockedpool.cpp\r\n@@ -247,7 +247,8 @@ void *PosixLockedPageAllocator::AllocateLocked(size_t len, bool *lockingSuccess)\r\n {\r\n     void *addr;\r\n     len = align_up(len, page_size);\r\n-    addr = mmap(nullptr, len, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0);\r\n+    // addr = mmap(nullptr, len, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0);\r\n+    addr = MAP_FAILED;\r\n     if (addr) {\r\n         *lockingSuccess = mlock(addr, len) == 0;\r\n     }\r\n```\r\n\r\n",
   "closed_at" : "2019-01-09T14:59:31Z",
   "closed_by" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   },
   "comments" : 4,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15117/comments",
   "created_at" : "2019-01-06T16:51:09Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15117/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/15117",
   "id" : 396274382,
   "labels" : [],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15117/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDExOlB1bGxSZXF1ZXN0MjQyNTA0NjUw",
   "number" : 15117,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/15117.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/15117",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/15117.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/15117"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "Fix invalid memory write in case of failing mmap(...) in PosixLockedPageAllocator::AllocateLocked",
   "updated_at" : "2019-01-09T14:59:31Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15117",
   "user" : {
      "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
      "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
      "followers_url" : "https://api.github.com/users/practicalswift/followers",
      "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
      "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/practicalswift",
      "id" : 7826565,
      "login" : "practicalswift",
      "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
      "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
      "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
      "repos_url" : "https://api.github.com/users/practicalswift/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/practicalswift"
   }
}
