[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r135608494"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/135608494"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`self.nodes[2].p2p.block_receive_map`, right?",
      "commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "created_at" : "2017-08-28T19:14:56Z",
      "diff_hunk" : "@@ -195,28 +190,26 @@ def run_test(self):\n         connect_nodes(self.nodes[1], 2)\n \n         self.log.info(\"Add P2P connection to node2\")\n-        node2 = BaseNode()\n-        connections.append(NodeConn('127.0.0.1', p2p_port(2), self.nodes[2], node2))\n-        node2.add_connection(connections[1])\n-        node2.wait_for_verack()\n+        self.nodes[2].add_p2p_connection(p2p_conn_type=BaseNode)\n+        self.nodes[2].p2p.wait_for_verack()\n \n         self.log.info(\"Wait for node2 reach current tip. Test that it has propagated all the blocks to us\")\n \n         getdata_request = msg_getdata()\n         for block in blocks:\n             getdata_request.inv.append(CInv(2, block))\n-        node2.send_message(getdata_request)\n+        self.nodes[2].send_message(getdata_request)\n \n         # wait_until() will loop until a predicate condition is met. Use it to test properties of the\n         # NodeConnCB objects.\n-        wait_until(lambda: sorted(blocks) == sorted(list(node2.block_receive_map.keys())), timeout=5, lock=mininode_lock)\n+        wait_until(lambda: sorted(blocks) == sorted(list(self.nodes[2].block_receive_map.keys())), timeout=5, lock=mininode_lock)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r135608494",
      "id" : 135608494,
      "original_commit_id" : "ba30027a70c328e45bfa7ce4afc100c847da5d2c",
      "original_position" : 66,
      "path" : "test/functional/example_test.py",
      "position" : null,
      "pull_request_review_id" : 59039098,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182",
      "updated_at" : "2017-10-23T16:46:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/135608494",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r135609557"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/135609557"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Where is `add_p2p_connections` defined? Is it virtual?",
      "commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "created_at" : "2017-08-28T19:19:41Z",
      "diff_hunk" : "@@ -141,6 +160,33 @@ def node_encrypt_wallet(self, passphrase):\n         self.rpc = None\n         self.rpc_connected = False\n \n+    def add_p2p_connection(self, p2p_conn_type, dstaddr='127.0.0.1', dstport=None, services=NODE_NETWORK, send_version=True):\n+        \"\"\"Add a p2p connection to the node.\"\"\"\n+        if dstport is None:\n+            dstport = p2p_port(self.index)\n+        p2p_conn = p2p_conn_type()\n+        self.p2ps.append(p2p_conn)\n+        p2p_conn.add_connection(NodeConn(dstaddr, dstport, self.rpc, p2p_conn, services=services, send_version=send_version))\n+        if self.p2p is None:\n+            self.p2p = self.p2ps[0]\n+        self.p2p_connected = True\n+        self.p2p_ever_connected = True\n+\n+    def send_message(self, message):\n+        \"\"\"Send a p2p message to the node.\"\"\"\n+        if not self.p2p_ever_connected:\n+            self.add_p2p_connections()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r135609557",
      "id" : 135609557,
      "original_commit_id" : "ba30027a70c328e45bfa7ce4afc100c847da5d2c",
      "original_position" : 81,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : null,
      "pull_request_review_id" : 59039098,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182",
      "updated_at" : "2017-10-23T16:46:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/135609557",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r135610294"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/135610294"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It seems very common to refer to `self.nodes[i].p2p`. Maybe this method should return the new connection so the client code can assign to a local variable.",
      "commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "created_at" : "2017-08-28T19:23:04Z",
      "diff_hunk" : "@@ -141,6 +160,33 @@ def node_encrypt_wallet(self, passphrase):\n         self.rpc = None\n         self.rpc_connected = False\n \n+    def add_p2p_connection(self, p2p_conn_type, dstaddr='127.0.0.1', dstport=None, services=NODE_NETWORK, send_version=True):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r135610294",
      "id" : 135610294,
      "original_commit_id" : "c3730eff46b498df59cd0b80632dceb9de35fcd3",
      "original_position" : 66,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : null,
      "pull_request_review_id" : 59039098,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182",
      "updated_at" : "2017-10-23T16:46:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/135610294",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/881253?v=4",
         "events_url" : "https://api.github.com/users/jimpo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jimpo/followers",
         "following_url" : "https://api.github.com/users/jimpo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jimpo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jimpo",
         "id" : 881253,
         "login" : "jimpo",
         "organizations_url" : "https://api.github.com/users/jimpo/orgs",
         "received_events_url" : "https://api.github.com/users/jimpo/received_events",
         "repos_url" : "https://api.github.com/users/jimpo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jimpo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jimpo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jimpo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r135647278"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/135647278"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yes. Thank you!",
      "commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "created_at" : "2017-08-28T22:03:20Z",
      "diff_hunk" : "@@ -195,28 +190,26 @@ def run_test(self):\n         connect_nodes(self.nodes[1], 2)\n \n         self.log.info(\"Add P2P connection to node2\")\n-        node2 = BaseNode()\n-        connections.append(NodeConn('127.0.0.1', p2p_port(2), self.nodes[2], node2))\n-        node2.add_connection(connections[1])\n-        node2.wait_for_verack()\n+        self.nodes[2].add_p2p_connection(p2p_conn_type=BaseNode)\n+        self.nodes[2].p2p.wait_for_verack()\n \n         self.log.info(\"Wait for node2 reach current tip. Test that it has propagated all the blocks to us\")\n \n         getdata_request = msg_getdata()\n         for block in blocks:\n             getdata_request.inv.append(CInv(2, block))\n-        node2.send_message(getdata_request)\n+        self.nodes[2].send_message(getdata_request)\n \n         # wait_until() will loop until a predicate condition is met. Use it to test properties of the\n         # NodeConnCB objects.\n-        wait_until(lambda: sorted(blocks) == sorted(list(node2.block_receive_map.keys())), timeout=5, lock=mininode_lock)\n+        wait_until(lambda: sorted(blocks) == sorted(list(self.nodes[2].block_receive_map.keys())), timeout=5, lock=mininode_lock)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r135647278",
      "id" : 135647278,
      "in_reply_to_id" : 135608494,
      "original_commit_id" : "ba30027a70c328e45bfa7ce4afc100c847da5d2c",
      "original_position" : 66,
      "path" : "test/functional/example_test.py",
      "position" : null,
      "pull_request_review_id" : 59082154,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182",
      "updated_at" : "2017-10-23T16:46:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/135647278",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r135647329"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/135647329"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good idea. I'll add that",
      "commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "created_at" : "2017-08-28T22:03:36Z",
      "diff_hunk" : "@@ -141,6 +160,33 @@ def node_encrypt_wallet(self, passphrase):\n         self.rpc = None\n         self.rpc_connected = False\n \n+    def add_p2p_connection(self, p2p_conn_type, dstaddr='127.0.0.1', dstport=None, services=NODE_NETWORK, send_version=True):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r135647329",
      "id" : 135647329,
      "in_reply_to_id" : 135610294,
      "original_commit_id" : "c3730eff46b498df59cd0b80632dceb9de35fcd3",
      "original_position" : 66,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : null,
      "pull_request_review_id" : 59082206,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182",
      "updated_at" : "2017-10-23T16:46:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/135647329",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r135647541"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/135647541"
         }
      },
      "author_association" : "MEMBER",
      "body" : "oops. This is vestigial. I previously had an `add_p2p_connections()`, but it turned out to not be very useful. I'll fix this up. Thanks for pointing this out.",
      "commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "created_at" : "2017-08-28T22:04:45Z",
      "diff_hunk" : "@@ -141,6 +160,33 @@ def node_encrypt_wallet(self, passphrase):\n         self.rpc = None\n         self.rpc_connected = False\n \n+    def add_p2p_connection(self, p2p_conn_type, dstaddr='127.0.0.1', dstport=None, services=NODE_NETWORK, send_version=True):\n+        \"\"\"Add a p2p connection to the node.\"\"\"\n+        if dstport is None:\n+            dstport = p2p_port(self.index)\n+        p2p_conn = p2p_conn_type()\n+        self.p2ps.append(p2p_conn)\n+        p2p_conn.add_connection(NodeConn(dstaddr, dstport, self.rpc, p2p_conn, services=services, send_version=send_version))\n+        if self.p2p is None:\n+            self.p2p = self.p2ps[0]\n+        self.p2p_connected = True\n+        self.p2p_ever_connected = True\n+\n+    def send_message(self, message):\n+        \"\"\"Send a p2p message to the node.\"\"\"\n+        if not self.p2p_ever_connected:\n+            self.add_p2p_connections()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r135647541",
      "id" : 135647541,
      "in_reply_to_id" : 135609557,
      "original_commit_id" : "ba30027a70c328e45bfa7ce4afc100c847da5d2c",
      "original_position" : 81,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : null,
      "pull_request_review_id" : 59082441,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182",
      "updated_at" : "2017-10-23T16:46:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/135647541",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "body" : "@jimpo - thanks for the review. I'm glad you like the new framework. My aim was to make test-writing easier and quicker for contributors, so I appreciate the feedback.\r\n\r\nI think I've addressed your review comments.",
      "created_at" : "2017-08-29T15:08:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#issuecomment-325694720",
      "id" : 325694720,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11182",
      "updated_at" : "2017-08-29T15:08:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/325694720",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2017-09-01T17:01:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#issuecomment-326633134",
      "id" : 326633134,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11182",
      "updated_at" : "2017-09-01T17:01:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/326633134",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2017-09-14T14:53:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#issuecomment-329507649",
      "id" : 329507649,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11182",
      "updated_at" : "2017-09-14T14:53:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/329507649",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2017-09-20T13:49:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#issuecomment-330857445",
      "id" : 330857445,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11182",
      "updated_at" : "2017-09-20T13:49:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/330857445",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "## p2p vs p2ps\r\n\r\nI am not 100% sure about the `p2p` and `p2ps` magic. What would somebody expect in a case where two p2p connections are made, we disconnect the first peer and call `send_message`?\r\n\r\nWhen we disconnect a peer should the `p2p` variable be updated? Maybe `p2p` should be a method which returns the first connection in the `p2ps` array.\r\n\r\nImo the behavior is not really predictable and a cleaner way would be to always call `p2ps[0]` or whatever index is needed, despite less syntax sugar.\r\n\r\n## import *\r\n\r\nSince you modified the files in this patch, do you think it would be a good idea to replace `import *` with specific imports? (exceptions could be `p2p-segwit` and `p2p-compactblocks` since the imports would be quite big).\r\n\r\n## ACK\r\n\r\nI think this patch is really helpful, way cleaner peer connection initialization.\r\n\r\nIf the above mentioned points are not relevant, ACK https://github.com/bitcoin/bitcoin/pull/11182/commits/5f9294759df348eca9a6361f7e98360fc07cd3f4",
      "created_at" : "2017-09-21T21:12:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#issuecomment-331283336",
      "id" : 331283336,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11182",
      "updated_at" : "2017-09-21T21:12:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/331283336",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/226170?v=4",
         "events_url" : "https://api.github.com/users/mess110/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mess110/followers",
         "following_url" : "https://api.github.com/users/mess110/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mess110/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mess110",
         "id" : 226170,
         "login" : "mess110",
         "organizations_url" : "https://api.github.com/users/mess110/orgs",
         "received_events_url" : "https://api.github.com/users/mess110/received_events",
         "repos_url" : "https://api.github.com/users/mess110/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mess110/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mess110/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mess110"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @mess110 . Responses:\r\n\r\n**p2p vs p2ps**: You're right that this is syntactic sugar, but I think being able to use `node.p2p` in place of `node.p2ps[0]` is useful. Most tests that use the p2p interface will only have a single p2p connection to the node, so writing `node.p2ps[0]` many times is redundant and distracts from the intent of the test. However, your feedback has convinced me to remove some of the syntactic sugar and simplify the implementation:\r\n\r\n- I've removed the `ever_connected` latch and automatic connecting on first `send_message`. Test cases should explicitly create a p2p connection if they wish to use it.\r\n- I've turned `self.p2p` into a property which returns the `p2ps[0]`\r\n- I've removed the redundant `connected` variable, which should always be equivalent to `p2ps is []`\r\n\r\n**wildcard imports**: yes, I'd love to clean this up, but I meet resistance whenever I try to do that! I've left it out of this PR so this only focuses on adding the p2p interface.",
      "created_at" : "2017-09-22T14:45:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#issuecomment-331467540",
      "id" : 331467540,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11182",
      "updated_at" : "2017-09-22T14:45:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/331467540",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK https://github.com/bitcoin/bitcoin/pull/11182/commits/0cb3474b664fc04a23640614e2e8b0deae6c2d50",
      "created_at" : "2017-09-24T19:07:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#issuecomment-331732032",
      "id" : 331732032,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11182",
      "updated_at" : "2017-09-24T19:07:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/331732032",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/226170?v=4",
         "events_url" : "https://api.github.com/users/mess110/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mess110/followers",
         "following_url" : "https://api.github.com/users/mess110/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mess110/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mess110",
         "id" : 226170,
         "login" : "mess110",
         "organizations_url" : "https://api.github.com/users/mess110/orgs",
         "received_events_url" : "https://api.github.com/users/mess110/received_events",
         "repos_url" : "https://api.github.com/users/mess110/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mess110/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mess110/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mess110"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "utACK 0cb3474b664fc04a23640614e2e8b0deae6c2d50",
      "created_at" : "2017-10-18T17:36:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#issuecomment-337668657",
      "id" : 337668657,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11182",
      "updated_at" : "2017-10-18T17:36:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/337668657",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r145731251"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145731251"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Probably should drop != to be pythonic and consistent with previous assert.",
      "commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "created_at" : "2017-10-19T15:13:14Z",
      "diff_hunk" : "@@ -151,6 +164,39 @@ def node_encrypt_wallet(self, passphrase):\n         self.encryptwallet(passphrase)\n         self.wait_until_stopped()\n \n+    def add_p2p_connection(self, p2p_conn_type, dstaddr='127.0.0.1', dstport=None, services=NODE_NETWORK, send_version=True):\n+        \"\"\"Add a p2p connection to the node.\n+\n+        This method adds the p2p connection to the self.p2ps list and also\n+        returns the connection to the caller.\"\"\"\n+        if dstport is None:\n+            dstport = p2p_port(self.index)\n+        p2p_conn = p2p_conn_type()\n+        self.p2ps.append(p2p_conn)\n+        p2p_conn.add_connection(NodeConn(dstaddr, dstport, self.rpc, p2p_conn, services=services, send_version=send_version))\n+\n+        return p2p_conn\n+\n+    @property\n+    def p2p(self):\n+        \"\"\"Return the first p2p connection\n+\n+        Convenience property - most tests only use a single p2p connection to each\n+        node, so this saves having to write node.p2ps[0] many times.\"\"\"\n+        assert self.p2ps, \"No p2p connection\"\n+        return self.p2ps[0]\n+\n+    def send_message(self, message):\n+        \"\"\"Send a p2p message to the node.\"\"\"\n+        assert self.p2ps != [], \"No p2p connection\"",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r145731251",
      "id" : 145731251,
      "original_commit_id" : "2d5ca2e6459236915fa7bf5b85cf50629266129c",
      "original_position" : 88,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : null,
      "pull_request_review_id" : 70574386,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182",
      "updated_at" : "2017-10-23T16:46:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145731251",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r145733426"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145733426"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This change seems to be unrelated, so maybe revert or move to another commit.\r\n\r\nAlso, it would be better `return getattr(self.rpc, name)` here to avoid making assumptions about python rpc class (like that it even has a \\_\\_getattr__ method), and so any exceptions thrown will be properly reported.",
      "commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "created_at" : "2017-10-19T15:20:05Z",
      "diff_hunk" : "@@ -63,10 +73,12 @@ def __init__(self, i, dirname, extra_args, rpchost, timewait, binary, stderr, mo\n         self.url = None\n         self.log = logging.getLogger('TestFramework.node%d' % i)\n \n-    def __getattr__(self, *args, **kwargs):\n+        self.p2ps = []\n+\n+    def __getattr__(self, name):\n         \"\"\"Dispatches any unrecognised messages to the RPC connection.\"\"\"\n         assert self.rpc_connected and self.rpc is not None, \"Error: no RPC connection\"\n-        return self.rpc.__getattr__(*args, **kwargs)\n+        return self.rpc.__getattr__(name)\n ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r145733426",
      "id" : 145733426,
      "original_commit_id" : "2d5ca2e6459236915fa7bf5b85cf50629266129c",
      "original_position" : 49,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : null,
      "pull_request_review_id" : 70574386,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182",
      "updated_at" : "2017-10-23T16:46:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145733426",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r145734889"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145734889"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Probably better to do `del self.p2ps[:]` to make sure connections are freed if there are other references to the list. Also would make it clearer that p2ps is an existing member.",
      "commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "created_at" : "2017-10-19T15:24:52Z",
      "diff_hunk" : "@@ -119,6 +131,7 @@ def stop_node(self):\n             self.stop()\n         except http.client.CannotSendRequest:\n             self.log.exception(\"Unable to stop node.\")\n+        self.p2ps = []",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r145734889",
      "id" : 145734889,
      "original_commit_id" : "2d5ca2e6459236915fa7bf5b85cf50629266129c",
      "original_position" : 56,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : null,
      "pull_request_review_id" : 70574386,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182",
      "updated_at" : "2017-10-23T16:46:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145734889",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r145736593"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145736593"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Seem to be missing net argument. Maybe just take **kwargs here to simplify this function, avoid the need to update it if NodeConn gets new options, and avoid repeating default values for services and send_version options that might get out of sync.",
      "commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "created_at" : "2017-10-19T15:30:39Z",
      "diff_hunk" : "@@ -151,6 +164,39 @@ def node_encrypt_wallet(self, passphrase):\n         self.encryptwallet(passphrase)\n         self.wait_until_stopped()\n \n+    def add_p2p_connection(self, p2p_conn_type, dstaddr='127.0.0.1', dstport=None, services=NODE_NETWORK, send_version=True):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r145736593",
      "id" : 145736593,
      "original_commit_id" : "2d5ca2e6459236915fa7bf5b85cf50629266129c",
      "original_position" : 64,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : null,
      "pull_request_review_id" : 70574386,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182",
      "updated_at" : "2017-10-23T16:46:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145736593",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r145737496"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145737496"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe add comment saying why it isn't an error for connection to be none. Saying e.g. when this condition is expected.",
      "commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "created_at" : "2017-10-19T15:33:00Z",
      "diff_hunk" : "@@ -151,6 +164,39 @@ def node_encrypt_wallet(self, passphrase):\n         self.encryptwallet(passphrase)\n         self.wait_until_stopped()\n \n+    def add_p2p_connection(self, p2p_conn_type, dstaddr='127.0.0.1', dstport=None, services=NODE_NETWORK, send_version=True):\n+        \"\"\"Add a p2p connection to the node.\n+\n+        This method adds the p2p connection to the self.p2ps list and also\n+        returns the connection to the caller.\"\"\"\n+        if dstport is None:\n+            dstport = p2p_port(self.index)\n+        p2p_conn = p2p_conn_type()\n+        self.p2ps.append(p2p_conn)\n+        p2p_conn.add_connection(NodeConn(dstaddr, dstport, self.rpc, p2p_conn, services=services, send_version=send_version))\n+\n+        return p2p_conn\n+\n+    @property\n+    def p2p(self):\n+        \"\"\"Return the first p2p connection\n+\n+        Convenience property - most tests only use a single p2p connection to each\n+        node, so this saves having to write node.p2ps[0] many times.\"\"\"\n+        assert self.p2ps, \"No p2p connection\"\n+        return self.p2ps[0]\n+\n+    def send_message(self, message):\n+        \"\"\"Send a p2p message to the node.\"\"\"\n+        assert self.p2ps != [], \"No p2p connection\"\n+        self.p2ps[0].send_message(message)\n+\n+    def disconnect_p2p(self, index=0):\n+        \"\"\"Close the p2p connection to the node.\"\"\"\n+        if self.p2ps[index].connection is not None:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r145737496",
      "id" : 145737496,
      "original_commit_id" : "2d5ca2e6459236915fa7bf5b85cf50629266129c",
      "original_position" : 93,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : null,
      "pull_request_review_id" : 70574386,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182",
      "updated_at" : "2017-10-23T16:46:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145737496",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r145737845"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145737845"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Probably should write `del self.p2ps[index]` since not using the return value.",
      "commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "created_at" : "2017-10-19T15:34:06Z",
      "diff_hunk" : "@@ -151,6 +164,39 @@ def node_encrypt_wallet(self, passphrase):\n         self.encryptwallet(passphrase)\n         self.wait_until_stopped()\n \n+    def add_p2p_connection(self, p2p_conn_type, dstaddr='127.0.0.1', dstport=None, services=NODE_NETWORK, send_version=True):\n+        \"\"\"Add a p2p connection to the node.\n+\n+        This method adds the p2p connection to the self.p2ps list and also\n+        returns the connection to the caller.\"\"\"\n+        if dstport is None:\n+            dstport = p2p_port(self.index)\n+        p2p_conn = p2p_conn_type()\n+        self.p2ps.append(p2p_conn)\n+        p2p_conn.add_connection(NodeConn(dstaddr, dstport, self.rpc, p2p_conn, services=services, send_version=send_version))\n+\n+        return p2p_conn\n+\n+    @property\n+    def p2p(self):\n+        \"\"\"Return the first p2p connection\n+\n+        Convenience property - most tests only use a single p2p connection to each\n+        node, so this saves having to write node.p2ps[0] many times.\"\"\"\n+        assert self.p2ps, \"No p2p connection\"\n+        return self.p2ps[0]\n+\n+    def send_message(self, message):\n+        \"\"\"Send a p2p message to the node.\"\"\"\n+        assert self.p2ps != [], \"No p2p connection\"\n+        self.p2ps[0].send_message(message)\n+\n+    def disconnect_p2p(self, index=0):\n+        \"\"\"Close the p2p connection to the node.\"\"\"\n+        if self.p2ps[index].connection is not None:\n+            self.p2ps[index].connection.disconnect_node()\n+        self.p2ps.pop(index)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r145737845",
      "id" : 145737845,
      "original_commit_id" : "2d5ca2e6459236915fa7bf5b85cf50629266129c",
      "original_position" : 95,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : null,
      "pull_request_review_id" : 70574386,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182",
      "updated_at" : "2017-10-23T16:46:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145737845",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r145738456"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145738456"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Don't see NodeConnCB being used here. NODE_NETWORK import could also go away if using **kwargs as suggested below.",
      "commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "created_at" : "2017-10-19T15:36:06Z",
      "diff_hunk" : "@@ -13,13 +13,19 @@\n import subprocess\n import time\n \n+from .authproxy import JSONRPCException\n+from .mininode import (\n+    NodeConn,\n+    NodeConnCB,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r145738456",
      "id" : 145738456,
      "original_commit_id" : "2d5ca2e6459236915fa7bf5b85cf50629266129c",
      "original_position" : 7,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : null,
      "pull_request_review_id" : 70574386,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182",
      "updated_at" : "2017-10-23T16:46:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145738456",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r145738978"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145738978"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Maybe call it `send_p2p_message` to be clearer and consistent with `add_p2p_connection`. This class has a lot of functionality already so it would be nice if all the new p2p attributes mentioned p2p.\r\n\r\nAnother alternative would be to drop this since `node.send_p2p_message()` hardly seems better than `node.p2p.send_message()`",
      "commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "created_at" : "2017-10-19T15:37:49Z",
      "diff_hunk" : "@@ -151,6 +164,39 @@ def node_encrypt_wallet(self, passphrase):\n         self.encryptwallet(passphrase)\n         self.wait_until_stopped()\n \n+    def add_p2p_connection(self, p2p_conn_type, dstaddr='127.0.0.1', dstport=None, services=NODE_NETWORK, send_version=True):\n+        \"\"\"Add a p2p connection to the node.\n+\n+        This method adds the p2p connection to the self.p2ps list and also\n+        returns the connection to the caller.\"\"\"\n+        if dstport is None:\n+            dstport = p2p_port(self.index)\n+        p2p_conn = p2p_conn_type()\n+        self.p2ps.append(p2p_conn)\n+        p2p_conn.add_connection(NodeConn(dstaddr, dstport, self.rpc, p2p_conn, services=services, send_version=send_version))\n+\n+        return p2p_conn\n+\n+    @property\n+    def p2p(self):\n+        \"\"\"Return the first p2p connection\n+\n+        Convenience property - most tests only use a single p2p connection to each\n+        node, so this saves having to write node.p2ps[0] many times.\"\"\"\n+        assert self.p2ps, \"No p2p connection\"\n+        return self.p2ps[0]\n+\n+    def send_message(self, message):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r145738978",
      "id" : 145738978,
      "original_commit_id" : "2d5ca2e6459236915fa7bf5b85cf50629266129c",
      "original_position" : 86,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : null,
      "pull_request_review_id" : 70574386,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182",
      "updated_at" : "2017-10-23T16:46:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145738978",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r145741411"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145741411"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Weird spacing",
      "commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "created_at" : "2017-10-19T15:45:22Z",
      "diff_hunk" : "@@ -165,37 +161,33 @@ def run_test(self):\n \n         # Start node1 and node2 with assumevalid so they accept a block with a bad signature.\n         self.start_node(1, extra_args=[\"-assumevalid=\" + hex(block102.sha256)])\n-        node1 = BaseNode()  # connects to node1\n-        connections.append(NodeConn('127.0.0.1', p2p_port(1), self.nodes[1], node1))\n-        node1.add_connection(connections[1])\n-        node1.wait_for_verack()\n+        p2p1 = self.nodes[1].add_p2p_connection(p2p_conn_type=BaseNode)\n+        p2p1.wait_for_verack()\n \n         self.start_node(2, extra_args=[\"-assumevalid=\" + hex(block102.sha256)])\n-        node2 = BaseNode()  # connects to node2\n-        connections.append(NodeConn('127.0.0.1', p2p_port(2), self.nodes[2], node2))\n-        node2.add_connection(connections[2])\n-        node2.wait_for_verack()\n+        p2p2 =self.nodes[2].add_p2p_connection(p2p_conn_type=BaseNode)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r145741411",
      "id" : 145741411,
      "original_commit_id" : "0cb3474b664fc04a23640614e2e8b0deae6c2d50",
      "original_position" : 64,
      "path" : "test/functional/assumevalid.py",
      "position" : null,
      "pull_request_review_id" : 70574386,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182",
      "updated_at" : "2017-10-23T16:46:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/145741411",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review @ryanofsky . I think I've addressed all your comments.\r\n\r\nPrevious branch: https://github.com/jnewbery/bitcoin/tree/pr11182.2\r\nRebased on master: https://github.com/jnewbery/bitcoin/tree/pr11182.3\r\nComments addressed: https://github.com/jnewbery/bitcoin/tree/pr11182.4\r\n\r\n> Growth of TestNode class seems less good, because now it's bigger, more coupled to other parts of framework and importing functionality that many tests won't use\r\n\r\nCan you expand a bit on what you think the concrete problems are? My hope for `TestNode` is that it can be a unified interface to a node under test with all batteries included. If an individual test doesn't need to use the p2p interface, that's fine - just don't add one. I'd rather that `TestNode` be more coupled to the mininode implementation than have all the individual test scripts coupled to that implementation, since it makes refactoring mininode and changing the implementation more straightforward (see #11518 for example).",
      "created_at" : "2017-10-20T14:00:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#issuecomment-338215228",
      "id" : 338215228,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11182",
      "updated_at" : "2017-10-20T14:00:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/338215228",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased",
      "created_at" : "2017-10-23T13:32:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#issuecomment-338659758",
      "id" : 338659758,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11182",
      "updated_at" : "2017-10-23T13:32:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/338659758",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r147747540"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/147747540"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "self.p2p.send_message and remove assert above?",
      "commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "created_at" : "2017-10-30T15:54:28Z",
      "diff_hunk" : "@@ -151,6 +160,45 @@ def node_encrypt_wallet(self, passphrase):\n         self.encryptwallet(passphrase)\n         self.wait_until_stopped()\n \n+    # def add_p2p_connection(self, p2p_conn_type, dstaddr='127.0.0.1', dstport=None, services=NODE_NETWORK, send_version=True):\n+    def add_p2p_connection(self, p2p_conn_type, **kwargs):\n+        \"\"\"Add a p2p connection to the node.\n+\n+        This method adds the p2p connection to the self.p2ps list and also\n+        returns the connection to the caller.\"\"\"\n+        if 'dstport' not in kwargs:\n+            kwargs['dstport'] = p2p_port(self.index)\n+        if 'dstaddr' not in kwargs:\n+            kwargs['dstaddr'] = '127.0.0.1'\n+        p2p_conn = p2p_conn_type()\n+        self.p2ps.append(p2p_conn)\n+        kwargs.update({'rpc': self.rpc, 'callback': p2p_conn})\n+        p2p_conn.add_connection(NodeConn(**kwargs))\n+\n+        return p2p_conn\n+\n+    @property\n+    def p2p(self):\n+        \"\"\"Return the first p2p connection\n+\n+        Convenience property - most tests only use a single p2p connection to each\n+        node, so this saves having to write node.p2ps[0] many times.\"\"\"\n+        assert self.p2ps, \"No p2p connection\"\n+        return self.p2ps[0]\n+\n+    def send_p2p_message(self, message):\n+        \"\"\"Send a p2p message to the node.\"\"\"\n+        assert self.p2ps, \"No p2p connection\"\n+        self.p2ps[0].send_message(message)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r147747540",
      "id" : 147747540,
      "original_commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "original_position" : 89,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : 89,
      "pull_request_review_id" : 72886758,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182",
      "updated_at" : "2017-10-30T15:57:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/147747540",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r147748935"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/147748935"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "And why not remove this function? It doesn't save a lot.",
      "commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "created_at" : "2017-10-30T15:58:55Z",
      "diff_hunk" : "@@ -151,6 +160,45 @@ def node_encrypt_wallet(self, passphrase):\n         self.encryptwallet(passphrase)\n         self.wait_until_stopped()\n \n+    # def add_p2p_connection(self, p2p_conn_type, dstaddr='127.0.0.1', dstport=None, services=NODE_NETWORK, send_version=True):\n+    def add_p2p_connection(self, p2p_conn_type, **kwargs):\n+        \"\"\"Add a p2p connection to the node.\n+\n+        This method adds the p2p connection to the self.p2ps list and also\n+        returns the connection to the caller.\"\"\"\n+        if 'dstport' not in kwargs:\n+            kwargs['dstport'] = p2p_port(self.index)\n+        if 'dstaddr' not in kwargs:\n+            kwargs['dstaddr'] = '127.0.0.1'\n+        p2p_conn = p2p_conn_type()\n+        self.p2ps.append(p2p_conn)\n+        kwargs.update({'rpc': self.rpc, 'callback': p2p_conn})\n+        p2p_conn.add_connection(NodeConn(**kwargs))\n+\n+        return p2p_conn\n+\n+    @property\n+    def p2p(self):\n+        \"\"\"Return the first p2p connection\n+\n+        Convenience property - most tests only use a single p2p connection to each\n+        node, so this saves having to write node.p2ps[0] many times.\"\"\"\n+        assert self.p2ps, \"No p2p connection\"\n+        return self.p2ps[0]\n+\n+    def send_p2p_message(self, message):\n+        \"\"\"Send a p2p message to the node.\"\"\"\n+        assert self.p2ps, \"No p2p connection\"\n+        self.p2ps[0].send_message(message)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r147748935",
      "id" : 147748935,
      "in_reply_to_id" : 147747540,
      "original_commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "original_position" : 89,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : 89,
      "pull_request_review_id" : 72888436,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182",
      "updated_at" : "2017-10-30T15:58:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/147748935",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Sorry for letting this sit in rebase hell. You might want to wait until #11389 is merged and then ping me after rebase.",
      "created_at" : "2017-11-01T14:00:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#issuecomment-341114135",
      "id" : 341114135,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11182",
      "updated_at" : "2017-11-01T14:00:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/341114135",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r148848225"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/148848225"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[tests] Add p2p connection to TestNode\"\r\n\r\nsend_message function is now send_p2p_message and these lines are changing in the next commit. I would move all these example_test.py changes out of here and into the next \"use TestNode p2p connection in tests\" commit because they would fit better there and avoid being a distraction from the more substantive changes here.",
      "commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "created_at" : "2017-11-03T17:35:50Z",
      "diff_hunk" : "@@ -180,7 +175,7 @@ def run_test(self):\n             block.solve()\n             block_message = msg_block(block)\n             # Send message is used to send a P2P message to the node over our NodeConn connection\n-            node0.send_message(block_message)\n+            self.nodes[0].send_message(block_message)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r148848225",
      "id" : 148848225,
      "original_commit_id" : "9054fc17e6b279e20d5d11820634a12fe545cd97",
      "original_position" : 40,
      "path" : "test/functional/example_test.py",
      "position" : null,
      "pull_request_review_id" : 74158677,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182",
      "updated_at" : "2017-11-03T19:29:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/148848225",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r148851171"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/148851171"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[tests] Add p2p connection to TestNode\"\r\n\r\nThis is now send_p2p_message. But I agree with JoÃÂ£o that this should be dropped. `node.send_p2p_message()` is not any more convenient than `node.p2p.send_message()`, and now tests can wind up with a confusing mix of the two calls. It's also weird that we would arbitrarily provide a wrapper for this one single NodeConnCB method, but not any of the other methods.",
      "commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "created_at" : "2017-11-03T17:47:20Z",
      "diff_hunk" : "@@ -31,9 +33,13 @@ class TestNode():\n     - state about the node (whether it's running, etc)\n     - a Python subprocess.Popen object representing the running process\n     - an RPC connection to the node\n+    - one or more P2P connections to the node\n+\n \n-    To make things easier for the test writer, a bit of magic is happening under the covers.\n-    Any unrecognised messages will be dispatched to the RPC connection.\"\"\"\n+    To make things easier for the test writer, this class will try to dispatch\n+    messages over the correct interface:\n+    - send_message is dispatched to the first P2P connection.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r148851171",
      "id" : 148851171,
      "original_commit_id" : "9054fc17e6b279e20d5d11820634a12fe545cd97",
      "original_position" : 28,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : 28,
      "pull_request_review_id" : 74158677,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182",
      "updated_at" : "2017-11-03T19:29:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/148851171",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r148851396"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/148851396"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[tests] Add p2p connection to TestNode\"\r\n\r\nDead code, should delete",
      "commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "created_at" : "2017-11-03T17:48:15Z",
      "diff_hunk" : "@@ -151,6 +160,45 @@ def node_encrypt_wallet(self, passphrase):\n         self.encryptwallet(passphrase)\n         self.wait_until_stopped()\n \n+    # def add_p2p_connection(self, p2p_conn_type, dstaddr='127.0.0.1', dstport=None, services=NODE_NETWORK, send_version=True):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r148851396",
      "id" : 148851396,
      "original_commit_id" : "9054fc17e6b279e20d5d11820634a12fe545cd97",
      "original_position" : 56,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : 60,
      "pull_request_review_id" : 74158677,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182",
      "updated_at" : "2017-11-03T19:29:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/148851396",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r148859555"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/148859555"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[tests] Add p2p connection to TestNode\"\r\n\r\nShould drop `p2p_conn_type` and just take `p2p_conn` as an argument.\r\n\r\nHere there is two much coupling in the other direction (Tests<->TestNode rather than TestNode<->MiniNode), and the control flow is unnecessarily convoluted. Test calls add_p2p_connection, add_p2p_connection calls back into test using p2p_conn_type callback to construct the test's custom NodeConnCB object, wires it up, and then passes it back to test.\r\n\r\nWould be cleaner and simpler for tests to construct their own NodeConnCB objects and just pass them here to be wired up.\r\n\r\n(I see in #11518 you are using this flow to indirectly pass dstport to the P2PConnection constructor up through the p2p_conn_type callback and inherited contructors. But I think a direct approach would be better there, too: instead of connecting in the P2PConnection constructor, you should just add a P2PConnection connect method and have this code call it.)\r\n\r\nTests should be largely unaffected by this change. Instead of saying `add_p2p_connection(CustomHandler)` they would say `add_p2p_connection(CustomHandler())` which would be better because it will allow them to more easily pass options to their own handlers, and would be more straightforward because it will be obvious just looking at the test code how and when the handler classes that it defines are getting instantiated.",
      "commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "created_at" : "2017-11-03T18:20:02Z",
      "diff_hunk" : "@@ -151,6 +160,45 @@ def node_encrypt_wallet(self, passphrase):\n         self.encryptwallet(passphrase)\n         self.wait_until_stopped()\n \n+    # def add_p2p_connection(self, p2p_conn_type, dstaddr='127.0.0.1', dstport=None, services=NODE_NETWORK, send_version=True):\n+    def add_p2p_connection(self, p2p_conn_type, **kwargs):\n+        \"\"\"Add a p2p connection to the node.\n+\n+        This method adds the p2p connection to the self.p2ps list and also\n+        returns the connection to the caller.\"\"\"\n+        if 'dstport' not in kwargs:\n+            kwargs['dstport'] = p2p_port(self.index)\n+        if 'dstaddr' not in kwargs:\n+            kwargs['dstaddr'] = '127.0.0.1'\n+        p2p_conn = p2p_conn_type()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r148859555",
      "id" : 148859555,
      "original_commit_id" : "9054fc17e6b279e20d5d11820634a12fe545cd97",
      "original_position" : 66,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : 70,
      "pull_request_review_id" : 74158677,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182",
      "updated_at" : "2017-11-03T19:29:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/148859555",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r148862392"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/148862392"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[tests] fix TestNode.\\_\\_getattr\\_\\_() method\"\r\n\r\nNeed to change args/kwargs to name in this commit (it is done in a later commit but broken here).",
      "commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "created_at" : "2017-11-03T18:32:01Z",
      "diff_hunk" : "@@ -66,7 +66,7 @@ def __init__(self, i, dirname, extra_args, rpchost, timewait, binary, stderr, mo\n     def __getattr__(self, *args, **kwargs):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r148862392",
      "id" : 148862392,
      "original_commit_id" : "efbe3de9773df14380844d3e4b5d5dc262d158a7",
      "original_position" : 1,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : null,
      "pull_request_review_id" : 74158677,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182",
      "updated_at" : "2017-11-03T19:29:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/148862392",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r148870138"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/148870138"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[tests] Add p2p connection to TestNode\"\r\n\r\nThis is an internal implementation detail of NodeConnCB and you should add a NodeConnCB.disconnect() method to take care of it. This disconnect_p2p method can then be removed and tests call `node.p2p.disconnect()` instead of `node.disconnect_p2p()`.\r\n\r\nIf for some tests need to clear the `p2ps` array (I don't see any that do) they should just do it directly. This would be nicer than the way the two current disconnect_p2p callers are effectively doing `del p2ps[0]` in a loop to clear the array, for no apparent reason.",
      "commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "created_at" : "2017-11-03T19:05:55Z",
      "diff_hunk" : "@@ -151,6 +160,45 @@ def node_encrypt_wallet(self, passphrase):\n         self.encryptwallet(passphrase)\n         self.wait_until_stopped()\n \n+    # def add_p2p_connection(self, p2p_conn_type, dstaddr='127.0.0.1', dstport=None, services=NODE_NETWORK, send_version=True):\n+    def add_p2p_connection(self, p2p_conn_type, **kwargs):\n+        \"\"\"Add a p2p connection to the node.\n+\n+        This method adds the p2p connection to the self.p2ps list and also\n+        returns the connection to the caller.\"\"\"\n+        if 'dstport' not in kwargs:\n+            kwargs['dstport'] = p2p_port(self.index)\n+        if 'dstaddr' not in kwargs:\n+            kwargs['dstaddr'] = '127.0.0.1'\n+        p2p_conn = p2p_conn_type()\n+        self.p2ps.append(p2p_conn)\n+        kwargs.update({'rpc': self.rpc, 'callback': p2p_conn})\n+        p2p_conn.add_connection(NodeConn(**kwargs))\n+\n+        return p2p_conn\n+\n+    @property\n+    def p2p(self):\n+        \"\"\"Return the first p2p connection\n+\n+        Convenience property - most tests only use a single p2p connection to each\n+        node, so this saves having to write node.p2ps[0] many times.\"\"\"\n+        assert self.p2ps, \"No p2p connection\"\n+        return self.p2ps[0]\n+\n+    def send_p2p_message(self, message):\n+        \"\"\"Send a p2p message to the node.\"\"\"\n+        assert self.p2ps, \"No p2p connection\"\n+        self.p2ps[0].send_message(message)\n+\n+    def disconnect_p2p(self, index=0):\n+        \"\"\"Close the p2p connection to the node.\"\"\"\n+        # Connection could have already been closed by other end. Calling disconnect_p2p()\n+        # on an already disconnected p2p connection is not an error.\n+        if self.p2ps[index].connection is not None:",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r148870138",
      "id" : 148870138,
      "original_commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "original_position" : 95,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : 95,
      "pull_request_review_id" : 74158677,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182",
      "updated_at" : "2017-11-03T19:29:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/148870138",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r149162022"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/149162022"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ok, I've removed the `send_p2p_message()` method",
      "commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "created_at" : "2017-11-06T18:28:15Z",
      "diff_hunk" : "@@ -31,9 +33,13 @@ class TestNode():\n     - state about the node (whether it's running, etc)\n     - a Python subprocess.Popen object representing the running process\n     - an RPC connection to the node\n+    - one or more P2P connections to the node\n+\n \n-    To make things easier for the test writer, a bit of magic is happening under the covers.\n-    Any unrecognised messages will be dispatched to the RPC connection.\"\"\"\n+    To make things easier for the test writer, this class will try to dispatch\n+    messages over the correct interface:\n+    - send_message is dispatched to the first P2P connection.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r149162022",
      "id" : 149162022,
      "in_reply_to_id" : 148851171,
      "original_commit_id" : "9054fc17e6b279e20d5d11820634a12fe545cd97",
      "original_position" : 28,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : 28,
      "pull_request_review_id" : 74513586,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182",
      "updated_at" : "2017-11-06T18:28:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/149162022",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r149162048"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/149162048"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "created_at" : "2017-11-06T18:28:23Z",
      "diff_hunk" : "@@ -66,7 +66,7 @@ def __init__(self, i, dirname, extra_args, rpchost, timewait, binary, stderr, mo\n     def __getattr__(self, *args, **kwargs):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r149162048",
      "id" : 149162048,
      "in_reply_to_id" : 148862392,
      "original_commit_id" : "efbe3de9773df14380844d3e4b5d5dc262d158a7",
      "original_position" : 1,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : null,
      "pull_request_review_id" : 74513616,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182",
      "updated_at" : "2017-11-06T18:28:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/149162048",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r149163323"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/149163323"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've left the changes to example_test.py in the first commit, since I think it's good to demonstrate the usage of the new functionality in the same commit as the functionality being added.\r\n\r\nHowever, I have changed these calls to be `node.p2p.send_message()` as suggested below.",
      "commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "created_at" : "2017-11-06T18:33:18Z",
      "diff_hunk" : "@@ -180,7 +175,7 @@ def run_test(self):\n             block.solve()\n             block_message = msg_block(block)\n             # Send message is used to send a P2P message to the node over our NodeConn connection\n-            node0.send_message(block_message)\n+            self.nodes[0].send_message(block_message)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r149163323",
      "id" : 149163323,
      "in_reply_to_id" : 148848225,
      "original_commit_id" : "9054fc17e6b279e20d5d11820634a12fe545cd97",
      "original_position" : 40,
      "path" : "test/functional/example_test.py",
      "position" : null,
      "pull_request_review_id" : 74515053,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182",
      "updated_at" : "2017-11-06T18:33:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/149163323",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r149163350"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/149163350"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "created_at" : "2017-11-06T18:33:25Z",
      "diff_hunk" : "@@ -151,6 +160,45 @@ def node_encrypt_wallet(self, passphrase):\n         self.encryptwallet(passphrase)\n         self.wait_until_stopped()\n \n+    # def add_p2p_connection(self, p2p_conn_type, dstaddr='127.0.0.1', dstport=None, services=NODE_NETWORK, send_version=True):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r149163350",
      "id" : 149163350,
      "in_reply_to_id" : 148851396,
      "original_commit_id" : "9054fc17e6b279e20d5d11820634a12fe545cd97",
      "original_position" : 56,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : 60,
      "pull_request_review_id" : 74515084,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182",
      "updated_at" : "2017-11-06T18:33:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/149163350",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r149182081"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/149182081"
         }
      },
      "author_association" : "MEMBER",
      "body" : "yes, I agree this is better. Changed",
      "commit_id" : "cb882d0d4cfeeb91492965ed0678c9c8de340c80",
      "created_at" : "2017-11-06T19:42:42Z",
      "diff_hunk" : "@@ -151,6 +160,45 @@ def node_encrypt_wallet(self, passphrase):\n         self.encryptwallet(passphrase)\n         self.wait_until_stopped()\n \n+    # def add_p2p_connection(self, p2p_conn_type, dstaddr='127.0.0.1', dstport=None, services=NODE_NETWORK, send_version=True):\n+    def add_p2p_connection(self, p2p_conn_type, **kwargs):\n+        \"\"\"Add a p2p connection to the node.\n+\n+        This method adds the p2p connection to the self.p2ps list and also\n+        returns the connection to the caller.\"\"\"\n+        if 'dstport' not in kwargs:\n+            kwargs['dstport'] = p2p_port(self.index)\n+        if 'dstaddr' not in kwargs:\n+            kwargs['dstaddr'] = '127.0.0.1'\n+        p2p_conn = p2p_conn_type()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#discussion_r149182081",
      "id" : 149182081,
      "in_reply_to_id" : 148859555,
      "original_commit_id" : "9054fc17e6b279e20d5d11820634a12fe545cd97",
      "original_position" : 66,
      "path" : "test/functional/test_framework/test_node.py",
      "position" : 70,
      "pull_request_review_id" : 74536909,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/11182",
      "updated_at" : "2017-11-06T19:42:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/149182081",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "rebased on master now that #11389 is merged",
      "created_at" : "2017-11-08T14:41:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#issuecomment-342837449",
      "id" : 342837449,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11182",
      "updated_at" : "2017-11-08T14:41:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/342837449",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "utACK 32ae82f5c3d51a66ad4deb84819809b890664245",
      "created_at" : "2017-11-08T18:01:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/11182#issuecomment-342902274",
      "id" : 342902274,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/11182",
      "updated_at" : "2017-11-08T18:01:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/342902274",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
