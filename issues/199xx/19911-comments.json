[
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2020-09-07T19:38:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#issuecomment-688486654",
      "id" : 688486654,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19911",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4ODQ4NjY1NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-07T19:38:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688486654",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-07T19:44:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#issuecomment-688488586",
      "id" : 688488586,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19911",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4ODQ4ODU4Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-07T19:44:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688488586",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484555699"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484555699"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Consider using the `WITH_LOCK` macro for simple one-line statements:\r\n\r\n```suggestion\r\n            WITH_LOCK(pfrom.cs_vRecv, pfrom.vRecvGetData.push_back(inv));\r\n```",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-09-07T19:54:50Z",
      "diff_hunk" : "@@ -2880,7 +2883,10 @@ void PeerLogicValidation::ProcessMessage(CNode& pfrom, const std::string& msg_ty\n             CInv inv;\n             inv.type = State(pfrom.GetId())->fWantsCmpctWitness ? MSG_WITNESS_BLOCK : MSG_BLOCK;\n             inv.hash = req.blockhash;\n-            pfrom.vRecvGetData.push_back(inv);\n+            {\n+                LOCK(pfrom.cs_vRecv);\n+                pfrom.vRecvGetData.push_back(inv);\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484555699",
      "id" : 484555699,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU1NTY5OQ==",
      "original_commit_id" : "a4d7f3dc3126b6b808f27dcf3ad7b6e8b9d6b0a7",
      "original_line" : 2922,
      "original_position" : 31,
      "original_start_line" : 2886,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483699195,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-10-14T14:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484555699",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484558805"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484558805"
         }
      },
      "author_association" : "MEMBER",
      "body" : "style: consider adding braces to if blocks when touching code, to conform with the current style guide.",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-09-07T20:14:20Z",
      "diff_hunk" : "@@ -3855,15 +3861,20 @@ bool PeerLogicValidation::ProcessMessages(CNode* pfrom, std::atomic<bool>& inter\n     //\n     bool fMoreWork = false;\n \n-    if (!pfrom->vRecvGetData.empty())\n-        ProcessGetData(*pfrom, chainparams, m_connman, m_mempool, interruptMsgProc);\n+    {\n+        LOCK(pfrom->cs_vRecv);\n+        if (!pfrom->vRecvGetData.empty())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484558805",
      "id" : 484558805,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU1ODgwNQ==",
      "original_commit_id" : "a4d7f3dc3126b6b808f27dcf3ad7b6e8b9d6b0a7",
      "original_line" : 3866,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483699195,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T14:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484558805",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484568250"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484568250"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done!",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-09-07T21:15:47Z",
      "diff_hunk" : "@@ -2880,7 +2883,10 @@ void PeerLogicValidation::ProcessMessage(CNode& pfrom, const std::string& msg_ty\n             CInv inv;\n             inv.type = State(pfrom.GetId())->fWantsCmpctWitness ? MSG_WITNESS_BLOCK : MSG_BLOCK;\n             inv.hash = req.blockhash;\n-            pfrom.vRecvGetData.push_back(inv);\n+            {\n+                LOCK(pfrom.cs_vRecv);\n+                pfrom.vRecvGetData.push_back(inv);\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484568250",
      "id" : 484568250,
      "in_reply_to_id" : 484555699,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU2ODI1MA==",
      "original_commit_id" : "a4d7f3dc3126b6b808f27dcf3ad7b6e8b9d6b0a7",
      "original_line" : 2922,
      "original_position" : 31,
      "original_start_line" : 2886,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483710588,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-10-14T14:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484568250",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484568297"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484568297"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done! did not do so to adjacent code i wasn't touching.",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-09-07T21:16:00Z",
      "diff_hunk" : "@@ -3855,15 +3861,20 @@ bool PeerLogicValidation::ProcessMessages(CNode* pfrom, std::atomic<bool>& inter\n     //\n     bool fMoreWork = false;\n \n-    if (!pfrom->vRecvGetData.empty())\n-        ProcessGetData(*pfrom, chainparams, m_connman, m_mempool, interruptMsgProc);\n+    {\n+        LOCK(pfrom->cs_vRecv);\n+        if (!pfrom->vRecvGetData.empty())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484568297",
      "id" : 484568297,
      "in_reply_to_id" : 484558805,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDU2ODI5Nw==",
      "original_commit_id" : "a4d7f3dc3126b6b808f27dcf3ad7b6e8b9d6b0a7",
      "original_line" : 3866,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483710633,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T14:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484568297",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The thread sanitizer is complaining about locking order; I'm looking into it.",
      "created_at" : "2020-09-07T22:46:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#issuecomment-688531736",
      "id" : 688531736,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19911",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4ODUzMTczNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-07T22:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688531736",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484707451"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484707451"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\nstatic void ProcessGetData(CNode& pfrom, const CChainParams& chainparams, CConnman& connman, CTxMemPool& mempool, const std::atomic<bool>& interruptMsgProc)\r\n    EXCLUSIVE_LOCKS_REQUIRED(!cs_main, pfrom.cs_vRecv)\r\n```",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-09-08T07:28:11Z",
      "diff_hunk" : "@@ -1722,7 +1722,7 @@ static CTransactionRef FindTxForGetData(const CTxMemPool& mempool, const CNode&\n     return {};\n }\n \n-void static ProcessGetData(CNode& pfrom, const CChainParams& chainparams, CConnman& connman, CTxMemPool& mempool, const std::atomic<bool>& interruptMsgProc) LOCKS_EXCLUDED(cs_main)\n+void static ProcessGetData(CNode& pfrom, const CChainParams& chainparams, CConnman& connman, CTxMemPool& mempool, const std::atomic<bool>& interruptMsgProc) EXCLUSIVE_LOCKS_REQUIRED(pfrom.cs_vRecv) LOCKS_EXCLUDED(cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484707451",
      "id" : 484707451,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDcwNzQ1MQ==",
      "original_commit_id" : "3fe40815bf0e26b58dca03e164972ea70a6aa69d",
      "original_line" : 1725,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483863940,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T14:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484707451",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484737211"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484737211"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think it's right to reuse this mutex to guard `vRecvGetData` (despite the name similarities). `cs_vRecv` was added in 321d0fc6b6624c65508f8b9059418cb936f0bbbe to guard `nRecvBytes` and `mapRecvBytesPerMsgCmd`, which are statistics used in the net layer. `vRecvGetData` is a data structure used in the application layer (and should eventually move to the `Peer` struct), so should be guarded by a different mutex.\r\n\r\nI do have some commits that move both `vRecvGetData` and `orphan_work_set` to the `Peer` struct in https://github.com/jnewbery/bitcoin/commits/2020-06-cs-main-split-needs-rebase (everything from \r\n_END move tx data to net processing // START move work queue data to net processing_ to _END move work queue data to net processing // START move subversion to net_processing_). It's slightly orthogonal to this PR, but perhaps we should just do that now while we're touching these fields?",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-09-08T08:19:36Z",
      "diff_hunk" : "@@ -825,7 +826,7 @@ class CNode\n \n     RecursiveMutex cs_sendProcessing;\n \n-    std::deque<CInv> vRecvGetData;\n+    std::deque<CInv> vRecvGetData GUARDED_BY(cs_vRecv);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484737211",
      "id" : 484737211,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDczNzIxMQ==",
      "original_commit_id" : "3fe40815bf0e26b58dca03e164972ea70a6aa69d",
      "original_line" : 829,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 483901878,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T14:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484737211",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@narula \r\n> The thread sanitizer is complaining about locking order; I'm looking into it.\r\n\r\nCould I suggest some code reorganization to keep locking order constant:\r\nhttps://github.com/hebasto/bitcoin/commits/pr19911-0908 ?",
      "created_at" : "2020-09-08T08:34:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#issuecomment-688712793",
      "id" : 688712793,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19911",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4ODcxMjc5Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-08T08:34:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688712793",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484795962"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484795962"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think `cs_main` is required here.",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-09-08T09:54:05Z",
      "diff_hunk" : "@@ -3852,8 +3861,14 @@ bool PeerManager::ProcessMessages(CNode* pfrom, std::atomic<bool>& interruptMsgP\n \n     // this maintains the order of responses\n     // and prevents vRecvGetData to grow unbounded\n-    if (!pfrom->vRecvGetData.empty()) return true;\n-    if (!pfrom->orphan_work_set.empty()) return true;\n+    {\n+        LOCK(pfrom->cs_vRecv);\n+        if (!pfrom->vRecvGetData.empty()) return true;\n+    }\n+    {\n+        LOCK2(cs_main, g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484795962",
      "id" : 484795962,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc5NTk2Mg==",
      "original_commit_id" : "3fe40815bf0e26b58dca03e164972ea70a6aa69d",
      "original_line" : 3869,
      "original_position" : 72,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 483901878,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T14:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484795962",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484799322"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484799322"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> ... `vRecvGetData` is a data structure used in the application layer (and should eventually move to the `Peer` struct)...\r\n\r\nMaybe start from moving, and then introduce a mutex?",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-09-08T09:59:50Z",
      "diff_hunk" : "@@ -825,7 +826,7 @@ class CNode\n \n     RecursiveMutex cs_sendProcessing;\n \n-    std::deque<CInv> vRecvGetData;\n+    std::deque<CInv> vRecvGetData GUARDED_BY(cs_vRecv);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484799322",
      "id" : 484799322,
      "in_reply_to_id" : 484737211,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc5OTMyMg==",
      "original_commit_id" : "3fe40815bf0e26b58dca03e164972ea70a6aa69d",
      "original_line" : 829,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 483981369,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T14:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484799322",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484820843"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484820843"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Maybe start from moving, and then introduce a mutex?\r\n\r\nI think that's probably the cleanest order, but I don't want to scope-creep @narula's PR if she thinks it's better to add the mutex first. I can do the move later.",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-09-08T10:39:48Z",
      "diff_hunk" : "@@ -825,7 +826,7 @@ class CNode\n \n     RecursiveMutex cs_sendProcessing;\n \n-    std::deque<CInv> vRecvGetData;\n+    std::deque<CInv> vRecvGetData GUARDED_BY(cs_vRecv);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r484820843",
      "id" : 484820843,
      "in_reply_to_id" : 484737211,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgyMDg0Mw==",
      "original_commit_id" : "3fe40815bf0e26b58dca03e164972ea70a6aa69d",
      "original_line" : 829,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 484009752,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T14:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/484820843",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r485237497"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485237497"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks @hebasto! TIL. It's certainly shorter, but I'm worried people might miss the `!` if reading quickly, and think this function requires `cs_main`.\r\n\r\nCould you share why you suggest switching from `void static` to `static void`? Is it for general cleanup?",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-09-08T22:49:57Z",
      "diff_hunk" : "@@ -1722,7 +1722,7 @@ static CTransactionRef FindTxForGetData(const CTxMemPool& mempool, const CNode&\n     return {};\n }\n \n-void static ProcessGetData(CNode& pfrom, const CChainParams& chainparams, CConnman& connman, CTxMemPool& mempool, const std::atomic<bool>& interruptMsgProc) LOCKS_EXCLUDED(cs_main)\n+void static ProcessGetData(CNode& pfrom, const CChainParams& chainparams, CConnman& connman, CTxMemPool& mempool, const std::atomic<bool>& interruptMsgProc) EXCLUSIVE_LOCKS_REQUIRED(pfrom.cs_vRecv) LOCKS_EXCLUDED(cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r485237497",
      "id" : 485237497,
      "in_reply_to_id" : 484707451,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIzNzQ5Nw==",
      "original_commit_id" : "3fe40815bf0e26b58dca03e164972ea70a6aa69d",
      "original_line" : 1725,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 484546358,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T14:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485237497",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r485351754"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485351754"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Thanks @hebasto! TIL. It's certainly shorter, but I'm worried people might miss the `!` if reading quickly, and think this function requires `cs_main`.\r\n\r\nIt is not about \"shorter\" :)\r\nSee:\r\n- https://clang.llvm.org/docs/ThreadSafetyAnalysis.html#excludes\r\n- https://clang.llvm.org/docs/ThreadSafetyAnalysis.html#negative-capabilities\r\n\r\n> Could you share why you suggest switching from `void static` to `static void`? Is it for general cleanup?\r\n\r\nE.g., fa0572d0f3b083b4c8e2e883a66e2b198c6779f1 by @MarcoFalke \r\n\r\n",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-09-09T05:44:56Z",
      "diff_hunk" : "@@ -1722,7 +1722,7 @@ static CTransactionRef FindTxForGetData(const CTxMemPool& mempool, const CNode&\n     return {};\n }\n \n-void static ProcessGetData(CNode& pfrom, const CChainParams& chainparams, CConnman& connman, CTxMemPool& mempool, const std::atomic<bool>& interruptMsgProc) LOCKS_EXCLUDED(cs_main)\n+void static ProcessGetData(CNode& pfrom, const CChainParams& chainparams, CConnman& connman, CTxMemPool& mempool, const std::atomic<bool>& interruptMsgProc) EXCLUSIVE_LOCKS_REQUIRED(pfrom.cs_vRecv) LOCKS_EXCLUDED(cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r485351754",
      "id" : 485351754,
      "in_reply_to_id" : 484707451,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM1MTc1NA==",
      "original_commit_id" : "3fe40815bf0e26b58dca03e164972ea70a6aa69d",
      "original_line" : 1725,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 484676711,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T14:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485351754",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r487585290"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487585290"
         }
      },
      "author_association" : "MEMBER",
      "body" : "right!",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-09-13T22:29:35Z",
      "diff_hunk" : "@@ -3852,8 +3861,14 @@ bool PeerManager::ProcessMessages(CNode* pfrom, std::atomic<bool>& interruptMsgP\n \n     // this maintains the order of responses\n     // and prevents vRecvGetData to grow unbounded\n-    if (!pfrom->vRecvGetData.empty()) return true;\n-    if (!pfrom->orphan_work_set.empty()) return true;\n+    {\n+        LOCK(pfrom->cs_vRecv);\n+        if (!pfrom->vRecvGetData.empty()) return true;\n+    }\n+    {\n+        LOCK2(cs_main, g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r487585290",
      "id" : 487585290,
      "in_reply_to_id" : 484795962,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzU4NTI5MA==",
      "original_commit_id" : "3fe40815bf0e26b58dca03e164972ea70a6aa69d",
      "original_line" : 3869,
      "original_position" : 72,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 487345173,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T14:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487585290",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r487697265"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487697265"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> I don't think it's right to reuse this mutex to guard `vRecvGetData` (despite the name similarities).\r\n\r\nI agree on not reusing of irrelevant mutex. To keep this PR focused, would it more correctly to introduce a new `Mutex m_recvgetdata_mutex`?",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-09-14T07:14:13Z",
      "diff_hunk" : "@@ -825,7 +826,7 @@ class CNode\n \n     RecursiveMutex cs_sendProcessing;\n \n-    std::deque<CInv> vRecvGetData;\n+    std::deque<CInv> vRecvGetData GUARDED_BY(cs_vRecv);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r487697265",
      "id" : 487697265,
      "in_reply_to_id" : 484737211,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzY5NzI2NQ==",
      "original_commit_id" : "3fe40815bf0e26b58dca03e164972ea70a6aa69d",
      "original_line" : 829,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 487473240,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T14:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487697265",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r487736372"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487736372"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This would be a slight sequencing change, but perhaps we should either call `ProcessGetData()` here, or not call it in the `GETDATA` processing for consistency. It seems from this comment that the only reason we weren't calling `ProcessGetData()` here was that `cs_main` was being held, which is no longer the case.",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-09-14T08:24:48Z",
      "diff_hunk" : "@@ -2845,36 +2848,36 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             return;\n         }\n \n-        LOCK(cs_main);\n-\n-        const CBlockIndex* pindex = LookupBlockIndex(req.blockhash);\n-        if (!pindex || !(pindex->nStatus & BLOCK_HAVE_DATA)) {\n-            LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block we don't have\\n\", pfrom.GetId());\n-            return;\n-        }\n+        CInv inv;\n+        {\n+            LOCK(cs_main);\n+            const CBlockIndex* pindex = LookupBlockIndex(req.blockhash);\n+            if (!pindex || !(pindex->nStatus & BLOCK_HAVE_DATA)) {\n+                LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block we don't have\\n\", pfrom.GetId());\n+                return;\n+            }\n+            if (pindex->nHeight >= ::ChainActive().Height() - MAX_BLOCKTXN_DEPTH) {\n+                CBlock block;\n+                bool ret = ReadBlockFromDisk(block, pindex, m_chainparams.GetConsensus());\n+                assert(ret);\n \n-        if (pindex->nHeight < ::ChainActive().Height() - MAX_BLOCKTXN_DEPTH) {\n+                SendBlockTransactions(pfrom, block, req);\n+                return;\n+            }\n             // If an older block is requested (should never happen in practice,\n             // but can happen in tests) send a block response instead of a\n             // blocktxn response. Sending a full block response instead of a\n             // small blocktxn response is preferable in the case where a peer\n             // might maliciously send lots of getblocktxn requests to trigger\n             // expensive disk reads, because it will require the peer to\n             // actually receive all the data read from disk over the network.\n-            LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block > %i deep\\n\", pfrom.GetId(), MAX_BLOCKTXN_DEPTH);\n-            CInv inv;\n             inv.type = State(pfrom.GetId())->fWantsCmpctWitness ? MSG_WITNESS_BLOCK : MSG_BLOCK;\n-            inv.hash = req.blockhash;\n-            pfrom.vRecvGetData.push_back(inv);\n-            // The message processing loop will go around again (without pausing) and we'll respond then (without cs_main)\n-            return;\n         }\n \n-        CBlock block;\n-        bool ret = ReadBlockFromDisk(block, pindex, m_chainparams.GetConsensus());\n-        assert(ret);\n-\n-        SendBlockTransactions(pfrom, block, req);\n+        LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block > %i deep\\n\", pfrom.GetId(), MAX_BLOCKTXN_DEPTH);\n+        inv.hash = req.blockhash;\n+        WITH_LOCK(pfrom.cs_vRecv, pfrom.vRecvGetData.push_back(inv));\n+        // The message processing loop will go around again (without pausing) and we'll respond then (without cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r487736372",
      "id" : 487736372,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzczNjM3Mg==",
      "original_commit_id" : "eadbad9d273edbca08ca1a49cb493292edd411a3",
      "original_line" : 2880,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 487526536,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T14:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487736372",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r487935532"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487935532"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree on a new mutex; I was wondering about that but assumed @sipa had some reason for suggesting using `cs_vRecv` to guard it in the first place. ",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-09-14T13:51:22Z",
      "diff_hunk" : "@@ -825,7 +826,7 @@ class CNode\n \n     RecursiveMutex cs_sendProcessing;\n \n-    std::deque<CInv> vRecvGetData;\n+    std::deque<CInv> vRecvGetData GUARDED_BY(cs_vRecv);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r487935532",
      "id" : 487935532,
      "in_reply_to_id" : 484737211,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkzNTUzMg==",
      "original_commit_id" : "3fe40815bf0e26b58dca03e164972ea70a6aa69d",
      "original_line" : 829,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 487789803,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T14:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487935532",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've pushed a new series of commits which move `vRecvGetData` and `orphan_work_set` to `Peer` and then guard them appropriately. It's a bit more of a change, but happy to help move things over there if that's the end goal. \r\n\r\n> I do have some commits that move both `vRecvGetData` and `orphan_work_set` to the `Peer` struct in https://github.com/jnewbery/bitcoin/commits/2020-06-cs-main-split-needs-rebase (everything from\r\n> _END move tx data to net processing // START move work queue data to net processing_ to _END move work queue data to net processing // START move subversion to net_processing_). It's slightly orthogonal to this PR, but perhaps we should just do that now while we're touching these fields?\r\n\r\n@jnewbery I tried to cherry-pick some of your commits but they did not move cleanly given the scope of your branch's change; I also didn't do one of the renames you did to minimize the change. Let me know if there's an appropriate way to credit you.",
      "created_at" : "2020-09-14T13:54:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#issuecomment-692068452",
      "id" : 692068452,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19911",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5MjA2ODQ1Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-14T13:54:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/692068452",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r487939860"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487939860"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Would this be a behavior change?",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-09-14T13:55:26Z",
      "diff_hunk" : "@@ -2845,36 +2848,36 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             return;\n         }\n \n-        LOCK(cs_main);\n-\n-        const CBlockIndex* pindex = LookupBlockIndex(req.blockhash);\n-        if (!pindex || !(pindex->nStatus & BLOCK_HAVE_DATA)) {\n-            LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block we don't have\\n\", pfrom.GetId());\n-            return;\n-        }\n+        CInv inv;\n+        {\n+            LOCK(cs_main);\n+            const CBlockIndex* pindex = LookupBlockIndex(req.blockhash);\n+            if (!pindex || !(pindex->nStatus & BLOCK_HAVE_DATA)) {\n+                LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block we don't have\\n\", pfrom.GetId());\n+                return;\n+            }\n+            if (pindex->nHeight >= ::ChainActive().Height() - MAX_BLOCKTXN_DEPTH) {\n+                CBlock block;\n+                bool ret = ReadBlockFromDisk(block, pindex, m_chainparams.GetConsensus());\n+                assert(ret);\n \n-        if (pindex->nHeight < ::ChainActive().Height() - MAX_BLOCKTXN_DEPTH) {\n+                SendBlockTransactions(pfrom, block, req);\n+                return;\n+            }\n             // If an older block is requested (should never happen in practice,\n             // but can happen in tests) send a block response instead of a\n             // blocktxn response. Sending a full block response instead of a\n             // small blocktxn response is preferable in the case where a peer\n             // might maliciously send lots of getblocktxn requests to trigger\n             // expensive disk reads, because it will require the peer to\n             // actually receive all the data read from disk over the network.\n-            LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block > %i deep\\n\", pfrom.GetId(), MAX_BLOCKTXN_DEPTH);\n-            CInv inv;\n             inv.type = State(pfrom.GetId())->fWantsCmpctWitness ? MSG_WITNESS_BLOCK : MSG_BLOCK;\n-            inv.hash = req.blockhash;\n-            pfrom.vRecvGetData.push_back(inv);\n-            // The message processing loop will go around again (without pausing) and we'll respond then (without cs_main)\n-            return;\n         }\n \n-        CBlock block;\n-        bool ret = ReadBlockFromDisk(block, pindex, m_chainparams.GetConsensus());\n-        assert(ret);\n-\n-        SendBlockTransactions(pfrom, block, req);\n+        LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block > %i deep\\n\", pfrom.GetId(), MAX_BLOCKTXN_DEPTH);\n+        inv.hash = req.blockhash;\n+        WITH_LOCK(pfrom.cs_vRecv, pfrom.vRecvGetData.push_back(inv));\n+        // The message processing loop will go around again (without pausing) and we'll respond then (without cs_main)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r487939860",
      "id" : 487939860,
      "in_reply_to_id" : 487736372,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkzOTg2MA==",
      "original_commit_id" : "eadbad9d273edbca08ca1a49cb493292edd411a3",
      "original_line" : 2880,
      "original_position" : 75,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 487793806,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T14:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/487939860",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r488028390"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488028390"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`PeerRef` is a shared pointer, so by passing it by value here, you're incrementing the ref count, and decrementing it again when you leave the function, which incurs a performance cost, since those operations need to be atomic.\r\n\r\nThis function doesn't need to take shared ownership of the underlying `Peer` object, so you should pass by `Peer&` (see http://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#r30-take-smart-pointers-as-parameters-only-to-explicitly-express-lifetime-semantics).",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-09-14T15:33:44Z",
      "diff_hunk" : "@@ -1722,11 +1730,11 @@ static CTransactionRef FindTxForGetData(const CTxMemPool& mempool, const CNode&\n     return {};\n }\n \n-void static ProcessGetData(CNode& pfrom, const CChainParams& chainparams, CConnman& connman, CTxMemPool& mempool, const std::atomic<bool>& interruptMsgProc) LOCKS_EXCLUDED(cs_main)\n+void static ProcessGetData(CNode& pfrom, PeerRef peer, const CChainParams& chainparams, CConnman& connman, CTxMemPool& mempool, const std::atomic<bool>& interruptMsgProc) EXCLUSIVE_LOCKS_REQUIRED(!cs_main, peer->cs_vRecvGetData)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r488028390",
      "id" : 488028390,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAyODM5MA==",
      "original_commit_id" : "e15554c134c55599951e0765b02b520f72750a79",
      "original_line" : 1733,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 487897779,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T14:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488028390",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r488029389"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488029389"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think it's probably safer to just return if you can't find the `Peer` object here (as all other instances of `GetPeerRef()` except the `FinalizeNode()` call do) rather than assert.",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-09-14T15:35:06Z",
      "diff_hunk" : "@@ -2334,6 +2342,8 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    PeerRef peer = GetPeerRef(pfrom.GetId());\n+    assert(peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r488029389",
      "id" : 488029389,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAyOTM4OQ==",
      "original_commit_id" : "e15554c134c55599951e0765b02b520f72750a79",
      "original_line" : 2346,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 487897779,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T14:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488029389",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #20158 (tree-wide: De-globalize ChainstateManager by dongcarl)\n* #19910 (net processing: Move peer_map to PeerManager by jnewbery)\n* #19829 (net processing: Move block inventory state to net_processing by jnewbery)\n* #9245 (Drop IO priority to idle while reading blocks for peer requests and startup verification by luke-jr)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-09-19T13:45:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#issuecomment-695215436",
      "id" : 695215436,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19911",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5NTIxNTQzNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-15T21:51:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/695215436",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-29T10:04:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#issuecomment-700602358",
      "id" : 700602358,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19911",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwMDYwMjM1OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-29T10:04:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/700602358",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r497173268"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/497173268"
         }
      },
      "author_association" : "MEMBER",
      "body" : "thanks for the pointer! fixed.",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-09-30T00:19:44Z",
      "diff_hunk" : "@@ -1722,11 +1730,11 @@ static CTransactionRef FindTxForGetData(const CTxMemPool& mempool, const CNode&\n     return {};\n }\n \n-void static ProcessGetData(CNode& pfrom, const CChainParams& chainparams, CConnman& connman, CTxMemPool& mempool, const std::atomic<bool>& interruptMsgProc) LOCKS_EXCLUDED(cs_main)\n+void static ProcessGetData(CNode& pfrom, PeerRef peer, const CChainParams& chainparams, CConnman& connman, CTxMemPool& mempool, const std::atomic<bool>& interruptMsgProc) EXCLUSIVE_LOCKS_REQUIRED(!cs_main, peer->cs_vRecvGetData)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r497173268",
      "id" : 497173268,
      "in_reply_to_id" : 488028390,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE3MzI2OA==",
      "original_commit_id" : "e15554c134c55599951e0765b02b520f72750a79",
      "original_line" : 1733,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 499009276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T14:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/497173268",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r497173408"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/497173408"
         }
      },
      "author_association" : "MEMBER",
      "body" : "addressed.",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-09-30T00:19:53Z",
      "diff_hunk" : "@@ -2334,6 +2342,8 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    PeerRef peer = GetPeerRef(pfrom.GetId());\n+    assert(peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r497173408",
      "id" : 497173408,
      "in_reply_to_id" : 488029389,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzE3MzQwOA==",
      "original_commit_id" : "e15554c134c55599951e0765b02b520f72750a79",
      "original_line" : 2346,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 499009343,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T14:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/497173408",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r497435407"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/497435407"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In commit \"Move m_orphan_work_set to net_processing\": I think you should put this call at the top of `ProcessMessage()` in this commit, rather than putting it here, and then moving it up in a later commit.\r\n\r\nAlternatively, you could change the `ProcessMessage()` signature to take a `Peer&`. I don't think that's necessary, but you may prefer it to fetching the `PeerRef` in `ProcessMessages()` and then again in `ProcessMessage()`.",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-09-30T11:27:17Z",
      "diff_hunk" : "@@ -2984,6 +2987,8 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         }\n \n         std::list<CTransactionRef> lRemovedTxn;\n+        PeerRef peer = GetPeerRef(pfrom.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r497435407",
      "id" : 497435407,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQzNTQwNw==",
      "original_commit_id" : "418cc40c35f5e34cfb9d19034d746d4abb75cfe3",
      "original_line" : 2990,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 499331075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T14:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/497435407",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r497446364"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/497446364"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Since you're touching every line that `vRecvGetData` is on already, you may as well add a scripted-diff commit to this branch that updates the name to modern style guidelines, e.g. something like `m_get_data_requests` or similar. Same for the mutex name - it could be renamed to `m_get_data_requests_mutex` or similar.",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-09-30T11:48:23Z",
      "diff_hunk" : "@@ -488,6 +488,14 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Set of txids to reconsider once their parent transactions have been accepted **/\n+    std::set<uint256> m_orphan_work_set GUARDED_BY(g_cs_orphans);\n+\n+    /** Protects vRecvGetData **/\n+    Mutex cs_vRecvGetData;\n+    /** Work queue of items requested by this peer **/\n+    std::deque<CInv> vRecvGetData GUARDED_BY(cs_vRecvGetData);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r497446364",
      "id" : 497446364,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQ0NjM2NA==",
      "original_commit_id" : "fe476e0c5130b8e13d5194fd7c98672f87818ba4",
      "original_line" : 510,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 499331075,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T14:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/497446364",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Sorry - needs rebase :grimacing: ",
      "created_at" : "2020-09-30T14:30:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#issuecomment-701428765",
      "id" : 701428765,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19911",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwMTQyODc2NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-30T14:30:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/701428765",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-30T15:35:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#issuecomment-701469339",
      "id" : 701469339,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19911",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwMTQ2OTMzOQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-30T15:35:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/701469339",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r497715142"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/497715142"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-09-30T18:26:43Z",
      "diff_hunk" : "@@ -488,6 +488,14 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Set of txids to reconsider once their parent transactions have been accepted **/\n+    std::set<uint256> m_orphan_work_set GUARDED_BY(g_cs_orphans);\n+\n+    /** Protects vRecvGetData **/\n+    Mutex cs_vRecvGetData;\n+    /** Work queue of items requested by this peer **/\n+    std::deque<CInv> vRecvGetData GUARDED_BY(cs_vRecvGetData);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r497715142",
      "id" : 497715142,
      "in_reply_to_id" : 497446364,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzcxNTE0Mg==",
      "original_commit_id" : "fe476e0c5130b8e13d5194fd7c98672f87818ba4",
      "original_line" : 510,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 499701900,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T14:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/497715142",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r497716433"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/497716433"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done. I am fine with calling `GetPeerRef` again, so will leave as is and not change the signature of `ProcessMessage()`.",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-09-30T18:28:55Z",
      "diff_hunk" : "@@ -2984,6 +2987,8 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         }\n \n         std::list<CTransactionRef> lRemovedTxn;\n+        PeerRef peer = GetPeerRef(pfrom.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r497716433",
      "id" : 497716433,
      "in_reply_to_id" : 497435407,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzcxNjQzMw==",
      "original_commit_id" : "418cc40c35f5e34cfb9d19034d746d4abb75cfe3",
      "original_line" : 2990,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 499703501,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T14:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/497716433",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This is rebased and I think all comments have been addressed.",
      "created_at" : "2020-09-30T18:29:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#issuecomment-701565791",
      "id" : 701565791,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19911",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwMTU2NTc5MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-30T18:29:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/701565791",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r501913124"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/501913124"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Rather than splitting this logic up (hoisting the `CInv` declaration above the code block, fetching the `type` inside the `cs_main` scope, and then putting the rest of the logic outside the cs_main scope), I recommend you keep all the logic together:\r\n\r\n```diff\r\n--- a/src/net_processing.cpp\r\n+++ b/src/net_processing.cpp\r\n@@ -2872,8 +2872,6 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\r\n             return;\r\n         }\r\n \r\n-        CInv inv;\r\n-\r\n         {\r\n             LOCK(cs_main);\r\n \r\n@@ -2892,17 +2890,18 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\r\n                 return;\r\n             }\r\n \r\n-            // If an older block is requested (should never happen in practice,\r\n-            // but can happen in tests) send a block response instead of a\r\n-            // blocktxn response. Sending a full block response instead of a\r\n-            // small blocktxn response is preferable in the case where a peer\r\n-            // might maliciously send lots of getblocktxn requests to trigger\r\n-            // expensive disk reads, because it will require the peer to\r\n-            // actually receive all the data read from disk over the network.\r\n-            inv.type = State(pfrom.GetId())->fWantsCmpctWitness ? MSG_WITNESS_BLOCK : MSG_BLOCK;\r\n         }\r\n \r\n+        // If an older block is requested (should never happen in practice,\r\n+        // but can happen in tests) send a block response instead of a\r\n+        // blocktxn response. Sending a full block response instead of a\r\n+        // small blocktxn response is preferable in the case where a peer\r\n+        // might maliciously send lots of getblocktxn requests to trigger\r\n+        // expensive disk reads, because it will require the peer to\r\n+        // actually receive all the data read from disk over the network.\r\n         LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block > %i deep\\n\", pfrom.GetId(), MAX_BLOCKTXN_DEPTH);\r\n+        CInv inv;\r\n+        inv.type = WITH_LOCK(cs_main, return State(pfrom.GetId())->fWantsCmpctWitness ? MSG_WITNESS_BLOCK : MSG_BLOCK);\r\n         inv.hash = req.blockhash;\r\n```\r\n\r\nIt's slightly wasteful that cs_main is released and then taken again, but I think it's ok because:\r\n\r\n1. As the comment says, we don't expect this to happen except in tests\r\n2. `fWantsCmpctWitness` should move to the `Peer` struct eventually, removing the need to take cs_main",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-08T18:03:59Z",
      "diff_hunk" : "@@ -2858,36 +2872,40 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             return;\n         }\n \n-        LOCK(cs_main);\n+        CInv inv;\n \n-        const CBlockIndex* pindex = LookupBlockIndex(req.blockhash);\n-        if (!pindex || !(pindex->nStatus & BLOCK_HAVE_DATA)) {\n-            LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block we don't have\\n\", pfrom.GetId());\n-            return;\n-        }\n+        {\n+            LOCK(cs_main);\n+\n+            const CBlockIndex* pindex = LookupBlockIndex(req.blockhash);\n+            if (!pindex || !(pindex->nStatus & BLOCK_HAVE_DATA)) {\n+                LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block we don't have\\n\", pfrom.GetId());\n+                return;\n+            }\n+\n+            if (pindex->nHeight >= ::ChainActive().Height() - MAX_BLOCKTXN_DEPTH) {\n+                CBlock block;\n+                bool ret = ReadBlockFromDisk(block, pindex, m_chainparams.GetConsensus());\n+                assert(ret);\n+\n+                SendBlockTransactions(pfrom, block, req);\n+                return;\n+            }\n \n-        if (pindex->nHeight < ::ChainActive().Height() - MAX_BLOCKTXN_DEPTH) {\n             // If an older block is requested (should never happen in practice,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r501913124",
      "id" : 501913124,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkxMzEyNA==",
      "original_commit_id" : "348202f27b75a6b147ab04166cdb343d3e955d91",
      "original_line" : 2895,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 505036862,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T14:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/501913124",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r501913848"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/501913848"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Just realised you add this as `cs_vRecvGetData` in one commit and then change it with a scripted diff in the subsequent commit. You can just name it `m_getdata_requests_mutex` in the first commit!",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-08T18:05:06Z",
      "diff_hunk" : "@@ -501,6 +501,14 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Set of txids to reconsider once their parent transactions have been accepted **/\n+    std::set<uint256> m_orphan_work_set GUARDED_BY(g_cs_orphans);\n+\n+    /** Protects m_getdata_requests **/\n+    Mutex m_getdata_requests_mutex;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r501913848",
      "id" : 501913848,
      "line" : 519,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTkxMzg0OA==",
      "original_commit_id" : "348202f27b75a6b147ab04166cdb343d3e955d91",
      "original_line" : 519,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 8,
      "pull_request_review_id" : 505036862,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T14:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/501913848",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-10-12T18:11:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#issuecomment-707271505",
      "id" : 707271505,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19911",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwNzI3MTUwNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-12T18:11:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/707271505",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504301257"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504301257"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agreed, this is nicer! Changed. \r\n\r\nInterestingly, your exact suggestion didn't work: I had to move the assignment to `inv.type` inside the `WITH_LOCK` macro. I got the following error the other way:\r\n\r\n```\r\n./sync.h:257:45: note: expanded from macro 'WITH_LOCK'\r\n#define WITH_LOCK(cs, code) [&] { LOCK(cs); code; }()\r\n                                            ^~~~\r\nnet_processing.cpp:2934:20: error: assigning to 'uint32_t' (aka 'unsigned int') from incompatible type 'void'\r\n        inv.type = WITH_LOCK(cs_main, State(pfrom.GetId())->fWantsCmpctWitness ? MSG_WITNESS_BLOCK : MSG_BLOCK);\r\n                   ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n./sync.h:257:29: note: expanded from macro 'WITH_LOCK'\r\n#define WITH_LOCK(cs, code) [&] { LOCK(cs); code; }()\r\n                            ^~~~~~~~~~~~~~~~~~~~~~~~~\r\n```",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-13T22:46:25Z",
      "diff_hunk" : "@@ -2858,36 +2872,40 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             return;\n         }\n \n-        LOCK(cs_main);\n+        CInv inv;\n \n-        const CBlockIndex* pindex = LookupBlockIndex(req.blockhash);\n-        if (!pindex || !(pindex->nStatus & BLOCK_HAVE_DATA)) {\n-            LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block we don't have\\n\", pfrom.GetId());\n-            return;\n-        }\n+        {\n+            LOCK(cs_main);\n+\n+            const CBlockIndex* pindex = LookupBlockIndex(req.blockhash);\n+            if (!pindex || !(pindex->nStatus & BLOCK_HAVE_DATA)) {\n+                LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block we don't have\\n\", pfrom.GetId());\n+                return;\n+            }\n+\n+            if (pindex->nHeight >= ::ChainActive().Height() - MAX_BLOCKTXN_DEPTH) {\n+                CBlock block;\n+                bool ret = ReadBlockFromDisk(block, pindex, m_chainparams.GetConsensus());\n+                assert(ret);\n+\n+                SendBlockTransactions(pfrom, block, req);\n+                return;\n+            }\n \n-        if (pindex->nHeight < ::ChainActive().Height() - MAX_BLOCKTXN_DEPTH) {\n             // If an older block is requested (should never happen in practice,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504301257",
      "id" : 504301257,
      "in_reply_to_id" : 501913124,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDMwMTI1Nw==",
      "original_commit_id" : "348202f27b75a6b147ab04166cdb343d3e955d91",
      "original_line" : 2895,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 507880932,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T14:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504301257",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504504603"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504504603"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It looks like you missed out the `return` from inside the `WITH_LOCK` macro's second argument:\r\n\r\n`        inv.type = WITH_LOCK(cs_main, return State(pfrom.GetId())->fWantsCmpctWitness ? MSG_WITNESS_BLOCK : MSG_BLOCK);`\r\n\r\nBut your way is also fine!",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-14T08:42:20Z",
      "diff_hunk" : "@@ -2858,36 +2872,40 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             return;\n         }\n \n-        LOCK(cs_main);\n+        CInv inv;\n \n-        const CBlockIndex* pindex = LookupBlockIndex(req.blockhash);\n-        if (!pindex || !(pindex->nStatus & BLOCK_HAVE_DATA)) {\n-            LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block we don't have\\n\", pfrom.GetId());\n-            return;\n-        }\n+        {\n+            LOCK(cs_main);\n+\n+            const CBlockIndex* pindex = LookupBlockIndex(req.blockhash);\n+            if (!pindex || !(pindex->nStatus & BLOCK_HAVE_DATA)) {\n+                LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block we don't have\\n\", pfrom.GetId());\n+                return;\n+            }\n+\n+            if (pindex->nHeight >= ::ChainActive().Height() - MAX_BLOCKTXN_DEPTH) {\n+                CBlock block;\n+                bool ret = ReadBlockFromDisk(block, pindex, m_chainparams.GetConsensus());\n+                assert(ret);\n+\n+                SendBlockTransactions(pfrom, block, req);\n+                return;\n+            }\n \n-        if (pindex->nHeight < ::ChainActive().Height() - MAX_BLOCKTXN_DEPTH) {\n             // If an older block is requested (should never happen in practice,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504504603",
      "id" : 504504603,
      "in_reply_to_id" : 501913124,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUwNDYwMw==",
      "original_commit_id" : "348202f27b75a6b147ab04166cdb343d3e955d91",
      "original_line" : 2895,
      "original_position" : 111,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 508122868,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T14:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504504603",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> In commit _Move m_orphan_work_set to net_processing_, you're not removing CNode::m_orphan_work_set.\r\n> \r\n> Other than that, looks good!\r\n\r\nGood catch, I lost that in the last rebase! Fixed.",
      "created_at" : "2020-10-14T14:11:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#issuecomment-708430130",
      "id" : 708430130,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19911",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwODQzMDEzMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-14T14:11:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/708430130",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review ACK da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-14T14:35:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#issuecomment-708445514",
      "id" : 708445514,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19911",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwODQ0NTUxNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-14T14:35:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/708445514",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504745752"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504745752"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8803aee66813d27ddbdfce937ab9c35f8f7c35bc\r\n\r\nTo describe a member `//!` is [recommended](https://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md#coding-style-doxygen-compatible-comments):\r\n```suggestion\r\n    //! Set of txids to reconsider once their parent transactions have been accepted.\r\n```",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-14T14:55:18Z",
      "diff_hunk" : "@@ -512,6 +512,9 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Set of txids to reconsider once their parent transactions have been accepted **/",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504745752",
      "id" : 504745752,
      "line" : 515,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc0NTc1Mg==",
      "original_commit_id" : "8803aee66813d27ddbdfce937ab9c35f8f7c35bc",
      "original_line" : 515,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 4,
      "pull_request_review_id" : 508436752,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T15:31:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504745752",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504746443"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504746443"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8803aee66813d27ddbdfce937ab9c35f8f7c35bc, nit:\r\n```suggestion\r\n    if (!peer) return;\r\n```",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-14T14:56:06Z",
      "diff_hunk" : "@@ -2363,6 +2366,8 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    PeerRef peer = GetPeerRef(pfrom.GetId());\n+    if (peer == nullptr) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504746443",
      "id" : 504746443,
      "line" : 2375,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc0NjQ0Mw==",
      "original_commit_id" : "8803aee66813d27ddbdfce937ab9c35f8f7c35bc",
      "original_line" : 2370,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 61,
      "pull_request_review_id" : 508436752,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T15:31:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504746443",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504748385"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504748385"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8803aee66813d27ddbdfce937ab9c35f8f7c35bc, nit:\r\n```suggestion\r\n    if (!peer) return false;\r\n```",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-14T14:58:28Z",
      "diff_hunk" : "@@ -3865,12 +3870,15 @@ bool PeerManager::ProcessMessages(CNode* pfrom, std::atomic<bool>& interruptMsgP\n {\n     bool fMoreWork = false;\n \n+    PeerRef peer = GetPeerRef(pfrom->GetId());\n+    if (peer == nullptr) return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504748385",
      "id" : 504748385,
      "line" : 3885,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc0ODM4NQ==",
      "original_commit_id" : "8803aee66813d27ddbdfce937ab9c35f8f7c35bc",
      "original_line" : 3874,
      "original_position" : 42,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 170,
      "pull_request_review_id" : 508436752,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T15:31:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504748385",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504755912"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504755912"
         }
      },
      "author_association" : "MEMBER",
      "body" : "673247b58cd1252ab7e99f7d63ead05cc100cef2, nit:\r\n```suggestion\r\n    std::set<uint256> m_orphan_work_set GUARDED_BY(::g_cs_orphans);\r\n```",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-14T15:08:07Z",
      "diff_hunk" : "@@ -513,7 +513,7 @@ struct Peer {\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n     /** Set of txids to reconsider once their parent transactions have been accepted **/\n-    std::set<uint256> m_orphan_work_set;\n+    std::set<uint256> m_orphan_work_set GUARDED_BY(g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504755912",
      "id" : 504755912,
      "line" : 516,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc1NTkxMg==",
      "original_commit_id" : "673247b58cd1252ab7e99f7d63ead05cc100cef2",
      "original_line" : 516,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 508436752,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T15:31:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504755912",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504756533"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504756533"
         }
      },
      "author_association" : "MEMBER",
      "body" : "673247b58cd1252ab7e99f7d63ead05cc100cef2, nit:\r\n```suggestion\r\n        LOCK(::g_cs_orphans);\r\n```",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-14T15:08:55Z",
      "diff_hunk" : "@@ -3887,7 +3889,10 @@ bool PeerManager::ProcessMessages(CNode* pfrom, std::atomic<bool>& interruptMsgP\n     // this maintains the order of responses\n     // and prevents vRecvGetData to grow unbounded\n     if (!pfrom->vRecvGetData.empty()) return true;\n-    if (!peer->m_orphan_work_set.empty()) return true;\n+    {\n+        LOCK(g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504756533",
      "id" : 504756533,
      "line" : 3912,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc1NjUzMw==",
      "original_commit_id" : "673247b58cd1252ab7e99f7d63ead05cc100cef2",
      "original_line" : 3893,
      "original_position" : 29,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 202,
      "pull_request_review_id" : 508436752,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T15:31:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504756533",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504757740"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504757740"
         }
      },
      "author_association" : "MEMBER",
      "body" : "2d9f2fca43aadcdda4d644cddab36dca88b40b97\r\n\r\nTo describe a member `//!` is [recommended](https://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md#coding-style-doxygen-compatible-comments):\r\n```suggestion\r\n    //! Work queue of items requested by this peer.\r\n```",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-14T15:10:26Z",
      "diff_hunk" : "@@ -515,6 +515,9 @@ struct Peer {\n     /** Set of txids to reconsider once their parent transactions have been accepted **/\n     std::set<uint256> m_orphan_work_set GUARDED_BY(g_cs_orphans);\n \n+    /** Work queue of items requested by this peer **/",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504757740",
      "id" : 504757740,
      "line" : 520,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc1Nzc0MA==",
      "original_commit_id" : "2d9f2fca43aadcdda4d644cddab36dca88b40b97",
      "original_line" : 518,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 9,
      "pull_request_review_id" : 508436752,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T15:31:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504757740",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504758200"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504758200"
         }
      },
      "author_association" : "MEMBER",
      "body" : "2d9f2fca43aadcdda4d644cddab36dca88b40b97, nit:\r\n```suggestion\r\n    if (!peer) return;\r\n```",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-14T15:11:02Z",
      "diff_hunk" : "@@ -1754,7 +1757,10 @@ void static ProcessGetData(CNode& pfrom, const CChainParams& chainparams, CConnm\n {\n     AssertLockNotHeld(cs_main);\n \n-    std::deque<CInv>::iterator it = pfrom.vRecvGetData.begin();\n+    PeerRef peer = GetPeerRef(pfrom.GetId());\n+    if (peer == nullptr) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504758200",
      "id" : 504758200,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc1ODIwMA==",
      "original_commit_id" : "2d9f2fca43aadcdda4d644cddab36dca88b40b97",
      "original_line" : 1761,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 508436752,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T15:31:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504758200",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504758581"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504758581"
         }
      },
      "author_association" : "MEMBER",
      "body" : "2d9f2fca43aadcdda4d644cddab36dca88b40b97, nit:\r\n```suggestion\r\n    auto it = peer->vRecvGetData.begin();\r\n```",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-14T15:11:33Z",
      "diff_hunk" : "@@ -1754,7 +1757,10 @@ void static ProcessGetData(CNode& pfrom, const CChainParams& chainparams, CConnm\n {\n     AssertLockNotHeld(cs_main);\n \n-    std::deque<CInv>::iterator it = pfrom.vRecvGetData.begin();\n+    PeerRef peer = GetPeerRef(pfrom.GetId());\n+    if (peer == nullptr) return;\n+\n+    std::deque<CInv>::iterator it = peer->vRecvGetData.begin();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504758581",
      "id" : 504758581,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc1ODU4MQ==",
      "original_commit_id" : "2d9f2fca43aadcdda4d644cddab36dca88b40b97",
      "original_line" : 1763,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 508436752,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T15:31:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504758581",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504759682"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504759682"
         }
      },
      "author_association" : "MEMBER",
      "body" : "2d9f2fca43aadcdda4d644cddab36dca88b40b97\r\n\r\nnit: add braces or make one line?",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-14T15:12:59Z",
      "diff_hunk" : "@@ -3921,7 +3928,7 @@ bool PeerManager::ProcessMessages(CNode* pfrom, std::atomic<bool>& interruptMsgP\n         ProcessMessage(*pfrom, msg_type, msg.m_recv, msg.m_time, interruptMsgProc);\n         if (interruptMsgProc)\n             return false;\n-        if (!pfrom->vRecvGetData.empty())\n+        if (!peer->vRecvGetData.empty())\n             fMoreWork = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504759682",
      "id" : 504759682,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc1OTY4Mg==",
      "original_commit_id" : "2d9f2fca43aadcdda4d644cddab36dca88b40b97",
      "original_line" : 3932,
      "original_position" : 93,
      "original_start_line" : 3931,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 508436752,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-10-14T15:31:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504759682",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504760847"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504760847"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ba951812ec0cc8ebee5911a582f188525b76ff0a\r\n\r\nTo describe a member `//!` is [recommended](https://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md#coding-style-doxygen-compatible-comments):\r\n```suggestion\r\n    //! Protects vRecvGetData.\r\n```",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-14T15:14:32Z",
      "diff_hunk" : "@@ -515,8 +515,10 @@ struct Peer {\n     /** Set of txids to reconsider once their parent transactions have been accepted **/\n     std::set<uint256> m_orphan_work_set GUARDED_BY(g_cs_orphans);\n \n+    /** Protects vRecvGetData **/",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504760847",
      "id" : 504760847,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc2MDg0Nw==",
      "original_commit_id" : "ba951812ec0cc8ebee5911a582f188525b76ff0a",
      "original_line" : 518,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 508436752,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T15:31:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504760847",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504772681"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504772681"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this could change behavior as between two consequent `::cs_main` holding the guarded state could be changed.\r\n\r\nMaybe just place `State` call into the guarded block above?",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-14T15:29:51Z",
      "diff_hunk" : "@@ -2900,36 +2903,38 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             return;\n         }\n \n-        LOCK(cs_main);\n+        {\n+            LOCK(cs_main);\n \n-        const CBlockIndex* pindex = LookupBlockIndex(req.blockhash);\n-        if (!pindex || !(pindex->nStatus & BLOCK_HAVE_DATA)) {\n-            LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block we don't have\\n\", pfrom.GetId());\n-            return;\n-        }\n+            const CBlockIndex* pindex = LookupBlockIndex(req.blockhash);\n+            if (!pindex || !(pindex->nStatus & BLOCK_HAVE_DATA)) {\n+                LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block we don't have\\n\", pfrom.GetId());\n+                return;\n+            }\n \n-        if (pindex->nHeight < ::ChainActive().Height() - MAX_BLOCKTXN_DEPTH) {\n-            // If an older block is requested (should never happen in practice,\n-            // but can happen in tests) send a block response instead of a\n-            // blocktxn response. Sending a full block response instead of a\n-            // small blocktxn response is preferable in the case where a peer\n-            // might maliciously send lots of getblocktxn requests to trigger\n-            // expensive disk reads, because it will require the peer to\n-            // actually receive all the data read from disk over the network.\n-            LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block > %i deep\\n\", pfrom.GetId(), MAX_BLOCKTXN_DEPTH);\n-            CInv inv;\n-            inv.type = State(pfrom.GetId())->fWantsCmpctWitness ? MSG_WITNESS_BLOCK : MSG_BLOCK;\n-            inv.hash = req.blockhash;\n-            peer->vRecvGetData.push_back(inv);\n-            // The message processing loop will go around again (without pausing) and we'll respond then (without cs_main)\n-            return;\n-        }\n+            if (pindex->nHeight >= ::ChainActive().Height() - MAX_BLOCKTXN_DEPTH) {\n+                CBlock block;\n+                bool ret = ReadBlockFromDisk(block, pindex, m_chainparams.GetConsensus());\n+                assert(ret);\n \n-        CBlock block;\n-        bool ret = ReadBlockFromDisk(block, pindex, m_chainparams.GetConsensus());\n-        assert(ret);\n+                SendBlockTransactions(pfrom, block, req);\n+                return;\n+            }\n+        }\n \n-        SendBlockTransactions(pfrom, block, req);\n+        // If an older block is requested (should never happen in practice,\n+        // but can happen in tests) send a block response instead of a\n+        // blocktxn response. Sending a full block response instead of a\n+        // small blocktxn response is preferable in the case where a peer\n+        // might maliciously send lots of getblocktxn requests to trigger\n+        // expensive disk reads, because it will require the peer to\n+        // actually receive all the data read from disk over the network.\n+        LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block > %i deep\\n\", pfrom.GetId(), MAX_BLOCKTXN_DEPTH);\n+        CInv inv;\n+        WITH_LOCK(cs_main, inv.type = State(pfrom.GetId())->fWantsCmpctWitness ? MSG_WITNESS_BLOCK : MSG_BLOCK);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504772681",
      "id" : 504772681,
      "line" : 2934,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc3MjY4MQ==",
      "original_commit_id" : "ba951812ec0cc8ebee5911a582f188525b76ff0a",
      "original_line" : 2934,
      "original_position" : 129,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 138,
      "pull_request_review_id" : 508436752,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T15:31:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504772681",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504790496"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504790496"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Whether a peer prefers witness data is independent from whether the block can be fetched from disk. The fact that they both happen to be guarded by cs_main is more of a historic accident than anything else. I think it's fine to release and retake cs_main here.",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-14T15:54:21Z",
      "diff_hunk" : "@@ -2900,36 +2903,38 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             return;\n         }\n \n-        LOCK(cs_main);\n+        {\n+            LOCK(cs_main);\n \n-        const CBlockIndex* pindex = LookupBlockIndex(req.blockhash);\n-        if (!pindex || !(pindex->nStatus & BLOCK_HAVE_DATA)) {\n-            LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block we don't have\\n\", pfrom.GetId());\n-            return;\n-        }\n+            const CBlockIndex* pindex = LookupBlockIndex(req.blockhash);\n+            if (!pindex || !(pindex->nStatus & BLOCK_HAVE_DATA)) {\n+                LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block we don't have\\n\", pfrom.GetId());\n+                return;\n+            }\n \n-        if (pindex->nHeight < ::ChainActive().Height() - MAX_BLOCKTXN_DEPTH) {\n-            // If an older block is requested (should never happen in practice,\n-            // but can happen in tests) send a block response instead of a\n-            // blocktxn response. Sending a full block response instead of a\n-            // small blocktxn response is preferable in the case where a peer\n-            // might maliciously send lots of getblocktxn requests to trigger\n-            // expensive disk reads, because it will require the peer to\n-            // actually receive all the data read from disk over the network.\n-            LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block > %i deep\\n\", pfrom.GetId(), MAX_BLOCKTXN_DEPTH);\n-            CInv inv;\n-            inv.type = State(pfrom.GetId())->fWantsCmpctWitness ? MSG_WITNESS_BLOCK : MSG_BLOCK;\n-            inv.hash = req.blockhash;\n-            peer->vRecvGetData.push_back(inv);\n-            // The message processing loop will go around again (without pausing) and we'll respond then (without cs_main)\n-            return;\n-        }\n+            if (pindex->nHeight >= ::ChainActive().Height() - MAX_BLOCKTXN_DEPTH) {\n+                CBlock block;\n+                bool ret = ReadBlockFromDisk(block, pindex, m_chainparams.GetConsensus());\n+                assert(ret);\n \n-        CBlock block;\n-        bool ret = ReadBlockFromDisk(block, pindex, m_chainparams.GetConsensus());\n-        assert(ret);\n+                SendBlockTransactions(pfrom, block, req);\n+                return;\n+            }\n+        }\n \n-        SendBlockTransactions(pfrom, block, req);\n+        // If an older block is requested (should never happen in practice,\n+        // but can happen in tests) send a block response instead of a\n+        // blocktxn response. Sending a full block response instead of a\n+        // small blocktxn response is preferable in the case where a peer\n+        // might maliciously send lots of getblocktxn requests to trigger\n+        // expensive disk reads, because it will require the peer to\n+        // actually receive all the data read from disk over the network.\n+        LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block > %i deep\\n\", pfrom.GetId(), MAX_BLOCKTXN_DEPTH);\n+        CInv inv;\n+        WITH_LOCK(cs_main, inv.type = State(pfrom.GetId())->fWantsCmpctWitness ? MSG_WITNESS_BLOCK : MSG_BLOCK);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504790496",
      "id" : 504790496,
      "in_reply_to_id" : 504772681,
      "line" : 2934,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc5MDQ5Ng==",
      "original_commit_id" : "ba951812ec0cc8ebee5911a582f188525b76ff0a",
      "original_line" : 2934,
      "original_position" : 129,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 138,
      "pull_request_review_id" : 508495150,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T15:54:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504790496",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504791695"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504791695"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I see lots of examples of `/**` being used for member comments throughout the codebase. We should update the developer docs to say both styles are allowed rather than try to change all comments to fit to one style.",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-14T15:55:59Z",
      "diff_hunk" : "@@ -512,6 +512,9 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Set of txids to reconsider once their parent transactions have been accepted **/",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504791695",
      "id" : 504791695,
      "in_reply_to_id" : 504745752,
      "line" : 515,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc5MTY5NQ==",
      "original_commit_id" : "8803aee66813d27ddbdfce937ab9c35f8f7c35bc",
      "original_line" : 515,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 4,
      "pull_request_review_id" : 508496671,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T15:56:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504791695",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504792094"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504792094"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@jnewbery Thanks!",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-14T15:56:28Z",
      "diff_hunk" : "@@ -2900,36 +2903,38 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             return;\n         }\n \n-        LOCK(cs_main);\n+        {\n+            LOCK(cs_main);\n \n-        const CBlockIndex* pindex = LookupBlockIndex(req.blockhash);\n-        if (!pindex || !(pindex->nStatus & BLOCK_HAVE_DATA)) {\n-            LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block we don't have\\n\", pfrom.GetId());\n-            return;\n-        }\n+            const CBlockIndex* pindex = LookupBlockIndex(req.blockhash);\n+            if (!pindex || !(pindex->nStatus & BLOCK_HAVE_DATA)) {\n+                LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block we don't have\\n\", pfrom.GetId());\n+                return;\n+            }\n \n-        if (pindex->nHeight < ::ChainActive().Height() - MAX_BLOCKTXN_DEPTH) {\n-            // If an older block is requested (should never happen in practice,\n-            // but can happen in tests) send a block response instead of a\n-            // blocktxn response. Sending a full block response instead of a\n-            // small blocktxn response is preferable in the case where a peer\n-            // might maliciously send lots of getblocktxn requests to trigger\n-            // expensive disk reads, because it will require the peer to\n-            // actually receive all the data read from disk over the network.\n-            LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block > %i deep\\n\", pfrom.GetId(), MAX_BLOCKTXN_DEPTH);\n-            CInv inv;\n-            inv.type = State(pfrom.GetId())->fWantsCmpctWitness ? MSG_WITNESS_BLOCK : MSG_BLOCK;\n-            inv.hash = req.blockhash;\n-            peer->vRecvGetData.push_back(inv);\n-            // The message processing loop will go around again (without pausing) and we'll respond then (without cs_main)\n-            return;\n-        }\n+            if (pindex->nHeight >= ::ChainActive().Height() - MAX_BLOCKTXN_DEPTH) {\n+                CBlock block;\n+                bool ret = ReadBlockFromDisk(block, pindex, m_chainparams.GetConsensus());\n+                assert(ret);\n \n-        CBlock block;\n-        bool ret = ReadBlockFromDisk(block, pindex, m_chainparams.GetConsensus());\n-        assert(ret);\n+                SendBlockTransactions(pfrom, block, req);\n+                return;\n+            }\n+        }\n \n-        SendBlockTransactions(pfrom, block, req);\n+        // If an older block is requested (should never happen in practice,\n+        // but can happen in tests) send a block response instead of a\n+        // blocktxn response. Sending a full block response instead of a\n+        // small blocktxn response is preferable in the case where a peer\n+        // might maliciously send lots of getblocktxn requests to trigger\n+        // expensive disk reads, because it will require the peer to\n+        // actually receive all the data read from disk over the network.\n+        LogPrint(BCLog::NET, \"Peer %d sent us a getblocktxn for a block > %i deep\\n\", pfrom.GetId(), MAX_BLOCKTXN_DEPTH);\n+        CInv inv;\n+        WITH_LOCK(cs_main, inv.type = State(pfrom.GetId())->fWantsCmpctWitness ? MSG_WITNESS_BLOCK : MSG_BLOCK);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504792094",
      "id" : 504792094,
      "in_reply_to_id" : 504772681,
      "line" : 2934,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc5MjA5NA==",
      "original_commit_id" : "ba951812ec0cc8ebee5911a582f188525b76ff0a",
      "original_line" : 2934,
      "original_position" : 129,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 138,
      "pull_request_review_id" : 508497161,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T15:56:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504792094",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Mind making the first rename commit a scripted-diff as well?\r\n\r\nIt can't be, since `orphan_work_set` is currently used as the name for both a member variable and a local variable.",
      "created_at" : "2020-10-14T15:56:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#issuecomment-708497125",
      "id" : 708497125,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19911",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwODQ5NzEyNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-14T15:56:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/708497125",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504792680"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504792680"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agree.",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-14T15:57:15Z",
      "diff_hunk" : "@@ -512,6 +512,9 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Set of txids to reconsider once their parent transactions have been accepted **/",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504792680",
      "id" : 504792680,
      "in_reply_to_id" : 504745752,
      "line" : 515,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc5MjY4MA==",
      "original_commit_id" : "8803aee66813d27ddbdfce937ab9c35f8f7c35bc",
      "original_line" : 515,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 4,
      "pull_request_review_id" : 508497904,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T15:57:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504792680",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> > Mind making the first rename commit a scripted-diff as well?\r\n> \r\n> It can't be, since `orphan_work_set` is currently used as the name for both a member variable and a local variable.\r\n\r\nIndeed. Sorry.",
      "created_at" : "2020-10-14T15:59:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#issuecomment-708498683",
      "id" : 708498683,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19911",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwODQ5ODY4Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-14T15:59:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/708498683",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504975677"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504975677"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm trying to be consistent with other ways this is checked in the file, for example https://github.com/bitcoin/bitcoin/blob/8803aee66813d27ddbdfce937ab9c35f8f7c35bc/src/net_processing.cpp#L999 and https://github.com/bitcoin/bitcoin/blob/8803aee66813d27ddbdfce937ab9c35f8f7c35bc/src/net_processing.cpp#L1146",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-14T21:13:56Z",
      "diff_hunk" : "@@ -2363,6 +2366,8 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    PeerRef peer = GetPeerRef(pfrom.GetId());\n+    if (peer == nullptr) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504975677",
      "id" : 504975677,
      "in_reply_to_id" : 504746443,
      "line" : 2375,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDk3NTY3Nw==",
      "original_commit_id" : "8803aee66813d27ddbdfce937ab9c35f8f7c35bc",
      "original_line" : 2370,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 61,
      "pull_request_review_id" : 508733523,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T21:13:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/504975677",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r505006941"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/505006941"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Resolution: I'll leave this as is.",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-14T22:06:37Z",
      "diff_hunk" : "@@ -512,6 +512,9 @@ struct Peer {\n     /** Whether this peer should be disconnected and marked as discouraged (unless it has the noban permission). */\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n+    /** Set of txids to reconsider once their parent transactions have been accepted **/",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r505006941",
      "id" : 505006941,
      "in_reply_to_id" : 504745752,
      "line" : 515,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAwNjk0MQ==",
      "original_commit_id" : "8803aee66813d27ddbdfce937ab9c35f8f7c35bc",
      "original_line" : 515,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 4,
      "pull_request_review_id" : 508803607,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T22:06:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/505006941",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r505007383"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/505007383"
         }
      },
      "author_association" : "MEMBER",
      "body" : "As noted above, leaving this as is.",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-14T22:07:12Z",
      "diff_hunk" : "@@ -515,6 +515,9 @@ struct Peer {\n     /** Set of txids to reconsider once their parent transactions have been accepted **/\n     std::set<uint256> m_orphan_work_set GUARDED_BY(g_cs_orphans);\n \n+    /** Work queue of items requested by this peer **/",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r505007383",
      "id" : 505007383,
      "in_reply_to_id" : 504757740,
      "line" : 520,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAwNzM4Mw==",
      "original_commit_id" : "2d9f2fca43aadcdda4d644cddab36dca88b40b97",
      "original_line" : 518,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 9,
      "pull_request_review_id" : 508803926,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T22:07:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/505007383",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r505018501"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/505018501"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thank you for the suggestion! Could you point me towards anything which indicates why this might be preferred? Based on my understanding, it seems like a style preference. 1) Globals are already prefixed with `g_` making it very unlikely to have a conflicting local variable 2) I don't see anywhere else in the codebase using this operator for globals.",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-14T22:21:35Z",
      "diff_hunk" : "@@ -513,7 +513,7 @@ struct Peer {\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n     /** Set of txids to reconsider once their parent transactions have been accepted **/\n-    std::set<uint256> m_orphan_work_set;\n+    std::set<uint256> m_orphan_work_set GUARDED_BY(g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r505018501",
      "id" : 505018501,
      "in_reply_to_id" : 504755912,
      "line" : 516,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTAxODUwMQ==",
      "original_commit_id" : "673247b58cd1252ab7e99f7d63ead05cc100cef2",
      "original_line" : 516,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 508810822,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-14T22:21:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/505018501",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r505192691"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/505192691"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`git grep ::cs` or https://github.com/bitcoin/bitcoin/blob/f2e6d14430137a271d153348d207df6ab8086bc6/src/init.cpp#L216\r\n\r\n> Based on my understanding, it seems like a style preference.\r\n\r\nCorrect. Feel free to ignore this nit.",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-15T06:19:35Z",
      "diff_hunk" : "@@ -513,7 +513,7 @@ struct Peer {\n     bool m_should_discourage GUARDED_BY(m_misbehavior_mutex){false};\n \n     /** Set of txids to reconsider once their parent transactions have been accepted **/\n-    std::set<uint256> m_orphan_work_set;\n+    std::set<uint256> m_orphan_work_set GUARDED_BY(g_cs_orphans);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r505192691",
      "id" : 505192691,
      "in_reply_to_id" : 504755912,
      "line" : 516,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE5MjY5MQ==",
      "original_commit_id" : "673247b58cd1252ab7e99f7d63ead05cc100cef2",
      "original_line" : 516,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 5,
      "pull_request_review_id" : 509019540,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-15T06:19:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/505192691",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r505198649"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/505198649"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think it is required to be consistent with a bad style of the surrounding code. Are we going to check every raw/smart pointer against `nullptr` explicitly everywhere in the code?",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-15T06:27:10Z",
      "diff_hunk" : "@@ -2363,6 +2366,8 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    PeerRef peer = GetPeerRef(pfrom.GetId());\n+    if (peer == nullptr) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r505198649",
      "id" : 505198649,
      "in_reply_to_id" : 504746443,
      "line" : 2375,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE5ODY0OQ==",
      "original_commit_id" : "8803aee66813d27ddbdfce937ab9c35f8f7c35bc",
      "original_line" : 2370,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 61,
      "pull_request_review_id" : 509033307,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-15T06:27:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/505198649",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r505377863"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/505377863"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think both are fine. We don't express a preference in our style guide. I think @hebasto's suggestion is more idiomatic, and if I were writing those lines again, I'd use the `!ptr` form.",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-15T09:06:01Z",
      "diff_hunk" : "@@ -2363,6 +2366,8 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    PeerRef peer = GetPeerRef(pfrom.GetId());\n+    if (peer == nullptr) return;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r505377863",
      "id" : 505377863,
      "in_reply_to_id" : 504746443,
      "line" : 2375,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM3Nzg2Mw==",
      "original_commit_id" : "8803aee66813d27ddbdfce937ab9c35f8f7c35bc",
      "original_line" : 2370,
      "original_position" : 15,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 61,
      "pull_request_review_id" : 509170186,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-15T09:06:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/505377863",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r505379547"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/505379547"
         }
      },
      "author_association" : "MEMBER",
      "body" : "We don't have guidance about `auto` usage in our style guide. I personally think `auto` should only be used if the type is immediately obvious from the surrounding code, and it's saving redundant and verbose keystrokes. ",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-15T09:08:11Z",
      "diff_hunk" : "@@ -1754,7 +1757,10 @@ void static ProcessGetData(CNode& pfrom, const CChainParams& chainparams, CConnm\n {\n     AssertLockNotHeld(cs_main);\n \n-    std::deque<CInv>::iterator it = pfrom.vRecvGetData.begin();\n+    PeerRef peer = GetPeerRef(pfrom.GetId());\n+    if (peer == nullptr) return;\n+\n+    std::deque<CInv>::iterator it = peer->vRecvGetData.begin();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r505379547",
      "id" : 505379547,
      "in_reply_to_id" : 504758581,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM3OTU0Nw==",
      "original_commit_id" : "2d9f2fca43aadcdda4d644cddab36dca88b40b97",
      "original_line" : 1763,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 509171915,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-15T09:08:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/505379547",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r505388279"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/505388279"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> We don't have guidance about `auto` usage in our style guide.\r\n\r\nYes. And I think we should have it.\r\n\r\n> I personally think `auto` should only be used if the type is immediately obvious from the surrounding code, and it's saving redundant and verbose keystrokes.\r\n\r\nhttps://herbsutter.com/2013/08/12/gotw-94-solution-aaa-style-almost-always-auto/",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-15T09:19:50Z",
      "diff_hunk" : "@@ -1754,7 +1757,10 @@ void static ProcessGetData(CNode& pfrom, const CChainParams& chainparams, CConnm\n {\n     AssertLockNotHeld(cs_main);\n \n-    std::deque<CInv>::iterator it = pfrom.vRecvGetData.begin();\n+    PeerRef peer = GetPeerRef(pfrom.GetId());\n+    if (peer == nullptr) return;\n+\n+    std::deque<CInv>::iterator it = peer->vRecvGetData.begin();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r505388279",
      "id" : 505388279,
      "in_reply_to_id" : 504758581,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM4ODI3OQ==",
      "original_commit_id" : "2d9f2fca43aadcdda4d644cddab36dca88b40b97",
      "original_line" : 1763,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 509181490,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-15T09:19:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/505388279",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r505431669"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/505431669"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks @hebasto. I hadn't seen that particular blog post before, but I am familiar with the arguments for and against `auto`. Scott Meyers also dedicates a chapter to it in Exceptional Modern C++.\r\n\r\nHere, I think it's useful to explicitly name the type, since `CInv` is part of the interface. Sure, we could switch out `std::deque` for another container at some point, but to know what `it->IsGenTxMsg()` is doing a few lines further down, you need to know that `it` is an iterator over some container of `CInv`s. I'd much rather the code told me that explicitly than having to go find out what `m_getdata_requests` is from somewhere else.",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-15T10:23:52Z",
      "diff_hunk" : "@@ -1754,7 +1757,10 @@ void static ProcessGetData(CNode& pfrom, const CChainParams& chainparams, CConnm\n {\n     AssertLockNotHeld(cs_main);\n \n-    std::deque<CInv>::iterator it = pfrom.vRecvGetData.begin();\n+    PeerRef peer = GetPeerRef(pfrom.GetId());\n+    if (peer == nullptr) return;\n+\n+    std::deque<CInv>::iterator it = peer->vRecvGetData.begin();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r505431669",
      "id" : 505431669,
      "in_reply_to_id" : 504758581,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQzMTY2OQ==",
      "original_commit_id" : "2d9f2fca43aadcdda4d644cddab36dca88b40b97",
      "original_line" : 1763,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 509232748,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-15T10:23:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/505431669",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r505435886"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/505435886"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ok.",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-15T10:30:56Z",
      "diff_hunk" : "@@ -1754,7 +1757,10 @@ void static ProcessGetData(CNode& pfrom, const CChainParams& chainparams, CConnm\n {\n     AssertLockNotHeld(cs_main);\n \n-    std::deque<CInv>::iterator it = pfrom.vRecvGetData.begin();\n+    PeerRef peer = GetPeerRef(pfrom.GetId());\n+    if (peer == nullptr) return;\n+\n+    std::deque<CInv>::iterator it = peer->vRecvGetData.begin();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r505435886",
      "id" : 505435886,
      "in_reply_to_id" : 504758581,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQzNTg4Ng==",
      "original_commit_id" : "2d9f2fca43aadcdda4d644cddab36dca88b40b97",
      "original_line" : 1763,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 509237940,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-15T10:30:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/505435886",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r505779994"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/505779994"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That is a very interesting post! I'm not sure I entirely agree with his reasoning against the readability argument, but perhaps we could debate that somewhere else :) I think this could go either way, and I prefer having the type explicit.",
      "commit_id" : "da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde",
      "created_at" : "2020-10-15T19:14:00Z",
      "diff_hunk" : "@@ -1754,7 +1757,10 @@ void static ProcessGetData(CNode& pfrom, const CChainParams& chainparams, CConnm\n {\n     AssertLockNotHeld(cs_main);\n \n-    std::deque<CInv>::iterator it = pfrom.vRecvGetData.begin();\n+    PeerRef peer = GetPeerRef(pfrom.GetId());\n+    if (peer == nullptr) return;\n+\n+    std::deque<CInv>::iterator it = peer->vRecvGetData.begin();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#discussion_r505779994",
      "id" : 505779994,
      "in_reply_to_id" : 504758581,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc3OTk5NA==",
      "original_commit_id" : "2d9f2fca43aadcdda4d644cddab36dca88b40b97",
      "original_line" : 1763,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 509691019,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19911",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-15T19:14:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/505779994",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think all comments have been addressed except the remaining review comments which I can summarize to the following nits:\r\n\r\n1) change `if (peer == nullptr)` to `if (!peer)` in the places where I add a new `nullptr` check\r\n2) fix up an existing if without braces: https://github.com/bitcoin/bitcoin/pull/19911#discussion_r504759682 in a line I touch\r\n\r\nI don't think these are important, and I already have one ACK on the code so I'd prefer not to change them. However, if others disagree, I can do so.",
      "created_at" : "2020-10-15T19:19:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#issuecomment-709539465",
      "id" : 709539465,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19911",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwOTUzOTQ2NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-15T19:19:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/709539465",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/177646?v=4",
         "events_url" : "https://api.github.com/users/narula/events{/privacy}",
         "followers_url" : "https://api.github.com/users/narula/followers",
         "following_url" : "https://api.github.com/users/narula/following{/other_user}",
         "gists_url" : "https://api.github.com/users/narula/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/narula",
         "id" : 177646,
         "login" : "narula",
         "node_id" : "MDQ6VXNlcjE3NzY0Ng==",
         "organizations_url" : "https://api.github.com/users/narula/orgs",
         "received_events_url" : "https://api.github.com/users/narula/received_events",
         "repos_url" : "https://api.github.com/users/narula/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/narula/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/narula/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/narula"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "review ACK da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde ð¬\r\n\r\n<details><summary>Show signature and timestamp</summary>\r\n\r\nSignature:\r\n\r\n```\r\n-----BEGIN PGP SIGNED MESSAGE-----\r\nHash: SHA512\r\n\r\nreview ACK da0988daf1d665a4644ad3f1ddf3f8a8bdd88cde ð¬\r\n-----BEGIN PGP SIGNATURE-----\r\n\r\niQGzBAEBCgAdFiEE+rVPoUahrI9sLGYTzit1aX5ppUgFAlwqrYAACgkQzit1aX5p\r\npUh3Kwv/Z92YkezB0vKDt8zCSK2kekyViu2esvi5EQIv7t59sPpc1lksTFvC75lX\r\nrmr8hVvOHb6l1pMTGEXLJHVgamn4B/xd5jnJCEGcI9GR1bamL6wRlSKLZEyhnVjV\r\nSiyp7qPFIQPTQxUsUhgJxeLqqYWV1TLmxRvekBnwtfksqpHTBR6icrBsQpg7Nu7Q\r\nf9uiggfUZq3UrnyzF9dJqYUG5CyGiymnRH9YUE89W+7cg/L7RllSQh6K5lrbeb9b\r\nWwAbJL64iDR3Npv4d9bwIQkZNgadyZA8yYw/kskriD9Gt+Qxg7V0VnBbExhve3mp\r\nvc2i6mpPqgDS0n4a+tv3pB7g4zvv9w8kLNt4wXiBIETVdbfH5acdDw3GvTOAhQBl\r\nNwu0KhCxCkXtWDP56vJo2D0V8WsaHMQv53DUAjsAKHot7c0ihXd+V3zhwUHhJXEP\r\nd1BHU3W+II9DB0c2e9gXyiS/ZHWbEhzwvtdj2pVAtETJG6dt8gM9aEmdzh7Lnfga\r\nQWbax8bo\r\n=//W2\r\n-----END PGP SIGNATURE-----\r\n```\r\n\r\n[Timestamp of file with hash `350e455a9cfde318c3ab04c709fac25fca0a0b8205b4cfd5c3a0765e95f4dff4  -`](https://opentimestamps.org/info/?004f70656e54696d657374616d7073000050726f6f6600bf89e2e884e892940108350e455a9cfde318c3ab04c709fac25fca0a0b8205b4cfd5c3a0765e95f4dff4f0108a65cb16c9b0c417eb5c7ddb3b913e8f08fff01013365521c5ff7b210251f58646d396d908f020fedf6d58a34cfe59ead72c640db1970626c70b3547027d547292211118e08a6f08f1045f8b1904f008e14c74031e8915e10083dfe30d2ef90c8e292868747470733a2f2f66696e6e65792e63616c656e6461722e657465726e69747977616c6c2e636f6dfff0102134509a7bc59e36cf5bf95b5fd7c12f08f020e3d2bd7b88e92e5b536d050ac5ffc040baaadc5c92a67d77120fd4229471decc08f1045f8b1902f008e352791dc9dbec720083dfe30d2ef90c8e2e2d68747470733a2f2f616c6963652e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267fff010262a9f94d2d60a327f2d7df07623d31308f1045f8b1902f0087ad9b4f054271fc50083dfe30d2ef90c8e232268747470733a2f2f6274632e63616c656e6461722e636174616c6c6178792e636f6df010a2a0682b72a70587f505e1028c82150908f020762cd581e83d8e88f794a46cd0a4960ea161133aae641e761dd54852f4d24aa408f1045f8b1902f008f76918ad4500e30f0083dfe30d2ef90c8e2c2b68747470733a2f2f626f622e6274632e63616c656e6461722e6f70656e74696d657374616d70732e6f7267)\r\n\r\n</details>\r\n",
      "created_at" : "2020-10-17T16:17:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19911#issuecomment-711038096",
      "id" : 711038096,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19911",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcxMTAzODA5Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-17T16:17:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/711038096",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
