[
   {
      "author_association" : "MEMBER",
      "body" : "@hebasto this is an example of stuff that I think we can do before moving locks around. The first and second commits refactor `ReattemptInitialBroadcast` to drop unlock/lock in each iteration.",
      "created_at" : "2020-09-08T14:04:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19917#issuecomment-688897981",
      "id" : 688897981,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19917",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4ODg5Nzk4MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-08T14:04:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688897981",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@vasild @ryanofsky your comment here would be nice too.",
      "created_at" : "2020-09-08T14:04:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19917#issuecomment-688898389",
      "id" : 688898389,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19917",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4ODg5ODM4OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-08T14:04:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688898389",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Why draft?",
      "created_at" : "2020-09-08T15:50:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19917#issuecomment-688969167",
      "id" : 688969167,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19917",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4ODk2OTE2Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-08T15:50:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688969167",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Yeah I don't mind setting it ready for review, the goal was to show an example rather than adding noise to your PR.",
      "created_at" : "2020-09-08T15:52:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19917#issuecomment-688970636",
      "id" : 688970636,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19917",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4ODk3MDYzNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-08T15:52:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688970636",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485027956"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485027956"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This approach is also a small step towards removing the lock from `GetUnbroadcastTxs` and `exists`.",
      "commit_id" : "dde441c11a07b9ff72dbcfda896c61adf33ae228",
      "created_at" : "2020-09-08T15:54:57Z",
      "diff_hunk" : "@@ -889,15 +889,24 @@ void PeerManager::InitializeNode(CNode *pnode) {\n \n void PeerManager::ReattemptInitialBroadcast(CScheduler& scheduler) const\n {\n-    std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n-\n-    for (const auto& elem : unbroadcast_txids) {\n-        // Sanity check: all unbroadcast txns should exist in the mempool\n-        if (m_mempool.exists(elem.first)) {\n-            LOCK(cs_main);\n+    std::vector<std::pair<uint256, uint256>> relay_transactions;\n+    {\n+        LOCK(m_mempool.cs);\n+        std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485027956",
      "id" : 485027956,
      "line" : 895,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAyNzk1Ng==",
      "original_commit_id" : "8f4307c975642ab0dfbc76e7165318a6e8791a5f",
      "original_line" : 895,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 13,
      "pull_request_review_id" : 484280398,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-08T21:06:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485027956",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Yeah I don't mind setting it ready for review, the goal was to show an example rather than adding noise to your PR.\r\n\r\nI'll be happy to postpone #19872 until this PR is reviewed and merged :)",
      "created_at" : "2020-09-08T15:55:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19917#issuecomment-688972446",
      "id" : 688972446,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19917",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4ODk3MjQ0Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-08T15:55:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688972446",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485047637"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485047637"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8f30df2002f00b7613e602bc576285974d8f2bcf\r\nDoes this approach decrease concurrency wrt to `::cs_main` uninterruptible locking?",
      "commit_id" : "dde441c11a07b9ff72dbcfda896c61adf33ae228",
      "created_at" : "2020-09-08T16:25:42Z",
      "diff_hunk" : "@@ -889,17 +889,24 @@ void PeerManager::InitializeNode(CNode *pnode) {\n \n void PeerManager::ReattemptInitialBroadcast(CScheduler& scheduler) const\n {\n+    std::vector<std::pair<uint256, uint256>> relay_transactions;\n     std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n \n+    relay_transactions.reserve(unbroadcast_txids.size());\n     for (const auto& elem : unbroadcast_txids) {\n         // Sanity check: all unbroadcast txns should exist in the mempool\n         if (m_mempool.exists(elem.first)) {\n-            LOCK(cs_main);\n-            RelayTransaction(elem.first, elem.second, m_connman);\n+            relay_transactions.push_back(elem);\n         } else {\n             m_mempool.RemoveUnbroadcastTx(elem.first, true);\n         }\n     }\n+    {\n+        LOCK(cs_main);\n+        for (const auto& elem : relay_transactions) {\n+            RelayTransaction(elem.first, elem.second, m_connman);\n+        }\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485047637",
      "id" : 485047637,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA0NzYzNw==",
      "original_commit_id" : "8f30df2002f00b7613e602bc576285974d8f2bcf",
      "original_line" : 909,
      "original_position" : 23,
      "original_start_line" : 904,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 484305574,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-09-08T21:06:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485047637",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485091674"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485091674"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`RelayTransaction` doesn't hold `cs_main` that long.",
      "commit_id" : "dde441c11a07b9ff72dbcfda896c61adf33ae228",
      "created_at" : "2020-09-08T17:43:17Z",
      "diff_hunk" : "@@ -889,17 +889,24 @@ void PeerManager::InitializeNode(CNode *pnode) {\n \n void PeerManager::ReattemptInitialBroadcast(CScheduler& scheduler) const\n {\n+    std::vector<std::pair<uint256, uint256>> relay_transactions;\n     std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n \n+    relay_transactions.reserve(unbroadcast_txids.size());\n     for (const auto& elem : unbroadcast_txids) {\n         // Sanity check: all unbroadcast txns should exist in the mempool\n         if (m_mempool.exists(elem.first)) {\n-            LOCK(cs_main);\n-            RelayTransaction(elem.first, elem.second, m_connman);\n+            relay_transactions.push_back(elem);\n         } else {\n             m_mempool.RemoveUnbroadcastTx(elem.first, true);\n         }\n     }\n+    {\n+        LOCK(cs_main);\n+        for (const auto& elem : relay_transactions) {\n+            RelayTransaction(elem.first, elem.second, m_connman);\n+        }\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485091674",
      "id" : 485091674,
      "in_reply_to_id" : 485047637,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA5MTY3NA==",
      "original_commit_id" : "8f30df2002f00b7613e602bc576285974d8f2bcf",
      "original_line" : 909,
      "original_position" : 23,
      "original_start_line" : 904,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 484361774,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2020-09-08T21:06:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485091674",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.",
      "created_at" : "2020-09-08T17:55:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19917#issuecomment-689040546",
      "id" : 689040546,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19917",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4OTA0MDU0Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-08T17:55:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/689040546",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "The changes in `PeerManager::ReattemptInitialBroadcast()` will execute `CTxMemPool::GetUnbroadcastTxs()` and `CTxMemPool::exists()` under `CTxMemPool::cs` whereas previously they were not called under this mutex. Both methods acquire the mutex themselves. So this adds more recursive mutex locks.\r\n\r\nWhat is the purpose of this patch? There is no description and commit messages are a bit scarce, missing answer to \"Why are we doing this?\".",
      "created_at" : "2020-09-08T19:13:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19917#issuecomment-689081363",
      "id" : 689081363,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19917",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4OTA4MTM2Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-08T19:13:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/689081363",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@vasild sure I can detail the intention. See https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485027956.",
      "created_at" : "2020-09-08T19:28:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19917#issuecomment-689087764",
      "id" : 689087764,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19917",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4OTA4Nzc2NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-08T19:28:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/689087764",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485197268"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485197268"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done in fb2dca415f6ac74d79292296831ccc33c485230b and dde441c11a07b9ff72dbcfda896c61adf33ae228.",
      "commit_id" : "dde441c11a07b9ff72dbcfda896c61adf33ae228",
      "created_at" : "2020-09-08T21:08:48Z",
      "diff_hunk" : "@@ -889,15 +889,24 @@ void PeerManager::InitializeNode(CNode *pnode) {\n \n void PeerManager::ReattemptInitialBroadcast(CScheduler& scheduler) const\n {\n-    std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n-\n-    for (const auto& elem : unbroadcast_txids) {\n-        // Sanity check: all unbroadcast txns should exist in the mempool\n-        if (m_mempool.exists(elem.first)) {\n-            LOCK(cs_main);\n+    std::vector<std::pair<uint256, uint256>> relay_transactions;\n+    {\n+        LOCK(m_mempool.cs);\n+        std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485197268",
      "id" : 485197268,
      "in_reply_to_id" : 485027956,
      "line" : 895,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE5NzI2OA==",
      "original_commit_id" : "8f4307c975642ab0dfbc76e7165318a6e8791a5f",
      "original_line" : 895,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 13,
      "pull_request_review_id" : 484494508,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-08T21:08:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485197268",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485381915"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485381915"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "missing `return`?",
      "commit_id" : "dde441c11a07b9ff72dbcfda896c61adf33ae228",
      "created_at" : "2020-09-09T06:59:49Z",
      "diff_hunk" : "@@ -421,7 +421,7 @@ void CTxMemPool::removeUnchecked(txiter it, MemPoolRemovalReason reason)\n     for (const CTxIn& txin : it->GetTx().vin)\n         mapNextTx.erase(txin.prevout);\n \n-    RemoveUnbroadcastTx(hash, true /* add logging because unchecked */ );\n+    WITH_LOCK(cs, RemoveUnbroadcastTx(hash, true /* add logging because unchecked */ ));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485381915",
      "id" : 485381915,
      "line" : 424,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM4MTkxNQ==",
      "original_commit_id" : "dde441c11a07b9ff72dbcfda896c61adf33ae228",
      "original_line" : 424,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 5,
      "pull_request_review_id" : 484713021,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-09T08:08:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485381915",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@promag To fix TSan errors consider comparing dde441c11a07b9ff72dbcfda896c61adf33ae228 with 049d8c54f4f14996c347d099bbad855c0aa74bb6.",
      "created_at" : "2020-09-09T07:19:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19917#issuecomment-689360687",
      "id" : 689360687,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19917",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY4OTM2MDY4Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-09T07:19:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/689360687",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485418310"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485418310"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This can be simplified to:\r\n\r\n```cpp\r\nvoid PeerManager::ReattemptInitialBroadcast(CScheduler& scheduler) const\r\n{\r\n    for (const auto& elem : WITH_LOCK(m_mempool.cs, return m_mempool.GetUnbroadcastTxs())) {\r\n        LOCK(cs_main);\r\n        RelayTransaction(elem.first, elem.second, m_connman);\r\n    } \r\n\r\n    // Schedule next run for 10-15 minutes in the future.\r\n    ...\r\n}\r\n```\r\n\r\nBecause `m_mempool.exists()` will always return `true` for a tx returned by `m_mempool.GetUnbroadcastTxs()` if we don't release `m_mempool.cs` between the two calls.\r\n\r\nAlso, the tx could be removed after we release `m_mempool.cs` and before we call `RelayTransaction()` and this is ok and is [handled just fine](https://github.com/bitcoin/bitcoin/blob/564e1ab/src/net_processing.cpp#L4429).\r\n\r\ncc @gzhao408",
      "commit_id" : "dde441c11a07b9ff72dbcfda896c61adf33ae228",
      "created_at" : "2020-09-09T08:06:33Z",
      "diff_hunk" : "@@ -889,15 +889,24 @@ void PeerManager::InitializeNode(CNode *pnode) {\n \n void PeerManager::ReattemptInitialBroadcast(CScheduler& scheduler) const\n {\n-    std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n-\n-    for (const auto& elem : unbroadcast_txids) {\n-        // Sanity check: all unbroadcast txns should exist in the mempool\n-        if (m_mempool.exists(elem.first)) {\n-            LOCK(cs_main);\n+    std::vector<std::pair<uint256, uint256>> relay_transactions;\n+    {\n+        LOCK(m_mempool.cs);\n+        std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n+        relay_transactions.reserve(unbroadcast_txids.size());\n+        for (const auto& elem : unbroadcast_txids) {\n+            // Sanity check: all unbroadcast txns should exist in the mempool\n+            if (m_mempool.exists(elem.first)) {\n+                relay_transactions.push_back(elem);\n+            } else {\n+                m_mempool.RemoveUnbroadcastTx(elem.first, true);\n+            }\n+        }\n+    }\n+    {\n+        LOCK(cs_main);\n+        for (const auto& elem : relay_transactions) {\n             RelayTransaction(elem.first, elem.second, m_connman);\n-        } else {\n-            m_mempool.RemoveUnbroadcastTx(elem.first, true);\n         }\n     }\n ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485418310",
      "id" : 485418310,
      "line" : 912,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQxODMxMA==",
      "original_commit_id" : "dde441c11a07b9ff72dbcfda896c61adf33ae228",
      "original_line" : 912,
      "original_position" : 32,
      "original_start_line" : 890,
      "path" : "src/net_processing.cpp",
      "position" : 32,
      "pull_request_review_id" : 484713021,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917",
      "side" : "RIGHT",
      "start_line" : 890,
      "start_side" : "RIGHT",
      "updated_at" : "2020-09-09T08:08:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485418310",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485422236"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485422236"
         }
      },
      "author_association" : "MEMBER",
      "body" : "But is it really necessary to have `cs_main` lock in each iteration?",
      "commit_id" : "dde441c11a07b9ff72dbcfda896c61adf33ae228",
      "created_at" : "2020-09-09T08:13:00Z",
      "diff_hunk" : "@@ -889,15 +889,24 @@ void PeerManager::InitializeNode(CNode *pnode) {\n \n void PeerManager::ReattemptInitialBroadcast(CScheduler& scheduler) const\n {\n-    std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n-\n-    for (const auto& elem : unbroadcast_txids) {\n-        // Sanity check: all unbroadcast txns should exist in the mempool\n-        if (m_mempool.exists(elem.first)) {\n-            LOCK(cs_main);\n+    std::vector<std::pair<uint256, uint256>> relay_transactions;\n+    {\n+        LOCK(m_mempool.cs);\n+        std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n+        relay_transactions.reserve(unbroadcast_txids.size());\n+        for (const auto& elem : unbroadcast_txids) {\n+            // Sanity check: all unbroadcast txns should exist in the mempool\n+            if (m_mempool.exists(elem.first)) {\n+                relay_transactions.push_back(elem);\n+            } else {\n+                m_mempool.RemoveUnbroadcastTx(elem.first, true);\n+            }\n+        }\n+    }\n+    {\n+        LOCK(cs_main);\n+        for (const auto& elem : relay_transactions) {\n             RelayTransaction(elem.first, elem.second, m_connman);\n-        } else {\n-            m_mempool.RemoveUnbroadcastTx(elem.first, true);\n         }\n     }\n ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485422236",
      "id" : 485422236,
      "in_reply_to_id" : 485418310,
      "line" : 912,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQyMjIzNg==",
      "original_commit_id" : "dde441c11a07b9ff72dbcfda896c61adf33ae228",
      "original_line" : 912,
      "original_position" : 32,
      "original_start_line" : 890,
      "path" : "src/net_processing.cpp",
      "position" : 32,
      "pull_request_review_id" : 484764315,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917",
      "side" : "RIGHT",
      "start_line" : 890,
      "start_side" : "RIGHT",
      "updated_at" : "2020-09-09T08:13:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485422236",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485447727"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485447727"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Since it was locked in each iteration before this PR, the question should rather be \"If we move `LOCK(cs_main)` before the loop, why would we do that?\"\r\n\r\nThe frequent lock/unlock allows other threads to proceed. I don't see a reason to change it.",
      "commit_id" : "dde441c11a07b9ff72dbcfda896c61adf33ae228",
      "created_at" : "2020-09-09T08:51:49Z",
      "diff_hunk" : "@@ -889,15 +889,24 @@ void PeerManager::InitializeNode(CNode *pnode) {\n \n void PeerManager::ReattemptInitialBroadcast(CScheduler& scheduler) const\n {\n-    std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n-\n-    for (const auto& elem : unbroadcast_txids) {\n-        // Sanity check: all unbroadcast txns should exist in the mempool\n-        if (m_mempool.exists(elem.first)) {\n-            LOCK(cs_main);\n+    std::vector<std::pair<uint256, uint256>> relay_transactions;\n+    {\n+        LOCK(m_mempool.cs);\n+        std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n+        relay_transactions.reserve(unbroadcast_txids.size());\n+        for (const auto& elem : unbroadcast_txids) {\n+            // Sanity check: all unbroadcast txns should exist in the mempool\n+            if (m_mempool.exists(elem.first)) {\n+                relay_transactions.push_back(elem);\n+            } else {\n+                m_mempool.RemoveUnbroadcastTx(elem.first, true);\n+            }\n+        }\n+    }\n+    {\n+        LOCK(cs_main);\n+        for (const auto& elem : relay_transactions) {\n             RelayTransaction(elem.first, elem.second, m_connman);\n-        } else {\n-            m_mempool.RemoveUnbroadcastTx(elem.first, true);\n         }\n     }\n ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485447727",
      "id" : 485447727,
      "in_reply_to_id" : 485418310,
      "line" : 912,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ0NzcyNw==",
      "original_commit_id" : "dde441c11a07b9ff72dbcfda896c61adf33ae228",
      "original_line" : 912,
      "original_position" : 32,
      "original_start_line" : 890,
      "path" : "src/net_processing.cpp",
      "position" : 32,
      "pull_request_review_id" : 484796398,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917",
      "side" : "RIGHT",
      "start_line" : 890,
      "start_side" : "RIGHT",
      "updated_at" : "2020-09-09T08:51:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485447727",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r486171314"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486171314"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> The frequent lock/unlock allows other threads to proceed. I don't see a reason to change it.\r\n\r\nAgree (https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485047637).",
      "commit_id" : "dde441c11a07b9ff72dbcfda896c61adf33ae228",
      "created_at" : "2020-09-10T08:47:10Z",
      "diff_hunk" : "@@ -889,15 +889,24 @@ void PeerManager::InitializeNode(CNode *pnode) {\n \n void PeerManager::ReattemptInitialBroadcast(CScheduler& scheduler) const\n {\n-    std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n-\n-    for (const auto& elem : unbroadcast_txids) {\n-        // Sanity check: all unbroadcast txns should exist in the mempool\n-        if (m_mempool.exists(elem.first)) {\n-            LOCK(cs_main);\n+    std::vector<std::pair<uint256, uint256>> relay_transactions;\n+    {\n+        LOCK(m_mempool.cs);\n+        std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n+        relay_transactions.reserve(unbroadcast_txids.size());\n+        for (const auto& elem : unbroadcast_txids) {\n+            // Sanity check: all unbroadcast txns should exist in the mempool\n+            if (m_mempool.exists(elem.first)) {\n+                relay_transactions.push_back(elem);\n+            } else {\n+                m_mempool.RemoveUnbroadcastTx(elem.first, true);\n+            }\n+        }\n+    }\n+    {\n+        LOCK(cs_main);\n+        for (const auto& elem : relay_transactions) {\n             RelayTransaction(elem.first, elem.second, m_connman);\n-        } else {\n-            m_mempool.RemoveUnbroadcastTx(elem.first, true);\n         }\n     }\n ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r486171314",
      "id" : 486171314,
      "in_reply_to_id" : 485418310,
      "line" : 912,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE3MTMxNA==",
      "original_commit_id" : "dde441c11a07b9ff72dbcfda896c61adf33ae228",
      "original_line" : 912,
      "original_position" : 32,
      "original_start_line" : 890,
      "path" : "src/net_processing.cpp",
      "position" : 32,
      "pull_request_review_id" : 485716863,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917",
      "side" : "RIGHT",
      "start_line" : 890,
      "start_side" : "RIGHT",
      "updated_at" : "2020-09-10T08:47:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486171314",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r486364727"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486364727"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@vasild I don't agree with that. Other threads can proceed but the current thread will wait unnecessarily in each iteration for the lock and as such other things will be delayed, not mentioning the mutex overhead. See https://stackoverflow.com/a/3652428.\r\n\r\nIn this case `RelayTransaction` is pretty quick, nothing that can potentially cause a big lock on `cs_main`.",
      "commit_id" : "dde441c11a07b9ff72dbcfda896c61adf33ae228",
      "created_at" : "2020-09-10T13:57:04Z",
      "diff_hunk" : "@@ -889,15 +889,24 @@ void PeerManager::InitializeNode(CNode *pnode) {\n \n void PeerManager::ReattemptInitialBroadcast(CScheduler& scheduler) const\n {\n-    std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n-\n-    for (const auto& elem : unbroadcast_txids) {\n-        // Sanity check: all unbroadcast txns should exist in the mempool\n-        if (m_mempool.exists(elem.first)) {\n-            LOCK(cs_main);\n+    std::vector<std::pair<uint256, uint256>> relay_transactions;\n+    {\n+        LOCK(m_mempool.cs);\n+        std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n+        relay_transactions.reserve(unbroadcast_txids.size());\n+        for (const auto& elem : unbroadcast_txids) {\n+            // Sanity check: all unbroadcast txns should exist in the mempool\n+            if (m_mempool.exists(elem.first)) {\n+                relay_transactions.push_back(elem);\n+            } else {\n+                m_mempool.RemoveUnbroadcastTx(elem.first, true);\n+            }\n+        }\n+    }\n+    {\n+        LOCK(cs_main);\n+        for (const auto& elem : relay_transactions) {\n             RelayTransaction(elem.first, elem.second, m_connman);\n-        } else {\n-            m_mempool.RemoveUnbroadcastTx(elem.first, true);\n         }\n     }\n ",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r486364727",
      "id" : 486364727,
      "in_reply_to_id" : 485418310,
      "line" : 912,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM2NDcyNw==",
      "original_commit_id" : "dde441c11a07b9ff72dbcfda896c61adf33ae228",
      "original_line" : 912,
      "original_position" : 32,
      "original_start_line" : 890,
      "path" : "src/net_processing.cpp",
      "position" : 32,
      "pull_request_review_id" : 485963211,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917",
      "side" : "RIGHT",
      "start_line" : 890,
      "start_side" : "RIGHT",
      "updated_at" : "2020-09-10T13:57:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486364727",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-16T00:14:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19917#issuecomment-693095452",
      "id" : 693095452,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19917",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5MzA5NTQ1Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-16T00:14:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/693095452",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebase hell.",
      "created_at" : "2020-11-07T11:47:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/19917#issuecomment-723435932",
      "id" : 723435932,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19917",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcyMzQzNTkzMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-11-07T11:47:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/723435932",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "node_id" : "MDQ6VXNlcjM1MzQ1MjQ=",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   }
]
