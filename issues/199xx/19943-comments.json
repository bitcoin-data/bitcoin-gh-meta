[
   {
      "author_association" : "MEMBER",
      "body" : "What I think is happening here:\r\n1. Node2 sets `g_relay_txes=false` because of `blocksonly` at the startup\r\n2. Node2 sends a `VERSION` message with `fRelay=false` because it's evaluated as `::g_relay_txes && pnode.m_tx_relay != nullptr` (see above).\r\n3. When got `VERSION` message, Node3 sets `pfrom.m_tx_relay->fRelayTxes=false` for Node2 according to `fRelay`\r\n\r\nBased on this condition, Node3 would not announce transactions to Node2:\r\n`if (!pto->m_tx_relay->fRelayTxes) pto->m_tx_relay->setInventoryTxToSend.clear();`",
      "created_at" : "2020-09-16T07:58:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19943#issuecomment-693241795",
      "id" : 693241795,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19943",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5MzI0MTc5NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-16T08:19:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/693241795",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Thanks for the analysis!\r\nShouldn't the `forcerelay` whitelist override `pto->m_tx_relay->fRelayTxes` and set it to `true`?\r\nNote that I opened connections in both directions (Node2 -> Node3 and Node3 -> Node2) since whitelists seem to apply only to inbound connections.",
      "created_at" : "2020-09-16T08:21:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19943#issuecomment-693253348",
      "id" : 693253348,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19943",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5MzI1MzM0OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-16T08:21:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/693253348",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/31281497?v=4",
         "events_url" : "https://api.github.com/users/t-bast/events{/privacy}",
         "followers_url" : "https://api.github.com/users/t-bast/followers",
         "following_url" : "https://api.github.com/users/t-bast/following{/other_user}",
         "gists_url" : "https://api.github.com/users/t-bast/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/t-bast",
         "id" : 31281497,
         "login" : "t-bast",
         "node_id" : "MDQ6VXNlcjMxMjgxNDk3",
         "organizations_url" : "https://api.github.com/users/t-bast/orgs",
         "received_events_url" : "https://api.github.com/users/t-bast/received_events",
         "repos_url" : "https://api.github.com/users/t-bast/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/t-bast/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/t-bast/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/t-bast"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Shouldn't the forcerelay whitelist override pto->m_tx_relay->fRelayTxes and set it to true?\r\n\r\nThe documentation of `forcerelay` says: \"relay transactions even if the transactions were already in the mempool\", which probably means it has nothing to do with blocks-only.\r\nOverriding can't happen, because this flag is set on the other side of the connection (not a blocks-only node), and that node simply isn't aware of whether it's whitelisted or not. It could have overriden `fRelay=false` in the `VERSION` message, but it doesn't.\r\n\r\nI looked at the test #18530.\r\nThe difference is that nodes *connecting* to blocks-only peer are mininodes. When they receive blocks-only node's version message, they don't apply much handling logic (like what I described in the previous message), so they keep sending transactions to a blocks-only node.\r\nReal nodes do apply it.\r\n\r\nSo, this test shows that, for example, if a *modified bitcoin node* (or another implementation) would send transactions to a blocks-only Bitcoin Core node, they would be relayed if conditions are met (`relay` permission is set).\r\n\r\nCurrent Bitcoin Core nodes don't do that. Whether Bitcoin Core nodes should I'm not so sure.\r\nAt least we should add a comment to the functional test #18530 I guess.\r\n\r\nFor now, you can e.g. remove this condition ` if (!pto->m_tx_relay->fRelayTxes) pto->m_tx_relay->setInventoryTxToSend.clear();` (in Node3), recompile, and perhaps it would work for you :)\r\nYou can also try sending a FILTERCLEAR message from Node2 to Node3 as another workaround, as it sets `pfrom.m_tx_relay->fRelayTxes=true` \r\nI don't 100% guarantee this works :)\r\n",
      "created_at" : "2020-09-16T09:55:27Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19943#issuecomment-693301620",
      "id" : 693301620,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19943",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5MzMwMTYyMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-16T09:55:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/693301620",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "\"addnode\" on both sides doesn't make any difference. Connections are bidirectional, and they would have the same behavior (sending same `VERSION` messages etc.) I tried to explain above.",
      "created_at" : "2020-09-16T09:56:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19943#issuecomment-693302322",
      "id" : 693302322,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19943",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5MzMwMjMyMg==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-16T09:56:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/693302322",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Awesome, thanks for your detailed answer, that makes a lot of sense.\r\nI agree that maybe adding a comment to the test would be helpful for newcomers :)\r\nI'll try your suggestions, that's definitely acceptable solutions for my use-case, I'll let you know if that works.",
      "created_at" : "2020-09-16T10:05:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19943#issuecomment-693306780",
      "id" : 693306780,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19943",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5MzMwNjc4MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-16T10:05:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/693306780",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/31281497?v=4",
         "events_url" : "https://api.github.com/users/t-bast/events{/privacy}",
         "followers_url" : "https://api.github.com/users/t-bast/followers",
         "following_url" : "https://api.github.com/users/t-bast/following{/other_user}",
         "gists_url" : "https://api.github.com/users/t-bast/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/t-bast",
         "id" : 31281497,
         "login" : "t-bast",
         "node_id" : "MDQ6VXNlcjMxMjgxNDk3",
         "organizations_url" : "https://api.github.com/users/t-bast/orgs",
         "received_events_url" : "https://api.github.com/users/t-bast/received_events",
         "repos_url" : "https://api.github.com/users/t-bast/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/t-bast/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/t-bast/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/t-bast"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "I've tested both solutions and they work fine.\r\nThanks for the help!",
      "created_at" : "2020-09-16T12:14:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19943#issuecomment-693365878",
      "id" : 693365878,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19943",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5MzM2NTg3OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-16T12:14:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/693365878",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/31281497?v=4",
         "events_url" : "https://api.github.com/users/t-bast/events{/privacy}",
         "followers_url" : "https://api.github.com/users/t-bast/followers",
         "following_url" : "https://api.github.com/users/t-bast/following{/other_user}",
         "gists_url" : "https://api.github.com/users/t-bast/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/t-bast",
         "id" : 31281497,
         "login" : "t-bast",
         "node_id" : "MDQ6VXNlcjMxMjgxNDk3",
         "organizations_url" : "https://api.github.com/users/t-bast/orgs",
         "received_events_url" : "https://api.github.com/users/t-bast/received_events",
         "repos_url" : "https://api.github.com/users/t-bast/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/t-bast/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/t-bast/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/t-bast"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I agree that maybe adding a comment to the test would be helpful for newcomers :)\r\n\r\nMaybe you could open a PR to add a comment to the test if you can spare the time @t-bast ;)",
      "created_at" : "2020-09-16T12:22:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19943#issuecomment-693369437",
      "id" : 693369437,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19943",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5MzM2OTQzNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-16T12:22:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/693369437",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/16323900?v=4",
         "events_url" : "https://api.github.com/users/michaelfolkson/events{/privacy}",
         "followers_url" : "https://api.github.com/users/michaelfolkson/followers",
         "following_url" : "https://api.github.com/users/michaelfolkson/following{/other_user}",
         "gists_url" : "https://api.github.com/users/michaelfolkson/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/michaelfolkson",
         "id" : 16323900,
         "login" : "michaelfolkson",
         "node_id" : "MDQ6VXNlcjE2MzIzOTAw",
         "organizations_url" : "https://api.github.com/users/michaelfolkson/orgs",
         "received_events_url" : "https://api.github.com/users/michaelfolkson/received_events",
         "repos_url" : "https://api.github.com/users/michaelfolkson/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/michaelfolkson/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/michaelfolkson/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/michaelfolkson"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Good idea! I can definitely spare the time, thanks for reminding me!",
      "created_at" : "2020-09-16T12:24:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/19943#issuecomment-693370180",
      "id" : 693370180,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/19943",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5MzM3MDE4MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-16T12:24:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/693370180",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/31281497?v=4",
         "events_url" : "https://api.github.com/users/t-bast/events{/privacy}",
         "followers_url" : "https://api.github.com/users/t-bast/followers",
         "following_url" : "https://api.github.com/users/t-bast/following{/other_user}",
         "gists_url" : "https://api.github.com/users/t-bast/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/t-bast",
         "id" : 31281497,
         "login" : "t-bast",
         "node_id" : "MDQ6VXNlcjMxMjgxNDk3",
         "organizations_url" : "https://api.github.com/users/t-bast/orgs",
         "received_events_url" : "https://api.github.com/users/t-bast/received_events",
         "repos_url" : "https://api.github.com/users/t-bast/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/t-bast/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/t-bast/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/t-bast"
      }
   }
]
