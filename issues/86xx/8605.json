{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "On OpenBSD:\n\n```\nInitializing test directory /tmp/test8vty0436/25006\nMiniNode: Connecting to Bitcoin Node IP # 127.0.0.1:11408\n...\nUnexpected exception caught during testing: error('cannot add item to database',)\n  File \"/home/user/bitcoin/qa/rpc-tests/test_framework/test_framework.py\", line 150, in main\n    self.run_test()\n  File \"qa/rpc-tests/p2p-fullblocktest.py\", line 73, in run_test\n    self.test.run()\n  File \"/home/user/bitcoin/qa/rpc-tests/test_framework/comptool.py\", line 336, in run\n    self.block_store.add_block(block)\n  File \"/home/user/bitcoin/qa/rpc-tests/test_framework/blockstore.py\", line 80, in add_block\n    self.blockDB[repr(block.sha256)] = bytes(block.serialize())\nStopping nodes\n```\n\nCould be a difference between ndb back-end libraries used on OpenBSD and Ubuntu. I vaguely remember some ndb variants can only handle fairly small databases.\n\nOn Ubuntu:\n\n``` python\n>>> import _dbm\n>>> _dbm.library\n'Berkeley DB'\n```\n\nOn OpenBSD:\n\n``` python\n>>> import _dbm\n>>> _dbm.library                                                                                                                                                                               \n'GNU gdbm'\n```\n\nI believe even that is misreporting: OpenBSD does not install gdbm by default. This must be some ancient dbm variant. Just checked: It's taking the symbol from the libc(!) off all places: https://github.com/robertbachmann/openbsd-libc/tree/master/db\n\n> 4.4BSD (and its derivatives such as NetBSD) contains Berkeley DB 1 in libc.\n\nUgh.\n\nAnyhow, seems to work if I swap `dbm.ndbm` with `dbm.dumb` in `test_framework/blockstore.py` (**be sure to replace all three occurences**). This is not a good idea by default, as the performance of the dumb database is rumored to be abysmal (I haven't benchmarked though), but we could add a workaround specifically for OpenBSD.\n\n``` patch\ndiff --git a/qa/rpc-tests/test_framework/blockstore.py b/qa/rpc-tests/test_framework/blockstore.py\nindex 1e2bbb2..74cf125 100644\n--- a/qa/rpc-tests/test_framework/blockstore.py\n+++ b/qa/rpc-tests/test_framework/blockstore.py\n@@ -9,11 +9,11 @@\n\n from .mininode import *\n from io import BytesIO\n-import dbm.ndbm\n+import dbm.dumb\n\n class BlockStore(object):\n     def __init__(self, datadir):\n-        self.blockDB = dbm.ndbm.open(datadir + \"/blocks\", 'c')\n+        self.blockDB = dbm.dumb.open(datadir + \"/blocks\", 'c')\n         self.currentBlock = 0\n         self.headers_map = dict()\n\n@@ -123,7 +123,7 @@ class BlockStore(object):\n\n class TxStore(object):\n     def __init__(self, datadir):\n-        self.txDB = dbm.ndbm.open(datadir + \"/transactions\", 'c')\n+        self.txDB = dbm.dumb.open(datadir + \"/transactions\", 'c')\n\n     def close(self):\n         self.txDB.close()\n```\n",
   "closed_at" : "2016-09-29T15:23:45Z",
   "closed_by" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   },
   "comments" : 2,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8605/comments",
   "created_at" : "2016-08-26T15:06:25Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8605/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/8605",
   "id" : 173475314,
   "labels" : [
      {
         "color" : "770000",
         "default" : false,
         "id" : 234878,
         "name" : "Linux/Unix",
         "node_id" : "MDU6TGFiZWwyMzQ4Nzg=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Linux/Unix"
      },
      {
         "color" : "d4c5f9",
         "default" : false,
         "id" : 62963516,
         "name" : "Tests",
         "node_id" : "MDU6TGFiZWw2Mjk2MzUxNg==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Tests"
      },
      {
         "color" : "660000",
         "default" : false,
         "id" : 234879,
         "name" : "macOS",
         "node_id" : "MDU6TGFiZWwyMzQ4Nzk=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/macOS"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8605/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWUxNzM0NzUzMTQ=",
   "number" : 8605,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "p2p-fullblocktest fails on BSD derivates",
   "updated_at" : "2016-09-29T15:23:45Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/8605",
   "user" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   }
}
