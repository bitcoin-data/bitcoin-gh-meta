[
   {
      "author_association" : "MEMBER",
      "body" : "See discussion in #21106, eg https://github.com/bitcoin/bitcoin/pull/21106#issuecomment-790834342",
      "created_at" : "2022-01-26T21:30:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24171#issuecomment-1022620930",
      "id" : 1022620930,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24171",
      "node_id" : "IC_kwDOABII58488_UC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1022620930/reactions"
      },
      "updated_at" : "2022-01-26T21:30:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1022620930",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#24970](https://github.com/bitcoin/bitcoin/pull/24970) (net processing: Move cleanSubVer, fPreferredDownload and nLocalHostNonce to Peer by jnewbery)\n* [#24008](https://github.com/bitcoin/bitcoin/pull/24008) (assumeutxo: net_processing changes by jamesob)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-01-26T23:03:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24171#issuecomment-1022682328",
      "id" : 1022682328,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24171",
      "node_id" : "IC_kwDOABII58489OTY",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1022682328/reactions"
      },
      "updated_at" : "2022-06-02T23:24:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1022682328",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24171#discussion_r793348531"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793348531"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: I think this can be removed, since `self.generate` already calls this internally (and fails if the sync fails).\r\n\r\nIt might also be good to explain why three nodes are needed and why node0->node1 isn't sufficient to test this.\r\n\r\nMy understanding is that this is setting up `node1` as the subject under test. Having an outbound and an inbound connection, of which the outbound is selected for block download, but fails to provide any data. The test would pass with just `node0->node1` setup which means that we already sync from inbound peers if there are no outbounds at all?",
      "commit_id" : "4fdd7fe3ea347efc6e6b16c9dd9e2ea9950e6936",
      "created_at" : "2022-01-27T08:10:15Z",
      "diff_hunk" : "@@ -0,0 +1,33 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test block download\n+\n+Ensure that even in IBD, we'll eventually sync chain from inbound peers\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+\n+class BlockSyncTest(BitcoinTestFramework):\n+\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 3\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.connect_nodes(0, 1)\n+        self.connect_nodes(1, 2)\n+\n+    def run_test(self):\n+        self.log.info(\"Setup network: node0->node1->node2\")\n+        self.log.info(\"Mining one block on node0\")\n+        self.generate(self.nodes[0], 1)\n+        self.log.info(\"Check that all nodes synced\")\n+        self.sync_all()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24171#discussion_r793348531",
      "id" : 793348531,
      "line" : 28,
      "node_id" : "PRRC_kwDOABII584vSYmz",
      "original_commit_id" : "4fdd7fe3ea347efc6e6b16c9dd9e2ea9950e6936",
      "original_line" : 28,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_block_sync.py",
      "position" : 28,
      "pull_request_review_id" : 864503932,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24171",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793348531/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-27T08:12:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793348531",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24171#discussion_r793374177"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793374177"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: I would prefer combining this smth like \r\n```suggestion\r\n        } else if (!pto->fClient && !pto->IsAddrFetchConn()) &&\r\n                  (nPreferredDownload == 0 || mapBlocksInFlight.empty())) {\r\n            // Typically this is an inbound peer. If we don't have any outbound\r\n            // peers, or if we aren't downloading any blocks from such peers,\r\n            // then allow block downloads from this peer, too.\r\n            // We prefer downloading blocks from outbound peers to avoid\r\n            // putting undue load on (say) some home user who is just making\r\n            // outbound connections to the network, but if our only source of\r\n            // the latest blocks is from an inbound peer, we have to be sure to\r\n            // eventually download it (and not just wait indefinitely for an\r\n            // outbound peer to have it).\r\n```",
      "commit_id" : "4fdd7fe3ea347efc6e6b16c9dd9e2ea9950e6936",
      "created_at" : "2022-01-27T08:44:39Z",
      "diff_hunk" : "@@ -4599,10 +4599,31 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         // Start block sync\n         if (pindexBestHeader == nullptr)\n             pindexBestHeader = m_chainman.ActiveChain().Tip();\n-        bool fFetch = state.fPreferredDownload || (nPreferredDownload == 0 && !pto->fClient && !pto->IsAddrFetchConn()); // Download if this is a nice peer, or we have no nice peers and this one might do.\n+\n+        // Determine whether we might try initial headers sync or parallel\n+        // block download from this peer -- this mostly affects behavior while\n+        // in IBD (once out of IBD, we sync from all peers).\n+        bool sync_blocks_and_headers_from_peer = false;\n+        if (state.fPreferredDownload) {\n+            sync_blocks_and_headers_from_peer = true;\n+        } else if (!pto->fClient && !pto->IsAddrFetchConn()) {\n+            // Typically this is an inbound peer. If we don't have any outbound\n+            // peers, or if we aren't downloading any blocks from such peers,\n+            // then allow block downloads from this peer, too.\n+            // We prefer downloading blocks from outbound peers to avoid\n+            // putting undue load on (say) some home user who is just making\n+            // outbound connections to the network, but if our only source of\n+            // the latest blocks is from an inbound peer, we have to be sure to\n+            // eventually download it (and not just wait indefinitely for an\n+            // outbound peer to have it).\n+            if (nPreferredDownload == 0 || mapBlocksInFlight.empty()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24171#discussion_r793374177",
      "id" : 793374177,
      "line" : 4619,
      "node_id" : "PRRC_kwDOABII584vSe3h",
      "original_commit_id" : "4fdd7fe3ea347efc6e6b16c9dd9e2ea9950e6936",
      "original_line" : 4619,
      "original_position" : 22,
      "original_start_line" : 4609,
      "path" : "src/net_processing.cpp",
      "position" : 22,
      "pull_request_review_id" : 864539444,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24171",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793374177/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 4609,
      "start_side" : "RIGHT",
      "updated_at" : "2022-01-27T08:46:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793374177",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6443210?v=4",
         "events_url" : "https://api.github.com/users/PastaPastaPasta/events{/privacy}",
         "followers_url" : "https://api.github.com/users/PastaPastaPasta/followers",
         "following_url" : "https://api.github.com/users/PastaPastaPasta/following{/other_user}",
         "gists_url" : "https://api.github.com/users/PastaPastaPasta/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/PastaPastaPasta",
         "id" : 6443210,
         "login" : "PastaPastaPasta",
         "node_id" : "MDQ6VXNlcjY0NDMyMTA=",
         "organizations_url" : "https://api.github.com/users/PastaPastaPasta/orgs",
         "received_events_url" : "https://api.github.com/users/PastaPastaPasta/received_events",
         "repos_url" : "https://api.github.com/users/PastaPastaPasta/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/PastaPastaPasta/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/PastaPastaPasta/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/PastaPastaPasta"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24171#discussion_r793508926"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793508926"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I prefer the current arrangement of the conditions, because:\r\n1. The following comment says: `Typically this is an inbound peer.` This here is referring to the conditions `!pto->fClient && !pto->IsAddrFetchConn()` describing the node from which we want to fetch the block header. The other two conditions are specific to our node, which are checking if there is any preferred block to download on our side or if we have **Blocks in Flight**. Merging these two sets of conditions would make the following comment confusing.\r\n2. Keeping these two sets of conditions separate makes it easier to understand the codeâs logic and easier to follow with the comments.\r\n",
      "commit_id" : "4fdd7fe3ea347efc6e6b16c9dd9e2ea9950e6936",
      "created_at" : "2022-01-27T11:21:51Z",
      "diff_hunk" : "@@ -4599,10 +4599,31 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         // Start block sync\n         if (pindexBestHeader == nullptr)\n             pindexBestHeader = m_chainman.ActiveChain().Tip();\n-        bool fFetch = state.fPreferredDownload || (nPreferredDownload == 0 && !pto->fClient && !pto->IsAddrFetchConn()); // Download if this is a nice peer, or we have no nice peers and this one might do.\n+\n+        // Determine whether we might try initial headers sync or parallel\n+        // block download from this peer -- this mostly affects behavior while\n+        // in IBD (once out of IBD, we sync from all peers).\n+        bool sync_blocks_and_headers_from_peer = false;\n+        if (state.fPreferredDownload) {\n+            sync_blocks_and_headers_from_peer = true;\n+        } else if (!pto->fClient && !pto->IsAddrFetchConn()) {\n+            // Typically this is an inbound peer. If we don't have any outbound\n+            // peers, or if we aren't downloading any blocks from such peers,\n+            // then allow block downloads from this peer, too.\n+            // We prefer downloading blocks from outbound peers to avoid\n+            // putting undue load on (say) some home user who is just making\n+            // outbound connections to the network, but if our only source of\n+            // the latest blocks is from an inbound peer, we have to be sure to\n+            // eventually download it (and not just wait indefinitely for an\n+            // outbound peer to have it).\n+            if (nPreferredDownload == 0 || mapBlocksInFlight.empty()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24171#discussion_r793508926",
      "id" : 793508926,
      "in_reply_to_id" : 793374177,
      "line" : 4619,
      "node_id" : "PRRC_kwDOABII584vS_w-",
      "original_commit_id" : "4fdd7fe3ea347efc6e6b16c9dd9e2ea9950e6936",
      "original_line" : 4619,
      "original_position" : 22,
      "original_start_line" : 4609,
      "path" : "src/net_processing.cpp",
      "position" : 22,
      "pull_request_review_id" : 864732367,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24171",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793508926/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 4609,
      "start_side" : "RIGHT",
      "updated_at" : "2022-01-27T11:21:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793508926",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/85434418?v=4",
         "events_url" : "https://api.github.com/users/shaavan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/shaavan/followers",
         "following_url" : "https://api.github.com/users/shaavan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/shaavan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/shaavan",
         "id" : 85434418,
         "login" : "shaavan",
         "node_id" : "MDQ6VXNlcjg1NDM0NDE4",
         "organizations_url" : "https://api.github.com/users/shaavan/orgs",
         "received_events_url" : "https://api.github.com/users/shaavan/received_events",
         "repos_url" : "https://api.github.com/users/shaavan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/shaavan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/shaavan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/shaavan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24171#discussion_r793544072"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793544072"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I checked for the suggestions of @MarcoFalke, and made sure they were correct. In the definition of the `generate` function, `sync_all` is being called by default.\r\nhttps://github.com/bitcoin/bitcoin/blob/master/test/functional/test_framework/test_framework.py#L633-L636\r\nAlso, I checked that the test works perfectly with just two nodes, 0 and 1.\r\nI made the following changes to the test to incorporate the suggestions.\r\n\r\n**Diff:**\r\n\r\n```diff\r\n     def set_test_params(self):\r\n         self.setup_clean_chain = True\r\n-        self.num_nodes = 3\r\n+        self.num_nodes = 2\r\n \r\n     def setup_network(self):\r\n         self.setup_nodes()\r\n         self.connect_nodes(0, 1)\r\n-        self.connect_nodes(1, 2)\r\n \r\n     def run_test(self):\r\n-        self.log.info(\"Setup network: node0->node1->node2\")\r\n-        self.log.info(\"Mining one block on node0\")\r\n+        self.log.info(\"Setup network: node0->node1\")\r\n+        self.log.info(\"Mining one block on node0 and check that all nodes synced\")\r\n         self.generate(self.nodes[0], 1)\r\n-        self.log.info(\"Check that all nodes synced\")\r\n-        self.sync_all()\r\n         self.log.info(\"Success!\")\r\n\r\n\r\n```\r\n",
      "commit_id" : "4fdd7fe3ea347efc6e6b16c9dd9e2ea9950e6936",
      "created_at" : "2022-01-27T12:10:58Z",
      "diff_hunk" : "@@ -0,0 +1,33 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test block download\n+\n+Ensure that even in IBD, we'll eventually sync chain from inbound peers\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+\n+class BlockSyncTest(BitcoinTestFramework):\n+\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 3\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.connect_nodes(0, 1)\n+        self.connect_nodes(1, 2)\n+\n+    def run_test(self):\n+        self.log.info(\"Setup network: node0->node1->node2\")\n+        self.log.info(\"Mining one block on node0\")\n+        self.generate(self.nodes[0], 1)\n+        self.log.info(\"Check that all nodes synced\")\n+        self.sync_all()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24171#discussion_r793544072",
      "id" : 793544072,
      "in_reply_to_id" : 793348531,
      "line" : 28,
      "node_id" : "PRRC_kwDOABII584vTIWI",
      "original_commit_id" : "4fdd7fe3ea347efc6e6b16c9dd9e2ea9950e6936",
      "original_line" : 28,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_block_sync.py",
      "position" : 28,
      "pull_request_review_id" : 864781569,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24171",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793544072/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-27T12:10:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793544072",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/85434418?v=4",
         "events_url" : "https://api.github.com/users/shaavan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/shaavan/followers",
         "following_url" : "https://api.github.com/users/shaavan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/shaavan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/shaavan",
         "id" : 85434418,
         "login" : "shaavan",
         "node_id" : "MDQ6VXNlcjg1NDM0NDE4",
         "organizations_url" : "https://api.github.com/users/shaavan/orgs",
         "received_events_url" : "https://api.github.com/users/shaavan/received_events",
         "repos_url" : "https://api.github.com/users/shaavan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/shaavan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/shaavan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/shaavan"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24171#discussion_r793548467"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793548467"
         }
      },
      "author_association" : "MEMBER",
      "body" : ">  Also, I checked that the test works perfectly with just two nodes, 0 and 1.\r\n\r\nJup, the test with two nodes is passing on master and this pull. I think the goal of the test was to have a test that *fails* on master, but passes with this pull. For this you need three nodes.",
      "commit_id" : "4fdd7fe3ea347efc6e6b16c9dd9e2ea9950e6936",
      "created_at" : "2022-01-27T12:17:05Z",
      "diff_hunk" : "@@ -0,0 +1,33 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test block download\n+\n+Ensure that even in IBD, we'll eventually sync chain from inbound peers\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+\n+class BlockSyncTest(BitcoinTestFramework):\n+\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 3\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.connect_nodes(0, 1)\n+        self.connect_nodes(1, 2)\n+\n+    def run_test(self):\n+        self.log.info(\"Setup network: node0->node1->node2\")\n+        self.log.info(\"Mining one block on node0\")\n+        self.generate(self.nodes[0], 1)\n+        self.log.info(\"Check that all nodes synced\")\n+        self.sync_all()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24171#discussion_r793548467",
      "id" : 793548467,
      "in_reply_to_id" : 793348531,
      "line" : 28,
      "node_id" : "PRRC_kwDOABII584vTJaz",
      "original_commit_id" : "4fdd7fe3ea347efc6e6b16c9dd9e2ea9950e6936",
      "original_line" : 28,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_block_sync.py",
      "position" : 28,
      "pull_request_review_id" : 864787823,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24171",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793548467/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-27T12:17:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793548467",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24171#discussion_r793561848"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793561848"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> Jup, the test with two nodes is passing on master and this pull. I think the goal of the test was to have a test that fails on master but passes with this pull.\r\n\r\nI just confirmed that it's true. I think the number of nodes should be kept at 3.\r\n\r\nWe can still incorporate the following change to the test to remove redundancy from it:\r\n\r\nDiff: \r\n\r\n```diff\r\ndef run_test(self):\r\n         self.log.info(\"Setup network: node0->node1->node2\")\r\n-        self.log.info(\"Mining one block on node0\")\r\n+        self.log.info(\"Mining one block on node0 and check that all nodes synced\")\r\n         self.generate(self.nodes[0], 1)\r\n-        self.log.info(\"Check that all nodes synced\")\r\n-        self.sync_all()\r\n         self.log.info(\"Success!\")\r\n\r\n```",
      "commit_id" : "4fdd7fe3ea347efc6e6b16c9dd9e2ea9950e6936",
      "created_at" : "2022-01-27T12:35:11Z",
      "diff_hunk" : "@@ -0,0 +1,33 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test block download\n+\n+Ensure that even in IBD, we'll eventually sync chain from inbound peers\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+\n+class BlockSyncTest(BitcoinTestFramework):\n+\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 3\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.connect_nodes(0, 1)\n+        self.connect_nodes(1, 2)\n+\n+    def run_test(self):\n+        self.log.info(\"Setup network: node0->node1->node2\")\n+        self.log.info(\"Mining one block on node0\")\n+        self.generate(self.nodes[0], 1)\n+        self.log.info(\"Check that all nodes synced\")\n+        self.sync_all()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24171#discussion_r793561848",
      "id" : 793561848,
      "in_reply_to_id" : 793348531,
      "line" : 28,
      "node_id" : "PRRC_kwDOABII584vTMr4",
      "original_commit_id" : "4fdd7fe3ea347efc6e6b16c9dd9e2ea9950e6936",
      "original_line" : 28,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_block_sync.py",
      "position" : 28,
      "pull_request_review_id" : 864806675,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24171",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793561848/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-27T12:47:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793561848",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/85434418?v=4",
         "events_url" : "https://api.github.com/users/shaavan/events{/privacy}",
         "followers_url" : "https://api.github.com/users/shaavan/followers",
         "following_url" : "https://api.github.com/users/shaavan/following{/other_user}",
         "gists_url" : "https://api.github.com/users/shaavan/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/shaavan",
         "id" : 85434418,
         "login" : "shaavan",
         "node_id" : "MDQ6VXNlcjg1NDM0NDE4",
         "organizations_url" : "https://api.github.com/users/shaavan/orgs",
         "received_events_url" : "https://api.github.com/users/shaavan/received_events",
         "repos_url" : "https://api.github.com/users/shaavan/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/shaavan/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/shaavan/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/shaavan"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Perhaps have a look at `test/functional/feature_minchainwork.py` to see if some of it needs updating with this change or if the test could be added there.",
      "created_at" : "2022-01-27T14:23:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24171#issuecomment-1023262346",
      "id" : 1023262346,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24171",
      "node_id" : "IC_kwDOABII5848_b6K",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1023262346/reactions"
      },
      "updated_at" : "2022-01-27T14:23:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1023262346",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24171#discussion_r793658207"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793658207"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> My understanding is that this is setting up node1 as the subject under test. Having an outbound and an inbound connection, of which the outbound is selected for block download, but fails to provide any data. The test would pass with just node0->node1 setup which means that we already sync from inbound peers if there are no outbounds at all?\r\n\r\n@MarcoFalke Yes that is correct. We already had logic in place to download blocks from inbound peers in the case that we had no outbound peers, but prior to this patch we have had no way to download blocks that are only known by inbound peers if we're in IBD.",
      "commit_id" : "15c1687642631ca5bd8ddd6aa316776aee7e3ccd",
      "created_at" : "2022-01-27T14:27:09Z",
      "diff_hunk" : "@@ -0,0 +1,33 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test block download\n+\n+Ensure that even in IBD, we'll eventually sync chain from inbound peers\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+\n+class BlockSyncTest(BitcoinTestFramework):\n+\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 3\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.connect_nodes(0, 1)\n+        self.connect_nodes(1, 2)\n+\n+    def run_test(self):\n+        self.log.info(\"Setup network: node0->node1->node2\")\n+        self.log.info(\"Mining one block on node0\")\n+        self.generate(self.nodes[0], 1)\n+        self.log.info(\"Check that all nodes synced\")\n+        self.sync_all()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24171#discussion_r793658207",
      "id" : 793658207,
      "in_reply_to_id" : 793348531,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584vTkNf",
      "original_commit_id" : "4fdd7fe3ea347efc6e6b16c9dd9e2ea9950e6936",
      "original_line" : 28,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_block_sync.py",
      "position" : null,
      "pull_request_review_id" : 864945857,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24171",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793658207/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-27T14:27:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793658207",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24171#discussion_r793658837"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793658837"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I've updated the test comments and removed the `self.sync_all()` call.",
      "commit_id" : "15c1687642631ca5bd8ddd6aa316776aee7e3ccd",
      "created_at" : "2022-01-27T14:27:39Z",
      "diff_hunk" : "@@ -0,0 +1,33 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2022 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test block download\n+\n+Ensure that even in IBD, we'll eventually sync chain from inbound peers\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+\n+class BlockSyncTest(BitcoinTestFramework):\n+\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 3\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        self.connect_nodes(0, 1)\n+        self.connect_nodes(1, 2)\n+\n+    def run_test(self):\n+        self.log.info(\"Setup network: node0->node1->node2\")\n+        self.log.info(\"Mining one block on node0\")\n+        self.generate(self.nodes[0], 1)\n+        self.log.info(\"Check that all nodes synced\")\n+        self.sync_all()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24171#discussion_r793658837",
      "id" : 793658837,
      "in_reply_to_id" : 793348531,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584vTkXV",
      "original_commit_id" : "4fdd7fe3ea347efc6e6b16c9dd9e2ea9950e6936",
      "original_line" : 28,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "test/functional/p2p_block_sync.py",
      "position" : null,
      "pull_request_review_id" : 864946560,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24171",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793658837/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-27T14:27:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793658837",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24171#discussion_r793661257"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793661257"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, I don't think many code reviewers will find the new arrangement of these conditions meaningfully harder to read than the old code here, and I do expect that many reviewers would indeed find the old code much harder to read, so I'm inclined to leave this as I've rewritten it.",
      "commit_id" : "15c1687642631ca5bd8ddd6aa316776aee7e3ccd",
      "created_at" : "2022-01-27T14:29:31Z",
      "diff_hunk" : "@@ -4599,10 +4599,31 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         // Start block sync\n         if (pindexBestHeader == nullptr)\n             pindexBestHeader = m_chainman.ActiveChain().Tip();\n-        bool fFetch = state.fPreferredDownload || (nPreferredDownload == 0 && !pto->fClient && !pto->IsAddrFetchConn()); // Download if this is a nice peer, or we have no nice peers and this one might do.\n+\n+        // Determine whether we might try initial headers sync or parallel\n+        // block download from this peer -- this mostly affects behavior while\n+        // in IBD (once out of IBD, we sync from all peers).\n+        bool sync_blocks_and_headers_from_peer = false;\n+        if (state.fPreferredDownload) {\n+            sync_blocks_and_headers_from_peer = true;\n+        } else if (!pto->fClient && !pto->IsAddrFetchConn()) {\n+            // Typically this is an inbound peer. If we don't have any outbound\n+            // peers, or if we aren't downloading any blocks from such peers,\n+            // then allow block downloads from this peer, too.\n+            // We prefer downloading blocks from outbound peers to avoid\n+            // putting undue load on (say) some home user who is just making\n+            // outbound connections to the network, but if our only source of\n+            // the latest blocks is from an inbound peer, we have to be sure to\n+            // eventually download it (and not just wait indefinitely for an\n+            // outbound peer to have it).\n+            if (nPreferredDownload == 0 || mapBlocksInFlight.empty()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24171#discussion_r793661257",
      "id" : 793661257,
      "in_reply_to_id" : 793374177,
      "line" : 4619,
      "node_id" : "PRRC_kwDOABII584vTk9J",
      "original_commit_id" : "4fdd7fe3ea347efc6e6b16c9dd9e2ea9950e6936",
      "original_line" : 4619,
      "original_position" : 22,
      "original_start_line" : 4609,
      "path" : "src/net_processing.cpp",
      "position" : 22,
      "pull_request_review_id" : 864949388,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24171",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793661257/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 4609,
      "start_side" : "RIGHT",
      "updated_at" : "2022-01-27T14:29:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/793661257",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jonatack See also #24178, where I do change the behavior of `nMinimumChainWork` and update the test for it.  \r\n\r\nI like the idea of having this very simple test from this PR in our repo, because I have stumbled upon this exact sequence of steps breaking in the past while writing tests, and I'd like that to never happen again! I do agree with you that there is likely room for further improving the `feature_minchainwork.py` test to incorporate this kind of logic too, but it seems like a bigger rewrite to me.\r\n\r\n---\r\n\r\nJust wanted to add an additional meta-review note; I think we could bikeshed the test here or the code style indefinitely, but more important to me is that we are happy with the changed criteria in this PR.  While I think my proposal here works overall, I do think there is plenty of room to criticize or defend the behavior I'm proposing, so I'd welcome feedback either way about the specifics of the change and the expected impact on the network.\r\n\r\nFor instance, one line of thinking is that perhaps we should not prefer outbound peers over inbound peers during IBD at all, now that `-maxuploadtarget` is a setting that users may use to prevent their node from serving historical blocks if they don't want to be doing that.  I opted for a smaller behavior change in this patch, but I could see the argument for making a bigger one (and honestly that would simplify our reasoning about initial sync much more!).",
      "created_at" : "2022-01-27T14:32:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24171#issuecomment-1023271127",
      "id" : 1023271127,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24171",
      "node_id" : "IC_kwDOABII5848_eDX",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1023271127/reactions"
      },
      "updated_at" : "2022-01-27T14:48:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1023271127",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 15c1687642631ca5bd8ddd6aa316776aee7e3ccd",
      "created_at" : "2022-01-27T14:47:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24171#issuecomment-1023285890",
      "id" : 1023285890,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24171",
      "node_id" : "IC_kwDOABII5848_hqC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1023285890/reactions"
      },
      "updated_at" : "2022-01-27T14:47:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1023285890",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've read the code on Github and I agree with the nature of the changes. The burden should always be on data providers to limit externally-requested bandwidth usage per their own thresholds (rather than relying on peers to be \"considerate\" a priori). On the other hand, unnecessary stalls (and certainly the prospect of network-wide stalls) in IBD are something worth avoiding. So this PR's strategy of allowing requests to inbound peers for blocks when no blocks are otherwise in flight seems reasonable and even preferable given the possibility of stalling otherwise.\r\n\r\nI'll review and test locally in a bit.",
      "created_at" : "2022-01-27T15:38:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24171#issuecomment-1023345714",
      "id" : 1023345714,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24171",
      "node_id" : "IC_kwDOABII5848_wQy",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1023345714/reactions"
      },
      "updated_at" : "2022-01-27T15:38:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1023345714",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2022-02-10T15:35:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24171#issuecomment-1035063067",
      "id" : 1035063067,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24171",
      "node_id" : "IC_kwDOABII5849sc8b",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1035063067/reactions"
      },
      "updated_at" : "2022-02-10T15:35:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1035063067",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/13405205?v=4",
         "events_url" : "https://api.github.com/users/prayank23/events{/privacy}",
         "followers_url" : "https://api.github.com/users/prayank23/followers",
         "following_url" : "https://api.github.com/users/prayank23/following{/other_user}",
         "gists_url" : "https://api.github.com/users/prayank23/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/prayank23",
         "id" : 13405205,
         "login" : "prayank23",
         "node_id" : "MDQ6VXNlcjEzNDA1MjA1",
         "organizations_url" : "https://api.github.com/users/prayank23/orgs",
         "received_events_url" : "https://api.github.com/users/prayank23/received_events",
         "repos_url" : "https://api.github.com/users/prayank23/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/prayank23/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/prayank23/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/prayank23"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 15c1687642631ca5bd8ddd6aa316776aee7e3ccd\r\n\r\nI think it's a good change even if we opt for something bigger in the future.\r\nnit: We could have a one printed statement here saying `this chain is less trusted because it comes from inbound peers only`.\r\n",
      "created_at" : "2022-03-11T11:31:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24171#issuecomment-1065029234",
      "id" : 1065029234,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24171",
      "node_id" : "IC_kwDOABII584_ew5y",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1065029234/reactions"
      },
      "updated_at" : "2022-03-11T11:31:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1065029234",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24171#discussion_r826381201"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/826381201"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "iiuc the logic here is supposed to allow block/header downloads from inbound peers when the outbound peers don't deliver but this seems to ignore the preference for outbound peers during the initial header sync. Should `pto` be an inbound peer on the first call to `SendMessages` then we would request initial header sync from `pto` since there are no blocks in flight at that time. However none of the outbound peers have done anything wrong (e.g. stall header download) that should make us prefer the inbound peer.",
      "commit_id" : "15c1687642631ca5bd8ddd6aa316776aee7e3ccd",
      "created_at" : "2022-03-14T21:09:30Z",
      "diff_hunk" : "@@ -4599,10 +4599,31 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         // Start block sync\n         if (pindexBestHeader == nullptr)\n             pindexBestHeader = m_chainman.ActiveChain().Tip();\n-        bool fFetch = state.fPreferredDownload || (nPreferredDownload == 0 && !pto->fClient && !pto->IsAddrFetchConn()); // Download if this is a nice peer, or we have no nice peers and this one might do.\n+\n+        // Determine whether we might try initial headers sync or parallel\n+        // block download from this peer -- this mostly affects behavior while\n+        // in IBD (once out of IBD, we sync from all peers).\n+        bool sync_blocks_and_headers_from_peer = false;\n+        if (state.fPreferredDownload) {\n+            sync_blocks_and_headers_from_peer = true;\n+        } else if (!pto->fClient && !pto->IsAddrFetchConn()) {\n+            // Typically this is an inbound peer. If we don't have any outbound\n+            // peers, or if we aren't downloading any blocks from such peers,\n+            // then allow block downloads from this peer, too.\n+            // We prefer downloading blocks from outbound peers to avoid\n+            // putting undue load on (say) some home user who is just making\n+            // outbound connections to the network, but if our only source of\n+            // the latest blocks is from an inbound peer, we have to be sure to\n+            // eventually download it (and not just wait indefinitely for an\n+            // outbound peer to have it).\n+            if (nPreferredDownload == 0 || mapBlocksInFlight.empty()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24171#discussion_r826381201",
      "id" : 826381201,
      "line" : 4619,
      "node_id" : "PRRC_kwDOABII584xQZOR",
      "original_commit_id" : "15c1687642631ca5bd8ddd6aa316776aee7e3ccd",
      "original_line" : 4619,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 22,
      "pull_request_review_id" : 909399227,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24171",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/826381201/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-14T21:22:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/826381201",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24171#discussion_r826891235"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/826891235"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If our first connection is an inbound peer, then our existing logic is likely to perform initial headers sync from that peer anyway (because we'll sync from an inbound peer if we have no outbounds).  So inherently there's some risk if inbound and outbound connections are racing each other at startup that we might pick an inbound peer for initial sync. \r\n\r\nOn the other hand, if we have multiple peers (inbound and outbound), then once we've begun initial headers sync with one peer (and `nSyncStarted` gets incremented above 0), then we won't initiate headers sync based on this test anymore -- instead the new test becomes whether our headers chain is close to caught up (see line 4626 below).",
      "commit_id" : "15c1687642631ca5bd8ddd6aa316776aee7e3ccd",
      "created_at" : "2022-03-15T11:58:04Z",
      "diff_hunk" : "@@ -4599,10 +4599,31 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         // Start block sync\n         if (pindexBestHeader == nullptr)\n             pindexBestHeader = m_chainman.ActiveChain().Tip();\n-        bool fFetch = state.fPreferredDownload || (nPreferredDownload == 0 && !pto->fClient && !pto->IsAddrFetchConn()); // Download if this is a nice peer, or we have no nice peers and this one might do.\n+\n+        // Determine whether we might try initial headers sync or parallel\n+        // block download from this peer -- this mostly affects behavior while\n+        // in IBD (once out of IBD, we sync from all peers).\n+        bool sync_blocks_and_headers_from_peer = false;\n+        if (state.fPreferredDownload) {\n+            sync_blocks_and_headers_from_peer = true;\n+        } else if (!pto->fClient && !pto->IsAddrFetchConn()) {\n+            // Typically this is an inbound peer. If we don't have any outbound\n+            // peers, or if we aren't downloading any blocks from such peers,\n+            // then allow block downloads from this peer, too.\n+            // We prefer downloading blocks from outbound peers to avoid\n+            // putting undue load on (say) some home user who is just making\n+            // outbound connections to the network, but if our only source of\n+            // the latest blocks is from an inbound peer, we have to be sure to\n+            // eventually download it (and not just wait indefinitely for an\n+            // outbound peer to have it).\n+            if (nPreferredDownload == 0 || mapBlocksInFlight.empty()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24171#discussion_r826891235",
      "id" : 826891235,
      "in_reply_to_id" : 826381201,
      "line" : 4619,
      "node_id" : "PRRC_kwDOABII584xSVvj",
      "original_commit_id" : "15c1687642631ca5bd8ddd6aa316776aee7e3ccd",
      "original_line" : 4619,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 22,
      "pull_request_review_id" : 910088362,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24171",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/826891235/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-15T12:14:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/826891235",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24171#discussion_r829363937"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24171"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/829363937"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think I overestimated our preference for initial header sync from outbound peers and my concerns were to conservative considering the current syncing logic. My assumption was that we very strongly prefer outbound peers to avoid being fed an alternative chain but it seems that we already accept headers during IBD from any peer (inbound/outbound) whether we requested initial sync from them or not.\r\n\r\nThank you for your detailed response!",
      "commit_id" : "15c1687642631ca5bd8ddd6aa316776aee7e3ccd",
      "created_at" : "2022-03-17T18:20:11Z",
      "diff_hunk" : "@@ -4599,10 +4599,31 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         // Start block sync\n         if (pindexBestHeader == nullptr)\n             pindexBestHeader = m_chainman.ActiveChain().Tip();\n-        bool fFetch = state.fPreferredDownload || (nPreferredDownload == 0 && !pto->fClient && !pto->IsAddrFetchConn()); // Download if this is a nice peer, or we have no nice peers and this one might do.\n+\n+        // Determine whether we might try initial headers sync or parallel\n+        // block download from this peer -- this mostly affects behavior while\n+        // in IBD (once out of IBD, we sync from all peers).\n+        bool sync_blocks_and_headers_from_peer = false;\n+        if (state.fPreferredDownload) {\n+            sync_blocks_and_headers_from_peer = true;\n+        } else if (!pto->fClient && !pto->IsAddrFetchConn()) {\n+            // Typically this is an inbound peer. If we don't have any outbound\n+            // peers, or if we aren't downloading any blocks from such peers,\n+            // then allow block downloads from this peer, too.\n+            // We prefer downloading blocks from outbound peers to avoid\n+            // putting undue load on (say) some home user who is just making\n+            // outbound connections to the network, but if our only source of\n+            // the latest blocks is from an inbound peer, we have to be sure to\n+            // eventually download it (and not just wait indefinitely for an\n+            // outbound peer to have it).\n+            if (nPreferredDownload == 0 || mapBlocksInFlight.empty()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24171#discussion_r829363937",
      "id" : 829363937,
      "in_reply_to_id" : 826381201,
      "line" : 4619,
      "node_id" : "PRRC_kwDOABII584xbxbh",
      "original_commit_id" : "15c1687642631ca5bd8ddd6aa316776aee7e3ccd",
      "original_line" : 4619,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 22,
      "pull_request_review_id" : 913511065,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24171",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/829363937/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-17T18:20:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/829363937",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-04-20T11:24:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24171#issuecomment-1103820844",
      "id" : 1103820844,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24171",
      "node_id" : "IC_kwDOABII585Byvgs",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1103820844/reactions"
      },
      "updated_at" : "2022-04-20T11:24:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1103820844",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK 48262a00f58489d705314ee3c31136133040bb0e\r\n\r\nSeems like a straightforward improvement, as demonstrated by the test case. Seems to me like there could be better conditions, but better to deploy a simple improvement now than debate forever about the best possible logic and deploy nothing.",
      "created_at" : "2022-06-01T23:44:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24171#issuecomment-1144252717",
      "id" : 1144252717,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24171",
      "node_id" : "IC_kwDOABII585EM-kt",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1144252717/reactions"
      },
      "updated_at" : "2022-06-01T23:44:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1144252717",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK 48262a00f58489d705314ee3c31136133040bb0e",
      "created_at" : "2022-06-02T18:54:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24171#issuecomment-1145204661",
      "id" : 1145204661,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24171",
      "node_id" : "IC_kwDOABII585EQm-1",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1145204661/reactions"
      },
      "updated_at" : "2022-06-02T18:54:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1145204661",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   }
]
