[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "FYI @fjahr",
      "created_at" : "2022-01-24T14:10:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24138#issuecomment-1020140609",
      "id" : 1020140609,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24138",
      "node_id" : "IC_kwDOABII5848zhxB",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1020140609/reactions"
      },
      "updated_at" : "2022-01-24T14:10:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1020140609",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#24230](https://github.com/bitcoin/bitcoin/pull/24230) (indexes: Stop using node internal types and locking cs_main, improve sync logic by ryanofsky)\n* [#24150](https://github.com/bitcoin/bitcoin/pull/24150) (refactor: move index class members from protected to private by jonatack)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-01-26T00:58:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24138#issuecomment-1021753569",
      "id" : 1021753569,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24138",
      "node_id" : "IC_kwDOABII58485rjh",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1021753569/reactions"
      },
      "updated_at" : "2022-02-02T07:14:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1021753569",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24138#discussion_r795092758"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24138"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/795092758"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't see why this should change. The `CommitInternal` override feels like a hacky refactor.",
      "commit_id" : "010156c07f28e2c8dc30d4408942d1e1d88ab54d",
      "created_at" : "2022-01-29T20:59:12Z",
      "diff_hunk" : "@@ -228,10 +228,7 @@ bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n     m_muhash.Finalize(out);\n     value.second.muhash = out;\n \n-    CDBBatch batch(*m_db);\n-    batch.Write(DBHeightKey(pindex->nHeight), value);\n-    batch.Write(DB_MUHASH, m_muhash);\n-    return m_db->WriteBatch(batch);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24138#discussion_r795092758",
      "id" : 795092758,
      "line" : 234,
      "node_id" : "PRRC_kwDOABII584vZCcW",
      "original_commit_id" : "010156c07f28e2c8dc30d4408942d1e1d88ab54d",
      "original_line" : 234,
      "original_position" : 7,
      "original_start_line" : 231,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 7,
      "pull_request_review_id" : 867009704,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24138",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/795092758/reactions"
      },
      "side" : "LEFT",
      "start_line" : 231,
      "start_side" : "LEFT",
      "updated_at" : "2022-01-29T21:00:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/795092758",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24138#discussion_r795092834"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24138"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/795092834"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Seems like the only problem is this lone line?",
      "commit_id" : "010156c07f28e2c8dc30d4408942d1e1d88ab54d",
      "created_at" : "2022-01-29T21:00:08Z",
      "diff_hunk" : "@@ -481,5 +486,5 @@ bool CoinStatsIndex::ReverseBlock(const CBlock& block, const CBlockIndex* pindex\n     Assert(m_total_unspendables_scripts == read_out.second.total_unspendables_scripts);\n     Assert(m_total_unspendables_unclaimed_rewards == read_out.second.total_unspendables_unclaimed_rewards);\n \n-    return m_db->Write(DB_MUHASH, m_muhash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24138#discussion_r795092834",
      "id" : 795092834,
      "line" : 484,
      "node_id" : "PRRC_kwDOABII584vZCdi",
      "original_commit_id" : "010156c07f28e2c8dc30d4408942d1e1d88ab54d",
      "original_line" : 484,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 31,
      "pull_request_review_id" : 867009704,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24138",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/795092834/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-29T21:00:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/795092834",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1095675?v=4",
         "events_url" : "https://api.github.com/users/luke-jr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/luke-jr/followers",
         "following_url" : "https://api.github.com/users/luke-jr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/luke-jr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/luke-jr",
         "id" : 1095675,
         "login" : "luke-jr",
         "node_id" : "MDQ6VXNlcjEwOTU2NzU=",
         "organizations_url" : "https://api.github.com/users/luke-jr/orgs",
         "received_events_url" : "https://api.github.com/users/luke-jr/received_events",
         "repos_url" : "https://api.github.com/users/luke-jr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/luke-jr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/luke-jr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24138#discussion_r795096236"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24138"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/795096236"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this is spot is problematic, and the reason for the behavior reported in #24076: \r\n\r\nIf we persist `DB_MUHASH` here in each `BlockConnected()` callback, but not `DB_BEST_BLOCK` (which is persisted only in `ChainStateFlushed()` callbacks and will therefore at this point in time have a lower height), the db is temporarily in an inconsistent state.\r\n\r\nSo in case of an unclean shutdown (with no time to flush the chainstate to disk to get in sync again), on next startup the index will initialize with the older `DB_BEST_BLOCK` but a `DB_MUHASH` which contains data from newer blocks. The index then reprocesses the blocks after `DB_BEST_BLOCK`'s height a second time. \r\nBut MuHash is a rolling hash, so it will incorporate data from these blocks twice, and the hash will be incorrect.",
      "commit_id" : "010156c07f28e2c8dc30d4408942d1e1d88ab54d",
      "created_at" : "2022-01-29T21:41:44Z",
      "diff_hunk" : "@@ -228,10 +228,7 @@ bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n     m_muhash.Finalize(out);\n     value.second.muhash = out;\n \n-    CDBBatch batch(*m_db);\n-    batch.Write(DBHeightKey(pindex->nHeight), value);\n-    batch.Write(DB_MUHASH, m_muhash);\n-    return m_db->WriteBatch(batch);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24138#discussion_r795096236",
      "id" : 795096236,
      "in_reply_to_id" : 795092758,
      "line" : 234,
      "node_id" : "PRRC_kwDOABII584vZDSs",
      "original_commit_id" : "010156c07f28e2c8dc30d4408942d1e1d88ab54d",
      "original_line" : 234,
      "original_position" : 7,
      "original_start_line" : 231,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 7,
      "pull_request_review_id" : 867012252,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24138",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/795096236/reactions"
      },
      "side" : "LEFT",
      "start_line" : 231,
      "start_side" : "LEFT",
      "updated_at" : "2022-01-29T21:41:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/795096236",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24138#discussion_r801593190"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24138"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801593190"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If I replace only that line with `true` (or `false` for that matter) the reorg test in `feature_coinstatsindex.py` still passes. But not sure if that helps with the original issue (and it indicates an obvious test coverage omission, cc @fjahr).",
      "commit_id" : "010156c07f28e2c8dc30d4408942d1e1d88ab54d",
      "created_at" : "2022-02-08T12:46:53Z",
      "diff_hunk" : "@@ -481,5 +486,5 @@ bool CoinStatsIndex::ReverseBlock(const CBlock& block, const CBlockIndex* pindex\n     Assert(m_total_unspendables_scripts == read_out.second.total_unspendables_scripts);\n     Assert(m_total_unspendables_unclaimed_rewards == read_out.second.total_unspendables_unclaimed_rewards);\n \n-    return m_db->Write(DB_MUHASH, m_muhash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24138#discussion_r801593190",
      "id" : 801593190,
      "in_reply_to_id" : 795092834,
      "line" : 484,
      "node_id" : "PRRC_kwDOABII584vx1dm",
      "original_commit_id" : "010156c07f28e2c8dc30d4408942d1e1d88ab54d",
      "original_line" : 484,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 31,
      "pull_request_review_id" : 875973739,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24138",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801593190/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-08T12:48:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801593190",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24138#discussion_r805197117"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24138"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/805197117"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Only replacing this line means the rolling `muhash` state is not persisted during reorgs. That would be a problem if the node gets shut down during the reorg, then we would risk an inconsistent state or probably the index wouldn't even start up anymore because the guard check in `Init()` would fail.",
      "commit_id" : "010156c07f28e2c8dc30d4408942d1e1d88ab54d",
      "created_at" : "2022-02-12T19:44:24Z",
      "diff_hunk" : "@@ -481,5 +486,5 @@ bool CoinStatsIndex::ReverseBlock(const CBlock& block, const CBlockIndex* pindex\n     Assert(m_total_unspendables_scripts == read_out.second.total_unspendables_scripts);\n     Assert(m_total_unspendables_unclaimed_rewards == read_out.second.total_unspendables_unclaimed_rewards);\n \n-    return m_db->Write(DB_MUHASH, m_muhash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24138#discussion_r805197117",
      "id" : 805197117,
      "in_reply_to_id" : 795092834,
      "line" : 484,
      "node_id" : "PRRC_kwDOABII584v_lU9",
      "original_commit_id" : "010156c07f28e2c8dc30d4408942d1e1d88ab54d",
      "original_line" : 484,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 31,
      "pull_request_review_id" : 880885450,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24138",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/805197117/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-13T00:14:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/805197117",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24138#discussion_r805201361"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24138"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/805201361"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think it was not considered hacky by the author of the current index architecture because it's done the same way in `blockfilterindex.cpp` and the documentation in `index/base.h` also states that this method can be overridden.\r\n\r\nObviously, I did it differently here but I can't remember if that was a deliberate choice or rather just lack of understanding (probably the latter).\r\n\r\nAnd that doesn't mean there isn't mayor room for refactoring here. But it looks like #24230 should be considered first when thinking about it first. I have not started reviewing it yet.",
      "commit_id" : "010156c07f28e2c8dc30d4408942d1e1d88ab54d",
      "created_at" : "2022-02-12T20:30:13Z",
      "diff_hunk" : "@@ -228,10 +228,7 @@ bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n     m_muhash.Finalize(out);\n     value.second.muhash = out;\n \n-    CDBBatch batch(*m_db);\n-    batch.Write(DBHeightKey(pindex->nHeight), value);\n-    batch.Write(DB_MUHASH, m_muhash);\n-    return m_db->WriteBatch(batch);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24138#discussion_r805201361",
      "id" : 805201361,
      "in_reply_to_id" : 795092758,
      "line" : 234,
      "node_id" : "PRRC_kwDOABII584v_mXR",
      "original_commit_id" : "010156c07f28e2c8dc30d4408942d1e1d88ab54d",
      "original_line" : 234,
      "original_position" : 7,
      "original_start_line" : 231,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 7,
      "pull_request_review_id" : 880885450,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24138",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/805201361/reactions"
      },
      "side" : "LEFT",
      "start_line" : 231,
      "start_side" : "LEFT",
      "updated_at" : "2022-02-13T00:14:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/805201361",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24138#discussion_r809434532"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24138"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/809434532"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"index: Commit DB_MUHASH and DB_BEST_BLOCK to disk together\" (010156c07f28e2c8dc30d4408942d1e1d88ab54d)\r\n\r\n> The `CommitInternal` override feels like a hacky refactor.\r\n\r\nI think I agree with luke if the point is that the override-and-call-base class code in `CommitInternal` is a little hacky, but fjahr's right this just the way the base index class was designed, so the override seems like appropriate way to handle this now. #24230 does clean up all the overrides and will simplify this a bit.",
      "commit_id" : "010156c07f28e2c8dc30d4408942d1e1d88ab54d",
      "created_at" : "2022-02-17T20:17:30Z",
      "diff_hunk" : "@@ -228,10 +228,7 @@ bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n     m_muhash.Finalize(out);\n     value.second.muhash = out;\n \n-    CDBBatch batch(*m_db);\n-    batch.Write(DBHeightKey(pindex->nHeight), value);\n-    batch.Write(DB_MUHASH, m_muhash);\n-    return m_db->WriteBatch(batch);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24138#discussion_r809434532",
      "id" : 809434532,
      "in_reply_to_id" : 795092758,
      "line" : 234,
      "node_id" : "PRRC_kwDOABII584wPv2k",
      "original_commit_id" : "010156c07f28e2c8dc30d4408942d1e1d88ab54d",
      "original_line" : 234,
      "original_position" : 7,
      "original_start_line" : 231,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 7,
      "pull_request_review_id" : 886505099,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24138",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/809434532/reactions"
      },
      "side" : "LEFT",
      "start_line" : 231,
      "start_side" : "LEFT",
      "updated_at" : "2022-02-17T20:53:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/809434532",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24138#discussion_r809436879"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24138"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/809436879"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"index: Commit DB_MUHASH and DB_BEST_BLOCK to disk together\" (010156c07f28e2c8dc30d4408942d1e1d88ab54d)\r\n\r\nI might add a code comment here like \"Intentionally do not update DB_MUHASH here so it stays in sync with DB_BEST_BLOCK, and index is not corrupted if there is an unclean shutdown\"",
      "commit_id" : "010156c07f28e2c8dc30d4408942d1e1d88ab54d",
      "created_at" : "2022-02-17T20:21:07Z",
      "diff_hunk" : "@@ -228,10 +228,7 @@ bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n     m_muhash.Finalize(out);\n     value.second.muhash = out;\n \n-    CDBBatch batch(*m_db);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24138#discussion_r809436879",
      "id" : 809436879,
      "line" : 231,
      "node_id" : "PRRC_kwDOABII584wPwbP",
      "original_commit_id" : "010156c07f28e2c8dc30d4408942d1e1d88ab54d",
      "original_line" : 231,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 4,
      "pull_request_review_id" : 886505099,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24138",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/809436879/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-17T20:53:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/809436879",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24138#discussion_r810001814"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24138"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810001814"
         }
      },
      "author_association" : "MEMBER",
      "body" : ">  if the node gets shut down during the reorg,\r\n\r\nI guess this is very non trivial to test, but maybe add a comment?",
      "commit_id" : "010156c07f28e2c8dc30d4408942d1e1d88ab54d",
      "created_at" : "2022-02-18T13:33:33Z",
      "diff_hunk" : "@@ -481,5 +486,5 @@ bool CoinStatsIndex::ReverseBlock(const CBlock& block, const CBlockIndex* pindex\n     Assert(m_total_unspendables_scripts == read_out.second.total_unspendables_scripts);\n     Assert(m_total_unspendables_unclaimed_rewards == read_out.second.total_unspendables_unclaimed_rewards);\n \n-    return m_db->Write(DB_MUHASH, m_muhash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24138#discussion_r810001814",
      "id" : 810001814,
      "in_reply_to_id" : 795092834,
      "line" : 484,
      "node_id" : "PRRC_kwDOABII584wR6WW",
      "original_commit_id" : "010156c07f28e2c8dc30d4408942d1e1d88ab54d",
      "original_line" : 484,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 31,
      "pull_request_review_id" : 887280272,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24138",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810001814/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-18T13:33:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/810001814",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24138#discussion_r811280315"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24138"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811280315"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Just to make this clear: This is not a refactor, it changes behavior (the points in time when `DB_MUHASH` is written to disk).\r\n\r\nMy understanding is that the indexes work in general such that that all persisted data describing the current _progress_ of indexing (such as the best block) must be in sync with the persisted chainstate information (which is sometimes not flushed for several blocks received) - that is why `ChainStateFlushed()` callbacks are used. In case of an unclean shutdown, the chainstate will be constructed from this point on, so the indexes must as well.\r\n\r\nIn contrast to this is the actual indexed data for each block - I think we could in principle cache it and also write it to disk with each `ChainStateFlushed()` callback and not use `BlockConnected()` at all. \r\n\r\nBut it is also possible to write it to disk in advance with each `BlockConnected()` callback, as it is done:\r\nThis is dependent on the assumption that we will not read (and possibly overwrite) the indexed data in case it is ahead of the flushed chainstate data (and the best block), and also that _before_ flushing the chainstate, we have called `BlockConnected()` for each block.\r\n\r\nWith this in mind, I don't see a better way of doing this other than overriding `CommitInternal`.",
      "commit_id" : "eb6cc05da32c5bde122725a0bc907d3767a791cd",
      "created_at" : "2022-02-21T16:21:20Z",
      "diff_hunk" : "@@ -228,10 +228,7 @@ bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n     m_muhash.Finalize(out);\n     value.second.muhash = out;\n \n-    CDBBatch batch(*m_db);\n-    batch.Write(DBHeightKey(pindex->nHeight), value);\n-    batch.Write(DB_MUHASH, m_muhash);\n-    return m_db->WriteBatch(batch);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24138#discussion_r811280315",
      "id" : 811280315,
      "in_reply_to_id" : 795092758,
      "line" : 234,
      "node_id" : "PRRC_kwDOABII584wWye7",
      "original_commit_id" : "010156c07f28e2c8dc30d4408942d1e1d88ab54d",
      "original_line" : 234,
      "original_position" : 7,
      "original_start_line" : 231,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 7,
      "pull_request_review_id" : 888896253,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24138",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811280315/reactions"
      },
      "side" : "LEFT",
      "start_line" : 231,
      "start_side" : "LEFT",
      "updated_at" : "2022-02-21T16:21:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811280315",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24138#discussion_r811294780"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24138"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811294780"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks, I added a comment here.",
      "commit_id" : "eb6cc05da32c5bde122725a0bc907d3767a791cd",
      "created_at" : "2022-02-21T16:40:07Z",
      "diff_hunk" : "@@ -228,10 +228,7 @@ bool CoinStatsIndex::WriteBlock(const CBlock& block, const CBlockIndex* pindex)\n     m_muhash.Finalize(out);\n     value.second.muhash = out;\n \n-    CDBBatch batch(*m_db);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24138#discussion_r811294780",
      "id" : 811294780,
      "in_reply_to_id" : 809436879,
      "line" : 231,
      "node_id" : "PRRC_kwDOABII584wW2A8",
      "original_commit_id" : "010156c07f28e2c8dc30d4408942d1e1d88ab54d",
      "original_line" : 231,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 4,
      "pull_request_review_id" : 888916281,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24138",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811294780/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-21T16:40:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811294780",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24138#discussion_r811297574"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24138"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811297574"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I added a comment at the end of `CoinStatsIndex::WriteBlock` (as suggested by ryanofsky below). I think that duplicating this comment in `CoinStatsIndex::ReverseBlock` is not required, since this function doesn't write anything else to disk there wouldn't really be the expectation that for it to write `DB_MUHASH` here.",
      "commit_id" : "eb6cc05da32c5bde122725a0bc907d3767a791cd",
      "created_at" : "2022-02-21T16:43:46Z",
      "diff_hunk" : "@@ -481,5 +486,5 @@ bool CoinStatsIndex::ReverseBlock(const CBlock& block, const CBlockIndex* pindex\n     Assert(m_total_unspendables_scripts == read_out.second.total_unspendables_scripts);\n     Assert(m_total_unspendables_unclaimed_rewards == read_out.second.total_unspendables_unclaimed_rewards);\n \n-    return m_db->Write(DB_MUHASH, m_muhash);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24138#discussion_r811297574",
      "id" : 811297574,
      "in_reply_to_id" : 795092834,
      "line" : 492,
      "node_id" : "PRRC_kwDOABII584wW2sm",
      "original_commit_id" : "010156c07f28e2c8dc30d4408942d1e1d88ab54d",
      "original_line" : 492,
      "original_position" : 31,
      "original_start_line" : null,
      "path" : "src/index/coinstatsindex.cpp",
      "position" : 33,
      "pull_request_review_id" : 888920204,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24138",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811297574/reactions"
      },
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-21T16:43:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/811297574",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I pushed an update, rebasing (with #24133 merged) and addressing feedback (adding a comment).\r\n\r\n> It would be good to add a unit test to coinstatsindex_tests that triggers the issue this is supposed to fix. I think the test would just need to make the index object, send a BlockConnected notification, and then destroy the index object without sending ChainStateFlushed notification. This would save a corrupted index that should result in errors next time it is loaded.\r\n\r\nThis would be great. I haven't done this with this push, because \r\na) I couldn't make it work yet, I had some technical difficulties with the test framework when restarting the index. I will look into it more unless\r\nb) @fjahr who said [here](https://github.com/bitcoin/bitcoin/pull/24133#discussion_r810605240) that he is working on this has more success.",
      "created_at" : "2022-02-21T16:51:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24138#issuecomment-1047069965",
      "id" : 1047069965,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24138",
      "node_id" : "IC_kwDOABII584-aQUN",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1047069965/reactions"
      },
      "updated_at" : "2022-02-21T16:53:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1047069965",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> @mzumsande I wrote a little test which passes with this bugfix, and fails with the fix reverted. Feel free to add it to this PR or use the code in any way: ~[ded9fda](https://github.com/bitcoin/bitcoin/commit/ded9fda2b6e154ac64b2fc755ddaa738b309b7e9)~ [d3c2ebb](https://github.com/bitcoin/bitcoin/commit/d3c2ebbfdc3c61a04b645c6bb435424fa60f4a0b)\r\n\r\nThank you! The test looks great, I added your commit to this PR (and confirmed that it fails on master).\r\n",
      "created_at" : "2022-03-01T14:02:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24138#issuecomment-1055472029",
      "id" : 1055472029,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24138",
      "node_id" : "IC_kwDOABII584-6Tmd",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1055472029/reactions"
      },
      "updated_at" : "2022-03-01T14:02:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1055472029",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24138#discussion_r820237111"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24138"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/820237111"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "in 691d45fdc83ec14f87a400f548553168ac70263f:\r\n\r\nNot sure why we need this whole block with the new `index` instead of reusing the old `index` above. It doesn't seem to make a difference in my testing? ",
      "commit_id" : "691d45fdc83ec14f87a400f548553168ac70263f",
      "created_at" : "2022-03-06T13:47:05Z",
      "diff_hunk" : "@@ -78,4 +85,44 @@ BOOST_FIXTURE_TEST_CASE(coinstatsindex_initial_sync, TestChain100Setup)\n     // Rest of shutdown sequence and destructors happen in ~TestingSetup()\n }\n \n+// Test shutdown between BlockConnected and ChainStateFlushed notifications,\n+// make sure index is not corrupted and is able to reload.\n+BOOST_FIXTURE_TEST_CASE(coinstatsindex_unclean_shutdown, TestChain100Setup)\n+{\n+    CChainState& chainstate = Assert(m_node.chainman)->ActiveChainstate();\n+    const CChainParams& params = Params();\n+    {\n+        CoinStatsIndex index{1 << 20};\n+        BOOST_REQUIRE(index.Start(chainstate));\n+        IndexWaitSynced(index);\n+        std::shared_ptr<const CBlock> new_block;\n+        CBlockIndex* new_block_index = nullptr;\n+        {\n+            const CScript script_pub_key{CScript() << ToByteVector(coinbaseKey.GetPubKey()) << OP_CHECKSIG};\n+            const CBlock block = this->CreateBlock({}, script_pub_key, chainstate);\n+\n+            new_block = std::make_shared<CBlock>(block);\n+\n+            LOCK(cs_main);\n+            BlockValidationState state;\n+            BOOST_CHECK(CheckBlock(block, state, params.GetConsensus()));\n+            BOOST_CHECK(chainstate.AcceptBlock(new_block, state, &new_block_index, true, nullptr, nullptr));\n+            CCoinsViewCache view(&chainstate.CoinsTip());\n+            BOOST_CHECK(chainstate.ConnectBlock(block, state, new_block_index, view));\n+        }\n+        // Send block connected notification, then stop the index without\n+        // sending a chainstate flushed notification. Prior to #24138, this\n+        // would cause the index to be corrupted and fail to reload.\n+        ValidationInterfaceTest::BlockConnected(index, new_block, new_block_index);\n+        index.Stop();\n+    }\n+\n+    {\n+        CoinStatsIndex index{1 << 20};\n+        // Make sure the index can be loaded.\n+        BOOST_REQUIRE(index.Start(chainstate));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24138#discussion_r820237111",
      "id" : 820237111,
      "line" : 123,
      "node_id" : "PRRC_kwDOABII584w49M3",
      "original_commit_id" : "691d45fdc83ec14f87a400f548553168ac70263f",
      "original_line" : 123,
      "original_position" : 83,
      "original_start_line" : null,
      "path" : "src/test/coinstatsindex_tests.cpp",
      "position" : 83,
      "pull_request_review_id" : 901078124,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24138",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/820237111/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-06T14:09:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/820237111",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24138#discussion_r822521424"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24138"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/822521424"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is there a huge cost to spinning up the second index? If not, I think both versions are fine.",
      "commit_id" : "691d45fdc83ec14f87a400f548553168ac70263f",
      "created_at" : "2022-03-09T10:49:49Z",
      "diff_hunk" : "@@ -78,4 +85,44 @@ BOOST_FIXTURE_TEST_CASE(coinstatsindex_initial_sync, TestChain100Setup)\n     // Rest of shutdown sequence and destructors happen in ~TestingSetup()\n }\n \n+// Test shutdown between BlockConnected and ChainStateFlushed notifications,\n+// make sure index is not corrupted and is able to reload.\n+BOOST_FIXTURE_TEST_CASE(coinstatsindex_unclean_shutdown, TestChain100Setup)\n+{\n+    CChainState& chainstate = Assert(m_node.chainman)->ActiveChainstate();\n+    const CChainParams& params = Params();\n+    {\n+        CoinStatsIndex index{1 << 20};\n+        BOOST_REQUIRE(index.Start(chainstate));\n+        IndexWaitSynced(index);\n+        std::shared_ptr<const CBlock> new_block;\n+        CBlockIndex* new_block_index = nullptr;\n+        {\n+            const CScript script_pub_key{CScript() << ToByteVector(coinbaseKey.GetPubKey()) << OP_CHECKSIG};\n+            const CBlock block = this->CreateBlock({}, script_pub_key, chainstate);\n+\n+            new_block = std::make_shared<CBlock>(block);\n+\n+            LOCK(cs_main);\n+            BlockValidationState state;\n+            BOOST_CHECK(CheckBlock(block, state, params.GetConsensus()));\n+            BOOST_CHECK(chainstate.AcceptBlock(new_block, state, &new_block_index, true, nullptr, nullptr));\n+            CCoinsViewCache view(&chainstate.CoinsTip());\n+            BOOST_CHECK(chainstate.ConnectBlock(block, state, new_block_index, view));\n+        }\n+        // Send block connected notification, then stop the index without\n+        // sending a chainstate flushed notification. Prior to #24138, this\n+        // would cause the index to be corrupted and fail to reload.\n+        ValidationInterfaceTest::BlockConnected(index, new_block, new_block_index);\n+        index.Stop();\n+    }\n+\n+    {\n+        CoinStatsIndex index{1 << 20};\n+        // Make sure the index can be loaded.\n+        BOOST_REQUIRE(index.Start(chainstate));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24138#discussion_r822521424",
      "id" : 822521424,
      "in_reply_to_id" : 820237111,
      "line" : 123,
      "node_id" : "PRRC_kwDOABII584xBq5Q",
      "original_commit_id" : "691d45fdc83ec14f87a400f548553168ac70263f",
      "original_line" : 123,
      "original_position" : 83,
      "original_start_line" : null,
      "path" : "src/test/coinstatsindex_tests.cpp",
      "position" : 83,
      "pull_request_review_id" : 904182906,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24138",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/822521424/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-09T10:49:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/822521424",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
