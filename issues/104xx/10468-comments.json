[
   {
      "author_association" : "MEMBER",
      "body" : "Just noticed this while reviewing #9662. It's quite weird:\r\n\r\n```\r\n$ src/bitcoin-cli -rpcwallet=\"hi\" listreceivedbyaddress 0 true\r\n[\r\n  {\r\n    \"address\": \"mzDWjPWzsNr7Nbd5rhC73MnmJt9L1Vd9CH\",\r\n    \"account\": \"\",\r\n    \"amount\": 0.00000000,\r\n    \"confirmations\": 0,\r\n    \"label\": \"\",\r\n    \"txids\": [\r\n    ]\r\n  }\r\n]\r\n\r\n$ src/bitcoin-cli -rpcwallet=\"hi\" listreceivedbyaddress 0 true true\r\n[\r\n  {\r\n    \"involvesWatchonly\": true,\r\n    \"address\": \"mzDWjPWzsNr7Nbd5rhC73MnmJt9L1Vd9CH\",\r\n    \"account\": \"\",\r\n    \"amount\": 0.01000000,\r\n    \"confirmations\": 0,\r\n    \"label\": \"\",\r\n    \"txids\": [\r\n      \"e710f6f7f1c9cd9e4cd86ec345d7058dd8236c717caf0e0088ad018c231cfa92\"\r\n    ]\r\n  }\r\n]\r\n```",
      "created_at" : "2018-07-10T15:10:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/10468#issuecomment-403857917",
      "id" : 403857917,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10468",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQwMzg1NzkxNw==",
      "updated_at" : "2018-07-10T15:10:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/403857917",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "The expected behavior with `listreceivedbyaddress` is that when `include_empty=true` and `include_watchonly=false` the watchonly addresses should not be returned at all. \r\n\r\nWhat has been reported and what I was able to reproduce is that when watchonly addresses are not supposed to be included (`include_watchonly=false`), they are included if `include_empty=true` and are always returned as having 0 balance even if they have a positive balance. \r\n\r\nI was able to reproduced this using legacy wallets on regtest.\r\n   - Preparation\r\n     ```shell\r\n     # create directories for nodes\r\n     mkdir -p /tmp/node1-datadir\r\n     mkdir -p /tmp/node2-datadir\r\n     \r\n     # run node1\r\n     src/bitcoind -regtest -datadir=/tmp/node1-datadir\r\n      \r\n     # run node2\r\n     src/bitcoind -regtest -datadir=/tmp/node2-datadir -rpcport=18300 -port=18400\r\n     \r\n     # (using variables for productivity)\r\n     NODE1=\"src/bitcoin-cli -regtest -datadir=/tmp/node1-datadir\"\r\n     NODE2=\"src/bitcoin-cli -regtest -datadir=/tmp/node2-datadir -rpcport=18300\"\r\n\r\n     # create wallets (legacy) \r\n     $NODE1 -named createwallet wallet_name=wallet1 descriptors=false\r\n     $NODE2 -named createwallet wallet_name=wallet2 descriptors=false\r\n\r\n     watch_address=$($NODE1 getnewaddress) # generate address on node1\r\n     $NODE2 importaddress $watch_address # add address as watchonly on node2\r\n\r\n     ```\r\n   - Observe issue when **there is no balance in $watch_address**. \r\n     ```shell\r\n     #  This returns nothing, **as expected**.\r\n     $NODE2 -named listreceivedbyaddress include_empty=false include_watchonly={false,true}\r\n     []\r\n\r\n     # This should also return nothing, but it returns the empty $watch_address\r\n     $NODE2 -named listreceivedbyaddress include_empty=true include_watchonly=false\r\n     [\r\n       {\r\n         \"address\": $watch_address,\r\n         \"amount\": 0.00000000,\r\n         \"confirmations\": 0,\r\n         \"label\": \"\",\r\n         \"txids\": [\r\n         ]\r\n       }\r\n     ]\r\n     ``` \r\n   - Observe issue **with balance in $watch_address**.\r\n     ```shell\r\n     $NODE1 addnode 127.0.0.1:18400 \"add\"  # connect nodes 1->2\r\n     $NODE1 generatetoaddress 101 $watch_address # mine blocks to address \r\n\r\n     # Correctly returns the watchonly address\r\n     $NODE2 -named listreceivedbyaddress include_empty={false,true} include_watchonly=true\r\n     [\r\n       {\r\n         \"involvesWatchonly\": true,\r\n         \"address\": $watch_address,\r\n         \"amount\": 50.00000000,\r\n         \"confirmations\": 101,\r\n         \"label\": \"\",\r\n         \"txids\": [\r\n           \"c0be670898b208f156a7be5776b97f2c459e7056450ff10c66e0a2058352c319\"\r\n         ]\r\n       }\r\n     ]\r\n     \r\n     # Correctly returns nothing\r\n     $NODE2 -named listreceivedbyaddress include_empty=false include_watchonly=false\r\n     []\r\n     \r\n     # This should also return nothing , but it returns the empty $watch_address\r\n     $NODE2 -named listreceivedbyaddress include_empty=true include_watchonly=false\r\n     [\r\n       {\r\n         \"address\": $watch_address,\r\n         \"amount\": 0.00000000,\r\n         \"confirmations\": 0,\r\n         \"label\": \"\",\r\n         \"txids\": [\r\n         ]\r\n       }\r\n     ]\r\n     ```\r\n\r\nNote: The same behavior can also reproduced for the `listreceivedbylabel` RPC.",
      "created_at" : "2022-08-03T16:11:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/issues/10468#issuecomment-1204165996",
      "id" : 1204165996,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10468",
      "node_id" : "IC_kwDOABII585Hxh1s",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1204165996/reactions"
      },
      "updated_at" : "2022-08-03T16:11:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1204165996",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/18506343?v=4",
         "events_url" : "https://api.github.com/users/kouloumos/events{/privacy}",
         "followers_url" : "https://api.github.com/users/kouloumos/followers",
         "following_url" : "https://api.github.com/users/kouloumos/following{/other_user}",
         "gists_url" : "https://api.github.com/users/kouloumos/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/kouloumos",
         "id" : 18506343,
         "login" : "kouloumos",
         "node_id" : "MDQ6VXNlcjE4NTA2MzQz",
         "organizations_url" : "https://api.github.com/users/kouloumos/orgs",
         "received_events_url" : "https://api.github.com/users/kouloumos/received_events",
         "repos_url" : "https://api.github.com/users/kouloumos/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/kouloumos/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/kouloumos/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/kouloumos"
      }
   }
]
