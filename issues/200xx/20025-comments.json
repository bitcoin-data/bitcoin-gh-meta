[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@sdaftuar @jnewbery following up on our discussion about `GetTransactionFee` here!",
      "created_at" : "2020-09-26T16:29:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20025#issuecomment-699517479",
      "id" : 699517479,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20025",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5OTUxNzQ3OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-26T16:29:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/699517479",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/gzhao408/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gzhao408/followers",
         "following_url" : "https://api.github.com/users/gzhao408/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gzhao408/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gzhao408",
         "id" : 25183001,
         "login" : "gzhao408",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/gzhao408/orgs",
         "received_events_url" : "https://api.github.com/users/gzhao408/received_events",
         "repos_url" : "https://api.github.com/users/gzhao408/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gzhao408/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gzhao408/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gzhao408"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19753 (p2p: don't add AlreadyHave transactions to recentRejects by troygiorshev)\n* #19645 (Allow updating mempool-txn with cheaper witnesses by ariard)\n* #19498 (Tidy up ProcessOrphanTx by jnewbery)\n* #19438 (Introduce deploymentstatus by ajtowns)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-09-26T21:07:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20025#issuecomment-699548015",
      "id" : 699548015,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20025",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY5OTU0ODAxNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-29T13:00:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/699548015",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2020-09-30T15:34:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20025#issuecomment-701469207",
      "id" : 701469207,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20025",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwMTQ2OTIwNw==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-09-30T15:34:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/701469207",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20025#discussion_r497640937"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20025"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/497640937"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I may be missing something, but I think this can be simplified further by dropping the call to ATMP here. Suppose the transaction has _two_ problems, one that `GetTransaction()` catches and another that's outside its scope. `GetTransactionFee()` will return a failure and presumably set `state` appropriately (I didn't verify this, but if it doesn't, that's a bug that should be fixed). I don't see what's wrong with just returning that error. \r\n\r\nIt's true that by calling ATMP here, `state` may get set to a _different_ error, but it's not clear to me why that's a better error to return.",
      "commit_id" : "6831972c09837c1a06034eaf63dfc4f3a6f0db6b",
      "created_at" : "2020-09-30T16:23:40Z",
      "diff_hunk" : "@@ -50,12 +50,14 @@ TransactionError BroadcastTransaction(NodeContext& node, const CTransactionRef t\n     if (!node.mempool->exists(hashTx)) {\n         // Transaction is not already in the mempool.\n         TxValidationState state;\n-        CAmount fee{0};\n         if (max_tx_fee) {\n-            // First, call ATMP with test_accept and check the fee. If ATMP\n-            // fails here, return error immediately.\n-            if (!AcceptToMemoryPool(*node.mempool, state, tx,\n-                nullptr /* plTxnReplaced */, false /* bypass_limits */, /* test_accept */ true, &fee)) {\n+            // First, check that transaction fee does not exceed max_tx_fee.\n+            Optional<CAmount> fee = GetTransactionFee(*node.mempool, state, *tx);\n+            if (fee == nullopt) {\n+                // Failed GetTransactionFee indicates a validation failure.\n+                // Use ATMP with test_accept to return the validation error.\n+                AcceptToMemoryPool(*node.mempool, state, tx,\n+                    nullptr /* plTxnReplaced */, false /* bypass_limits */, true /* test_accept */);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20025#discussion_r497640937",
      "id" : 497640937,
      "line" : 60,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY0MDkzNw==",
      "original_commit_id" : "6831972c09837c1a06034eaf63dfc4f3a6f0db6b",
      "original_line" : 60,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/node/transaction.cpp",
      "position" : 43,
      "pull_request_review_id" : 499606456,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20025",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-09-30T16:41:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/497640937",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Could this PR also remove the fee return value from ATMP? I think all you'd need to do is call GetTransactionFee() from the testmempoolaccept rpc handler (before the existing call to ATMP(test_accept=true)). That would increase the lines-of-code count slightly, but is cleaner and creates even more separation between the fee stuff and ATMP.\r\n\r\nWe just introduced the `fee` return value in #19940 and the hope is that, for `testmempoolaccept`, we can return more fee information gathered from ATMP like modified fees as well. We get this information for free, so I think it's cleaner to just use ATMP. I don't think it's possible to separate fees since it's a big part of policy.",
      "created_at" : "2020-10-01T17:43:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20025#issuecomment-702293576",
      "id" : 702293576,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20025",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwMjI5MzU3Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-01T17:43:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/702293576",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20025#discussion_r498415454"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20025"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/498415454"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "ATMP should be the authority on validation; I don't want to trust anything else with filling in `TxValidationResult`. I think I could make it a little cleaner and have `GetTransactionFee` just not touch state, but `CheckTxInputs` needs it ð¤  ",
      "commit_id" : "6831972c09837c1a06034eaf63dfc4f3a6f0db6b",
      "created_at" : "2020-10-01T17:45:44Z",
      "diff_hunk" : "@@ -50,12 +50,14 @@ TransactionError BroadcastTransaction(NodeContext& node, const CTransactionRef t\n     if (!node.mempool->exists(hashTx)) {\n         // Transaction is not already in the mempool.\n         TxValidationState state;\n-        CAmount fee{0};\n         if (max_tx_fee) {\n-            // First, call ATMP with test_accept and check the fee. If ATMP\n-            // fails here, return error immediately.\n-            if (!AcceptToMemoryPool(*node.mempool, state, tx,\n-                nullptr /* plTxnReplaced */, false /* bypass_limits */, /* test_accept */ true, &fee)) {\n+            // First, check that transaction fee does not exceed max_tx_fee.\n+            Optional<CAmount> fee = GetTransactionFee(*node.mempool, state, *tx);\n+            if (fee == nullopt) {\n+                // Failed GetTransactionFee indicates a validation failure.\n+                // Use ATMP with test_accept to return the validation error.\n+                AcceptToMemoryPool(*node.mempool, state, tx,\n+                    nullptr /* plTxnReplaced */, false /* bypass_limits */, true /* test_accept */);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20025#discussion_r498415454",
      "id" : 498415454,
      "in_reply_to_id" : 497640937,
      "line" : 60,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQxNTQ1NA==",
      "original_commit_id" : "6831972c09837c1a06034eaf63dfc4f3a6f0db6b",
      "original_line" : 60,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/node/transaction.cpp",
      "position" : 43,
      "pull_request_review_id" : 500580932,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20025",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-01T17:45:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/498415454",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : " ACK 6831972c09837c1a06034eaf63dfc4f3a6f0db6b (last commit only), provisional since this PR needs rebasing onto latest #19339.",
      "created_at" : "2020-10-04T20:06:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20025#issuecomment-703308735",
      "id" : 703308735,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/20025",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDcwMzMwODczNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2020-10-04T20:06:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/703308735",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/8321330?v=4",
         "events_url" : "https://api.github.com/users/LarryRuane/events{/privacy}",
         "followers_url" : "https://api.github.com/users/LarryRuane/followers",
         "following_url" : "https://api.github.com/users/LarryRuane/following{/other_user}",
         "gists_url" : "https://api.github.com/users/LarryRuane/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/LarryRuane",
         "id" : 8321330,
         "login" : "LarryRuane",
         "node_id" : "MDQ6VXNlcjgzMjEzMzA=",
         "organizations_url" : "https://api.github.com/users/LarryRuane/orgs",
         "received_events_url" : "https://api.github.com/users/LarryRuane/received_events",
         "repos_url" : "https://api.github.com/users/LarryRuane/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/LarryRuane/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/LarryRuane"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/20025#discussion_r500513483"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20025"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500513483"
         }
      },
      "author_association" : "NONE",
      "body" : "Tcb",
      "commit_id" : "6831972c09837c1a06034eaf63dfc4f3a6f0db6b",
      "created_at" : "2020-10-06T18:33:48Z",
      "diff_hunk" : "@@ -50,12 +50,14 @@ TransactionError BroadcastTransaction(NodeContext& node, const CTransactionRef t\n     if (!node.mempool->exists(hashTx)) {\n         // Transaction is not already in the mempool.\n         TxValidationState state;\n-        CAmount fee{0};\n         if (max_tx_fee) {\n-            // First, call ATMP with test_accept and check the fee. If ATMP\n-            // fails here, return error immediately.\n-            if (!AcceptToMemoryPool(*node.mempool, state, tx,\n-                nullptr /* plTxnReplaced */, false /* bypass_limits */, /* test_accept */ true, &fee)) {\n+            // First, check that transaction fee does not exceed max_tx_fee.\n+            Optional<CAmount> fee = GetTransactionFee(*node.mempool, state, *tx);\n+            if (fee == nullopt) {\n+                // Failed GetTransactionFee indicates a validation failure.\n+                // Use ATMP with test_accept to return the validation error.\n+                AcceptToMemoryPool(*node.mempool, state, tx,\n+                    nullptr /* plTxnReplaced */, false /* bypass_limits */, true /* test_accept */);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/20025#discussion_r500513483",
      "id" : 500513483,
      "in_reply_to_id" : 497640937,
      "line" : 60,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUxMzQ4Mw==",
      "original_commit_id" : "6831972c09837c1a06034eaf63dfc4f3a6f0db6b",
      "original_line" : 60,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/node/transaction.cpp",
      "position" : 43,
      "pull_request_review_id" : 503251378,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/20025",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-10-06T18:34:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/500513483",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/71334874?v=4",
         "events_url" : "https://api.github.com/users/Elvistcb/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Elvistcb/followers",
         "following_url" : "https://api.github.com/users/Elvistcb/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Elvistcb/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Elvistcb",
         "id" : 71334874,
         "login" : "Elvistcb",
         "node_id" : "MDQ6VXNlcjcxMzM0ODc0",
         "organizations_url" : "https://api.github.com/users/Elvistcb/orgs",
         "received_events_url" : "https://api.github.com/users/Elvistcb/received_events",
         "repos_url" : "https://api.github.com/users/Elvistcb/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Elvistcb/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Elvistcb/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Elvistcb"
      }
   }
]
