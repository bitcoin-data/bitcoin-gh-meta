{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "NONE",
   "body" : "When running the p2p_addr_relay.py test on a WSL (ubuntu1804), I encountered a **KeyError** exception.\r\nIt was on the following stage : \"_Check that we only relay addresses to inbound peers who have previously sent us addr related messages_\".\r\nThe missing key is the \"addr_relay_enabled\".\r\nIt seems there is no reference or previous dictionary where to find it.\r\n\r\nHere are the logs:\r\n\r\n> 2021-08-26T10:16:27.071000Z TestFramework (INFO): Initializing test directory /tmp/bitcoin_func_test_tbpvrrpg\r\n2021-08-26T10:16:27.783000Z TestFramework (INFO): Send an addr message that is too large\r\n2021-08-26T10:16:27.952000Z TestFramework (INFO): Test address relay\r\n2021-08-26T10:16:27.953000Z TestFramework (INFO): Check that addr message content is relayed and added to addrman\r\n2021-08-26T10:16:29.611000Z TestFramework (INFO): Check relay of addresses received from outbound peers\r\n2021-08-26T10:16:29.968000Z TestFramework (INFO): Check that the first addr message received from an outbound peer is not relayed\r\n2021-08-26T10:16:30.021000Z TestFramework (INFO): Check that subsequent addr messages sent from an outbound peer are relayed\r\n2021-08-26T10:16:30.175000Z TestFramework (INFO): Check address relay to outbound peers\r\n2021-08-26T10:16:30.581000Z TestFramework (INFO): Check that addresses are relayed to full outbound peers\r\n2021-08-26T10:16:30.581000Z TestFramework (INFO): Check that addresses are not relayed to block-relay-only outbound peers\r\n2021-08-26T10:16:30.584000Z TestFramework (INFO): Check that we only relay addresses to inbound peers who have previously sent us addr related messages\r\n2021-08-26T10:16:30.895000Z TestFramework (ERROR): Key error\r\nTraceback (most recent call last):\r\n  File \"/home/nourou/bitcoin/test/functional/test_framework/test_framework.py\", line 131, in main\r\n    self.run_test()\r\n  File \"p2p_addr_relay.py\", line 86, in run_test\r\n    self.inbound_blackhole_tests()\r\n  File \"p2p_addr_relay.py\", line 214, in inbound_blackhole_tests\r\n    assert_equal(peerinfo[0]['addr_relay_enabled'], True)  # addr_source\r\nKeyError: 'addr_relay_enabled'\r\n2021-08-26T10:16:30.586000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_sendaddrv2()\r\n2021-08-26T10:16:30.586000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_verack()\r\n2021-08-26T10:16:30.586000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_sendheaders()\r\n2021-08-26T10:16:30.587000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_sendcmpct(announce=False, version=2)\r\n2021-08-26T10:16:30.587000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_sendcmpct(announce=False, version=1)\r\n2021-08-26T10:16:30.587000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_ping(nonce=3f51963ece3a99e0)\r\n2021-08-26T10:16:30.587000Z TestFramework.p2p (DEBUG): Send message to 127.0.0.1:15188: msg_pong(nonce=3f51963ece3a99e0)\r\n2021-08-26T10:16:30.587000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_getheaders(locator=CBlockLocator(vHave=[23807444962857534591630102868443165169099872195127563234000810727149388982010, 447397901073913437177306182676806822084817164934125609\r\n01130905383743091755536, 12663556118629435951519719937229071722250511777495500151983207830672125396536, 44153859904987177378521432406456967833959290357169379249027894378362945782348, 6949721849041576887560731018902390530686828028312945809877884568294648915735, 7838396004\r\n4691199607349080946738357045163442094918920687129393... (msg truncated)\r\n2021-08-26T10:16:30.587000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_feefilter(feerate=000003e8)\r\n2021-08-26T10:16:30.634000Z TestFramework.p2p (DEBUG): Send message to 127.0.0.1:15188: msg_ping(nonce=00000001)\r\n2021-08-26T10:16:30.635000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_pong(nonce=00000001)\r\n2021-08-26T10:16:30.686000Z TestFramework.p2p (DEBUG): Connecting to Bitcoin Node: 127.0.0.1:15188\r\n2021-08-26T10:16:30.687000Z TestFramework.p2p (DEBUG): Connected & Listening: 127.0.0.1:15188\r\n2021-08-26T10:16:30.687000Z TestFramework.p2p (DEBUG): Send message to 127.0.0.1:15188: msg_version(nVersion=70016 nServices=9 nTime=Thu Aug 26 12:16:30 2021 addrTo=CAddress(nServices=1 net=IPv4 addr=127.0.0.1 port=15188) addrFrom=CAddress(nServices=1 net=IPv4 addr=0.0.0\r\n.0 port=0) nNonce=0xCDE1539BE4DD0287 strSubVer=/python-p2p-tester:0.0.3/ nStartingHeight=-1 relay=1)\r\n2021-08-26T10:16:30.688000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_version(nVersion=70016 nServices=1033 nTime=Thu Aug 26 12:56:27 2021 addrTo=CAddress(nServices=0 net=IPv4 addr=0.0.0.0 port=0) addrFrom=CAddress(nServices=1033 net=IPv4 addr\r\n=0.0.0.0 port=0) nNonce=0x1BB1500D2D875110 strSubVer=/Satoshi:21.99.0(testnode0)/ nStartingHeight=200 relay=1)\r\n2021-08-26T10:16:30.688000Z TestFramework.p2p (DEBUG): Send message to 127.0.0.1:15188: msg_verack()\r\n2021-08-26T10:16:30.689000Z TestFramework.p2p (DEBUG): Send message to 127.0.0.1:15188: msg_getaddr()\r\n2021-08-26T10:16:30.689000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_wtxidrelay()\r\n2021-08-26T10:16:30.689000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_sendaddrv2()\r\n2021-08-26T10:16:30.689000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_verack()\r\n2021-08-26T10:16:30.689000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_sendheaders()\r\n2021-08-26T10:16:30.690000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_sendcmpct(announce=False, version=2)\r\n2021-08-26T10:16:30.690000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_sendcmpct(announce=False, version=1)\r\n2021-08-26T10:16:30.690000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_ping(nonce=ce6d7861bf58d32e)\r\n2021-08-26T10:16:30.690000Z TestFramework.p2p (DEBUG): Send message to 127.0.0.1:15188: msg_pong(nonce=ce6d7861bf58d32e)\r\n2021-08-26T10:16:30.690000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_getheaders(locator=CBlockLocator(vHave=[23807444962857534591630102868443165169099872195127563234000810727149388982010, 447397901073913437177306182676806822084817164934125609\r\n01130905383743091755536, 12663556118629435951519719937229071722250511777495500151983207830672125396536, 44153859904987177378521432406456967833959290357169379249027894378362945782348, 6949721849041576887560731018902390530686828028312945809877884568294648915735, 7838396004\r\n4691199607349080946738357045163442094918920687129393... (msg truncated)\r\n2021-08-26T10:16:30.690000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_feefilter(feerate=000003e8)\r\n2021-08-26T10:16:30.737000Z TestFramework.p2p (DEBUG): Send message to 127.0.0.1:15188: msg_ping(nonce=00000001)\r\n2021-08-26T10:16:30.738000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_pong(nonce=00000001)\r\n2021-08-26T10:16:30.790000Z TestFramework.p2p (DEBUG): Connecting to Bitcoin Node: 127.0.0.1:15188\r\n2021-08-26T10:16:30.791000Z TestFramework.p2p (DEBUG): Connected & Listening: 127.0.0.1:15188\r\n2021-08-26T10:16:30.791000Z TestFramework.p2p (DEBUG): Send message to 127.0.0.1:15188: msg_version(nVersion=70016 nServices=9 nTime=Thu Aug 26 12:16:30 2021 addrTo=CAddress(nServices=1 net=IPv4 addr=127.0.0.1 port=15188) addrFrom=CAddress(nServices=1 net=IPv4 addr=0.0.0\r\n.0 port=0) nNonce=0xC03B06A32F1618AC strSubVer=/python-p2p-tester:0.0.3/ nStartingHeight=-1 relay=1)\r\n2021-08-26T10:16:30.792000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_version(nVersion=70016 nServices=1033 nTime=Thu Aug 26 12:56:27 2021 addrTo=CAddress(nServices=0 net=IPv4 addr=0.0.0.0 port=0) addrFrom=CAddress(nServices=1033 net=IPv4 addr\r\n=0.0.0.0 port=0) nNonce=0x162B7EC1F6F7DD53 strSubVer=/Satoshi:21.99.0(testnode0)/ nStartingHeight=200 relay=1)\r\n2021-08-26T10:16:30.792000Z TestFramework.p2p (DEBUG): Send message to 127.0.0.1:15188: msg_verack()\r\n2021-08-26T10:16:30.792000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_wtxidrelay()\r\n2021-08-26T10:16:30.793000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_sendaddrv2()\r\n2021-08-26T10:16:30.793000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_verack()\r\n2021-08-26T10:16:30.793000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_sendheaders()\r\n2021-08-26T10:16:30.793000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_sendcmpct(announce=False, version=2)\r\n2021-08-26T10:16:30.793000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_sendcmpct(announce=False, version=1)\r\n2021-08-26T10:16:30.793000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_ping(nonce=d1be045bb8729d13)\r\n2021-08-26T10:16:30.794000Z TestFramework.p2p (DEBUG): Send message to 127.0.0.1:15188: msg_pong(nonce=d1be045bb8729d13)\r\n2021-08-26T10:16:30.794000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_getheaders(locator=CBlockLocator(vHave=[23807444962857534591630102868443165169099872195127563234000810727149388982010, 447397901073913437177306182676806822084817164934125609\r\n01130905383743091755536, 12663556118629435951519719937229071722250511777495500151983207830672125396536, 44153859904987177378521432406456967833959290357169379249027894378362945782348, 6949721849041576887560731018902390530686828028312945809877884568294648915735, 7838396004\r\n4691199607349080946738357045163442094918920687129393... (msg truncated)\r\n2021-08-26T10:16:30.794000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_feefilter(feerate=000003e8)\r\n2021-08-26T10:16:30.841000Z TestFramework.p2p (DEBUG): Send message to 127.0.0.1:15188: msg_ping(nonce=00000001)\r\n2021-08-26T10:16:30.842000Z TestFramework.p2p (DEBUG): Received message from 127.0.0.1:15188: msg_pong(nonce=00000001)\r\n2021-08-26T10:16:30.895000Z TestFramework (ERROR): Key error\r\nTraceback (most recent call last):\r\n  File \"/home/nourou/bitcoin/test/functional/test_framework/test_framework.py\", line 131, in main\r\n    self.run_test()\r\n  File \"p2p_addr_relay.py\", line 86, in run_test\r\n    self.inbound_blackhole_tests()\r\n  File \"p2p_addr_relay.py\", line 214, in inbound_blackhole_tests\r\n    assert_equal(peerinfo[0]['addr_relay_enabled'], True)  # addr_source\r\nKeyError: 'addr_relay_enabled'\r\n2021-08-26T10:16:30.937000Z TestFramework (DEBUG): Closing down network thread\r\n2021-08-26T10:16:30.988000Z TestFramework (INFO): Stopping nodes\r\n2021-08-26T10:16:30.989000Z TestFramework.node0 (DEBUG): Stopping node\r\n2021-08-26T10:16:31.417000Z TestFramework.node0 (DEBUG): Node stopped\r\n2021-08-26T10:16:31.417000Z TestFramework (WARNING): Not cleaning up dir /tmp/bitcoin_func_test_tbpvrrpg\r\n2021-08-26T10:16:31.418000Z TestFramework (ERROR): Test failed. Test logging available at /tmp/bitcoin_func_test_tbpvrrpg/test_framework.log\r\n\r\n",
   "closed_at" : "2021-08-27T19:01:55Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/43266768?v=4",
      "events_url" : "https://api.github.com/users/nourou4them/events{/privacy}",
      "followers_url" : "https://api.github.com/users/nourou4them/followers",
      "following_url" : "https://api.github.com/users/nourou4them/following{/other_user}",
      "gists_url" : "https://api.github.com/users/nourou4them/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/nourou4them",
      "id" : 43266768,
      "login" : "nourou4them",
      "node_id" : "MDQ6VXNlcjQzMjY2NzY4",
      "organizations_url" : "https://api.github.com/users/nourou4them/orgs",
      "received_events_url" : "https://api.github.com/users/nourou4them/received_events",
      "repos_url" : "https://api.github.com/users/nourou4them/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/nourou4them/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/nourou4them/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/nourou4them"
   },
   "comments" : 5,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22819/comments",
   "created_at" : "2021-08-27T13:54:55Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22819/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/22819",
   "id" : 981275717,
   "labels" : [],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22819/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWU5ODEyNzU3MTc=",
   "number" : 22819,
   "performed_via_github_app" : null,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "test: Test failed when running p2p_addr_relay.py",
   "updated_at" : "2021-08-27T19:01:55Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22819",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/43266768?v=4",
      "events_url" : "https://api.github.com/users/nourou4them/events{/privacy}",
      "followers_url" : "https://api.github.com/users/nourou4them/followers",
      "following_url" : "https://api.github.com/users/nourou4them/following{/other_user}",
      "gists_url" : "https://api.github.com/users/nourou4them/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/nourou4them",
      "id" : 43266768,
      "login" : "nourou4them",
      "node_id" : "MDQ6VXNlcjQzMjY2NzY4",
      "organizations_url" : "https://api.github.com/users/nourou4them/orgs",
      "received_events_url" : "https://api.github.com/users/nourou4them/received_events",
      "repos_url" : "https://api.github.com/users/nourou4them/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/nourou4them/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/nourou4them/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/nourou4them"
   }
}
