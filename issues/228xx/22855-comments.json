[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#22539](https://github.com/bitcoin/bitcoin/pull/22539) (Re-include RBF replacement txs in fee estimation by darosior)\n* [#22290](https://github.com/bitcoin/bitcoin/pull/22290) (Package Mempool Submission with Package Fee-Bumping by glozow)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-09-02T02:12:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22855#issuecomment-911042249",
      "id" : 911042249,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22855",
      "node_id" : "IC_kwDOABII5842TWbJ",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-16T00:11:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/911042249",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22855#discussion_r706010269"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22855"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706010269"
         }
      },
      "author_association" : "MEMBER",
      "body" : "a few lines up: Could also fixup the whitespace after the refactors in 2/3? https://github.com/bitcoin/bitcoin/pull/22675#pullrequestreview-747002094",
      "commit_id" : "3cf46f6055f7cd2e5da81e0d29cafc51ad4aafba",
      "created_at" : "2021-09-10T08:48:43Z",
      "diff_hunk" : "@@ -57,17 +57,18 @@ std::optional<std::string> GetEntriesForConflicts(const CTransaction& tx,\n     uint64_t nConflictingCount = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22855#discussion_r706010269",
      "id" : 706010269,
      "line" : 57,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjAxMDI2OQ==",
      "original_commit_id" : "7c48d198f9a561f2b342464ea0d00e5d79d2f5d5",
      "original_line" : 57,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : 13,
      "pull_request_review_id" : 751188757,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22855",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-10T08:48:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706010269",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22855#discussion_r706039953"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22855"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706039953"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Oh right! Done, sorry I missed that",
      "commit_id" : "3cf46f6055f7cd2e5da81e0d29cafc51ad4aafba",
      "created_at" : "2021-09-10T09:33:15Z",
      "diff_hunk" : "@@ -57,17 +57,18 @@ std::optional<std::string> GetEntriesForConflicts(const CTransaction& tx,\n     uint64_t nConflictingCount = 0;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22855#discussion_r706039953",
      "id" : 706039953,
      "in_reply_to_id" : 706010269,
      "line" : 57,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjAzOTk1Mw==",
      "original_commit_id" : "7c48d198f9a561f2b342464ea0d00e5d79d2f5d5",
      "original_line" : 57,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : 13,
      "pull_request_review_id" : 751227653,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22855",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-10T09:33:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706039953",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. While you're tidying up might as well add all the missing `<std>` headers to `policy/rbf.*`, and `MAX_BIP125_RBF_SEQUENCE` can be constexpr.",
      "created_at" : "2021-09-10T13:55:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22855#issuecomment-916923327",
      "id" : 916923327,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22855",
      "node_id" : "IC_kwDOABII5842pyO_",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-10T13:55:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/916923327",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22855#discussion_r706506966"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22855"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706506966"
         }
      },
      "author_association" : "MEMBER",
      "body" : "micro-nit \"by opting out of their single-owned input\". If the input spent is 2-of-2 like LN's commitment you should check that counterparty's signature is covering a RBF-signaling `nSequence` field.",
      "commit_id" : "3cf46f6055f7cd2e5da81e0d29cafc51ad4aafba",
      "created_at" : "2021-09-10T22:48:15Z",
      "diff_hunk" : "@@ -17,7 +17,7 @@ static const uint32_t MAX_BIP125_RBF_SEQUENCE = 0xfffffffd;\n *\n * SEQUENCE_FINAL-1 is picked to still allow use of nLockTime by non-replaceable transactions. All\n * inputs rather than just one is for the sake of multi-party protocols, where we don't want a single\n-* party to be able to disable replacement. */\n-bool SignalsOptInRBF(const CTransaction &tx);\n+* party to be able to disable replacement by opting out in their own input. */",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22855#discussion_r706506966",
      "id" : 706506966,
      "line" : 20,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjUwNjk2Ng==",
      "original_commit_id" : "3cf46f6055f7cd2e5da81e0d29cafc51ad4aafba",
      "original_line" : 20,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/util/rbf.h",
      "position" : 6,
      "pull_request_review_id" : 751842422,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22855",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-10T23:10:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706506966",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22855#discussion_r706513387"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22855"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706513387"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think it would interesting to add a comment noting that this higher-feerate than any directly replaced transactions it's not part of the BIP. \r\n\r\nAlso I think this check might bounce-off higher-fee transactions than the replaced one if the conflict transaction has a higher feerate. Let's say a 2_000 vb/10_000 sats replacement vs a 100 vb/8_000 sats conflicts. Without entering in a discussion on the miner block strategy, this is at lest consistent with `BlockAssembler::addPackageTxs` which is selecting packages on feerate.",
      "commit_id" : "3cf46f6055f7cd2e5da81e0d29cafc51ad4aafba",
      "created_at" : "2021-09-10T23:10:04Z",
      "diff_hunk" : "@@ -771,39 +771,43 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, Workspace& ws)\n     // pathological case by making sure setConflicts and setAncestors don't\n     // intersect.\n     if (const auto err_string{EntriesAndTxidsDisjoint(setAncestors, setConflicts, hash)}) {\n+        // We classify this as a consensus error because a transaction depending on something it\n+        // conflicts with would be inconsistent.\n         return state.Invalid(TxValidationResult::TX_CONSENSUS, \"bad-txns-spends-conflicting-tx\", *err_string);\n     }\n \n \n-    // If we don't hold the lock allConflicting might be incomplete; the\n-    // subsequent RemoveStaged() and addUnchecked() calls don't guarantee\n-    // mempool consistency for us.\n     fReplacementTransaction = setConflicts.size();\n-    if (fReplacementTransaction)\n-    {\n+    if (fReplacementTransaction) {\n         CFeeRate newFeeRate(nModifiedFees, nSize);\n+        // It's possible that the replacement pays more fees than its direct conflicts but not more\n+        // than all conflicts (i.e. the direct conflicts have high-fee descendants). However, if the\n+        // replacement doesn't pay more fees than its direct conflicts, then we can be sure it's not\n+        // more economically rational to mine. Before we go digging through the mempool for all\n+        // transactions that would need to be removed (direct conflicts and all descendants), check\n+        // that the replacement transaction pays more than its direct conflicts.\n         if (const auto err_string{PaysMoreThanConflicts(setIterConflicting, newFeeRate, hash)}) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22855#discussion_r706513387",
      "id" : 706513387,
      "line" : 789,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjUxMzM4Nw==",
      "original_commit_id" : "3cf46f6055f7cd2e5da81e0d29cafc51ad4aafba",
      "original_line" : 789,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 24,
      "pull_request_review_id" : 751842422,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22855",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-10T23:10:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706513387",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22855#discussion_r706513499"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22855"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706513499"
         }
      },
      "author_association" : "MEMBER",
      "body" : "See https://github.com/bitcoin/bitcoin/pull/22675#discussion_r706498561",
      "commit_id" : "3cf46f6055f7cd2e5da81e0d29cafc51ad4aafba",
      "created_at" : "2021-09-10T23:10:32Z",
      "diff_hunk" : "@@ -150,24 +151,26 @@ std::optional<std::string> PaysMoreThanConflicts(const CTxMemPool::setEntries& i\n std::optional<std::string> PaysForRBF(CAmount original_fees,\n                                       CAmount replacement_fees,\n                                       size_t replacement_vsize,\n+                                      CFeeRate relay_fee,\n                                       const uint256& txid)\n {\n-    // The replacement must pay greater fees than the transactions it\n-    // replaces - if we did the bandwidth used by those conflicting\n-    // transactions would not be paid for.\n+    // BIP125 Rule #3: The replacement fees must be greater than or equal to fees of the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22855#discussion_r706513499",
      "id" : 706513499,
      "line" : 157,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjUxMzQ5OQ==",
      "original_commit_id" : "3cf46f6055f7cd2e5da81e0d29cafc51ad4aafba",
      "original_line" : 157,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : 80,
      "pull_request_review_id" : 751842422,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22855",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-10T23:10:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706513499",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22855#discussion_r709055840"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22855"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709055840"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> I think it would interesting to add a comment noting that this higher-feerate than any directly replaced transactions it's not part of the BIP.\r\n\r\nI thought that's what I was doing by adding this comment :sweat_smile: but if you have a more specific wording suggestion I'd be happy to add!",
      "commit_id" : "3cf46f6055f7cd2e5da81e0d29cafc51ad4aafba",
      "created_at" : "2021-09-15T10:31:14Z",
      "diff_hunk" : "@@ -771,39 +771,43 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, Workspace& ws)\n     // pathological case by making sure setConflicts and setAncestors don't\n     // intersect.\n     if (const auto err_string{EntriesAndTxidsDisjoint(setAncestors, setConflicts, hash)}) {\n+        // We classify this as a consensus error because a transaction depending on something it\n+        // conflicts with would be inconsistent.\n         return state.Invalid(TxValidationResult::TX_CONSENSUS, \"bad-txns-spends-conflicting-tx\", *err_string);\n     }\n \n \n-    // If we don't hold the lock allConflicting might be incomplete; the\n-    // subsequent RemoveStaged() and addUnchecked() calls don't guarantee\n-    // mempool consistency for us.\n     fReplacementTransaction = setConflicts.size();\n-    if (fReplacementTransaction)\n-    {\n+    if (fReplacementTransaction) {\n         CFeeRate newFeeRate(nModifiedFees, nSize);\n+        // It's possible that the replacement pays more fees than its direct conflicts but not more\n+        // than all conflicts (i.e. the direct conflicts have high-fee descendants). However, if the\n+        // replacement doesn't pay more fees than its direct conflicts, then we can be sure it's not\n+        // more economically rational to mine. Before we go digging through the mempool for all\n+        // transactions that would need to be removed (direct conflicts and all descendants), check\n+        // that the replacement transaction pays more than its direct conflicts.\n         if (const auto err_string{PaysMoreThanConflicts(setIterConflicting, newFeeRate, hash)}) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22855#discussion_r709055840",
      "id" : 709055840,
      "in_reply_to_id" : 706513387,
      "line" : 789,
      "node_id" : "PRRC_kwDOABII584qQ1Vg",
      "original_commit_id" : "3cf46f6055f7cd2e5da81e0d29cafc51ad4aafba",
      "original_line" : 789,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 24,
      "pull_request_review_id" : 754944662,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22855",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-15T10:31:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709055840",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22855#discussion_r709063025"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22855"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709063025"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "https://github.com/bitcoin/bitcoin/pull/22675#discussion_r709062666",
      "commit_id" : "3cf46f6055f7cd2e5da81e0d29cafc51ad4aafba",
      "created_at" : "2021-09-15T10:42:05Z",
      "diff_hunk" : "@@ -150,24 +151,26 @@ std::optional<std::string> PaysMoreThanConflicts(const CTxMemPool::setEntries& i\n std::optional<std::string> PaysForRBF(CAmount original_fees,\n                                       CAmount replacement_fees,\n                                       size_t replacement_vsize,\n+                                      CFeeRate relay_fee,\n                                       const uint256& txid)\n {\n-    // The replacement must pay greater fees than the transactions it\n-    // replaces - if we did the bandwidth used by those conflicting\n-    // transactions would not be paid for.\n+    // BIP125 Rule #3: The replacement fees must be greater than or equal to fees of the",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22855#discussion_r709063025",
      "id" : 709063025,
      "in_reply_to_id" : 706513499,
      "line" : 157,
      "node_id" : "PRRC_kwDOABII584qQ3Fx",
      "original_commit_id" : "3cf46f6055f7cd2e5da81e0d29cafc51ad4aafba",
      "original_line" : 157,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "src/policy/rbf.cpp",
      "position" : 80,
      "pull_request_review_id" : 754954266,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22855",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-09-15T10:42:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/709063025",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK",
      "created_at" : "2021-09-16T18:49:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22855#issuecomment-921156618",
      "id" : 921156618,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22855",
      "node_id" : "IC_kwDOABII584257wK",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-16T18:49:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/921156618",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for the reviews, addressed comments",
      "created_at" : "2021-09-21T09:54:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22855#issuecomment-923820328",
      "id" : 923820328,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/22855",
      "node_id" : "IC_kwDOABII5843EGEo",
      "performed_via_github_app" : null,
      "updated_at" : "2021-09-21T09:54:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/923820328",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22855#discussion_r777130441"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22855"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/777130441"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sorry for the late review note, but I think this comment is confusing: in `PaysMoreThanConflicts()` we're checking that the *feerate* of the new transaction is higher than its direct conflicts, not that the total *fees* paid are higher (eg if the new transaction is smaller, the feerate could be higher but the total fees paid can be lower).",
      "commit_id" : "0ef08f8bed537435f3f9db1e38b7d6f3551fe830",
      "created_at" : "2022-01-01T18:58:16Z",
      "diff_hunk" : "@@ -771,39 +771,43 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, Workspace& ws)\n     // pathological case by making sure setConflicts and setAncestors don't\n     // intersect.\n     if (const auto err_string{EntriesAndTxidsDisjoint(setAncestors, setConflicts, hash)}) {\n+        // We classify this as a consensus error because a transaction depending on something it\n+        // conflicts with would be inconsistent.\n         return state.Invalid(TxValidationResult::TX_CONSENSUS, \"bad-txns-spends-conflicting-tx\", *err_string);\n     }\n \n \n-    // If we don't hold the lock allConflicting might be incomplete; the\n-    // subsequent RemoveStaged() and addUnchecked() calls don't guarantee\n-    // mempool consistency for us.\n     fReplacementTransaction = setConflicts.size();\n-    if (fReplacementTransaction)\n-    {\n+    if (fReplacementTransaction) {\n         CFeeRate newFeeRate(nModifiedFees, nSize);\n+        // It's possible that the replacement pays more fees than its direct conflicts but not more\n+        // than all conflicts (i.e. the direct conflicts have high-fee descendants). However, if the\n+        // replacement doesn't pay more fees than its direct conflicts, then we can be sure it's not\n+        // more economically rational to mine. Before we go digging through the mempool for all\n+        // transactions that would need to be removed (direct conflicts and all descendants), check\n+        // that the replacement transaction pays more than its direct conflicts.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22855#discussion_r777130441",
      "id" : 777130441,
      "line" : 788,
      "node_id" : "PRRC_kwDOABII584uUhHJ",
      "original_commit_id" : "0ef08f8bed537435f3f9db1e38b7d6f3551fe830",
      "original_line" : 788,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 23,
      "pull_request_review_id" : 842354011,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22855",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/777130441/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-01T18:58:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/777130441",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/22855#discussion_r778215831"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22855"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/778215831"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah thank you, I should have said feerate.\r\n\r\nI also misinterpreted the purpose of the code - I was thinking of mining scores=ancestor feerate so I assumed it was an incomplete-but-early-exit check. Based on the context you provided (https://github.com/bitcoin/bitcoin/pull/23121#pullrequestreview-842354501), this was checking that the replacement is a better mining candidate based on the block template code at the time. I'll update this comment to reflect that.",
      "commit_id" : "0ef08f8bed537435f3f9db1e38b7d6f3551fe830",
      "created_at" : "2022-01-04T16:25:50Z",
      "diff_hunk" : "@@ -771,39 +771,43 @@ bool MemPoolAccept::PreChecks(ATMPArgs& args, Workspace& ws)\n     // pathological case by making sure setConflicts and setAncestors don't\n     // intersect.\n     if (const auto err_string{EntriesAndTxidsDisjoint(setAncestors, setConflicts, hash)}) {\n+        // We classify this as a consensus error because a transaction depending on something it\n+        // conflicts with would be inconsistent.\n         return state.Invalid(TxValidationResult::TX_CONSENSUS, \"bad-txns-spends-conflicting-tx\", *err_string);\n     }\n \n \n-    // If we don't hold the lock allConflicting might be incomplete; the\n-    // subsequent RemoveStaged() and addUnchecked() calls don't guarantee\n-    // mempool consistency for us.\n     fReplacementTransaction = setConflicts.size();\n-    if (fReplacementTransaction)\n-    {\n+    if (fReplacementTransaction) {\n         CFeeRate newFeeRate(nModifiedFees, nSize);\n+        // It's possible that the replacement pays more fees than its direct conflicts but not more\n+        // than all conflicts (i.e. the direct conflicts have high-fee descendants). However, if the\n+        // replacement doesn't pay more fees than its direct conflicts, then we can be sure it's not\n+        // more economically rational to mine. Before we go digging through the mempool for all\n+        // transactions that would need to be removed (direct conflicts and all descendants), check\n+        // that the replacement transaction pays more than its direct conflicts.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/22855#discussion_r778215831",
      "id" : 778215831,
      "in_reply_to_id" : 777130441,
      "line" : 788,
      "node_id" : "PRRC_kwDOABII584uYqGX",
      "original_commit_id" : "0ef08f8bed537435f3f9db1e38b7d6f3551fe830",
      "original_line" : 788,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 23,
      "pull_request_review_id" : 843758629,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/22855",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/778215831/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-04T16:25:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/778215831",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   }
]
