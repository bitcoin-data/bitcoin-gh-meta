{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "MEMBER",
   "body" : "While trying to debug the apparent deadlock revealed in https://github.com/bitcoin/bitcoin/pull/12873, I realized it'd be nice to have the `POTENTIAL DEADLOCK DETECTED` message display which thread acquired each lock. I also think it'd be generally useful to have log lines display the name of the originating thread.\r\n\r\nThis changeset does both of those things by introducing a class which manages thread naming, `ThreadNameRegistry`. The class abstracts process-control calls responsible for thread naming and provides automatic number suffixing to threads which use the same name (e.g. `httpworker.0`, `httpworker.1`, ...).\r\n\r\nWith this patch, thread names look like this\r\n\r\n```\r\n $ pstree -p `pgrep bitcoind`\r\n\r\nbitcoind(3415)ââ¬â{addcon}(3465)\r\n               ââ{httpworker.0}(3454)\r\n               ââ{httpworker.1}(3455)\r\n               ââ{httpworker.2}(3456)\r\n               ââ{httpworker.3}(3457)\r\n               ââ{http}(3453)\r\n               ââ{msghand}(3467)\r\n               ââ{net}(3463)\r\n               ââ{opencon}(3466)\r\n               ââ{scheduler}(3452)\r\n               ââ{scriptch.0}(3445)\r\n               ââ{scriptch.1}(3446)\r\n               ââ{scriptch.2}(3447)\r\n               ââ{scriptch.3}(3448)\r\n               ââ{scriptch.4}(3449)\r\n               ââ{scriptch.5}(3450)\r\n               ââ{scriptch.6}(3451)\r\n               ââ{torcontrol}(3462)\r\n```\r\nand the debug log looks like this\r\n```\r\n2018-04-26T21:54:23Z [bitcoind] init message: Loading wallet...\r\n2018-04-26T21:54:24Z [bitcoind] mapBlockIndex.size() = 1\r\n2018-04-26T21:54:24Z [bitcoind] nBestHeight = 0\r\n2018-04-26T21:54:24Z [loadblk] Imported mempool transactions from disk: 0 succeeded, 0 failed, 0 expired, 0 already there\r\n2018-04-26T21:54:24Z [torcontrol] torcontrol thread start\r\n2018-04-26T21:54:24Z [bitcoind] Bound to [::]:18444\r\n2018-04-26T21:54:24Z [torcontrol] tor: Error connecting to Tor control socket\r\n2018-04-26T21:54:24Z [torcontrol] tor: Not connected to Tor control port 127.0.0.1:9051, trying to reconnect\r\n2018-04-26T21:54:24Z [bitcoind] Bound to 0.0.0.0:18444\r\n2018-04-26T21:54:24Z [bitcoind] init message: Loading P2P addresses...\r\n2018-04-26T21:54:24Z [bitcoind] Loaded 0 addresses from peers.dat  0ms\r\n2018-04-26T21:54:24Z [dnsseed] dnsseed thread start\r\n2018-04-26T21:54:24Z [bitcoind] init message: Done loading\r\n2018-04-26T21:54:24Z [addcon] addcon thread start\r\n2018-04-26T21:54:24Z [dnsseed] Loading addresses from DNS seeds (could take a while)\r\n2018-04-26T21:54:24Z [net] net thread start\r\n2018-04-26T21:54:24Z [dnsseed] 0 addresses found from DNS seeds\r\n2018-04-26T21:54:24Z [dnsseed] dnsseed thread exit\r\n2018-04-26T21:54:24Z [msghand] msghand thread start\r\n2018-04-26T21:54:24Z [opencon] opencon thread start\r\n2018-04-26T21:54:25Z [torcontrol] tor: Error connecting to Tor control socket\r\n2018-04-26T21:54:25Z [torcontrol] tor: Not connected to Tor control port 127.0.0.1:9051, trying to reconnect\r\n```\r\n\r\nNote that child thread names have changed; I'm no longer using the `bitcoin-` prefix. Because we're limited to 16 characters for thread name (on Linux, anyway), that prefix was causing the numeric suffix some names have to be hidden. If it's desirable to keep the prefix, I can revert this change.\r\n\r\n#### Implementation considerations\r\n\r\nA basic version of this change could be done pretty trivially with something like \r\n```cpp\r\nthread_local std::string threadname;\r\n```\r\nbut per @theuni (https://github.com/bitcoin/bitcoin/pull/11722#pullrequestreview-79322658), we can't rely on having `thread_local`. Also note that with a basic implementation like that, we wouldn't be able to do the automatic numbering scheme to differentiate between threads with the same basename (e.g. `httpworker`, `scriptch`).\r\n\r\nWe could also rely solely on thread-related system calls. I don't like this much either because of [how poorly defined or unavailable `getname` is on some platforms](https://stackoverflow.com/a/7989973), e.g. OS X, FreeBSD; not to mention the 16 character limit.\r\n\r\n#### Tests\r\n\r\n~~If this gets a Concept ACK or two, I'll implement some.~~ Unittests attached.\r\n\r\n",
   "closed_at" : "2018-05-03T21:20:26Z",
   "closed_by" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
      "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
      "followers_url" : "https://api.github.com/users/jamesob/followers",
      "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/jamesob",
      "id" : 73197,
      "login" : "jamesob",
      "node_id" : "MDQ6VXNlcjczMTk3",
      "organizations_url" : "https://api.github.com/users/jamesob/orgs",
      "received_events_url" : "https://api.github.com/users/jamesob/received_events",
      "repos_url" : "https://api.github.com/users/jamesob/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/jamesob"
   },
   "comments" : 17,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13099/comments",
   "created_at" : "2018-04-26T22:22:37Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13099/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099",
   "id" : 318217430,
   "labels" : [
      {
         "color" : "E6F6D6",
         "default" : false,
         "id" : 135961,
         "name" : "Refactoring",
         "node_id" : "MDU6TGFiZWwxMzU5NjE=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Refactoring"
      },
      {
         "color" : "5319e7",
         "default" : false,
         "id" : 241832923,
         "name" : "Utils/log/libs",
         "node_id" : "MDU6TGFiZWwyNDE4MzI5MjM=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Utils/log/libs"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13099/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDExOlB1bGxSZXF1ZXN0MTg0NDc5NzIw",
   "number" : 13099,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/13099.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099",
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/13099.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13099"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "Use thread names in logs and deadlock diagnostics",
   "updated_at" : "2018-05-05T17:59:08Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13099",
   "user" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
      "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
      "followers_url" : "https://api.github.com/users/jamesob/followers",
      "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/jamesob",
      "id" : 73197,
      "login" : "jamesob",
      "node_id" : "MDQ6VXNlcjczMTk3",
      "organizations_url" : "https://api.github.com/users/jamesob/orgs",
      "received_events_url" : "https://api.github.com/users/jamesob/received_events",
      "repos_url" : "https://api.github.com/users/jamesob/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/jamesob"
   }
}
