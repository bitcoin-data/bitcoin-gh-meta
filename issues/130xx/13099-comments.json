[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13099#discussion_r184548289"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13099"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184548289"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is there somewhere more general or useful I should put the two functions in this namespace?",
      "commit_id" : "8379557572b9261bf317cf35550781341c2ff06f",
      "created_at" : "2018-04-26T22:25:14Z",
      "diff_hunk" : "@@ -0,0 +1,144 @@\n+// Copyright (c) 2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <threadnames.h>\n+#include <tinyformat.h>\n+\n+#include <boost/thread.hpp>\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h> // For HAVE_SYS_PRCTL_H\n+#endif\n+\n+#if (defined(__FreeBSD__) || defined(__OpenBSD__) || defined(__DragonFly__))\n+#include <pthread.h>\n+#include <pthread_np.h>\n+#endif\n+\n+#ifdef HAVE_SYS_PRCTL_H\n+#include <sys/prctl.h> // For prctl, PR_SET_NAME\n+#endif\n+\n+\n+extern int LogPrintStr(const std::string &str);\n+\n+std::unique_ptr<ThreadNameRegistry> g_thread_name_registry(new ThreadNameRegistry());\n+\n+namespace {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#discussion_r184548289",
      "id" : 184548289,
      "original_commit_id" : "121002fddf40b9c667f962ab40b5d7a5223d4cb4",
      "original_position" : 28,
      "path" : "src/threadnames.cpp",
      "position" : null,
      "pull_request_review_id" : 115769336,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13099",
      "updated_at" : "2018-04-27T16:30:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184548289",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13099#discussion_r184548394"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13099"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184548394"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Remove or uncomment this block before merge.",
      "commit_id" : "8379557572b9261bf317cf35550781341c2ff06f",
      "created_at" : "2018-04-26T22:25:48Z",
      "diff_hunk" : "@@ -0,0 +1,144 @@\n+// Copyright (c) 2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <threadnames.h>\n+#include <tinyformat.h>\n+\n+#include <boost/thread.hpp>\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h> // For HAVE_SYS_PRCTL_H\n+#endif\n+\n+#if (defined(__FreeBSD__) || defined(__OpenBSD__) || defined(__DragonFly__))\n+#include <pthread.h>\n+#include <pthread_np.h>\n+#endif\n+\n+#ifdef HAVE_SYS_PRCTL_H\n+#include <sys/prctl.h> // For prctl, PR_SET_NAME\n+#endif\n+\n+\n+extern int LogPrintStr(const std::string &str);\n+\n+std::unique_ptr<ThreadNameRegistry> g_thread_name_registry(new ThreadNameRegistry());\n+\n+namespace {\n+\n+/**\n+ * @return true if `to_check` is prefixed with `prefix`.\n+ */\n+bool HasPrefix(const std::string& to_check, const std::string& prefix) {\n+    return to_check.compare(0, prefix.size(), prefix) == 0;\n+}\n+\n+/**\n+ * Count the number of entries in a map with a given prefix.\n+ *\n+ * @return The number of occurrences of keys with the given prefix.\n+ */\n+template <class T>\n+int CountMapPrefixes(T map, const std::string& prefix) {\n+    auto it = map.lower_bound(prefix);\n+    int count = 0;\n+\n+    while (it != map.end() && HasPrefix(it->first, prefix)) {\n+        ++it; ++count;\n+    }\n+\n+    return count;\n+}\n+\n+} // namespace\n+\n+bool ThreadNameRegistry::Register(std::string name, bool expect_multiple)\n+{\n+    std::lock_guard<std::mutex> guard(m_map_lock);\n+\n+    if (expect_multiple) {\n+        name = tfm::format(\"%s.%d\", name, CountMapPrefixes(m_name_to_id, name));\n+    }\n+\n+    std::string process_name(name);\n+\n+    /*\n+     * Uncomment if we want to retain the `bitcoin-` system thread name prefix.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#discussion_r184548394",
      "id" : 184548394,
      "original_commit_id" : "121002fddf40b9c667f962ab40b5d7a5223d4cb4",
      "original_position" : 67,
      "path" : "src/threadnames.cpp",
      "position" : 67,
      "pull_request_review_id" : 115769466,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13099",
      "updated_at" : "2018-04-27T16:30:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184548394",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13099#discussion_r184627159"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13099"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184627159"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Should lock mutex.",
      "commit_id" : "8379557572b9261bf317cf35550781341c2ff06f",
      "created_at" : "2018-04-27T08:46:16Z",
      "diff_hunk" : "@@ -0,0 +1,144 @@\n+// Copyright (c) 2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <threadnames.h>\n+#include <tinyformat.h>\n+\n+#include <boost/thread.hpp>\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h> // For HAVE_SYS_PRCTL_H\n+#endif\n+\n+#if (defined(__FreeBSD__) || defined(__OpenBSD__) || defined(__DragonFly__))\n+#include <pthread.h>\n+#include <pthread_np.h>\n+#endif\n+\n+#ifdef HAVE_SYS_PRCTL_H\n+#include <sys/prctl.h> // For prctl, PR_SET_NAME\n+#endif\n+\n+\n+extern int LogPrintStr(const std::string &str);\n+\n+std::unique_ptr<ThreadNameRegistry> g_thread_names(new ThreadNameRegistry());\n+\n+namespace {\n+\n+/**\n+ * @return true if `to_check` is prefixed with `prefix`.\n+ */\n+bool HasPrefix(const std::string& to_check, const std::string& prefix) {\n+    return to_check.compare(0, prefix.size(), prefix) == 0;\n+}\n+\n+/**\n+ * Count the number of entries in a map with a given prefix.\n+ *\n+ * @return The number of occurrences of keys with the given prefix.\n+ */\n+template <class T>\n+int CountMapPrefixes(T map, const std::string& prefix) {\n+    auto it = map.lower_bound(prefix);\n+    int count = 0;\n+\n+    while (it != map.end() && HasPrefix(it->first, prefix)) {\n+        ++it; ++count;\n+    }\n+\n+    return count;\n+}\n+\n+} // namespace\n+\n+bool ThreadNameRegistry::Rename(std::string name, bool expect_multiple)\n+{\n+    std::lock_guard<std::mutex> guard(m_map_lock);\n+\n+    if (expect_multiple) {\n+        name = tfm::format(\"%s.%d\", name, CountMapPrefixes(m_name_to_id, name));\n+    }\n+\n+    std::string process_name(name);\n+\n+    /*\n+     * Uncomment if we want to retain the `bitcoin-` system thread name prefix.\n+     *\n+    const std::string process_prefix(\"bitcoin-\");\n+    if (!HasPrefix(process_name, process_prefix)) {\n+        process_name = process_prefix + process_name;\n+    }\n+    */\n+\n+    RenameProcessThread(process_name.c_str());\n+\n+    auto thread_id = boost::this_thread::get_id();\n+    auto it_name = m_name_to_id.find(name);\n+    auto it_id = m_id_to_name.find(thread_id);\n+\n+    // Don't allow name collisions.\n+    if (it_name != m_name_to_id.end() && it_name->second != thread_id) {\n+        std::stringstream errmsg; // stringstream use necessary to get thread_id into a string.\n+        errmsg << \"Thread name '\" << name << \"' already registered (id: \" << it_name->second << \")\\n\";\n+        LogPrintStr(errmsg.str());\n+        return false;\n+    }\n+    // Warn on reregistration.\n+    else if (it_id != m_id_to_name.end()) {\n+        std::stringstream warnmsg;\n+        warnmsg << \"Reregistering thread \" << thread_id << \" with name '%s'; previously was '%s'\\n\";\n+        LogPrintStr(tfm::format(warnmsg.str().c_str(), name, it_id->second));\n+    }\n+\n+    m_id_to_name[thread_id] = name;\n+    m_name_to_id[name] = thread_id;\n+    return true;\n+}\n+\n+const std::string& ThreadNameRegistry::GetThreadName()\n+{\n+    auto thread_id = boost::this_thread::get_id();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#discussion_r184627159",
      "id" : 184627159,
      "original_commit_id" : "fcfba12253e67b635b56fc41173cb90ef60645c3",
      "original_position" : 102,
      "path" : "src/threadnames.cpp",
      "position" : null,
      "pull_request_review_id" : 115862133,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13099",
      "updated_at" : "2018-04-27T16:30:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184627159",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13099#discussion_r184627393"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13099"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184627393"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This could be a static function or a function in a anonymous namespace.",
      "commit_id" : "8379557572b9261bf317cf35550781341c2ff06f",
      "created_at" : "2018-04-27T08:47:31Z",
      "diff_hunk" : "@@ -0,0 +1,144 @@\n+// Copyright (c) 2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <threadnames.h>\n+#include <tinyformat.h>\n+\n+#include <boost/thread.hpp>\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h> // For HAVE_SYS_PRCTL_H\n+#endif\n+\n+#if (defined(__FreeBSD__) || defined(__OpenBSD__) || defined(__DragonFly__))\n+#include <pthread.h>\n+#include <pthread_np.h>\n+#endif\n+\n+#ifdef HAVE_SYS_PRCTL_H\n+#include <sys/prctl.h> // For prctl, PR_SET_NAME\n+#endif\n+\n+\n+extern int LogPrintStr(const std::string &str);\n+\n+std::unique_ptr<ThreadNameRegistry> g_thread_names(new ThreadNameRegistry());\n+\n+namespace {\n+\n+/**\n+ * @return true if `to_check` is prefixed with `prefix`.\n+ */\n+bool HasPrefix(const std::string& to_check, const std::string& prefix) {\n+    return to_check.compare(0, prefix.size(), prefix) == 0;\n+}\n+\n+/**\n+ * Count the number of entries in a map with a given prefix.\n+ *\n+ * @return The number of occurrences of keys with the given prefix.\n+ */\n+template <class T>\n+int CountMapPrefixes(T map, const std::string& prefix) {\n+    auto it = map.lower_bound(prefix);\n+    int count = 0;\n+\n+    while (it != map.end() && HasPrefix(it->first, prefix)) {\n+        ++it; ++count;\n+    }\n+\n+    return count;\n+}\n+\n+} // namespace\n+\n+bool ThreadNameRegistry::Rename(std::string name, bool expect_multiple)\n+{\n+    std::lock_guard<std::mutex> guard(m_map_lock);\n+\n+    if (expect_multiple) {\n+        name = tfm::format(\"%s.%d\", name, CountMapPrefixes(m_name_to_id, name));\n+    }\n+\n+    std::string process_name(name);\n+\n+    /*\n+     * Uncomment if we want to retain the `bitcoin-` system thread name prefix.\n+     *\n+    const std::string process_prefix(\"bitcoin-\");\n+    if (!HasPrefix(process_name, process_prefix)) {\n+        process_name = process_prefix + process_name;\n+    }\n+    */\n+\n+    RenameProcessThread(process_name.c_str());\n+\n+    auto thread_id = boost::this_thread::get_id();\n+    auto it_name = m_name_to_id.find(name);\n+    auto it_id = m_id_to_name.find(thread_id);\n+\n+    // Don't allow name collisions.\n+    if (it_name != m_name_to_id.end() && it_name->second != thread_id) {\n+        std::stringstream errmsg; // stringstream use necessary to get thread_id into a string.\n+        errmsg << \"Thread name '\" << name << \"' already registered (id: \" << it_name->second << \")\\n\";\n+        LogPrintStr(errmsg.str());\n+        return false;\n+    }\n+    // Warn on reregistration.\n+    else if (it_id != m_id_to_name.end()) {\n+        std::stringstream warnmsg;\n+        warnmsg << \"Reregistering thread \" << thread_id << \" with name '%s'; previously was '%s'\\n\";\n+        LogPrintStr(tfm::format(warnmsg.str().c_str(), name, it_id->second));\n+    }\n+\n+    m_id_to_name[thread_id] = name;\n+    m_name_to_id[name] = thread_id;\n+    return true;\n+}\n+\n+const std::string& ThreadNameRegistry::GetThreadName()\n+{\n+    auto thread_id = boost::this_thread::get_id();\n+    auto found = m_id_to_name.find(thread_id);\n+\n+    if (found != m_id_to_name.end()) {\n+        return found->second;\n+    } else {\n+        auto insert_ret = m_id_to_name.emplace(thread_id, GetProcessThreadName());\n+        return insert_ret.first->second;\n+    }\n+}\n+\n+void ThreadNameRegistry::RenameProcessThread(const char* name)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#discussion_r184627393",
      "id" : 184627393,
      "original_commit_id" : "fcfba12253e67b635b56fc41173cb90ef60645c3",
      "original_position" : 113,
      "path" : "src/threadnames.cpp",
      "position" : null,
      "pull_request_review_id" : 115862133,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13099",
      "updated_at" : "2018-04-27T16:30:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184627393",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13099#discussion_r184627453"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13099"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184627453"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This could be a static function or a function in a anonymous namespace.",
      "commit_id" : "8379557572b9261bf317cf35550781341c2ff06f",
      "created_at" : "2018-04-27T08:47:49Z",
      "diff_hunk" : "@@ -0,0 +1,144 @@\n+// Copyright (c) 2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <threadnames.h>\n+#include <tinyformat.h>\n+\n+#include <boost/thread.hpp>\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h> // For HAVE_SYS_PRCTL_H\n+#endif\n+\n+#if (defined(__FreeBSD__) || defined(__OpenBSD__) || defined(__DragonFly__))\n+#include <pthread.h>\n+#include <pthread_np.h>\n+#endif\n+\n+#ifdef HAVE_SYS_PRCTL_H\n+#include <sys/prctl.h> // For prctl, PR_SET_NAME\n+#endif\n+\n+\n+extern int LogPrintStr(const std::string &str);\n+\n+std::unique_ptr<ThreadNameRegistry> g_thread_names(new ThreadNameRegistry());\n+\n+namespace {\n+\n+/**\n+ * @return true if `to_check` is prefixed with `prefix`.\n+ */\n+bool HasPrefix(const std::string& to_check, const std::string& prefix) {\n+    return to_check.compare(0, prefix.size(), prefix) == 0;\n+}\n+\n+/**\n+ * Count the number of entries in a map with a given prefix.\n+ *\n+ * @return The number of occurrences of keys with the given prefix.\n+ */\n+template <class T>\n+int CountMapPrefixes(T map, const std::string& prefix) {\n+    auto it = map.lower_bound(prefix);\n+    int count = 0;\n+\n+    while (it != map.end() && HasPrefix(it->first, prefix)) {\n+        ++it; ++count;\n+    }\n+\n+    return count;\n+}\n+\n+} // namespace\n+\n+bool ThreadNameRegistry::Rename(std::string name, bool expect_multiple)\n+{\n+    std::lock_guard<std::mutex> guard(m_map_lock);\n+\n+    if (expect_multiple) {\n+        name = tfm::format(\"%s.%d\", name, CountMapPrefixes(m_name_to_id, name));\n+    }\n+\n+    std::string process_name(name);\n+\n+    /*\n+     * Uncomment if we want to retain the `bitcoin-` system thread name prefix.\n+     *\n+    const std::string process_prefix(\"bitcoin-\");\n+    if (!HasPrefix(process_name, process_prefix)) {\n+        process_name = process_prefix + process_name;\n+    }\n+    */\n+\n+    RenameProcessThread(process_name.c_str());\n+\n+    auto thread_id = boost::this_thread::get_id();\n+    auto it_name = m_name_to_id.find(name);\n+    auto it_id = m_id_to_name.find(thread_id);\n+\n+    // Don't allow name collisions.\n+    if (it_name != m_name_to_id.end() && it_name->second != thread_id) {\n+        std::stringstream errmsg; // stringstream use necessary to get thread_id into a string.\n+        errmsg << \"Thread name '\" << name << \"' already registered (id: \" << it_name->second << \")\\n\";\n+        LogPrintStr(errmsg.str());\n+        return false;\n+    }\n+    // Warn on reregistration.\n+    else if (it_id != m_id_to_name.end()) {\n+        std::stringstream warnmsg;\n+        warnmsg << \"Reregistering thread \" << thread_id << \" with name '%s'; previously was '%s'\\n\";\n+        LogPrintStr(tfm::format(warnmsg.str().c_str(), name, it_id->second));\n+    }\n+\n+    m_id_to_name[thread_id] = name;\n+    m_name_to_id[name] = thread_id;\n+    return true;\n+}\n+\n+const std::string& ThreadNameRegistry::GetThreadName()\n+{\n+    auto thread_id = boost::this_thread::get_id();\n+    auto found = m_id_to_name.find(thread_id);\n+\n+    if (found != m_id_to_name.end()) {\n+        return found->second;\n+    } else {\n+        auto insert_ret = m_id_to_name.emplace(thread_id, GetProcessThreadName());\n+        return insert_ret.first->second;\n+    }\n+}\n+\n+void ThreadNameRegistry::RenameProcessThread(const char* name)\n+{\n+#if defined(PR_SET_NAME)\n+    // Only the first 15 characters are used (16 - NUL terminator)\n+    ::prctl(PR_SET_NAME, name, 0, 0, 0);\n+#elif (defined(__FreeBSD__) || defined(__OpenBSD__) || defined(__DragonFly__))\n+    pthread_set_name_np(pthread_self(), name);\n+\n+#elif defined(MAC_OSX)\n+    pthread_setname_np(name);\n+#else\n+    // Prevent warnings for unused parameters...\n+    (void)name;\n+#endif\n+}\n+\n+std::string ThreadNameRegistry::GetProcessThreadName()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#discussion_r184627453",
      "id" : 184627453,
      "original_commit_id" : "fcfba12253e67b635b56fc41173cb90ef60645c3",
      "original_position" : 129,
      "path" : "src/threadnames.cpp",
      "position" : null,
      "pull_request_review_id" : 115862133,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13099",
      "updated_at" : "2018-04-27T16:30:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184627453",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13099#discussion_r184627560"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13099"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184627560"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Argument could be `const std::string& name`?",
      "commit_id" : "8379557572b9261bf317cf35550781341c2ff06f",
      "created_at" : "2018-04-27T08:48:18Z",
      "diff_hunk" : "@@ -0,0 +1,144 @@\n+// Copyright (c) 2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <threadnames.h>\n+#include <tinyformat.h>\n+\n+#include <boost/thread.hpp>\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h> // For HAVE_SYS_PRCTL_H\n+#endif\n+\n+#if (defined(__FreeBSD__) || defined(__OpenBSD__) || defined(__DragonFly__))\n+#include <pthread.h>\n+#include <pthread_np.h>\n+#endif\n+\n+#ifdef HAVE_SYS_PRCTL_H\n+#include <sys/prctl.h> // For prctl, PR_SET_NAME\n+#endif\n+\n+\n+extern int LogPrintStr(const std::string &str);\n+\n+std::unique_ptr<ThreadNameRegistry> g_thread_names(new ThreadNameRegistry());\n+\n+namespace {\n+\n+/**\n+ * @return true if `to_check` is prefixed with `prefix`.\n+ */\n+bool HasPrefix(const std::string& to_check, const std::string& prefix) {\n+    return to_check.compare(0, prefix.size(), prefix) == 0;\n+}\n+\n+/**\n+ * Count the number of entries in a map with a given prefix.\n+ *\n+ * @return The number of occurrences of keys with the given prefix.\n+ */\n+template <class T>\n+int CountMapPrefixes(T map, const std::string& prefix) {\n+    auto it = map.lower_bound(prefix);\n+    int count = 0;\n+\n+    while (it != map.end() && HasPrefix(it->first, prefix)) {\n+        ++it; ++count;\n+    }\n+\n+    return count;\n+}\n+\n+} // namespace\n+\n+bool ThreadNameRegistry::Rename(std::string name, bool expect_multiple)\n+{\n+    std::lock_guard<std::mutex> guard(m_map_lock);\n+\n+    if (expect_multiple) {\n+        name = tfm::format(\"%s.%d\", name, CountMapPrefixes(m_name_to_id, name));\n+    }\n+\n+    std::string process_name(name);\n+\n+    /*\n+     * Uncomment if we want to retain the `bitcoin-` system thread name prefix.\n+     *\n+    const std::string process_prefix(\"bitcoin-\");\n+    if (!HasPrefix(process_name, process_prefix)) {\n+        process_name = process_prefix + process_name;\n+    }\n+    */\n+\n+    RenameProcessThread(process_name.c_str());\n+\n+    auto thread_id = boost::this_thread::get_id();\n+    auto it_name = m_name_to_id.find(name);\n+    auto it_id = m_id_to_name.find(thread_id);\n+\n+    // Don't allow name collisions.\n+    if (it_name != m_name_to_id.end() && it_name->second != thread_id) {\n+        std::stringstream errmsg; // stringstream use necessary to get thread_id into a string.\n+        errmsg << \"Thread name '\" << name << \"' already registered (id: \" << it_name->second << \")\\n\";\n+        LogPrintStr(errmsg.str());\n+        return false;\n+    }\n+    // Warn on reregistration.\n+    else if (it_id != m_id_to_name.end()) {\n+        std::stringstream warnmsg;\n+        warnmsg << \"Reregistering thread \" << thread_id << \" with name '%s'; previously was '%s'\\n\";\n+        LogPrintStr(tfm::format(warnmsg.str().c_str(), name, it_id->second));\n+    }\n+\n+    m_id_to_name[thread_id] = name;\n+    m_name_to_id[name] = thread_id;\n+    return true;\n+}\n+\n+const std::string& ThreadNameRegistry::GetThreadName()\n+{\n+    auto thread_id = boost::this_thread::get_id();\n+    auto found = m_id_to_name.find(thread_id);\n+\n+    if (found != m_id_to_name.end()) {\n+        return found->second;\n+    } else {\n+        auto insert_ret = m_id_to_name.emplace(thread_id, GetProcessThreadName());\n+        return insert_ret.first->second;\n+    }\n+}\n+\n+void ThreadNameRegistry::RenameProcessThread(const char* name)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#discussion_r184627560",
      "id" : 184627560,
      "in_reply_to_id" : 184627393,
      "original_commit_id" : "fcfba12253e67b635b56fc41173cb90ef60645c3",
      "original_position" : 113,
      "path" : "src/threadnames.cpp",
      "position" : null,
      "pull_request_review_id" : 115862133,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13099",
      "updated_at" : "2018-04-27T16:30:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184627560",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13099#discussion_r184628415"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13099"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184628415"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Shoud also add to `m_name_to_id`?",
      "commit_id" : "8379557572b9261bf317cf35550781341c2ff06f",
      "created_at" : "2018-04-27T08:52:03Z",
      "diff_hunk" : "@@ -0,0 +1,144 @@\n+// Copyright (c) 2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <threadnames.h>\n+#include <tinyformat.h>\n+\n+#include <boost/thread.hpp>\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h> // For HAVE_SYS_PRCTL_H\n+#endif\n+\n+#if (defined(__FreeBSD__) || defined(__OpenBSD__) || defined(__DragonFly__))\n+#include <pthread.h>\n+#include <pthread_np.h>\n+#endif\n+\n+#ifdef HAVE_SYS_PRCTL_H\n+#include <sys/prctl.h> // For prctl, PR_SET_NAME\n+#endif\n+\n+\n+extern int LogPrintStr(const std::string &str);\n+\n+std::unique_ptr<ThreadNameRegistry> g_thread_names(new ThreadNameRegistry());\n+\n+namespace {\n+\n+/**\n+ * @return true if `to_check` is prefixed with `prefix`.\n+ */\n+bool HasPrefix(const std::string& to_check, const std::string& prefix) {\n+    return to_check.compare(0, prefix.size(), prefix) == 0;\n+}\n+\n+/**\n+ * Count the number of entries in a map with a given prefix.\n+ *\n+ * @return The number of occurrences of keys with the given prefix.\n+ */\n+template <class T>\n+int CountMapPrefixes(T map, const std::string& prefix) {\n+    auto it = map.lower_bound(prefix);\n+    int count = 0;\n+\n+    while (it != map.end() && HasPrefix(it->first, prefix)) {\n+        ++it; ++count;\n+    }\n+\n+    return count;\n+}\n+\n+} // namespace\n+\n+bool ThreadNameRegistry::Rename(std::string name, bool expect_multiple)\n+{\n+    std::lock_guard<std::mutex> guard(m_map_lock);\n+\n+    if (expect_multiple) {\n+        name = tfm::format(\"%s.%d\", name, CountMapPrefixes(m_name_to_id, name));\n+    }\n+\n+    std::string process_name(name);\n+\n+    /*\n+     * Uncomment if we want to retain the `bitcoin-` system thread name prefix.\n+     *\n+    const std::string process_prefix(\"bitcoin-\");\n+    if (!HasPrefix(process_name, process_prefix)) {\n+        process_name = process_prefix + process_name;\n+    }\n+    */\n+\n+    RenameProcessThread(process_name.c_str());\n+\n+    auto thread_id = boost::this_thread::get_id();\n+    auto it_name = m_name_to_id.find(name);\n+    auto it_id = m_id_to_name.find(thread_id);\n+\n+    // Don't allow name collisions.\n+    if (it_name != m_name_to_id.end() && it_name->second != thread_id) {\n+        std::stringstream errmsg; // stringstream use necessary to get thread_id into a string.\n+        errmsg << \"Thread name '\" << name << \"' already registered (id: \" << it_name->second << \")\\n\";\n+        LogPrintStr(errmsg.str());\n+        return false;\n+    }\n+    // Warn on reregistration.\n+    else if (it_id != m_id_to_name.end()) {\n+        std::stringstream warnmsg;\n+        warnmsg << \"Reregistering thread \" << thread_id << \" with name '%s'; previously was '%s'\\n\";\n+        LogPrintStr(tfm::format(warnmsg.str().c_str(), name, it_id->second));\n+    }\n+\n+    m_id_to_name[thread_id] = name;\n+    m_name_to_id[name] = thread_id;\n+    return true;\n+}\n+\n+const std::string& ThreadNameRegistry::GetThreadName()\n+{\n+    auto thread_id = boost::this_thread::get_id();\n+    auto found = m_id_to_name.find(thread_id);\n+\n+    if (found != m_id_to_name.end()) {\n+        return found->second;\n+    } else {\n+        auto insert_ret = m_id_to_name.emplace(thread_id, GetProcessThreadName());\n+        return insert_ret.first->second;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#discussion_r184628415",
      "id" : 184628415,
      "original_commit_id" : "fcfba12253e67b635b56fc41173cb90ef60645c3",
      "original_position" : 109,
      "path" : "src/threadnames.cpp",
      "position" : null,
      "pull_request_review_id" : 115862133,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13099",
      "updated_at" : "2018-04-27T16:30:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184628415",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13099#discussion_r184628534"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13099"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184628534"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why return reference?",
      "commit_id" : "8379557572b9261bf317cf35550781341c2ff06f",
      "created_at" : "2018-04-27T08:52:37Z",
      "diff_hunk" : "@@ -0,0 +1,50 @@\n+// Copyright (c) 2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_THREADNAMES_H\n+#define BITCOIN_THREADNAMES_H\n+\n+#include <map>\n+#include <mutex>\n+\n+#include <boost/thread.hpp>\n+\n+\n+/**\n+ * Keeps a map of thread IDs to string names and handles system-level thread naming.\n+ */\n+class ThreadNameRegistry\n+{\n+public:\n+    const std::string& GetThreadName();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#discussion_r184628534",
      "id" : 184628534,
      "original_commit_id" : "fcfba12253e67b635b56fc41173cb90ef60645c3",
      "original_position" : 20,
      "path" : "src/threadnames.h",
      "position" : null,
      "pull_request_review_id" : 115862133,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13099",
      "updated_at" : "2018-04-27T16:30:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184628534",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/3534524?v=4",
         "events_url" : "https://api.github.com/users/promag/events{/privacy}",
         "followers_url" : "https://api.github.com/users/promag/followers",
         "following_url" : "https://api.github.com/users/promag/following{/other_user}",
         "gists_url" : "https://api.github.com/users/promag/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/promag",
         "id" : 3534524,
         "login" : "promag",
         "organizations_url" : "https://api.github.com/users/promag/orgs",
         "received_events_url" : "https://api.github.com/users/promag/received_events",
         "repos_url" : "https://api.github.com/users/promag/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/promag/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/promag/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/promag"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13099#discussion_r184710702"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13099"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184710702"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good catch, thanks. ",
      "commit_id" : "8379557572b9261bf317cf35550781341c2ff06f",
      "created_at" : "2018-04-27T14:49:05Z",
      "diff_hunk" : "@@ -0,0 +1,144 @@\n+// Copyright (c) 2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <threadnames.h>\n+#include <tinyformat.h>\n+\n+#include <boost/thread.hpp>\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h> // For HAVE_SYS_PRCTL_H\n+#endif\n+\n+#if (defined(__FreeBSD__) || defined(__OpenBSD__) || defined(__DragonFly__))\n+#include <pthread.h>\n+#include <pthread_np.h>\n+#endif\n+\n+#ifdef HAVE_SYS_PRCTL_H\n+#include <sys/prctl.h> // For prctl, PR_SET_NAME\n+#endif\n+\n+\n+extern int LogPrintStr(const std::string &str);\n+\n+std::unique_ptr<ThreadNameRegistry> g_thread_names(new ThreadNameRegistry());\n+\n+namespace {\n+\n+/**\n+ * @return true if `to_check` is prefixed with `prefix`.\n+ */\n+bool HasPrefix(const std::string& to_check, const std::string& prefix) {\n+    return to_check.compare(0, prefix.size(), prefix) == 0;\n+}\n+\n+/**\n+ * Count the number of entries in a map with a given prefix.\n+ *\n+ * @return The number of occurrences of keys with the given prefix.\n+ */\n+template <class T>\n+int CountMapPrefixes(T map, const std::string& prefix) {\n+    auto it = map.lower_bound(prefix);\n+    int count = 0;\n+\n+    while (it != map.end() && HasPrefix(it->first, prefix)) {\n+        ++it; ++count;\n+    }\n+\n+    return count;\n+}\n+\n+} // namespace\n+\n+bool ThreadNameRegistry::Rename(std::string name, bool expect_multiple)\n+{\n+    std::lock_guard<std::mutex> guard(m_map_lock);\n+\n+    if (expect_multiple) {\n+        name = tfm::format(\"%s.%d\", name, CountMapPrefixes(m_name_to_id, name));\n+    }\n+\n+    std::string process_name(name);\n+\n+    /*\n+     * Uncomment if we want to retain the `bitcoin-` system thread name prefix.\n+     *\n+    const std::string process_prefix(\"bitcoin-\");\n+    if (!HasPrefix(process_name, process_prefix)) {\n+        process_name = process_prefix + process_name;\n+    }\n+    */\n+\n+    RenameProcessThread(process_name.c_str());\n+\n+    auto thread_id = boost::this_thread::get_id();\n+    auto it_name = m_name_to_id.find(name);\n+    auto it_id = m_id_to_name.find(thread_id);\n+\n+    // Don't allow name collisions.\n+    if (it_name != m_name_to_id.end() && it_name->second != thread_id) {\n+        std::stringstream errmsg; // stringstream use necessary to get thread_id into a string.\n+        errmsg << \"Thread name '\" << name << \"' already registered (id: \" << it_name->second << \")\\n\";\n+        LogPrintStr(errmsg.str());\n+        return false;\n+    }\n+    // Warn on reregistration.\n+    else if (it_id != m_id_to_name.end()) {\n+        std::stringstream warnmsg;\n+        warnmsg << \"Reregistering thread \" << thread_id << \" with name '%s'; previously was '%s'\\n\";\n+        LogPrintStr(tfm::format(warnmsg.str().c_str(), name, it_id->second));\n+    }\n+\n+    m_id_to_name[thread_id] = name;\n+    m_name_to_id[name] = thread_id;\n+    return true;\n+}\n+\n+const std::string& ThreadNameRegistry::GetThreadName()\n+{\n+    auto thread_id = boost::this_thread::get_id();\n+    auto found = m_id_to_name.find(thread_id);\n+\n+    if (found != m_id_to_name.end()) {\n+        return found->second;\n+    } else {\n+        auto insert_ret = m_id_to_name.emplace(thread_id, GetProcessThreadName());\n+        return insert_ret.first->second;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#discussion_r184710702",
      "id" : 184710702,
      "in_reply_to_id" : 184628415,
      "original_commit_id" : "fcfba12253e67b635b56fc41173cb90ef60645c3",
      "original_position" : 109,
      "path" : "src/threadnames.cpp",
      "position" : null,
      "pull_request_review_id" : 115966694,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13099",
      "updated_at" : "2018-04-27T16:30:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184710702",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thoughts on pulling the `TraceThread` class out of util into the new files you're creating here? Seems like a good home for tracethread and would reduce the clutter in util",
      "created_at" : "2018-04-27T14:49:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#issuecomment-384993376",
      "id" : 384993376,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13099",
      "updated_at" : "2018-04-27T14:49:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/384993376",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/195769?v=4",
         "events_url" : "https://api.github.com/users/skeees/events{/privacy}",
         "followers_url" : "https://api.github.com/users/skeees/followers",
         "following_url" : "https://api.github.com/users/skeees/following{/other_user}",
         "gists_url" : "https://api.github.com/users/skeees/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/skeees",
         "id" : 195769,
         "login" : "skeees",
         "organizations_url" : "https://api.github.com/users/skeees/orgs",
         "received_events_url" : "https://api.github.com/users/skeees/received_events",
         "repos_url" : "https://api.github.com/users/skeees/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/skeees/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/skeees/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/skeees"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13099#discussion_r184718471"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13099"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184718471"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'd like to be able to unittest the `*Process*` functions eventually, so maybe I should just make them public.",
      "commit_id" : "8379557572b9261bf317cf35550781341c2ff06f",
      "created_at" : "2018-04-27T15:14:02Z",
      "diff_hunk" : "@@ -0,0 +1,144 @@\n+// Copyright (c) 2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <threadnames.h>\n+#include <tinyformat.h>\n+\n+#include <boost/thread.hpp>\n+\n+#if defined(HAVE_CONFIG_H)\n+#include <config/bitcoin-config.h> // For HAVE_SYS_PRCTL_H\n+#endif\n+\n+#if (defined(__FreeBSD__) || defined(__OpenBSD__) || defined(__DragonFly__))\n+#include <pthread.h>\n+#include <pthread_np.h>\n+#endif\n+\n+#ifdef HAVE_SYS_PRCTL_H\n+#include <sys/prctl.h> // For prctl, PR_SET_NAME\n+#endif\n+\n+\n+extern int LogPrintStr(const std::string &str);\n+\n+std::unique_ptr<ThreadNameRegistry> g_thread_names(new ThreadNameRegistry());\n+\n+namespace {\n+\n+/**\n+ * @return true if `to_check` is prefixed with `prefix`.\n+ */\n+bool HasPrefix(const std::string& to_check, const std::string& prefix) {\n+    return to_check.compare(0, prefix.size(), prefix) == 0;\n+}\n+\n+/**\n+ * Count the number of entries in a map with a given prefix.\n+ *\n+ * @return The number of occurrences of keys with the given prefix.\n+ */\n+template <class T>\n+int CountMapPrefixes(T map, const std::string& prefix) {\n+    auto it = map.lower_bound(prefix);\n+    int count = 0;\n+\n+    while (it != map.end() && HasPrefix(it->first, prefix)) {\n+        ++it; ++count;\n+    }\n+\n+    return count;\n+}\n+\n+} // namespace\n+\n+bool ThreadNameRegistry::Rename(std::string name, bool expect_multiple)\n+{\n+    std::lock_guard<std::mutex> guard(m_map_lock);\n+\n+    if (expect_multiple) {\n+        name = tfm::format(\"%s.%d\", name, CountMapPrefixes(m_name_to_id, name));\n+    }\n+\n+    std::string process_name(name);\n+\n+    /*\n+     * Uncomment if we want to retain the `bitcoin-` system thread name prefix.\n+     *\n+    const std::string process_prefix(\"bitcoin-\");\n+    if (!HasPrefix(process_name, process_prefix)) {\n+        process_name = process_prefix + process_name;\n+    }\n+    */\n+\n+    RenameProcessThread(process_name.c_str());\n+\n+    auto thread_id = boost::this_thread::get_id();\n+    auto it_name = m_name_to_id.find(name);\n+    auto it_id = m_id_to_name.find(thread_id);\n+\n+    // Don't allow name collisions.\n+    if (it_name != m_name_to_id.end() && it_name->second != thread_id) {\n+        std::stringstream errmsg; // stringstream use necessary to get thread_id into a string.\n+        errmsg << \"Thread name '\" << name << \"' already registered (id: \" << it_name->second << \")\\n\";\n+        LogPrintStr(errmsg.str());\n+        return false;\n+    }\n+    // Warn on reregistration.\n+    else if (it_id != m_id_to_name.end()) {\n+        std::stringstream warnmsg;\n+        warnmsg << \"Reregistering thread \" << thread_id << \" with name '%s'; previously was '%s'\\n\";\n+        LogPrintStr(tfm::format(warnmsg.str().c_str(), name, it_id->second));\n+    }\n+\n+    m_id_to_name[thread_id] = name;\n+    m_name_to_id[name] = thread_id;\n+    return true;\n+}\n+\n+const std::string& ThreadNameRegistry::GetThreadName()\n+{\n+    auto thread_id = boost::this_thread::get_id();\n+    auto found = m_id_to_name.find(thread_id);\n+\n+    if (found != m_id_to_name.end()) {\n+        return found->second;\n+    } else {\n+        auto insert_ret = m_id_to_name.emplace(thread_id, GetProcessThreadName());\n+        return insert_ret.first->second;\n+    }\n+}\n+\n+void ThreadNameRegistry::RenameProcessThread(const char* name)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#discussion_r184718471",
      "id" : 184718471,
      "in_reply_to_id" : 184627393,
      "original_commit_id" : "fcfba12253e67b635b56fc41173cb90ef60645c3",
      "original_position" : 113,
      "path" : "src/threadnames.cpp",
      "position" : null,
      "pull_request_review_id" : 115976185,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13099",
      "updated_at" : "2018-04-27T16:30:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/184718471",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK",
      "created_at" : "2018-04-27T16:18:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#issuecomment-385020386",
      "id" : 385020386,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13099",
      "updated_at" : "2018-04-27T16:18:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/385020386",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@promag thanks for the review; I've pushed changes incorporating your feedback.\r\n\r\n@skeees I like that idea but maybe we can save it for a future PR? That entails changing a bunch of call sites and I'm worried about introducing a circular dependency between util and threadnames (by way of logging).",
      "created_at" : "2018-04-27T17:38:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#issuecomment-385042045",
      "id" : 385042045,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13099",
      "updated_at" : "2018-04-27T17:38:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/385042045",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "How does the use of boost::thread::id interact with eventual boost::thread removal? IIRC there was something about no guarantees being made that you can interact with boost::thread if the thread was started by std, though it usually works in practice. We do have a HAVE_THREAD_LOCAL defined, which should be set everywhere but OSX, so maybe we could just turn it on there if boost::thread::id is an issue?",
      "created_at" : "2018-04-28T00:40:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#issuecomment-385126024",
      "id" : 385126024,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13099",
      "updated_at" : "2018-04-28T00:40:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/385126024",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/649246?v=4",
         "events_url" : "https://api.github.com/users/TheBlueMatt/events{/privacy}",
         "followers_url" : "https://api.github.com/users/TheBlueMatt/followers",
         "following_url" : "https://api.github.com/users/TheBlueMatt/following{/other_user}",
         "gists_url" : "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/TheBlueMatt",
         "id" : 649246,
         "login" : "TheBlueMatt",
         "organizations_url" : "https://api.github.com/users/TheBlueMatt/orgs",
         "received_events_url" : "https://api.github.com/users/TheBlueMatt/received_events",
         "repos_url" : "https://api.github.com/users/TheBlueMatt/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/TheBlueMatt/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/TheBlueMatt"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13099#discussion_r185057629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13099"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185057629"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Bit of a nit, but maybe `m_name_to_id` could instead be a `map<string, int>` - where it just stores the occurrences of that name/prefix, then you don't have to call `CountMapPrefix`, but can just update the count each time. ",
      "commit_id" : "8379557572b9261bf317cf35550781341c2ff06f",
      "created_at" : "2018-04-30T17:46:18Z",
      "diff_hunk" : "@@ -0,0 +1,55 @@\n+// Copyright (c) 2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_THREADNAMES_H\n+#define BITCOIN_THREADNAMES_H\n+\n+#include <map>\n+#include <mutex>\n+\n+#include <boost/thread.hpp>\n+\n+\n+/**\n+ * Keeps a map of thread IDs to string names and handles system-level thread naming.\n+ */\n+class ThreadNameRegistry\n+{\n+public:\n+    /**\n+     * @return the name of the current thread, falling back to the process\n+     *     name if a value has not been explicitly set with Rename.\n+     */\n+    std::string GetName();\n+\n+    /**\n+     * Name the current thread; doesn't allow colliding names unless `expect_multiple` is true.\n+     *\n+     * @param[in] name             The desired name of the process.\n+     * @param[in] expect_multiple  If true, allow name reuse by appending an ordered \".[n]\" suffix\n+     *                             to the given name.\n+     *\n+     * @return true if the name was registered successfully.\n+     */\n+    bool Rename(std::string name, bool expect_multiple = false);\n+\n+    /**\n+     * Rename the current thread at the system level, e.g. `prctrl(PR_SET_NAME, ...)`.\n+     */\n+    void RenameProcess(const char* name);\n+\n+    /**\n+     * @return the system's name for the current thread.\n+     */\n+    std::string GetProcessName();\n+\n+private:\n+    std::mutex m_map_lock;\n+    std::map<boost::thread::id, std::string> m_id_to_name;\n+    std::map<std::string, boost::thread::id> m_name_to_id;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#discussion_r185057629",
      "id" : 185057629,
      "original_commit_id" : "8379557572b9261bf317cf35550781341c2ff06f",
      "original_position" : 50,
      "path" : "src/threadnames.h",
      "position" : 50,
      "pull_request_review_id" : 116373936,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13099",
      "updated_at" : "2018-04-30T17:46:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185057629",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/14220652?v=4",
         "events_url" : "https://api.github.com/users/conscott/events{/privacy}",
         "followers_url" : "https://api.github.com/users/conscott/followers",
         "following_url" : "https://api.github.com/users/conscott/following{/other_user}",
         "gists_url" : "https://api.github.com/users/conscott/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/conscott",
         "id" : 14220652,
         "login" : "conscott",
         "organizations_url" : "https://api.github.com/users/conscott/orgs",
         "received_events_url" : "https://api.github.com/users/conscott/received_events",
         "repos_url" : "https://api.github.com/users/conscott/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/conscott/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/conscott/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/conscott"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK- just a comment on how the maps are used. ",
      "created_at" : "2018-04-30T17:53:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#issuecomment-385476929",
      "id" : 385476929,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13099",
      "updated_at" : "2018-04-30T17:53:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/385476929",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/14220652?v=4",
         "events_url" : "https://api.github.com/users/conscott/events{/privacy}",
         "followers_url" : "https://api.github.com/users/conscott/followers",
         "following_url" : "https://api.github.com/users/conscott/following{/other_user}",
         "gists_url" : "https://api.github.com/users/conscott/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/conscott",
         "id" : 14220652,
         "login" : "conscott",
         "organizations_url" : "https://api.github.com/users/conscott/orgs",
         "received_events_url" : "https://api.github.com/users/conscott/received_events",
         "repos_url" : "https://api.github.com/users/conscott/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/conscott/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/conscott/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/conscott"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/13099#discussion_r185149361"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13099"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185149361"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks for the look and great suggestion. I think maintaining a map of counts will also allow me to remove all of the utility functions in the anonymous namespace - nice catch!",
      "commit_id" : "8379557572b9261bf317cf35550781341c2ff06f",
      "created_at" : "2018-05-01T01:03:11Z",
      "diff_hunk" : "@@ -0,0 +1,55 @@\n+// Copyright (c) 2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_THREADNAMES_H\n+#define BITCOIN_THREADNAMES_H\n+\n+#include <map>\n+#include <mutex>\n+\n+#include <boost/thread.hpp>\n+\n+\n+/**\n+ * Keeps a map of thread IDs to string names and handles system-level thread naming.\n+ */\n+class ThreadNameRegistry\n+{\n+public:\n+    /**\n+     * @return the name of the current thread, falling back to the process\n+     *     name if a value has not been explicitly set with Rename.\n+     */\n+    std::string GetName();\n+\n+    /**\n+     * Name the current thread; doesn't allow colliding names unless `expect_multiple` is true.\n+     *\n+     * @param[in] name             The desired name of the process.\n+     * @param[in] expect_multiple  If true, allow name reuse by appending an ordered \".[n]\" suffix\n+     *                             to the given name.\n+     *\n+     * @return true if the name was registered successfully.\n+     */\n+    bool Rename(std::string name, bool expect_multiple = false);\n+\n+    /**\n+     * Rename the current thread at the system level, e.g. `prctrl(PR_SET_NAME, ...)`.\n+     */\n+    void RenameProcess(const char* name);\n+\n+    /**\n+     * @return the system's name for the current thread.\n+     */\n+    std::string GetProcessName();\n+\n+private:\n+    std::mutex m_map_lock;\n+    std::map<boost::thread::id, std::string> m_id_to_name;\n+    std::map<std::string, boost::thread::id> m_name_to_id;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#discussion_r185149361",
      "id" : 185149361,
      "in_reply_to_id" : 185057629,
      "original_commit_id" : "8379557572b9261bf317cf35550781341c2ff06f",
      "original_position" : 50,
      "path" : "src/threadnames.h",
      "position" : 50,
      "pull_request_review_id" : 116483063,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/13099",
      "updated_at" : "2018-05-01T01:03:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/185149361",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@TheBlueMatt good points, thanks for looking. I've pushed changes which\r\n- only make use of `boost::thread` when `thread_local` is not available. When it is available, we assign each thread a `thread_local`-cached ID based on a static counter.\r\n- incorporate @conscott's suggestion of using `m_name_to_count` which nicely cuts out a bunch of code.\r\n- add tests.\r\n\r\n([jamesob/threadnames.1 -> jamesob/threadnames.3](https://gist.github.com/jamesob/88f7cf082ee0bf97a2411bf8bd120594))\r\n\r\nThis changeset is ready for review-for-merge IMO.\r\n",
      "created_at" : "2018-05-01T18:39:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#issuecomment-385752118",
      "id" : 385752118,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13099",
      "updated_at" : "2018-05-01T18:39:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/385752118",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "OWNER",
      "body" : "@theuni What's the status of `thread_local` on OSX? I remember seeing https://stackoverflow.com/questions/28094794/why-does-apple-clang-disallow-c11-thread-local-when-official-clang-supports, but which Xcode version's patches does our clang run with, or...?",
      "created_at" : "2018-05-01T18:41:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#issuecomment-385752850",
      "id" : 385752850,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13099",
      "updated_at" : "2018-05-01T18:41:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/385752850",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I've pushed a small change removing `GetProcessName` support for *BSD systems. After double-checking `pthread_getname` support for OpenBSD, I found that [it doesn't seem to exist](https://man.openbsd.org/pthreads.3). As a result, any threads which are not explicitly named with `Rename()` will be labeled `\"<unknown>\"` on BSD systems.\r\n\r\n```diff\r\n $ diff -uw <(git diff master..threadnames.3) <(git diff master..threadnames.4)\r\n\r\n--- /proc/self/fd/12    2018-05-01 14:56:59.561313752 -0400\r\n+++ /proc/self/fd/13    2018-05-01 14:56:59.549313568 -0400\r\n@@ -2215,10 +2215,10 @@\r\n      void reset();\r\n diff --git a/src/threadnames.cpp b/src/threadnames.cpp\r\n new file mode 100644\r\n-index 0000000..305c3b4\r\n+index 0000000..92e3f75\r\n --- /dev/null\r\n +++ b/src/threadnames.cpp\r\n-@@ -0,0 +1,135 @@\r\n+@@ -0,0 +1,133 @@\r\n +// Copyright (c) 2018 The Bitcoin Core developers\r\n +// Distributed under the MIT software license, see the accompanying\r\n +// file COPYING or http://www.opensource.org/licenses/mit-license.php.\r\n@@ -2345,8 +2345,6 @@\r\n +\r\n +#if defined(PR_GET_NAME)\r\n +    ::prctl(PR_GET_NAME, pthreadname_buff);\r\n-+#elif (defined(__FreeBSD__) || defined(__OpenBSD__) || defined(__DragonFly__))\r\n-+    pthread_get_name_np(pthread_self(), pthreadname_buff);\r\n +#elif defined(MAC_OSX)\r\n +    pthread_getname_np(pthread_self(), pthreadname_buff, sizeof(threadname_buff));\r\n +#else\r\n```",
      "created_at" : "2018-05-01T18:59:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#issuecomment-385757762",
      "id" : 385757762,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13099",
      "updated_at" : "2018-05-01T18:59:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/385757762",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "After spending the day figuring out that [`thread_local` is apparently broken on mingw32 compilers](https://gist.github.com/jamesob/fe9a872051a88b2025b1aa37bfa98605), I'm now falling back to boost thread IDs for WIN32. Tests are passing and this is once again ready for review.",
      "created_at" : "2018-05-02T21:42:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#issuecomment-386130606",
      "id" : 386130606,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13099",
      "updated_at" : "2018-05-02T21:42:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/386130606",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Per @sipa's advice, I'm now using `std::thread` to determine thread IDs for all platforms instead of either boost or the ham-fisted `thread_local` code.\r\n\r\n[jamesob/threadnames.11 -> jamesob/threadnames.13](https://gist.github.com/jamesob/310427d0590b1790b7601afdf86c09c8)",
      "created_at" : "2018-05-03T13:45:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#issuecomment-386300574",
      "id" : 386300574,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13099",
      "updated_at" : "2018-05-03T13:45:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/386300574",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "If platform-specific functions are being used anyway, why not just use pthread_getspecific/pthread_setspecific, which are meant for exactly this? That also makes it a trivial transition when we're finally ready to use thread_local.",
      "created_at" : "2018-05-03T16:25:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#issuecomment-386354019",
      "id" : 386354019,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13099",
      "updated_at" : "2018-05-03T16:25:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/386354019",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@theuni what are you talking about replacing at this point? We're now platform agnostic with `std::thread`, and it seems to work fine with boost threads. Any reason you can see that it won't work?",
      "created_at" : "2018-05-03T17:45:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#issuecomment-386378854",
      "id" : 386378854,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13099",
      "updated_at" : "2018-05-03T17:45:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/386378854",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jamesob See the top two commits here for a quick attempt: https://github.com/theuni/bitcoin/commits/thread_names\r\n\r\nThat addresses a few things that make me hesitate about this PR:\r\n- system thread id/name are conflated with internal use. This drags in system requirements (name length, for ex) and overhead for internal functions.\r\n- Heavy map lookup with locking. #12970 demonstrated how painful overhead in logging can be.\r\n- Most can go away once we can use thread_local unconditionally.\r\n\r\nI realize that my changes are oversimplified, it's just a quick POC for discussion.",
      "created_at" : "2018-05-03T18:36:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#issuecomment-386394865",
      "id" : 386394865,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13099",
      "updated_at" : "2018-05-03T18:36:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/386394865",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@theuni I think your simple implementation looks great. Very much agree with your concern re: map lookup and locking overhead, and I think there's a way to combine our approaches to avoid it. Let me know if this sounds right:\r\n\r\nIMO lock acquisition during the single `Rename()` call per thread is acceptable, but we want to avoid any subsequent locking during `GetName()` (since it is called per logline). So: during `Rename()` we can use Registry's count map for numeric suffix generation and then use your method for caching the name of the thread for use during `GetName()`.\r\n\r\nIf that sounds good to you, I'll cherry-pick your two commits onto this branch and reorganize accordingly. Otherwise if you think the numeric suffix isn't worthwhile, I'm happy to close this out and proceed on your commits only.",
      "created_at" : "2018-05-03T20:08:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#issuecomment-386420332",
      "id" : 386420332,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13099",
      "updated_at" : "2018-05-03T20:08:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/386420332",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jamesob Looking again, I think handling the suffix at this layer is unnecessary and adds a significant amount of complication. Why not just add a suffix before passing the name into TraceThread() ?",
      "created_at" : "2018-05-03T21:14:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#issuecomment-386438629",
      "id" : 386438629,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13099",
      "updated_at" : "2018-05-03T21:14:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/386438629",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@theuni ugh, you're right, that's dumb. Let's go off of your commits. ",
      "created_at" : "2018-05-03T21:20:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#issuecomment-386440185",
      "id" : 386440185,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13099",
      "updated_at" : "2018-05-03T21:20:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/386440185",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "From IRC:\r\n> \\<cfields\\> jamesob: noo!\r\n\\<cfields\\> jamesob: I hope you don't think I'm being NIH about that PR, that wasn't my intention at all. Coding up an alternative myself helps me to understand the challenges better, it wasn't meant to replace your work.",
      "created_at" : "2018-05-03T21:46:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13099#issuecomment-386447345",
      "id" : 386447345,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13099",
      "updated_at" : "2018-05-03T21:46:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/386447345",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   }
]
