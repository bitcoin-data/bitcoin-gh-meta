[
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r601057629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601057629"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't think there's any need to `SetupAddressRelay` here, and doing so would cause you to continue choosing inbounds that are treating you as block-relay-only instead of ignoring them as a black hole.",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-25T05:32:50Z",
      "diff_hunk" : "@@ -2625,7 +2625,11 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             pfrom.fDisconnect = true;\n             return;\n         }\n-        pfrom.m_wants_addrv2 = true;\n+\n+        if (SetupAddressRelay(pfrom)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r601057629",
      "id" : 601057629,
      "line" : 2629,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTA1NzYyOQ==",
      "original_commit_id" : "cd55b53800ec63b516bdca46bfee0d57e34e3af6",
      "original_line" : 2629,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 52,
      "pull_request_review_id" : 620728925,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T21:03:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601057629",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21515 by naumenkogs\n* #15606 by jamesob\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-03-25T08:54:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-806477418",
      "id" : 806477418,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwNjQ3NzQxOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T22:28:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/806477418",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r601317221"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601317221"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This isn't thread safe. By accessing `m_addr_known` from outside the message handler thread (eg an rpc worker thread or qt), this opens race conditions where `m_addr_known` is being set by the message handler thread and read by an rpc thread concurrently. In such cases, the thread reading the value could see the old value, the new value or garbage.",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-25T10:21:59Z",
      "diff_hunk" : "@@ -611,6 +611,8 @@ void CNode::copyStats(CNodeStats &stats, const std::vector<bool> &m_asmap)\n     stats.addrLocal = addrLocalUnlocked.IsValid() ? addrLocalUnlocked.ToString() : \"\";\n \n     X(m_conn_type);\n+\n+    stats.addr_relay_enabled = RelayAddrsWithConn();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r601317221",
      "id" : 601317221,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTMxNzIyMQ==",
      "original_commit_id" : "ea30030216e1a3456ff609bba7c4d2087940478a",
      "original_line" : 615,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 620941721,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T21:03:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601317221",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r601327487"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601327487"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think it matters much either way. The only peers this affects are inbound block-relay-only connections from v0.21 peers, which (incorrectly) send `sendaddrv2` to us. Inbound block-relay-only peers on v22 won't send `sendaddrv2` because of the change in commit _Stop sending SENDADDRV2 message to block relay only peers_.",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-25T10:30:26Z",
      "diff_hunk" : "@@ -2625,7 +2625,11 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             pfrom.fDisconnect = true;\n             return;\n         }\n-        pfrom.m_wants_addrv2 = true;\n+\n+        if (SetupAddressRelay(pfrom)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r601327487",
      "id" : 601327487,
      "in_reply_to_id" : 601057629,
      "line" : 2629,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTMyNzQ4Nw==",
      "original_commit_id" : "cd55b53800ec63b516bdca46bfee0d57e34e3af6",
      "original_line" : 2629,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 52,
      "pull_request_review_id" : 620941721,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T21:03:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601327487",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r601328295"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601328295"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I suggest you drop these tidy-up changes in _Add some documentation and small style fixes_. They don't seem very related to the rest of the PR :see_no_evil: ",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-25T10:31:11Z",
      "diff_hunk" : "@@ -4243,12 +4279,17 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                     }\n                 }\n             }\n+\n             pto->vAddrToSend.clear();\n-            if (!vAddr.empty())\n+\n+            if (!vAddr.empty()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r601328295",
      "id" : 601328295,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTMyODI5NQ==",
      "original_commit_id" : "ea30030216e1a3456ff609bba7c4d2087940478a",
      "original_line" : 4285,
      "original_position" : 121,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 620941721,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T21:03:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/601328295",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think that an approach like this was first suggested by AJ in https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-527012757:\r\n\r\n> I think since we AdvertiseLocal regularly to our non-block-relay peers, we could just set a flag on the peer if we've ever seen an ADDR message from them, and only choose nodes with that flag in RelayAddress?\r\n\r\nI think it's a good idea, since it stops us relaying addrs to both inbound block-relay-only peers _and_ other kinds of black holes.",
      "created_at" : "2021-03-25T10:36:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-806541067",
      "id" : 806541067,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwNjU0MTA2Nw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-25T10:36:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/806541067",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r603710494"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603710494"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ergh, its annoying that v0.21 peers will send us the `sendaddrv2` message, but I'm not sure if this warrants removing this conditional. some thoughts:\r\n- in terms of protocol & logical coherence, I'd expect `sendaddrv2` to indicate desire that the node wants to participate in addr relay\r\n- in this patch, calling `SetupAddressRelay` for the node mimics the behavior of current master. so I think of calling as the default (rather than the other way around)\r\n- in terms of safety, it seems better to have a blackhole than exclude a peer from address relay.   I think... a blackhole means an address, or set of addresses will not propagate as well this time, but excluding a peer from address relay (esp if programmatically / many peers exclude) means that peer could be at a higher risk of being eclipsed? \r\n\r\nI thought I was on the fence, but writing out this reasoning makes me realize I'd like to leave as is.\r\n\r\nthoughts? ",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T01:05:47Z",
      "diff_hunk" : "@@ -2625,7 +2625,11 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             pfrom.fDisconnect = true;\n             return;\n         }\n-        pfrom.m_wants_addrv2 = true;\n+\n+        if (SetupAddressRelay(pfrom)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r603710494",
      "id" : 603710494,
      "in_reply_to_id" : 601057629,
      "line" : 2629,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzcxMDQ5NA==",
      "original_commit_id" : "cd55b53800ec63b516bdca46bfee0d57e34e3af6",
      "original_line" : 2629,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 52,
      "pull_request_review_id" : 623763694,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T21:03:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603710494",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r603711802"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603711802"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ayo, good catch. it feels like overkill to introduce a lock just to expose a boolean, so I've dropped this commit for now. will some of your addr-in-net-processing refactor will make it so we can do this safely? ",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T01:09:14Z",
      "diff_hunk" : "@@ -611,6 +611,8 @@ void CNode::copyStats(CNodeStats &stats, const std::vector<bool> &m_asmap)\n     stats.addrLocal = addrLocalUnlocked.IsValid() ? addrLocalUnlocked.ToString() : \"\";\n \n     X(m_conn_type);\n+\n+    stats.addr_relay_enabled = RelayAddrsWithConn();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r603711802",
      "id" : 603711802,
      "in_reply_to_id" : 601317221,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzcxMTgwMg==",
      "original_commit_id" : "ea30030216e1a3456ff609bba7c4d2087940478a",
      "original_line" : 615,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 623764905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T21:03:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603711802",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r603713142"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603713142"
         }
      },
      "author_association" : "MEMBER",
      "body" : "sorry I'm not sorry!! I abhor two line if statements, they are great footguns. these changes are pretty trivial, I don't think they would make sense as a stand-alone PR, or that they increase the complexity of review, so I'd rather leave them in.",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T01:13:48Z",
      "diff_hunk" : "@@ -4243,12 +4279,17 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                     }\n                 }\n             }\n+\n             pto->vAddrToSend.clear();\n-            if (!vAddr.empty())\n+\n+            if (!vAddr.empty()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r603713142",
      "id" : 603713142,
      "in_reply_to_id" : 601328295,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzcxMzE0Mg==",
      "original_commit_id" : "ea30030216e1a3456ff609bba7c4d2087940478a",
      "original_line" : 4285,
      "original_position" : 121,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 623766503,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T21:03:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603713142",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "fixed tests & added a test. patch is ready, but leaving as a draft until I gain more confidence that this would not break any other software on the network. \r\n\r\ncompiling a list of other clients & compatibility with this patch: \r\n\r\n<table>\r\n<tr>\r\n\t<td> breadwallet\r\n\t<td> â\r\n\t<td> \r\n\r\nSends `getaddr` & only accepts `addr` messages afterwards ([link](https://github.com/breadwallet/breadwallet-core/blob/develop/bitcoin/BRPeer.c#L283))\r\n\r\n<tr>\r\n\t<td> btcd\r\n\t<td> \r\n\r\nâ Confirmed by @roasbeef ([issue](https://github.com/btcsuite/btcd/issues/1709))\r\n\r\n<td> \r\n\r\nAfter connecting to a new outbound peer, sends `addr` self advertisement, and sometimes sends `getaddr`. Relevant code linked in the issue. \r\n\r\n<tr>\r\n\r\n\r\n<td> libbitcoin \r\n\r\n<td>\r\n\r\nâ Confirmed by @evoskuil ([issue](https://github.com/libbitcoin/libbitcoin-network/issues/251))\r\n\r\n<td>\r\n\r\nWhen connecting to an outbound peer, sends a `getaddr` message. \r\n\r\n\r\n<tr> \r\n\r\n<td> bitcoin knots\r\n\r\n<td> â\r\n\r\n<td> \r\n\r\n\r\nSame behavior as Bitcoin Core, upon receiving a `version` message, sends a `getaddr` to outbound connections unless they are block-relay only, usually also self-advertises. ([link](https://github.com/bitcoinknots/bitcoin/blob/0.21.x-knots/src/net_processing.cpp#L2488))\r\n\r\n<tr>\r\n\r\n<td> bcoin \r\n\r\n<td> \r\n\r\nâ Confirmed by @pinheadmz ([issue](https://github.com/bcoin-org/bcoin/issues/1012)).\r\n\r\n<td>\r\n\r\nUpon opening a connection, node will self-advertise & usually send a `getaddr` message ([link](https://github.com/bcoin-org/bcoin/blob/f1abba52eda16d3981039651d0e0407e0c7fc778/lib/net/pool.js#L1269)).\r\n\r\n<tr>\r\n\r\n<td> gocoin\r\n\r\n<td>\r\n\r\nâ Confirmed by @piotrnar ([issue](https://github.com/piotrnar/gocoin/issues/57))\r\n\r\n<td>\r\n\r\nUpon receipt of a `version` message, node will self-advertise. Node will usually also send a `getaddr` message to peers.\r\n\r\n<tr> \r\n\r\n<td> bitcore\r\n\r\n<td>\r\n\r\nâ Confirmed by @micahriggan ([issue](https://github.com/bitpay/bitcore/issues/3140))\r\n\r\n<td>\r\n\r\nBitcore nodes typically have dedicated bitcoin node(s) and the addresses are passed in via config.\r\n\r\n<tr>\r\n\r\n<td> bitcoinj\r\n\r\n<td>\r\n\r\nâ ([issue](https://github.com/bitcoinj/bitcoinj/issues/2123))\r\n\r\n<td> As part of connecting to a peer, the node will send a `getaddr` message on the link. \r\n\r\n</table>",
      "created_at" : "2021-03-30T04:53:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-809906430",
      "id" : 809906430,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwOTkwNjQzMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-19T21:08:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/809906430",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r603867126"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603867126"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> will some of your addr-in-net-processing refactor will make it so we can do this safely?\r\n\r\nHopefully, yes!",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T07:56:46Z",
      "diff_hunk" : "@@ -611,6 +611,8 @@ void CNode::copyStats(CNodeStats &stats, const std::vector<bool> &m_asmap)\n     stats.addrLocal = addrLocalUnlocked.IsValid() ? addrLocalUnlocked.ToString() : \"\";\n \n     X(m_conn_type);\n+\n+    stats.addr_relay_enabled = RelayAddrsWithConn();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r603867126",
      "id" : 603867126,
      "in_reply_to_id" : 601317221,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzg2NzEyNg==",
      "original_commit_id" : "ea30030216e1a3456ff609bba7c4d2087940478a",
      "original_line" : 615,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 623952119,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T21:03:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603867126",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r603872782"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603872782"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I agree that two line if statements are undesirable. If you were already touching these lines, then I'd agree that you should improve them. However, these are the only changes you make to `SendMessages()` and are unrelated to the rest of the changes in this PR.\r\n\r\nI refactor this entire chunk of logic in #21236. Without this tidy-up commit, the two PRs don't conflict and can be merged in either order. If you include these changes, then the PRs conflict and one will have to be rebased when the other is merged.",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T08:05:19Z",
      "diff_hunk" : "@@ -4243,12 +4279,17 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                     }\n                 }\n             }\n+\n             pto->vAddrToSend.clear();\n-            if (!vAddr.empty())\n+\n+            if (!vAddr.empty()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r603872782",
      "id" : 603872782,
      "in_reply_to_id" : 601328295,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzg3Mjc4Mg==",
      "original_commit_id" : "ea30030216e1a3456ff609bba7c4d2087940478a",
      "original_line" : 4285,
      "original_position" : 121,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 623959766,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T21:03:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603872782",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r603974606"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603974606"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: is it worth replacing `if (... && !pfrom.IsBlockOnlyConn())` with `if (... && SetupAddrssRelay(pfrom))` since it already checks if the peer is block-relay-only?",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T10:27:09Z",
      "diff_hunk" : "@@ -2437,6 +2437,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n \n         if (!pfrom.IsInboundConn() && !pfrom.IsBlockOnlyConn()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r603974606",
      "id" : 603974606,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzk3NDYwNg==",
      "original_commit_id" : "9db8ab25b0aee97cad56e98200918fdf3cf849fb",
      "original_line" : 2439,
      "original_position" : 3,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 624095110,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T21:03:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603974606",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/18324680?v=4",
         "events_url" : "https://api.github.com/users/ccdle12/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ccdle12/followers",
         "following_url" : "https://api.github.com/users/ccdle12/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ccdle12/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ccdle12",
         "id" : 18324680,
         "login" : "ccdle12",
         "node_id" : "MDQ6VXNlcjE4MzI0Njgw",
         "organizations_url" : "https://api.github.com/users/ccdle12/orgs",
         "received_events_url" : "https://api.github.com/users/ccdle12/received_events",
         "repos_url" : "https://api.github.com/users/ccdle12/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ccdle12/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ccdle12/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ccdle12"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r603974781"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603974781"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nice tests, would it would be overkill to also test for the outbound case?",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T10:27:23Z",
      "diff_hunk" : "@@ -101,6 +115,25 @@ def relay_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def blackhole_tests(self):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r603974781",
      "id" : 603974781,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMzk3NDc4MQ==",
      "original_commit_id" : "8e2bcc0cb68ef2f43c22d686010fde2c2b54080a",
      "original_line" : 118,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : null,
      "pull_request_review_id" : 624095310,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T21:03:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/603974781",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/18324680?v=4",
         "events_url" : "https://api.github.com/users/ccdle12/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ccdle12/followers",
         "following_url" : "https://api.github.com/users/ccdle12/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ccdle12/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ccdle12",
         "id" : 18324680,
         "login" : "ccdle12",
         "node_id" : "MDQ6VXNlcjE4MzI0Njgw",
         "organizations_url" : "https://api.github.com/users/ccdle12/orgs",
         "received_events_url" : "https://api.github.com/users/ccdle12/received_events",
         "repos_url" : "https://api.github.com/users/ccdle12/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ccdle12/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ccdle12/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ccdle12"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604430768"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604430768"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ok! reverted :) ",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T21:04:33Z",
      "diff_hunk" : "@@ -4243,12 +4279,17 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                     }\n                 }\n             }\n+\n             pto->vAddrToSend.clear();\n-            if (!vAddr.empty())\n+\n+            if (!vAddr.empty()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604430768",
      "id" : 604430768,
      "in_reply_to_id" : 601328295,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDQzMDc2OA==",
      "original_commit_id" : "ea30030216e1a3456ff609bba7c4d2087940478a",
      "original_line" : 4285,
      "original_position" : 121,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 624702659,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T21:04:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604430768",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604431246"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604431246"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nice idea, done!",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T21:05:24Z",
      "diff_hunk" : "@@ -2437,6 +2437,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n \n         if (!pfrom.IsInboundConn() && !pfrom.IsBlockOnlyConn()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604431246",
      "id" : 604431246,
      "in_reply_to_id" : 603974606,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDQzMTI0Ng==",
      "original_commit_id" : "9db8ab25b0aee97cad56e98200918fdf3cf849fb",
      "original_line" : 2439,
      "original_position" : 3,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 624703297,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T21:05:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604431246",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604432892"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604432892"
         }
      },
      "author_association" : "MEMBER",
      "body" : "definitely not overkill, the inbound vs outbound behavior is different- inbounds we wait to hear an `addr` message before considering the peer eligible for relay, but with outbounds we setup relay, send `getaddr` & self-announce (unless its a block-relay-only connection). I added some tests to check these behaviors. ",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T21:08:17Z",
      "diff_hunk" : "@@ -101,6 +115,25 @@ def relay_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def blackhole_tests(self):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604432892",
      "id" : 604432892,
      "in_reply_to_id" : 603974781,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDQzMjg5Mg==",
      "original_commit_id" : "8e2bcc0cb68ef2f43c22d686010fde2c2b54080a",
      "original_line" : 118,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : null,
      "pull_request_review_id" : 624705469,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T21:08:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604432892",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604439165"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604439165"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "```suggestion\r\n     *  announcements. Reasons peers might not support addr relay on the link\r\n     *  include that they connected to us as a block-relay-only peer or they are\r\n     *  a light client.\r\n```",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T21:19:40Z",
      "diff_hunk" : "@@ -546,6 +543,20 @@ class CNode\n \n     // flood relay\n     std::vector<CAddress> vAddrToSend;\n+\n+    /** Bloom filter to track recent addr messages relayed with this peer.\n+     *\n+     *  We initialize this filter for outbound peers (other than\n+     *  block-relay-only connections) or when an inbound peer sends us an\n+     *  address related message (ADDR, ADDRV2, GETADDR, SENDADDRV2).\n+     *\n+     *  We use the presence of this filter to decide whether a peer is eligible\n+     *  for trickle relay of addr messages. This avoids relaying to peers that\n+     *  are unlikely to forward them, effectively blackholing self\n+     *  announcements. Reasons peers might not support addr relay on the link\n+     *  is if they connected to us as a block-relay-only peer or as a light\n+     *  client.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604439165",
      "id" : 604439165,
      "line" : 558,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDQzOTE2NQ==",
      "original_commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "original_line" : 558,
      "original_position" : 32,
      "original_start_line" : 556,
      "path" : "src/net.h",
      "position" : 32,
      "pull_request_review_id" : 624713468,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : 556,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-31T00:24:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604439165",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604450797"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604450797"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Since peers are chosen randomly, does it make sense to run `self.inbound_blackhole_tests()` a few extra times, just to assert it's not because the node didn't pick `blackhole_peer` by chance?",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T21:41:49Z",
      "diff_hunk" : "@@ -82,6 +130,49 @@ def run_test(self):\n         ipv4_branching_factor = 2\n         assert_equal(total_ipv4_received, num_ipv4_addrs * ipv4_branching_factor)\n \n+        self.nodes[0].disconnect_p2ps()\n+\n+    def inbound_blackhole_tests(self):\n+        self.log.info('Check that we only relay addresses to inbound peers who have previously sent us addr related messages')\n+\n+        addr_source = self.nodes[0].add_p2p_connection(P2PInterface())\n+        receiver_peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+        blackhole_peer = self.nodes[0].add_p2p_connection(AddrBlackhole())\n+\n+        msg = self.setup_addr_msg(2)\n+        self.send_addr_msg(addr_source, msg, [receiver_peer, blackhole_peer])\n+\n+        assert_equal(receiver_peer.num_ipv4_received, 2)\n+        assert_equal(blackhole_peer.num_ipv4_received, 0)\n+\n+        self.nodes[0].disconnect_p2ps()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604450797",
      "id" : 604450797,
      "line" : 148,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDQ1MDc5Nw==",
      "original_commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "original_line" : 148,
      "original_position" : 153,
      "original_start_line" : 135,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 153,
      "pull_request_review_id" : 624713468,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : 135,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-30T22:57:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604450797",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604456653"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604456653"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think this test could also be improved by asserting that, after `blackhole_peer` does send an `addr`/`addrv2`/`getaddrs`/`sendaddrv2` message, it can get selected for addr propagation.",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T21:53:40Z",
      "diff_hunk" : "@@ -82,6 +130,49 @@ def run_test(self):\n         ipv4_branching_factor = 2\n         assert_equal(total_ipv4_received, num_ipv4_addrs * ipv4_branching_factor)\n \n+        self.nodes[0].disconnect_p2ps()\n+\n+    def inbound_blackhole_tests(self):\n+        self.log.info('Check that we only relay addresses to inbound peers who have previously sent us addr related messages')\n+\n+        addr_source = self.nodes[0].add_p2p_connection(P2PInterface())\n+        receiver_peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+        blackhole_peer = self.nodes[0].add_p2p_connection(AddrBlackhole())\n+\n+        msg = self.setup_addr_msg(2)\n+        self.send_addr_msg(addr_source, msg, [receiver_peer, blackhole_peer])\n+\n+        assert_equal(receiver_peer.num_ipv4_received, 2)\n+        assert_equal(blackhole_peer.num_ipv4_received, 0)\n+\n+        self.nodes[0].disconnect_p2ps()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604456653",
      "id" : 604456653,
      "in_reply_to_id" : 604450797,
      "line" : 148,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDQ1NjY1Mw==",
      "original_commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "original_line" : 148,
      "original_position" : 153,
      "original_start_line" : 135,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 153,
      "pull_request_review_id" : 624713468,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : 135,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-30T22:57:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604456653",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604458405"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604458405"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Another thought - for the blackhole peer, I think could be helpful to assert bytes received for addr-related messages = 0 using `getpeerinfo()`",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T21:57:04Z",
      "diff_hunk" : "@@ -82,6 +130,49 @@ def run_test(self):\n         ipv4_branching_factor = 2\n         assert_equal(total_ipv4_received, num_ipv4_addrs * ipv4_branching_factor)\n \n+        self.nodes[0].disconnect_p2ps()\n+\n+    def inbound_blackhole_tests(self):\n+        self.log.info('Check that we only relay addresses to inbound peers who have previously sent us addr related messages')\n+\n+        addr_source = self.nodes[0].add_p2p_connection(P2PInterface())\n+        receiver_peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+        blackhole_peer = self.nodes[0].add_p2p_connection(AddrBlackhole())\n+\n+        msg = self.setup_addr_msg(2)\n+        self.send_addr_msg(addr_source, msg, [receiver_peer, blackhole_peer])\n+\n+        assert_equal(receiver_peer.num_ipv4_received, 2)\n+        assert_equal(blackhole_peer.num_ipv4_received, 0)\n+\n+        self.nodes[0].disconnect_p2ps()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604458405",
      "id" : 604458405,
      "in_reply_to_id" : 604450797,
      "line" : 148,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDQ1ODQwNQ==",
      "original_commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "original_line" : 148,
      "original_position" : 153,
      "original_start_line" : 135,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 153,
      "pull_request_review_id" : 624713468,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : 135,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-30T22:57:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604458405",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604477534"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604477534"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Side question: why do we clear this list here instead of appending to it, given that `PushAddress` and `SendMessages` filter for duplicates?",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T22:41:05Z",
      "diff_hunk" : "@@ -3569,6 +3584,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n         pfrom.fSentAddr = true;\n \n+        SetupAddressRelay(pfrom);\n+\n         pfrom.vAddrToSend.clear();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604477534",
      "id" : 604477534,
      "line" : 3589,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDQ3NzUzNA==",
      "original_commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "original_line" : 3589,
      "original_position" : 78,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 78,
      "pull_request_review_id" : 624713468,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-30T22:57:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604477534",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604497976"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604497976"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Since peers are chosen randomly..\r\n\r\nyes, peers are chosen randomly, but this test is set up to not be random- ipv4 addresses will be relayed to 2 peers that are not the source of the addr message. so both `receiver_peer` and `blackhole_peer` would receive the addr if they were eligible. definitely wouldn't want a flaky test there :) \r\n\r\n> I think this test could also be improved.. \r\n\r\nthats a great idea! I've added locally, will include in next push. \r\n\r\n> assert bytes received for addr-related messages = 0\r\n\r\nhm, `blackhole_peer` is a p2p connection, so we can't call `getpeerinfo()` on it to get the bytes received directly. that said, we could check `bytessent_per_msg` on the node to see that no bytes have been sent for an `addr` message. however, I its a bit brittle & the p2p connection is capturing directly receiving the addr message, so I don't think that's adding much value to the test. let me know if you think it'd add test coverage :) ",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-30T23:35:10Z",
      "diff_hunk" : "@@ -82,6 +130,49 @@ def run_test(self):\n         ipv4_branching_factor = 2\n         assert_equal(total_ipv4_received, num_ipv4_addrs * ipv4_branching_factor)\n \n+        self.nodes[0].disconnect_p2ps()\n+\n+    def inbound_blackhole_tests(self):\n+        self.log.info('Check that we only relay addresses to inbound peers who have previously sent us addr related messages')\n+\n+        addr_source = self.nodes[0].add_p2p_connection(P2PInterface())\n+        receiver_peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+        blackhole_peer = self.nodes[0].add_p2p_connection(AddrBlackhole())\n+\n+        msg = self.setup_addr_msg(2)\n+        self.send_addr_msg(addr_source, msg, [receiver_peer, blackhole_peer])\n+\n+        assert_equal(receiver_peer.num_ipv4_received, 2)\n+        assert_equal(blackhole_peer.num_ipv4_received, 0)\n+\n+        self.nodes[0].disconnect_p2ps()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604497976",
      "id" : 604497976,
      "in_reply_to_id" : 604450797,
      "line" : 148,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDQ5Nzk3Ng==",
      "original_commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "original_line" : 148,
      "original_position" : 153,
      "original_start_line" : 135,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 153,
      "pull_request_review_id" : 624783523,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : 135,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-30T23:35:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604497976",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604518862"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604518862"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> yes, peers are chosen randomly, but this test is set up to not be random- ipv4 addresses will be relayed to 2 peers that are not the source of the addr message. so both receiver_peer and blackhole_peer would receive the addr if they were eligible. definitely wouldn't want a flaky test there :)\r\n\r\nOh right it's always going to be the same one. That makes sense then, that the node has 2 options but doesn't send it to a peer that hasn't established addr relay. But wait I'm confused why it would be flaky, I thought `blackhole_peer` would never get the addr because it hasn't sent any addr-related messages?\r\n\r\n> hm, blackhole_peer is a p2p connection, so we can't call getpeerinfo() on it to get the bytes received directly.\r\n\r\nEr I mean, call `getpeerinfo()` on the node to see bytes received, kinda like this:\r\n\r\n```py\r\ndef sum_addr_messages(msgs):\r\n    return msgs['addr'] + msgs['addrv2'] + msgs['getaddr'] + msgs['sendaddrv2']\r\n...\r\n\r\npeerinfo = self.nodes[0].getpeerinfo()\r\n# receiver_peer sent us its own addr and a getaddr after the VERSION message, so we relay\r\nassert sum_addr_messages(peerinfo[1]['bytesrecv_per_msg']) > 0\r\nassert_equal(receiver_peer.num_ipv4_received, 2)\r\n\r\n# blackhole_peer should not have sent us any addr-related messages, so we don't relay\r\nassert sum_addr_messages(peerinfo[2]['bytesrecv_per_msg']) == 0\r\nassert_equal(blackhole_peer.num_ipv4_received, 0)\r\n```\r\nI just thought it'd be a more precise test, asserting that the addrs aren't relayed because no addr messages have been received. ð nbd",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-31T00:39:13Z",
      "diff_hunk" : "@@ -82,6 +130,49 @@ def run_test(self):\n         ipv4_branching_factor = 2\n         assert_equal(total_ipv4_received, num_ipv4_addrs * ipv4_branching_factor)\n \n+        self.nodes[0].disconnect_p2ps()\n+\n+    def inbound_blackhole_tests(self):\n+        self.log.info('Check that we only relay addresses to inbound peers who have previously sent us addr related messages')\n+\n+        addr_source = self.nodes[0].add_p2p_connection(P2PInterface())\n+        receiver_peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+        blackhole_peer = self.nodes[0].add_p2p_connection(AddrBlackhole())\n+\n+        msg = self.setup_addr_msg(2)\n+        self.send_addr_msg(addr_source, msg, [receiver_peer, blackhole_peer])\n+\n+        assert_equal(receiver_peer.num_ipv4_received, 2)\n+        assert_equal(blackhole_peer.num_ipv4_received, 0)\n+\n+        self.nodes[0].disconnect_p2ps()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604518862",
      "id" : 604518862,
      "in_reply_to_id" : 604450797,
      "line" : 148,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDUxODg2Mg==",
      "original_commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "original_line" : 148,
      "original_position" : 153,
      "original_start_line" : 135,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 153,
      "pull_request_review_id" : 624806781,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : 135,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-31T00:45:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604518862",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604526797"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604526797"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> But wait I'm confused why it would be flaky, I thought blackhole_peer would never get the addr because it hasn't sent any addr-related messages?\r\n\r\nyes yes, it would be flaky if it wasn't deterministic / `blackhole_peer` was being skipped by chance. I think we're on the same page, just confusion of my language now. \r\n\r\n> Er I mean, call getpeerinfo() on the node to see bytes received, kinda like this\r\n\r\noh I get it now, you're suggesting additional coverage to test the setup, not another way to test the `addr` relayed. that's a cool idea! sure, I'll add it :) \r\n\r\nsmol note: \r\n> receiver_peer sent us its own addr and a getaddr after the VERSION message, so we relay\r\n\r\nsince `receiver_peer` is essentially a `P2PInterface` object, it actually won't self announce upon receiving `version` message. I added  that it will send out a `getaddr` so tests wouldn't unexpectedly break  in this patch. but I think that highlights why this suggested coverage is useful, at the very least it communicates the relevant setup that's otherwise \"invisible\" from the POV of this test file. ",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-31T01:06:30Z",
      "diff_hunk" : "@@ -82,6 +130,49 @@ def run_test(self):\n         ipv4_branching_factor = 2\n         assert_equal(total_ipv4_received, num_ipv4_addrs * ipv4_branching_factor)\n \n+        self.nodes[0].disconnect_p2ps()\n+\n+    def inbound_blackhole_tests(self):\n+        self.log.info('Check that we only relay addresses to inbound peers who have previously sent us addr related messages')\n+\n+        addr_source = self.nodes[0].add_p2p_connection(P2PInterface())\n+        receiver_peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+        blackhole_peer = self.nodes[0].add_p2p_connection(AddrBlackhole())\n+\n+        msg = self.setup_addr_msg(2)\n+        self.send_addr_msg(addr_source, msg, [receiver_peer, blackhole_peer])\n+\n+        assert_equal(receiver_peer.num_ipv4_received, 2)\n+        assert_equal(blackhole_peer.num_ipv4_received, 0)\n+\n+        self.nodes[0].disconnect_p2ps()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r604526797",
      "id" : 604526797,
      "in_reply_to_id" : 604450797,
      "line" : 148,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNDUyNjc5Nw==",
      "original_commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "original_line" : 148,
      "original_position" : 153,
      "original_start_line" : 135,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 153,
      "pull_request_review_id" : 624815696,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : 135,
      "start_side" : "RIGHT",
      "updated_at" : "2021-03-31T01:06:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/604526797",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@glozow The concern would be other Bitcoin node implementations which don't send addr/getaddr, but do care about receiving them. I don't think that's particularly likely, but it's also hard to be sure there are none.",
      "created_at" : "2021-03-31T05:01:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-810762563",
      "id" : 810762563,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxMDc2MjU2Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-31T05:01:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/810762563",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Concept ACK ",
      "created_at" : "2021-03-31T16:06:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-811184984",
      "id" : 811184984,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxMTE4NDk4NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-31T16:06:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/811184984",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/16559?v=4",
         "events_url" : "https://api.github.com/users/ivanacostarubio/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ivanacostarubio/followers",
         "following_url" : "https://api.github.com/users/ivanacostarubio/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ivanacostarubio/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ivanacostarubio",
         "id" : 16559,
         "login" : "ivanacostarubio",
         "node_id" : "MDQ6VXNlcjE2NTU5",
         "organizations_url" : "https://api.github.com/users/ivanacostarubio/orgs",
         "received_events_url" : "https://api.github.com/users/ivanacostarubio/received_events",
         "repos_url" : "https://api.github.com/users/ivanacostarubio/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ivanacostarubio/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ivanacostarubio/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ivanacostarubio"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r605058607"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/605058607"
         }
      },
      "author_association" : "NONE",
      "body" : "```suggestion\r\n    std::unique_ptr<CRollingBloomFilter> m_addr_known GUARDED_BY(cs_addrKnown){nullptr};\r\n```\r\nand add `cs_addrKnown` as a private member:\r\n\r\n```\r\nmutable RecursiveMutex cs_addrKnown;\r\n```\r\n\r\nto address the point about race conditions mentioned by @jnewbery ",
      "commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "created_at" : "2021-03-31T16:46:07Z",
      "diff_hunk" : "@@ -546,6 +543,20 @@ class CNode\n \n     // flood relay\n     std::vector<CAddress> vAddrToSend;\n+\n+    /** Bloom filter to track recent addr messages relayed with this peer.\n+     *\n+     *  We initialize this filter for outbound peers (other than\n+     *  block-relay-only connections) or when an inbound peer sends us an\n+     *  address related message (ADDR, ADDRV2, GETADDR, SENDADDRV2).\n+     *\n+     *  We use the presence of this filter to decide whether a peer is eligible\n+     *  for trickle relay of addr messages. This avoids relaying to peers that\n+     *  are unlikely to forward them, effectively blackholing self\n+     *  announcements. Reasons peers might not support addr relay on the link\n+     *  is if they connected to us as a block-relay-only peer or as a light\n+     *  client.\n+     * */\n     std::unique_ptr<CRollingBloomFilter> m_addr_known{nullptr};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r605058607",
      "id" : 605058607,
      "line" : 560,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwNTA1ODYwNw==",
      "original_commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "original_line" : 560,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : 34,
      "pull_request_review_id" : 625507909,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-03-31T16:46:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/605058607",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/80422284?v=4",
         "events_url" : "https://api.github.com/users/GeneFerneau/events{/privacy}",
         "followers_url" : "https://api.github.com/users/GeneFerneau/followers",
         "following_url" : "https://api.github.com/users/GeneFerneau/following{/other_user}",
         "gists_url" : "https://api.github.com/users/GeneFerneau/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/GeneFerneau",
         "id" : 80422284,
         "login" : "GeneFerneau",
         "node_id" : "MDQ6VXNlcjgwNDIyMjg0",
         "organizations_url" : "https://api.github.com/users/GeneFerneau/orgs",
         "received_events_url" : "https://api.github.com/users/GeneFerneau/received_events",
         "repos_url" : "https://api.github.com/users/GeneFerneau/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/GeneFerneau/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/GeneFerneau/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/GeneFerneau"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "Concept ACK\r\n\r\nNeed to review surrounding code more, and run the tests. Looks good so far!",
      "created_at" : "2021-03-31T16:49:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-811245866",
      "id" : 811245866,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxMTI0NTg2Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-31T16:49:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/811245866",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/80422284?v=4",
         "events_url" : "https://api.github.com/users/GeneFerneau/events{/privacy}",
         "followers_url" : "https://api.github.com/users/GeneFerneau/followers",
         "following_url" : "https://api.github.com/users/GeneFerneau/following{/other_user}",
         "gists_url" : "https://api.github.com/users/GeneFerneau/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/GeneFerneau",
         "id" : 80422284,
         "login" : "GeneFerneau",
         "node_id" : "MDQ6VXNlcjgwNDIyMjg0",
         "organizations_url" : "https://api.github.com/users/GeneFerneau/orgs",
         "received_events_url" : "https://api.github.com/users/GeneFerneau/received_events",
         "repos_url" : "https://api.github.com/users/GeneFerneau/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/GeneFerneau/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/GeneFerneau/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/GeneFerneau"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Reiterating my concept ACK on this. Reducing the number of addr black holes seems like a good win for addr gossipping across the network.\r\n\r\nThis branch needs rebase now that the addr data has been moved up into net_processing. I'd be very happy to help with that if you need a hand.",
      "created_at" : "2021-06-09T10:49:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-857592679",
      "id" : 857592679,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1NzU5MjY3OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-09T10:49:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/857592679",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Reiterating my concept ACK on this. Reducing the number of addr black holes seems like a good win for addr gossipping across the network.\r\n\r\nI think this was somewhat pending being sure it wouldn't break bitcore (see https://github.com/bitpay/bitcore/issues/3140) which now looks like it's now resolved.",
      "created_at" : "2021-06-09T11:39:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-857622218",
      "id" : 857622218,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1NzYyMjIxOA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-09T11:39:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/857622218",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Reiterating my concept ACK on this\r\n\r\nThanks! \r\n\r\n> I think this was somewhat pending being sure it wouldn't break bitcore (see bitpay/bitcore#3140) which now looks like it's now resolved.\r\n\r\nIndeed. I'm now working to rebase & bring this PR out of draft. I've rebased locally but am working through some test failures, I hope to have this ready for review by early next week. \r\n\r\nPS: I also investigated bitcoinj & opened an issue on their repo, they also seem compatible ð. ",
      "created_at" : "2021-06-12T00:58:26Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-859973340",
      "id" : 859973340,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1OTk3MzM0MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-12T00:58:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/859973340",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r651383772"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651383772"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Leaving this as is - I find it most logically consistent for `sendaddrv2` to indicate \"interested in addresses\". Opened #22245 to change the behavior for inbound block-relay-only v22.0 peers.",
      "commit_id" : "78e45d901ace269534a3bd3a86b5d2389f983aaa",
      "created_at" : "2021-06-15T01:34:48Z",
      "diff_hunk" : "@@ -2625,7 +2625,11 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             pfrom.fDisconnect = true;\n             return;\n         }\n-        pfrom.m_wants_addrv2 = true;\n+\n+        if (SetupAddressRelay(pfrom)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r651383772",
      "id" : 651383772,
      "in_reply_to_id" : 601057629,
      "line" : 2751,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTM4Mzc3Mg==",
      "original_commit_id" : "cd55b53800ec63b516bdca46bfee0d57e34e3af6",
      "original_line" : 2751,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 110,
      "pull_request_review_id" : 683482383,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-15T01:34:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651383772",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r651388591"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651388591"
         }
      },
      "author_association" : "MEMBER",
      "body" : "updated language ",
      "commit_id" : "78e45d901ace269534a3bd3a86b5d2389f983aaa",
      "created_at" : "2021-06-15T01:49:53Z",
      "diff_hunk" : "@@ -546,6 +543,20 @@ class CNode\n \n     // flood relay\n     std::vector<CAddress> vAddrToSend;\n+\n+    /** Bloom filter to track recent addr messages relayed with this peer.\n+     *\n+     *  We initialize this filter for outbound peers (other than\n+     *  block-relay-only connections) or when an inbound peer sends us an\n+     *  address related message (ADDR, ADDRV2, GETADDR, SENDADDRV2).\n+     *\n+     *  We use the presence of this filter to decide whether a peer is eligible\n+     *  for trickle relay of addr messages. This avoids relaying to peers that\n+     *  are unlikely to forward them, effectively blackholing self\n+     *  announcements. Reasons peers might not support addr relay on the link\n+     *  is if they connected to us as a block-relay-only peer or as a light\n+     *  client.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r651388591",
      "id" : 651388591,
      "in_reply_to_id" : 604439165,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTM4ODU5MQ==",
      "original_commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "original_line" : 558,
      "original_position" : 32,
      "original_start_line" : 556,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 683487797,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-06-15T01:49:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651388591",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r651389080"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651389080"
         }
      },
      "author_association" : "MEMBER",
      "body" : "based on this convo, I've updated the tests to assert that `blackhole_peer` starts receiving addr messages after sending one. I've also added `getpeerinfo` for the node to verify the test setup of which peers have sent addr related messages. \r\n\r\nthanks!   ",
      "commit_id" : "78e45d901ace269534a3bd3a86b5d2389f983aaa",
      "created_at" : "2021-06-15T01:51:21Z",
      "diff_hunk" : "@@ -82,6 +130,49 @@ def run_test(self):\n         ipv4_branching_factor = 2\n         assert_equal(total_ipv4_received, num_ipv4_addrs * ipv4_branching_factor)\n \n+        self.nodes[0].disconnect_p2ps()\n+\n+    def inbound_blackhole_tests(self):\n+        self.log.info('Check that we only relay addresses to inbound peers who have previously sent us addr related messages')\n+\n+        addr_source = self.nodes[0].add_p2p_connection(P2PInterface())\n+        receiver_peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+        blackhole_peer = self.nodes[0].add_p2p_connection(AddrBlackhole())\n+\n+        msg = self.setup_addr_msg(2)\n+        self.send_addr_msg(addr_source, msg, [receiver_peer, blackhole_peer])\n+\n+        assert_equal(receiver_peer.num_ipv4_received, 2)\n+        assert_equal(blackhole_peer.num_ipv4_received, 0)\n+\n+        self.nodes[0].disconnect_p2ps()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r651389080",
      "id" : 651389080,
      "in_reply_to_id" : 604450797,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTM4OTA4MA==",
      "original_commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "original_line" : 212,
      "original_position" : 153,
      "original_start_line" : 135,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : null,
      "pull_request_review_id" : 683488319,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-06-15T01:51:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651389080",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r651389788"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651389788"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Holding off on this to try to figure out if there's a better way I can expose this value through the `getpeerinfo` RPC than having to introduce a mutex for this one hyper-specific use case. Ideas welcome! ",
      "commit_id" : "78e45d901ace269534a3bd3a86b5d2389f983aaa",
      "created_at" : "2021-06-15T01:53:26Z",
      "diff_hunk" : "@@ -546,6 +543,20 @@ class CNode\n \n     // flood relay\n     std::vector<CAddress> vAddrToSend;\n+\n+    /** Bloom filter to track recent addr messages relayed with this peer.\n+     *\n+     *  We initialize this filter for outbound peers (other than\n+     *  block-relay-only connections) or when an inbound peer sends us an\n+     *  address related message (ADDR, ADDRV2, GETADDR, SENDADDRV2).\n+     *\n+     *  We use the presence of this filter to decide whether a peer is eligible\n+     *  for trickle relay of addr messages. This avoids relaying to peers that\n+     *  are unlikely to forward them, effectively blackholing self\n+     *  announcements. Reasons peers might not support addr relay on the link\n+     *  is if they connected to us as a block-relay-only peer or as a light\n+     *  client.\n+     * */\n     std::unique_ptr<CRollingBloomFilter> m_addr_known{nullptr};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r651389788",
      "id" : 651389788,
      "in_reply_to_id" : 605058607,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTM4OTc4OA==",
      "original_commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "original_line" : 560,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 683489100,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-15T01:53:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651389788",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "My [research](https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-809906430) indicates that these changes would not break any clients, I've opened issues trying to confirm my understand on all the repos, and I have not heard any opposition from the mailing list or on IRC. This seems like the extent of what I can do to make sure these changes are compatible with alternative clients ð\r\n\r\nI've also broken out the commit to \"stop sending sendaddrv2 messages to block-relay-only peers\" into #22245. \r\n\r\nSo I'm bringing this PR out of draft. I have rebased it on top of #21236 and #21707. They were both pretty involved, so I recommend reviewing from scratch. The `p2p_addr_relay.py` functional test is getting pretty big & hits a fair amount of behind-the-scenes p2p mechanisms. I tried to improve the clarity & document relevant mechanisms, but open to suggestions if anything is still unclear. ",
      "created_at" : "2021-06-15T02:04:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-861114349",
      "id" : 861114349,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MTExNDM0OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-15T02:05:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/861114349",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK. Impressively thorough investigation of impact on alternative clients :)",
      "created_at" : "2021-06-16T11:35:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-862305024",
      "id" : 862305024,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MjMwNTAyNA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-16T11:35:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/862305024",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/16323900?v=4",
         "events_url" : "https://api.github.com/users/michaelfolkson/events{/privacy}",
         "followers_url" : "https://api.github.com/users/michaelfolkson/followers",
         "following_url" : "https://api.github.com/users/michaelfolkson/following{/other_user}",
         "gists_url" : "https://api.github.com/users/michaelfolkson/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/michaelfolkson",
         "id" : 16323900,
         "login" : "michaelfolkson",
         "node_id" : "MDQ6VXNlcjE2MzIzOTAw",
         "organizations_url" : "https://api.github.com/users/michaelfolkson/orgs",
         "received_events_url" : "https://api.github.com/users/michaelfolkson/received_events",
         "repos_url" : "https://api.github.com/users/michaelfolkson/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/michaelfolkson/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/michaelfolkson/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/michaelfolkson"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> For inbound peers, we initialize the filter if/when we get an addr related message (ADDR, ADDRV2, GETADDR, SENDADDRV2).\r\n\r\nSo it may happen that a light client who does not participate in address relay connects to us and sends us `getaddr` in order to learn some peers and we (mis)interpret that and start sending unrequested addresses to that peer in the hopes of further relay. Black hole again.\r\n\r\nOr a peer that does not participate in address relay replies to our `getaddr` with `addr` and we (mis)interpret that as \"the peer participates in address relay\"?\r\n\r\nDo we have any estimates of how severe the black holes problem is? I think that currently address relay works, so maybe it is not a \"big\" problem, or not a problem at all?\r\n\r\nWhat if we relay to 3 instead of 2 random peers? Has that been considered? I would not require protocol changes. Would it solve the black holes problem or diminish it to such extend that it can be ignored?",
      "created_at" : "2021-06-16T11:48:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-862312851",
      "id" : 862312851,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MjMxMjg1MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-16T11:48:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/862312851",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@vasild\r\n\r\n> So it may happen that a light client who does not participate in address relay connects to us and sends us getaddr in order to learn some peers and we (mis)interpret that and start sending unrequested addresses to that peer in the hopes of further relay. Black hole again.\r\nOr a peer that does not participate in address relay replies to our getaddr with addr and we (mis)interpret that as \"the peer participates in address relay\"?\r\n\r\nI believe this question is addressed in the OP- \"Although we cannot prevent this in a malicious case, we can improve it for the normal, honest cases, and reduce the overall likelihood of occurrence.\" \r\n\r\nIncase that is unclear, let me try to provide some additional context- the goal of this PR is not to ensure perfect accuracy of whether or not the receiving peer would forward the addresses. In fact, I don't think we could ever ensure such accuracy- even if we had a p2p message that said \"I will forward addresses you send me\", that could easily be abused by a peer who doesn't actually follow through. \r\n\r\nThe goal of this PR is to _reduce the frequency_ of sending addresses to nodes who have no interest in them & will certainly not forward those along. For example, we know that an honest node who is running the latest version of bitcoin core will have block-relay-only connections where it will drop any addresses sent over that connection.\r\n\r\n> Do we have any estimates of how severe the black holes problem is? I think that currently address relay works, so maybe it is not a \"big\" problem, or not a problem at all? \r\n\r\nWhile I do think this PR offers an improvement to address relay, the end goal is to increase the number of block-relay-only connections created by a bitcoin node (also goal of the `DISABLETX` work in #20726). Even if the number of black holes are not currently a problem, fixing them are a prerequisite to being able to increase the number of block-relay-only connections. For more context on this conversation, please see https://github.com/bitcoin/bitcoin/pull/15759#issuecomment-480868516 & the surrounding discussion. \r\n\r\n> What if we relay to 3 instead of 2 random peers? Has that been considered? I would not require protocol changes. Would it solve the black holes problem or diminish it to such extend that it can be ignored?\r\n\r\nRelaying addresses to 3 rather than 2 random peers could be possible, but I think it would require in-depth research to ensure there wouldn't be any negative bandwidth or privacy impact. One of the alternative approaches that has been considered is to mark \"potential blackholes\" and then increase redundancy if they have been selected in `RelayAddress`. A downside of that approach is it's hard to build confidence that such approach wouldn't lead to network-wide biases of certain addresses or certain peers. \r\n\r\nI agree with what @sdaftuar said in https://github.com/bitcoin/bitcoin/pull/22245#issuecomment-862839610: \r\n> I donât think anyone believes that implicit behavior (that is undocumented in any BIP) is the right way for protocol development to proceed if starting from a clean slate â so eventually I think weâll rewrite things.\r\n\r\nThe current state of `addr` propagation relies heavily on assumptions & is poorly understood and poorly documented. In the long term, I hope to work towards a shared set of design goals & more explicit expectations that are well documented. However, this PR is coming from the hope that we don't have to gate making progress towards increasing block-relay-only connections on a fundamental redesign of `addr` relay. ",
      "created_at" : "2021-06-18T05:50:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-863775060",
      "id" : 863775060,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2Mzc3NTA2MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-21T04:35:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/863775060",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "If the focus is on avoiding gossip to peers that connected to us in block-only mode, then isn't the absence of `getaddr` enough to recognize that? That is, a peer who connected to us and did not send us `getaddr` must be in blocks-only mode / is a black hole? No need to involve `addr` and `addrv2`? I.e. only for inbound connections, delay initializing `Peer::m_addr_known` for until after `getaddr` is received.\r\n\r\nGiven that \"when\" and \"to whom\" to relay addresses is not mandated by any specification and is up to each peer to decide, and one may as well decide to relay only on full moon on odd months or if the peer's address ends in `7`, then deciding to skip relay to peers that did not send `getaddr` is not a protocol change.\r\n\r\nI see the assumption \"the peer did not send us `messageX` => they must be a black hole\" as flawed. More like a hack, which might be acceptable in the current situation.\r\n\r\nStill sending to some black holes is ok (we currently do). But could this PR have the adverse effect of starting to treat as black holes peers that are actually not?\r\n\r\nAs for relaying to more peers: currently we relay reachable addresses to 2 peers. So (assuming everybody relays) every node relays to two others (it spreads like a virus). And an average spread rate of <1 is required to stop an address from propagating. It means that if more than half of the peers are black holes then propagation will not work (will stop). I think we are far from 50% black holes but I could be wrong. For unreachable peers (e.g. a Tor address relayed via a peer that does not have Tor connectivity) the number is 1.5 and so, 33% or more black holes are needed to brick propagation.",
      "created_at" : "2021-06-18T10:40:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-863943765",
      "id" : 863943765,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2Mzk0Mzc2NQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-18T10:40:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/863943765",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@vasild \r\n\r\n> That is, a peer who connected to us and did not send us getaddr must be in blocks-only mode / is a black hole?\r\n\r\nThis is false. If you see the notes I've taken on alternative clients here: https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-809906430, you can see that several of them will always self-advertise, but only occasionally send getaddr messages. \r\n\r\n> Still sending to some black holes is ok (we currently do). But could this PR have the adverse effect of starting to treat as black holes peers that are actually not?\r\n\r\nYes, exactly. This is why I have taken great care to communicate these changes & research clients to ensure they would not be harmed. If we only used getaddr to indicate \"wants to participate in addr relay\", this exact adverse effect would occur. \r\n\r\n> As for relaying to more peers: currently we relay reachable addresses to 2 peers. So (assuming everybody relays) every node relays to two others (it spreads like a virus). And an average spread rate of <1 is required to stop an address from propagating. It means that if more than half of the peers are black holes then propagation will not work (will stop). I think we are far from 50% black holes but I could be wrong. For unreachable peers (e.g. a Tor address relayed via a peer that does not have Tor connectivity) the number is 1.5 and so, 33% or more black holes are needed to brick propagation.\r\n\r\nAs I said in my previous post, \"Relaying addresses to 3 rather than 2 random peers could be possible, but I think it would require in-depth research to ensure there wouldn't be any negative bandwidth or privacy impact.\" There is no doubt that relaying addresses to more peers could ensure they saturate the network. Heck, if that was all we cared about, why not forward addresses to every node? \r\n\r\nThe concern is if there would be any _other_ adverse impact, and that is difficult to reason about. We could model the bandwidth increase by estimating: number of nodes on network, expected frequency of initiating self-announcements, number of anticipated blackholes & multiplier of forwarding addresses. This could help build confidence, but a lot of these numbers would have to be estimates. Even harder would be to guarantee that there are no significant security concerns. For example, addr relay can reveal node topology which can ease a partition or eclipse attack. I believe it would be significantly more complex to usefully model how changing the relay policy would impact potential information leaks. And that wouldn't be the only security concern about changing addr relay policy, just one example.",
      "created_at" : "2021-06-18T18:17:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-864202916",
      "id" : 864202916,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NDIwMjkxNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-18T18:17:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/864202916",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK.\r\n\r\n> As for relaying to more peers: currently we relay reachable addresses to 2 peers. So (assuming everybody relays) every node relays to two others (it spreads like a virus). And an average spread rate of <1 is required to stop an address from propagating. It means that if more than half of the peers are black holes then propagation will not work (will stop). I think we are far from 50% black holes but I could be wrong.\r\n\r\nI think that there are at least two limitations to a virus-like spread:\r\n1. Each full node relays a given addr only once to two peers, and becomes a black hole for it after that - if it receives the addr again from another peer, it won't relay it to different peers within 24h because of how `RelayAddress()` works. This makes addr gossip sensitive to network topology (hubs with many peers are bottlenecks) and makes it pretty much impossible for an addr to percolate through the entire network via gossip relay. Even with zero black holes, an addr would only reach ~35% of the nodes in my simulation.\r\n2. Each node in the network will stop relaying an addr 10 minutes after the announcement (that's 20 hops on average with `AVG_ADDRESS_BROADCAST_INTERVAL = 30s`), see [first condition here](https://github.com/bitcoin/bitcoin/blob/da69d9965a112c6421fce5649b5a18beb7513526/src/net_processing.cpp#L2783-L2786)\r\n\r\nMy impression is that the introduction of 20% block-relay-only connections could have effected addr gossip relay quite clearly. I did some quick simulations similar to @naumenkogs' work from #17194 but adjusted for points 1 and 2 from above: \r\nThe simulations ([code](https://github.com/mzumsande/addr_relay_sim)) suggest that the percentage of nodes reached by an initial self-announcement of a new non-listening node falls from 35% (0% black holes) to 21% (20% black holes) to 2% (35% black holes).\r\n\r\n> I think that currently address relay works, so maybe it is not a \"big\" problem, or not a problem at all?\r\n\r\nI think that whether addr gossip relay \"works\"  is not so easy to judge because other means of addr propagation (DNS seeds; getaddr mechanism) also contribute to addr propagation and introduce some degree of redundancy - maybe the best measure is how fast a new node on the network receives inbound connections?\r\nBut getaddr does not adapt quickly (older addrs, 24 hour cache) to changes in the network, so it makes sense to me to improve the state of gossip relay as suggested by this PR.",
      "created_at" : "2021-06-21T00:08:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-864633869",
      "id" : 864633869,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NDYzMzg2OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-21T00:08:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/864633869",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> The simulations ([code](https://github.com/mzumsande/addr_relay_sim)) suggest that the percentage of nodes reached by an initial self-announcement of a new non-listening node falls from 35% (0% black holes) to 21% (20% black holes) to 2% (35% black holes).\r\n\r\nI think that's simulating having 8 outbounds of which 20% (or 30%,35%,40%) are blackholes, rather than 8 full outbounds and an additional 2 blackholes.\r\n\r\nMight be worth distinguishing between the percentage of listening nodes that see an address versus total nodes -- I think with 8 outbounds, 0% blackholes it's 92% of listening nodes and 35% of all nodes that see an address, and 20% blackholes (6.4 full outbound 1.6 block relay only) gives 65% of listening nodes and 21% of all nodes see an address.\r\n\r\nI tried writing [my own sim](https://gist.github.com/ajtowns/ec27774113e5d1214b99281f6b7549c4) which only deals with listening peers; the numbers I got were 8 full-relay 0 block-relay gives ~80% of nodes seeing an address on average, while 8 full-relay 2 block-relay gives ~70% coverage, and 8 full-relay 5 block-relay gives ~50% coverage. Switching from 2 peers to 3 for addr relay brings those numbers up to 95%, 92% and 85% respectively.",
      "created_at" : "2021-06-21T05:30:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-864740342",
      "id" : 864740342,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NDc0MDM0Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-21T05:30:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/864740342",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@mzumsande, @ajtowns, wow! That gives some rough picture on the severity of the problem. I think it rules out \"not a problem at all\". Thanks!\r\n\r\n@amitiuttarwar, I guess the \"waiting for confirmation\" for btcd and bitcoinj [above](https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-809906430) should be cleared before this PR is merged?",
      "created_at" : "2021-06-21T14:48:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-865093349",
      "id" : 865093349,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NTA5MzM0OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-21T14:48:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/865093349",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@mzumsande, thanks for putting together that awesome simulation! and thank you @ajtowns for reviewing :) very cool. \r\n\r\nbiggest changes in the recent push: \r\n- as per the conversation on #22245, I've removed the commit that uses `sendaddrv2` as a signal to set up addr relay on the connection \r\n- I was finding the `p2p_addr_relay.py` refactor commit hard to parse, so I pulled it out into #22306 and broke it down into multiple commits. this PR builds on that branch. ",
      "created_at" : "2021-06-22T03:47:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-865505493",
      "id" : 865505493,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NTUwNTQ5Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-22T03:47:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/865505493",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Had a bit more of a [poke](https://gist.github.com/ajtowns/ec27774113e5d1214b99281f6b7549c4) at this, I think the interesting results are (with 10k listening nodes, 50k private nodes with only outbounds):\r\n\r\n```\r\nConn: 8+2 Spread: 2 Limit: 10000/600 Avg/dev: 78.5%Â±9.7% 26.1%Â±3.5%\r\nConn: 8+0 Spread: 2 Limit: 10000/600 Avg/dev: 90.5%Â±1.7% 33.5%Â±1.0%\r\nConn: 8+5 Spread: 2 Limit: 10000/600 Avg/dev: 44.5%Â±17.0% 13.0%Â±5.1%\r\n\r\nConn: 8+5 Spread: 3 Limit: 10000/600 Avg/dev: 96.5%Â±9.7% 35.8%Â±3.6%\r\nConn: 8+0 Spread: 3 Limit: 10000/600 Avg/dev: 99.6%Â±0.1% 46.1%Â±0.2%\r\n```\r\n\r\nThat is, with 8 regular outbounds, sending addresses to 2 peers gives ~78% coverage of listening peers (and ~26% coverage of total peers) with 2 additional block-relay-only/blackhole peers, or ~90% coverage with this patch, or ~44% coverage without this patch and 5 additional block-relay-only peers instead of 2.\r\n\r\nWith a spread of 3 instead, then 5 block-relay-only peers gets to 96% coverage even without this patch (though with a large stddev), and with this patch as well gets to 99% coverage with a small standard deviation. So this seems like a \"both\" rather than an \"either/or\" situation to me.\r\n\r\nAddr relay is pretty low bandwidth, so I think the extra 50% of data for going from 2 to 3 is probably pretty fine (maybe make it 3 peers of which at most 2 are outbounds so that private peers don't increase traffic to listening nodes?); I'm not seeing what the privacy concerns should really be.\r\n\r\nI think these numbers are a bit more robust and better match @mzumsande's results. I switched the limit to 600s with poisson timing rather than 20 hops; provided there were enough samples the results between the two methods seemed pretty consistent.\r\n\r\nSo in summary, Concept ACK?",
      "created_at" : "2021-06-22T07:09:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-865658016",
      "id" : 865658016,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NTY1ODAxNg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-22T07:09:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/865658016",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Addr relay is pretty low bandwidth, so I think the extra 50% of data for going from 2 to 3 is probably pretty fine...\r\n\r\nI agree.\r\n\r\n> I'm not seeing what the privacy concerns should really be.\r\n\r\nMe neither.\r\n\r\nI reproduced the above results and ran one more simulation: just increase spread from 2 to 3:\r\n\r\n```\r\n# current (copy from above)\r\nConn: 8+2 Spread: 2 Limit: 10000/600 Avg/dev: 78.5%Â±9.7% 26.1%Â±3.5%\r\n\r\n# just increase spread from 2 to 3\r\nConn: 8+2 Spread: 3 Limit: 10000/600 Avg/dev: 99.1%/0.1% 41.4%/0.2%\r\n\r\n# increase spread from 2 to 3 and reduce blackholes as per this PR (copy from above)\r\nConn: 8+0 Spread: 3 Limit: 10000/600 Avg/dev: 99.6%Â±0.1% 46.1%Â±0.2%\r\n```\r\n\r\nSo, assuming spread is increased from 2 to 3 and we are at 99.1%/41.4% then this PR will only improve it to 99.6%/46.1% :eyes: \r\n\r\nAlso to consider relay of addresses from non-reachable networks, currently with spread 1.5. The script gives an error when given a float: TypeError: can't multiply sequence by non-int of type 'float'.",
      "created_at" : "2021-06-22T12:06:18Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-865926162",
      "id" : 865926162,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NTkyNjE2Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-22T12:06:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/865926162",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/266751?v=4",
         "events_url" : "https://api.github.com/users/vasild/events{/privacy}",
         "followers_url" : "https://api.github.com/users/vasild/followers",
         "following_url" : "https://api.github.com/users/vasild/following{/other_user}",
         "gists_url" : "https://api.github.com/users/vasild/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/vasild",
         "id" : 266751,
         "login" : "vasild",
         "node_id" : "MDQ6VXNlcjI2Njc1MQ==",
         "organizations_url" : "https://api.github.com/users/vasild/orgs",
         "received_events_url" : "https://api.github.com/users/vasild/received_events",
         "repos_url" : "https://api.github.com/users/vasild/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/vasild/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/vasild/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/vasild"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Also to consider relay of addresses from non-reachable networks, currently with spread 1.5.\r\n\r\nChanging the spread to `random.choice([1,2])` to simulate an address everyone considers unreachable gives about 5% coverage with 8 outbounds and 2 blackholes; but 27% with 8 outbounds and no blackholes (ie behaviour prior to block relay only nods or after this pr). If you wanted to model ipv4 vs ipv6 or tor, you'd need to model some nodes as considering those nets reachable and being peered with other nodes on the network (preferentially?) which would get complicated.",
      "created_at" : "2021-06-23T06:43:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-866573780",
      "id" : 866573780,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2NjU3Mzc4MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-23T06:43:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/866573780",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-07-19T11:48:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-882483617",
      "id" : 882483617,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "IC_kwDOABII5840maGh",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-19T11:48:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/882483617",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "### Latest push: \r\n- rebased on master \r\n- introduced a new variable, `addr_relay_enabled`, to the Peer struct. this is used to expose this information to `getpeerinfo` without causing a thread safety issue. The bool made the `RelayAddrsWithPeer` function redundant, so I removed that.\r\n- these commits are generally small & isolated, so I'm hoping this PR is pretty straightforward to review :) \r\n\r\n### Status of this PR: \r\n- Ready for review! ð\r\n- My research of alternative clients suggests these changes would not harm other software: https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-809906430\r\n- I believe I have addressed all of the conceptual concerns that have been expressed by reviewers.  \r\n\r\n### Future thought: \r\n\r\nIf this PR gets accepted & released, we should keep an eye on the peer rate limiting introduced in #22387. `MAX_ADDR_RATE_PER_SECOND` is currently set to `0.1` based on network observations + some buffer. If this patch were widely adopted, it's possible the observed rate could naturally increase. \r\n\r\nâï¸ Further explanation: based on an estimated number of listening nodes on the network & frequency of self announcements in Bitcoin Core, I was surprised to find the observed addr announcement rate / per / second to be ~0.025. I think a large part of the delta between conceptual mathÂ & observed frequency arises from blackhole rate (aka how well does a single announcement propagate) combined with the role of `m_addr_known`, which would fluctuate based on the node-path a specific announcement takes. \r\n\r\nAnyway, just want to mention that since this is a network level phenomena, its hard for us to accurately predict, and thus would want to observe. ",
      "created_at" : "2021-07-26T20:41:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-887012346",
      "id" : 887012346,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "IC_kwDOABII58403rv6",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-26T20:41:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887012346",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r676929839"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676929839"
         }
      },
      "author_association" : "MEMBER",
      "body" : "added `addr_relay_enabled` as an atomic to address this issue. ",
      "commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "created_at" : "2021-07-26T20:42:25Z",
      "diff_hunk" : "@@ -546,6 +543,20 @@ class CNode\n \n     // flood relay\n     std::vector<CAddress> vAddrToSend;\n+\n+    /** Bloom filter to track recent addr messages relayed with this peer.\n+     *\n+     *  We initialize this filter for outbound peers (other than\n+     *  block-relay-only connections) or when an inbound peer sends us an\n+     *  address related message (ADDR, ADDRV2, GETADDR, SENDADDRV2).\n+     *\n+     *  We use the presence of this filter to decide whether a peer is eligible\n+     *  for trickle relay of addr messages. This avoids relaying to peers that\n+     *  are unlikely to forward them, effectively blackholing self\n+     *  announcements. Reasons peers might not support addr relay on the link\n+     *  is if they connected to us as a block-relay-only peer or as a light\n+     *  client.\n+     * */\n     std::unique_ptr<CRollingBloomFilter> m_addr_known{nullptr};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r676929839",
      "id" : 676929839,
      "in_reply_to_id" : 605058607,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NjkyOTgzOQ==",
      "original_commit_id" : "0c194ffafd1ed23a9a65ca6f38a2388e34884388",
      "original_line" : 560,
      "original_position" : 34,
      "original_start_line" : null,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 715265031,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-26T20:42:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676929839",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677298006"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677298006"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        if (peer->addr_relay_enabled && id != originator && IsAddrCompatible(*peer, addr)) {\r\n```",
      "commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "created_at" : "2021-07-27T09:53:20Z",
      "diff_hunk" : "@@ -1681,7 +1696,7 @@ void PeerManagerImpl::RelayAddress(NodeId originator,\n     LOCK(m_peer_mutex);\n \n     for (auto& [id, peer] : m_peer_map) {\n-        if (RelayAddrsWithPeer(*peer) && id != originator && IsAddrCompatible(*peer, addr)) {\n+        if ( peer->addr_relay_enabled && id != originator && IsAddrCompatible(*peer, addr)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677298006",
      "id" : 677298006,
      "line" : 1699,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzI5ODAwNg==",
      "original_commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "original_line" : 1699,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 89,
      "pull_request_review_id" : 715716437,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-27T10:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677298006",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677298478"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677298478"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is this new `getaddr` message to trigger addr relay from the node? What do you think about just sending an empty `addr` message instead?",
      "commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "created_at" : "2021-07-27T09:53:59Z",
      "diff_hunk" : "@@ -166,11 +178,13 @@ def relay_tests(self):\n         # large GETADDR responses from being relayed, it now typically affects the self-announcement\n         # of the outbound peer which is often sent before the GETADDR response.\n         assert_equal(inbound_peer.num_ipv4_received, 0)\n+        inbound_peer.send_and_ping(msg_getaddr())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677298478",
      "id" : 677298478,
      "line" : 181,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzI5ODQ3OA==",
      "original_commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "original_line" : 181,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 68,
      "pull_request_review_id" : 715716437,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-27T10:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677298478",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677303641"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677303641"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n        return sum(bytes_recvd for (msg, bytes_recvd) in msgs_dict.items() if msg in ['addr', 'addrv2', 'getaddr', 'sendaddrv2'])\r\n```\r\n",
      "commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "created_at" : "2021-07-27T10:01:19Z",
      "diff_hunk" : "@@ -184,7 +198,68 @@ def relay_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def sum_addr_messages(self, msgs_dict):\n+        val = 0\n+        for msg in ['addr', 'addrv2', 'getaddr', 'sendaddrv2']:\n+            if msg in msgs_dict:\n+                val += msgs_dict[msg]\n+        return val",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677303641",
      "id" : 677303641,
      "line" : 206,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzMwMzY0MQ==",
      "original_commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "original_line" : 206,
      "original_position" : 88,
      "original_start_line" : 202,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 88,
      "pull_request_review_id" : 715716437,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : 202,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-27T10:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677303641",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677304728"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677304728"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps move this above the `m_getaddr_recvd` logic (to avoid reading the unused `m_getaddr_recvd` value for non-addr-relay peers).",
      "commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "created_at" : "2021-07-27T10:03:01Z",
      "diff_hunk" : "@@ -3725,6 +3743,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n         peer->m_getaddr_recvd = true;\n \n+        SetupAddressRelay(pfrom);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677304728",
      "id" : 677304728,
      "line" : 3746,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzMwNDcyOA==",
      "original_commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "original_line" : 3746,
      "original_position" : 132,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 132,
      "pull_request_review_id" : 715716437,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-27T10:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677304728",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677307450"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677307450"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is a bit misleading. The logic block below contains self-advertisement logic, but it also sends a `getaddr` to request addresses, which is not self-advertisement.",
      "commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "created_at" : "2021-07-27T10:07:04Z",
      "diff_hunk" : "@@ -2572,7 +2587,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         UpdatePreferredDownload(pfrom, State(pfrom.GetId()));\n         }\n \n-        if (!pfrom.IsInboundConn() && !pfrom.IsBlockOnlyConn()) {\n+        // Self advertisement logic",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677307450",
      "id" : 677307450,
      "line" : 2590,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzMwNzQ1MA==",
      "original_commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "original_line" : 2590,
      "original_position" : 98,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 98,
      "pull_request_review_id" : 715716437,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-27T10:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677307450",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677310663"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677310663"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'd very much prefer not to introduce the word 'trickle' here. I've only ever heard the word 'trickle' being used to refer to transaction propagation (eg #7125). Adding the word here would be overloading the term with a new meaning.",
      "commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "created_at" : "2021-07-27T10:11:21Z",
      "diff_hunk" : "@@ -224,9 +224,23 @@ struct Peer {\n \n     /** A vector of addresses to send to the peer, limited to MAX_ADDR_TO_SEND. */\n     std::vector<CAddress> m_addrs_to_send;\n-    /** Probabilistic filter of addresses that this peer already knows.\n-     *  Used to avoid relaying addresses to this peer more than once. */\n-    const std::unique_ptr<CRollingBloomFilter> m_addr_known;\n+    /** Bloom filter to track recent addr messages relayed with this peer.\n+     *\n+     *  We initialize this filter for outbound peers (other than\n+     *  block-relay-only connections) or when an inbound peer sends us an\n+     *  address related message (ADDR, ADDRV2, GETADDR).\n+     *\n+     *  We use the presence of this filter to decide whether a peer is eligible\n+     *  for trickle relay of addr messages. This avoids relaying to peers that",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677310663",
      "id" : 677310663,
      "line" : 234,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzMxMDY2Mw==",
      "original_commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "original_line" : 234,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 14,
      "pull_request_review_id" : 715716437,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-27T10:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677310663",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677310877"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677310877"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Same comment as above about the word \"trickle\"",
      "commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "created_at" : "2021-07-27T10:11:41Z",
      "diff_hunk" : "@@ -184,7 +198,68 @@ def relay_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def sum_addr_messages(self, msgs_dict):\n+        val = 0\n+        for msg in ['addr', 'addrv2', 'getaddr', 'sendaddrv2']:\n+            if msg in msgs_dict:\n+                val += msgs_dict[msg]\n+        return val\n+\n+    def inbound_blackhole_tests(self):\n+        self.log.info('Check that we only relay addresses to inbound peers who have previously sent us addr related messages')\n+\n+        addr_source = self.nodes[0].add_p2p_connection(P2PInterface())\n+        receiver_peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+        blackhole_peer = self.nodes[0].add_p2p_connection(AddrReceiver(send_getaddr=False))\n+        initial_addrs_received = receiver_peer.num_ipv4_received\n+\n+        peerinfo = self.nodes[0].getpeerinfo()\n+        assert_equal(peerinfo[0]['addr_relay_enabled'], True)  # addr_source\n+        assert_equal(peerinfo[1]['addr_relay_enabled'], True)  # receiver_peer\n+        assert_equal(peerinfo[2]['addr_relay_enabled'], False)  # blackhole_peer\n+\n+        # addr_source sends 2 addresses to node0\n+        msg = self.setup_addr_msg(2)\n+        addr_source.send_and_ping(msg)\n+        self.mocktime += 30 * 60\n+        self.nodes[0].setmocktime(self.mocktime)\n+        receiver_peer.sync_with_ping()\n+        blackhole_peer.sync_with_ping()\n+\n+        peerinfo = self.nodes[0].getpeerinfo()\n+\n+        # Confirm node received addr-related messages from receiver peer\n+        assert_greater_than(self.sum_addr_messages(peerinfo[1]['bytesrecv_per_msg']), 0)\n+        # And that peer received addresses\n+        assert_equal(receiver_peer.num_ipv4_received - initial_addrs_received, 2)\n+\n+        # Confirm node has not received addr-related messages from blackhole peer\n+        assert_equal(self.sum_addr_messages(peerinfo[2]['bytesrecv_per_msg']), 0)\n+        # And that peer did not receive addresses\n+        assert_equal(blackhole_peer.num_ipv4_received, 0)\n+\n+        self.log.info(\"After blackhole peer sends addr message, it becomes eligible for trickle relay\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677310877",
      "id" : 677310877,
      "line" : 241,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzMxMDg3Nw==",
      "original_commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "original_line" : 241,
      "original_position" : 123,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 123,
      "pull_request_review_id" : 715716437,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-27T10:32:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677310877",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677311723"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677311723"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Also, remove `sendaddrv2` from the list?",
      "commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "created_at" : "2021-07-27T10:12:50Z",
      "diff_hunk" : "@@ -184,7 +198,68 @@ def relay_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def sum_addr_messages(self, msgs_dict):\n+        val = 0\n+        for msg in ['addr', 'addrv2', 'getaddr', 'sendaddrv2']:\n+            if msg in msgs_dict:\n+                val += msgs_dict[msg]\n+        return val",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677311723",
      "id" : 677311723,
      "in_reply_to_id" : 677303641,
      "line" : 206,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzMxMTcyMw==",
      "original_commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "original_line" : 206,
      "original_position" : 88,
      "original_start_line" : 202,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 88,
      "pull_request_review_id" : 715716437,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : 202,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-27T10:32:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677311723",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677318087"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677318087"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is no longer true. We use `addr_relay_enabled` to decide whether a peer is eligible for addr relay.",
      "commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "created_at" : "2021-07-27T10:22:22Z",
      "diff_hunk" : "@@ -224,9 +224,23 @@ struct Peer {\n \n     /** A vector of addresses to send to the peer, limited to MAX_ADDR_TO_SEND. */\n     std::vector<CAddress> m_addrs_to_send;\n-    /** Probabilistic filter of addresses that this peer already knows.\n-     *  Used to avoid relaying addresses to this peer more than once. */\n-    const std::unique_ptr<CRollingBloomFilter> m_addr_known;\n+    /** Bloom filter to track recent addr messages relayed with this peer.\n+     *\n+     *  We initialize this filter for outbound peers (other than\n+     *  block-relay-only connections) or when an inbound peer sends us an\n+     *  address related message (ADDR, ADDRV2, GETADDR).\n+     *\n+     *  We use the presence of this filter to decide whether a peer is eligible\n+     *  for trickle relay of addr messages. This avoids relaying to peers that\n+     *  are unlikely to forward them, effectively blackholing self\n+     *  announcements. Reasons peers might not support addr relay on the link\n+     *  include that they connected to us as a block-relay-only peer or they\n+     *  are a light client.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677318087",
      "id" : 677318087,
      "line" : 238,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzMxODA4Nw==",
      "original_commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "original_line" : 238,
      "original_position" : 18,
      "original_start_line" : 233,
      "path" : "src/net_processing.cpp",
      "position" : 18,
      "pull_request_review_id" : 715716437,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : 233,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-27T10:32:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677318087",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677318160"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677318160"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    std::atomic_bool m_addr_relay_enabled{false};\r\n```",
      "commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "created_at" : "2021-07-27T10:22:29Z",
      "diff_hunk" : "@@ -224,9 +224,23 @@ struct Peer {\n \n     /** A vector of addresses to send to the peer, limited to MAX_ADDR_TO_SEND. */\n     std::vector<CAddress> m_addrs_to_send;\n-    /** Probabilistic filter of addresses that this peer already knows.\n-     *  Used to avoid relaying addresses to this peer more than once. */\n-    const std::unique_ptr<CRollingBloomFilter> m_addr_known;\n+    /** Bloom filter to track recent addr messages relayed with this peer.\n+     *\n+     *  We initialize this filter for outbound peers (other than\n+     *  block-relay-only connections) or when an inbound peer sends us an\n+     *  address related message (ADDR, ADDRV2, GETADDR).\n+     *\n+     *  We use the presence of this filter to decide whether a peer is eligible\n+     *  for trickle relay of addr messages. This avoids relaying to peers that\n+     *  are unlikely to forward them, effectively blackholing self\n+     *  announcements. Reasons peers might not support addr relay on the link\n+     *  include that they connected to us as a block-relay-only peer or they\n+     *  are a light client.\n+     **/\n+    std::unique_ptr<CRollingBloomFilter> m_addr_known;\n+    /** Whether we are participating in address relay with this connection.\n+     *  Must correlate with whether m_addr_known has been initialized. */\n+    std::atomic_bool addr_relay_enabled{false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677318160",
      "id" : 677318160,
      "line" : 243,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzMxODE2MA==",
      "original_commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "original_line" : 243,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 23,
      "pull_request_review_id" : 715716437,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-27T10:32:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677318160",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677321159"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677321159"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n    bool m_addr_relay_enabled;\r\n```",
      "commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "created_at" : "2021-07-27T10:27:34Z",
      "diff_hunk" : "@@ -31,6 +31,7 @@ struct CNodeStateStats {\n     std::vector<int> vHeightInFlight;\n     uint64_t m_addr_processed = 0;\n     uint64_t m_addr_rate_limited = 0;\n+    bool addr_relay_enabled;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677321159",
      "id" : 677321159,
      "line" : 34,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzMyMTE1OQ==",
      "original_commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "original_line" : 34,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : 4,
      "pull_request_review_id" : 715716437,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-27T10:32:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677321159",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677322503"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677322503"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You can atomically test and set the flag as follows:\r\n\r\n```suggestion\r\n    if (!peer->addr_relay_enabled.exchange(true)) {\r\n        // First addr message we have received from the peer, initialize\r\n        // m_addr_known\r\n        peer->m_addr_known = std::make_unique<CRollingBloomFilter>(5000, 0.001);\r\n```\r\n\r\n(`std::atomic<T>::exchange()` returns the value of the object before the call (https://en.cppreference.com/w/cpp/atomic/atomic/exchange))",
      "commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "created_at" : "2021-07-27T10:29:35Z",
      "diff_hunk" : "@@ -4423,6 +4443,24 @@ class CompareInvMempoolOrder\n };\n }\n \n+bool PeerManagerImpl::SetupAddressRelay(CNode& node) const\n+{\n+    // We don't participate in addr relay with outbound block-relay-only\n+    // connections to prevent providing adversaries with the additional\n+    // information of addr traffic to infer the link.\n+    if (node.IsBlockOnlyConn()) return false;\n+\n+    PeerRef peer = GetPeerRef(node.GetId());\n+    if (!peer->addr_relay_enabled) {\n+        // First addr message we have received from the peer, initialize\n+        // m_addr_known\n+        peer->m_addr_known = std::make_unique<CRollingBloomFilter>(5000, 0.001);\n+        peer->addr_relay_enabled = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677322503",
      "id" : 677322503,
      "line" : 4458,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzMyMjUwMw==",
      "original_commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "original_line" : 4458,
      "original_position" : 162,
      "original_start_line" : 4454,
      "path" : "src/net_processing.cpp",
      "position" : 162,
      "pull_request_review_id" : 715716437,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : 4454,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-27T10:32:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677322503",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677762857"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677762857"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't follow- there is an earlier clause that returns early if `!IsInboundConn`, so `SetupAddressRelay` should never return false. So I don't think the order matters here? ",
      "commit_id" : "ceb20ad575cb2cbe971844e8a6422eca87d44bbb",
      "created_at" : "2021-07-27T20:07:08Z",
      "diff_hunk" : "@@ -3725,6 +3743,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n         peer->m_getaddr_recvd = true;\n \n+        SetupAddressRelay(pfrom);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677762857",
      "id" : 677762857,
      "in_reply_to_id" : 677304728,
      "line" : 3754,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3Nzc2Mjg1Nw==",
      "original_commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "original_line" : 3754,
      "original_position" : 132,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 140,
      "pull_request_review_id" : 716330681,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-27T20:07:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677762857",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677804715"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677804715"
         }
      },
      "author_association" : "MEMBER",
      "body" : "fixed",
      "commit_id" : "ceb20ad575cb2cbe971844e8a6422eca87d44bbb",
      "created_at" : "2021-07-27T21:13:44Z",
      "diff_hunk" : "@@ -1681,7 +1696,7 @@ void PeerManagerImpl::RelayAddress(NodeId originator,\n     LOCK(m_peer_mutex);\n \n     for (auto& [id, peer] : m_peer_map) {\n-        if (RelayAddrsWithPeer(*peer) && id != originator && IsAddrCompatible(*peer, addr)) {\n+        if ( peer->addr_relay_enabled && id != originator && IsAddrCompatible(*peer, addr)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677804715",
      "id" : 677804715,
      "in_reply_to_id" : 677298006,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzgwNDcxNQ==",
      "original_commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "original_line" : 1699,
      "original_position" : 89,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 716384429,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-27T21:13:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677804715",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677806027"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677806027"
         }
      },
      "author_association" : "MEMBER",
      "body" : "good idea! done & added a comment",
      "commit_id" : "ceb20ad575cb2cbe971844e8a6422eca87d44bbb",
      "created_at" : "2021-07-27T21:15:51Z",
      "diff_hunk" : "@@ -166,11 +178,13 @@ def relay_tests(self):\n         # large GETADDR responses from being relayed, it now typically affects the self-announcement\n         # of the outbound peer which is often sent before the GETADDR response.\n         assert_equal(inbound_peer.num_ipv4_received, 0)\n+        inbound_peer.send_and_ping(msg_getaddr())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677806027",
      "id" : 677806027,
      "in_reply_to_id" : 677298478,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzgwNjAyNw==",
      "original_commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "original_line" : 181,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : null,
      "pull_request_review_id" : 716385982,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-27T21:15:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677806027",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677806229"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677806229"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done and done",
      "commit_id" : "ceb20ad575cb2cbe971844e8a6422eca87d44bbb",
      "created_at" : "2021-07-27T21:16:10Z",
      "diff_hunk" : "@@ -184,7 +198,68 @@ def relay_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def sum_addr_messages(self, msgs_dict):\n+        val = 0\n+        for msg in ['addr', 'addrv2', 'getaddr', 'sendaddrv2']:\n+            if msg in msgs_dict:\n+                val += msgs_dict[msg]\n+        return val",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677806229",
      "id" : 677806229,
      "in_reply_to_id" : 677303641,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzgwNjIyOQ==",
      "original_commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "original_line" : 206,
      "original_position" : 88,
      "original_start_line" : 202,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : null,
      "pull_request_review_id" : 716386227,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-27T21:16:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677806229",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677806468"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677806468"
         }
      },
      "author_association" : "MEMBER",
      "body" : "good point, updated to include ",
      "commit_id" : "ceb20ad575cb2cbe971844e8a6422eca87d44bbb",
      "created_at" : "2021-07-27T21:16:36Z",
      "diff_hunk" : "@@ -2572,7 +2587,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         UpdatePreferredDownload(pfrom, State(pfrom.GetId()));\n         }\n \n-        if (!pfrom.IsInboundConn() && !pfrom.IsBlockOnlyConn()) {\n+        // Self advertisement logic",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677806468",
      "id" : 677806468,
      "in_reply_to_id" : 677307450,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzgwNjQ2OA==",
      "original_commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "original_line" : 2590,
      "original_position" : 98,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 716386505,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-27T21:16:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677806468",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677807103"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677807103"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ah gotcha. I updated the language to use \"gossiping addr messages\", does that feel more appropriate / consistent? \r\n\r\n(also mentioned in https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677310877, linking as a reminder to myself for potential future updates)",
      "commit_id" : "ceb20ad575cb2cbe971844e8a6422eca87d44bbb",
      "created_at" : "2021-07-27T21:17:32Z",
      "diff_hunk" : "@@ -224,9 +224,23 @@ struct Peer {\n \n     /** A vector of addresses to send to the peer, limited to MAX_ADDR_TO_SEND. */\n     std::vector<CAddress> m_addrs_to_send;\n-    /** Probabilistic filter of addresses that this peer already knows.\n-     *  Used to avoid relaying addresses to this peer more than once. */\n-    const std::unique_ptr<CRollingBloomFilter> m_addr_known;\n+    /** Bloom filter to track recent addr messages relayed with this peer.\n+     *\n+     *  We initialize this filter for outbound peers (other than\n+     *  block-relay-only connections) or when an inbound peer sends us an\n+     *  address related message (ADDR, ADDRV2, GETADDR).\n+     *\n+     *  We use the presence of this filter to decide whether a peer is eligible\n+     *  for trickle relay of addr messages. This avoids relaying to peers that",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677807103",
      "id" : 677807103,
      "in_reply_to_id" : 677310663,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzgwNzEwMw==",
      "original_commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "original_line" : 234,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 716387229,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-27T21:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677807103",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677807351"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677807351"
         }
      },
      "author_association" : "MEMBER",
      "body" : "convo continued in https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677807103, resolving this thread",
      "commit_id" : "ceb20ad575cb2cbe971844e8a6422eca87d44bbb",
      "created_at" : "2021-07-27T21:18:00Z",
      "diff_hunk" : "@@ -184,7 +198,68 @@ def relay_tests(self):\n \n         self.nodes[0].disconnect_p2ps()\n \n+    def sum_addr_messages(self, msgs_dict):\n+        val = 0\n+        for msg in ['addr', 'addrv2', 'getaddr', 'sendaddrv2']:\n+            if msg in msgs_dict:\n+                val += msgs_dict[msg]\n+        return val\n+\n+    def inbound_blackhole_tests(self):\n+        self.log.info('Check that we only relay addresses to inbound peers who have previously sent us addr related messages')\n+\n+        addr_source = self.nodes[0].add_p2p_connection(P2PInterface())\n+        receiver_peer = self.nodes[0].add_p2p_connection(AddrReceiver())\n+        blackhole_peer = self.nodes[0].add_p2p_connection(AddrReceiver(send_getaddr=False))\n+        initial_addrs_received = receiver_peer.num_ipv4_received\n+\n+        peerinfo = self.nodes[0].getpeerinfo()\n+        assert_equal(peerinfo[0]['addr_relay_enabled'], True)  # addr_source\n+        assert_equal(peerinfo[1]['addr_relay_enabled'], True)  # receiver_peer\n+        assert_equal(peerinfo[2]['addr_relay_enabled'], False)  # blackhole_peer\n+\n+        # addr_source sends 2 addresses to node0\n+        msg = self.setup_addr_msg(2)\n+        addr_source.send_and_ping(msg)\n+        self.mocktime += 30 * 60\n+        self.nodes[0].setmocktime(self.mocktime)\n+        receiver_peer.sync_with_ping()\n+        blackhole_peer.sync_with_ping()\n+\n+        peerinfo = self.nodes[0].getpeerinfo()\n+\n+        # Confirm node received addr-related messages from receiver peer\n+        assert_greater_than(self.sum_addr_messages(peerinfo[1]['bytesrecv_per_msg']), 0)\n+        # And that peer received addresses\n+        assert_equal(receiver_peer.num_ipv4_received - initial_addrs_received, 2)\n+\n+        # Confirm node has not received addr-related messages from blackhole peer\n+        assert_equal(self.sum_addr_messages(peerinfo[2]['bytesrecv_per_msg']), 0)\n+        # And that peer did not receive addresses\n+        assert_equal(blackhole_peer.num_ipv4_received, 0)\n+\n+        self.log.info(\"After blackhole peer sends addr message, it becomes eligible for trickle relay\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677807351",
      "id" : 677807351,
      "in_reply_to_id" : 677310877,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzgwNzM1MQ==",
      "original_commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "original_line" : 241,
      "original_position" : 123,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : null,
      "pull_request_review_id" : 716387566,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-27T21:18:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677807351",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677808295"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677808295"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ah good point. updated the comments on both `m_addr_known` and `m_addr_relay_enabled`",
      "commit_id" : "ceb20ad575cb2cbe971844e8a6422eca87d44bbb",
      "created_at" : "2021-07-27T21:19:39Z",
      "diff_hunk" : "@@ -224,9 +224,23 @@ struct Peer {\n \n     /** A vector of addresses to send to the peer, limited to MAX_ADDR_TO_SEND. */\n     std::vector<CAddress> m_addrs_to_send;\n-    /** Probabilistic filter of addresses that this peer already knows.\n-     *  Used to avoid relaying addresses to this peer more than once. */\n-    const std::unique_ptr<CRollingBloomFilter> m_addr_known;\n+    /** Bloom filter to track recent addr messages relayed with this peer.\n+     *\n+     *  We initialize this filter for outbound peers (other than\n+     *  block-relay-only connections) or when an inbound peer sends us an\n+     *  address related message (ADDR, ADDRV2, GETADDR).\n+     *\n+     *  We use the presence of this filter to decide whether a peer is eligible\n+     *  for trickle relay of addr messages. This avoids relaying to peers that\n+     *  are unlikely to forward them, effectively blackholing self\n+     *  announcements. Reasons peers might not support addr relay on the link\n+     *  include that they connected to us as a block-relay-only peer or they\n+     *  are a light client.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677808295",
      "id" : 677808295,
      "in_reply_to_id" : 677318087,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzgwODI5NQ==",
      "original_commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "original_line" : 238,
      "original_position" : 18,
      "original_start_line" : 233,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 716388652,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-27T21:19:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677808295",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677808482"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677808482"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done, thanks",
      "commit_id" : "ceb20ad575cb2cbe971844e8a6422eca87d44bbb",
      "created_at" : "2021-07-27T21:19:56Z",
      "diff_hunk" : "@@ -224,9 +224,23 @@ struct Peer {\n \n     /** A vector of addresses to send to the peer, limited to MAX_ADDR_TO_SEND. */\n     std::vector<CAddress> m_addrs_to_send;\n-    /** Probabilistic filter of addresses that this peer already knows.\n-     *  Used to avoid relaying addresses to this peer more than once. */\n-    const std::unique_ptr<CRollingBloomFilter> m_addr_known;\n+    /** Bloom filter to track recent addr messages relayed with this peer.\n+     *\n+     *  We initialize this filter for outbound peers (other than\n+     *  block-relay-only connections) or when an inbound peer sends us an\n+     *  address related message (ADDR, ADDRV2, GETADDR).\n+     *\n+     *  We use the presence of this filter to decide whether a peer is eligible\n+     *  for trickle relay of addr messages. This avoids relaying to peers that\n+     *  are unlikely to forward them, effectively blackholing self\n+     *  announcements. Reasons peers might not support addr relay on the link\n+     *  include that they connected to us as a block-relay-only peer or they\n+     *  are a light client.\n+     **/\n+    std::unique_ptr<CRollingBloomFilter> m_addr_known;\n+    /** Whether we are participating in address relay with this connection.\n+     *  Must correlate with whether m_addr_known has been initialized. */\n+    std::atomic_bool addr_relay_enabled{false};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677808482",
      "id" : 677808482,
      "in_reply_to_id" : 677318160,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzgwODQ4Mg==",
      "original_commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "original_line" : 243,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 716388829,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-27T21:19:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677808482",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677808551"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677808551"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "ceb20ad575cb2cbe971844e8a6422eca87d44bbb",
      "created_at" : "2021-07-27T21:20:03Z",
      "diff_hunk" : "@@ -31,6 +31,7 @@ struct CNodeStateStats {\n     std::vector<int> vHeightInFlight;\n     uint64_t m_addr_processed = 0;\n     uint64_t m_addr_rate_limited = 0;\n+    bool addr_relay_enabled;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677808551",
      "id" : 677808551,
      "in_reply_to_id" : 677321159,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzgwODU1MQ==",
      "original_commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "original_line" : 34,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 716388920,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-27T21:20:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677808551",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677808677"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677808677"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nice trick! done",
      "commit_id" : "ceb20ad575cb2cbe971844e8a6422eca87d44bbb",
      "created_at" : "2021-07-27T21:20:15Z",
      "diff_hunk" : "@@ -4423,6 +4443,24 @@ class CompareInvMempoolOrder\n };\n }\n \n+bool PeerManagerImpl::SetupAddressRelay(CNode& node) const\n+{\n+    // We don't participate in addr relay with outbound block-relay-only\n+    // connections to prevent providing adversaries with the additional\n+    // information of addr traffic to infer the link.\n+    if (node.IsBlockOnlyConn()) return false;\n+\n+    PeerRef peer = GetPeerRef(node.GetId());\n+    if (!peer->addr_relay_enabled) {\n+        // First addr message we have received from the peer, initialize\n+        // m_addr_known\n+        peer->m_addr_known = std::make_unique<CRollingBloomFilter>(5000, 0.001);\n+        peer->addr_relay_enabled = true;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677808677",
      "id" : 677808677,
      "in_reply_to_id" : 677322503,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzgwODY3Nw==",
      "original_commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "original_line" : 4458,
      "original_position" : 162,
      "original_start_line" : 4454,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 716389049,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-27T21:20:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677808677",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "thanks for the review @jnewbery! incorporated all your feedback with one or two questions. \r\n\r\n> I think the use of an atomic addr_relay_enabled is fine for now. Perhaps once #21527 has landed and we have proper locking in net_processing, m_addr_known can be guarded by the net processing lock and we can lose the additional atomic bool.\r\n\r\nsounds good, I would definitely prefer that approach.",
      "created_at" : "2021-07-27T21:22:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-887843936",
      "id" : 887843936,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "IC_kwDOABII584062xg",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T21:22:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887843936",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677822334"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677822334"
         }
      },
      "author_association" : "MEMBER",
      "body" : "\"gossiping addr messages\" SGTM!",
      "commit_id" : "ceb20ad575cb2cbe971844e8a6422eca87d44bbb",
      "created_at" : "2021-07-27T21:45:17Z",
      "diff_hunk" : "@@ -224,9 +224,23 @@ struct Peer {\n \n     /** A vector of addresses to send to the peer, limited to MAX_ADDR_TO_SEND. */\n     std::vector<CAddress> m_addrs_to_send;\n-    /** Probabilistic filter of addresses that this peer already knows.\n-     *  Used to avoid relaying addresses to this peer more than once. */\n-    const std::unique_ptr<CRollingBloomFilter> m_addr_known;\n+    /** Bloom filter to track recent addr messages relayed with this peer.\n+     *\n+     *  We initialize this filter for outbound peers (other than\n+     *  block-relay-only connections) or when an inbound peer sends us an\n+     *  address related message (ADDR, ADDRV2, GETADDR).\n+     *\n+     *  We use the presence of this filter to decide whether a peer is eligible\n+     *  for trickle relay of addr messages. This avoids relaying to peers that",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r677822334",
      "id" : 677822334,
      "in_reply_to_id" : 677310663,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NzgyMjMzNA==",
      "original_commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "original_line" : 234,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 716405818,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-27T21:45:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/677822334",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r678092470"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/678092470"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm not sure it makes sense to declare this method `const`. It doesn't mutate the state of the `PeerManagerImpl` object itself, but it can mutate a `Peer` object, which is owned by `PeerManagerImpl`.",
      "commit_id" : "00a54cbddbc6bc69c30a9597f6e669b1af331d65",
      "created_at" : "2021-07-28T08:33:58Z",
      "diff_hunk" : "@@ -612,6 +633,14 @@ class PeerManagerImpl final : public PeerManager\n      * @param[in]   vRecv           The raw message received\n      */\n     void ProcessGetCFCheckPt(CNode& peer, CDataStream& vRecv);\n+\n+    /** Checks if address relay is permitted with peer. If needed, initializes\n+     * the m_addr_known bloom filter and sets m_addr_relay_enabled to true.\n+     *\n+     *  @return   True if address relay is enabled with peer\n+     *            False if address relay is disallowed\n+     */\n+    bool SetupAddressRelay(CNode& node) const;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r678092470",
      "id" : 678092470,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3ODA5MjQ3MA==",
      "original_commit_id" : "ceb20ad575cb2cbe971844e8a6422eca87d44bbb",
      "original_line" : 643,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 716729381,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-28T11:23:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/678092470",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r678098001"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/678098001"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Logically, I think it makes sense to not access any addr data members until after `SetupAddressRelay()` is called. You're right that for now the ordering doesn't matter, but  I could imagine in the future we might want to collect the addr relay data members (`m_addrs_to_send`, `m_getaddr_sent`, `m_addr_send_times_mutex`, `m_next_addr_send`, etc)\r\ninto a struct which is initialized by `SetupAddressRelay()`, and only access those members after calling `SetupAddressRelay()`.\r\n\r\nI'll mark this comment as resolved.",
      "commit_id" : "00a54cbddbc6bc69c30a9597f6e669b1af331d65",
      "created_at" : "2021-07-28T08:41:20Z",
      "diff_hunk" : "@@ -3725,6 +3743,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n         peer->m_getaddr_recvd = true;\n \n+        SetupAddressRelay(pfrom);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r678098001",
      "id" : 678098001,
      "in_reply_to_id" : 677304728,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3ODA5ODAwMQ==",
      "original_commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "original_line" : 3754,
      "original_position" : 132,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 716729381,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-28T11:23:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/678098001",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r678209791"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/678209791"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe explicitly default initialize this to `false`:\r\n\r\n```suggestion\r\n    bool m_addr_relay_enabled{false};\r\n```",
      "commit_id" : "00a54cbddbc6bc69c30a9597f6e669b1af331d65",
      "created_at" : "2021-07-28T11:22:03Z",
      "diff_hunk" : "@@ -31,6 +31,7 @@ struct CNodeStateStats {\n     std::vector<int> vHeightInFlight;\n     uint64_t m_addr_processed = 0;\n     uint64_t m_addr_rate_limited = 0;\n+    bool m_addr_relay_enabled;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r678209791",
      "id" : 678209791,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3ODIwOTc5MQ==",
      "original_commit_id" : "ceb20ad575cb2cbe971844e8a6422eca87d44bbb",
      "original_line" : 34,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 716729381,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-28T11:23:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/678209791",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r678686278"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/678686278"
         }
      },
      "author_association" : "MEMBER",
      "body" : "removed",
      "commit_id" : "00a54cbddbc6bc69c30a9597f6e669b1af331d65",
      "created_at" : "2021-07-28T22:09:32Z",
      "diff_hunk" : "@@ -612,6 +633,14 @@ class PeerManagerImpl final : public PeerManager\n      * @param[in]   vRecv           The raw message received\n      */\n     void ProcessGetCFCheckPt(CNode& peer, CDataStream& vRecv);\n+\n+    /** Checks if address relay is permitted with peer. If needed, initializes\n+     * the m_addr_known bloom filter and sets m_addr_relay_enabled to true.\n+     *\n+     *  @return   True if address relay is enabled with peer\n+     *            False if address relay is disallowed\n+     */\n+    bool SetupAddressRelay(CNode& node) const;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r678686278",
      "id" : 678686278,
      "in_reply_to_id" : 678092470,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3ODY4NjI3OA==",
      "original_commit_id" : "ceb20ad575cb2cbe971844e8a6422eca87d44bbb",
      "original_line" : 643,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 717507510,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-28T22:09:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/678686278",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r678686351"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/678686351"
         }
      },
      "author_association" : "MEMBER",
      "body" : "done",
      "commit_id" : "00a54cbddbc6bc69c30a9597f6e669b1af331d65",
      "created_at" : "2021-07-28T22:09:43Z",
      "diff_hunk" : "@@ -31,6 +31,7 @@ struct CNodeStateStats {\n     std::vector<int> vHeightInFlight;\n     uint64_t m_addr_processed = 0;\n     uint64_t m_addr_rate_limited = 0;\n+    bool m_addr_relay_enabled;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r678686351",
      "id" : 678686351,
      "in_reply_to_id" : 678209791,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3ODY4NjM1MQ==",
      "original_commit_id" : "ceb20ad575cb2cbe971844e8a6422eca87d44bbb",
      "original_line" : 34,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/net_processing.h",
      "position" : null,
      "pull_request_review_id" : 717507607,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-28T22:09:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/678686351",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r678686487"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/678686487"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ah gotcha, ok! moved",
      "commit_id" : "00a54cbddbc6bc69c30a9597f6e669b1af331d65",
      "created_at" : "2021-07-28T22:10:02Z",
      "diff_hunk" : "@@ -3725,6 +3743,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n         peer->m_getaddr_recvd = true;\n \n+        SetupAddressRelay(pfrom);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r678686487",
      "id" : 678686487,
      "in_reply_to_id" : 677304728,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3ODY4NjQ4Nw==",
      "original_commit_id" : "d16a2296bf86ea1ed44dd745ac9a567849947473",
      "original_line" : 3754,
      "original_position" : 132,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 717507767,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-28T22:10:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/678686487",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@jnewbery \r\n- incorporated all your feedback\r\n- also took a look at your branch, it looks awesome! I think it makes a lot of sense to encapsulate the address related data into a small data structure & only initialize where needed. I'd be happy to see this sorta thing through as a follow-up, if these changes get accepted. thank you!",
      "created_at" : "2021-07-28T22:12:54Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-888655176",
      "id" : 888655176,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "IC_kwDOABII5840981I",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-28T22:12:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/888655176",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review ACK 00a54cbddbc6bc69c30a9597f6e669b1af331d65",
      "created_at" : "2021-07-29T11:28:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-889039481",
      "id" : 889039481,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "IC_kwDOABII5840_ap5",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-29T11:28:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/889039481",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r679074888"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/679074888"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Any reason to not pass in `PeerRef peer` from outside and remove this line?",
      "commit_id" : "00a54cbddbc6bc69c30a9597f6e669b1af331d65",
      "created_at" : "2021-07-29T11:43:48Z",
      "diff_hunk" : "@@ -4423,6 +4431,23 @@ class CompareInvMempoolOrder\n };\n }\n \n+bool PeerManagerImpl::SetupAddressRelay(CNode& node)\n+{\n+    // We don't participate in addr relay with outbound block-relay-only\n+    // connections to prevent providing adversaries with the additional\n+    // information of addr traffic to infer the link.\n+    if (node.IsBlockOnlyConn()) return false;\n+\n+    PeerRef peer = GetPeerRef(node.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r679074888",
      "id" : 679074888,
      "line" : 4461,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3OTA3NDg4OA==",
      "original_commit_id" : "4ef28624c3f8238e3688f841ba9d67e67ec747d0",
      "original_line" : 4441,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 165,
      "pull_request_review_id" : 717991899,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-29T12:00:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/679074888",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r679085653"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/679085653"
         }
      },
      "author_association" : "MEMBER",
      "body" : "7e4662b8a0ea0428aa9eefe7b8116f85e5eda486: blackholing",
      "commit_id" : "00a54cbddbc6bc69c30a9597f6e669b1af331d65",
      "created_at" : "2021-07-29T12:00:33Z",
      "diff_hunk" : "@@ -230,8 +230,25 @@ struct Peer {\n      *  We initialize this filter for outbound peers (other than\n      *  block-relay-only connections) or when an inbound peer sends us an\n      *  address related message (ADDR, ADDRV2, GETADDR).\n+     *\n+     *  Presence of this filter must correlate with m_addr_relay_enabled.\n      **/\n     std::unique_ptr<CRollingBloomFilter> m_addr_known;\n+    /** Whether we are participating in address relay with this connection.\n+     *\n+     *  We set this bool to true for outbound peers (other than\n+     *  block-relay-only connections), or when an inbound peer sends us an\n+     *  address related message (ADDR, ADDRV2, GETADDR).\n+     *\n+     *  We use this bool to decide whether a peer is eligible for gossiping\n+     *  addr messages. This avoids relaying to peers that are unlikely to\n+     *  forward them, effectively blaackholing self announcements. Reasons",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r679085653",
      "id" : 679085653,
      "line" : 245,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3OTA4NTY1Mw==",
      "original_commit_id" : "7e4662b8a0ea0428aa9eefe7b8116f85e5eda486",
      "original_line" : 245,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 25,
      "pull_request_review_id" : 717991899,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-29T12:00:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/679085653",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r679338070"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/679338070"
         }
      },
      "author_association" : "MEMBER",
      "body" : "no particular reason _not_ to, I'm trying to understand the differences... \r\n\r\ncurrent implementation: uses `GetPeerRef` which constructs an additional `shared_ptr`, and would have to update the control block used to coordinate between the pointers. \r\n\r\nyour suggestion: passing in `PeerRef peer`, doesn't this increment the refcount at the beginning of the function & decrement at the end? so what difference does it make? \r\n\r\nanother alternative: passing in `Peer& peer`. does this mean the lifetime of the reference would just be managed in the normal program execution? so would that mean this is the most efficient?",
      "commit_id" : "00a54cbddbc6bc69c30a9597f6e669b1af331d65",
      "created_at" : "2021-07-29T17:11:15Z",
      "diff_hunk" : "@@ -4423,6 +4431,23 @@ class CompareInvMempoolOrder\n };\n }\n \n+bool PeerManagerImpl::SetupAddressRelay(CNode& node)\n+{\n+    // We don't participate in addr relay with outbound block-relay-only\n+    // connections to prevent providing adversaries with the additional\n+    // information of addr traffic to infer the link.\n+    if (node.IsBlockOnlyConn()) return false;\n+\n+    PeerRef peer = GetPeerRef(node.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r679338070",
      "id" : 679338070,
      "in_reply_to_id" : 679074888,
      "line" : 4461,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3OTMzODA3MA==",
      "original_commit_id" : "4ef28624c3f8238e3688f841ba9d67e67ec747d0",
      "original_line" : 4441,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 165,
      "pull_request_review_id" : 718341498,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-29T17:19:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/679338070",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r679341641"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/679341641"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Also, you wouldn't need to check for nullptr, as the caller already did that",
      "commit_id" : "00a54cbddbc6bc69c30a9597f6e669b1af331d65",
      "created_at" : "2021-07-29T17:16:17Z",
      "diff_hunk" : "@@ -4423,6 +4431,23 @@ class CompareInvMempoolOrder\n };\n }\n \n+bool PeerManagerImpl::SetupAddressRelay(CNode& node)\n+{\n+    // We don't participate in addr relay with outbound block-relay-only\n+    // connections to prevent providing adversaries with the additional\n+    // information of addr traffic to infer the link.\n+    if (node.IsBlockOnlyConn()) return false;\n+\n+    PeerRef peer = GetPeerRef(node.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r679341641",
      "id" : 679341641,
      "in_reply_to_id" : 679074888,
      "line" : 4461,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3OTM0MTY0MQ==",
      "original_commit_id" : "4ef28624c3f8238e3688f841ba9d67e67ec747d0",
      "original_line" : 4441,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 165,
      "pull_request_review_id" : 718346053,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-29T17:16:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/679341641",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r679347992"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/679347992"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> another alternative: passing in Peer& peer. does this mean the lifetime of the reference would just be managed in the normal program execution? so would that mean this is the most efficient?\r\n\r\nThis is the way to do it. The called function is not taking ownership of `Peer`, so just pass by reference. You only need to pass smart pointers when you're indicating ownership semantics: https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rf-inout (and items F26/27)",
      "commit_id" : "00a54cbddbc6bc69c30a9597f6e669b1af331d65",
      "created_at" : "2021-07-29T17:25:25Z",
      "diff_hunk" : "@@ -4423,6 +4431,23 @@ class CompareInvMempoolOrder\n };\n }\n \n+bool PeerManagerImpl::SetupAddressRelay(CNode& node)\n+{\n+    // We don't participate in addr relay with outbound block-relay-only\n+    // connections to prevent providing adversaries with the additional\n+    // information of addr traffic to infer the link.\n+    if (node.IsBlockOnlyConn()) return false;\n+\n+    PeerRef peer = GetPeerRef(node.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r679347992",
      "id" : 679347992,
      "in_reply_to_id" : 679074888,
      "line" : 4461,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3OTM0Nzk5Mg==",
      "original_commit_id" : "4ef28624c3f8238e3688f841ba9d67e67ec747d0",
      "original_line" : 4441,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 165,
      "pull_request_review_id" : 718354044,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-29T17:25:26Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/679347992",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r679573334"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/679573334"
         }
      },
      "author_association" : "MEMBER",
      "body" : "*** blaaaaackholing \r\n\r\n:) fixed ",
      "commit_id" : "3f7250b328b8b2f5d63f323702445ac5c989b73d",
      "created_at" : "2021-07-30T00:48:58Z",
      "diff_hunk" : "@@ -230,8 +230,25 @@ struct Peer {\n      *  We initialize this filter for outbound peers (other than\n      *  block-relay-only connections) or when an inbound peer sends us an\n      *  address related message (ADDR, ADDRV2, GETADDR).\n+     *\n+     *  Presence of this filter must correlate with m_addr_relay_enabled.\n      **/\n     std::unique_ptr<CRollingBloomFilter> m_addr_known;\n+    /** Whether we are participating in address relay with this connection.\n+     *\n+     *  We set this bool to true for outbound peers (other than\n+     *  block-relay-only connections), or when an inbound peer sends us an\n+     *  address related message (ADDR, ADDRV2, GETADDR).\n+     *\n+     *  We use this bool to decide whether a peer is eligible for gossiping\n+     *  addr messages. This avoids relaying to peers that are unlikely to\n+     *  forward them, effectively blaackholing self announcements. Reasons",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r679573334",
      "id" : 679573334,
      "in_reply_to_id" : 679085653,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3OTU3MzMzNA==",
      "original_commit_id" : "7e4662b8a0ea0428aa9eefe7b8116f85e5eda486",
      "original_line" : 245,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 718637139,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-30T00:48:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/679573334",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r679573586"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/679573586"
         }
      },
      "author_association" : "MEMBER",
      "body" : "ð done, thanks! ",
      "commit_id" : "3f7250b328b8b2f5d63f323702445ac5c989b73d",
      "created_at" : "2021-07-30T00:49:42Z",
      "diff_hunk" : "@@ -4423,6 +4431,23 @@ class CompareInvMempoolOrder\n };\n }\n \n+bool PeerManagerImpl::SetupAddressRelay(CNode& node)\n+{\n+    // We don't participate in addr relay with outbound block-relay-only\n+    // connections to prevent providing adversaries with the additional\n+    // information of addr traffic to infer the link.\n+    if (node.IsBlockOnlyConn()) return false;\n+\n+    PeerRef peer = GetPeerRef(node.GetId());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r679573586",
      "id" : 679573586,
      "in_reply_to_id" : 679074888,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3OTU3MzU4Ng==",
      "original_commit_id" : "4ef28624c3f8238e3688f841ba9d67e67ec747d0",
      "original_line" : 4441,
      "original_position" : 35,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 718637368,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-30T00:49:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/679573586",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "thanks @MarcoFalke, addressed your comments ",
      "created_at" : "2021-07-30T00:50:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-889550648",
      "id" : 889550648,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "IC_kwDOABII5841BXc4",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-30T00:50:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/889550648",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "reACK 3f7250b328b8b2f5d63f323702445ac5c989b73d\r\n\r\nOnly changes are addressing review comments from Marco.",
      "created_at" : "2021-07-30T09:17:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-889760155",
      "id" : 889760155,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "IC_kwDOABII5841CKmb",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-30T09:17:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/889760155",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK 3f7250b328b8b2f5d63f323702445ac5c989b73d\r\n\r\nCompared the `SetupAddressRelay()` call sites to where I thought they should be, threw in some asserts where I expected `m_addr_relay_enabled` to be true, did a code review looking for possibilities of `m_addr_known` being used before initialized. Test looks correct. Thanks for diligently checking for compatibility with other clients, seems to be a safe change. :)",
      "created_at" : "2021-07-30T09:37:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-889770457",
      "id" : 889770457,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "IC_kwDOABII5841CNHZ",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-30T09:37:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/889770457",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r680963101"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/680963101"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`if (!pfrom.IsInboundConn() || !SetupAddressRelay(pfrom, *peer)) { error; return; }` might have been better so you don't have to keep the knowledge that SetupAddressRelay always returns true for inbound conns in your head.",
      "commit_id" : "3f7250b328b8b2f5d63f323702445ac5c989b73d",
      "created_at" : "2021-08-02T13:18:29Z",
      "diff_hunk" : "@@ -3717,6 +3743,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             return;\n         }\n \n+        SetupAddressRelay(pfrom, *peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r680963101",
      "id" : 680963101,
      "line" : 3746,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MDk2MzEwMQ==",
      "original_commit_id" : "3f7250b328b8b2f5d63f323702445ac5c989b73d",
      "original_line" : 3746,
      "original_position" : 140,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 140,
      "pull_request_review_id" : 720191910,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-02T13:39:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/680963101",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r681016819"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/681016819"
         }
      },
      "author_association" : "MEMBER",
      "body" : "makes sense, I'll change if I have to push again ",
      "commit_id" : "3f7250b328b8b2f5d63f323702445ac5c989b73d",
      "created_at" : "2021-08-02T14:25:32Z",
      "diff_hunk" : "@@ -3717,6 +3743,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             return;\n         }\n \n+        SetupAddressRelay(pfrom, *peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r681016819",
      "id" : 681016819,
      "in_reply_to_id" : 680963101,
      "line" : 3746,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MTAxNjgxOQ==",
      "original_commit_id" : "3f7250b328b8b2f5d63f323702445ac5c989b73d",
      "original_line" : 3746,
      "original_position" : 140,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 140,
      "pull_request_review_id" : 720264341,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-02T14:25:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/681016819",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r681374594"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/681374594"
         }
      },
      "author_association" : "MEMBER",
      "body" : "s/intialize/initialize",
      "commit_id" : "3f7250b328b8b2f5d63f323702445ac5c989b73d",
      "created_at" : "2021-08-03T01:47:41Z",
      "diff_hunk" : "@@ -167,6 +179,9 @@ def relay_tests(self):\n         # of the outbound peer which is often sent before the GETADDR response.\n         assert_equal(inbound_peer.num_ipv4_received, 0)\n \n+        # Send an empty ADDR message to intialize address relay on this connection.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r681374594",
      "id" : 681374594,
      "line" : 182,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MTM3NDU5NA==",
      "original_commit_id" : "3f7250b328b8b2f5d63f323702445ac5c989b73d",
      "original_line" : 182,
      "original_position" : 68,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 68,
      "pull_request_review_id" : 720711594,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-03T01:47:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/681374594",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r681556819"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/681556819"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`Assume(Setup())` would do that?",
      "commit_id" : "3f7250b328b8b2f5d63f323702445ac5c989b73d",
      "created_at" : "2021-08-03T08:39:58Z",
      "diff_hunk" : "@@ -3717,6 +3743,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             return;\n         }\n \n+        SetupAddressRelay(pfrom, *peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r681556819",
      "id" : 681556819,
      "in_reply_to_id" : 680963101,
      "line" : 3746,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MTU1NjgxOQ==",
      "original_commit_id" : "3f7250b328b8b2f5d63f323702445ac5c989b73d",
      "original_line" : 3746,
      "original_position" : 140,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 140,
      "pull_request_review_id" : 720934989,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-03T08:39:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/681556819",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Maybe add a line to the release notes saying that inbound peers will never receive address messages unless they send ADDR, ADDRV2, or GETADDR themselves? ",
      "created_at" : "2021-08-03T08:44:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-891658146",
      "id" : 891658146,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "IC_kwDOABII5841JZ-i",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-03T08:44:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/891658146",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r681570767"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/681570767"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: Would be nice to always add a trailing comma to avoid ugly diffs and keeping the `git blame` depth lower in the future.",
      "commit_id" : "3f7250b328b8b2f5d63f323702445ac5c989b73d",
      "created_at" : "2021-08-03T08:58:08Z",
      "diff_hunk" : "@@ -11,14 +11,15 @@\n     NODE_NETWORK,\n     NODE_WITNESS,\n     msg_addr,\n-    msg_getaddr\n+    msg_getaddr,\n+    msg_verack",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r681570767",
      "id" : 681570767,
      "line" : 15,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MTU3MDc2Nw==",
      "original_commit_id" : "3f7250b328b8b2f5d63f323702445ac5c989b73d",
      "original_line" : 15,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 6,
      "pull_request_review_id" : 720952782,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-03T08:58:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/681570767",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r681861829"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/681861829"
         }
      },
      "author_association" : "MEMBER",
      "body" : "noted",
      "commit_id" : "3f7250b328b8b2f5d63f323702445ac5c989b73d",
      "created_at" : "2021-08-03T15:19:30Z",
      "diff_hunk" : "@@ -11,14 +11,15 @@\n     NODE_NETWORK,\n     NODE_WITNESS,\n     msg_addr,\n-    msg_getaddr\n+    msg_getaddr,\n+    msg_verack",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r681861829",
      "id" : 681861829,
      "in_reply_to_id" : 681570767,
      "line" : 15,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MTg2MTgyOQ==",
      "original_commit_id" : "3f7250b328b8b2f5d63f323702445ac5c989b73d",
      "original_line" : 15,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "test/functional/p2p_addr_relay.py",
      "position" : 6,
      "pull_request_review_id" : 721335348,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-03T15:19:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/681861829",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r681936270"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/681936270"
         }
      },
      "author_association" : "MEMBER",
      "body" : "addressed in #22618 ",
      "commit_id" : "3f7250b328b8b2f5d63f323702445ac5c989b73d",
      "created_at" : "2021-08-03T16:51:14Z",
      "diff_hunk" : "@@ -3717,6 +3743,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             return;\n         }\n \n+        SetupAddressRelay(pfrom, *peer);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#discussion_r681936270",
      "id" : 681936270,
      "in_reply_to_id" : 680963101,
      "line" : 3746,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MTkzNjI3MA==",
      "original_commit_id" : "3f7250b328b8b2f5d63f323702445ac5c989b73d",
      "original_line" : 3746,
      "original_position" : 140,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 140,
      "pull_request_review_id" : 721432604,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21528",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-03T16:51:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/681936270",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@MarcoFalke \r\n> Maybe add a line to the release notes\r\n\r\nAdded in #22618, thanks :) ",
      "created_at" : "2021-08-03T16:51:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21528#issuecomment-892004202",
      "id" : 892004202,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21528",
      "node_id" : "IC_kwDOABII5841Kudq",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-03T16:51:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/892004202",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1500952?v=4",
         "events_url" : "https://api.github.com/users/amitiuttarwar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/amitiuttarwar/followers",
         "following_url" : "https://api.github.com/users/amitiuttarwar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/amitiuttarwar",
         "id" : 1500952,
         "login" : "amitiuttarwar",
         "node_id" : "MDQ6VXNlcjE1MDA5NTI=",
         "organizations_url" : "https://api.github.com/users/amitiuttarwar/orgs",
         "received_events_url" : "https://api.github.com/users/amitiuttarwar/received_events",
         "repos_url" : "https://api.github.com/users/amitiuttarwar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/amitiuttarwar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/amitiuttarwar"
      }
   }
]
