[
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for this @ccdle12. It goes without saying that I'm very supportive of such changes. `SendMessages()` is a monster. It's very difficult to know whether their are unintended interactions between the different parts of the code. It's also impossible to isolate and test the functionality for the units of code.\r\n\r\n> The idea would be for the changes to eventually look something like this:\r\n> \r\n> ```\r\n> bool PeerManagerImpl::SendMessages(CNode* pto) {\r\n>     ...\r\n>     {\r\n>         LOCK(cs_main);\r\n>         ...\r\n>         MaybeAnnounceLocalAddress(...);\r\n>         SendAddr(...);\r\n>         SendGetHeadersBlockSync(...);\r\n>         SendBlockAnnouncements(...);\r\n>         SendInv(...);\r\n>         ...\r\n>     }\r\n>     ...\r\n> }\r\n> ```\r\n\r\nOr perhaps even better would be for each peer to have a list of tasks with times, and then pop tasks off the front when the current time has passed the task time. That'd stop us from making many redundant time comparisons in each `SendMessages()` invocation.\r\n\r\nI've already done something very similar to this PR in #21236. Do you mind taking a look at that and seeing if it achieves your goals?",
      "created_at" : "2021-03-27T15:18:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21534#issuecomment-808748225",
      "id" : 808748225,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21534",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwODc0ODIyNQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-27T15:18:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/808748225",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21528 ([net_processing] Reduce addr blackholes by amitiuttarwar)\n* #21236 (Net processing: Extract `addr` send functionality into MaybeSendAddr() by jnewbery)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-03-27T16:09:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21534#issuecomment-808755369",
      "id" : 808755369,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21534",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwODc1NTM2OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-27T16:09:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/808755369",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Or perhaps even better would be for each peer to have a list of tasks with times, and then pop tasks off the front when the current time has passed the task time. That'd stop us from making many redundant time comparisons in each `SendMessages()` invocation.\r\n> \r\n> I've already done something very similar to this PR in #21236. Do you mind taking a look at that and seeing if it achieves your goals?\r\n\r\nThanks @jnewbery, appreciate the feedback and taking a look at this. I'll check out #21236 and see if I can help anywhere.\r\n",
      "created_at" : "2021-03-27T17:09:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21534#issuecomment-808763410",
      "id" : 808763410,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21534",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwODc2MzQxMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-27T17:09:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/808763410",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/18324680?v=4",
         "events_url" : "https://api.github.com/users/ccdle12/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ccdle12/followers",
         "following_url" : "https://api.github.com/users/ccdle12/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ccdle12/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ccdle12",
         "id" : 18324680,
         "login" : "ccdle12",
         "node_id" : "MDQ6VXNlcjE4MzI0Njgw",
         "organizations_url" : "https://api.github.com/users/ccdle12/orgs",
         "received_events_url" : "https://api.github.com/users/ccdle12/received_events",
         "repos_url" : "https://api.github.com/users/ccdle12/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ccdle12/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ccdle12/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ccdle12"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "closing since the changes proposed are covered in #21236 ",
      "created_at" : "2021-03-28T14:19:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21534#issuecomment-808903462",
      "id" : 808903462,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21534",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwODkwMzQ2Mg==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-28T14:19:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/808903462",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/18324680?v=4",
         "events_url" : "https://api.github.com/users/ccdle12/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ccdle12/followers",
         "following_url" : "https://api.github.com/users/ccdle12/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ccdle12/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ccdle12",
         "id" : 18324680,
         "login" : "ccdle12",
         "node_id" : "MDQ6VXNlcjE4MzI0Njgw",
         "organizations_url" : "https://api.github.com/users/ccdle12/orgs",
         "received_events_url" : "https://api.github.com/users/ccdle12/received_events",
         "repos_url" : "https://api.github.com/users/ccdle12/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ccdle12/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ccdle12/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ccdle12"
      }
   }
]
