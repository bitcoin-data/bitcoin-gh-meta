[
   {
      "author_association" : "MEMBER",
      "body" : "I guess after rebasing on top of 2bdf37fe187ba6f090a0f5299b74d5d82cde4697, most of this is just a name change. But there are still a few changes of substance and the rename is probably worth doing.",
      "created_at" : "2021-03-24T16:40:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21523#issuecomment-805980810",
      "id" : 805980810,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21523",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwNTk4MDgxMA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-24T16:40:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/805980810",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21391 ([Bundle 5/n] Prune g_chainman usage in RPC modules by dongcarl)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-03-24T21:40:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21523#issuecomment-806203880",
      "id" : 806203880,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21523",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgwNjIwMzg4MA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-03-29T08:26:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/806203880",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21523#discussion_r610078206"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21523"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/610078206"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: parameterize VerifyDB by chainstate\" (cd93f827eb1178c3b001b45af5c062bf0be2cf05)\r\n\r\nCould comment below be updated to explain the `g_chainman` check?\r\n\r\nAlso could logprint below be updated to not mention pruning if block isn't pruned?\r\n\r\nAlso it would seem more direct and less likely to hide errors to check here if `chainstate` specifically is an unvalidated snapshot, instead of checking if there is just any snapshot. This would avoid hiding legitimate errors if the background chainstate is missing blocks.",
      "commit_id" : "844ad0eccaa1dbfefc30d19804d95d67c3d5f06d",
      "created_at" : "2021-04-08T20:31:45Z",
      "diff_hunk" : "@@ -4247,37 +4247,40 @@ CVerifyDB::~CVerifyDB()\n     uiInterface.ShowProgress(\"\", 100, false);\n }\n \n-bool CVerifyDB::VerifyDB(const CChainParams& chainparams, CChainState& active_chainstate, CCoinsView *coinsview, int nCheckLevel, int nCheckDepth)\n+bool CVerifyDB::VerifyDB(\n+    CChainState& chainstate,\n+    const CChainParams& chainparams,\n+    CCoinsView& coinsview,\n+    int nCheckLevel, int nCheckDepth)\n {\n     AssertLockHeld(cs_main);\n \n-    assert(std::addressof(::ChainstateActive()) == std::addressof(active_chainstate));\n-    if (active_chainstate.m_chain.Tip() == nullptr || active_chainstate.m_chain.Tip()->pprev == nullptr)\n+    if (chainstate.m_chain.Tip() == nullptr || chainstate.m_chain.Tip()->pprev == nullptr)\n         return true;\n \n     // Verify blocks in the best chain\n-    if (nCheckDepth <= 0 || nCheckDepth > active_chainstate.m_chain.Height())\n-        nCheckDepth = active_chainstate.m_chain.Height();\n+    if (nCheckDepth <= 0 || nCheckDepth > chainstate.m_chain.Height())\n+        nCheckDepth = chainstate.m_chain.Height();\n     nCheckLevel = std::max(0, std::min(4, nCheckLevel));\n     LogPrintf(\"Verifying last %i blocks at level %i\\n\", nCheckDepth, nCheckLevel);\n-    CCoinsViewCache coins(coinsview);\n+    CCoinsViewCache coins(&coinsview);\n     CBlockIndex* pindex;\n     CBlockIndex* pindexFailure = nullptr;\n     int nGoodTransactions = 0;\n     BlockValidationState state;\n     int reportDone = 0;\n     LogPrintf(\"[0%%]...\"); /* Continued */\n-    for (pindex = active_chainstate.m_chain.Tip(); pindex && pindex->pprev; pindex = pindex->pprev) {\n-        const int percentageDone = std::max(1, std::min(99, (int)(((double)(active_chainstate.m_chain.Height() - pindex->nHeight)) / (double)nCheckDepth * (nCheckLevel >= 4 ? 50 : 100))));\n+    for (pindex = chainstate.m_chain.Tip(); pindex && pindex->pprev; pindex = pindex->pprev) {\n+        const int percentageDone = std::max(1, std::min(99, (int)(((double)(chainstate.m_chain.Height() - pindex->nHeight)) / (double)nCheckDepth * (nCheckLevel >= 4 ? 50 : 100))));\n         if (reportDone < percentageDone/10) {\n             // report every 10% step\n             LogPrintf(\"[%d%%]...\", percentageDone); /* Continued */\n             reportDone = percentageDone/10;\n         }\n         uiInterface.ShowProgress(_(\"Verifying blocks...\").translated, percentageDone, false);\n-        if (pindex->nHeight <= active_chainstate.m_chain.Height()-nCheckDepth)\n+        if (pindex->nHeight <= chainstate.m_chain.Height()-nCheckDepth)\n             break;\n-        if (fPruneMode && !(pindex->nStatus & BLOCK_HAVE_DATA)) {\n+        if ((fPruneMode || g_chainman.IsSnapshotActive()) && !(pindex->nStatus & BLOCK_HAVE_DATA)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21523#discussion_r610078206",
      "id" : 610078206,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMDA3ODIwNg==",
      "original_commit_id" : "cd93f827eb1178c3b001b45af5c062bf0be2cf05",
      "original_line" : 4284,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 631807406,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21523",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-23T19:13:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/610078206",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21523#discussion_r611241900"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21523"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611241900"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: I think if you make this `size_t` here you can drop the cast below.",
      "commit_id" : "844ad0eccaa1dbfefc30d19804d95d67c3d5f06d",
      "created_at" : "2021-04-11T20:28:08Z",
      "diff_hunk" : "@@ -4300,9 +4303,11 @@ bool CVerifyDB::VerifyDB(const CChainParams& chainparams, CChainState& active_ch\n             }\n         }\n         // check level 3: check for inconsistencies during memory-only disconnect of tip blocks\n-        if (nCheckLevel >= 3 && (coins.DynamicMemoryUsage() + active_chainstate.CoinsTip().DynamicMemoryUsage()) <= active_chainstate.m_coinstip_cache_size_bytes) {\n+        int64_t curr_coins_usage = coins.DynamicMemoryUsage() + chainstate.CoinsTip().DynamicMemoryUsage();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21523#discussion_r611241900",
      "id" : 611241900,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMTI0MTkwMA==",
      "original_commit_id" : "cd93f827eb1178c3b001b45af5c062bf0be2cf05",
      "original_line" : 4311,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 633049354,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21523",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-23T19:13:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611241900",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21523#discussion_r611899246"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21523"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611899246"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: `IsSnapshotActive()` in `ChainstateManager` doesn't have a comment though part of the public interface.",
      "commit_id" : "844ad0eccaa1dbfefc30d19804d95d67c3d5f06d",
      "created_at" : "2021-04-12T19:31:56Z",
      "diff_hunk" : "@@ -4247,37 +4247,40 @@ CVerifyDB::~CVerifyDB()\n     uiInterface.ShowProgress(\"\", 100, false);\n }\n \n-bool CVerifyDB::VerifyDB(const CChainParams& chainparams, CChainState& active_chainstate, CCoinsView *coinsview, int nCheckLevel, int nCheckDepth)\n+bool CVerifyDB::VerifyDB(\n+    CChainState& chainstate,\n+    const CChainParams& chainparams,\n+    CCoinsView& coinsview,\n+    int nCheckLevel, int nCheckDepth)\n {\n     AssertLockHeld(cs_main);\n \n-    assert(std::addressof(::ChainstateActive()) == std::addressof(active_chainstate));\n-    if (active_chainstate.m_chain.Tip() == nullptr || active_chainstate.m_chain.Tip()->pprev == nullptr)\n+    if (chainstate.m_chain.Tip() == nullptr || chainstate.m_chain.Tip()->pprev == nullptr)\n         return true;\n \n     // Verify blocks in the best chain\n-    if (nCheckDepth <= 0 || nCheckDepth > active_chainstate.m_chain.Height())\n-        nCheckDepth = active_chainstate.m_chain.Height();\n+    if (nCheckDepth <= 0 || nCheckDepth > chainstate.m_chain.Height())\n+        nCheckDepth = chainstate.m_chain.Height();\n     nCheckLevel = std::max(0, std::min(4, nCheckLevel));\n     LogPrintf(\"Verifying last %i blocks at level %i\\n\", nCheckDepth, nCheckLevel);\n-    CCoinsViewCache coins(coinsview);\n+    CCoinsViewCache coins(&coinsview);\n     CBlockIndex* pindex;\n     CBlockIndex* pindexFailure = nullptr;\n     int nGoodTransactions = 0;\n     BlockValidationState state;\n     int reportDone = 0;\n     LogPrintf(\"[0%%]...\"); /* Continued */\n-    for (pindex = active_chainstate.m_chain.Tip(); pindex && pindex->pprev; pindex = pindex->pprev) {\n-        const int percentageDone = std::max(1, std::min(99, (int)(((double)(active_chainstate.m_chain.Height() - pindex->nHeight)) / (double)nCheckDepth * (nCheckLevel >= 4 ? 50 : 100))));\n+    for (pindex = chainstate.m_chain.Tip(); pindex && pindex->pprev; pindex = pindex->pprev) {\n+        const int percentageDone = std::max(1, std::min(99, (int)(((double)(chainstate.m_chain.Height() - pindex->nHeight)) / (double)nCheckDepth * (nCheckLevel >= 4 ? 50 : 100))));\n         if (reportDone < percentageDone/10) {\n             // report every 10% step\n             LogPrintf(\"[%d%%]...\", percentageDone); /* Continued */\n             reportDone = percentageDone/10;\n         }\n         uiInterface.ShowProgress(_(\"Verifying blocks...\").translated, percentageDone, false);\n-        if (pindex->nHeight <= active_chainstate.m_chain.Height()-nCheckDepth)\n+        if (pindex->nHeight <= chainstate.m_chain.Height()-nCheckDepth)\n             break;\n-        if (fPruneMode && !(pindex->nStatus & BLOCK_HAVE_DATA)) {\n+        if ((fPruneMode || g_chainman.IsSnapshotActive()) && !(pindex->nStatus & BLOCK_HAVE_DATA)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21523#discussion_r611899246",
      "id" : 611899246,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMTg5OTI0Ng==",
      "original_commit_id" : "cd93f827eb1178c3b001b45af5c062bf0be2cf05",
      "original_line" : 4284,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 633895404,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21523",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-23T19:13:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/611899246",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21523#discussion_r612512652"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21523"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612512652"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> This would avoid hiding legitimate errors if the background chainstate is missing blocks.\r\n\r\nGood catch! Fixed.",
      "commit_id" : "844ad0eccaa1dbfefc30d19804d95d67c3d5f06d",
      "created_at" : "2021-04-13T14:42:44Z",
      "diff_hunk" : "@@ -4247,37 +4247,40 @@ CVerifyDB::~CVerifyDB()\n     uiInterface.ShowProgress(\"\", 100, false);\n }\n \n-bool CVerifyDB::VerifyDB(const CChainParams& chainparams, CChainState& active_chainstate, CCoinsView *coinsview, int nCheckLevel, int nCheckDepth)\n+bool CVerifyDB::VerifyDB(\n+    CChainState& chainstate,\n+    const CChainParams& chainparams,\n+    CCoinsView& coinsview,\n+    int nCheckLevel, int nCheckDepth)\n {\n     AssertLockHeld(cs_main);\n \n-    assert(std::addressof(::ChainstateActive()) == std::addressof(active_chainstate));\n-    if (active_chainstate.m_chain.Tip() == nullptr || active_chainstate.m_chain.Tip()->pprev == nullptr)\n+    if (chainstate.m_chain.Tip() == nullptr || chainstate.m_chain.Tip()->pprev == nullptr)\n         return true;\n \n     // Verify blocks in the best chain\n-    if (nCheckDepth <= 0 || nCheckDepth > active_chainstate.m_chain.Height())\n-        nCheckDepth = active_chainstate.m_chain.Height();\n+    if (nCheckDepth <= 0 || nCheckDepth > chainstate.m_chain.Height())\n+        nCheckDepth = chainstate.m_chain.Height();\n     nCheckLevel = std::max(0, std::min(4, nCheckLevel));\n     LogPrintf(\"Verifying last %i blocks at level %i\\n\", nCheckDepth, nCheckLevel);\n-    CCoinsViewCache coins(coinsview);\n+    CCoinsViewCache coins(&coinsview);\n     CBlockIndex* pindex;\n     CBlockIndex* pindexFailure = nullptr;\n     int nGoodTransactions = 0;\n     BlockValidationState state;\n     int reportDone = 0;\n     LogPrintf(\"[0%%]...\"); /* Continued */\n-    for (pindex = active_chainstate.m_chain.Tip(); pindex && pindex->pprev; pindex = pindex->pprev) {\n-        const int percentageDone = std::max(1, std::min(99, (int)(((double)(active_chainstate.m_chain.Height() - pindex->nHeight)) / (double)nCheckDepth * (nCheckLevel >= 4 ? 50 : 100))));\n+    for (pindex = chainstate.m_chain.Tip(); pindex && pindex->pprev; pindex = pindex->pprev) {\n+        const int percentageDone = std::max(1, std::min(99, (int)(((double)(chainstate.m_chain.Height() - pindex->nHeight)) / (double)nCheckDepth * (nCheckLevel >= 4 ? 50 : 100))));\n         if (reportDone < percentageDone/10) {\n             // report every 10% step\n             LogPrintf(\"[%d%%]...\", percentageDone); /* Continued */\n             reportDone = percentageDone/10;\n         }\n         uiInterface.ShowProgress(_(\"Verifying blocks...\").translated, percentageDone, false);\n-        if (pindex->nHeight <= active_chainstate.m_chain.Height()-nCheckDepth)\n+        if (pindex->nHeight <= chainstate.m_chain.Height()-nCheckDepth)\n             break;\n-        if (fPruneMode && !(pindex->nStatus & BLOCK_HAVE_DATA)) {\n+        if ((fPruneMode || g_chainman.IsSnapshotActive()) && !(pindex->nStatus & BLOCK_HAVE_DATA)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21523#discussion_r612512652",
      "id" : 612512652,
      "in_reply_to_id" : 610078206,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjUxMjY1Mg==",
      "original_commit_id" : "cd93f827eb1178c3b001b45af5c062bf0be2cf05",
      "original_line" : 4284,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 634679066,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21523",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-23T19:13:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612512652",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the reviews so far @ryanofsky @fjahr @ariard. I've incorporated your feedback and split out the rename commit.",
      "created_at" : "2021-04-13T14:51:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21523#issuecomment-818798799",
      "id" : 818798799,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21523",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxODc5ODc5OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-13T14:51:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/818798799",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code Review ACK c47a00d3",
      "created_at" : "2021-04-13T16:33:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21523#issuecomment-818876278",
      "id" : 818876278,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21523",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxODg3NjI3OA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-13T16:33:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/818876278",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21523#discussion_r612693771"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21523"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612693771"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"refactor: rename active_chainstate in VerifyDB\" (de836511d892331c0ab8d917c9cf0ca8d81537ee)\r\n\r\nIt doesn't really matter and this is fixed in the next commit, but there are three different types here: `int64_t` for `curr_coins_usage`, `unsigned long` for the cast, and `size_t` for `m_coinstip_cache_size_bytes`, and it would be nice to use `size_t` for all three from the start.",
      "commit_id" : "844ad0eccaa1dbfefc30d19804d95d67c3d5f06d",
      "created_at" : "2021-04-13T18:45:30Z",
      "diff_hunk" : "@@ -4301,9 +4305,11 @@ bool CVerifyDB::VerifyDB(const CChainParams& chainparams, CChainState& active_ch\n             }\n         }\n         // check level 3: check for inconsistencies during memory-only disconnect of tip blocks\n-        if (nCheckLevel >= 3 && (coins.DynamicMemoryUsage() + active_chainstate.CoinsTip().DynamicMemoryUsage()) <= active_chainstate.m_coinstip_cache_size_bytes) {\n+        int64_t curr_coins_usage = coins.DynamicMemoryUsage() + chainstate.CoinsTip().DynamicMemoryUsage();\n+\n+        if (nCheckLevel >= 3 && static_cast<unsigned long>(curr_coins_usage) <= chainstate.m_coinstip_cache_size_bytes) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21523#discussion_r612693771",
      "id" : 612693771,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjY5Mzc3MQ==",
      "original_commit_id" : "de836511d892331c0ab8d917c9cf0ca8d81537ee",
      "original_line" : 4310,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 634918001,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21523",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-23T19:13:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/612693771",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Code Review ACK c47a00d3de4ac3e62d3eee215f6180d4f3170dfb",
      "created_at" : "2021-04-14T21:10:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21523#issuecomment-819835011",
      "id" : 819835011,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21523",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgxOTgzNTAxMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-14T21:10:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/819835011",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2021-04-17T16:26:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21523#issuecomment-821849299",
      "id" : 821849299,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21523",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyMTg0OTI5OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-17T16:26:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/821849299",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased and fixed compilation for the first commit. Thanks for the looks all.",
      "created_at" : "2021-04-23T19:14:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21523#issuecomment-825865633",
      "id" : 825865633,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21523",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNTg2NTYzMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-23T19:14:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/825865633",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Code review re-ACK 844ad0eccaa1dbfefc30d19804d95d67c3d5f06d",
      "created_at" : "2021-04-23T21:36:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21523#issuecomment-825938089",
      "id" : 825938089,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21523",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyNTkzODA4OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-04-23T21:36:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/825938089",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21523#discussion_r619603733"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21523"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/619603733"
         }
      },
      "author_association" : "MEMBER",
      "body" : "9b604c0207b526c008617cdca210f35db5e344db: Maybe move this hunk to the previous commit?",
      "commit_id" : "844ad0eccaa1dbfefc30d19804d95d67c3d5f06d",
      "created_at" : "2021-04-24T07:23:45Z",
      "diff_hunk" : "@@ -4158,9 +4162,9 @@ bool CVerifyDB::VerifyDB(\n             }\n         }\n         // check level 3: check for inconsistencies during memory-only disconnect of tip blocks\n-        int64_t curr_coins_usage = coins.DynamicMemoryUsage() + chainstate.CoinsTip().DynamicMemoryUsage();\n+        size_t curr_coins_usage = coins.DynamicMemoryUsage() + chainstate.CoinsTip().DynamicMemoryUsage();\n \n-        if (nCheckLevel >= 3 && static_cast<unsigned long>(curr_coins_usage) <= chainstate.m_coinstip_cache_size_bytes) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21523#discussion_r619603733",
      "id" : 619603733,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxOTYwMzczMw==",
      "original_commit_id" : "9b604c0207b526c008617cdca210f35db5e344db",
      "original_line" : 4163,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 643931167,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21523",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-24T07:26:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/619603733",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21523#discussion_r619603905"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21523"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/619603905"
         }
      },
      "author_association" : "MEMBER",
      "body" : "9b604c0207b526c008617cdca210f35db5e344db: Wouldn't it be easier to remove the prune and snapshot condition and simply check HAVE_DATA? Performance shouldn't decrease and it would be less code, which is nice.",
      "commit_id" : "844ad0eccaa1dbfefc30d19804d95d67c3d5f06d",
      "created_at" : "2021-04-24T07:25:21Z",
      "diff_hunk" : "@@ -4135,8 +4138,9 @@ bool CVerifyDB::VerifyDB(\n         uiInterface.ShowProgress(_(\"Verifying blocks...\").translated, percentageDone, false);\n         if (pindex->nHeight <= chainstate.m_chain.Height()-nCheckDepth)\n             break;\n-        if (fPruneMode && !(pindex->nStatus & BLOCK_HAVE_DATA)) {\n-            // If pruning, only go back as far as we have data.\n+        if ((fPruneMode || is_snapshot_cs) && !(pindex->nStatus & BLOCK_HAVE_DATA)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21523#discussion_r619603905",
      "id" : 619603905,
      "line" : 4141,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxOTYwMzkwNQ==",
      "original_commit_id" : "9b604c0207b526c008617cdca210f35db5e344db",
      "original_line" : 4141,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 52,
      "pull_request_review_id" : 643931167,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21523",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-24T07:26:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/619603905",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21523#discussion_r619614061"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21523"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/619614061"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I guess your goal is to treat it as error when block data is missing, but pruning is off an no snapshot is loaded?",
      "commit_id" : "844ad0eccaa1dbfefc30d19804d95d67c3d5f06d",
      "created_at" : "2021-04-24T08:23:29Z",
      "diff_hunk" : "@@ -4135,8 +4138,9 @@ bool CVerifyDB::VerifyDB(\n         uiInterface.ShowProgress(_(\"Verifying blocks...\").translated, percentageDone, false);\n         if (pindex->nHeight <= chainstate.m_chain.Height()-nCheckDepth)\n             break;\n-        if (fPruneMode && !(pindex->nStatus & BLOCK_HAVE_DATA)) {\n-            // If pruning, only go back as far as we have data.\n+        if ((fPruneMode || is_snapshot_cs) && !(pindex->nStatus & BLOCK_HAVE_DATA)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21523#discussion_r619614061",
      "id" : 619614061,
      "in_reply_to_id" : 619603905,
      "line" : 4141,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxOTYxNDA2MQ==",
      "original_commit_id" : "9b604c0207b526c008617cdca210f35db5e344db",
      "original_line" : 4141,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 52,
      "pull_request_review_id" : 644011418,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21523",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-24T08:23:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/619614061",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21523#discussion_r620489585"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21523"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/620489585"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Right - I think we want to fail here if we're lacking block data when not pruning or operating from snapshot.",
      "commit_id" : "844ad0eccaa1dbfefc30d19804d95d67c3d5f06d",
      "created_at" : "2021-04-26T17:09:43Z",
      "diff_hunk" : "@@ -4135,8 +4138,9 @@ bool CVerifyDB::VerifyDB(\n         uiInterface.ShowProgress(_(\"Verifying blocks...\").translated, percentageDone, false);\n         if (pindex->nHeight <= chainstate.m_chain.Height()-nCheckDepth)\n             break;\n-        if (fPruneMode && !(pindex->nStatus & BLOCK_HAVE_DATA)) {\n-            // If pruning, only go back as far as we have data.\n+        if ((fPruneMode || is_snapshot_cs) && !(pindex->nStatus & BLOCK_HAVE_DATA)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21523#discussion_r620489585",
      "id" : 620489585,
      "in_reply_to_id" : 619603905,
      "line" : 4141,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMDQ4OTU4NQ==",
      "original_commit_id" : "9b604c0207b526c008617cdca210f35db5e344db",
      "original_line" : 4141,
      "original_position" : 33,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 52,
      "pull_request_review_id" : 644920844,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21523",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-04-26T17:09:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/620489585",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   }
]
