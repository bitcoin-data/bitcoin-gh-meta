[
   {
      "body" : "Note that https://github.com/bitcoin/bitcoin/pull/10697#issuecomment-311811754 applies here as well.",
      "created_at" : "2017-07-04T00:03:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10738#issuecomment-312751966",
      "id" : 312751966,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10738",
      "updated_at" : "2017-07-04T00:03:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/312751966",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "Test failure looks unrelated and matches another one here: https://travis-ci.org/bitcoin/bitcoin/jobs/248773151. Kicking off a new build.",
      "created_at" : "2017-07-04T00:45:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10738#issuecomment-312755338",
      "id" : 312755338,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10738",
      "updated_at" : "2017-07-04T00:45:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/312755338",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/417043?v=3",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "body" : "Needs rebase.",
      "created_at" : "2017-08-23T10:22:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10738#issuecomment-324287323",
      "id" : 324287323,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10738",
      "updated_at" : "2017-08-23T10:22:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/324287323",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10738#discussion_r158109825"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10738"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/158109825"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I don't understand how make_strong/strong_ptr/decay_ptr provide any benefit in this example. Why wouldn't you just use regular shared pointers, and write this loop as `while (str.use_count() > 1)`?",
      "commit_id" : "6dc671a22046c6c09a6de2b1d38e9e2fa3920628",
      "created_at" : "2017-12-20T19:09:07Z",
      "diff_hunk" : "@@ -0,0 +1,317 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_STRONGPTR_H\n+#define BITCOIN_STRONGPTR_H\n+\n+#include <memory>\n+\n+/*\n+    strong_ptr and decay_ptr create a safe use pattern for moving shared_ptrs\n+    to a unique_ptr.\n+\n+    While any such pattern would usually make no sense, it can be made to work\n+    with a new type that holds an extra reference (strong_ptr), and one that\n+    observes the lifetime of extra references (decay_ptr).\n+\n+    The process is:\n+        1. Create a strong_ptr like any typical smart pointer. It cannot be\n+            copied, but it can \"loan out\" shared_ptrs using\n+            strong_ptr::get_shared().\n+        2. Use the \"loaned\" shared_ptrs as usual, and use the strong_ptr as\n+            though it were a unique_ptr.\n+        3. When it's time to coalesce, move the strong_ptr into a decay_ptr.\n+        4. Query the status with decay_ptr::decayed().\n+\n+    Once moved into a decay_ptr, the original strong_ptr is reset, and the\n+    decay_ptr is unable to loan out any new shared_ptrs. Once the decay_ptr has\n+    decayed, it behaves just like a unique_ptr.\n+\n+    If a loaned shared_ptr outlives the strong_ptr that owns it, the lifetime\n+    is extended until the last copy is deleted. This is accomplished by\n+    creating a shared_ptr to represent the lifetime of the strong_ptr, and\n+    storing a copy of it in the loaned shared_ptr's deleter.\n+\n+    Thus, strong_ptr and decay_ptr ensure that allocated memory is always freed.\n+\n+    Here's a quick example of their use:\n+\n+        void func(std::shared_ptr<int>)\n+        {\n+            // Some long-lived operation\n+        }\n+\n+        int main()\n+        {\n+            strong_ptr<int> str(make_strong<int>(100));\n+            std::thread(func, str.get_shared());\n+            decay_ptr<int> dec(std::move(strong));\n+            // The original strong_ptr is now reset\n+            while (!dec.decayed()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10738#discussion_r158109825",
      "id" : 158109825,
      "original_commit_id" : "6dc671a22046c6c09a6de2b1d38e9e2fa3920628",
      "original_position" : 51,
      "path" : "src/strong_ptr.h",
      "position" : 51,
      "pull_request_review_id" : 84866659,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10738",
      "updated_at" : "2017-12-20T19:09:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/158109825",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10738#discussion_r158149046"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10738"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/158149046"
         }
      },
      "author_association" : "MEMBER",
      "body" : "a weak_ptr can be created from a shared_ptr without bumping its refcount. That weak_ptr can ```lock()``` in a separate thread just after checking use_count() here. ```shared_ptr.unique()``` (```shared_ptr.use_count() == 1```) was deprecated in c++17 for that reason.\r\n\r\nOnce moved to a decay_ptr, ```decayed()``` is a trustworthy ```unique()```.",
      "commit_id" : "6dc671a22046c6c09a6de2b1d38e9e2fa3920628",
      "created_at" : "2017-12-20T22:07:55Z",
      "diff_hunk" : "@@ -0,0 +1,317 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_STRONGPTR_H\n+#define BITCOIN_STRONGPTR_H\n+\n+#include <memory>\n+\n+/*\n+    strong_ptr and decay_ptr create a safe use pattern for moving shared_ptrs\n+    to a unique_ptr.\n+\n+    While any such pattern would usually make no sense, it can be made to work\n+    with a new type that holds an extra reference (strong_ptr), and one that\n+    observes the lifetime of extra references (decay_ptr).\n+\n+    The process is:\n+        1. Create a strong_ptr like any typical smart pointer. It cannot be\n+            copied, but it can \"loan out\" shared_ptrs using\n+            strong_ptr::get_shared().\n+        2. Use the \"loaned\" shared_ptrs as usual, and use the strong_ptr as\n+            though it were a unique_ptr.\n+        3. When it's time to coalesce, move the strong_ptr into a decay_ptr.\n+        4. Query the status with decay_ptr::decayed().\n+\n+    Once moved into a decay_ptr, the original strong_ptr is reset, and the\n+    decay_ptr is unable to loan out any new shared_ptrs. Once the decay_ptr has\n+    decayed, it behaves just like a unique_ptr.\n+\n+    If a loaned shared_ptr outlives the strong_ptr that owns it, the lifetime\n+    is extended until the last copy is deleted. This is accomplished by\n+    creating a shared_ptr to represent the lifetime of the strong_ptr, and\n+    storing a copy of it in the loaned shared_ptr's deleter.\n+\n+    Thus, strong_ptr and decay_ptr ensure that allocated memory is always freed.\n+\n+    Here's a quick example of their use:\n+\n+        void func(std::shared_ptr<int>)\n+        {\n+            // Some long-lived operation\n+        }\n+\n+        int main()\n+        {\n+            strong_ptr<int> str(make_strong<int>(100));\n+            std::thread(func, str.get_shared());\n+            decay_ptr<int> dec(std::move(strong));\n+            // The original strong_ptr is now reset\n+            while (!dec.decayed()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10738#discussion_r158149046",
      "id" : 158149046,
      "in_reply_to_id" : 158109825,
      "original_commit_id" : "6dc671a22046c6c09a6de2b1d38e9e2fa3920628",
      "original_position" : 51,
      "path" : "src/strong_ptr.h",
      "position" : 51,
      "pull_request_review_id" : 84912959,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10738",
      "updated_at" : "2017-12-20T22:07:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/158149046",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10738#discussion_r166312833"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10738"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/166312833"
         }
      },
      "author_association" : "OWNER",
      "body" : "I don't think this is a particularly good example, as it encourages busy waiting :-) But for the application in our net code it's a clever solution.",
      "commit_id" : "6dc671a22046c6c09a6de2b1d38e9e2fa3920628",
      "created_at" : "2018-02-06T14:19:34Z",
      "diff_hunk" : "@@ -0,0 +1,317 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_STRONGPTR_H\n+#define BITCOIN_STRONGPTR_H\n+\n+#include <memory>\n+\n+/*\n+    strong_ptr and decay_ptr create a safe use pattern for moving shared_ptrs\n+    to a unique_ptr.\n+\n+    While any such pattern would usually make no sense, it can be made to work\n+    with a new type that holds an extra reference (strong_ptr), and one that\n+    observes the lifetime of extra references (decay_ptr).\n+\n+    The process is:\n+        1. Create a strong_ptr like any typical smart pointer. It cannot be\n+            copied, but it can \"loan out\" shared_ptrs using\n+            strong_ptr::get_shared().\n+        2. Use the \"loaned\" shared_ptrs as usual, and use the strong_ptr as\n+            though it were a unique_ptr.\n+        3. When it's time to coalesce, move the strong_ptr into a decay_ptr.\n+        4. Query the status with decay_ptr::decayed().\n+\n+    Once moved into a decay_ptr, the original strong_ptr is reset, and the\n+    decay_ptr is unable to loan out any new shared_ptrs. Once the decay_ptr has\n+    decayed, it behaves just like a unique_ptr.\n+\n+    If a loaned shared_ptr outlives the strong_ptr that owns it, the lifetime\n+    is extended until the last copy is deleted. This is accomplished by\n+    creating a shared_ptr to represent the lifetime of the strong_ptr, and\n+    storing a copy of it in the loaned shared_ptr's deleter.\n+\n+    Thus, strong_ptr and decay_ptr ensure that allocated memory is always freed.\n+\n+    Here's a quick example of their use:\n+\n+        void func(std::shared_ptr<int>)\n+        {\n+            // Some long-lived operation\n+        }\n+\n+        int main()\n+        {\n+            strong_ptr<int> str(make_strong<int>(100));\n+            std::thread(func, str.get_shared());\n+            decay_ptr<int> dec(std::move(strong));\n+            // The original strong_ptr is now reset\n+            while (!dec.decayed()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10738#discussion_r166312833",
      "id" : 166312833,
      "in_reply_to_id" : 158109825,
      "original_commit_id" : "6dc671a22046c6c09a6de2b1d38e9e2fa3920628",
      "original_position" : 51,
      "path" : "src/strong_ptr.h",
      "position" : 51,
      "pull_request_review_id" : 94358094,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10738",
      "updated_at" : "2018-02-06T14:19:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/166312833",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10738#discussion_r166316663"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10738"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/166316663"
         }
      },
      "author_association" : "OWNER",
      "body" : "What is the advantage of having a specific overload for nullptr_t?",
      "commit_id" : "6dc671a22046c6c09a6de2b1d38e9e2fa3920628",
      "created_at" : "2018-02-06T14:26:13Z",
      "diff_hunk" : "@@ -0,0 +1,317 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_STRONGPTR_H\n+#define BITCOIN_STRONGPTR_H\n+\n+#include <memory>\n+\n+/*\n+    strong_ptr and decay_ptr create a safe use pattern for moving shared_ptrs\n+    to a unique_ptr.\n+\n+    While any such pattern would usually make no sense, it can be made to work\n+    with a new type that holds an extra reference (strong_ptr), and one that\n+    observes the lifetime of extra references (decay_ptr).\n+\n+    The process is:\n+        1. Create a strong_ptr like any typical smart pointer. It cannot be\n+            copied, but it can \"loan out\" shared_ptrs using\n+            strong_ptr::get_shared().\n+        2. Use the \"loaned\" shared_ptrs as usual, and use the strong_ptr as\n+            though it were a unique_ptr.\n+        3. When it's time to coalesce, move the strong_ptr into a decay_ptr.\n+        4. Query the status with decay_ptr::decayed().\n+\n+    Once moved into a decay_ptr, the original strong_ptr is reset, and the\n+    decay_ptr is unable to loan out any new shared_ptrs. Once the decay_ptr has\n+    decayed, it behaves just like a unique_ptr.\n+\n+    If a loaned shared_ptr outlives the strong_ptr that owns it, the lifetime\n+    is extended until the last copy is deleted. This is accomplished by\n+    creating a shared_ptr to represent the lifetime of the strong_ptr, and\n+    storing a copy of it in the loaned shared_ptr's deleter.\n+\n+    Thus, strong_ptr and decay_ptr ensure that allocated memory is always freed.\n+\n+    Here's a quick example of their use:\n+\n+        void func(std::shared_ptr<int>)\n+        {\n+            // Some long-lived operation\n+        }\n+\n+        int main()\n+        {\n+            strong_ptr<int> str(make_strong<int>(100));\n+            std::thread(func, str.get_shared());\n+            decay_ptr<int> dec(std::move(strong));\n+            // The original strong_ptr is now reset\n+            while (!dec.decayed()) {\n+                // wait here\n+                continue;\n+            }\n+            // dec is guaranteed to be unique here. Its memory will be freed\n+            // when it goes out of scope.\n+            return 0;\n+        }\n+*/\n+\n+template <typename T>\n+class decay_ptr;\n+\n+template <typename T>\n+class strong_ptr\n+{\n+    struct shared_deleter {\n+        void operator()(T* /* unused */) const {}\n+        const std::shared_ptr<void> m_data;\n+    };\n+\n+    friend class decay_ptr<T>;\n+\n+    template <typename U, typename... Args>\n+    friend strong_ptr<U> make_strong(Args&&... args);\n+\n+    template <typename U>\n+    explicit strong_ptr(std::shared_ptr<U>&& rhs) : m_data{std::move(rhs)}\n+    {\n+    }\n+\n+public:\n+    using element_type = T;\n+\n+    constexpr strong_ptr() : strong_ptr(nullptr) {}\n+\n+    constexpr strong_ptr(std::nullptr_t) : m_shared{nullptr} {}\n+\n+    template <typename U>\n+    explicit strong_ptr(U* ptr) : m_data(ptr)\n+    {\n+    }\n+\n+    template <typename Deleter>\n+    strong_ptr(std::nullptr_t ptr, Deleter deleter) : m_data{ptr, std::move(deleter)}\n+    {\n+    }\n+\n+    template <typename U, typename Deleter>\n+    strong_ptr(U* ptr, Deleter deleter) : m_data{ptr, std::move(deleter)}\n+    {\n+    }\n+\n+    template <typename U, typename Deleter>\n+    strong_ptr(std::unique_ptr<U, Deleter>&& rhs) : m_data{std::move(rhs)}\n+    {\n+    }\n+\n+    template <typename U>\n+    strong_ptr(strong_ptr<U>&& rhs) : m_data{std::move(rhs.m_data)}, m_shared{std::move(rhs.m_shared)}\n+    {\n+    }\n+\n+    strong_ptr(strong_ptr&& rhs) noexcept : m_data{std::move(rhs.m_data)}, m_shared{std::move(rhs.m_shared)} {}\n+\n+    ~strong_ptr() = default;\n+\n+    strong_ptr(const strong_ptr& rhs) = delete;\n+    strong_ptr& operator=(const strong_ptr& rhs) = delete;\n+\n+    strong_ptr& operator=(strong_ptr&& rhs) noexcept\n+    {\n+        m_data = std::move(rhs.m_data);\n+        m_shared = std::move(rhs.m_shared);\n+        return *this;\n+    }\n+\n+    template <typename U>\n+    strong_ptr& operator=(strong_ptr<U>&& rhs)\n+    {\n+        m_data = std::move(rhs.m_data);\n+        m_shared = std::move(rhs.m_shared);\n+        return *this;\n+    }\n+\n+    template <typename U>\n+    strong_ptr& operator=(U* rhs)\n+    {\n+        reset(rhs);\n+        return *this;\n+    }\n+\n+    template <typename U, typename Deleter>\n+    strong_ptr& operator=(std::unique_ptr<U, Deleter>&& rhs)\n+    {\n+        m_data = std::move(rhs);\n+        m_shared.reset(nullptr, shared_deleter{m_data});\n+        return *this;\n+    }\n+\n+    void reset()\n+    {\n+        m_data.reset();\n+        m_shared.reset();\n+    }\n+    void reset(std::nullptr_t)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10738#discussion_r166316663",
      "id" : 166316663,
      "original_commit_id" : "6dc671a22046c6c09a6de2b1d38e9e2fa3920628",
      "original_position" : 156,
      "path" : "src/strong_ptr.h",
      "position" : 156,
      "pull_request_review_id" : 94360577,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10738",
      "updated_at" : "2018-02-06T14:44:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/166316663",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10738#discussion_r166320184"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10738"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/166320184"
         }
      },
      "author_association" : "OWNER",
      "body" : "Nice! I like how this cleans up the searching functions. Maybe add a comment (for doxygen) that this returns the first (arbitrary) node that matches a certain predicate, or `nullptr` otherwise.",
      "commit_id" : "6dc671a22046c6c09a6de2b1d38e9e2fa3920628",
      "created_at" : "2018-02-06T14:31:53Z",
      "diff_hunk" : "@@ -333,6 +328,19 @@ class CConnman\n     // Whether the node should be passed out in ForEach* callbacks\n     static bool NodeFullyConnected(const CNode* pnode);\n \n+    template <typename Callable>",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10738#discussion_r166320184",
      "id" : 166320184,
      "original_commit_id" : "e1dbd84efeba803437bc97507288cde37f640fb1",
      "original_position" : 16,
      "path" : "src/net.h",
      "position" : null,
      "pull_request_review_id" : 94360577,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10738",
      "updated_at" : "2018-02-06T14:44:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/166320184",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10738#discussion_r166323055"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10738"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/166323055"
         }
      },
      "author_association" : "OWNER",
      "body" : "Creating a copy - increasing all refcounts in the process, just to drop them again at the end of the function - feels like a lot of overhead, how many lock operations does that take internally? Can we somehow benchmark that this is more efficient than holding cs_vnodes for the entire time? (or at least, not much slower, not all the cases are performance critical and it does clean up the code)",
      "commit_id" : "6dc671a22046c6c09a6de2b1d38e9e2fa3920628",
      "created_at" : "2018-02-06T14:40:56Z",
      "diff_hunk" : "@@ -329,6 +329,19 @@ class CConnman\n     // Whether the node should be passed out in ForEach* callbacks\n     static bool NodeFullyConnected(const CNode* pnode);\n \n+    std::vector<std::shared_ptr<CNode>> GetNodesCopy() const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10738#discussion_r166323055",
      "id" : 166323055,
      "original_commit_id" : "afd1a552d20ecf24789b1fdb81d080d177037275",
      "original_position" : 40,
      "path" : "src/net.h",
      "position" : 85,
      "pull_request_review_id" : 94360577,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10738",
      "updated_at" : "2018-02-06T14:44:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/166323055",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10738#discussion_r167354695"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10738"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/167354695"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Performance isn't the intention, this was done in order to avoid keeping cs_vNodes locked during the ForEachNode callbacks. Though I agree and also really dislike the overhead.",
      "commit_id" : "6dc671a22046c6c09a6de2b1d38e9e2fa3920628",
      "created_at" : "2018-02-09T21:49:03Z",
      "diff_hunk" : "@@ -329,6 +329,19 @@ class CConnman\n     // Whether the node should be passed out in ForEach* callbacks\n     static bool NodeFullyConnected(const CNode* pnode);\n \n+    std::vector<std::shared_ptr<CNode>> GetNodesCopy() const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10738#discussion_r167354695",
      "id" : 167354695,
      "in_reply_to_id" : 166323055,
      "original_commit_id" : "afd1a552d20ecf24789b1fdb81d080d177037275",
      "original_position" : 40,
      "path" : "src/net.h",
      "position" : 85,
      "pull_request_review_id" : 95573235,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10738",
      "updated_at" : "2018-02-09T21:49:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/167354695",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/10738#discussion_r167358024"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10738"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/167358024"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Heh, I have no idea why I added that. Will remove.",
      "commit_id" : "6dc671a22046c6c09a6de2b1d38e9e2fa3920628",
      "created_at" : "2018-02-09T22:04:04Z",
      "diff_hunk" : "@@ -0,0 +1,317 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_STRONGPTR_H\n+#define BITCOIN_STRONGPTR_H\n+\n+#include <memory>\n+\n+/*\n+    strong_ptr and decay_ptr create a safe use pattern for moving shared_ptrs\n+    to a unique_ptr.\n+\n+    While any such pattern would usually make no sense, it can be made to work\n+    with a new type that holds an extra reference (strong_ptr), and one that\n+    observes the lifetime of extra references (decay_ptr).\n+\n+    The process is:\n+        1. Create a strong_ptr like any typical smart pointer. It cannot be\n+            copied, but it can \"loan out\" shared_ptrs using\n+            strong_ptr::get_shared().\n+        2. Use the \"loaned\" shared_ptrs as usual, and use the strong_ptr as\n+            though it were a unique_ptr.\n+        3. When it's time to coalesce, move the strong_ptr into a decay_ptr.\n+        4. Query the status with decay_ptr::decayed().\n+\n+    Once moved into a decay_ptr, the original strong_ptr is reset, and the\n+    decay_ptr is unable to loan out any new shared_ptrs. Once the decay_ptr has\n+    decayed, it behaves just like a unique_ptr.\n+\n+    If a loaned shared_ptr outlives the strong_ptr that owns it, the lifetime\n+    is extended until the last copy is deleted. This is accomplished by\n+    creating a shared_ptr to represent the lifetime of the strong_ptr, and\n+    storing a copy of it in the loaned shared_ptr's deleter.\n+\n+    Thus, strong_ptr and decay_ptr ensure that allocated memory is always freed.\n+\n+    Here's a quick example of their use:\n+\n+        void func(std::shared_ptr<int>)\n+        {\n+            // Some long-lived operation\n+        }\n+\n+        int main()\n+        {\n+            strong_ptr<int> str(make_strong<int>(100));\n+            std::thread(func, str.get_shared());\n+            decay_ptr<int> dec(std::move(strong));\n+            // The original strong_ptr is now reset\n+            while (!dec.decayed()) {\n+                // wait here\n+                continue;\n+            }\n+            // dec is guaranteed to be unique here. Its memory will be freed\n+            // when it goes out of scope.\n+            return 0;\n+        }\n+*/\n+\n+template <typename T>\n+class decay_ptr;\n+\n+template <typename T>\n+class strong_ptr\n+{\n+    struct shared_deleter {\n+        void operator()(T* /* unused */) const {}\n+        const std::shared_ptr<void> m_data;\n+    };\n+\n+    friend class decay_ptr<T>;\n+\n+    template <typename U, typename... Args>\n+    friend strong_ptr<U> make_strong(Args&&... args);\n+\n+    template <typename U>\n+    explicit strong_ptr(std::shared_ptr<U>&& rhs) : m_data{std::move(rhs)}\n+    {\n+    }\n+\n+public:\n+    using element_type = T;\n+\n+    constexpr strong_ptr() : strong_ptr(nullptr) {}\n+\n+    constexpr strong_ptr(std::nullptr_t) : m_shared{nullptr} {}\n+\n+    template <typename U>\n+    explicit strong_ptr(U* ptr) : m_data(ptr)\n+    {\n+    }\n+\n+    template <typename Deleter>\n+    strong_ptr(std::nullptr_t ptr, Deleter deleter) : m_data{ptr, std::move(deleter)}\n+    {\n+    }\n+\n+    template <typename U, typename Deleter>\n+    strong_ptr(U* ptr, Deleter deleter) : m_data{ptr, std::move(deleter)}\n+    {\n+    }\n+\n+    template <typename U, typename Deleter>\n+    strong_ptr(std::unique_ptr<U, Deleter>&& rhs) : m_data{std::move(rhs)}\n+    {\n+    }\n+\n+    template <typename U>\n+    strong_ptr(strong_ptr<U>&& rhs) : m_data{std::move(rhs.m_data)}, m_shared{std::move(rhs.m_shared)}\n+    {\n+    }\n+\n+    strong_ptr(strong_ptr&& rhs) noexcept : m_data{std::move(rhs.m_data)}, m_shared{std::move(rhs.m_shared)} {}\n+\n+    ~strong_ptr() = default;\n+\n+    strong_ptr(const strong_ptr& rhs) = delete;\n+    strong_ptr& operator=(const strong_ptr& rhs) = delete;\n+\n+    strong_ptr& operator=(strong_ptr&& rhs) noexcept\n+    {\n+        m_data = std::move(rhs.m_data);\n+        m_shared = std::move(rhs.m_shared);\n+        return *this;\n+    }\n+\n+    template <typename U>\n+    strong_ptr& operator=(strong_ptr<U>&& rhs)\n+    {\n+        m_data = std::move(rhs.m_data);\n+        m_shared = std::move(rhs.m_shared);\n+        return *this;\n+    }\n+\n+    template <typename U>\n+    strong_ptr& operator=(U* rhs)\n+    {\n+        reset(rhs);\n+        return *this;\n+    }\n+\n+    template <typename U, typename Deleter>\n+    strong_ptr& operator=(std::unique_ptr<U, Deleter>&& rhs)\n+    {\n+        m_data = std::move(rhs);\n+        m_shared.reset(nullptr, shared_deleter{m_data});\n+        return *this;\n+    }\n+\n+    void reset()\n+    {\n+        m_data.reset();\n+        m_shared.reset();\n+    }\n+    void reset(std::nullptr_t)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10738#discussion_r167358024",
      "id" : 167358024,
      "in_reply_to_id" : 166316663,
      "original_commit_id" : "6dc671a22046c6c09a6de2b1d38e9e2fa3920628",
      "original_position" : 156,
      "path" : "src/strong_ptr.h",
      "position" : 156,
      "pull_request_review_id" : 95577203,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/10738",
      "updated_at" : "2018-02-09T22:04:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/167358024",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/417043?v=4",
         "events_url" : "https://api.github.com/users/theuni/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theuni/followers",
         "following_url" : "https://api.github.com/users/theuni/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theuni/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theuni",
         "id" : 417043,
         "login" : "theuni",
         "organizations_url" : "https://api.github.com/users/theuni/orgs",
         "received_events_url" : "https://api.github.com/users/theuni/received_events",
         "repos_url" : "https://api.github.com/users/theuni/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theuni/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theuni/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theuni"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The title sounds great because is not \"reinventing the wheel\" like our own ref_count data structure.\r\nBut strong_pointer feels like reinventing the wheel again...",
      "created_at" : "2018-02-10T15:36:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10738#issuecomment-364663457",
      "id" : 364663457,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10738",
      "updated_at" : "2018-02-10T15:36:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/364663457",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/1008458?v=4",
         "events_url" : "https://api.github.com/users/jtimon/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jtimon/followers",
         "following_url" : "https://api.github.com/users/jtimon/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jtimon/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jtimon",
         "id" : 1008458,
         "login" : "jtimon",
         "organizations_url" : "https://api.github.com/users/jtimon/orgs",
         "received_events_url" : "https://api.github.com/users/jtimon/received_events",
         "repos_url" : "https://api.github.com/users/jtimon/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jtimon/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jtimon"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--5fd3d806e98f4a0ca80977bb178665a0-->There hasn't been much activity lately and the patch still needs rebase, so I am closing this for now. Please let me know when you want to continue working on this, so the pull request can be re-opened.",
      "created_at" : "2018-11-08T23:20:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/10738#issuecomment-437192700",
      "id" : 437192700,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/10738",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDQzNzE5MjcwMA==",
      "updated_at" : "2018-11-08T23:20:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/437192700",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   }
]
