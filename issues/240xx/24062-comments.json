[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.",
      "created_at" : "2022-01-14T02:24:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24062#issuecomment-1012690611",
      "id" : 1012690611,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24062",
      "node_id" : "IC_kwDOABII5848XG6z",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1012690611/reactions"
      },
      "updated_at" : "2022-05-14T11:11:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1012690611",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. Thanks!",
      "created_at" : "2022-01-14T08:02:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24062#issuecomment-1012894789",
      "id" : 1012894789,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24062",
      "node_id" : "IC_kwDOABII5848X4xF",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1012894789/reactions"
      },
      "updated_at" : "2022-01-14T08:02:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1012894789",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24062#discussion_r784643490"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24062"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/784643490"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> ... it is not possible that within one section another one is called...\r\n\r\nIt is not obvious where functions with a non-trivial body--like `PushMessage`--are called. Even everything is correct now, there is a possibility to introduce a recursion in the future by modifying the `PushMessage` function or other functions been called from within it.\r\n\r\nCould we just call `PushMessage` without holding `most_recent_block_mutex`?",
      "commit_id" : "83003ffe049a432f6fa4127e054f073127e70b90",
      "created_at" : "2022-01-14T08:22:12Z",
      "diff_hunk" : "@@ -4704,7 +4704,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n \n                     bool fGotBlockFromCache = false;\n                     {\n-                        LOCK(cs_most_recent_block);\n+                        LOCK(most_recent_block_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24062#discussion_r784643490",
      "id" : 784643490,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584uxLWi",
      "original_commit_id" : "cac83660c07568820dcd0cd9cc71548bf05857c3",
      "original_line" : 4708,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 852638995,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24062",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/784643490/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-19T20:35:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/784643490",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24062#discussion_r784809257"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24062"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/784809257"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fair enough, will take a deeper look.",
      "commit_id" : "cac83660c07568820dcd0cd9cc71548bf05857c3",
      "created_at" : "2022-01-14T12:35:30Z",
      "diff_hunk" : "@@ -4704,7 +4704,7 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n \n                     bool fGotBlockFromCache = false;\n                     {\n-                        LOCK(cs_most_recent_block);\n+                        LOCK(most_recent_block_mutex);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24062#discussion_r784809257",
      "id" : 784809257,
      "in_reply_to_id" : 784643490,
      "line" : 4707,
      "node_id" : "PRRC_kwDOABII584uxz0p",
      "original_commit_id" : "cac83660c07568820dcd0cd9cc71548bf05857c3",
      "original_line" : 4707,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 64,
      "pull_request_review_id" : 852867806,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24062",
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/784809257/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-14T12:35:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/784809257",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Added another commit which reduces the scope of the lock `most_recent_block_mutex`, [as suggested by @hebasto](https://github.com/bitcoin/bitcoin/pull/24062#discussion_r784643490). Rather than calling the non-trivial method `CConnman::PushMessage` immediately, only the (cached) cmpctblock message is now assembled and sent after, outside of the critical section.",
      "created_at" : "2022-01-25T15:16:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24062#issuecomment-1021294673",
      "id" : 1021294673,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24062",
      "node_id" : "IC_kwDOABII584837hR",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1021294673/reactions"
      },
      "updated_at" : "2022-01-25T15:16:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1021294673",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-04-30T11:01:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24062#issuecomment-1113968360",
      "id" : 1113968360,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24062",
      "node_id" : "IC_kwDOABII585CZc7o",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1113968360/reactions"
      },
      "updated_at" : "2022-04-30T11:01:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1113968360",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased on master. Note that the scripted-diff renaming commit (getting rid of the lock's `cs_` prefix) was dropped as this was already resolved in the recently merged PR #24543. Also updated the PR title and description accordingly with the current critical section code snippets.",
      "created_at" : "2022-05-01T23:58:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24062#issuecomment-1114371295",
      "id" : 1114371295,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24062",
      "node_id" : "IC_kwDOABII585Ca_Tf",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1114371295/reactions"
      },
      "updated_at" : "2022-05-01T23:58:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1114371295",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-05-16T13:06:01Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24062#issuecomment-1127648578",
      "id" : 1127648578,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24062",
      "node_id" : "IC_kwDOABII585DNo1C",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1127648578/reactions"
      },
      "updated_at" : "2022-05-16T13:06:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1127648578",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased on master, updated the PR description with the current critical section code snippets (shorter after #20799 has been merged). The boolean variable `fGotBlockFromCache` is now removed in the first commit and a std::optional on the cached message is used instead, which I think is a bit more elegant.",
      "created_at" : "2022-05-16T13:35:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24062#issuecomment-1127685253",
      "id" : 1127685253,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24062",
      "node_id" : "IC_kwDOABII585DNxyF",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1127685253/reactions"
      },
      "updated_at" : "2022-05-16T13:35:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1127685253",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/91535?v=4",
         "events_url" : "https://api.github.com/users/theStack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/theStack/followers",
         "following_url" : "https://api.github.com/users/theStack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/theStack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/theStack",
         "id" : 91535,
         "login" : "theStack",
         "node_id" : "MDQ6VXNlcjkxNTM1",
         "organizations_url" : "https://api.github.com/users/theStack/orgs",
         "received_events_url" : "https://api.github.com/users/theStack/received_events",
         "repos_url" : "https://api.github.com/users/theStack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/theStack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/theStack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/theStack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24062#discussion_r873745398"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24062"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/873745398"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "As std::optional default value is nullopt. Could write it as:\r\n```\r\nif (cached_cmpctblock_msg) {\r\n    m_connman.PushMessage(pto, std::move(*cached_cmpctblock_msg));\r\n}\r\n```",
      "commit_id" : "83003ffe049a432f6fa4127e054f073127e70b90",
      "created_at" : "2022-05-16T13:43:56Z",
      "diff_hunk" : "@@ -4759,15 +4759,16 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                     LogPrint(BCLog::NET, \"%s sending header-and-ids %s to peer=%d\\n\", __func__,\n                             vHeaders.front().GetHash().ToString(), pto->GetId());\n \n-                    bool fGotBlockFromCache = false;\n+                    std::optional<CSerializedNetMsg> cached_cmpctblock_msg;\n                     {\n                         LOCK(m_most_recent_block_mutex);\n                         if (m_most_recent_block_hash == pBestIndex->GetBlockHash()) {\n-                            m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::CMPCTBLOCK, *m_most_recent_compact_block));\n-                            fGotBlockFromCache = true;\n+                            cached_cmpctblock_msg = msgMaker.Make(NetMsgType::CMPCTBLOCK, *m_most_recent_compact_block);\n                         }\n                     }\n-                    if (!fGotBlockFromCache) {\n+                    if (cached_cmpctblock_msg.has_value()) {\n+                        m_connman.PushMessage(pto, std::move(cached_cmpctblock_msg.value()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24062#discussion_r873745398",
      "id" : 873745398,
      "line" : 4770,
      "node_id" : "PRRC_kwDOABII5840FEv2",
      "original_commit_id" : "83003ffe049a432f6fa4127e054f073127e70b90",
      "original_line" : 4770,
      "original_position" : 25,
      "original_start_line" : 4769,
      "path" : "src/net_processing.cpp",
      "position" : 25,
      "pull_request_review_id" : 973984527,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24062",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/873745398/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 4769,
      "start_side" : "RIGHT",
      "updated_at" : "2022-05-16T14:06:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/873745398",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24062#discussion_r874483424"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24062"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874483424"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Just realized, all of this could be written as:\r\n\r\n```cpp\r\nif (WITH_LOCK(m_most_recent_block_mutex, return m_most_recent_block_hash == pBestIndex->GetBlockHash())) {\r\n    m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::CMPCTBLOCK, *m_most_recent_compact_block));\r\n",
      "commit_id" : "83003ffe049a432f6fa4127e054f073127e70b90",
      "created_at" : "2022-05-17T07:50:28Z",
      "diff_hunk" : "@@ -4759,15 +4759,16 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                     LogPrint(BCLog::NET, \"%s sending header-and-ids %s to peer=%d\\n\", __func__,\n                             vHeaders.front().GetHash().ToString(), pto->GetId());\n \n-                    bool fGotBlockFromCache = false;\n+                    std::optional<CSerializedNetMsg> cached_cmpctblock_msg;\n                     {\n                         LOCK(m_most_recent_block_mutex);\n                         if (m_most_recent_block_hash == pBestIndex->GetBlockHash()) {\n-                            m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::CMPCTBLOCK, *m_most_recent_compact_block));\n-                            fGotBlockFromCache = true;\n+                            cached_cmpctblock_msg = msgMaker.Make(NetMsgType::CMPCTBLOCK, *m_most_recent_compact_block);\n                         }\n                     }\n-                    if (!fGotBlockFromCache) {\n+                    if (cached_cmpctblock_msg.has_value()) {\n+                        m_connman.PushMessage(pto, std::move(cached_cmpctblock_msg.value()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24062#discussion_r874483424",
      "id" : 874483424,
      "line" : 4770,
      "node_id" : "PRRC_kwDOABII5840H47g",
      "original_commit_id" : "83003ffe049a432f6fa4127e054f073127e70b90",
      "original_line" : 4770,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 25,
      "pull_request_review_id" : 974995631,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24062",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874483424/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-17T07:50:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874483424",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24062#discussion_r874615848"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24062"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874615848"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`m_most_recent_compact_block` should also be accessed from within a critical section.",
      "commit_id" : "83003ffe049a432f6fa4127e054f073127e70b90",
      "created_at" : "2022-05-17T09:55:25Z",
      "diff_hunk" : "@@ -4759,15 +4759,16 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n                     LogPrint(BCLog::NET, \"%s sending header-and-ids %s to peer=%d\\n\", __func__,\n                             vHeaders.front().GetHash().ToString(), pto->GetId());\n \n-                    bool fGotBlockFromCache = false;\n+                    std::optional<CSerializedNetMsg> cached_cmpctblock_msg;\n                     {\n                         LOCK(m_most_recent_block_mutex);\n                         if (m_most_recent_block_hash == pBestIndex->GetBlockHash()) {\n-                            m_connman.PushMessage(pto, msgMaker.Make(NetMsgType::CMPCTBLOCK, *m_most_recent_compact_block));\n-                            fGotBlockFromCache = true;\n+                            cached_cmpctblock_msg = msgMaker.Make(NetMsgType::CMPCTBLOCK, *m_most_recent_compact_block);\n                         }\n                     }\n-                    if (!fGotBlockFromCache) {\n+                    if (cached_cmpctblock_msg.has_value()) {\n+                        m_connman.PushMessage(pto, std::move(cached_cmpctblock_msg.value()));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24062#discussion_r874615848",
      "id" : 874615848,
      "in_reply_to_id" : 874483424,
      "line" : 4770,
      "node_id" : "PRRC_kwDOABII5840IZQo",
      "original_commit_id" : "83003ffe049a432f6fa4127e054f073127e70b90",
      "original_line" : 4770,
      "original_position" : 25,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 25,
      "pull_request_review_id" : 975183587,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24062",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874615848/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-17T09:56:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/874615848",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   }
]
