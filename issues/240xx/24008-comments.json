[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [fjahr](https://github.com/bitcoin/bitcoin/pull/24008#pullrequestreview-1428107827) |\n| Concept ACK | [naumenkogs](https://github.com/bitcoin/bitcoin/pull/24008#issuecomment-1064991171), [ariard](https://github.com/bitcoin/bitcoin/pull/24008#pullrequestreview-1081310397), [mzumsande](https://github.com/bitcoin/bitcoin/pull/24008#pullrequestreview-1157367086) |\n| Approach ACK | [jonatack](https://github.com/bitcoin/bitcoin/pull/24008#pullrequestreview-875201275) |\n| Stale ACK | [ryanofsky](https://github.com/bitcoin/bitcoin/pull/24008#pullrequestreview-1178353665) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#27626](https://github.com/bitcoin/bitcoin/pull/27626) (Parallel compact block downloads, take 3 by instagibbs)\n* [#27596](https://github.com/bitcoin/bitcoin/pull/27596) (assumeutxo (2) by jamesob)\n* [#27576](https://github.com/bitcoin/bitcoin/pull/27576) (kernel: Remove args, chainparams, chainparamsbase from kernel library by TheCharlatan)\n* [#26762](https://github.com/bitcoin/bitcoin/pull/26762) (refactor: Make `CCheckQueue` RAII-styled by hebasto)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2022-01-07T20:25:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#issuecomment-1007716637",
      "id" : 1007716637,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24008",
      "node_id" : "IC_kwDOABII5848EIkd",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1007716637/reactions"
      },
      "updated_at" : "2023-05-16T21:49:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1007716637",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Queuing this one up for review soon.",
      "created_at" : "2022-01-31T21:08:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#issuecomment-1026211300",
      "id" : 1026211300,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24008",
      "node_id" : "IC_kwDOABII5849Kr3k",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1026211300/reactions"
      },
      "updated_at" : "2022-01-31T21:08:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1026211300",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r797103646"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797103646"
         }
      },
      "author_association" : "MEMBER",
      "body" : "17906dd5\r\n```suggestion\r\n    // Returns nullptr if no snapshot has been loaded.\r\n```",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-02-01T22:38:20Z",
      "diff_hunk" : "@@ -822,6 +822,10 @@ class ChainstateManager\n         CBlockIndex** ppindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n     friend CChainState;\n \n+    // Returns nullptr if no snapshot ahs been loaded.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r797103646",
      "id" : 797103646,
      "line" : 825,
      "node_id" : "PRRC_kwDOABII584vgtYe",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 825,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 4,
      "pull_request_review_id" : 869907044,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797103646/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-02T23:09:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797103646",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r797105983"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797105983"
         }
      },
      "author_association" : "MEMBER",
      "body" : "17906dd5 suggestions\r\n\r\n- add `AssertLockHeld(::cs_main);`\r\n- use PascalCase for the function name in new code\r\n- use const with braced initialization\r\n\r\n<details><summary>suggested diff</summary><p>\r\n\r\n```diff\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex d81ee4fa03..5c9bf34aad 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -5091,16 +5091,18 @@ void ChainstateManager::MaybeRebalanceCaches()\r\n     }\r\n }\r\n \r\n-CBlockIndex* ChainstateManager::getSnapshotBaseBlock()\r\n+CBlockIndex* ChainstateManager::GetSnapshotBaseBlock()\r\n {\r\n+    AssertLockHeld(::cs_main);\r\n-    auto blockhash_op = SnapshotBlockhash();\r\n+    const auto blockhash_op{SnapshotBlockhash()};\r\n     if (!blockhash_op) return nullptr;\r\n     return m_blockman.LookupBlockIndex(*blockhash_op);\r\n }\r\n \r\n-std::optional<int> ChainstateManager::getSnapshotHeight()\r\n+std::optional<int> ChainstateManager::GetSnapshotHeight()\r\n {\r\n+    AssertLockHeld(::cs_main);\r\n-    CBlockIndex* base = getSnapshotBaseBlock();\r\n+    const CBlockIndex* base{GetSnapshotBaseBlock()};\r\n     return base ? std::make_optional(base->nHeight) : std::nullopt;\r\n }\r\n \r\ndiff --git a/src/validation.h b/src/validation.h\r\nindex ddeddbcecc..5bc249c27c 100644\r\n--- a/src/validation.h\r\n+++ b/src/validation.h\r\n@@ -842,8 +842,8 @@ private:\r\n     friend CChainState;\r\n \r\n     // Returns nullptr if no snapshot ahs been loaded.\r\n-    CBlockIndex* getSnapshotBaseBlock() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n-    std::optional<int> getSnapshotHeight() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n+    CBlockIndex* GetSnapshotBaseBlock() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n+    std::optional<int> GetSnapshotHeight() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\r\n \r\n public:\r\n     std::thread m_load_block;\r\n```\r\n</p></details>\r\n",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-02-01T22:40:59Z",
      "diff_hunk" : "@@ -4984,3 +5029,33 @@ void ChainstateManager::MaybeRebalanceCaches()\n         }\n     }\n }\n+\n+CBlockIndex* ChainstateManager::getSnapshotBaseBlock()\n+{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r797105983",
      "id" : 797105983,
      "line" : 5034,
      "node_id" : "PRRC_kwDOABII584vgt8_",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 5034,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 94,
      "pull_request_review_id" : 869907044,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797105983/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-02T23:18:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797105983",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r797166061"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797166061"
         }
      },
      "author_association" : "MEMBER",
      "body" : "75912c5 suggestions\r\n\r\n- add missing `AssertLockHeld(::cs_main);`\r\n- place comment outside of conditional\r\n- const with braced init\r\n\r\n<details><summary>suggested diff</summary><p>\r\n\r\n```diff\r\n\r\n CChainState& ChainstateManager::GetChainstateForNewBlock(const uint256& blockhash)\r\n {\r\n+    AssertLockHeld(::cs_main);\r\n-    auto* pblock = m_blockman.LookupBlockIndex(blockhash);\r\n+    const auto* pblock{m_blockman.LookupBlockIndex(blockhash)};\r\n     if (m_snapshot_chainstate &&\r\n-            // If pblock is null, we haven't seen the header for this block.\r\n-            // Because we expect to have received the headers for the IBD chain\r\n-            // contents before receiving blocks, this means that any block for\r\n-            // which we don't have headers should go in the snapshot chain.\r\n-            (pblock == nullptr || !m_snapshot_chainstate->m_chain.Contains(pblock))) {\r\n+        (pblock == nullptr || !m_snapshot_chainstate->m_chain.Contains(pblock))) {\r\n+        // If pblock is null, we haven't seen the header for this block.\r\n+        // Because we expect to have received the headers for the IBD chain\r\n+        // contents before receiving blocks, this means that any block for\r\n+        // which we don't have headers should go in the snapshot chain.\r\n         return *m_snapshot_chainstate.get();\r\n```\r\n</p></details>\r\n",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-02-02T00:00:32Z",
      "diff_hunk" : "@@ -4921,6 +4951,21 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+CChainState& ChainstateManager::GetChainstateForNewBlock(const uint256& blockhash)\n+{\n+    auto* pblock = m_blockman.LookupBlockIndex(blockhash);\n+    if (m_snapshot_chainstate &&\n+            // If pblock is null, we haven't seen the header for this block.\n+            // Because we expect to have received the headers for the IBD chain\n+            // contents before receiving blocks, this means that any block for\n+            // which we don't have headers should go in the snapshot chain.\n+            (pblock == nullptr || !m_snapshot_chainstate->m_chain.Contains(pblock))) {\n+        return *m_snapshot_chainstate.get();\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r797166061",
      "id" : 797166061,
      "line" : 4964,
      "node_id" : "PRRC_kwDOABII584vg8nt",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 4964,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 80,
      "pull_request_review_id" : 869907044,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797166061/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-02T23:09:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797166061",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r797169841"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797169841"
         }
      },
      "author_association" : "MEMBER",
      "body" : "75912c552e43e0bb43e42349164d0aa279927013 suggestions\r\n- `::cs_main` preferred over `cs_main` to clarify it is a global\r\n-  `chainstate` can use braced init and an inlined `WITH_LOCK` macro\r\n\r\n<details><summary>diff</summary><p>\r\n\r\n```diff\r\n     AssertLockNotHeld(cs_main);\r\n-\r\n-    CChainState* chainstate;\r\n-    {\r\n-        LOCK(cs_main);\r\n-        chainstate = &this->GetChainstateForNewBlock(block->GetHash());\r\n-    }\r\n+    CChainState* chainstate{\r\n+        WITH_LOCK(::cs_main, return &this->GetChainstateForNewBlock(block->GetHash()))};\r\n```\r\n</p></details>\r\n",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-02-02T00:06:20Z",
      "diff_hunk" : "@@ -3603,6 +3603,12 @@ bool ChainstateManager::ProcessNewBlock(const CChainParams& chainparams, const s\n {\n     AssertLockNotHeld(cs_main);\n \n+    CChainState* chainstate;\n+    {\n+        LOCK(cs_main);\n+        chainstate = &this->GetChainstateForNewBlock(block->GetHash());\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r797169841",
      "id" : 797169841,
      "line" : 3610,
      "node_id" : "PRRC_kwDOABII584vg9ix",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 3610,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 8,
      "pull_request_review_id" : 869907044,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797169841/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-02T23:11:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/797169841",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r801024687"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801024687"
         }
      },
      "author_association" : "MEMBER",
      "body" : "75912c552e43e0bb43e42349164d0aa279927013 is the lock needed for `chainstate`? `ChainstateManager::ActiveChainstate()` already locks `cs_main`\r\n\r\n```suggestion\r\n    if (chainstate == &this->ActiveChainstate()) {\r\n```",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-02-07T20:18:35Z",
      "diff_hunk" : "@@ -3620,18 +3626,21 @@ bool ChainstateManager::ProcessNewBlock(const CChainParams& chainparams, const s\n         bool ret = CheckBlock(*block, state, chainparams.GetConsensus());\n         if (ret) {\n             // Store to disk\n-            ret = ActiveChainstate().AcceptBlock(block, state, &pindex, force_processing, nullptr, new_block);\n+            ret = chainstate->AcceptBlock(\n+                block, state, &pindex, force_processing, nullptr, new_block);\n         }\n         if (!ret) {\n             GetMainSignals().BlockChecked(*block, state);\n             return error(\"%s: AcceptBlock FAILED (%s)\", __func__, state.ToString());\n         }\n     }\n \n-    NotifyHeaderTip(ActiveChainstate());\n+    if (WITH_LOCK(::cs_main, return chainstate == &this->ActiveChainstate())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r801024687",
      "id" : 801024687,
      "line" : 3638,
      "node_id" : "PRRC_kwDOABII584vvqqv",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 3638,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 28,
      "pull_request_review_id" : 875201275,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801024687/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-07T21:42:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801024687",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r801030242"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801030242"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8cafc54 thread safety run-time assertion needed here\r\n```diff\r\n std::vector<CChainState*> ChainstateManager::GetAllForBlockDownload()\r\n {\r\n+    AssertLockHeld(::cs_main);\r\n     std::vector<CChainState*> out;\r\n```\r\n",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-02-07T20:26:31Z",
      "diff_hunk" : "@@ -4596,6 +4605,27 @@ std::vector<CChainState*> ChainstateManager::GetAll()\n     return out;\n }\n \n+std::vector<CChainState*> ChainstateManager::GetAllForBlockDownload()\n+{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r801030242",
      "id" : 801030242,
      "line" : 4609,
      "node_id" : "PRRC_kwDOABII584vvsBi",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 4609,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 43,
      "pull_request_review_id" : 875201275,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801030242/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-07T21:42:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801030242",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r801031354"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801031354"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8cafc54 style nit\r\n```diff\r\n-    bool snapshot_in_ibd =\r\n-        m_snapshot_chainstate && m_snapshot_chainstate->IsInitialBlockDownload();\r\n+    const bool snapshot_in_ibd{\r\n+        m_snapshot_chainstate && m_snapshot_chainstate->IsInitialBlockDownload()};\r\n```\r\n",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-02-07T20:28:02Z",
      "diff_hunk" : "@@ -4596,6 +4605,27 @@ std::vector<CChainState*> ChainstateManager::GetAll()\n     return out;\n }\n \n+std::vector<CChainState*> ChainstateManager::GetAllForBlockDownload()\n+{\n+    std::vector<CChainState*> out;\n+\n+    bool snapshot_in_ibd =\n+        m_snapshot_chainstate && m_snapshot_chainstate->IsInitialBlockDownload();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r801031354",
      "id" : 801031354,
      "line" : 4613,
      "node_id" : "PRRC_kwDOABII584vvsS6",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 4613,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 47,
      "pull_request_review_id" : 875201275,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801031354/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-07T21:42:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801031354",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r801056945"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801056945"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0ef00576\r\n```diff\r\n-    /** Update pindexLastCommonBlock and add not-in-flight missing successors to vBlocks, until it has\r\n-     *  at most count entries.\r\n+    /** Update `chainstate_to_last_common_block` and add not-in-flight missing\r\n+     *  successors to `vBlocks`, until it has at most `count` entries.\r\n```\r\n",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-02-07T21:04:47Z",
      "diff_hunk" : "@@ -538,7 +538,12 @@ class PeerManagerImpl final : public PeerManager\n     /** Update pindexLastCommonBlock and add not-in-flight missing successors to vBlocks, until it has",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r801056945",
      "id" : 801056945,
      "line" : 538,
      "node_id" : "PRRC_kwDOABII584vvyix",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 538,
      "original_position" : 1,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 1,
      "pull_request_review_id" : 875201275,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801056945/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-07T21:42:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801056945",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r801058811"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801058811"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0ef00576 not sure, but maybe safer on first use in this function to raise instead of failing silently/UB\r\n```suggestion\r\n        state->chainstate_to_last_common_block.at(chainstate) = our_chain[\r\n```",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-02-07T21:07:34Z",
      "diff_hunk" : "@@ -1014,32 +1039,45 @@ void PeerManagerImpl::FindNextBlocksToDownload(NodeId nodeid, unsigned int count\n     // Make sure pindexBestKnownBlock is up to date, we'll need it.\n     ProcessBlockAvailability(nodeid);\n \n-    if (state->pindexBestKnownBlock == nullptr || state->pindexBestKnownBlock->nChainWork < m_chainman.ActiveChain().Tip()->nChainWork || state->pindexBestKnownBlock->nChainWork < nMinimumChainWork) {\n+    const CChain& our_chain = chainstate->m_chain;\n+    const CBlockIndex* our_tip = our_chain.Tip();\n+\n+    if (state->pindexBestKnownBlock == nullptr\n+            || state->pindexBestKnownBlock->nChainWork < our_tip->nChainWork\n+            || state->pindexBestKnownBlock->nChainWork < nMinimumChainWork) {\n         // This peer has nothing interesting.\n         return;\n     }\n \n-    if (state->pindexLastCommonBlock == nullptr) {\n+    if (!state->chainstate_to_last_common_block.count(chainstate)) {\n         // Bootstrap quickly by guessing a parent of our best tip is the forking point.\n         // Guessing wrong in either direction is not a problem.\n-        state->pindexLastCommonBlock = m_chainman.ActiveChain()[std::min(state->pindexBestKnownBlock->nHeight, m_chainman.ActiveChain().Height())];\n+        //\n+        // Namespace this by chainstate so that we can simultaneously sync two\n+        // separate chainstates at different heights.\n+        state->chainstate_to_last_common_block[chainstate] = our_chain[",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r801058811",
      "id" : 801058811,
      "line" : 1058,
      "node_id" : "PRRC_kwDOABII584vvy_7",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 1058,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 84,
      "pull_request_review_id" : 875201275,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801058811/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-07T21:43:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801058811",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r801068809"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801068809"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0ef00576cc9a4aac27310b9fc29c534ad829aad9 suggestions\r\n\r\n```diff\r\n-        // during IBD, but once it hits a tip capacity will trickle into subsequent\r\n-        // chainstates.\r\n-        int requests_available = MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight;\r\n+        // during IBD, but once it hits a tip, capacity will trickle into\r\n+        // subsequent chainstates.\r\n+        int requests_available{MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight};\r\n \r\n-        // Service the snapshot chainstate first - more important to get to the\r\n-        // network's tip quickly than do the background validation on the\r\n-        // snapshot.\r\n+        // GetAllForBlockDownload() services the snapshot chainstate first.\r\n+        // It is more important to get to the network's tip quickly than do the\r\n+        // background validation on the snapshot.\r\n```\r\n",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-02-07T21:22:16Z",
      "diff_hunk" : "@@ -4975,21 +5026,37 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         // Message: getdata (blocks)\n         //\n         std::vector<CInv> vGetData;\n-        if (!pto->fClient && ((fFetch && !pto->m_limited_node) || !m_chainman.ActiveChainstate().IsInitialBlockDownload()) && state.nBlocksInFlight < MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n-            std::vector<const CBlockIndex*> vToDownload;\n-            NodeId staller = -1;\n-            FindNextBlocksToDownload(pto->GetId(), MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight, vToDownload, staller);\n-            for (const CBlockIndex *pindex : vToDownload) {\n-                uint32_t nFetchFlags = GetFetchFlags(*pto);\n-                vGetData.push_back(CInv(MSG_BLOCK | nFetchFlags, pindex->GetBlockHash()));\n-                BlockRequested(pto->GetId(), *pindex);\n-                LogPrint(BCLog::NET, \"Requesting block %s (%d) peer=%d\\n\", pindex->GetBlockHash().ToString(),\n-                    pindex->nHeight, pto->GetId());\n-            }\n-            if (state.nBlocksInFlight == 0 && staller != -1) {\n-                if (State(staller)->m_stalling_since == 0us) {\n-                    State(staller)->m_stalling_since = current_time;\n-                    LogPrint(BCLog::NET, \"Stall started peer=%d\\n\", staller);\n+\n+        // The first chainstate in line for processing will likely exhaust this\n+        // during IBD, but once it hits a tip capacity will trickle into subsequent\n+        // chainstates.\n+        int requests_available = MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight;\n+\n+        // Service the snapshot chainstate first - more important to get to the\n+        // network's tip quickly than do the background validation on the\n+        // snapshot.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r801068809",
      "id" : 801068809,
      "line" : 5037,
      "node_id" : "PRRC_kwDOABII584vv1cJ",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 5037,
      "original_position" : 238,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 238,
      "pull_request_review_id" : 875201275,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801068809/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-07T21:42:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801068809",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r801072282"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801072282"
         }
      },
      "author_association" : "MEMBER",
      "body" : "c4d90167 see #24178 that changes this logic",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-02-07T21:27:14Z",
      "diff_hunk" : "@@ -3184,7 +3234,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n \n         LOCK(cs_main);\n-        if (m_chainman.ActiveChainstate().IsInitialBlockDownload() && !pfrom.HasPermission(NetPermissionFlags::Download)) {\n+        if (m_chainman.IsAnyChainInIBD() && !pfrom.HasPermission(NetPermissionFlags::Download)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r801072282",
      "id" : 801072282,
      "line" : 3237,
      "node_id" : "PRRC_kwDOABII584vv2Sa",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 3237,
      "original_position" : 194,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 194,
      "pull_request_review_id" : 875201275,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801072282/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-07T21:42:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801072282",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r801075886"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801075886"
         }
      },
      "author_association" : "MEMBER",
      "body" : "c4d90167 can simplify here\r\n```diff\r\n-            bool is_ibd;\r\n-            WITH_LOCK(::cs_main, is_ibd = m_chainman.IsAnyChainInIBD());\r\n+            const bool is_ibd{WITH_LOCK(::cs_main, return m_chainman.IsAnyChainInIBD())};\r\n```\r\n",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-02-07T21:32:14Z",
      "diff_hunk" : "@@ -2660,6 +2707,9 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n \n         // Self advertisement & GETADDR logic\n         if (!pfrom.IsInboundConn() && SetupAddressRelay(pfrom, *peer)) {\n+            bool is_ibd;\n+            WITH_LOCK(::cs_main, is_ibd = m_chainman.IsAnyChainInIBD());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r801075886",
      "id" : 801075886,
      "line" : 2711,
      "node_id" : "PRRC_kwDOABII584vv3Ku",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 2711,
      "original_position" : 175,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 175,
      "pull_request_review_id" : 875201275,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801075886/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-07T21:42:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801075886",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r801077582"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801077582"
         }
      },
      "author_association" : "MEMBER",
      "body" : "c4d90167f030547373715a44fc020d0da8461565\r\n```suggestion\r\n    const bool is_ibd{WITH_LOCK(::cs_main, return m_chainman.IsAnyChainInIBD())};\r\n```",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-02-07T21:34:48Z",
      "diff_hunk" : "@@ -4412,9 +4462,10 @@ void PeerManagerImpl::MaybeSendAddr(CNode& node, Peer& peer, std::chrono::micros\n     if (!peer.m_addr_relay_enabled) return;\n \n     LOCK(peer.m_addr_send_times_mutex);\n+    bool is_ibd = WITH_LOCK(::cs_main, return m_chainman.IsAnyChainInIBD());",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r801077582",
      "id" : 801077582,
      "line" : 4465,
      "node_id" : "PRRC_kwDOABII584vv3lO",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 4465,
      "original_position" : 202,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 202,
      "pull_request_review_id" : 875201275,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801077582/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-07T21:42:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801077582",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r801081962"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801081962"
         }
      },
      "author_association" : "MEMBER",
      "body" : "0ef00576cc9a4aac27310b9fc29c534ad829aad9 \r\n\r\n```diff\r\n CChainState& ChainstateManager::getChainstateForIndexing()\r\n {\r\n+    AssertLockHeld(::cs_main);\r\n     return getSnapshotBaseBlock() ? *m_ibd_chainstate : *m_active_chainstate;\r\n }\r\n \r\n@@ -5117,6 +5119,7 @@ bool ChainstateManager::hasBgChainstateInUse()\r\n \r\n bool ChainstateManager::IsAnyChainInIBD()\r\n {\r\n+    AssertLockHeld(::cs_main);\r\n     return\r\n```\r\n\r\nNaming style: PascalCase for `getChainstateForIndexing()` and `getSnapshotHeight()`?",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-02-07T21:41:24Z",
      "diff_hunk" : "@@ -4984,3 +5029,33 @@ void ChainstateManager::MaybeRebalanceCaches()\n         }\n     }\n }\n+\n+CBlockIndex* ChainstateManager::getSnapshotBaseBlock()\n+{\n+    auto blockhash_op = SnapshotBlockhash();\n+    if (!blockhash_op) return nullptr;\n+    return m_blockman.LookupBlockIndex(*blockhash_op);\n+}\n+\n+std::optional<int> ChainstateManager::getSnapshotHeight()\n+{\n+    CBlockIndex* base = getSnapshotBaseBlock();\n+    return base ? std::make_optional(base->nHeight) : std::nullopt;\n+}\n+\n+CChainState& ChainstateManager::getChainstateForIndexing()\n+{\n+    return getSnapshotBaseBlock() ? *m_ibd_chainstate : *m_active_chainstate;\n+}\n+\n+bool ChainstateManager::hasBgChainstateInUse()\n+{\n+    return this->SnapshotBlockhash() && !m_snapshot_validated;\n+}\n+\n+bool ChainstateManager::IsAnyChainInIBD()\n+{\n+    return",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r801081962",
      "id" : 801081962,
      "line" : 5058,
      "node_id" : "PRRC_kwDOABII584vv4pq",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 5058,
      "original_position" : 118,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 118,
      "pull_request_review_id" : 875201275,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801081962/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-07T21:42:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/801081962",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r805085789"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/805085789"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> use PascalCase for the function name in new code\r\n\r\n@ryanofsky has pioneered using `thisCovention` for method names (in order to distinguish methods from functions without using `this`) and so I've been using that here.",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-02-12T00:29:28Z",
      "diff_hunk" : "@@ -4984,3 +5029,33 @@ void ChainstateManager::MaybeRebalanceCaches()\n         }\n     }\n }\n+\n+CBlockIndex* ChainstateManager::getSnapshotBaseBlock()\n+{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r805085789",
      "id" : 805085789,
      "in_reply_to_id" : 797105983,
      "line" : 5034,
      "node_id" : "PRRC_kwDOABII584v_KJd",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 5034,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 94,
      "pull_request_review_id" : 880788546,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/805085789/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-02-12T00:29:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/805085789",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r824590539"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/824590539"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: it takes some effort to see it can't overflow, but perhaps we should make it uint and make according changes?",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-03-11T10:36:33Z",
      "diff_hunk" : "@@ -4980,21 +5022,37 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         // Message: getdata (blocks)\n         //\n         std::vector<CInv> vGetData;\n-        if (!pto->fClient && ((fFetch && !pto->m_limited_node) || !m_chainman.ActiveChainstate().IsInitialBlockDownload()) && state.nBlocksInFlight < MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n-            std::vector<const CBlockIndex*> vToDownload;\n-            NodeId staller = -1;\n-            FindNextBlocksToDownload(pto->GetId(), MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight, vToDownload, staller);\n-            for (const CBlockIndex *pindex : vToDownload) {\n-                uint32_t nFetchFlags = GetFetchFlags(*pto);\n-                vGetData.push_back(CInv(MSG_BLOCK | nFetchFlags, pindex->GetBlockHash()));\n-                BlockRequested(pto->GetId(), *pindex);\n-                LogPrint(BCLog::NET, \"Requesting block %s (%d) peer=%d\\n\", pindex->GetBlockHash().ToString(),\n-                    pindex->nHeight, pto->GetId());\n-            }\n-            if (state.nBlocksInFlight == 0 && staller != -1) {\n-                if (State(staller)->m_stalling_since == 0us) {\n-                    State(staller)->m_stalling_since = current_time;\n-                    LogPrint(BCLog::NET, \"Stall started peer=%d\\n\", staller);\n+\n+        // The first chainstate in line for processing will likely exhaust this\n+        // during IBD, but once it hits a tip capacity will trickle into subsequent\n+        // chainstates.\n+        int requests_available = MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r824590539",
      "id" : 824590539,
      "line" : 5033,
      "node_id" : "PRRC_kwDOABII584xJkDL",
      "original_commit_id" : "0ef00576cc9a4aac27310b9fc29c534ad829aad9",
      "original_line" : 5029,
      "original_position" : 181,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 181,
      "pull_request_review_id" : 907044195,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/824590539/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-11T10:36:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/824590539",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK modulo nits by me and jonatack",
      "created_at" : "2022-03-11T10:41:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#issuecomment-1064991171",
      "id" : 1064991171,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24008",
      "node_id" : "IC_kwDOABII584_ennD",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1064991171/reactions"
      },
      "updated_at" : "2022-03-11T10:41:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1064991171",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r831501460"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/831501460"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"add ChainstateManager.getSnapshot{Height,BaseBlock}()\" (17906dd52543fb75d2c45de884799b35ec5721f4)\r\n\r\nCan methods be const?",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-03-21T20:09:30Z",
      "diff_hunk" : "@@ -822,6 +822,10 @@ class ChainstateManager\n         CBlockIndex** ppindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n     friend CChainState;\n \n+    // Returns nullptr if no snapshot ahs been loaded.\n+    CBlockIndex* getSnapshotBaseBlock() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+    std::optional<int> getSnapshotHeight() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r831501460",
      "id" : 831501460,
      "line" : 827,
      "node_id" : "PRRC_kwDOABII584xj7SU",
      "original_commit_id" : "17906dd52543fb75d2c45de884799b35ec5721f4",
      "original_line" : 827,
      "original_position" : 6,
      "original_start_line" : 826,
      "path" : "src/validation.h",
      "position" : 6,
      "pull_request_review_id" : 916299921,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/831501460/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 826,
      "start_side" : "RIGHT",
      "updated_at" : "2022-03-21T21:08:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/831501460",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r831511847"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/831511847"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: introduce ChainstateManager::GetChainstateForNewBlock\" (75912c552e43e0bb43e42349164d0aa279927013)\r\n\r\nNote: In my own words I'd describe the logic as: Always prefer to add blocks to the newer snapshot chainstate, not the older background chainstate, but add blocks to the background chainstate if they're already in in the snapshot chainstate.",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-03-21T20:23:43Z",
      "diff_hunk" : "@@ -4921,6 +4930,21 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+CChainState& ChainstateManager::GetChainstateForNewBlock(const uint256& blockhash)\n+{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r831511847",
      "id" : 831511847,
      "line" : 4955,
      "node_id" : "PRRC_kwDOABII584xj90n",
      "original_commit_id" : "75912c552e43e0bb43e42349164d0aa279927013",
      "original_line" : 4934,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 43,
      "pull_request_review_id" : 916299921,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/831511847/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-21T21:08:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/831511847",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r831533853"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/831533853"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"p2p: don't advertise until we finish all IBDs\" (c4d90167f030547373715a44fc020d0da8461565)\r\n\r\nMaybe wait to add these until they are actually used and tested",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-03-21T20:53:48Z",
      "diff_hunk" : "@@ -987,6 +987,23 @@ class ChainstateManager\n     //! ResizeCoinsCaches() as needed.\n     void MaybeRebalanceCaches() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! Returns true if any chainstate in use is in initial block download.\n+    bool IsAnyChainInIBD() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    //! @returns the chainstate that indexers should consult when ensuring that an\n+    //!   index is synced with a chain where we can expect block index entries to have\n+    //!   BLOCK_HAVE_DATA beneath the tip.\n+    //!\n+    //!   In other words, give us the chainstate for which we can reasonably expect\n+    //!   that all blocks beneath the tip have been indexed. In practice this means\n+    //!   when using an assumed-valid chainstate based upon a snapshot, return only the\n+    //!   fully validated chain.\n+    CChainState& getChainstateForIndexing() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    //! @returns true if we have more than one chainstate in use. This means that a\n+    //! background validation chainstate is running.\n+    bool hasBgChainstateInUse();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r831533853",
      "id" : 831533853,
      "line" : 1005,
      "node_id" : "PRRC_kwDOABII584xkDMd",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 1005,
      "original_position" : 19,
      "original_start_line" : 993,
      "path" : "src/validation.h",
      "position" : 19,
      "pull_request_review_id" : 916299921,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/831533853/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 993,
      "start_side" : "RIGHT",
      "updated_at" : "2022-03-21T21:08:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/831533853",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r831542382"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/831542382"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"p2p: don't advertise until we finish all IBDs\" (c4d90167f030547373715a44fc020d0da8461565)\r\n\r\nThere are a few other `ActiveChainstate().IsInitialBlockDownload()` calls in this file that aren't replaced by `m_chainman.IsAnyChainInIBD()` calls. Will these need to be changed later to avoid changing network behavior when an assumeutxo snapshot is loaded? If not, maybe it is worth going through the calls in this PR and adding comments that could shed more light on why message processing is affected by IBD status, or why it only depends on active IBD status not full IBD status.",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-03-21T21:05:33Z",
      "diff_hunk" : "@@ -3231,7 +3234,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n \n         LOCK(cs_main);\n-        if (m_chainman.ActiveChainstate().IsInitialBlockDownload() && !pfrom.HasPermission(NetPermissionFlags::Download)) {\n+        if (m_chainman.IsAnyChainInIBD() && !pfrom.HasPermission(NetPermissionFlags::Download)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r831542382",
      "id" : 831542382,
      "line" : 3237,
      "node_id" : "PRRC_kwDOABII584xkFRu",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 3237,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 24,
      "pull_request_review_id" : 916299921,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/831542382/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-03-21T21:08:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/831542382",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r847983627"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/847983627"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "There isn't a function with the name `GetSnapshotHeight` or `GetSnapshotBaseBlock` -- why would you need to distinguish the method from a function that doesn't exist? I really dislike the \"let's randomly introduce new and different code style conventions\" approach, especially when combined with \"let's patch the entire codebase to update to the latest style conventions\".\r\n\r\nThe developers-notes say \"Class names, function names, and method names are UpperCamelCase\r\n(PascalCase). Do not prefix class names with `C`.\"",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-04-12T05:29:10Z",
      "diff_hunk" : "@@ -4984,3 +5029,33 @@ void ChainstateManager::MaybeRebalanceCaches()\n         }\n     }\n }\n+\n+CBlockIndex* ChainstateManager::getSnapshotBaseBlock()\n+{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r847983627",
      "id" : 847983627,
      "in_reply_to_id" : 797105983,
      "line" : 5034,
      "node_id" : "PRRC_kwDOABII584yizQL",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 5034,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 94,
      "pull_request_review_id" : 938917428,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/847983627/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-12T05:29:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/847983627",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r848008098"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/848008098"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> There isn't a function with the name `GetSnapshotHeight` or `GetSnapshotBaseBlock` -- why would you need to distinguish the method from a function that doesn't exist?\r\n\r\nThe reason I like calling non-static member variables `m_var` instead of `var` is not to distinguish them from other variables called `var`, but to make it obvious that they are members, and make code easier to read and understand. Similarly the reason I like calling non-static member functions `fun()` instead of `Fun()` is not to distinguish from other functions call `Fun()`, but to make it obvious that they are members, so code is clearer and easier to understand. It is nice to know, when you are calling a function, if that function will have access to `*this`.\r\n\r\nI just wanted to respond to your question though, not defend or debate anything. This could easily be a garbage coding convention and I am stupid for liking it.",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-04-12T06:10:42Z",
      "diff_hunk" : "@@ -4984,3 +5029,33 @@ void ChainstateManager::MaybeRebalanceCaches()\n         }\n     }\n }\n+\n+CBlockIndex* ChainstateManager::getSnapshotBaseBlock()\n+{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r848008098",
      "id" : 848008098,
      "in_reply_to_id" : 797105983,
      "line" : 5034,
      "node_id" : "PRRC_kwDOABII584yi5Oi",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 5034,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 94,
      "pull_request_review_id" : 938949931,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/848008098/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-12T06:10:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/848008098",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r848018690"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/848018690"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It's a completely fine convention, it's just not the one this codebase has adopted. And if we keep changing conventions we'll never get the benefit of any of them.",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-04-12T06:27:41Z",
      "diff_hunk" : "@@ -4984,3 +5029,33 @@ void ChainstateManager::MaybeRebalanceCaches()\n         }\n     }\n }\n+\n+CBlockIndex* ChainstateManager::getSnapshotBaseBlock()\n+{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r848018690",
      "id" : 848018690,
      "in_reply_to_id" : 797105983,
      "line" : 5034,
      "node_id" : "PRRC_kwDOABII584yi70C",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 5034,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 94,
      "pull_request_review_id" : 938966769,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/848018690/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-12T06:27:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/848018690",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r848490431"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/848490431"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> it's just not the one this codebase has adopted\r\n\r\n@ajtowns I encourage you to take a look at the entire `src/interfaces` and `src/node` subtrees. Pretty much all of the multiprocess code (and increasingly some validation code) has been using this convention for years.",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-04-12T14:14:58Z",
      "diff_hunk" : "@@ -4984,3 +5029,33 @@ void ChainstateManager::MaybeRebalanceCaches()\n         }\n     }\n }\n+\n+CBlockIndex* ChainstateManager::getSnapshotBaseBlock()\n+{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r848490431",
      "id" : 848490431,
      "in_reply_to_id" : 797105983,
      "line" : 5034,
      "node_id" : "PRRC_kwDOABII584yku-_",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 5034,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 94,
      "pull_request_review_id" : 939626155,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/848490431/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-12T14:14:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/848490431",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r848515694"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/848515694"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If there's agreement on this style, it would be helpful and save developer time to update the developer notes.",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-04-12T14:36:53Z",
      "diff_hunk" : "@@ -4984,3 +5029,33 @@ void ChainstateManager::MaybeRebalanceCaches()\n         }\n     }\n }\n+\n+CBlockIndex* ChainstateManager::getSnapshotBaseBlock()\n+{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r848515694",
      "id" : 848515694,
      "in_reply_to_id" : 797105983,
      "line" : 5034,
      "node_id" : "PRRC_kwDOABII584yk1Ju",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 5034,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 94,
      "pull_request_review_id" : 939662822,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/848515694/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-12T14:36:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/848515694",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r848582465"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/848582465"
         }
      },
      "author_association" : "MEMBER",
      "body" : "@jonatack agree, but previous attempts have been rejected and locked (?): https://github.com/bitcoin/bitcoin/pull/14635#issuecomment-492796314",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-04-12T15:36:08Z",
      "diff_hunk" : "@@ -4984,3 +5029,33 @@ void ChainstateManager::MaybeRebalanceCaches()\n         }\n     }\n }\n+\n+CBlockIndex* ChainstateManager::getSnapshotBaseBlock()\n+{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r848582465",
      "id" : 848582465,
      "in_reply_to_id" : 797105983,
      "line" : 5034,
      "node_id" : "PRRC_kwDOABII584ylFdB",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 5034,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 94,
      "pull_request_review_id" : 939758507,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/848582465/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-12T15:36:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/848582465",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r848695416"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/848695416"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "If I look through the existing codebase, and model my new code on that rather than the developer notes, I'll be using hungarian notation, just as satoshi intended. Suggesting an alternative convention is fine, but if it gets rejected, you don't just keep on using it anyway.",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-04-12T17:38:21Z",
      "diff_hunk" : "@@ -4984,3 +5029,33 @@ void ChainstateManager::MaybeRebalanceCaches()\n         }\n     }\n }\n+\n+CBlockIndex* ChainstateManager::getSnapshotBaseBlock()\n+{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r848695416",
      "id" : 848695416,
      "in_reply_to_id" : 797105983,
      "line" : 5034,
      "node_id" : "PRRC_kwDOABII584ylhB4",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 5034,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 94,
      "pull_request_review_id" : 939919431,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/848695416/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-12T17:38:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/848695416",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r852237486"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852237486"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "For the sake of progress here it seems like it would be better to change these methods back to the Uppercase for now and keep that discussion seperate in #24846.",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-04-18T16:26:32Z",
      "diff_hunk" : "@@ -4984,3 +5029,33 @@ void ChainstateManager::MaybeRebalanceCaches()\n         }\n     }\n }\n+\n+CBlockIndex* ChainstateManager::getSnapshotBaseBlock()\n+{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r852237486",
      "id" : 852237486,
      "in_reply_to_id" : 797105983,
      "line" : 5034,
      "node_id" : "PRRC_kwDOABII584yzByu",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 5034,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 94,
      "pull_request_review_id" : 944575785,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852237486/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-18T17:18:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852237486",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r852240540"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852240540"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Did you consider making the interface of the two methods consistent and `getSnapshotBaseBlock` return an optional as well?",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-04-18T16:31:19Z",
      "diff_hunk" : "@@ -4984,3 +5029,33 @@ void ChainstateManager::MaybeRebalanceCaches()\n         }\n     }\n }\n+\n+CBlockIndex* ChainstateManager::getSnapshotBaseBlock()\n+{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r852240540",
      "id" : 852240540,
      "in_reply_to_id" : 797105983,
      "line" : 5034,
      "node_id" : "PRRC_kwDOABII584yzCic",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 5034,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 94,
      "pull_request_review_id" : 944575785,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852240540/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-18T17:18:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852240540",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r852263118"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852263118"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "+1",
      "commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "created_at" : "2022-04-18T17:06:42Z",
      "diff_hunk" : "@@ -987,6 +987,23 @@ class ChainstateManager\n     //! ResizeCoinsCaches() as needed.\n     void MaybeRebalanceCaches() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! Returns true if any chainstate in use is in initial block download.\n+    bool IsAnyChainInIBD() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    //! @returns the chainstate that indexers should consult when ensuring that an\n+    //!   index is synced with a chain where we can expect block index entries to have\n+    //!   BLOCK_HAVE_DATA beneath the tip.\n+    //!\n+    //!   In other words, give us the chainstate for which we can reasonably expect\n+    //!   that all blocks beneath the tip have been indexed. In practice this means\n+    //!   when using an assumed-valid chainstate based upon a snapshot, return only the\n+    //!   fully validated chain.\n+    CChainState& getChainstateForIndexing() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    //! @returns true if we have more than one chainstate in use. This means that a\n+    //! background validation chainstate is running.\n+    bool hasBgChainstateInUse();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r852263118",
      "id" : 852263118,
      "in_reply_to_id" : 831533853,
      "line" : 1005,
      "node_id" : "PRRC_kwDOABII584yzIDO",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 1005,
      "original_position" : 19,
      "original_start_line" : 993,
      "path" : "src/validation.h",
      "position" : 19,
      "pull_request_review_id" : 944575785,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852263118/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 993,
      "start_side" : "RIGHT",
      "updated_at" : "2022-04-18T17:18:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/852263118",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-04-28T10:53:00Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#issuecomment-1112062268",
      "id" : 1112062268,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24008",
      "node_id" : "IC_kwDOABII585CSLk8",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1112062268/reactions"
      },
      "updated_at" : "2022-04-28T10:53:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1112062268",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for all the feedback so far; I'll get around to fixing this up in the next day or so after I get #24232 in order.",
      "created_at" : "2022-04-28T11:53:23Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#issuecomment-1112111998",
      "id" : 1112111998,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24008",
      "node_id" : "IC_kwDOABII585CSXt-",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1112111998/reactions"
      },
      "updated_at" : "2022-04-28T11:53:23Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1112111998",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r862185596"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862185596"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point; I've added some commentary to the other uses of IsInitialBlockDownload().",
      "commit_id" : "2c7595a6f727544ce87e7caa2ef10e05232358a7",
      "created_at" : "2022-04-29T21:42:27Z",
      "diff_hunk" : "@@ -3231,7 +3234,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n \n         LOCK(cs_main);\n-        if (m_chainman.ActiveChainstate().IsInitialBlockDownload() && !pfrom.HasPermission(NetPermissionFlags::Download)) {\n+        if (m_chainman.IsAnyChainInIBD() && !pfrom.HasPermission(NetPermissionFlags::Download)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r862185596",
      "id" : 862185596,
      "in_reply_to_id" : 831542382,
      "line" : 3331,
      "node_id" : "PRRC_kwDOABII584zY-h8",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 3331,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 230,
      "pull_request_review_id" : 958298033,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862185596/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-29T21:58:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862185596",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r862188708"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862188708"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "2c7595a6f727544ce87e7caa2ef10e05232358a7",
      "created_at" : "2022-04-29T21:48:28Z",
      "diff_hunk" : "@@ -822,6 +822,10 @@ class ChainstateManager\n         CBlockIndex** ppindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n     friend CChainState;\n \n+    // Returns nullptr if no snapshot ahs been loaded.\n+    CBlockIndex* getSnapshotBaseBlock() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+    std::optional<int> getSnapshotHeight() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r862188708",
      "id" : 862188708,
      "in_reply_to_id" : 831501460,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584zY_Sk",
      "original_commit_id" : "17906dd52543fb75d2c45de884799b35ec5721f4",
      "original_line" : 827,
      "original_position" : 6,
      "original_start_line" : 826,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 958298033,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862188708/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-04-29T21:58:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862188708",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r862191203"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862191203"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Relented on all counts here.",
      "commit_id" : "2c7595a6f727544ce87e7caa2ef10e05232358a7",
      "created_at" : "2022-04-29T21:51:31Z",
      "diff_hunk" : "@@ -4984,3 +5029,33 @@ void ChainstateManager::MaybeRebalanceCaches()\n         }\n     }\n }\n+\n+CBlockIndex* ChainstateManager::getSnapshotBaseBlock()\n+{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r862191203",
      "id" : 862191203,
      "in_reply_to_id" : 797105983,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584zY_5j",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 5254,
      "original_position" : 94,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 958298033,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862191203/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-29T21:58:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862191203",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r862191338"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862191338"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "2c7595a6f727544ce87e7caa2ef10e05232358a7",
      "created_at" : "2022-04-29T21:51:45Z",
      "diff_hunk" : "@@ -3603,6 +3603,12 @@ bool ChainstateManager::ProcessNewBlock(const CChainParams& chainparams, const s\n {\n     AssertLockNotHeld(cs_main);\n \n+    CChainState* chainstate;\n+    {\n+        LOCK(cs_main);\n+        chainstate = &this->GetChainstateForNewBlock(block->GetHash());\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r862191338",
      "id" : 862191338,
      "in_reply_to_id" : 797169841,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584zY_7q",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 3610,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 958298033,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862191338/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-29T21:58:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862191338",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r862193503"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862193503"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "2c7595a6f727544ce87e7caa2ef10e05232358a7",
      "created_at" : "2022-04-29T21:55:13Z",
      "diff_hunk" : "@@ -4921,6 +4951,21 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+CChainState& ChainstateManager::GetChainstateForNewBlock(const uint256& blockhash)\n+{\n+    auto* pblock = m_blockman.LookupBlockIndex(blockhash);\n+    if (m_snapshot_chainstate &&\n+            // If pblock is null, we haven't seen the header for this block.\n+            // Because we expect to have received the headers for the IBD chain\n+            // contents before receiving blocks, this means that any block for\n+            // which we don't have headers should go in the snapshot chain.\n+            (pblock == nullptr || !m_snapshot_chainstate->m_chain.Contains(pblock))) {\n+        return *m_snapshot_chainstate.get();\n+    }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r862193503",
      "id" : 862193503,
      "in_reply_to_id" : 797166061,
      "line" : 5204,
      "node_id" : "PRRC_kwDOABII584zZAdf",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 5204,
      "original_position" : 80,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 78,
      "pull_request_review_id" : 958298033,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862193503/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-29T21:58:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862193503",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r862193784"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862193784"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "2c7595a6f727544ce87e7caa2ef10e05232358a7",
      "created_at" : "2022-04-29T21:55:35Z",
      "diff_hunk" : "@@ -3620,18 +3626,21 @@ bool ChainstateManager::ProcessNewBlock(const CChainParams& chainparams, const s\n         bool ret = CheckBlock(*block, state, chainparams.GetConsensus());\n         if (ret) {\n             // Store to disk\n-            ret = ActiveChainstate().AcceptBlock(block, state, &pindex, force_processing, nullptr, new_block);\n+            ret = chainstate->AcceptBlock(\n+                block, state, &pindex, force_processing, nullptr, new_block);\n         }\n         if (!ret) {\n             GetMainSignals().BlockChecked(*block, state);\n             return error(\"%s: AcceptBlock FAILED (%s)\", __func__, state.ToString());\n         }\n     }\n \n-    NotifyHeaderTip(ActiveChainstate());\n+    if (WITH_LOCK(::cs_main, return chainstate == &this->ActiveChainstate())) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r862193784",
      "id" : 862193784,
      "in_reply_to_id" : 801024687,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584zZAh4",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 3638,
      "original_position" : 28,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 958298033,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862193784/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-29T21:58:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862193784",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r862195583"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862195583"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "2c7595a6f727544ce87e7caa2ef10e05232358a7",
      "created_at" : "2022-04-29T21:58:10Z",
      "diff_hunk" : "@@ -4596,6 +4605,27 @@ std::vector<CChainState*> ChainstateManager::GetAll()\n     return out;\n }\n \n+std::vector<CChainState*> ChainstateManager::GetAllForBlockDownload()\n+{\n+    std::vector<CChainState*> out;\n+\n+    bool snapshot_in_ibd =\n+        m_snapshot_chainstate && m_snapshot_chainstate->IsInitialBlockDownload();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r862195583",
      "id" : 862195583,
      "in_reply_to_id" : 801031354,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584zZA9_",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 4613,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 958298033,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862195583/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-29T21:58:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862195583",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r862195631"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862195631"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "2c7595a6f727544ce87e7caa2ef10e05232358a7",
      "created_at" : "2022-04-29T21:58:16Z",
      "diff_hunk" : "@@ -4596,6 +4605,27 @@ std::vector<CChainState*> ChainstateManager::GetAll()\n     return out;\n }\n \n+std::vector<CChainState*> ChainstateManager::GetAllForBlockDownload()\n+{",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r862195631",
      "id" : 862195631,
      "in_reply_to_id" : 801030242,
      "line" : 4846,
      "node_id" : "PRRC_kwDOABII584zZA-v",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 4846,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 39,
      "pull_request_review_id" : 958298033,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862195631/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-29T21:58:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862195631",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r862196865"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862196865"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good catch, not sure what happened here. Too many assumeutxo commits getting shuffled around.",
      "commit_id" : "2c7595a6f727544ce87e7caa2ef10e05232358a7",
      "created_at" : "2022-04-29T22:00:19Z",
      "diff_hunk" : "@@ -987,6 +987,23 @@ class ChainstateManager\n     //! ResizeCoinsCaches() as needed.\n     void MaybeRebalanceCaches() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! Returns true if any chainstate in use is in initial block download.\n+    bool IsAnyChainInIBD() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    //! @returns the chainstate that indexers should consult when ensuring that an\n+    //!   index is synced with a chain where we can expect block index entries to have\n+    //!   BLOCK_HAVE_DATA beneath the tip.\n+    //!\n+    //!   In other words, give us the chainstate for which we can reasonably expect\n+    //!   that all blocks beneath the tip have been indexed. In practice this means\n+    //!   when using an assumed-valid chainstate based upon a snapshot, return only the\n+    //!   fully validated chain.\n+    CChainState& getChainstateForIndexing() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+\n+    //! @returns true if we have more than one chainstate in use. This means that a\n+    //! background validation chainstate is running.\n+    bool hasBgChainstateInUse();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r862196865",
      "id" : 862196865,
      "in_reply_to_id" : 831533853,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584zZBSB",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 1005,
      "original_position" : 19,
      "original_start_line" : 993,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 958313747,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862196865/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2022-04-29T22:00:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862196865",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r862248090"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862248090"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Missed an uppercase here it seems.",
      "commit_id" : "2c7595a6f727544ce87e7caa2ef10e05232358a7",
      "created_at" : "2022-04-29T22:55:04Z",
      "diff_hunk" : "@@ -5218,3 +5261,35 @@ ChainstateManager::~ChainstateManager()\n         i.clear();\n     }\n }\n+\n+std::optional<const CBlockIndex> ChainstateManager::GetSnapshotBaseBlock() const\n+{\n+    AssertLockHeld(::cs_main);\n+    const auto blockhash_op{this->SnapshotBlockhash()};\n+    if (!blockhash_op) return {};\n+    const CBlockIndex* found = m_blockman.LookupBlockIndex(*blockhash_op);\n+\n+    if (found) {\n+        return *found;\n+    }\n+    return {};\n+}\n+\n+std::optional<int> ChainstateManager::GetSnapshotBaseHeight() const\n+{\n+    AssertLockHeld(::cs_main);\n+    auto base{this->GetSnapshotBaseBlock()};\n+    return base ? std::make_optional(base->nHeight) : std::nullopt;\n+}\n+\n+CChainState& ChainstateManager::getChainstateForIndexing()\n+{\n+    return getSnapshotBaseBlock() ? *m_ibd_chainstate : *m_active_chainstate;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r862248090",
      "id" : 862248090,
      "line" : 5287,
      "node_id" : "PRRC_kwDOABII584zZNya",
      "original_commit_id" : "2c7595a6f727544ce87e7caa2ef10e05232358a7",
      "original_line" : 5287,
      "original_position" : 113,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 113,
      "pull_request_review_id" : 958380230,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862248090/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-04-29T22:55:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/862248090",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-04-30T11:02:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#issuecomment-1113968371",
      "id" : 1113968371,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24008",
      "node_id" : "IC_kwDOABII585CZc7z",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1113968371/reactions"
      },
      "updated_at" : "2022-04-30T11:02:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1113968371",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r863006004"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/863006004"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ah, thanks.",
      "commit_id" : "bd25cf319c6710c7b772080d2a49f86ce50d829a",
      "created_at" : "2022-05-02T16:45:07Z",
      "diff_hunk" : "@@ -5218,3 +5261,35 @@ ChainstateManager::~ChainstateManager()\n         i.clear();\n     }\n }\n+\n+std::optional<const CBlockIndex> ChainstateManager::GetSnapshotBaseBlock() const\n+{\n+    AssertLockHeld(::cs_main);\n+    const auto blockhash_op{this->SnapshotBlockhash()};\n+    if (!blockhash_op) return {};\n+    const CBlockIndex* found = m_blockman.LookupBlockIndex(*blockhash_op);\n+\n+    if (found) {\n+        return *found;\n+    }\n+    return {};\n+}\n+\n+std::optional<int> ChainstateManager::GetSnapshotBaseHeight() const\n+{\n+    AssertLockHeld(::cs_main);\n+    auto base{this->GetSnapshotBaseBlock()};\n+    return base ? std::make_optional(base->nHeight) : std::nullopt;\n+}\n+\n+CChainState& ChainstateManager::getChainstateForIndexing()\n+{\n+    return getSnapshotBaseBlock() ? *m_ibd_chainstate : *m_active_chainstate;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r863006004",
      "id" : 863006004,
      "in_reply_to_id" : 862248090,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584zcG00",
      "original_commit_id" : "2c7595a6f727544ce87e7caa2ef10e05232358a7",
      "original_line" : 5287,
      "original_position" : 113,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 959297850,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/863006004/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-05-02T16:45:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/863006004",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-05-13T07:39:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#issuecomment-1125750498",
      "id" : 1125750498,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24008",
      "node_id" : "IC_kwDOABII585DGZbi",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1125750498/reactions"
      },
      "updated_at" : "2022-05-13T07:39:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1125750498",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-05-31T10:21:06Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#issuecomment-1141949598",
      "id" : 1141949598,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24008",
      "node_id" : "IC_kwDOABII585EEMSe",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1141949598/reactions"
      },
      "updated_at" : "2022-05-31T10:21:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1141949598",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-06-02T20:47:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#issuecomment-1145326809",
      "id" : 1145326809,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24008",
      "node_id" : "IC_kwDOABII585EREzZ",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1145326809/reactions"
      },
      "updated_at" : "2022-06-02T20:47:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1145326809",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r888466699"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/888466699"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This makes a copy of the CBlockIndex rather than returning a pointer to the existing one?",
      "commit_id" : "df44c76cdb637d3aa5b6807163f014137b381918",
      "created_at" : "2022-06-02T22:44:41Z",
      "diff_hunk" : "@@ -5225,3 +5268,30 @@ ChainstateManager::~ChainstateManager()\n         i.clear();\n     }\n }\n+\n+std::optional<const CBlockIndex> ChainstateManager::GetSnapshotBaseBlock() const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r888466699",
      "id" : 888466699,
      "line" : 5272,
      "node_id" : "PRRC_kwDOABII58409O0L",
      "original_commit_id" : "df44c76cdb637d3aa5b6807163f014137b381918",
      "original_line" : 5272,
      "original_position" : 91,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 91,
      "pull_request_review_id" : 994264356,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/888466699/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-02T23:20:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/888466699",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r888474234"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/888474234"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Having a one or two element map for every peer seems a bit icky.\r\n\r\nIs this even necessary though? If you have a common snapshot block, then your common IBD block will be whatever your IBD tip is, no? And if you do have a snapshot block, but don't have a common snapshot block with this peer, don't you want to disconnect?\r\n\r\nI guess I'm suggesting replacing this by a `CBlockIndex*` to trace the last common block, and a `bool is_last_common_block_from_snapshot`?",
      "commit_id" : "df44c76cdb637d3aa5b6807163f014137b381918",
      "created_at" : "2022-06-02T23:00:58Z",
      "diff_hunk" : "@@ -380,8 +380,18 @@ struct CNodeState {\n     const CBlockIndex* pindexBestKnownBlock{nullptr};\n     //! The hash of the last unknown block this peer has announced.\n     uint256 hashLastUnknownBlock{};\n-    //! The last full block we both have.\n-    const CBlockIndex* pindexLastCommonBlock{nullptr};\n+\n+    //! The last full block we both have (per chainstate).\n+    //!\n+    //! This is namespaced by chainstate to allow syncing two separate chainstates\n+    //! simultaneously from a single peer.\n+    //!\n+    //! Nota bene: this is contingent on the ChainstateManager not destructing\n+    //! any CChainState objects which were in use at any point (e.g. a background\n+    //! validation chainstate which has completed) until the end of\n+    //! init.cpp:Shutdown(), else we'll have bad pointers here.\n+    std::map<const CChainState*, const CBlockIndex*> chainstate_to_last_common_block = {};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r888474234",
      "id" : 888474234,
      "line" : 393,
      "node_id" : "PRRC_kwDOABII58409Qp6",
      "original_commit_id" : "56cae81ed7fe59170a4413444d509e1a3c7b132d",
      "original_line" : 393,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 16,
      "pull_request_review_id" : 994264356,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/888474234/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-02T23:20:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/888474234",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r888476401"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/888476401"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`x[k]` for a map [isn't undefined behaviour](https://en.cppreference.com/w/cpp/container/map/operator_at), it creates the entry (setting it to nullptr here), then the `=` replaces it. `insert_or_assign(chainstate, our_chain[blah])` would arguably be better I guess.",
      "commit_id" : "df44c76cdb637d3aa5b6807163f014137b381918",
      "created_at" : "2022-06-02T23:06:14Z",
      "diff_hunk" : "@@ -1014,32 +1039,45 @@ void PeerManagerImpl::FindNextBlocksToDownload(NodeId nodeid, unsigned int count\n     // Make sure pindexBestKnownBlock is up to date, we'll need it.\n     ProcessBlockAvailability(nodeid);\n \n-    if (state->pindexBestKnownBlock == nullptr || state->pindexBestKnownBlock->nChainWork < m_chainman.ActiveChain().Tip()->nChainWork || state->pindexBestKnownBlock->nChainWork < nMinimumChainWork) {\n+    const CChain& our_chain = chainstate->m_chain;\n+    const CBlockIndex* our_tip = our_chain.Tip();\n+\n+    if (state->pindexBestKnownBlock == nullptr\n+            || state->pindexBestKnownBlock->nChainWork < our_tip->nChainWork\n+            || state->pindexBestKnownBlock->nChainWork < nMinimumChainWork) {\n         // This peer has nothing interesting.\n         return;\n     }\n \n-    if (state->pindexLastCommonBlock == nullptr) {\n+    if (!state->chainstate_to_last_common_block.count(chainstate)) {\n         // Bootstrap quickly by guessing a parent of our best tip is the forking point.\n         // Guessing wrong in either direction is not a problem.\n-        state->pindexLastCommonBlock = m_chainman.ActiveChain()[std::min(state->pindexBestKnownBlock->nHeight, m_chainman.ActiveChain().Height())];\n+        //\n+        // Namespace this by chainstate so that we can simultaneously sync two\n+        // separate chainstates at different heights.\n+        state->chainstate_to_last_common_block[chainstate] = our_chain[",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r888476401",
      "id" : 888476401,
      "in_reply_to_id" : 801058811,
      "line" : 1175,
      "node_id" : "PRRC_kwDOABII58409RLx",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 1175,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 89,
      "pull_request_review_id" : 994264356,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/888476401/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-02T23:20:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/888476401",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r888478773"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/888478773"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Seems weird not to take the lock in the function, rather than have every caller invoke it as `WITH_LOCK(cs_main, ...)`",
      "commit_id" : "df44c76cdb637d3aa5b6807163f014137b381918",
      "created_at" : "2022-06-02T23:12:18Z",
      "diff_hunk" : "@@ -5288,3 +5288,10 @@ std::optional<int> ChainstateManager::GetSnapshotBaseHeight() const\n     auto base{this->GetSnapshotBaseBlock()};\n     return base ? std::make_optional(base->nHeight) : std::nullopt;\n }\n+\n+bool ChainstateManager::IsAnyChainInIBD()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r888478773",
      "id" : 888478773,
      "line" : 5292,
      "node_id" : "PRRC_kwDOABII58409Rw1",
      "original_commit_id" : "f61f80a043cb0e9fb336ee2098f10302742aa2e3",
      "original_line" : 5292,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 5,
      "pull_request_review_id" : 994264356,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/888478773/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-02T23:20:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/888478773",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r888480307"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/888480307"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not entirely clear to me that this (\"Until we have completed IBD on all chainstates, don't answer getheaders requests from our peers or advertise ourselves.\") is a good idea? If you've caught up on the snapshot chain, is the fact that you got there via assumeutxo any worse than getting there via assumevalid? No objection to keeping it purely for \"first, do no harm\" reasons, but if we're already confident there's no harm possible, better to have more nodes sharing headers etc, than less.",
      "commit_id" : "df44c76cdb637d3aa5b6807163f014137b381918",
      "created_at" : "2022-06-02T23:16:22Z",
      "diff_hunk" : "@@ -1038,6 +1038,9 @@ class ChainstateManager\n     /** Produce the necessary coinbase commitment for a block (modifies the hash, don't call for mined blocks). */\n     std::vector<unsigned char> GenerateCoinbaseCommitment(CBlock& block, const CBlockIndex* pindexPrev) const;\n \n+    //! Returns true if any chainstate in use is in initial block download.\n+    bool IsAnyChainInIBD() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r888480307",
      "id" : 888480307,
      "line" : 1042,
      "node_id" : "PRRC_kwDOABII58409SIz",
      "original_commit_id" : "f61f80a043cb0e9fb336ee2098f10302742aa2e3",
      "original_line" : 1042,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 5,
      "pull_request_review_id" : 994264356,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/888480307/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-02T23:20:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/888480307",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r891686321"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/891686321"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Having a one or two element map for every peer seems a bit icky.\r\n\r\nHow come? Aren't the number of peers (in the hundreds at the most, by default ~10?) going to make the memory consumption of this data structure negligible?\r\n\r\n> I guess I'm suggesting replacing this by a CBlockIndex* to trace the last common block, and a bool is_last_common_block_from_snapshot?\r\n\r\nThe consensus has been that we want as few parts of the system as possible knowing about \"snapshots\" per se. The current approach also has the advantage that if we were ever to further parallelize validation with more than one background validation chainstate, we could keep this structure. \r\n\r\nI think this suggestion also makes end usage of this data more complicated, because we have to articulate the logic you spell out above within usages. I don't think the memory parsimony justifies the added complexity.",
      "commit_id" : "a4ff597d34bc003d839a201f52114275281e1f78",
      "created_at" : "2022-06-07T20:35:19Z",
      "diff_hunk" : "@@ -380,8 +380,18 @@ struct CNodeState {\n     const CBlockIndex* pindexBestKnownBlock{nullptr};\n     //! The hash of the last unknown block this peer has announced.\n     uint256 hashLastUnknownBlock{};\n-    //! The last full block we both have.\n-    const CBlockIndex* pindexLastCommonBlock{nullptr};\n+\n+    //! The last full block we both have (per chainstate).\n+    //!\n+    //! This is namespaced by chainstate to allow syncing two separate chainstates\n+    //! simultaneously from a single peer.\n+    //!\n+    //! Nota bene: this is contingent on the ChainstateManager not destructing\n+    //! any CChainState objects which were in use at any point (e.g. a background\n+    //! validation chainstate which has completed) until the end of\n+    //! init.cpp:Shutdown(), else we'll have bad pointers here.\n+    std::map<const CChainState*, const CBlockIndex*> chainstate_to_last_common_block = {};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r891686321",
      "id" : 891686321,
      "in_reply_to_id" : 888474234,
      "line" : 394,
      "node_id" : "PRRC_kwDOABII5841Jg2x",
      "original_commit_id" : "56cae81ed7fe59170a4413444d509e1a3c7b132d",
      "original_line" : 394,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 16,
      "pull_request_review_id" : 998813279,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/891686321/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-07T21:40:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/891686321",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r891688836"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/891688836"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agree that this isn't UB; not going to address unless there is an observable benefit.",
      "commit_id" : "a4ff597d34bc003d839a201f52114275281e1f78",
      "created_at" : "2022-06-07T20:38:36Z",
      "diff_hunk" : "@@ -1014,32 +1039,45 @@ void PeerManagerImpl::FindNextBlocksToDownload(NodeId nodeid, unsigned int count\n     // Make sure pindexBestKnownBlock is up to date, we'll need it.\n     ProcessBlockAvailability(nodeid);\n \n-    if (state->pindexBestKnownBlock == nullptr || state->pindexBestKnownBlock->nChainWork < m_chainman.ActiveChain().Tip()->nChainWork || state->pindexBestKnownBlock->nChainWork < nMinimumChainWork) {\n+    const CChain& our_chain = chainstate->m_chain;\n+    const CBlockIndex* our_tip = our_chain.Tip();\n+\n+    if (state->pindexBestKnownBlock == nullptr\n+            || state->pindexBestKnownBlock->nChainWork < our_tip->nChainWork\n+            || state->pindexBestKnownBlock->nChainWork < nMinimumChainWork) {\n         // This peer has nothing interesting.\n         return;\n     }\n \n-    if (state->pindexLastCommonBlock == nullptr) {\n+    if (!state->chainstate_to_last_common_block.count(chainstate)) {\n         // Bootstrap quickly by guessing a parent of our best tip is the forking point.\n         // Guessing wrong in either direction is not a problem.\n-        state->pindexLastCommonBlock = m_chainman.ActiveChain()[std::min(state->pindexBestKnownBlock->nHeight, m_chainman.ActiveChain().Height())];\n+        //\n+        // Namespace this by chainstate so that we can simultaneously sync two\n+        // separate chainstates at different heights.\n+        state->chainstate_to_last_common_block[chainstate] = our_chain[",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r891688836",
      "id" : 891688836,
      "in_reply_to_id" : 801058811,
      "line" : 1176,
      "node_id" : "PRRC_kwDOABII5841JheE",
      "original_commit_id" : "c4d90167f030547373715a44fc020d0da8461565",
      "original_line" : 1176,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 89,
      "pull_request_review_id" : 998813279,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/891688836/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-07T21:40:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/891688836",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r891689931"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/891689931"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Copy here doesn't seem like a big deal; smallish data structures and this function is (and always will be) called pretty sparingly. Plus, copy means we don't have to worry about the lifetime of the underlying CBlockIndex reference.",
      "commit_id" : "a4ff597d34bc003d839a201f52114275281e1f78",
      "created_at" : "2022-06-07T20:40:04Z",
      "diff_hunk" : "@@ -5225,3 +5268,30 @@ ChainstateManager::~ChainstateManager()\n         i.clear();\n     }\n }\n+\n+std::optional<const CBlockIndex> ChainstateManager::GetSnapshotBaseBlock() const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r891689931",
      "id" : 891689931,
      "in_reply_to_id" : 888466699,
      "line" : 5270,
      "node_id" : "PRRC_kwDOABII5841JhvL",
      "original_commit_id" : "df44c76cdb637d3aa5b6807163f014137b381918",
      "original_line" : 5270,
      "original_position" : 91,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 91,
      "pull_request_review_id" : 998813279,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/891689931/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-07T21:40:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/891689931",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r891690511"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/891690511"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I thought that generally we preferred lock annotations to inline locking for short functions like these to avoid recursive acquisitions.",
      "commit_id" : "a4ff597d34bc003d839a201f52114275281e1f78",
      "created_at" : "2022-06-07T20:40:53Z",
      "diff_hunk" : "@@ -5288,3 +5288,10 @@ std::optional<int> ChainstateManager::GetSnapshotBaseHeight() const\n     auto base{this->GetSnapshotBaseBlock()};\n     return base ? std::make_optional(base->nHeight) : std::nullopt;\n }\n+\n+bool ChainstateManager::IsAnyChainInIBD()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r891690511",
      "id" : 891690511,
      "in_reply_to_id" : 888478773,
      "line" : 5290,
      "node_id" : "PRRC_kwDOABII5841Jh4P",
      "original_commit_id" : "f61f80a043cb0e9fb336ee2098f10302742aa2e3",
      "original_line" : 5290,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 111,
      "pull_request_review_id" : 998813279,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/891690511/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-07T21:40:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/891690511",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r891731127"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/891731127"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good observation. I definitely agree that we should still be answering getheaders requests, which I think we are per this code: https://github.com/jamesob/bitcoin/blob/39ddd522c37f760c8054d2fa58e026c69a50ce8b/src/net_processing.cpp#L3292-L3321. In terms of advertising ourselves while background-validating, I'll remain conservative in this changeset and defer to others... should be a pretty easy follow-up if deemed safe, and it'd allow someone besides me to make assumeutxo-related changes :).",
      "commit_id" : "a4ff597d34bc003d839a201f52114275281e1f78",
      "created_at" : "2022-06-07T21:38:32Z",
      "diff_hunk" : "@@ -1038,6 +1038,9 @@ class ChainstateManager\n     /** Produce the necessary coinbase commitment for a block (modifies the hash, don't call for mined blocks). */\n     std::vector<unsigned char> GenerateCoinbaseCommitment(CBlock& block, const CBlockIndex* pindexPrev) const;\n \n+    //! Returns true if any chainstate in use is in initial block download.\n+    bool IsAnyChainInIBD() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r891731127",
      "id" : 891731127,
      "in_reply_to_id" : 888480307,
      "line" : 1038,
      "node_id" : "PRRC_kwDOABII5841Jry3",
      "original_commit_id" : "f61f80a043cb0e9fb336ee2098f10302742aa2e3",
      "original_line" : 1038,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 49,
      "pull_request_review_id" : 998813279,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/891731127/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-07T21:40:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/891731127",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r891949166"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/891949166"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This seems dangerous. There are many places in the code base where raw pointers are compared to check CBlockIndex equality. Creating a copy will change the raw pointer and make two \"identical\" CBlockIndex appear different.\r\n\r\nAlso copying a CBlockIndex does not extend its lifetime. It has a pprev member, that will be deleted as well.\r\n\r\nIf someone has an easy patch to `=delete` the copy constructor, I'd be looking forward to review.\r\n\r\n\r\n(If you really want to refer to a block after the lifetime of the CBlockIndex, for whatever reason, you could return the hash of the block)",
      "commit_id" : "a4ff597d34bc003d839a201f52114275281e1f78",
      "created_at" : "2022-06-08T05:59:51Z",
      "diff_hunk" : "@@ -5225,3 +5268,30 @@ ChainstateManager::~ChainstateManager()\n         i.clear();\n     }\n }\n+\n+std::optional<const CBlockIndex> ChainstateManager::GetSnapshotBaseBlock() const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r891949166",
      "id" : 891949166,
      "in_reply_to_id" : 888466699,
      "line" : 5270,
      "node_id" : "PRRC_kwDOABII5841KhBu",
      "original_commit_id" : "df44c76cdb637d3aa5b6807163f014137b381918",
      "original_line" : 5270,
      "original_position" : 91,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 91,
      "pull_request_review_id" : 999156385,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/891949166/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-08T05:59:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/891949166",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r892424673"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/892424673"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good points, I should think harder. Fixed and pushed.",
      "commit_id" : "54d04d1f09bfbc933b06e74ece325bf05e838848",
      "created_at" : "2022-06-08T14:03:01Z",
      "diff_hunk" : "@@ -5225,3 +5268,30 @@ ChainstateManager::~ChainstateManager()\n         i.clear();\n     }\n }\n+\n+std::optional<const CBlockIndex> ChainstateManager::GetSnapshotBaseBlock() const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r892424673",
      "id" : 892424673,
      "in_reply_to_id" : 888466699,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5841MVHh",
      "original_commit_id" : "df44c76cdb637d3aa5b6807163f014137b381918",
      "original_line" : 5270,
      "original_position" : 91,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 999820980,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/892424673/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-08T14:03:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/892424673",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r892580801"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/892580801"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> If someone has an easy patch to =delete the copy constructor, I'd be looking forward to review.\r\n\r\nAdded in https://github.com/bitcoin/bitcoin/pull/25311.",
      "commit_id" : "54d04d1f09bfbc933b06e74ece325bf05e838848",
      "created_at" : "2022-06-08T16:11:38Z",
      "diff_hunk" : "@@ -5225,3 +5268,30 @@ ChainstateManager::~ChainstateManager()\n         i.clear();\n     }\n }\n+\n+std::optional<const CBlockIndex> ChainstateManager::GetSnapshotBaseBlock() const",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r892580801",
      "id" : 892580801,
      "in_reply_to_id" : 888466699,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5841M7PB",
      "original_commit_id" : "df44c76cdb637d3aa5b6807163f014137b381918",
      "original_line" : 5270,
      "original_position" : 91,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1000046674,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/892580801/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-08T16:11:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/892580801",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r895298321"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/895298321"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "> The consensus has been that we want as few parts of the system as possible knowing about \"snapshots\" per se.\r\n\r\nSure; but the map already means the code needs to know about snapshots per se.\r\n\r\n> if we were ever to further parallelize validation with more than one background validation chainstate, we could keep this structure.\r\n\r\nThat seems crazy to me; managing two utxo sets is already a lot of space, increasing that is costly, and I don't think validating the chain at many points would help with any bottlenecks.\r\n\r\nBut you shouldn't even need the bool; the fact that the snapshots are all at different points in the same chain should let you just say: `last_common_block_for_this_chainstate = min(tip, last_common_block)` when picking where to start, and `if (last_common_block->nHeight < pindex->nHeight) last_common_block = pindex` when updating.\r\n\r\n<details>\r\n<summary>(click for suggestion)</summary>\r\n\r\n```diff\r\n--- a/src/net_processing.cpp\r\n+++ b/src/net_processing.cpp\r\n@@ -391,7 +391,7 @@ struct CNodeState {\r\n     //! any CChainState objects which were in use at any point (e.g. a background\r\n     //! validation chainstate which has completed) until the end of\r\n     //! init.cpp:Shutdown(), else we'll have bad pointers here.\r\n-    std::map<const CChainState*, const CBlockIndex*> chainstate_to_last_common_block = {};\r\n+    const CBlockIndex* last_common_block = nullptr;\r\n \r\n     //! The best header we have sent our peer.\r\n     const CBlockIndex* pindexBestHeaderSent{nullptr};\r\n@@ -757,7 +757,7 @@ private:\r\n \r\n     bool TipMayBeStale() EXCLUSIVE_LOCKS_REQUIRED(cs_main);\r\n \r\n-    /** Update chainstate_to_last_common_block and add not-in-flight missing successors\r\n+    /** Update last_common_block and add not-in-flight missing successors\r\n      * to vBlocks, until it has at most count entries.\r\n      */\r\n     void FindNextBlocksToDownload(\r\n@@ -1140,6 +1140,13 @@ void PeerManagerImpl::UpdateBlockAvailability(NodeId nodeid, const uint256 &hash\r\n     }\r\n }\r\n \r\n+static const CBlockIndex* GetLastCommonBlock(const CBlockIndex* tip, const CBlockIndex* last_common_block) EXCLUSIVE_LOCKS_REQUIRED(::cs_main)\r\n+{\r\n+    if (last_common_block == nullptr || tip == nullptr) return nullptr;\r\n+    if (tip->nHeight <= last_common_block->nHeight) return tip;\r\n+    return last_common_block;\r\n+}\r\n+\r\n void PeerManagerImpl::FindNextBlocksToDownload(\r\n     const CChainState* const chainstate,\r\n     NodeId nodeid,\r\n@@ -1167,27 +1174,22 @@ void PeerManagerImpl::FindNextBlocksToDownload(\r\n         return;\r\n     }\r\n \r\n-    if (!state->chainstate_to_last_common_block.count(chainstate)) {\r\n+    if (!state->last_common_block) {\r\n         // Bootstrap quickly by guessing a parent of our best tip is the forking point.\r\n         // Guessing wrong in either direction is not a problem.\r\n-        //\r\n-        // Namespace this by chainstate so that we can simultaneously sync two\r\n-        // separate chainstates at different heights.\r\n-        state->chainstate_to_last_common_block[chainstate] = our_chain[\r\n-            std::min(state->pindexBestKnownBlock->nHeight, our_chain.Height())];\r\n+        state->last_common_block = our_chain[std::min(state->pindexBestKnownBlock->nHeight, our_chain.Height())];\r\n     }\r\n \r\n     // If the peer reorganized, our previous chainstate_to_last_common_block may not be an ancestor\r\n     // of its current tip anymore. Go back enough to fix that.\r\n-    state->chainstate_to_last_common_block[chainstate] = LastCommonAncestor(\r\n-        state->chainstate_to_last_common_block[chainstate], state->pindexBestKnownBlock);\r\n+    state->last_common_block = LastCommonAncestor(state->last_common_block, state->pindexBestKnownBlock);\r\n \r\n-    if (state->chainstate_to_last_common_block[chainstate] == state->pindexBestKnownBlock) {\r\n+    if (state->last_common_block == state->pindexBestKnownBlock) {\r\n         return;\r\n     }\r\n \r\n     std::vector<const CBlockIndex*> vToFetch;\r\n-    const CBlockIndex *pindexWalk = state->chainstate_to_last_common_block[chainstate];\r\n+    const CBlockIndex* pindexWalk = GetLastCommonBlock(our_tip, state->last_common_block);\r\n     // Never fetch further than the best block we know the peer has, or more than BLOCK_DOWNLOAD_WINDOW + 1 beyond the last\r\n     // linked block we have in common with this peer. The +1 is so we can detect stalling, namely if we would be able to\r\n     // download that next block if the window were 1 larger.\r\n@@ -1209,7 +1211,7 @@ void PeerManagerImpl::FindNextBlocksToDownload(\r\n \r\n         // Iterate over those blocks in vToFetch (in forward direction), adding the ones that\r\n         // are not yet downloaded and not in flight to vBlocks. In the meantime, update\r\n-        // chainstate_to_last_common_block as long as all ancestors are already downloaded, or if it's\r\n+        // last_common_block as long as all ancestors are already downloaded, or if it's\r\n         // already part of our chain (and therefore don't need it even if pruned).\r\n         for (const CBlockIndex* pindex : vToFetch) {\r\n             if (!pindex->IsValid(BLOCK_VALID_TREE)) {\r\n@@ -1221,8 +1223,11 @@ void PeerManagerImpl::FindNextBlocksToDownload(\r\n                 return;\r\n             }\r\n             if (pindex->nStatus & BLOCK_HAVE_DATA || our_chain.Contains(pindex)) {\r\n-                if (pindex->HaveTxsDownloaded())\r\n-                    state->chainstate_to_last_common_block[chainstate] = pindex;\r\n+                if (pindex->HaveTxsDownloaded()) {\r\n+                    if (state->last_common_block == nullptr || pindex->nHeight > state->last_common_block->nHeight) {\r\n+                        state->last_common_block = pindex;\r\n+                    }\r\n+                }\r\n             } else if (!IsBlockRequested(pindex->GetBlockHash())) {\r\n                 // The block is not already downloaded, and not yet in flight.\r\n                 if (pindex->nHeight > nWindowEnd) {\r\n@@ -1434,13 +1439,8 @@ bool PeerManagerImpl::GetNodeStateStats(NodeId nodeid, CNodeStateStats& stats) c\r\n         stats.nSyncHeight = state->pindexBestKnownBlock ? state->pindexBestKnownBlock->nHeight : -1;\r\n         stats.nCommonHeight = -1;\r\n \r\n-        // Take the max common height with this peer across chainstates.\r\n-        for (const auto& it : state->chainstate_to_last_common_block) {\r\n-            const CBlockIndex* block = it.second;\r\n-            if (block && block->nHeight > stats.nCommonHeight) {\r\n-                stats.nCommonHeight = block->nHeight;\r\n-            }\r\n-        }\r\n+        if (state->last_common_block) stats.nCommonHeight = state->last_common_block->nHeight;\r\n+\r\n         for (const QueuedBlock& queue : state->vBlocksInFlight) {\r\n             if (queue.pindex)\r\n                 stats.vHeightInFlight.push_back(queue.pindex->nHeight);\r\n```\r\n</details>",
      "commit_id" : "54d04d1f09bfbc933b06e74ece325bf05e838848",
      "created_at" : "2022-06-13T03:23:15Z",
      "diff_hunk" : "@@ -380,8 +380,18 @@ struct CNodeState {\n     const CBlockIndex* pindexBestKnownBlock{nullptr};\n     //! The hash of the last unknown block this peer has announced.\n     uint256 hashLastUnknownBlock{};\n-    //! The last full block we both have.\n-    const CBlockIndex* pindexLastCommonBlock{nullptr};\n+\n+    //! The last full block we both have (per chainstate).\n+    //!\n+    //! This is namespaced by chainstate to allow syncing two separate chainstates\n+    //! simultaneously from a single peer.\n+    //!\n+    //! Nota bene: this is contingent on the ChainstateManager not destructing\n+    //! any CChainState objects which were in use at any point (e.g. a background\n+    //! validation chainstate which has completed) until the end of\n+    //! init.cpp:Shutdown(), else we'll have bad pointers here.\n+    std::map<const CChainState*, const CBlockIndex*> chainstate_to_last_common_block = {};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r895298321",
      "id" : 895298321,
      "in_reply_to_id" : 888474234,
      "line" : 394,
      "node_id" : "PRRC_kwDOABII5841XSsR",
      "original_commit_id" : "56cae81ed7fe59170a4413444d509e1a3c7b132d",
      "original_line" : 394,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 16,
      "pull_request_review_id" : 1003746458,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/895298321/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-13T03:23:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/895298321",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/127186?v=4",
         "events_url" : "https://api.github.com/users/ajtowns/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ajtowns/followers",
         "following_url" : "https://api.github.com/users/ajtowns/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ajtowns/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ajtowns",
         "id" : 127186,
         "login" : "ajtowns",
         "node_id" : "MDQ6VXNlcjEyNzE4Ng==",
         "organizations_url" : "https://api.github.com/users/ajtowns/orgs",
         "received_events_url" : "https://api.github.com/users/ajtowns/received_events",
         "repos_url" : "https://api.github.com/users/ajtowns/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ajtowns/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ajtowns"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r905108173"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/905108173"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Sure; but the map already means the code needs to know about snapshots per se.\r\n\r\nThis is not true - knowing about multiple chainstates is not knowing about snapshots, per the definition of \"per se!\"\r\n\r\n---\r\n\r\nThanks for the example patch. I have looked at this a few times, and I still haven't been able to convince myself that it does something equivalent. It likely does - I'm maybe just too tired or demotivated to see it. \r\n\r\nAs I just mentioned in https://github.com/bitcoin/bitcoin/pull/24232#pullrequestreview-1007902467, I am growing very weary of work on assumeutxo after three years. Unless there are substantive safety/correctness concerns, I will not be making substantial changes to the approach in this and other PRs.\r\n",
      "commit_id" : "54d04d1f09bfbc933b06e74ece325bf05e838848",
      "created_at" : "2022-06-23T14:41:10Z",
      "diff_hunk" : "@@ -380,8 +380,18 @@ struct CNodeState {\n     const CBlockIndex* pindexBestKnownBlock{nullptr};\n     //! The hash of the last unknown block this peer has announced.\n     uint256 hashLastUnknownBlock{};\n-    //! The last full block we both have.\n-    const CBlockIndex* pindexLastCommonBlock{nullptr};\n+\n+    //! The last full block we both have (per chainstate).\n+    //!\n+    //! This is namespaced by chainstate to allow syncing two separate chainstates\n+    //! simultaneously from a single peer.\n+    //!\n+    //! Nota bene: this is contingent on the ChainstateManager not destructing\n+    //! any CChainState objects which were in use at any point (e.g. a background\n+    //! validation chainstate which has completed) until the end of\n+    //! init.cpp:Shutdown(), else we'll have bad pointers here.\n+    std::map<const CChainState*, const CBlockIndex*> chainstate_to_last_common_block = {};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r905108173",
      "id" : 905108173,
      "in_reply_to_id" : 888474234,
      "line" : 394,
      "node_id" : "PRRC_kwDOABII58418trN",
      "original_commit_id" : "56cae81ed7fe59170a4413444d509e1a3c7b132d",
      "original_line" : 394,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 16,
      "pull_request_review_id" : 1017136953,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/905108173/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-06-23T14:41:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/905108173",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-07-04T21:07:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#issuecomment-1174364092",
      "id" : 1174364092,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24008",
      "node_id" : "IC_kwDOABII585F_1-8",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1174364092/reactions"
      },
      "updated_at" : "2022-07-04T21:07:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1174364092",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r952029829"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/952029829"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Note, I think there is a discrepancy between the comment and the actual `GetChainStateForNewBlock()` logic.\r\n\r\nFrom my understanding, the comment is saying the decision criteria to append a new block should be the PoW accumulated. However, the logic implemented probe the presence of the block in the snapshot chainstate, then if it's already included select the IBD chainstate as the relevant chainstate ?\r\n\r\nThat said, I think this approach is sound in case of a peer deliberately sending non-requested blocks to stale the assumeutxo-syncing, where the snapshot chainstate would be prevented to reach the tip quickly. ",
      "commit_id" : "4d581ddf2caeb6ab3a3eeddbf7ea15452bb1c11b",
      "created_at" : "2022-08-23T00:14:36Z",
      "diff_hunk" : "@@ -913,6 +913,19 @@ class ChainstateManager\n     [[nodiscard]] bool ActivateSnapshot(\n         CAutoFile& coins_file, const node::SnapshotMetadata& metadata, bool in_memory);\n \n+    //! Return the relevant chainstate for a new block.\n+    //!\n+    //! Because the use of UTXO snapshots requires the simultaneous maintenance\n+    //! of two chainstates, when a new block message arrives we have to decide\n+    //! which chain we should attempt to append it to.\n+    //!\n+    //! If our most-work chain hasn't seen the incoming blockhash, return that.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r952029829",
      "id" : 952029829,
      "line" : 928,
      "node_id" : "PRRC_kwDOABII5844vtKF",
      "original_commit_id" : "84443da54fd3469812564c8cbed61808809f0e82",
      "original_line" : 922,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 10,
      "pull_request_review_id" : 1081310397,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/952029829/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-23T01:46:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/952029829",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r952045802"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/952045802"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I wonder if it's too early if snapshot chainstate is deprioritized after we get out of IBD. The current definition of network tip is `DEFAULT_MAX_TIP_AGE`, that's still 24h of blocks. If we start to download blocks in parallel for both chainstates, the slow down might diminish the \"quick deployment effect\" for a assumeutxo user.\r\n\r\nI think this concern could only be qualified once the assumeutxo feature is completed and we observe such perf bottleneck. If it's the case, we could introduce a tighter notion of chain tip, such as 2h of blocks. So this is just a note on potential assumeutxo refinements.",
      "commit_id" : "4d581ddf2caeb6ab3a3eeddbf7ea15452bb1c11b",
      "created_at" : "2022-08-23T00:58:37Z",
      "diff_hunk" : "@@ -4693,6 +4693,28 @@ std::vector<CChainState*> ChainstateManager::GetAll()\n     return out;\n }\n \n+std::vector<CChainState*> ChainstateManager::GetAllForBlockDownload()\n+{\n+    AssertLockHeld(::cs_main);\n+    std::vector<CChainState*> out;\n+\n+    bool snapshot_in_ibd{\n+        m_snapshot_chainstate && m_snapshot_chainstate->IsInitialBlockDownload()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r952045802",
      "id" : 952045802,
      "line" : 4702,
      "node_id" : "PRRC_kwDOABII5844vxDq",
      "original_commit_id" : "38ac3b3bc3ef70303641ef96b824aaca5af1de0f",
      "original_line" : 4702,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 10,
      "pull_request_review_id" : 1081310397,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/952045802/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-23T01:46:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/952045802",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r952062129"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/952062129"
         }
      },
      "author_association" : "MEMBER",
      "body" : "As we have two chainstates requesting blocks in parallel, at least as long as snapshot has not reached network's tip, there is a possibility that the bandwidth consumption increase exhaust the monthly ISP data usage caps of the assumeutxo hosts. In some world regions, the Internet access is capped to 5 - 30 GB/month. That's okay, I think we have few options to do resources control like `maxreceivebuffer`, however I wonder if there are other interactions where we're making assumptions on bandwidth / download throughput that would be altered by that change.",
      "commit_id" : "4d581ddf2caeb6ab3a3eeddbf7ea15452bb1c11b",
      "created_at" : "2022-08-23T01:41:24Z",
      "diff_hunk" : "@@ -5237,21 +5278,41 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         // Message: getdata (blocks)\n         //\n         std::vector<CInv> vGetData;\n-        if (!pto->fClient && ((sync_blocks_and_headers_from_peer && !pto->m_limited_node) || !m_chainman.ActiveChainstate().IsInitialBlockDownload()) && state.nBlocksInFlight < MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n-            std::vector<const CBlockIndex*> vToDownload;\n-            NodeId staller = -1;\n-            FindNextBlocksToDownload(pto->GetId(), MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight, vToDownload, staller);\n-            for (const CBlockIndex *pindex : vToDownload) {\n-                uint32_t nFetchFlags = GetFetchFlags(*pto);\n-                vGetData.push_back(CInv(MSG_BLOCK | nFetchFlags, pindex->GetBlockHash()));\n-                BlockRequested(pto->GetId(), *pindex);\n-                LogPrint(BCLog::NET, \"Requesting block %s (%d) peer=%d\\n\", pindex->GetBlockHash().ToString(),\n-                    pindex->nHeight, pto->GetId());\n-            }\n-            if (state.nBlocksInFlight == 0 && staller != -1) {\n-                if (State(staller)->m_stalling_since == 0us) {\n-                    State(staller)->m_stalling_since = current_time;\n-                    LogPrint(BCLog::NET, \"Stall started peer=%d\\n\", staller);\n+\n+        // The first chainstate in line for processing will likely exhaust this\n+        // during IBD, but once it hits a tip capacity will trickle into subsequent\n+        // chainstates.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r952062129",
      "id" : 952062129,
      "line" : 5306,
      "node_id" : "PRRC_kwDOABII5844v1Cx",
      "original_commit_id" : "f33a023bc9b82b015550b79ce01a8867fc34da5f",
      "original_line" : 5284,
      "original_position" : 176,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 176,
      "pull_request_review_id" : 1081310397,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/952062129/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-23T01:46:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/952062129",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r952063025"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/952063025"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think `doc/design/assumeutxo.md` could be updated with the description of the changes implemented here. Beyond, such documentation would constitute a good reference to review the changes themselves and assert their correctness.",
      "commit_id" : "4d581ddf2caeb6ab3a3eeddbf7ea15452bb1c11b",
      "created_at" : "2022-08-23T01:43:35Z",
      "diff_hunk" : "@@ -1849,6 +1849,10 @@ void PeerManagerImpl::BlockChecked(const CBlock& block, const BlockValidationSta\n     // 3. This is currently the best block we're aware of. We haven't updated\n     //    the tip yet so we have no way to check this directly here. Instead we\n     //    just check that there are currently no other blocks in flight.\n+    //\n+    // No need to consider the background validation chainstate's IBD status\n+    // (if applicable) because any active chainstate not in IBD will allow\n+    // us to judge block validity.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r952063025",
      "id" : 952063025,
      "line" : 1855,
      "node_id" : "PRRC_kwDOABII5844v1Qx",
      "original_commit_id" : "4d581ddf2caeb6ab3a3eeddbf7ea15452bb1c11b",
      "original_line" : 1855,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 7,
      "pull_request_review_id" : 1081310397,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/952063025/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-08-23T01:46:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/952063025",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r990270144"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/990270144"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think we can do this without adding `Chainstate` pointers to `CNodeState` which i would really prefer.\r\n\r\nWhat I would suggest is that we nuke `pindexLastCommonBlock` entirely and compute it on demand instead (the performance overhead should be minimal). Then we don't need to keep track of it per chainstate but rather only compute it on demand for a given chain. I have a branch that should illustrate what i mean: https://github.com/dergoegge/bitcoin/commits/2022-10-assumeutxo-netproc (last commit puts the loop over the chains inside of `FindNextBlocksToDownload`, not sure if that works out)",
      "commit_id" : "4d581ddf2caeb6ab3a3eeddbf7ea15452bb1c11b",
      "created_at" : "2022-10-07T16:23:11Z",
      "diff_hunk" : "@@ -386,8 +386,18 @@ struct CNodeState {\n     const CBlockIndex* pindexBestKnownBlock{nullptr};\n     //! The hash of the last unknown block this peer has announced.\n     uint256 hashLastUnknownBlock{};\n-    //! The last full block we both have.\n-    const CBlockIndex* pindexLastCommonBlock{nullptr};\n+\n+    //! The last full block we both have (per chainstate).\n+    //!\n+    //! This is namespaced by chainstate to allow syncing two separate chainstates\n+    //! simultaneously from a single peer.\n+    //!\n+    //! Nota bene: this is contingent on the ChainstateManager not destructing\n+    //! any CChainState objects which were in use at any point (e.g. a background\n+    //! validation chainstate which has completed) until the end of\n+    //! init.cpp:Shutdown(), else we'll have bad pointers here.\n+    std::map<const CChainState*, const CBlockIndex*> chainstate_to_last_common_block = {};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r990270144",
      "id" : 990270144,
      "line" : 399,
      "node_id" : "PRRC_kwDOABII5847BlLA",
      "original_commit_id" : "4d581ddf2caeb6ab3a3eeddbf7ea15452bb1c11b",
      "original_line" : 399,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 16,
      "pull_request_review_id" : 1134795496,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/990270144/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-10-07T16:23:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/990270144",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8077169?v=4",
         "events_url" : "https://api.github.com/users/dergoegge/events{/privacy}",
         "followers_url" : "https://api.github.com/users/dergoegge/followers",
         "following_url" : "https://api.github.com/users/dergoegge/following{/other_user}",
         "gists_url" : "https://api.github.com/users/dergoegge/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/dergoegge",
         "id" : 8077169,
         "login" : "dergoegge",
         "node_id" : "MDQ6VXNlcjgwNzcxNjk=",
         "organizations_url" : "https://api.github.com/users/dergoegge/orgs",
         "received_events_url" : "https://api.github.com/users/dergoegge/received_events",
         "repos_url" : "https://api.github.com/users/dergoegge/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/dergoegge/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/dergoegge"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1006241550"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1006241550"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "`GetSnapshotBaseHeight()` is never used in this PR.",
      "commit_id" : "645418e8b4d76a0c640590024452b4342802286e",
      "created_at" : "2022-10-26T22:30:18Z",
      "diff_hunk" : "@@ -831,6 +831,10 @@ class ChainstateManager\n         CBlockIndex** ppindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n     friend CChainState;\n \n+    // Returns nullptr if no snapshot has been loaded.\n+    const CBlockIndex* GetSnapshotBaseBlock() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+    std::optional<int> GetSnapshotBaseHeight() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1006241550",
      "id" : 1006241550,
      "line" : 849,
      "node_id" : "PRRC_kwDOABII5847-gcO",
      "original_commit_id" : "57de47bca91208f2178a470cf3bb666f4da5a713",
      "original_line" : 849,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 6,
      "pull_request_review_id" : 1157367086,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1006241550/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-09T23:00:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1006241550",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1006259405"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1006259405"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why would we need a chainstate to be out of IBD to assess work in a headers chain?\r\nIn my understanding, the reason for this check is that if the peer is on a chain with insufficient work, we disconnect them here because they wouldn't be able to help us sync.\r\nThis could also apply to the background validation chain, so I guess we'd have to decide whether syncing that chain is a high enough priority that we would kick a peer for it.",
      "commit_id" : "645418e8b4d76a0c640590024452b4342802286e",
      "created_at" : "2022-10-26T23:04:30Z",
      "diff_hunk" : "@@ -2425,6 +2429,10 @@ void PeerManagerImpl::UpdatePeerStateForReceivedHeaders(CNode& pfrom,\n \n     // If we're in IBD, we want outbound peers that will serve us a useful\n     // chain. Disconnect peers that are on chains with insufficient work.\n+    //\n+    // Can ignore background validation chainstate IBD status here (if applicable);\n+    // as long as the active chainstate is out of IBD, we are able to assess\n+    // work in the headers chain.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1006259405",
      "id" : 1006259405,
      "line" : 2756,
      "node_id" : "PRRC_kwDOABII5847-kzN",
      "original_commit_id" : "4d581ddf2caeb6ab3a3eeddbf7ea15452bb1c11b",
      "original_line" : 2756,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 184,
      "pull_request_review_id" : 1157367086,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1006259405/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-09T23:00:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1006259405",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1016945847"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016945847"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yeah there's nothing to do with PoW here per se - when I say \"most-work\" that's just shorthand for \"active chain.\" I'll update the comment to be more specific.",
      "commit_id" : "645418e8b4d76a0c640590024452b4342802286e",
      "created_at" : "2022-11-08T17:48:44Z",
      "diff_hunk" : "@@ -913,6 +913,19 @@ class ChainstateManager\n     [[nodiscard]] bool ActivateSnapshot(\n         CAutoFile& coins_file, const node::SnapshotMetadata& metadata, bool in_memory);\n \n+    //! Return the relevant chainstate for a new block.\n+    //!\n+    //! Because the use of UTXO snapshots requires the simultaneous maintenance\n+    //! of two chainstates, when a new block message arrives we have to decide\n+    //! which chain we should attempt to append it to.\n+    //!\n+    //! If our most-work chain hasn't seen the incoming blockhash, return that.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1016945847",
      "id" : 1016945847,
      "in_reply_to_id" : 952029829,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5848nVy3",
      "original_commit_id" : "84443da54fd3469812564c8cbed61808809f0e82",
      "original_line" : 928,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : null,
      "pull_request_review_id" : 1172590162,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016945847/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-08T17:48:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016945847",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1016950655"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016950655"
         }
      },
      "author_association" : "MEMBER",
      "body" : "[rehashing a discussion from CoreDev]\r\n\r\nThis is a good idea, but should be considered separately as it will require benchmarking and more thorough analysis to ensure that it e.g. doesn't open some kind of DoS vector. I'm not familiar with why these values were cached in the first place, and so \"un-caching\" them is a design choice I'd rather not conflate here with assumeutxo.",
      "commit_id" : "645418e8b4d76a0c640590024452b4342802286e",
      "created_at" : "2022-11-08T17:53:51Z",
      "diff_hunk" : "@@ -386,8 +386,18 @@ struct CNodeState {\n     const CBlockIndex* pindexBestKnownBlock{nullptr};\n     //! The hash of the last unknown block this peer has announced.\n     uint256 hashLastUnknownBlock{};\n-    //! The last full block we both have.\n-    const CBlockIndex* pindexLastCommonBlock{nullptr};\n+\n+    //! The last full block we both have (per chainstate).\n+    //!\n+    //! This is namespaced by chainstate to allow syncing two separate chainstates\n+    //! simultaneously from a single peer.\n+    //!\n+    //! Nota bene: this is contingent on the ChainstateManager not destructing\n+    //! any CChainState objects which were in use at any point (e.g. a background\n+    //! validation chainstate which has completed) until the end of\n+    //! init.cpp:Shutdown(), else we'll have bad pointers here.\n+    std::map<const CChainState*, const CBlockIndex*> chainstate_to_last_common_block = {};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1016950655",
      "id" : 1016950655,
      "in_reply_to_id" : 990270144,
      "line" : null,
      "node_id" : "PRRC_kwDOABII5848nW9_",
      "original_commit_id" : "4d581ddf2caeb6ab3a3eeddbf7ea15452bb1c11b",
      "original_line" : 399,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1172597079,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016950655/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-08T17:53:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016950655",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1016952651"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016952651"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Huh? We are still sharing the same number of `requests_available` - we're just splitting them across two chainstates. It should be identical from the standpoint of bandwidth usage.",
      "commit_id" : "645418e8b4d76a0c640590024452b4342802286e",
      "created_at" : "2022-11-08T17:55:54Z",
      "diff_hunk" : "@@ -5237,21 +5278,41 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         // Message: getdata (blocks)\n         //\n         std::vector<CInv> vGetData;\n-        if (!pto->fClient && ((sync_blocks_and_headers_from_peer && !pto->m_limited_node) || !m_chainman.ActiveChainstate().IsInitialBlockDownload()) && state.nBlocksInFlight < MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n-            std::vector<const CBlockIndex*> vToDownload;\n-            NodeId staller = -1;\n-            FindNextBlocksToDownload(pto->GetId(), MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight, vToDownload, staller);\n-            for (const CBlockIndex *pindex : vToDownload) {\n-                uint32_t nFetchFlags = GetFetchFlags(*pto);\n-                vGetData.push_back(CInv(MSG_BLOCK | nFetchFlags, pindex->GetBlockHash()));\n-                BlockRequested(pto->GetId(), *pindex);\n-                LogPrint(BCLog::NET, \"Requesting block %s (%d) peer=%d\\n\", pindex->GetBlockHash().ToString(),\n-                    pindex->nHeight, pto->GetId());\n-            }\n-            if (state.nBlocksInFlight == 0 && staller != -1) {\n-                if (State(staller)->m_stalling_since == 0us) {\n-                    State(staller)->m_stalling_since = current_time;\n-                    LogPrint(BCLog::NET, \"Stall started peer=%d\\n\", staller);\n+\n+        // The first chainstate in line for processing will likely exhaust this\n+        // during IBD, but once it hits a tip capacity will trickle into subsequent\n+        // chainstates.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1016952651",
      "id" : 1016952651,
      "in_reply_to_id" : 952062129,
      "line" : 5850,
      "node_id" : "PRRC_kwDOABII5848nXdL",
      "original_commit_id" : "f33a023bc9b82b015550b79ce01a8867fc34da5f",
      "original_line" : 5850,
      "original_position" : 176,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 282,
      "pull_request_review_id" : 1172599824,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016952651/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-08T17:55:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016952651",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1016969344"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016969344"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Even after IBD, the snapshot chainstate will still take priority for block download due to the ordering here.",
      "commit_id" : "645418e8b4d76a0c640590024452b4342802286e",
      "created_at" : "2022-11-08T18:14:04Z",
      "diff_hunk" : "@@ -4693,6 +4693,28 @@ std::vector<CChainState*> ChainstateManager::GetAll()\n     return out;\n }\n \n+std::vector<CChainState*> ChainstateManager::GetAllForBlockDownload()\n+{\n+    AssertLockHeld(::cs_main);\n+    std::vector<CChainState*> out;\n+\n+    bool snapshot_in_ibd{\n+        m_snapshot_chainstate && m_snapshot_chainstate->IsInitialBlockDownload()};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1016969344",
      "id" : 1016969344,
      "in_reply_to_id" : 952045802,
      "line" : 4833,
      "node_id" : "PRRC_kwDOABII5848nbiA",
      "original_commit_id" : "38ac3b3bc3ef70303641ef96b824aaca5af1de0f",
      "original_line" : 4833,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 44,
      "pull_request_review_id" : 1172624940,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016969344/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-08T18:14:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1016969344",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased here and I _think_ all feedback has been addressed.",
      "created_at" : "2022-11-08T18:21:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#issuecomment-1307649381",
      "id" : 1307649381,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24008",
      "node_id" : "IC_kwDOABII585N8SVl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1307649381/reactions"
      },
      "updated_at" : "2022-11-08T18:21:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1307649381",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1017562163"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1017562163"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I'm likely misunderstanding something.\r\nImagine a snapshot doesn't exist. Then, if `m_ibd_chainstate == false`, `out` will be empty, and this would trigger an issue?\r\n\r\nSo, if the caller must not call it in this case, this requirement probably should be documented?",
      "commit_id" : "645418e8b4d76a0c640590024452b4342802286e",
      "created_at" : "2022-11-09T08:00:17Z",
      "diff_hunk" : "@@ -4824,6 +4824,28 @@ std::vector<Chainstate*> ChainstateManager::GetAll()\n     return out;\n }\n \n+std::vector<Chainstate*> ChainstateManager::GetAllForBlockDownload()\n+{\n+    AssertLockHeld(::cs_main);\n+    std::vector<Chainstate*> out;\n+\n+    bool snapshot_in_ibd{\n+        m_snapshot_chainstate && m_snapshot_chainstate->IsInitialBlockDownload()};\n+\n+    if (m_snapshot_chainstate) {\n+        out.push_back(m_snapshot_chainstate.get());\n+    }\n+    // Exclude the ibd chainstate (which is in the background if we have a snapshot\n+    // chainstate active) if the snapshot chainstate is in IBD because the main\n+    // priority is getting the active chain to network tip.\n+    if (!IsSnapshotValidated() && !snapshot_in_ibd && m_ibd_chainstate) {\n+        out.push_back(m_ibd_chainstate.get());\n+    }\n+\n+    assert(out.size() > 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1017562163",
      "id" : 1017562163,
      "line" : 4845,
      "node_id" : "PRRC_kwDOABII5848psQz",
      "original_commit_id" : "42f5b6b03bba1ef1c1bc6c225606d119c4e27169",
      "original_line" : 4845,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 22,
      "pull_request_review_id" : 1173511441,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1017562163/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-09T08:00:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1017562163",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7975071?v=4",
         "events_url" : "https://api.github.com/users/naumenkogs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/naumenkogs/followers",
         "following_url" : "https://api.github.com/users/naumenkogs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/naumenkogs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/naumenkogs",
         "id" : 7975071,
         "login" : "naumenkogs",
         "node_id" : "MDQ6VXNlcjc5NzUwNzE=",
         "organizations_url" : "https://api.github.com/users/naumenkogs/orgs",
         "received_events_url" : "https://api.github.com/users/naumenkogs/received_events",
         "repos_url" : "https://api.github.com/users/naumenkogs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/naumenkogs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/naumenkogs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1018465778"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1018465778"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I'm new to AssumeUTXO and had a similar question - I came to the conclustion that `m_ibd_chainstate` always exists. If we are in a situation where the background chainstate catches up with the snapshot, after the next restart there will be only one chain, which is the old snapshot chainstate, but it will now be \"rebranded\" as `m_ibd_chainstate` (#25740). If we never used AssumeUTXO, the usual chainstate will be `m_ibd_chainstate`.",
      "commit_id" : "645418e8b4d76a0c640590024452b4342802286e",
      "created_at" : "2022-11-09T22:15:58Z",
      "diff_hunk" : "@@ -4824,6 +4824,28 @@ std::vector<Chainstate*> ChainstateManager::GetAll()\n     return out;\n }\n \n+std::vector<Chainstate*> ChainstateManager::GetAllForBlockDownload()\n+{\n+    AssertLockHeld(::cs_main);\n+    std::vector<Chainstate*> out;\n+\n+    bool snapshot_in_ibd{\n+        m_snapshot_chainstate && m_snapshot_chainstate->IsInitialBlockDownload()};\n+\n+    if (m_snapshot_chainstate) {\n+        out.push_back(m_snapshot_chainstate.get());\n+    }\n+    // Exclude the ibd chainstate (which is in the background if we have a snapshot\n+    // chainstate active) if the snapshot chainstate is in IBD because the main\n+    // priority is getting the active chain to network tip.\n+    if (!IsSnapshotValidated() && !snapshot_in_ibd && m_ibd_chainstate) {\n+        out.push_back(m_ibd_chainstate.get());\n+    }\n+\n+    assert(out.size() > 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1018465778",
      "id" : 1018465778,
      "in_reply_to_id" : 1017562163,
      "line" : 4845,
      "node_id" : "PRRC_kwDOABII5848tI3y",
      "original_commit_id" : "42f5b6b03bba1ef1c1bc6c225606d119c4e27169",
      "original_line" : 4845,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 22,
      "pull_request_review_id" : 1157367086,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1018465778/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-09T23:00:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1018465778",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/48763452?v=4",
         "events_url" : "https://api.github.com/users/mzumsande/events{/privacy}",
         "followers_url" : "https://api.github.com/users/mzumsande/followers",
         "following_url" : "https://api.github.com/users/mzumsande/following{/other_user}",
         "gists_url" : "https://api.github.com/users/mzumsande/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/mzumsande",
         "id" : 48763452,
         "login" : "mzumsande",
         "node_id" : "MDQ6VXNlcjQ4NzYzNDUy",
         "organizations_url" : "https://api.github.com/users/mzumsande/orgs",
         "received_events_url" : "https://api.github.com/users/mzumsande/received_events",
         "repos_url" : "https://api.github.com/users/mzumsande/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/mzumsande/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/mzumsande"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1021007712"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021007712"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"add ChainstateManager.GetSnapshot{BaseHeight,BaseBlock}()\" (3219f1d682378003296b9e8792ae73557c518a0d)\r\n\r\nMaybe it could return `Assert(LookupBlockIndex())` to assert that the hash is valid if there is a snapshot.",
      "commit_id" : "645418e8b4d76a0c640590024452b4342802286e",
      "created_at" : "2022-11-14T01:28:47Z",
      "diff_hunk" : "@@ -5302,3 +5302,18 @@ Chainstate& ChainstateManager::ActivateExistingSnapshot(CTxMemPool* mempool, uin\n     m_active_chainstate = m_snapshot_chainstate.get();\n     return *m_snapshot_chainstate;\n }\n+\n+const CBlockIndex* ChainstateManager::GetSnapshotBaseBlock() const\n+{\n+    AssertLockHeld(::cs_main);\n+    const auto blockhash_op{this->SnapshotBlockhash()};\n+    if (!blockhash_op) return nullptr;\n+    return m_blockman.LookupBlockIndex(*blockhash_op);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1021007712",
      "id" : 1021007712,
      "line" : 5354,
      "node_id" : "PRRC_kwDOABII584821dg",
      "original_commit_id" : "3219f1d682378003296b9e8792ae73557c518a0d",
      "original_line" : 5311,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 10,
      "pull_request_review_id" : 1178353665,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021007712/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-14T02:38:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021007712",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1021014794"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021014794"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainstateManager::GetAllForBlockDownload()\" (42f5b6b03bba1ef1c1bc6c225606d119c4e27169)\r\n\r\nYeah I basically repeat this same comment in all my assumeutxo reviews, but I still find the terms \"IBD chainstate\" and \"snapshot chainstate\" confusing and think it would be nice to abolish them later (https://github.com/bitcoin/bitcoin/pull/24232#discussion_r835355848).\r\n\r\nUsually when you try to write code that is more general than it needs to be, it makes things more complicated. But sometimes generalizing code makes it simpler. I think all the code using chainstatemanager would be simpler if chainstatemanager just kept a simple vector of chainstates and pointer to the active chainstate, so assumeutxo logic and terminology would be only need to appear in code loading and validating the snapshot, and the rest of validation and net processing code would only have to care about active and inactive chainstates.",
      "commit_id" : "645418e8b4d76a0c640590024452b4342802286e",
      "created_at" : "2022-11-14T01:54:35Z",
      "diff_hunk" : "@@ -4824,6 +4824,28 @@ std::vector<Chainstate*> ChainstateManager::GetAll()\n     return out;\n }\n \n+std::vector<Chainstate*> ChainstateManager::GetAllForBlockDownload()\n+{\n+    AssertLockHeld(::cs_main);\n+    std::vector<Chainstate*> out;\n+\n+    bool snapshot_in_ibd{\n+        m_snapshot_chainstate && m_snapshot_chainstate->IsInitialBlockDownload()};\n+\n+    if (m_snapshot_chainstate) {\n+        out.push_back(m_snapshot_chainstate.get());\n+    }\n+    // Exclude the ibd chainstate (which is in the background if we have a snapshot\n+    // chainstate active) if the snapshot chainstate is in IBD because the main\n+    // priority is getting the active chain to network tip.\n+    if (!IsSnapshotValidated() && !snapshot_in_ibd && m_ibd_chainstate) {\n+        out.push_back(m_ibd_chainstate.get());\n+    }\n+\n+    assert(out.size() > 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1021014794",
      "id" : 1021014794,
      "in_reply_to_id" : 1017562163,
      "line" : 4845,
      "node_id" : "PRRC_kwDOABII584823MK",
      "original_commit_id" : "42f5b6b03bba1ef1c1bc6c225606d119c4e27169",
      "original_line" : 4845,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 22,
      "pull_request_review_id" : 1178353665,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021014794/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-14T02:39:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021014794",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1021018683"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021018683"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"net_processing: work with multiple chainstates\" (c5bfecff4d0db726fab893a46cc1dab29591f325)\r\n\r\nThere's a lot of map lookups in this function, and it seems like you could eliminate them all by declaring a local reference\r\n\r\n```\r\nconst CBlockIndex*& last_common_block =  state->chainstate_to_last_common_block[chainstate];\r\n```\r\n\r\nNote the pointer is const but the reference is non-const, so you could assign to it and make fewer changes to code below, just replacing `state->pindexLastCommonBlock` with `last_common_block` and `m_chainman.ActiveChain()` with `our_chain`.",
      "commit_id" : "645418e8b4d76a0c640590024452b4342802286e",
      "created_at" : "2022-11-14T02:07:17Z",
      "diff_hunk" : "@@ -1293,31 +1313,44 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\n     // Make sure pindexBestKnownBlock is up to date, we'll need it.\n     ProcessBlockAvailability(peer.m_id);\n \n-    if (state->pindexBestKnownBlock == nullptr || state->pindexBestKnownBlock->nChainWork < m_chainman.ActiveChain().Tip()->nChainWork || state->pindexBestKnownBlock->nChainWork < m_chainman.MinimumChainWork()) {\n+    const CChain& our_chain = chainstate->m_chain;\n+    const CBlockIndex* our_tip = our_chain.Tip();\n+\n+    if (state->pindexBestKnownBlock == nullptr\n+            || state->pindexBestKnownBlock->nChainWork < our_tip->nChainWork\n+            || state->pindexBestKnownBlock->nChainWork < m_chainman.MinimumChainWork()) {\n         // This peer has nothing interesting.\n         return;\n     }\n \n-    if (state->pindexLastCommonBlock == nullptr) {\n+    if (!state->chainstate_to_last_common_block.count(chainstate)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1021018683",
      "id" : 1021018683,
      "line" : 1326,
      "node_id" : "PRRC_kwDOABII584824I7",
      "original_commit_id" : "c5bfecff4d0db726fab893a46cc1dab29591f325",
      "original_line" : 1326,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 70,
      "pull_request_review_id" : 1178353665,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021018683/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-14T02:39:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021018683",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1021024865"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021024865"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainstateManager::GetAllForBlockDownload()\" (42f5b6b03bba1ef1c1bc6c225606d119c4e27169)\r\n\r\nIs there a reason to exclude the ibd chainstate if the comment in commit \"net_processing: work with multiple chainstates\" (c5bfecff4d0db726fab893a46cc1dab29591f325) is correct: \"The first chainstate in line for processing will likely exhaust this during IBD, but once it hits a tip capacity will trickle into subsequent chainstates.\"?\r\n\r\nIt seems cleaner if code in net_processing just decide what blocks to download and validation code doesn't have to be involved in the details.\r\n\r\nEDIT: To be more specific, I'm suggesting dropping this `GetAllForBlockDownload` method and just having net_processing code call `GetAll` instead. `GetAll` method could be changed to return snapshot chainstate before IBD chainstate so it has higher priority to download blocks",
      "commit_id" : "645418e8b4d76a0c640590024452b4342802286e",
      "created_at" : "2022-11-14T02:26:36Z",
      "diff_hunk" : "@@ -4824,6 +4824,28 @@ std::vector<Chainstate*> ChainstateManager::GetAll()\n     return out;\n }\n \n+std::vector<Chainstate*> ChainstateManager::GetAllForBlockDownload()\n+{\n+    AssertLockHeld(::cs_main);\n+    std::vector<Chainstate*> out;\n+\n+    bool snapshot_in_ibd{\n+        m_snapshot_chainstate && m_snapshot_chainstate->IsInitialBlockDownload()};\n+\n+    if (m_snapshot_chainstate) {\n+        out.push_back(m_snapshot_chainstate.get());\n+    }\n+    // Exclude the ibd chainstate (which is in the background if we have a snapshot\n+    // chainstate active) if the snapshot chainstate is in IBD because the main\n+    // priority is getting the active chain to network tip.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1021024865",
      "id" : 1021024865,
      "line" : 4840,
      "node_id" : "PRRC_kwDOABII584825ph",
      "original_commit_id" : "42f5b6b03bba1ef1c1bc6c225606d119c4e27169",
      "original_line" : 4840,
      "original_position" : 17,
      "original_start_line" : 4838,
      "path" : "src/validation.cpp",
      "position" : 17,
      "pull_request_review_id" : 1178353665,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021024865/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 4838,
      "start_side" : "RIGHT",
      "updated_at" : "2022-11-14T19:58:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021024865",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1021992945"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021992945"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: introduce ChainstateManager::GetChainstateForNewBlock\" (650677dd66cede06e242975f51c0e5e77b99079f)\r\n\r\nIf I revert this line, all tests seem to still pass. I understand why we can't have functional tests for this code before there is a snapshot loading RPC but it seems like it shouldn't be that hard to come up with a unit test that would exercise this logic. I don't think it's good to be in a state where validation code doesn't have test coverage, even if it's a temporary state.",
      "commit_id" : "645418e8b4d76a0c640590024452b4342802286e",
      "created_at" : "2022-11-14T19:50:13Z",
      "diff_hunk" : "@@ -3902,18 +3904,21 @@ bool ChainstateManager::ProcessNewBlock(const std::shared_ptr<const CBlock>& blo\n         bool ret = CheckBlock(*block, state, GetConsensus());\n         if (ret) {\n             // Store to disk\n-            ret = ActiveChainstate().AcceptBlock(block, state, &pindex, force_processing, nullptr, new_block, min_pow_checked);\n+            ret = chainstate->AcceptBlock(\n+                block, state, &pindex, force_processing, nullptr, new_block, min_pow_checked);\n         }\n         if (!ret) {\n             GetMainSignals().BlockChecked(*block, state);\n             return error(\"%s: AcceptBlock FAILED (%s)\", __func__, state.ToString());\n         }\n     }\n \n-    NotifyHeaderTip(ActiveChainstate());\n+    if (chainstate == &this->ActiveChainstate()) {\n+        NotifyHeaderTip(*chainstate);\n+    }\n \n     BlockValidationState state; // Only used to report errors, not invalidity - ignore it\n-    if (!ActiveChainstate().ActivateBestChain(state, block)) {\n+    if (!chainstate->ActivateBestChain(state, block)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1021992945",
      "id" : 1021992945,
      "line" : 3921,
      "node_id" : "PRRC_kwDOABII58486l_x",
      "original_commit_id" : "650677dd66cede06e242975f51c0e5e77b99079f",
      "original_line" : 3921,
      "original_position" : 30,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 30,
      "pull_request_review_id" : 1179743982,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021992945/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-14T19:59:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021992945",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1021995519"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021995519"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"validation: add ChainstateManager::GetAllForBlockDownload()\" (42f5b6b03bba1ef1c1bc6c225606d119c4e27169)\r\n\r\nAfter #24008 will this need to change to `m_snapshot_chainstate && IsUsable(m_snapshot_chainstate)`?",
      "commit_id" : "645418e8b4d76a0c640590024452b4342802286e",
      "created_at" : "2022-11-14T19:53:24Z",
      "diff_hunk" : "@@ -4824,6 +4824,28 @@ std::vector<Chainstate*> ChainstateManager::GetAll()\n     return out;\n }\n \n+std::vector<Chainstate*> ChainstateManager::GetAllForBlockDownload()\n+{\n+    AssertLockHeld(::cs_main);\n+    std::vector<Chainstate*> out;\n+\n+    bool snapshot_in_ibd{\n+        m_snapshot_chainstate && m_snapshot_chainstate->IsInitialBlockDownload()};\n+\n+    if (m_snapshot_chainstate) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1021995519",
      "id" : 1021995519,
      "line" : 4835,
      "node_id" : "PRRC_kwDOABII58486mn_",
      "original_commit_id" : "42f5b6b03bba1ef1c1bc6c225606d119c4e27169",
      "original_line" : 4835,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 12,
      "pull_request_review_id" : 1179743982,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021995519/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-14T19:59:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1021995519",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1022688185"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1022688185"
         }
      },
      "author_association" : "MEMBER",
      "body" : "c5bfecff4d0db726fab893a46cc1dab29591f325\r\n```suggestion\r\n        for (const auto* chainstate : m_chainman.GetAllForBlockDownload()) {\r\n```",
      "commit_id" : "645418e8b4d76a0c640590024452b4342802286e",
      "created_at" : "2022-11-15T11:44:02Z",
      "diff_hunk" : "@@ -5776,21 +5844,41 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         // Message: getdata (blocks)\n         //\n         std::vector<CInv> vGetData;\n-        if (CanServeBlocks(*peer) && ((sync_blocks_and_headers_from_peer && !IsLimitedPeer(*peer)) || !m_chainman.ActiveChainstate().IsInitialBlockDownload()) && state.nBlocksInFlight < MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n-            std::vector<const CBlockIndex*> vToDownload;\n-            NodeId staller = -1;\n-            FindNextBlocksToDownload(*peer, MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight, vToDownload, staller);\n-            for (const CBlockIndex *pindex : vToDownload) {\n-                uint32_t nFetchFlags = GetFetchFlags(*peer);\n-                vGetData.push_back(CInv(MSG_BLOCK | nFetchFlags, pindex->GetBlockHash()));\n-                BlockRequested(pto->GetId(), *pindex);\n-                LogPrint(BCLog::NET, \"Requesting block %s (%d) peer=%d\\n\", pindex->GetBlockHash().ToString(),\n-                    pindex->nHeight, pto->GetId());\n-            }\n-            if (state.nBlocksInFlight == 0 && staller != -1) {\n-                if (State(staller)->m_stalling_since == 0us) {\n-                    State(staller)->m_stalling_since = current_time;\n-                    LogPrint(BCLog::NET, \"Stall started peer=%d\\n\", staller);\n+\n+        // The first chainstate in line for processing will likely exhaust this\n+        // during IBD, but once it hits a tip capacity will trickle into subsequent\n+        // chainstates.\n+        unsigned int requests_available{\n+            state.nBlocksInFlight > MAX_BLOCKS_IN_TRANSIT_PER_PEER ?\n+                0U :\n+                static_cast<unsigned int>(MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight)};\n+\n+        // GetAllForBlockDownload() ensures we get blocks for the snapshot\n+        // chainstate first. It is more important to get to the network's tip\n+        // quickly than do the background validation on the snapshot.\n+        for (Chainstate* chainstate : m_chainman.GetAllForBlockDownload()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1022688185",
      "id" : 1022688185,
      "line" : 5859,
      "node_id" : "PRRC_kwDOABII58489Pu5",
      "original_commit_id" : "645418e8b4d76a0c640590024452b4342802286e",
      "original_line" : 5859,
      "original_position" : 291,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 291,
      "pull_request_review_id" : 1180724106,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1022688185/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-15T11:48:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1022688185",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1022689304"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1022689304"
         }
      },
      "author_association" : "MEMBER",
      "body" : "42f5b6b03bba1ef1c1bc6c225606d119c4e27169\r\n```suggestion\r\nstd::vector<Chainstate*> ChainstateManager::GetAllForBlockDownload() const\r\n```",
      "commit_id" : "645418e8b4d76a0c640590024452b4342802286e",
      "created_at" : "2022-11-15T11:45:14Z",
      "diff_hunk" : "@@ -4819,6 +4824,28 @@ std::vector<Chainstate*> ChainstateManager::GetAll()\n     return out;\n }\n \n+std::vector<Chainstate*> ChainstateManager::GetAllForBlockDownload()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1022689304",
      "id" : 1022689304,
      "line" : 4827,
      "node_id" : "PRRC_kwDOABII58489QAY",
      "original_commit_id" : "645418e8b4d76a0c640590024452b4342802286e",
      "original_line" : 4827,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 38,
      "pull_request_review_id" : 1180724106,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1022689304/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-15T11:48:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1022689304",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1022690017"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1022690017"
         }
      },
      "author_association" : "MEMBER",
      "body" : "03abde6150e9950e18edc00cb0541a33f714a231\r\n```suggestion\r\nbool ChainstateManager::IsAnyChainInIBD() const\r\n```",
      "commit_id" : "645418e8b4d76a0c640590024452b4342802286e",
      "created_at" : "2022-11-15T11:46:04Z",
      "diff_hunk" : "@@ -5302,3 +5345,25 @@ Chainstate& ChainstateManager::ActivateExistingSnapshot(CTxMemPool* mempool, uin\n     m_active_chainstate = m_snapshot_chainstate.get();\n     return *m_snapshot_chainstate;\n }\n+\n+const CBlockIndex* ChainstateManager::GetSnapshotBaseBlock() const\n+{\n+    AssertLockHeld(::cs_main);\n+    const auto blockhash_op{this->SnapshotBlockhash()};\n+    if (!blockhash_op) return nullptr;\n+    return m_blockman.LookupBlockIndex(*blockhash_op);\n+}\n+\n+std::optional<int> ChainstateManager::GetSnapshotBaseHeight() const\n+{\n+    AssertLockHeld(::cs_main);\n+    auto base{this->GetSnapshotBaseBlock()};\n+    return base ? std::make_optional(base->nHeight) : std::nullopt;\n+}\n+\n+bool ChainstateManager::IsAnyChainInIBD()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1022690017",
      "id" : 1022690017,
      "line" : 5364,
      "node_id" : "PRRC_kwDOABII58489QLh",
      "original_commit_id" : "645418e8b4d76a0c640590024452b4342802286e",
      "original_line" : 5364,
      "original_position" : 106,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 106,
      "pull_request_review_id" : 1180724106,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1022690017/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-11-15T11:48:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1022690017",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22493292?v=4",
         "events_url" : "https://api.github.com/users/aureleoules/events{/privacy}",
         "followers_url" : "https://api.github.com/users/aureleoules/followers",
         "following_url" : "https://api.github.com/users/aureleoules/following{/other_user}",
         "gists_url" : "https://api.github.com/users/aureleoules/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/aureleoules",
         "id" : 22493292,
         "login" : "aureleoules",
         "node_id" : "MDQ6VXNlcjIyNDkzMjky",
         "organizations_url" : "https://api.github.com/users/aureleoules/orgs",
         "received_events_url" : "https://api.github.com/users/aureleoules/received_events",
         "repos_url" : "https://api.github.com/users/aureleoules/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/aureleoules/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/aureleoules/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/aureleoules"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2022-12-05T22:51:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#issuecomment-1338286426",
      "id" : 1338286426,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24008",
      "node_id" : "IC_kwDOABII585PxKFa",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1338286426/reactions"
      },
      "updated_at" : "2022-12-05T22:51:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1338286426",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2022-12-12T10:02:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#issuecomment-1346200097",
      "id" : 1346200097,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24008",
      "node_id" : "IC_kwDOABII585QPWIh",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1346200097/reactions"
      },
      "updated_at" : "2022-12-12T10:02:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1346200097",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1116123753"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1116123753"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Neither are used here, because `GetSnapshotBaseBlock` is only used by `GetSnapshotBaseHeight`. But they are used in the final PR, so I'm fine with introducing them here.",
      "commit_id" : "88a7b840147952f9ec4fbd2e6a73632e355281e0",
      "created_at" : "2023-02-23T18:58:08Z",
      "diff_hunk" : "@@ -831,6 +831,10 @@ class ChainstateManager\n         CBlockIndex** ppindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n     friend CChainState;\n \n+    // Returns nullptr if no snapshot has been loaded.\n+    const CBlockIndex* GetSnapshotBaseBlock() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n+    std::optional<int> GetSnapshotBaseHeight() const EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1116123753",
      "id" : 1116123753,
      "in_reply_to_id" : 1006241550,
      "line" : 852,
      "node_id" : "PRRC_kwDOABII585ChrJp",
      "original_commit_id" : "57de47bca91208f2178a470cf3bb666f4da5a713",
      "original_line" : 852,
      "original_position" : 6,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 6,
      "pull_request_review_id" : 1311957223,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1116123753/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-23T19:47:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1116123753",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1116142978"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1116142978"
         }
      },
      "author_association" : "MEMBER",
      "body" : "That seems like a good idea, also because `GetSnapshotBaseHeight` will deference the result to get a height. (Though it won't crash because it checks if the result is a `nullptr`.)",
      "commit_id" : "88a7b840147952f9ec4fbd2e6a73632e355281e0",
      "created_at" : "2023-02-23T19:15:57Z",
      "diff_hunk" : "@@ -5302,3 +5302,18 @@ Chainstate& ChainstateManager::ActivateExistingSnapshot(CTxMemPool* mempool, uin\n     m_active_chainstate = m_snapshot_chainstate.get();\n     return *m_snapshot_chainstate;\n }\n+\n+const CBlockIndex* ChainstateManager::GetSnapshotBaseBlock() const\n+{\n+    AssertLockHeld(::cs_main);\n+    const auto blockhash_op{this->SnapshotBlockhash()};\n+    if (!blockhash_op) return nullptr;\n+    return m_blockman.LookupBlockIndex(*blockhash_op);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1116142978",
      "id" : 1116142978,
      "in_reply_to_id" : 1021007712,
      "line" : 5374,
      "node_id" : "PRRC_kwDOABII585Chv2C",
      "original_commit_id" : "3219f1d682378003296b9e8792ae73557c518a0d",
      "original_line" : 5374,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 96,
      "pull_request_review_id" : 1311957223,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1116142978/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-23T19:47:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1116142978",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1116158372"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1116158372"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I find the explanation in the function body more clear. Maybe say:\r\n\r\n```md\r\n// Because we expect to have received the headers for the IBD chain\r\n// contents before receiving blocks, when the (shared) block manager\r\n// doesn't include a header for this block, it must go to\r\n// to the snapshot chain.\r\n```",
      "commit_id" : "88a7b840147952f9ec4fbd2e6a73632e355281e0",
      "created_at" : "2023-02-23T19:32:46Z",
      "diff_hunk" : "@@ -938,6 +938,19 @@ class ChainstateManager\n     [[nodiscard]] bool ActivateSnapshot(\n         AutoFile& coins_file, const node::SnapshotMetadata& metadata, bool in_memory);\n \n+    //! Return the relevant chainstate for a new block.\n+    //!\n+    //! Because the use of UTXO snapshots requires the simultaneous maintenance\n+    //! of two chainstates, when a new block message arrives we have to decide\n+    //! which chain we should attempt to append it to.\n+    //!\n+    //! If our active chainstate hasn't seen the incoming blockhash, return that.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1116158372",
      "id" : 1116158372,
      "line" : 953,
      "node_id" : "PRRC_kwDOABII585Chzmk",
      "original_commit_id" : "bf99340edefc83913116f2ef972988e016deba3d",
      "original_line" : 947,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 10,
      "pull_request_review_id" : 1311957223,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1116158372/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-23T19:47:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1116158372",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1116169293"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1116169293"
         }
      },
      "author_association" : "MEMBER",
      "body" : "bf99340edefc83913116f2ef972988e016deba3d IIUC: maybe clarify here that `m_chain.Contains` searches both the snapshot headers _and_ the IBD headers it's built on top of. When a `pblock` exists but is not contained in the chainstate it's a fork, and it's up to the snapshot chainstate to explore those.",
      "commit_id" : "88a7b840147952f9ec4fbd2e6a73632e355281e0",
      "created_at" : "2023-02-23T19:42:35Z",
      "diff_hunk" : "@@ -5204,6 +5209,22 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+Chainstate& ChainstateManager::GetChainstateForNewBlock(const uint256& blockhash)\n+{\n+    AssertLockHeld(::cs_main);\n+    const auto* pblock{m_blockman.LookupBlockIndex(blockhash)};\n+    // If pblock is null, we haven't seen the header for this block.\n+    // Because we expect to have received the headers for the IBD chain\n+    // contents before receiving blocks, this means that any block for\n+    // which we don't have headers should go in the snapshot chain.\n+    if (m_snapshot_chainstate &&\n+            (pblock == nullptr || !m_snapshot_chainstate->m_chain.Contains(pblock))) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1116169293",
      "id" : 1116169293,
      "line" : 5243,
      "node_id" : "PRRC_kwDOABII585Ch2RN",
      "original_commit_id" : "bf99340edefc83913116f2ef972988e016deba3d",
      "original_line" : 5221,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 47,
      "pull_request_review_id" : 1311957223,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1116169293/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-02-23T19:48:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1116169293",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Also, as far as I understand it, AssumeUTXO will mess up the order of the blocks stored on disk - the first blockfiles would have the blocks between the AssumeUTXO block and the tip, and the subsequent blockfiles would have the blocks between Genesis and the AssumeUTXO block. I wonder if that could break or slow down something, have you tried a reindex for example?\r\n\r\nThis is certainly worth addressing. My inclination is to say that given there are only 6925 separate block files on my mainnet node at time of writing, I wouldn't expect a significant slowdown to intermingle block storage locality. But that said this should certainly be benchmarked. Over the next week I'll do an IBD with assumeutxo, and then compare reindexing it to reindexing a \"traditionally\" IBD'd datadir.",
      "created_at" : "2023-03-09T16:15:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#issuecomment-1462344633",
      "id" : 1462344633,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24008",
      "node_id" : "IC_kwDOABII585XKZu5",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1462344633/reactions"
      },
      "updated_at" : "2023-03-09T16:15:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1462344633",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1132286555"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1132286555"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit (feel free to ignore): What about passing a `const&` ref here? Otherwise someone could pass in a `nullptr` and run into UB at runtime?",
      "commit_id" : "07ab98ecc64a39b377e20dcdd571a750ab62fd97",
      "created_at" : "2023-03-10T12:02:29Z",
      "diff_hunk" : "@@ -889,10 +899,15 @@ class PeerManagerImpl final : public PeerManager\n \n     bool TipMayBeStale() EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n-    /** Update pindexLastCommonBlock and add not-in-flight missing successors to vBlocks, until it has\n-     *  at most count entries.\n+    /** Update chainstate_to_last_common_block and add not-in-flight missing successors\n+     * to vBlocks, until it has at most count entries.\n      */\n-    void FindNextBlocksToDownload(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, NodeId& nodeStaller) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+    void FindNextBlocksToDownload(\n+        const Chainstate* const chainstate,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1132286555",
      "id" : 1132286555,
      "line" : 906,
      "node_id" : "PRRC_kwDOABII585DfVJb",
      "original_commit_id" : "07ab98ecc64a39b377e20dcdd571a750ab62fd97",
      "original_line" : 906,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 32,
      "pull_request_review_id" : 1334725192,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1132286555/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-03-10T12:10:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1132286555",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1132291848"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1132291848"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: No need to call `get` if you call `*` later on. Also, can inline the assert:\r\n```suggestion\r\n\r\n    return *Assert(m_ibd_chainstate);\r\n```",
      "commit_id" : "07ab98ecc64a39b377e20dcdd571a750ab62fd97",
      "created_at" : "2023-03-10T12:08:58Z",
      "diff_hunk" : "@@ -5485,6 +5512,22 @@ SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation(\n     return SnapshotCompletionResult::SUCCESS;\n }\n \n+Chainstate& ChainstateManager::GetChainstateForNewBlock(const uint256& blockhash)\n+{\n+    AssertLockHeld(::cs_main);\n+    const auto* pblock{m_blockman.LookupBlockIndex(blockhash)};\n+    // If pblock is null, we haven't seen the header for this block.\n+    // Because we expect to have received the headers for the IBD chain\n+    // contents before receiving blocks, this means that any block for\n+    // which we don't have headers should go in the snapshot chain.\n+    if (m_snapshot_chainstate &&\n+            (pblock == nullptr || !m_snapshot_chainstate->m_chain.Contains(pblock))) {\n+        return *m_snapshot_chainstate.get();\n+    }\n+    assert(m_ibd_chainstate);\n+    return *m_ibd_chainstate.get();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1132291848",
      "id" : 1132291848,
      "line" : 5528,
      "node_id" : "PRRC_kwDOABII585DfWcI",
      "original_commit_id" : "07ab98ecc64a39b377e20dcdd571a750ab62fd97",
      "original_line" : 5528,
      "original_position" : 80,
      "original_start_line" : 5527,
      "path" : "src/validation.cpp",
      "position" : 80,
      "pull_request_review_id" : 1334725192,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1132291848/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 5527,
      "start_side" : "RIGHT",
      "updated_at" : "2023-03-10T12:10:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1132291848",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1133292021"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1133292021"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This function could have an early return of `m_ibd_chainstate` if there is no `m_snapshot_chainstate` which should be the base case, i.e. when assumeutxo is not used?",
      "commit_id" : "07ab98ecc64a39b377e20dcdd571a750ab62fd97",
      "created_at" : "2023-03-12T17:15:55Z",
      "diff_hunk" : "@@ -5485,6 +5490,22 @@ SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation(\n     return SnapshotCompletionResult::SUCCESS;\n }\n \n+Chainstate& ChainstateManager::GetChainstateForNewBlock(const uint256& blockhash)\n+{\n+    AssertLockHeld(::cs_main);\n+    const auto* pblock{m_blockman.LookupBlockIndex(blockhash)};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1133292021",
      "id" : 1133292021,
      "line" : 5518,
      "node_id" : "PRRC_kwDOABII585DjKn1",
      "original_commit_id" : "8e4813736298c5dfc6ba96302a148293e8ecd029",
      "original_line" : 5496,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 70,
      "pull_request_review_id" : 1336057822,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1133292021/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-03-12T17:52:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1133292021",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1133294858"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1133294858"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: `m_chainstate_to_last_common_block`",
      "commit_id" : "07ab98ecc64a39b377e20dcdd571a750ab62fd97",
      "created_at" : "2023-03-12T17:32:36Z",
      "diff_hunk" : "@@ -410,8 +410,18 @@ struct CNodeState {\n     const CBlockIndex* pindexBestKnownBlock{nullptr};\n     //! The hash of the last unknown block this peer has announced.\n     uint256 hashLastUnknownBlock{};\n-    //! The last full block we both have.\n-    const CBlockIndex* pindexLastCommonBlock{nullptr};\n+\n+    //! The last full block we both have (per chainstate).\n+    //!\n+    //! This is namespaced by chainstate to allow syncing two separate chainstates\n+    //! simultaneously from a single peer.\n+    //!\n+    //! Nota bene: this is contingent on the ChainstateManager not destructing\n+    //! any Chainstate objects which were in use at any point (e.g. a background\n+    //! validation chainstate which has completed) until the end of\n+    //! init.cpp:Shutdown(), else we'll have bad pointers here.\n+    std::map<const Chainstate*, const CBlockIndex*> chainstate_to_last_common_block = {};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1133294858",
      "id" : 1133294858,
      "line" : 423,
      "node_id" : "PRRC_kwDOABII585DjLUK",
      "original_commit_id" : "ed8f55b87cc6e8ce4fcb05c00829996267d39748",
      "original_line" : 423,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 16,
      "pull_request_review_id" : 1336057822,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1133294858/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2023-03-12T17:52:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1133294858",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Approach ACK [0ef0057](https://github.com/bitcoin/bitcoin/commit/0ef00576cc9a4aac27310b9fc29c534ad829aad9) the logic seems good AFAICS\r\n\r\nWill re-review after my last review 14 months age.\r\n\r\nFinishing the 2 remaining PRs in the parent https://github.com/bitcoin/bitcoin/pull/15606 after v25 branch-off, to target early in the v26 release cycle might be a reasonable goal?",
      "created_at" : "2023-04-14T20:03:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#issuecomment-1509171387",
      "id" : 1509171387,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24008",
      "node_id" : "IC_kwDOABII585Z9CC7",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1509171387/reactions"
      },
      "updated_at" : "2023-04-14T20:06:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1509171387",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1171514903"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171514903"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yep, that's a good point. Will do, thanks!",
      "commit_id" : "c7cdc7ca833ce1b5ce9a696fb4ef633c55528023",
      "created_at" : "2023-04-19T15:29:33Z",
      "diff_hunk" : "@@ -4824,6 +4824,28 @@ std::vector<Chainstate*> ChainstateManager::GetAll()\n     return out;\n }\n \n+std::vector<Chainstate*> ChainstateManager::GetAllForBlockDownload()\n+{\n+    AssertLockHeld(::cs_main);\n+    std::vector<Chainstate*> out;\n+\n+    bool snapshot_in_ibd{\n+        m_snapshot_chainstate && m_snapshot_chainstate->IsInitialBlockDownload()};\n+\n+    if (m_snapshot_chainstate) {\n+        out.push_back(m_snapshot_chainstate.get());\n+    }\n+    // Exclude the ibd chainstate (which is in the background if we have a snapshot\n+    // chainstate active) if the snapshot chainstate is in IBD because the main\n+    // priority is getting the active chain to network tip.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1171514903",
      "id" : 1171514903,
      "in_reply_to_id" : 1021024865,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585F0-YX",
      "original_commit_id" : "42f5b6b03bba1ef1c1bc6c225606d119c4e27169",
      "original_line" : 4968,
      "original_position" : 17,
      "original_start_line" : 4838,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1392348713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171514903/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-04-19T16:05:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171514903",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1171516859"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171516859"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "c7cdc7ca833ce1b5ce9a696fb4ef633c55528023",
      "created_at" : "2023-04-19T15:30:41Z",
      "diff_hunk" : "@@ -4824,6 +4824,28 @@ std::vector<Chainstate*> ChainstateManager::GetAll()\n     return out;\n }\n \n+std::vector<Chainstate*> ChainstateManager::GetAllForBlockDownload()\n+{\n+    AssertLockHeld(::cs_main);\n+    std::vector<Chainstate*> out;\n+\n+    bool snapshot_in_ibd{\n+        m_snapshot_chainstate && m_snapshot_chainstate->IsInitialBlockDownload()};\n+\n+    if (m_snapshot_chainstate) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1171516859",
      "id" : 1171516859,
      "in_reply_to_id" : 1021995519,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585F0-27",
      "original_commit_id" : "42f5b6b03bba1ef1c1bc6c225606d119c4e27169",
      "original_line" : 4963,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1392348713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171516859/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-19T16:05:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171516859",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1171516957"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171516957"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "c7cdc7ca833ce1b5ce9a696fb4ef633c55528023",
      "created_at" : "2023-04-19T15:30:46Z",
      "diff_hunk" : "@@ -4819,6 +4824,28 @@ std::vector<Chainstate*> ChainstateManager::GetAll()\n     return out;\n }\n \n+std::vector<Chainstate*> ChainstateManager::GetAllForBlockDownload()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1171516957",
      "id" : 1171516957,
      "in_reply_to_id" : 1022689304,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585F0-4d",
      "original_commit_id" : "645418e8b4d76a0c640590024452b4342802286e",
      "original_line" : 4955,
      "original_position" : 38,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1392348713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171516957/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-19T16:05:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171516957",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1171527318"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171527318"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Great catch, done.",
      "commit_id" : "c7cdc7ca833ce1b5ce9a696fb4ef633c55528023",
      "created_at" : "2023-04-19T15:38:53Z",
      "diff_hunk" : "@@ -1293,31 +1313,44 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\n     // Make sure pindexBestKnownBlock is up to date, we'll need it.\n     ProcessBlockAvailability(peer.m_id);\n \n-    if (state->pindexBestKnownBlock == nullptr || state->pindexBestKnownBlock->nChainWork < m_chainman.ActiveChain().Tip()->nChainWork || state->pindexBestKnownBlock->nChainWork < m_chainman.MinimumChainWork()) {\n+    const CChain& our_chain = chainstate->m_chain;\n+    const CBlockIndex* our_tip = our_chain.Tip();\n+\n+    if (state->pindexBestKnownBlock == nullptr\n+            || state->pindexBestKnownBlock->nChainWork < our_tip->nChainWork\n+            || state->pindexBestKnownBlock->nChainWork < m_chainman.MinimumChainWork()) {\n         // This peer has nothing interesting.\n         return;\n     }\n \n-    if (state->pindexLastCommonBlock == nullptr) {\n+    if (!state->chainstate_to_last_common_block.count(chainstate)) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1171527318",
      "id" : 1171527318,
      "in_reply_to_id" : 1021018683,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585F1BaW",
      "original_commit_id" : "c5bfecff4d0db726fab893a46cc1dab29591f325",
      "original_line" : 1339,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1392348713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171527318/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-19T16:05:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171527318",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1171527608"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171527608"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yup, good idea. Done.",
      "commit_id" : "c7cdc7ca833ce1b5ce9a696fb4ef633c55528023",
      "created_at" : "2023-04-19T15:39:07Z",
      "diff_hunk" : "@@ -889,10 +899,15 @@ class PeerManagerImpl final : public PeerManager\n \n     bool TipMayBeStale() EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n-    /** Update pindexLastCommonBlock and add not-in-flight missing successors to vBlocks, until it has\n-     *  at most count entries.\n+    /** Update chainstate_to_last_common_block and add not-in-flight missing successors\n+     * to vBlocks, until it has at most count entries.\n      */\n-    void FindNextBlocksToDownload(const Peer& peer, unsigned int count, std::vector<const CBlockIndex*>& vBlocks, NodeId& nodeStaller) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+    void FindNextBlocksToDownload(\n+        const Chainstate* const chainstate,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1171527608",
      "id" : 1171527608,
      "in_reply_to_id" : 1132286555,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585F1Be4",
      "original_commit_id" : "07ab98ecc64a39b377e20dcdd571a750ab62fd97",
      "original_line" : 906,
      "original_position" : 32,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1392348713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171527608/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-19T16:05:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171527608",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1171527697"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171527697"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done.",
      "commit_id" : "c7cdc7ca833ce1b5ce9a696fb4ef633c55528023",
      "created_at" : "2023-04-19T15:39:11Z",
      "diff_hunk" : "@@ -410,8 +410,18 @@ struct CNodeState {\n     const CBlockIndex* pindexBestKnownBlock{nullptr};\n     //! The hash of the last unknown block this peer has announced.\n     uint256 hashLastUnknownBlock{};\n-    //! The last full block we both have.\n-    const CBlockIndex* pindexLastCommonBlock{nullptr};\n+\n+    //! The last full block we both have (per chainstate).\n+    //!\n+    //! This is namespaced by chainstate to allow syncing two separate chainstates\n+    //! simultaneously from a single peer.\n+    //!\n+    //! Nota bene: this is contingent on the ChainstateManager not destructing\n+    //! any Chainstate objects which were in use at any point (e.g. a background\n+    //! validation chainstate which has completed) until the end of\n+    //! init.cpp:Shutdown(), else we'll have bad pointers here.\n+    std::map<const Chainstate*, const CBlockIndex*> chainstate_to_last_common_block = {};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1171527697",
      "id" : 1171527697,
      "in_reply_to_id" : 1133294858,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585F1BgR",
      "original_commit_id" : "ed8f55b87cc6e8ce4fcb05c00829996267d39748",
      "original_line" : 423,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1392348713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171527697/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-19T16:05:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171527697",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1171531164"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171531164"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "c7cdc7ca833ce1b5ce9a696fb4ef633c55528023",
      "created_at" : "2023-04-19T15:41:52Z",
      "diff_hunk" : "@@ -5776,21 +5844,41 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         // Message: getdata (blocks)\n         //\n         std::vector<CInv> vGetData;\n-        if (CanServeBlocks(*peer) && ((sync_blocks_and_headers_from_peer && !IsLimitedPeer(*peer)) || !m_chainman.ActiveChainstate().IsInitialBlockDownload()) && state.nBlocksInFlight < MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n-            std::vector<const CBlockIndex*> vToDownload;\n-            NodeId staller = -1;\n-            FindNextBlocksToDownload(*peer, MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight, vToDownload, staller);\n-            for (const CBlockIndex *pindex : vToDownload) {\n-                uint32_t nFetchFlags = GetFetchFlags(*peer);\n-                vGetData.push_back(CInv(MSG_BLOCK | nFetchFlags, pindex->GetBlockHash()));\n-                BlockRequested(pto->GetId(), *pindex);\n-                LogPrint(BCLog::NET, \"Requesting block %s (%d) peer=%d\\n\", pindex->GetBlockHash().ToString(),\n-                    pindex->nHeight, pto->GetId());\n-            }\n-            if (state.nBlocksInFlight == 0 && staller != -1) {\n-                if (State(staller)->m_stalling_since == 0us) {\n-                    State(staller)->m_stalling_since = current_time;\n-                    LogPrint(BCLog::NET, \"Stall started peer=%d\\n\", staller);\n+\n+        // The first chainstate in line for processing will likely exhaust this\n+        // during IBD, but once it hits a tip capacity will trickle into subsequent\n+        // chainstates.\n+        unsigned int requests_available{\n+            state.nBlocksInFlight > MAX_BLOCKS_IN_TRANSIT_PER_PEER ?\n+                0U :\n+                static_cast<unsigned int>(MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight)};\n+\n+        // GetAllForBlockDownload() ensures we get blocks for the snapshot\n+        // chainstate first. It is more important to get to the network's tip\n+        // quickly than do the background validation on the snapshot.\n+        for (Chainstate* chainstate : m_chainman.GetAllForBlockDownload()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1171531164",
      "id" : 1171531164,
      "in_reply_to_id" : 1022688185,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585F1CWc",
      "original_commit_id" : "645418e8b4d76a0c640590024452b4342802286e",
      "original_line" : 5876,
      "original_position" : 291,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1392348713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171531164/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-19T16:05:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171531164",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1171549876"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171549876"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point, added.",
      "commit_id" : "c7cdc7ca833ce1b5ce9a696fb4ef633c55528023",
      "created_at" : "2023-04-19T15:57:01Z",
      "diff_hunk" : "@@ -5485,6 +5490,22 @@ SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation(\n     return SnapshotCompletionResult::SUCCESS;\n }\n \n+Chainstate& ChainstateManager::GetChainstateForNewBlock(const uint256& blockhash)\n+{\n+    AssertLockHeld(::cs_main);\n+    const auto* pblock{m_blockman.LookupBlockIndex(blockhash)};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1171549876",
      "id" : 1171549876,
      "in_reply_to_id" : 1133292021,
      "line" : 5547,
      "node_id" : "PRRC_kwDOABII585F1G60",
      "original_commit_id" : "8e4813736298c5dfc6ba96302a148293e8ecd029",
      "original_line" : 5547,
      "original_position" : 41,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 69,
      "pull_request_review_id" : 1392348713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171549876/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-19T16:05:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171549876",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1171551677"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171551677"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point, done.",
      "commit_id" : "c7cdc7ca833ce1b5ce9a696fb4ef633c55528023",
      "created_at" : "2023-04-19T15:58:30Z",
      "diff_hunk" : "@@ -5204,6 +5209,22 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     return true;\n }\n \n+Chainstate& ChainstateManager::GetChainstateForNewBlock(const uint256& blockhash)\n+{\n+    AssertLockHeld(::cs_main);\n+    const auto* pblock{m_blockman.LookupBlockIndex(blockhash)};\n+    // If pblock is null, we haven't seen the header for this block.\n+    // Because we expect to have received the headers for the IBD chain\n+    // contents before receiving blocks, this means that any block for\n+    // which we don't have headers should go in the snapshot chain.\n+    if (m_snapshot_chainstate &&\n+            (pblock == nullptr || !m_snapshot_chainstate->m_chain.Contains(pblock))) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1171551677",
      "id" : 1171551677,
      "in_reply_to_id" : 1116169293,
      "line" : 5556,
      "node_id" : "PRRC_kwDOABII585F1HW9",
      "original_commit_id" : "bf99340edefc83913116f2ef972988e016deba3d",
      "original_line" : 5556,
      "original_position" : 47,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 78,
      "pull_request_review_id" : 1392348713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171551677/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-19T16:05:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171551677",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1171552108"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171552108"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks, done.",
      "commit_id" : "c7cdc7ca833ce1b5ce9a696fb4ef633c55528023",
      "created_at" : "2023-04-19T15:58:51Z",
      "diff_hunk" : "@@ -5485,6 +5512,22 @@ SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation(\n     return SnapshotCompletionResult::SUCCESS;\n }\n \n+Chainstate& ChainstateManager::GetChainstateForNewBlock(const uint256& blockhash)\n+{\n+    AssertLockHeld(::cs_main);\n+    const auto* pblock{m_blockman.LookupBlockIndex(blockhash)};\n+    // If pblock is null, we haven't seen the header for this block.\n+    // Because we expect to have received the headers for the IBD chain\n+    // contents before receiving blocks, this means that any block for\n+    // which we don't have headers should go in the snapshot chain.\n+    if (m_snapshot_chainstate &&\n+            (pblock == nullptr || !m_snapshot_chainstate->m_chain.Contains(pblock))) {\n+        return *m_snapshot_chainstate.get();\n+    }\n+    assert(m_ibd_chainstate);\n+    return *m_ibd_chainstate.get();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1171552108",
      "id" : 1171552108,
      "in_reply_to_id" : 1132291848,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585F1Hds",
      "original_commit_id" : "07ab98ecc64a39b377e20dcdd571a750ab62fd97",
      "original_line" : 5528,
      "original_position" : 80,
      "original_start_line" : 5527,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1392348713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171552108/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2023-04-19T16:05:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171552108",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1171552243"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171552243"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Reworded.",
      "commit_id" : "c7cdc7ca833ce1b5ce9a696fb4ef633c55528023",
      "created_at" : "2023-04-19T15:58:57Z",
      "diff_hunk" : "@@ -938,6 +938,19 @@ class ChainstateManager\n     [[nodiscard]] bool ActivateSnapshot(\n         AutoFile& coins_file, const node::SnapshotMetadata& metadata, bool in_memory);\n \n+    //! Return the relevant chainstate for a new block.\n+    //!\n+    //! Because the use of UTXO snapshots requires the simultaneous maintenance\n+    //! of two chainstates, when a new block message arrives we have to decide\n+    //! which chain we should attempt to append it to.\n+    //!\n+    //! If our active chainstate hasn't seen the incoming blockhash, return that.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1171552243",
      "id" : 1171552243,
      "in_reply_to_id" : 1116158372,
      "line" : 1059,
      "node_id" : "PRRC_kwDOABII585F1Hfz",
      "original_commit_id" : "bf99340edefc83913116f2ef972988e016deba3d",
      "original_line" : 1059,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 23,
      "pull_request_review_id" : 1392348713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171552243/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-19T16:05:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171552243",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1171554198"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171554198"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "c7cdc7ca833ce1b5ce9a696fb4ef633c55528023",
      "created_at" : "2023-04-19T16:00:27Z",
      "diff_hunk" : "@@ -5302,3 +5345,25 @@ Chainstate& ChainstateManager::ActivateExistingSnapshot(CTxMemPool* mempool, uin\n     m_active_chainstate = m_snapshot_chainstate.get();\n     return *m_snapshot_chainstate;\n }\n+\n+const CBlockIndex* ChainstateManager::GetSnapshotBaseBlock() const\n+{\n+    AssertLockHeld(::cs_main);\n+    const auto blockhash_op{this->SnapshotBlockhash()};\n+    if (!blockhash_op) return nullptr;\n+    return m_blockman.LookupBlockIndex(*blockhash_op);\n+}\n+\n+std::optional<int> ChainstateManager::GetSnapshotBaseHeight() const\n+{\n+    AssertLockHeld(::cs_main);\n+    auto base{this->GetSnapshotBaseBlock()};\n+    return base ? std::make_optional(base->nHeight) : std::nullopt;\n+}\n+\n+bool ChainstateManager::IsAnyChainInIBD()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1171554198",
      "id" : 1171554198,
      "in_reply_to_id" : 1022690017,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585F1H-W",
      "original_commit_id" : "645418e8b4d76a0c640590024452b4342802286e",
      "original_line" : 5794,
      "original_position" : 106,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1392348713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171554198/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-04-19T16:05:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1171554198",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@sdaftuar did you have Current Thoughts about this approach? Trying to bridge IRC discussions to the blocking PR",
      "created_at" : "2023-05-04T20:14:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#issuecomment-1535354925",
      "id" : 1535354925,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24008",
      "node_id" : "IC_kwDOABII585bg6gt",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1535354925/reactions"
      },
      "updated_at" : "2023-05-04T20:14:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1535354925",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5767891?v=4",
         "events_url" : "https://api.github.com/users/instagibbs/events{/privacy}",
         "followers_url" : "https://api.github.com/users/instagibbs/followers",
         "following_url" : "https://api.github.com/users/instagibbs/following{/other_user}",
         "gists_url" : "https://api.github.com/users/instagibbs/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/instagibbs",
         "id" : 5767891,
         "login" : "instagibbs",
         "node_id" : "MDQ6VXNlcjU3Njc4OTE=",
         "organizations_url" : "https://api.github.com/users/instagibbs/orgs",
         "received_events_url" : "https://api.github.com/users/instagibbs/received_events",
         "repos_url" : "https://api.github.com/users/instagibbs/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/instagibbs/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/instagibbs"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1188458662"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188458662"
         }
      },
      "author_association" : "MEMBER",
      "body" : "426ebe830b3bb076182505b60233e8c8f6d35069: the `m_snapshot_chainstate` check is now redundant:  https://github.com/bitcoin/bitcoin/pull/24008/commits/426ebe830b3bb076182505b60233e8c8f6d35069#r1171549876",
      "commit_id" : "c7cdc7ca833ce1b5ce9a696fb4ef633c55528023",
      "created_at" : "2023-05-09T10:33:03Z",
      "diff_hunk" : "@@ -5515,6 +5520,29 @@ SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation(\n     return SnapshotCompletionResult::SUCCESS;\n }\n \n+Chainstate& ChainstateManager::GetChainstateForNewBlock(const uint256& blockhash)\n+{\n+    AssertLockHeld(::cs_main);\n+    // Early return to avoid unnecessary blockindex lookup when assumeutxo is not in use.\n+    if (!m_snapshot_chainstate) {\n+        return *Assert(m_ibd_chainstate);\n+    }\n+\n+    const auto* pblock{m_blockman.LookupBlockIndex(blockhash)};\n+    // If pblock is null, we haven't seen the header for this block.\n+    // Because we expect to have received the headers for the IBD chain\n+    // contents before receiving blocks, this means that any block for\n+    // which we don't have headers should go in the snapshot chain.\n+    //\n+    // Note that searching the snapshot chain (as below) implicitly searches the ibd\n+    // chain, since the former includes the latter.\n+    if (m_snapshot_chainstate &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1188458662",
      "id" : 1188458662,
      "line" : 5555,
      "node_id" : "PRRC_kwDOABII585G1nCm",
      "original_commit_id" : "426ebe830b3bb076182505b60233e8c8f6d35069",
      "original_line" : 5539,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 77,
      "pull_request_review_id" : 1418382365,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188458662/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T11:34:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188458662",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The first commit tends to confuses me, so I'll just note a clarification here. I'm not fully convinced that blocks near the tip can't end up getting processed by the background chainstate. And if they do, I'm not sure if that's bad.\r\n\r\nWhen a block comes in near the tip, we know the header so `LookupBlockIndex` will return a `pblock`. This header is _not_ contained in `m_chain`, because headers are only added to `m_chain` by `ConnectTip()`. So a potential tip block is sent to the snapshot chainstate.\r\n\r\n`m_chain` grows sequentially as the tip moves from the snapshot height onwards. Therefore is we only receive each block once, you would expect `!m_snapshot_chainstate->m_chain.Contains(pblock)` to be `true` for candidate tip blocks, and `false` for blocks from before the snapshot.\r\n\r\nBut blocks can be received multiple times (and out of order, but that doesn't seem to be a problem). Each time a block is received it triggers `ProcessNewBlock()`. Can this never be called with a block _in `m_chain`_ that is between the snapshot and the tip? What if we receive a block that we saw before and already added to `m_chain`?\r\n\r\nnet_processing calls `chainman.ProcessNewBlock` from `ProcessBlock()`, which is called two different sites: when receiving a compact block, a `BLOCKTXN` message and when receiving a `BLOCK` message. I don't think these call sites check that we already processed this block.",
      "created_at" : "2023-05-09T11:30:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#issuecomment-1539999879",
      "id" : 1539999879,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24008",
      "node_id" : "IC_kwDOABII585byoiH",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1539999879/reactions"
      },
      "updated_at" : "2023-05-09T11:30:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1539999879",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1188522463"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188522463"
         }
      },
      "author_association" : "MEMBER",
      "body" : "c7cdc7ca833ce1b5ce9a696fb4ef633c55528023: this line does more than \"add commentary\". Maybe move this to 3a7a714721a593e271ce70d4612c995968dbb0da or its own commit directly after that one?\r\n\r\nThe code comment could clarify why we care about this even for the background sync: \"with insufficient work\" -> \"with less than the minimum chain work.\"",
      "commit_id" : "c7cdc7ca833ce1b5ce9a696fb4ef633c55528023",
      "created_at" : "2023-05-09T12:29:52Z",
      "diff_hunk" : "@@ -2777,7 +2781,7 @@ void PeerManagerImpl::UpdatePeerStateForReceivedHeaders(CNode& pfrom, Peer& peer\n \n     // If we're in IBD, we want outbound peers that will serve us a useful\n     // chain. Disconnect peers that are on chains with insufficient work.\n-    if (m_chainman.ActiveChainstate().IsInitialBlockDownload() && !may_have_more_headers) {\n+    if (m_chainman.IsAnyChainInIBD() && !may_have_more_headers) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1188522463",
      "id" : 1188522463,
      "line" : 2784,
      "node_id" : "PRRC_kwDOABII585G12nf",
      "original_commit_id" : "c7cdc7ca833ce1b5ce9a696fb4ef633c55528023",
      "original_line" : 2784,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 182,
      "pull_request_review_id" : 1418514150,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188522463/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T12:51:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188522463",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> @sdaftuar did you have Current Thoughts about this approach? Trying to bridge IRC discussions to the blocking PR\r\n\r\nI was trying to come up with my own proof-of-concept to demonstrate an alternate approach before commenting, but just to get everyone up to speed on what I'm thinking:\r\n\r\n* The first commit \"validation: introduce ChainstateManager::GetChainstateForNewBlock\" seems like something we don't conceptually need. I think the underlying issue is that `AcceptBlock` should be chainstate-agnostic -- the decision to store a block on disk isn't fundamentally based on a chain tip or the utxos we have. (The reason it comes into play in the current logic is as a heuristic for anti-DoS checks.) I have a branch that refactors `AcceptBlock` and some related code into `ChainstateManager` to show what I mean.  https://github.com/bitcoin/bitcoin/compare/master...sdaftuar:bitcoin:2023-04-blockstorage\r\n* I think we can avoid parametrizing data in `net_processing` by chainstate, and thus avoid storing chainstate-pointers or making the existing download logic more complex by having it support two different download strategies at the same time. My thought is that a lot of the complexity in `FindNextBlocksToDownload` comes from being able to download blocks towards any tip that our peer has which has more work than our own. However, in the background sync case, we are only interested in download blocks towards the snapshot base block hash.  So all we need to know is whether our peer's tip contains the base block hash, and if it does, we just walk from our background chainstate tip towards that base block and look for blocks that we haven't requested yet.\r\n\r\nI don't have a branch to share yet that implements that second bullet, but I'm hoping to get to it soon.",
      "created_at" : "2023-05-09T13:05:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#issuecomment-1540089055",
      "id" : 1540089055,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24008",
      "node_id" : "IC_kwDOABII585by-Tf",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1540089055/reactions"
      },
      "updated_at" : "2023-05-09T13:05:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1540089055",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1188597311"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188597311"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8e1d9a4bedc73b1ce2124a8583df8ed78d0c48ed: nit `>=` seems more intuitive, so the else case can't be 0. ",
      "commit_id" : "ac9adf012925c770dfe523c5b57451f313cc8be5",
      "created_at" : "2023-05-09T13:25:57Z",
      "diff_hunk" : "@@ -5802,21 +5843,41 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         // Message: getdata (blocks)\n         //\n         std::vector<CInv> vGetData;\n-        if (CanServeBlocks(*peer) && ((sync_blocks_and_headers_from_peer && !IsLimitedPeer(*peer)) || !m_chainman.ActiveChainstate().IsInitialBlockDownload()) && state.nBlocksInFlight < MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n-            std::vector<const CBlockIndex*> vToDownload;\n-            NodeId staller = -1;\n-            FindNextBlocksToDownload(*peer, MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight, vToDownload, staller);\n-            for (const CBlockIndex *pindex : vToDownload) {\n-                uint32_t nFetchFlags = GetFetchFlags(*peer);\n-                vGetData.push_back(CInv(MSG_BLOCK | nFetchFlags, pindex->GetBlockHash()));\n-                BlockRequested(pto->GetId(), *pindex);\n-                LogPrint(BCLog::NET, \"Requesting block %s (%d) peer=%d\\n\", pindex->GetBlockHash().ToString(),\n-                    pindex->nHeight, pto->GetId());\n-            }\n-            if (state.nBlocksInFlight == 0 && staller != -1) {\n-                if (State(staller)->m_stalling_since == 0us) {\n-                    State(staller)->m_stalling_since = current_time;\n-                    LogPrint(BCLog::NET, \"Stall started peer=%d\\n\", staller);\n+\n+        // The first chainstate in line for processing will likely exhaust this\n+        // during IBD, but once it hits a tip capacity will trickle into subsequent\n+        // chainstates.\n+        unsigned int requests_available{\n+            state.nBlocksInFlight > MAX_BLOCKS_IN_TRANSIT_PER_PEER ?",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1188597311",
      "id" : 1188597311,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585G2I4_",
      "original_commit_id" : "8e1d9a4bedc73b1ce2124a8583df8ed78d0c48ed",
      "original_line" : 5851,
      "original_position" : 178,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1418631351,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188597311/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T14:09:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188597311",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1188619638"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188619638"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8e1d9a4bedc73b1ce2124a8583df8ed78d0c48ed: Maybe move the `CanServeBlocks(*peer)` check out of this loop (and check `< MAX_BLOCKS_IN_TRANSIT_PER_PEER` first) to make the `if` statement more readable.\r\n\r\nYou should also clarify that `|| !chainstate->IsInitialBlockDownload()` is always true for the background validation chainstate, so we never use a pruned peer for this.\r\n\r\nI'm somewhat inclined with @ryanofsky's [observation](https://github.com/bitcoin/bitcoin/pull/24008/commits/ac00102e4712af7b04fb59b0035df32d6d662d13#r1021014794) that this abstraction is a bit overkill. You could consider dropping ac00102e4712af7b04fb59b0035df32d6d662d13 and just explicitly handling the background and tip behavior here.\r\n",
      "commit_id" : "ac9adf012925c770dfe523c5b57451f313cc8be5",
      "created_at" : "2023-05-09T13:41:09Z",
      "diff_hunk" : "@@ -5802,21 +5843,41 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         // Message: getdata (blocks)\n         //\n         std::vector<CInv> vGetData;\n-        if (CanServeBlocks(*peer) && ((sync_blocks_and_headers_from_peer && !IsLimitedPeer(*peer)) || !m_chainman.ActiveChainstate().IsInitialBlockDownload()) && state.nBlocksInFlight < MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n-            std::vector<const CBlockIndex*> vToDownload;\n-            NodeId staller = -1;\n-            FindNextBlocksToDownload(*peer, MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight, vToDownload, staller);\n-            for (const CBlockIndex *pindex : vToDownload) {\n-                uint32_t nFetchFlags = GetFetchFlags(*peer);\n-                vGetData.push_back(CInv(MSG_BLOCK | nFetchFlags, pindex->GetBlockHash()));\n-                BlockRequested(pto->GetId(), *pindex);\n-                LogPrint(BCLog::NET, \"Requesting block %s (%d) peer=%d\\n\", pindex->GetBlockHash().ToString(),\n-                    pindex->nHeight, pto->GetId());\n-            }\n-            if (state.nBlocksInFlight == 0 && staller != -1) {\n-                if (State(staller)->m_stalling_since == 0us) {\n-                    State(staller)->m_stalling_since = current_time;\n-                    LogPrint(BCLog::NET, \"Stall started peer=%d\\n\", staller);\n+\n+        // The first chainstate in line for processing will likely exhaust this\n+        // during IBD, but once it hits a tip capacity will trickle into subsequent\n+        // chainstates.\n+        unsigned int requests_available{\n+            state.nBlocksInFlight > MAX_BLOCKS_IN_TRANSIT_PER_PEER ?\n+                0U :\n+                static_cast<unsigned int>(MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight)};\n+\n+        // GetAllForBlockDownload() ensures we get blocks for the snapshot\n+        // chainstate first. It is more important to get to the network's tip\n+        // quickly than do the background validation on the snapshot.\n+        for (const auto* const chainstate : m_chainman.GetAllForBlockDownload()) {\n+            if (CanServeBlocks(*peer) &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1188619638",
      "id" : 1188619638,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585G2OV2",
      "original_commit_id" : "8e1d9a4bedc73b1ce2124a8583df8ed78d0c48ed",
      "original_line" : 5859,
      "original_position" : 186,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1418631351,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188619638/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T14:09:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188619638",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1188628966"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188628966"
         }
      },
      "author_association" : "MEMBER",
      "body" : "8e1d9a4bedc73b1ce2124a8583df8ed78d0c48ed: light preference for `--requests_available` in the for loop above.",
      "commit_id" : "ac9adf012925c770dfe523c5b57451f313cc8be5",
      "created_at" : "2023-05-09T13:47:08Z",
      "diff_hunk" : "@@ -5802,21 +5843,41 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         // Message: getdata (blocks)\n         //\n         std::vector<CInv> vGetData;\n-        if (CanServeBlocks(*peer) && ((sync_blocks_and_headers_from_peer && !IsLimitedPeer(*peer)) || !m_chainman.ActiveChainstate().IsInitialBlockDownload()) && state.nBlocksInFlight < MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n-            std::vector<const CBlockIndex*> vToDownload;\n-            NodeId staller = -1;\n-            FindNextBlocksToDownload(*peer, MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight, vToDownload, staller);\n-            for (const CBlockIndex *pindex : vToDownload) {\n-                uint32_t nFetchFlags = GetFetchFlags(*peer);\n-                vGetData.push_back(CInv(MSG_BLOCK | nFetchFlags, pindex->GetBlockHash()));\n-                BlockRequested(pto->GetId(), *pindex);\n-                LogPrint(BCLog::NET, \"Requesting block %s (%d) peer=%d\\n\", pindex->GetBlockHash().ToString(),\n-                    pindex->nHeight, pto->GetId());\n-            }\n-            if (state.nBlocksInFlight == 0 && staller != -1) {\n-                if (State(staller)->m_stalling_since == 0us) {\n-                    State(staller)->m_stalling_since = current_time;\n-                    LogPrint(BCLog::NET, \"Stall started peer=%d\\n\", staller);\n+\n+        // The first chainstate in line for processing will likely exhaust this\n+        // during IBD, but once it hits a tip capacity will trickle into subsequent\n+        // chainstates.\n+        unsigned int requests_available{\n+            state.nBlocksInFlight > MAX_BLOCKS_IN_TRANSIT_PER_PEER ?\n+                0U :\n+                static_cast<unsigned int>(MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight)};\n+\n+        // GetAllForBlockDownload() ensures we get blocks for the snapshot\n+        // chainstate first. It is more important to get to the network's tip\n+        // quickly than do the background validation on the snapshot.\n+        for (const auto* const chainstate : m_chainman.GetAllForBlockDownload()) {\n+            if (CanServeBlocks(*peer) &&\n+                    ((sync_blocks_and_headers_from_peer && !IsLimitedPeer(*peer))\n+                     || !chainstate->IsInitialBlockDownload())\n+                    && state.nBlocksInFlight < MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n+                std::vector<const CBlockIndex*> vToDownload;\n+                NodeId staller = -1;\n+                FindNextBlocksToDownload(*chainstate, *peer, requests_available, vToDownload, staller);\n+\n+                for (const CBlockIndex *pindex : vToDownload) {\n+                    uint32_t nFetchFlags = GetFetchFlags(*peer);\n+                    vGetData.push_back(CInv(MSG_BLOCK | nFetchFlags, pindex->GetBlockHash()));\n+                    BlockRequested(pto->GetId(), *pindex);\n+                    LogPrint(BCLog::NET, \"Requesting block %s (%d) peer=%d\\n\", pindex->GetBlockHash().ToString(),\n+                        pindex->nHeight, pto->GetId());\n+                }\n+\n+                requests_available -= vToDownload.size();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1188628966",
      "id" : 1188628966,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585G2Qnm",
      "original_commit_id" : "8e1d9a4bedc73b1ce2124a8583df8ed78d0c48ed",
      "original_line" : 5875,
      "original_position" : 202,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1418631351,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188628966/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T14:09:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188628966",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1188629628"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188629628"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`assert(requests_available >= vToDownload.size())`  ? `FindNextBlocksToDownload` itself doesn't guarantee that, because its `vBlocks` param doesn't have to be empty.",
      "commit_id" : "ac9adf012925c770dfe523c5b57451f313cc8be5",
      "created_at" : "2023-05-09T13:47:36Z",
      "diff_hunk" : "@@ -5802,21 +5843,41 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         // Message: getdata (blocks)\n         //\n         std::vector<CInv> vGetData;\n-        if (CanServeBlocks(*peer) && ((sync_blocks_and_headers_from_peer && !IsLimitedPeer(*peer)) || !m_chainman.ActiveChainstate().IsInitialBlockDownload()) && state.nBlocksInFlight < MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n-            std::vector<const CBlockIndex*> vToDownload;\n-            NodeId staller = -1;\n-            FindNextBlocksToDownload(*peer, MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight, vToDownload, staller);\n-            for (const CBlockIndex *pindex : vToDownload) {\n-                uint32_t nFetchFlags = GetFetchFlags(*peer);\n-                vGetData.push_back(CInv(MSG_BLOCK | nFetchFlags, pindex->GetBlockHash()));\n-                BlockRequested(pto->GetId(), *pindex);\n-                LogPrint(BCLog::NET, \"Requesting block %s (%d) peer=%d\\n\", pindex->GetBlockHash().ToString(),\n-                    pindex->nHeight, pto->GetId());\n-            }\n-            if (state.nBlocksInFlight == 0 && staller != -1) {\n-                if (State(staller)->m_stalling_since == 0us) {\n-                    State(staller)->m_stalling_since = current_time;\n-                    LogPrint(BCLog::NET, \"Stall started peer=%d\\n\", staller);\n+\n+        // The first chainstate in line for processing will likely exhaust this\n+        // during IBD, but once it hits a tip capacity will trickle into subsequent\n+        // chainstates.\n+        unsigned int requests_available{\n+            state.nBlocksInFlight > MAX_BLOCKS_IN_TRANSIT_PER_PEER ?\n+                0U :\n+                static_cast<unsigned int>(MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight)};\n+\n+        // GetAllForBlockDownload() ensures we get blocks for the snapshot\n+        // chainstate first. It is more important to get to the network's tip\n+        // quickly than do the background validation on the snapshot.\n+        for (const auto* const chainstate : m_chainman.GetAllForBlockDownload()) {\n+            if (CanServeBlocks(*peer) &&\n+                    ((sync_blocks_and_headers_from_peer && !IsLimitedPeer(*peer))\n+                     || !chainstate->IsInitialBlockDownload())\n+                    && state.nBlocksInFlight < MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n+                std::vector<const CBlockIndex*> vToDownload;\n+                NodeId staller = -1;\n+                FindNextBlocksToDownload(*chainstate, *peer, requests_available, vToDownload, staller);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1188629628",
      "id" : 1188629628,
      "line" : 5889,
      "node_id" : "PRRC_kwDOABII585G2Qx8",
      "original_commit_id" : "8e1d9a4bedc73b1ce2124a8583df8ed78d0c48ed",
      "original_line" : 5889,
      "original_position" : 192,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 280,
      "pull_request_review_id" : 1418631351,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188629628/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T14:09:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188629628",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1188647774"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188647774"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Could add a TODO here to relax this for background validation. And/or explain that we expect a node with less than the minimum chainwork to still be in IBD and not willing to serve us blocks? Or that it's too much hassle to figure out which blocks they have in common with us (e.g. it's a fork-coin)?",
      "commit_id" : "ac9adf012925c770dfe523c5b57451f313cc8be5",
      "created_at" : "2023-05-09T13:59:34Z",
      "diff_hunk" : "@@ -1312,31 +1332,44 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\n     // Make sure pindexBestKnownBlock is up to date, we'll need it.\n     ProcessBlockAvailability(peer.m_id);\n \n-    if (state->pindexBestKnownBlock == nullptr || state->pindexBestKnownBlock->nChainWork < m_chainman.ActiveChain().Tip()->nChainWork || state->pindexBestKnownBlock->nChainWork < m_chainman.MinimumChainWork()) {\n+    const CChain& our_chain = chainstate.m_chain;\n+    const CBlockIndex* our_tip = our_chain.Tip();\n+\n+    if (state->pindexBestKnownBlock == nullptr\n+            || state->pindexBestKnownBlock->nChainWork < our_tip->nChainWork\n+            || state->pindexBestKnownBlock->nChainWork < m_chainman.MinimumChainWork()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1188647774",
      "id" : 1188647774,
      "line" : 1341,
      "node_id" : "PRRC_kwDOABII585G2VNe",
      "original_commit_id" : "8e1d9a4bedc73b1ce2124a8583df8ed78d0c48ed",
      "original_line" : 1341,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 76,
      "pull_request_review_id" : 1418631351,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188647774/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T14:09:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1188647774",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1189036219"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189036219"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Hmm, would we relax this for background validation? I don't really see why. Recall that \"our_tip\" is referring to the tip of the chainstate we're working on (could be background) and not our network tip.",
      "commit_id" : "ac9adf012925c770dfe523c5b57451f313cc8be5",
      "created_at" : "2023-05-09T19:14:56Z",
      "diff_hunk" : "@@ -1312,31 +1332,44 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\n     // Make sure pindexBestKnownBlock is up to date, we'll need it.\n     ProcessBlockAvailability(peer.m_id);\n \n-    if (state->pindexBestKnownBlock == nullptr || state->pindexBestKnownBlock->nChainWork < m_chainman.ActiveChain().Tip()->nChainWork || state->pindexBestKnownBlock->nChainWork < m_chainman.MinimumChainWork()) {\n+    const CChain& our_chain = chainstate.m_chain;\n+    const CBlockIndex* our_tip = our_chain.Tip();\n+\n+    if (state->pindexBestKnownBlock == nullptr\n+            || state->pindexBestKnownBlock->nChainWork < our_tip->nChainWork\n+            || state->pindexBestKnownBlock->nChainWork < m_chainman.MinimumChainWork()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1189036219",
      "id" : 1189036219,
      "in_reply_to_id" : 1188647774,
      "line" : 1341,
      "node_id" : "PRRC_kwDOABII585G30C7",
      "original_commit_id" : "8e1d9a4bedc73b1ce2124a8583df8ed78d0c48ed",
      "original_line" : 1341,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 76,
      "pull_request_review_id" : 1419307024,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189036219/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T19:21:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189036219",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1189036653"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189036653"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed, thanks. Though I haven't updated the comment; having trouble figuring out what to say there.",
      "commit_id" : "ac9adf012925c770dfe523c5b57451f313cc8be5",
      "created_at" : "2023-05-09T19:15:23Z",
      "diff_hunk" : "@@ -2777,7 +2781,7 @@ void PeerManagerImpl::UpdatePeerStateForReceivedHeaders(CNode& pfrom, Peer& peer\n \n     // If we're in IBD, we want outbound peers that will serve us a useful\n     // chain. Disconnect peers that are on chains with insufficient work.\n-    if (m_chainman.ActiveChainstate().IsInitialBlockDownload() && !may_have_more_headers) {\n+    if (m_chainman.IsAnyChainInIBD() && !may_have_more_headers) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1189036653",
      "id" : 1189036653,
      "in_reply_to_id" : 1188522463,
      "line" : 2785,
      "node_id" : "PRRC_kwDOABII585G30Jt",
      "original_commit_id" : "c7cdc7ca833ce1b5ce9a696fb4ef633c55528023",
      "original_line" : 2785,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 182,
      "pull_request_review_id" : 1419307024,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189036653/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T19:21:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189036653",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1189039131"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189039131"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "ac9adf012925c770dfe523c5b57451f313cc8be5",
      "created_at" : "2023-05-09T19:18:08Z",
      "diff_hunk" : "@@ -5802,21 +5843,41 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         // Message: getdata (blocks)\n         //\n         std::vector<CInv> vGetData;\n-        if (CanServeBlocks(*peer) && ((sync_blocks_and_headers_from_peer && !IsLimitedPeer(*peer)) || !m_chainman.ActiveChainstate().IsInitialBlockDownload()) && state.nBlocksInFlight < MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n-            std::vector<const CBlockIndex*> vToDownload;\n-            NodeId staller = -1;\n-            FindNextBlocksToDownload(*peer, MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight, vToDownload, staller);\n-            for (const CBlockIndex *pindex : vToDownload) {\n-                uint32_t nFetchFlags = GetFetchFlags(*peer);\n-                vGetData.push_back(CInv(MSG_BLOCK | nFetchFlags, pindex->GetBlockHash()));\n-                BlockRequested(pto->GetId(), *pindex);\n-                LogPrint(BCLog::NET, \"Requesting block %s (%d) peer=%d\\n\", pindex->GetBlockHash().ToString(),\n-                    pindex->nHeight, pto->GetId());\n-            }\n-            if (state.nBlocksInFlight == 0 && staller != -1) {\n-                if (State(staller)->m_stalling_since == 0us) {\n-                    State(staller)->m_stalling_since = current_time;\n-                    LogPrint(BCLog::NET, \"Stall started peer=%d\\n\", staller);\n+\n+        // The first chainstate in line for processing will likely exhaust this\n+        // during IBD, but once it hits a tip capacity will trickle into subsequent\n+        // chainstates.\n+        unsigned int requests_available{\n+            state.nBlocksInFlight > MAX_BLOCKS_IN_TRANSIT_PER_PEER ?",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1189039131",
      "id" : 1189039131,
      "in_reply_to_id" : 1188597311,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585G30wb",
      "original_commit_id" : "8e1d9a4bedc73b1ce2124a8583df8ed78d0c48ed",
      "original_line" : 5851,
      "original_position" : 178,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1419307024,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189039131/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T19:21:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189039131",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1189039290"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189039290"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed, and I've dropped the commit in question.",
      "commit_id" : "ac9adf012925c770dfe523c5b57451f313cc8be5",
      "created_at" : "2023-05-09T19:18:19Z",
      "diff_hunk" : "@@ -5802,21 +5843,41 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         // Message: getdata (blocks)\n         //\n         std::vector<CInv> vGetData;\n-        if (CanServeBlocks(*peer) && ((sync_blocks_and_headers_from_peer && !IsLimitedPeer(*peer)) || !m_chainman.ActiveChainstate().IsInitialBlockDownload()) && state.nBlocksInFlight < MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n-            std::vector<const CBlockIndex*> vToDownload;\n-            NodeId staller = -1;\n-            FindNextBlocksToDownload(*peer, MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight, vToDownload, staller);\n-            for (const CBlockIndex *pindex : vToDownload) {\n-                uint32_t nFetchFlags = GetFetchFlags(*peer);\n-                vGetData.push_back(CInv(MSG_BLOCK | nFetchFlags, pindex->GetBlockHash()));\n-                BlockRequested(pto->GetId(), *pindex);\n-                LogPrint(BCLog::NET, \"Requesting block %s (%d) peer=%d\\n\", pindex->GetBlockHash().ToString(),\n-                    pindex->nHeight, pto->GetId());\n-            }\n-            if (state.nBlocksInFlight == 0 && staller != -1) {\n-                if (State(staller)->m_stalling_since == 0us) {\n-                    State(staller)->m_stalling_since = current_time;\n-                    LogPrint(BCLog::NET, \"Stall started peer=%d\\n\", staller);\n+\n+        // The first chainstate in line for processing will likely exhaust this\n+        // during IBD, but once it hits a tip capacity will trickle into subsequent\n+        // chainstates.\n+        unsigned int requests_available{\n+            state.nBlocksInFlight > MAX_BLOCKS_IN_TRANSIT_PER_PEER ?\n+                0U :\n+                static_cast<unsigned int>(MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight)};\n+\n+        // GetAllForBlockDownload() ensures we get blocks for the snapshot\n+        // chainstate first. It is more important to get to the network's tip\n+        // quickly than do the background validation on the snapshot.\n+        for (const auto* const chainstate : m_chainman.GetAllForBlockDownload()) {\n+            if (CanServeBlocks(*peer) &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1189039290",
      "id" : 1189039290,
      "in_reply_to_id" : 1188619638,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585G30y6",
      "original_commit_id" : "8e1d9a4bedc73b1ce2124a8583df8ed78d0c48ed",
      "original_line" : 5859,
      "original_position" : 186,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1419307024,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189039290/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T19:21:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189039290",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1189039363"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189039363"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.\r\n",
      "commit_id" : "ac9adf012925c770dfe523c5b57451f313cc8be5",
      "created_at" : "2023-05-09T19:18:26Z",
      "diff_hunk" : "@@ -5802,21 +5843,41 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         // Message: getdata (blocks)\n         //\n         std::vector<CInv> vGetData;\n-        if (CanServeBlocks(*peer) && ((sync_blocks_and_headers_from_peer && !IsLimitedPeer(*peer)) || !m_chainman.ActiveChainstate().IsInitialBlockDownload()) && state.nBlocksInFlight < MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n-            std::vector<const CBlockIndex*> vToDownload;\n-            NodeId staller = -1;\n-            FindNextBlocksToDownload(*peer, MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight, vToDownload, staller);\n-            for (const CBlockIndex *pindex : vToDownload) {\n-                uint32_t nFetchFlags = GetFetchFlags(*peer);\n-                vGetData.push_back(CInv(MSG_BLOCK | nFetchFlags, pindex->GetBlockHash()));\n-                BlockRequested(pto->GetId(), *pindex);\n-                LogPrint(BCLog::NET, \"Requesting block %s (%d) peer=%d\\n\", pindex->GetBlockHash().ToString(),\n-                    pindex->nHeight, pto->GetId());\n-            }\n-            if (state.nBlocksInFlight == 0 && staller != -1) {\n-                if (State(staller)->m_stalling_since == 0us) {\n-                    State(staller)->m_stalling_since = current_time;\n-                    LogPrint(BCLog::NET, \"Stall started peer=%d\\n\", staller);\n+\n+        // The first chainstate in line for processing will likely exhaust this\n+        // during IBD, but once it hits a tip capacity will trickle into subsequent\n+        // chainstates.\n+        unsigned int requests_available{\n+            state.nBlocksInFlight > MAX_BLOCKS_IN_TRANSIT_PER_PEER ?\n+                0U :\n+                static_cast<unsigned int>(MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight)};\n+\n+        // GetAllForBlockDownload() ensures we get blocks for the snapshot\n+        // chainstate first. It is more important to get to the network's tip\n+        // quickly than do the background validation on the snapshot.\n+        for (const auto* const chainstate : m_chainman.GetAllForBlockDownload()) {\n+            if (CanServeBlocks(*peer) &&\n+                    ((sync_blocks_and_headers_from_peer && !IsLimitedPeer(*peer))\n+                     || !chainstate->IsInitialBlockDownload())\n+                    && state.nBlocksInFlight < MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n+                std::vector<const CBlockIndex*> vToDownload;\n+                NodeId staller = -1;\n+                FindNextBlocksToDownload(*chainstate, *peer, requests_available, vToDownload, staller);\n+\n+                for (const CBlockIndex *pindex : vToDownload) {\n+                    uint32_t nFetchFlags = GetFetchFlags(*peer);\n+                    vGetData.push_back(CInv(MSG_BLOCK | nFetchFlags, pindex->GetBlockHash()));\n+                    BlockRequested(pto->GetId(), *pindex);\n+                    LogPrint(BCLog::NET, \"Requesting block %s (%d) peer=%d\\n\", pindex->GetBlockHash().ToString(),\n+                        pindex->nHeight, pto->GetId());\n+                }\n+\n+                requests_available -= vToDownload.size();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1189039363",
      "id" : 1189039363,
      "in_reply_to_id" : 1188628966,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585G300D",
      "original_commit_id" : "8e1d9a4bedc73b1ce2124a8583df8ed78d0c48ed",
      "original_line" : 5875,
      "original_position" : 202,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : null,
      "pull_request_review_id" : 1419307024,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189039363/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T19:21:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189039363",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1189039493"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189039493"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed, but using `Assume()` because that seems safer.",
      "commit_id" : "ac9adf012925c770dfe523c5b57451f313cc8be5",
      "created_at" : "2023-05-09T19:18:36Z",
      "diff_hunk" : "@@ -5802,21 +5843,41 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n         // Message: getdata (blocks)\n         //\n         std::vector<CInv> vGetData;\n-        if (CanServeBlocks(*peer) && ((sync_blocks_and_headers_from_peer && !IsLimitedPeer(*peer)) || !m_chainman.ActiveChainstate().IsInitialBlockDownload()) && state.nBlocksInFlight < MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n-            std::vector<const CBlockIndex*> vToDownload;\n-            NodeId staller = -1;\n-            FindNextBlocksToDownload(*peer, MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight, vToDownload, staller);\n-            for (const CBlockIndex *pindex : vToDownload) {\n-                uint32_t nFetchFlags = GetFetchFlags(*peer);\n-                vGetData.push_back(CInv(MSG_BLOCK | nFetchFlags, pindex->GetBlockHash()));\n-                BlockRequested(pto->GetId(), *pindex);\n-                LogPrint(BCLog::NET, \"Requesting block %s (%d) peer=%d\\n\", pindex->GetBlockHash().ToString(),\n-                    pindex->nHeight, pto->GetId());\n-            }\n-            if (state.nBlocksInFlight == 0 && staller != -1) {\n-                if (State(staller)->m_stalling_since == 0us) {\n-                    State(staller)->m_stalling_since = current_time;\n-                    LogPrint(BCLog::NET, \"Stall started peer=%d\\n\", staller);\n+\n+        // The first chainstate in line for processing will likely exhaust this\n+        // during IBD, but once it hits a tip capacity will trickle into subsequent\n+        // chainstates.\n+        unsigned int requests_available{\n+            state.nBlocksInFlight > MAX_BLOCKS_IN_TRANSIT_PER_PEER ?\n+                0U :\n+                static_cast<unsigned int>(MAX_BLOCKS_IN_TRANSIT_PER_PEER - state.nBlocksInFlight)};\n+\n+        // GetAllForBlockDownload() ensures we get blocks for the snapshot\n+        // chainstate first. It is more important to get to the network's tip\n+        // quickly than do the background validation on the snapshot.\n+        for (const auto* const chainstate : m_chainman.GetAllForBlockDownload()) {\n+            if (CanServeBlocks(*peer) &&\n+                    ((sync_blocks_and_headers_from_peer && !IsLimitedPeer(*peer))\n+                     || !chainstate->IsInitialBlockDownload())\n+                    && state.nBlocksInFlight < MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n+                std::vector<const CBlockIndex*> vToDownload;\n+                NodeId staller = -1;\n+                FindNextBlocksToDownload(*chainstate, *peer, requests_available, vToDownload, staller);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1189039493",
      "id" : 1189039493,
      "in_reply_to_id" : 1188629628,
      "line" : 5889,
      "node_id" : "PRRC_kwDOABII585G302F",
      "original_commit_id" : "8e1d9a4bedc73b1ce2124a8583df8ed78d0c48ed",
      "original_line" : 5889,
      "original_position" : 192,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 280,
      "pull_request_review_id" : 1419307024,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189039493/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T19:21:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189039493",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1189040133"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189040133"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Fixed.",
      "commit_id" : "ac9adf012925c770dfe523c5b57451f313cc8be5",
      "created_at" : "2023-05-09T19:19:16Z",
      "diff_hunk" : "@@ -5515,6 +5520,29 @@ SnapshotCompletionResult ChainstateManager::MaybeCompleteSnapshotValidation(\n     return SnapshotCompletionResult::SUCCESS;\n }\n \n+Chainstate& ChainstateManager::GetChainstateForNewBlock(const uint256& blockhash)\n+{\n+    AssertLockHeld(::cs_main);\n+    // Early return to avoid unnecessary blockindex lookup when assumeutxo is not in use.\n+    if (!m_snapshot_chainstate) {\n+        return *Assert(m_ibd_chainstate);\n+    }\n+\n+    const auto* pblock{m_blockman.LookupBlockIndex(blockhash)};\n+    // If pblock is null, we haven't seen the header for this block.\n+    // Because we expect to have received the headers for the IBD chain\n+    // contents before receiving blocks, this means that any block for\n+    // which we don't have headers should go in the snapshot chain.\n+    //\n+    // Note that searching the snapshot chain (as below) implicitly searches the ibd\n+    // chain, since the former includes the latter.\n+    if (m_snapshot_chainstate &&",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1189040133",
      "id" : 1189040133,
      "in_reply_to_id" : 1188458662,
      "line" : null,
      "node_id" : "PRRC_kwDOABII585G31AF",
      "original_commit_id" : "426ebe830b3bb076182505b60233e8c8f6d35069",
      "original_line" : 5539,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 1419307024,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189040133/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-09T19:21:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189040133",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Also, as far as I understand it, AssumeUTXO will mess up the order of the blocks stored on disk - the first blockfiles would have the blocks between the AssumeUTXO block and the tip, and the subsequent blockfiles would have the blocks between Genesis and the AssumeUTXO block. I wonder if that could break or slow down something, have you tried a reindex for example?\r\n\r\nIt's worth noting that there's a proposed remedy for this in #27596 - see https://github.com/bitcoin/bitcoin/pull/27596/commits/b29f39ecd9affdfa90e273c6e6422b5c2c04cd01. cc @mzumsande",
      "created_at" : "2023-05-09T19:24:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#issuecomment-1540768765",
      "id" : 1540768765,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24008",
      "node_id" : "IC_kwDOABII585b1kP9",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1540768765/reactions"
      },
      "updated_at" : "2023-05-09T19:24:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1540768765",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1189596088"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189596088"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I only meant the comparison to `MinimumChainWork()`. Though in practice the assume UTXO height and minimum chainwork are probably not that far apart. ",
      "commit_id" : "ac9adf012925c770dfe523c5b57451f313cc8be5",
      "created_at" : "2023-05-10T09:11:09Z",
      "diff_hunk" : "@@ -1312,31 +1332,44 @@ void PeerManagerImpl::FindNextBlocksToDownload(const Peer& peer, unsigned int co\n     // Make sure pindexBestKnownBlock is up to date, we'll need it.\n     ProcessBlockAvailability(peer.m_id);\n \n-    if (state->pindexBestKnownBlock == nullptr || state->pindexBestKnownBlock->nChainWork < m_chainman.ActiveChain().Tip()->nChainWork || state->pindexBestKnownBlock->nChainWork < m_chainman.MinimumChainWork()) {\n+    const CChain& our_chain = chainstate.m_chain;\n+    const CBlockIndex* our_tip = our_chain.Tip();\n+\n+    if (state->pindexBestKnownBlock == nullptr\n+            || state->pindexBestKnownBlock->nChainWork < our_tip->nChainWork\n+            || state->pindexBestKnownBlock->nChainWork < m_chainman.MinimumChainWork()) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#discussion_r1189596088",
      "id" : 1189596088,
      "in_reply_to_id" : 1188647774,
      "line" : 1341,
      "node_id" : "PRRC_kwDOABII585G58u4",
      "original_commit_id" : "8e1d9a4bedc73b1ce2124a8583df8ed78d0c48ed",
      "original_line" : 1341,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/net_processing.cpp",
      "position" : 76,
      "pull_request_review_id" : 1420147873,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24008",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189596088/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2023-05-10T09:12:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1189596088",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review! I'm done with nits on this one, and assumeutxo in general.",
      "created_at" : "2023-05-16T15:51:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#issuecomment-1549933311",
      "id" : 1549933311,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24008",
      "node_id" : "IC_kwDOABII585cYhr_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 1,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1549933311/reactions"
      },
      "updated_at" : "2023-05-16T15:51:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1549933311",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I wrote:\r\n> \r\n> > The first commit tends to confuses me\r\n> \r\n> Could use some thoughts on that comment (from anyone really).\r\n\r\n@Sjors I found it hard to follow that message, to be honest :D Could you maybe try to formulate more clearly what is bothering you in particular and what questions you need to be answered? It might help if you reference the specific phases you are thinking of based on `doc/design/assumeutxo.md`. I think this is the most confusing part when discussing this.",
      "created_at" : "2023-05-16T22:16:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#issuecomment-1550427767",
      "id" : 1550427767,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24008",
      "node_id" : "IC_kwDOABII585caaZ3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1550427767/reactions"
      },
      "updated_at" : "2023-05-16T22:16:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1550427767",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I guess a simpler way to phrase it is: what can go wrong if c14ae132c5a5204a9a755c84c6de05fb30459221 picks the incorrect chainstate for a block? What are all the different ways in which we can receive a block? What do we expect to happen in each of these cases? Tests would be a really nice way to illustrate that, but are apparently a pain to write for net_processing. ",
      "created_at" : "2023-05-17T08:09:20Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24008#issuecomment-1550948362",
      "id" : 1550948362,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24008",
      "node_id" : "IC_kwDOABII585ccZgK",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1550948362/reactions"
      },
      "updated_at" : "2023-05-17T08:09:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1550948362",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   }
]
