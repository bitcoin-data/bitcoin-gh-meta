[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#24008](https://github.com/bitcoin/bitcoin/pull/24008) (assumeutxo: net_processing changes by jamesob)\n* [#22485](https://github.com/bitcoin/bitcoin/pull/22485) (index: doc/log BaseIndex sync behavior with empty datadir by jamesob)\n* [#19888](https://github.com/bitcoin/bitcoin/pull/19888) (rpc, test: Improve getblockstats for unspendables by fjahr)\n* [#15606](https://github.com/bitcoin/bitcoin/pull/15606) (assumeutxo by jamesob)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2022-01-07T20:29:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24006#issuecomment-1007719572",
      "id" : 1007719572,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24006",
      "node_id" : "IC_kwDOABII5848EJSU",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1007719572/reactions"
      },
      "updated_at" : "2022-01-11T02:33:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1007719572",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24006#discussion_r781434469"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24006"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/781434469"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: `ahs` -> `has`",
      "commit_id" : "82399df1fda8e27b31379037be1493a152b7e4a0",
      "created_at" : "2022-01-10T18:16:56Z",
      "diff_hunk" : "@@ -822,6 +822,10 @@ class ChainstateManager\n         CBlockIndex** ppindex) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n     friend CChainState;\n \n+    // Returns nullptr if no snapshot ahs been loaded.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24006#discussion_r781434469",
      "id" : 781434469,
      "line" : 825,
      "node_id" : "PRRC_kwDOABII584uk75l",
      "original_commit_id" : "e50aa36a7834a56798fb679f36bc5dc1208afd24",
      "original_line" : 825,
      "original_position" : 4,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 4,
      "pull_request_review_id" : 848178476,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24006",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/781434469/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-10T18:35:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/781434469",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/24006#discussion_r781438469"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24006"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/781438469"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is a bit cryptically worded, because \"fully validated chain\" could be read as \"the background chain, but only once it's fully validated\".",
      "commit_id" : "82399df1fda8e27b31379037be1493a152b7e4a0",
      "created_at" : "2022-01-10T18:22:07Z",
      "diff_hunk" : "@@ -968,6 +968,20 @@ class ChainstateManager\n     //! ResizeCoinsCaches() as needed.\n     void MaybeRebalanceCaches() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! @returns the chainstate that indexers should consult when ensuring that an\n+    //!   index is synced with a chain where we can expect block index entries to have\n+    //!   BLOCK_HAVE_DATA beneath the tip.\n+    //!\n+    //!   In other words, give us the chainstate for which we can reasonably expect\n+    //!   that all blocks beneath the tip have been indexed. In practice this means\n+    //!   when using an assumed-valid chainstate based upon a snapshot, return only the\n+    //!   fully validated chain.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24006#discussion_r781438469",
      "id" : 781438469,
      "line" : 978,
      "node_id" : "PRRC_kwDOABII584uk84F",
      "original_commit_id" : "0975c1ff29bebfe352554ff29433d467cff517e4",
      "original_line" : 978,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/validation.h",
      "position" : 11,
      "pull_request_review_id" : 848178476,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/24006",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/781438469/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-01-10T18:35:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/781438469",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Also, doesn't MuHash in coinstatsindex require the index to be in sequence, because the hash for each block is an increment of that of the previous block? Or do we store the increment and infer the value for each block on the fly?\r\n\r\nIt works like this in the index but since the MuHash is just a representation of a UTXO set and does not commit to a previous state you can \"jump in\" at any point in the chain and calculate the MuHash at any height by looking only at the UTXO set (inefficient because the full set has to be processed) and then from this point on work with the deltas (=blocks) as usual (efficient). Because of this it is also possible to calculate the MuHash at the tip without the index, it just takes a while. I haven't looked at the code in detail yet but just skimming I think the code for this starting of the coinstatsindex at any height is not included yet, right? But since assumeutxo supplies the UTXO set and its corresponding height this should be possible to build this in a follow-up.\r\n\r\nBut I agree with Sjors' question on the conceptual level: do we really need the indices to sync already right away on the blocks between the au height and tip or is it not maybe simpler to have the indices only sync with the background chain? Syncing the blocks between au and tip first we could serve blockfilters at the tip right away, which is nice, but if there is ever an issue with an incorrect snapshot then we make it other people's problem too because we are serving incorrect blockfilters.",
      "created_at" : "2022-01-10T20:57:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24006#issuecomment-1009335207",
      "id" : 1009335207,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24006",
      "node_id" : "IC_kwDOABII5848KTun",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1009335207/reactions"
      },
      "updated_at" : "2022-01-10T23:21:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1009335207",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
         "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fjahr/followers",
         "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fjahr",
         "id" : 1322187,
         "login" : "fjahr",
         "node_id" : "MDQ6VXNlcjEzMjIxODc=",
         "organizations_url" : "https://api.github.com/users/fjahr/orgs",
         "received_events_url" : "https://api.github.com/users/fjahr/received_events",
         "repos_url" : "https://api.github.com/users/fjahr/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fjahr"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I'm confused. \r\n\r\nThe way this works as-written is that if the user starts with an empty datadir and then proceeds to load a snapshot, indexes will be built on the basis of incoming (Background)BlockConnected events that will come from both chainstates (due to the behavior documented in the unmerged https://github.com/bitcoin/bitcoin/pull/22485) - hence the lack of ordering.\r\n\r\nBut now that we're discussing it, maybe it's preferable to just defer index building until we're done with the assumed-valid chain...\r\n\r\n> Also, doesn't MuHash in coinstatsindex require the index to be in sequence, because the hash for each block is an increment of that of the previous block? Or do we store the increment and infer the value for each block on the fly? cc @fjahr\r\n\r\nGood catch! Thought I'd checked that but apparently not: https://github.com/jamesob/bitcoin/blob/e84248814296b82d926f5018dd62d917ddefe626/src/index/coinstatsindex.cpp#L118-L121\r\n\r\nA few options that come to mind:\r\n- we can defer indexation until there is are no assumed-valid chainstates in use (as @fjahr suggested as I was typing this), or\r\n- we can introduce an `m_requires_sequential` member variable to `BaseIndex` that does the above, but only for indexes that require it. This is kind of an optimized version of the first option.",
      "created_at" : "2022-01-10T21:05:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24006#issuecomment-1009341632",
      "id" : 1009341632,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24006",
      "node_id" : "IC_kwDOABII5848KVTA",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1009341632/reactions"
      },
      "updated_at" : "2022-01-10T21:05:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1009341632",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I think we can introduce `m_requires_sequential` in the future if we really want to build an index earlier. I can't see an obvious use case for that atm.",
      "created_at" : "2022-01-11T09:33:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24006#issuecomment-1009761151",
      "id" : 1009761151,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24006",
      "node_id" : "IC_kwDOABII5848L7t_",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1009761151/reactions"
      },
      "updated_at" : "2022-01-11T09:33:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1009761151",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/10217?v=4",
         "events_url" : "https://api.github.com/users/Sjors/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Sjors/followers",
         "following_url" : "https://api.github.com/users/Sjors/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Sjors/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Sjors",
         "id" : 10217,
         "login" : "Sjors",
         "node_id" : "MDQ6VXNlcjEwMjE3",
         "organizations_url" : "https://api.github.com/users/Sjors/orgs",
         "received_events_url" : "https://api.github.com/users/Sjors/received_events",
         "repos_url" : "https://api.github.com/users/Sjors/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Sjors/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Sjors"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Closing this while I work on a simpler implementation that preserves sequential indexing at the cost of deferring indexing on the assumed-valid chainstate. ",
      "created_at" : "2022-01-12T16:24:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/24006#issuecomment-1011224654",
      "id" : 1011224654,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/24006",
      "node_id" : "IC_kwDOABII5848RhBO",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1011224654/reactions"
      },
      "updated_at" : "2022-01-12T16:24:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1011224654",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/73197?v=4",
         "events_url" : "https://api.github.com/users/jamesob/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jamesob/followers",
         "following_url" : "https://api.github.com/users/jamesob/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jamesob/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jamesob",
         "id" : 73197,
         "login" : "jamesob",
         "node_id" : "MDQ6VXNlcjczMTk3",
         "organizations_url" : "https://api.github.com/users/jamesob/orgs",
         "received_events_url" : "https://api.github.com/users/jamesob/received_events",
         "repos_url" : "https://api.github.com/users/jamesob/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jamesob/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jamesob"
      }
   }
]
