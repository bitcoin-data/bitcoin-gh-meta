{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "This is the weirdest bug I have seen in a while, as I can't reproduce, but it happens persistently on a server of one of our users.\r\n\r\nI tried to delete wallet and recreate it, it doesn't work, still stuck.\r\nI tried to remove the wallet and not recreate it, and bitcoin core starts properly.\r\n\r\nI uploaded a wallet generated there: https://aois.blob.core.windows.net/public/wallet.tar.gz\r\n\r\nI tried to load the wallet on my local node (non-pruned), it works and there is no rescan.\r\n\r\n```\r\n2022-12-08T00:11:47Z No coin database inconsistencies in last 6 blocks (503 transactions)\r\n2022-12-08T00:11:47Z  block index           10522ms\r\n2022-12-08T00:11:47Z init message: Loading walletâ¦\r\n2022-12-08T00:11:47Z BerkeleyEnvironment::Open: LogDir=C:\\Users\\NicolasDorier\\tmp\\database ErrorFile=C:\\Users\\NicolasDorier\\tmp\\db.log\r\n2022-12-08T00:11:47Z [default wallet] Wallet File Version = 169900\r\n2022-12-08T00:11:47Z [default wallet] Keys: 2001 plaintext, 0 encrypted, 2001 w/ metadata, 2001 total. Unknown wallet records: 0\r\n2022-12-08T00:11:47Z [default wallet] Wallet completed loading in              60ms\r\n2022-12-08T00:11:47Z [default wallet] setKeyPool.size() = 2000\r\n2022-12-08T00:11:47Z [default wallet] mapWallet.size() = 0\r\n2022-12-08T00:11:47Z [default wallet] m_address_book.size() = 0\r\n2022-12-08T00:11:47Z Unsetting NODE_NETWORK on prune mode\r\n20\r\n```\r\n\r\n\r\nOn the server of the user the node is pruned, and there is a rescan with error\r\n\r\n```\r\n2022-12-08T00:01:33Z [default wallet] Wallet completed loading in             152ms\r\n2022-12-08T00:01:33Z Error: Prune: last wallet synchronisation goes beyond pruned data. You need to -reindex (download the whole blockchain again in case of pruned node)\r\nError: Prune: last wallet synchronisation goes beyond pruned data. You need to -reindex (download the whole blockchain again in case of pruned node)\r\n```\r\nEven though the wallet just got created.\r\n\r\nThe pruneheight should also be big enough:\r\n```bash\r\ngetblockchaininfo\r\n```\r\n```json\r\n{\r\n  \"chain\": \"test\",\r\n  \"blocks\": 2410292,\r\n  \"headers\": 2410292,\r\n  \"bestblockhash\": \"0000000000000022a51915a9d3473d6185744de708a1bf008a471e702dfc43fc\",\r\n  \"difficulty\": 82946068.46057868,\r\n  \"time\": 1670458413,\r\n  \"mediantime\": 1670455720,\r\n  \"verificationprogress\": 0.9999988037011049,\r\n  \"initialblockdownload\": false,\r\n  \"chainwork\": \"000000000000000000000000000000000000000000000839f6768de759ba571f\",\r\n  \"size_on_disk\": 8702871138,\r\n  \"pruned\": true,\r\n  \"pruneheight\": 1441677,\r\n  \"automatic_pruning\": true,\r\n  \"prune_target_size\": 104857600000,\r\n  \"warnings\": \"Unknown new rules activated (versionbit 28)\"\r\n}\r\n```\r\n\r\nAnything else I can provide you? I am really at loss about why this specific node is asking for a rescan.\r\n\r\n**Expected behavior**\r\n\r\nNode starts properly when a new wallet is just created.\r\n\r\n**Actual behavior**\r\n\r\nNode stuck\r\n\r\n```\r\n2022-12-08T00:00:24Z Bitcoin Core version v24.0.0 (release build)\r\n2022-12-08T00:00:24Z Using the 'sse4(1way),sse41(4way)' SHA256 implementation\r\n2022-12-08T00:00:24Z Default data directory /home/bitcoin/.bitcoin\r\n2022-12-08T00:00:24Z Using data directory /home/bitcoin/.bitcoin/testnet3\r\n2022-12-08T00:00:24Z Config file: /home/bitcoin/.bitcoin/bitcoin.conf\r\n2022-12-08T00:00:24Z Config file arg: testnet=\"1\"\r\n2022-12-08T00:00:24Z Config file arg: [test] maxmempool=\"500\"\r\n2022-12-08T00:00:24Z Config file arg: [test] onion=\"tor:9050\"\r\n2022-12-08T00:00:24Z Config file arg: [test] port=\"39388\"\r\n2022-12-08T00:00:24Z Config file arg: [test] printtoconsole=\"1\"\r\n2022-12-08T00:00:24Z Config file arg: [test] prune=\"100000\"\r\n2022-12-08T00:00:24Z Config file arg: [test] rpcallowip=\"::/0\"\r\n2022-12-08T00:00:24Z Config file arg: [test] rpcallowip=\"0.0.0.0/0\"\r\n2022-12-08T00:00:24Z Config file arg: [test] rpcauth=****\r\n2022-12-08T00:00:24Z Config file arg: [test] rpcauth=****\r\n2022-12-08T00:00:24Z Config file arg: [test] rpcbind=****\r\n2022-12-08T00:00:24Z Config file arg: [test] rpcport=\"43782\"\r\n2022-12-08T00:00:24Z Config file arg: [test] walletdir=\"/walletdata/testnet\"\r\n2022-12-08T00:00:24Z Config file arg: [test] whitelist=\"0.0.0.0/0\"\r\n2022-12-08T00:00:24Z Config file arg: [test] zmqpubhashblock=\"tcp://0.0.0.0:28334\"\r\n2022-12-08T00:00:24Z Config file arg: [test] zmqpubrawblock=\"tcp://0.0.0.0:28332\"\r\n2022-12-08T00:00:24Z Config file arg: [test] zmqpubrawtx=\"tcp://0.0.0.0:28333\"\r\n2022-12-08T00:00:24Z Using at most 125 automatic connections (1048576 file descriptors available)\r\n2022-12-08T00:00:24Z Using 16 MiB out of 16 MiB requested for signature cache, able to store 524288 elements\r\n2022-12-08T00:00:24Z Using 16 MiB out of 16 MiB requested for script execution cache, able to store 524288 elements\r\n2022-12-08T00:00:24Z Script verification uses 1 additional threads\r\n2022-12-08T00:00:24Z scheduler thread start\r\n2022-12-08T00:00:24Z WARNING: the RPC server is not safe to expose to untrusted networks such as the public internet\r\n2022-12-08T00:00:24Z [http] creating work queue of depth 16\r\n2022-12-08T00:00:24Z Using random cookie authentication.\r\n2022-12-08T00:00:24Z Generated RPC authentication cookie /home/bitcoin/.bitcoin/testnet3/.cookie\r\n2022-12-08T00:00:24Z Using rpcauth authentication.\r\n2022-12-08T00:00:24Z [http] starting 4 worker threads\r\n2022-12-08T00:00:24Z Using wallet directory /walletdata/testnet\r\n2022-12-08T00:00:24Z init message: Verifying wallet(s)â¦\r\n2022-12-08T00:00:24Z Using BerkeleyDB version Berkeley DB 4.8.30: (April  9, 2010)\r\n2022-12-08T00:00:24Z Using wallet /walletdata/testnet/wallet.dat\r\n2022-12-08T00:00:24Z BerkeleyEnvironment::Open: LogDir=/walletdata/testnet/database ErrorFile=/walletdata/testnet/db.log\r\n2022-12-08T00:00:24Z Using /16 prefix for IP bucketing\r\n2022-12-08T00:00:24Z init message: Loading P2P addressesâ¦\r\n2022-12-08T00:00:25Z Loaded 22930 addresses from peers.dat  393ms\r\n2022-12-08T00:00:25Z init message: Loading banlistâ¦\r\n2022-12-08T00:00:25Z SetNetworkActive: true\r\n2022-12-08T00:00:25Z Cache configuration:\r\n2022-12-08T00:00:25Z * Using 2.0 MiB for block index database\r\n2022-12-08T00:00:25Z * Using 8.0 MiB for chain state database\r\n2022-12-08T00:00:25Z * Using 440.0 MiB for in-memory UTXO set (plus up to 476.8 MiB of unused mempool space)\r\n2022-12-08T00:00:25Z init message: Loading block indexâ¦\r\n2022-12-08T00:00:25Z Assuming ancestors of block 0000000000000004877fa2d36316398528de4f347df2f8a96f76613a298ce060 have valid signatures.\r\n2022-12-08T00:00:25Z Setting nMinimumChainWork=00000000000000000000000000000000000000000000076f6e7cbd0beade5d20\r\n2022-12-08T00:00:25Z Prune configured to target 100000 MiB on disk for block and undo files.\r\n2022-12-08T00:00:25Z Switching active chainstate to Chainstate [ibd] @ height -1 (null)\r\n2022-12-08T00:00:25Z Opening LevelDB in /home/bitcoin/.bitcoin/testnet3/blocks/index\r\n2022-12-08T00:00:25Z Opened LevelDB successfully\r\n2022-12-08T00:00:25Z Using obfuscation key for /home/bitcoin/.bitcoin/testnet3/blocks/index: 0000000000000000\r\n2022-12-08T00:01:15Z LoadBlockIndexDB: last block file = 211\r\n2022-12-08T00:01:15Z LoadBlockIndexDB: last block file info: CBlockFileInfo(blocks=3150, size=89162763, heights=2407141...2410289, time=2022-11-19...2022-12-07)\r\n2022-12-08T00:01:15Z Checking all blk files are present...\r\n2022-12-08T00:01:16Z LoadBlockIndexDB(): Block files have previously been pruned\r\n2022-12-08T00:01:30Z Opening LevelDB in /home/bitcoin/.bitcoin/testnet3/chainstate\r\n2022-12-08T00:01:30Z Opened LevelDB successfully\r\n2022-12-08T00:01:30Z Using obfuscation key for /home/bitcoin/.bitcoin/testnet3/chainstate: dd2d995e0b39a1e4\r\n2022-12-08T00:01:32Z Loaded best chain: hashBestChain=000000000000002e323100923fd63334a2b4e3e087609da60e07bfcb41fc3e66 height=2410289 date=2022-12-07T23:46:07Z progress=0.999998\r\n2022-12-08T00:01:32Z init message: Verifying blocksâ¦\r\n2022-12-08T00:01:32Z Verifying last 6 blocks at level 3\r\n2022-12-08T00:01:32Z [0%]...[16%]...[33%]...[50%]...[66%]...[83%]...[99%]...[DONE].\r\n2022-12-08T00:01:32Z No coin database inconsistencies in last 6 blocks (433 transactions)\r\n2022-12-08T00:01:32Z  block index           67622ms\r\n2022-12-08T00:01:32Z init message: Loading walletâ¦\r\n2022-12-08T00:01:32Z BerkeleyEnvironment::Open: LogDir=/walletdata/testnet/database ErrorFile=/walletdata/testnet/db.log\r\n2022-12-08T00:01:32Z [default wallet] Wallet file version = 10500, last client version = 240000\r\n2022-12-08T00:01:33Z [default wallet] Keys: 2001 plaintext, 0 encrypted, 2001 w/ metadata, 2001 total. Unknown wallet records: 0\r\n2022-12-08T00:01:33Z [default wallet] Wallet completed loading in             152ms\r\n2022-12-08T00:01:33Z Error: Prune: last wallet synchronisation goes beyond pruned data. You need to -reindex (download the whole blockchain again in case of pruned node)\r\nError: Prune: last wallet synchronisation goes beyond pruned data. You need to -reindex (download the whole blockchain again in case of pruned node)\r\n2022-12-08T00:01:33Z Shutdown: In progress...\r\n2022-12-08T00:01:33Z scheduler thread exit\r\n2022-12-08T00:01:34Z Shutdown: done\r\n```\r\n\r\n**To reproduce**\r\n\r\nI can only reproduce on a single instance, I tried to reproduce on my own server and didn't managed to.\r\n\r\n```bash\r\nbitcoin-wallet \"-datadir=/walletdata/testnet\" \"-legacy\" \"-wallet=\" create\r\n```\r\n\r\nConfig\r\n\r\n```ini\r\ntestnet=1\r\n[test]\r\nwalletdir=/walletdata/testnet\r\n\r\nprinttoconsole=1\r\nrpcallowip=::/0\r\nrpcport=43782\r\nrpcbind=0.0.0.0:43782\r\nrpcallowip=0.0.0.0/0\r\nport=39388\r\nwhitelist=0.0.0.0/0\r\nmaxmempool=500\r\n\r\nprune=100000\r\nzmqpubrawblock=tcp://0.0.0.0:28332\r\nzmqpubrawtx=tcp://0.0.0.0:28333\r\nzmqpubhashblock=tcp://0.0.0.0:28334\r\n\r\nonion=tor:9050\r\n```\r\n\r\n**System information**\r\n\r\nBitcoin Core 24.0 amd64\r\nDocker Hub `btcpayserver/bitcoin:24.0`.\r\n",
   "closed_at" : "2023-01-11T00:56:45Z",
   "closed_by" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
      "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
      "followers_url" : "https://api.github.com/users/achow101/followers",
      "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/achow101",
      "id" : 3782274,
      "login" : "achow101",
      "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
      "organizations_url" : "https://api.github.com/users/achow101/orgs",
      "received_events_url" : "https://api.github.com/users/achow101/received_events",
      "repos_url" : "https://api.github.com/users/achow101/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/achow101"
   },
   "comments" : 10,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26655/comments",
   "created_at" : "2022-12-08T00:14:23Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26655/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/26655",
   "id" : 1483179042,
   "labels" : [
      {
         "color" : "FBBAAB",
         "default" : false,
         "description" : null,
         "id" : 64585,
         "name" : "Bug",
         "node_id" : "MDU6TGFiZWw2NDU4NQ==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug"
      },
      {
         "color" : "08a781",
         "default" : false,
         "description" : null,
         "id" : 149424,
         "name" : "Wallet",
         "node_id" : "MDU6TGFiZWwxNDk0MjQ=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Wallet"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26655/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "I_kwDOABII585YZ4Qi",
   "number" : 26655,
   "performed_via_github_app" : null,
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26655/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "state_reason" : "completed",
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26655/timeline",
   "title" : "Pruned node unable to start when a wallet is present",
   "updated_at" : "2023-01-11T00:56:45Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26655",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/3020646?v=4",
      "events_url" : "https://api.github.com/users/NicolasDorier/events{/privacy}",
      "followers_url" : "https://api.github.com/users/NicolasDorier/followers",
      "following_url" : "https://api.github.com/users/NicolasDorier/following{/other_user}",
      "gists_url" : "https://api.github.com/users/NicolasDorier/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/NicolasDorier",
      "id" : 3020646,
      "login" : "NicolasDorier",
      "node_id" : "MDQ6VXNlcjMwMjA2NDY=",
      "organizations_url" : "https://api.github.com/users/NicolasDorier/orgs",
      "received_events_url" : "https://api.github.com/users/NicolasDorier/received_events",
      "repos_url" : "https://api.github.com/users/NicolasDorier/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/NicolasDorier/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/NicolasDorier/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/NicolasDorier"
   }
}
