[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--021abf342d371248e50ceaed478a90ca-->\n### Reviews\nSee [the guideline](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#code-review) for information on the review process.\n| Type | Reviewers |\n| ---- | --------- |\n| ACK | [furszy](https://github.com/bitcoin/bitcoin/pull/26643#pullrequestreview-1212371832), [S3RK](https://github.com/bitcoin/bitcoin/pull/26643#issuecomment-1346027469) |\n| Stale ACK | [john-moffett](https://github.com/bitcoin/bitcoin/pull/26643#pullrequestreview-1208766983) |\n\nIf your review is incorrectly listed, please react with ð to this comment and the bot will ignore it on the next update.\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#26661](https://github.com/bitcoin/bitcoin/pull/26661) (wallet: Coin Selection, return accurate error messages by furszy)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.\n",
      "created_at" : "2022-12-05T20:41:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26643#issuecomment-1338137650",
      "id" : 1338137650,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26643",
      "node_id" : "IC_kwDOABII585Pwlwy",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1338137650/reactions"
      },
      "updated_at" : "2022-12-12T07:45:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1338137650",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26643#discussion_r1040635526"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26643"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1040635526"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Should we define it the same way as down below?\r\n\r\n```diff\r\n-CAmount current_fee = result->GetSelectedValue() - recipients_sum - change_amount;\r\n+CAmount current_fee = result->GetSelectedValue() - CalculateOutputValue(txNew);\r\n```",
      "commit_id" : "6e737685cad63af5811b7fe37d2613355f6bdc26",
      "created_at" : "2022-12-06T08:23:01Z",
      "diff_hunk" : "@@ -952,19 +958,6 @@ static util::Result<CreatedTransactionResult> CreateTransactionInternal(\n     CAmount fee_needed = coin_selection_params.m_effective_feerate.GetFee(nBytes);\n     CAmount current_fee = result->GetSelectedValue() - recipients_sum - change_amount;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26643#discussion_r1040635526",
      "id" : 1040635526,
      "line" : 959,
      "node_id" : "PRRC_kwDOABII584-BtaG",
      "original_commit_id" : "427e6f95ba9a32be7d681367d286ca08ec7674cd",
      "original_line" : 959,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 22,
      "pull_request_review_id" : 1206092411,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26643",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1040635526/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-06T08:23:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1040635526",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26643#discussion_r1040635927"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26643"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1040635927"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Have you considered making it a member of `CMutableTransaction`?",
      "commit_id" : "6e737685cad63af5811b7fe37d2613355f6bdc26",
      "created_at" : "2022-12-06T08:23:27Z",
      "diff_hunk" : "@@ -756,6 +757,11 @@ static void DiscourageFeeSniping(CMutableTransaction& tx, FastRandomContext& rng\n     }\n }\n \n+static CAmount CalculateOutputValue(const CMutableTransaction& tx)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26643#discussion_r1040635927",
      "id" : 1040635927,
      "line" : 760,
      "node_id" : "PRRC_kwDOABII584-BtgX",
      "original_commit_id" : "427e6f95ba9a32be7d681367d286ca08ec7674cd",
      "original_line" : 760,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 12,
      "pull_request_review_id" : 1206093000,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26643",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1040635927/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-06T08:23:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1040635927",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n",
      "created_at" : "2022-12-06T11:20:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26643#issuecomment-1339173275",
      "id" : 1339173275,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26643",
      "node_id" : "IC_kwDOABII585P0imb",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1339173275/reactions"
      },
      "updated_at" : "2022-12-06T11:20:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1339173275",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26643#discussion_r1043762881"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26643"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1043762881"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 1574bfa0:\r\n\r\nHmm, guess that the `CalculateOutputValue` is meant to be a guard? Because, atm, there seems to not be possible to have `recipients_sum + change_amount != CalculateOutputValue(txNew)`\r\n\r\nIf that is the case, what about adding an `Assume` here?",
      "commit_id" : "212e1497c3ab4d01a791179dc7b93236a1206d2b",
      "created_at" : "2022-12-08T19:54:01Z",
      "diff_hunk" : "@@ -959,20 +960,7 @@ static util::Result<CreatedTransactionResult> CreateTransactionInternal(\n         return util::Error{_(\"Missing solving data for estimating transaction size\")};\n     }\n     CAmount fee_needed = coin_selection_params.m_effective_feerate.GetFee(nBytes);\n-    CAmount current_fee = result->GetSelectedValue() - recipients_sum - change_amount;\n-\n-    // The only time that fee_needed should be less than the amount available for fees is when\n-    // we are subtracting the fee from the outputs. If this occurs at any other time, it is a bug.\n-    if (!coin_selection_params.m_subtract_fee_outputs && fee_needed > current_fee) {\n-        return util::Error{Untranslated(STR_INTERNAL_BUG(\"Fee needed > fee paid\"))};\n-    }\n-\n-    // If there is a change output and we overpay the fees then increase the change to match the fee needed\n-    if (nChangePosInOut != -1 && fee_needed < current_fee) {\n-        auto& change = txNew.vout.at(nChangePosInOut);\n-        change.nValue += current_fee - fee_needed;\n-        current_fee = fee_needed;\n-    }\n+    CAmount current_fee = result->GetSelectedValue() - CalculateOutputValue(txNew);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26643#discussion_r1043762881",
      "id" : 1043762881,
      "line" : 963,
      "node_id" : "PRRC_kwDOABII584-No7B",
      "original_commit_id" : "1574bfa0b600256acb0f4f50a8e84e7b01e50e3e",
      "original_line" : 963,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 26,
      "pull_request_review_id" : 1210686037,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26643",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1043762881/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-08T19:54:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1043762881",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26643#discussion_r1043825164"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26643"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1043825164"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This is probably too much but.. could `fee_needed` be lower than `current_fee`?\r\nBecause.. if that happens, `to_reduce` will be negative so instead of reducing value from the outputs, we would be adding it.",
      "commit_id" : "1f6b0fa8f5fbcdb913be9668fcdbd6fa41777cd1",
      "created_at" : "2022-12-08T21:04:00Z",
      "diff_hunk" : "@@ -960,24 +960,16 @@ static util::Result<CreatedTransactionResult> CreateTransactionInternal(\n         return util::Error{_(\"Missing solving data for estimating transaction size\")};\n     }\n     CAmount fee_needed = coin_selection_params.m_effective_feerate.GetFee(nBytes);\n-    nFeeRet = result->GetSelectedValue() - recipients_sum - change_amount;\n+    CAmount current_fee = result->GetSelectedValue() - CalculateOutputValue(txNew);\n \n-    // The only time that fee_needed should be less than the amount available for fees is when\n-    // we are subtracting the fee from the outputs. If this occurs at any other time, it is a bug.\n-    if (!coin_selection_params.m_subtract_fee_outputs && fee_needed > nFeeRet) {\n-        return util::Error{Untranslated(STR_INTERNAL_BUG(\"Fee needed > fee paid\"))};\n-    }\n-\n-    // If there is a change output and we overpay the fees then increase the change to match the fee needed\n-    if (nChangePosInOut != -1 && fee_needed < nFeeRet) {\n-        auto& change = txNew.vout.at(nChangePosInOut);\n-        change.nValue += nFeeRet - fee_needed;\n-        nFeeRet = fee_needed;\n+    // Sanity check that the fee cannot be negative as that means we have more output value than input value\n+    if (current_fee < 0) {\n+        return util::Error{Untranslated(STR_INTERNAL_BUG(\"Fee paid < 0\"))};\n     }\n \n     // Reduce output values for subtractFeeFromAmount\n     if (coin_selection_params.m_subtract_fee_outputs) {\n-        CAmount to_reduce = fee_needed - nFeeRet;\n+        CAmount to_reduce = fee_needed - current_fee;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26643#discussion_r1043825164",
      "id" : 1043825164,
      "line" : 974,
      "node_id" : "PRRC_kwDOABII584-N4IM",
      "original_commit_id" : "212e1497c3ab4d01a791179dc7b93236a1206d2b",
      "original_line" : 974,
      "original_position" : 42,
      "original_start_line" : 970,
      "path" : "src/wallet/spend.cpp",
      "position" : 44,
      "pull_request_review_id" : 1210778577,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26643",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1043825164/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 972,
      "start_side" : "RIGHT",
      "updated_at" : "2022-12-08T21:04:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1043825164",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26643#discussion_r1043834457"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26643"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1043834457"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, with a sufficiently large change output script and feerate, this is possible, and (currently) expected behavior. We test for it at spend_tests.cpp:61.",
      "commit_id" : "1f6b0fa8f5fbcdb913be9668fcdbd6fa41777cd1",
      "created_at" : "2022-12-08T21:16:57Z",
      "diff_hunk" : "@@ -960,24 +960,16 @@ static util::Result<CreatedTransactionResult> CreateTransactionInternal(\n         return util::Error{_(\"Missing solving data for estimating transaction size\")};\n     }\n     CAmount fee_needed = coin_selection_params.m_effective_feerate.GetFee(nBytes);\n-    nFeeRet = result->GetSelectedValue() - recipients_sum - change_amount;\n+    CAmount current_fee = result->GetSelectedValue() - CalculateOutputValue(txNew);\n \n-    // The only time that fee_needed should be less than the amount available for fees is when\n-    // we are subtracting the fee from the outputs. If this occurs at any other time, it is a bug.\n-    if (!coin_selection_params.m_subtract_fee_outputs && fee_needed > nFeeRet) {\n-        return util::Error{Untranslated(STR_INTERNAL_BUG(\"Fee needed > fee paid\"))};\n-    }\n-\n-    // If there is a change output and we overpay the fees then increase the change to match the fee needed\n-    if (nChangePosInOut != -1 && fee_needed < nFeeRet) {\n-        auto& change = txNew.vout.at(nChangePosInOut);\n-        change.nValue += nFeeRet - fee_needed;\n-        nFeeRet = fee_needed;\n+    // Sanity check that the fee cannot be negative as that means we have more output value than input value\n+    if (current_fee < 0) {\n+        return util::Error{Untranslated(STR_INTERNAL_BUG(\"Fee paid < 0\"))};\n     }\n \n     // Reduce output values for subtractFeeFromAmount\n     if (coin_selection_params.m_subtract_fee_outputs) {\n-        CAmount to_reduce = fee_needed - nFeeRet;\n+        CAmount to_reduce = fee_needed - current_fee;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26643#discussion_r1043834457",
      "id" : 1043834457,
      "in_reply_to_id" : 1043825164,
      "line" : 974,
      "node_id" : "PRRC_kwDOABII584-N6ZZ",
      "original_commit_id" : "212e1497c3ab4d01a791179dc7b93236a1206d2b",
      "original_line" : 974,
      "original_position" : 42,
      "original_start_line" : 970,
      "path" : "src/wallet/spend.cpp",
      "position" : 44,
      "pull_request_review_id" : 1210792754,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26643",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1043834457/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 972,
      "start_side" : "RIGHT",
      "updated_at" : "2022-12-08T21:16:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1043834457",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26643#discussion_r1043840867"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26643"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1043840867"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Done",
      "commit_id" : "1f6b0fa8f5fbcdb913be9668fcdbd6fa41777cd1",
      "created_at" : "2022-12-08T21:26:05Z",
      "diff_hunk" : "@@ -959,20 +960,7 @@ static util::Result<CreatedTransactionResult> CreateTransactionInternal(\n         return util::Error{_(\"Missing solving data for estimating transaction size\")};\n     }\n     CAmount fee_needed = coin_selection_params.m_effective_feerate.GetFee(nBytes);\n-    CAmount current_fee = result->GetSelectedValue() - recipients_sum - change_amount;\n-\n-    // The only time that fee_needed should be less than the amount available for fees is when\n-    // we are subtracting the fee from the outputs. If this occurs at any other time, it is a bug.\n-    if (!coin_selection_params.m_subtract_fee_outputs && fee_needed > current_fee) {\n-        return util::Error{Untranslated(STR_INTERNAL_BUG(\"Fee needed > fee paid\"))};\n-    }\n-\n-    // If there is a change output and we overpay the fees then increase the change to match the fee needed\n-    if (nChangePosInOut != -1 && fee_needed < current_fee) {\n-        auto& change = txNew.vout.at(nChangePosInOut);\n-        change.nValue += current_fee - fee_needed;\n-        current_fee = fee_needed;\n-    }\n+    CAmount current_fee = result->GetSelectedValue() - CalculateOutputValue(txNew);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26643#discussion_r1043840867",
      "id" : 1043840867,
      "in_reply_to_id" : 1043762881,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584-N79j",
      "original_commit_id" : "1574bfa0b600256acb0f4f50a8e84e7b01e50e3e",
      "original_line" : 963,
      "original_position" : 26,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : null,
      "pull_request_review_id" : 1210802235,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26643",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1043840867/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2022-12-08T21:26:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1043840867",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/26643#discussion_r1044455304"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26643"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1044455304"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Interesting. That is the opposite to what someone would expect from a functionality called \"subtract fee from outputs\".\r\nbut.. all good anyway, something for later.",
      "commit_id" : "1f6b0fa8f5fbcdb913be9668fcdbd6fa41777cd1",
      "created_at" : "2022-12-09T13:30:15Z",
      "diff_hunk" : "@@ -960,24 +960,16 @@ static util::Result<CreatedTransactionResult> CreateTransactionInternal(\n         return util::Error{_(\"Missing solving data for estimating transaction size\")};\n     }\n     CAmount fee_needed = coin_selection_params.m_effective_feerate.GetFee(nBytes);\n-    nFeeRet = result->GetSelectedValue() - recipients_sum - change_amount;\n+    CAmount current_fee = result->GetSelectedValue() - CalculateOutputValue(txNew);\n \n-    // The only time that fee_needed should be less than the amount available for fees is when\n-    // we are subtracting the fee from the outputs. If this occurs at any other time, it is a bug.\n-    if (!coin_selection_params.m_subtract_fee_outputs && fee_needed > nFeeRet) {\n-        return util::Error{Untranslated(STR_INTERNAL_BUG(\"Fee needed > fee paid\"))};\n-    }\n-\n-    // If there is a change output and we overpay the fees then increase the change to match the fee needed\n-    if (nChangePosInOut != -1 && fee_needed < nFeeRet) {\n-        auto& change = txNew.vout.at(nChangePosInOut);\n-        change.nValue += nFeeRet - fee_needed;\n-        nFeeRet = fee_needed;\n+    // Sanity check that the fee cannot be negative as that means we have more output value than input value\n+    if (current_fee < 0) {\n+        return util::Error{Untranslated(STR_INTERNAL_BUG(\"Fee paid < 0\"))};\n     }\n \n     // Reduce output values for subtractFeeFromAmount\n     if (coin_selection_params.m_subtract_fee_outputs) {\n-        CAmount to_reduce = fee_needed - nFeeRet;\n+        CAmount to_reduce = fee_needed - current_fee;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26643#discussion_r1044455304",
      "id" : 1044455304,
      "in_reply_to_id" : 1043825164,
      "line" : 974,
      "node_id" : "PRRC_kwDOABII584-QR-I",
      "original_commit_id" : "212e1497c3ab4d01a791179dc7b93236a1206d2b",
      "original_line" : 974,
      "original_position" : 42,
      "original_start_line" : 970,
      "path" : "src/wallet/spend.cpp",
      "position" : 44,
      "pull_request_review_id" : 1211668885,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/26643",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1044455304/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 972,
      "start_side" : "RIGHT",
      "updated_at" : "2022-12-09T13:30:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/1044455304",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Inside [8c8e173](https://github.com/bitcoin/bitcoin/commit/8c8e173852bcfcc7ece8b5b4321215a8384cd97c), you moved the change output increment due a fees overpay below the SFFO functionality. So, now if there is a fee surplus, instead of adding it to the change output first, we will add it to the recipients amount if SFFO is enabled.\r\n> (if there is an extra fee, \"fee needed\" will be lower than \"current fee\" so the SFFO `to_reduce` amount will be negative, so instead of subtract the amount we will add it to the recipients amount. Sending more coins than what the user specified to send to each SFFO enabled output instead of sending them back to us in the change output).\r\n\r\nI've flipped it back around so the order stays the same.\r\n\r\nHowever, I don't think the scenario you describe is even at all possible. The only times that `fee_needed < current_fee` is possible are if the change was small and thrown away as fees, or due to rounding errors in the fee estimates for coin selection. The the former case, the condition you mention cannot be reached because there is no change output. Because SFFO does not account for fees at all (it doesn't include any fees in the selection target and it only uses the real values during the selection algorithms), the latter case cannot be reached. Thus the scenario you describe is not possible.",
      "created_at" : "2022-12-09T20:15:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26643#issuecomment-1344742071",
      "id" : 1344742071,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26643",
      "node_id" : "IC_kwDOABII585QJyK3",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1344742071/reactions"
      },
      "updated_at" : "2022-12-09T20:15:50Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1344742071",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ok great, thanks. The noice is no longer there.\r\n\r\n>  Because SFFO does not account for fees at all (it doesn't include any fees in the selection target and it only uses the real values during the selection algorithms), the latter case cannot be reached. Thus the scenario you describe is not possible.\r\n\r\nIn that case, what about `Assume(current_fee == 0)` for SFFO?.",
      "created_at" : "2022-12-10T00:24:34Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26643#issuecomment-1344938690",
      "id" : 1344938690,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26643",
      "node_id" : "IC_kwDOABII585QKiLC",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1344938690/reactions"
      },
      "updated_at" : "2022-12-10T00:24:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1344938690",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/5377650?v=4",
         "events_url" : "https://api.github.com/users/furszy/events{/privacy}",
         "followers_url" : "https://api.github.com/users/furszy/followers",
         "following_url" : "https://api.github.com/users/furszy/following{/other_user}",
         "gists_url" : "https://api.github.com/users/furszy/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/furszy",
         "id" : 5377650,
         "login" : "furszy",
         "node_id" : "MDQ6VXNlcjUzNzc2NTA=",
         "organizations_url" : "https://api.github.com/users/furszy/orgs",
         "received_events_url" : "https://api.github.com/users/furszy/received_events",
         "repos_url" : "https://api.github.com/users/furszy/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/furszy/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/furszy/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/furszy"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Code review ACK 798430d127521d088c081ee625912a704f415990",
      "created_at" : "2022-12-12T07:45:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/26643#issuecomment-1346027469",
      "id" : 1346027469,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/26643",
      "node_id" : "IC_kwDOABII585QOr_N",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1346027469/reactions"
      },
      "updated_at" : "2022-12-12T07:45:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1346027469",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   }
]
