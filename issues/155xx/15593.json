{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "#### Issue description\r\n`addnode` RPC call takes a very long time when adding a second connection on regtest. \r\n\r\n#### Expected behaviour\r\nI'm trying to connect multiple local `bitcoind` nodes on regtest. I'm doing this through the `addnode` RPC call. I expect these connections to become active more or less instantaneously, seeing as there is almost no data to sync and no real network latency. \r\n\r\nMy flow: \r\n\r\n1) Start three `bitcoind` processes (see below for logs and config)\r\n2) `bitcoin-cli addnode localhost:<port for second node> add`\r\n3) `bitcoin-cli addnode localhost:<port for third node> add`\r\n\r\n#### Actual behavior\r\n\r\nThe first connections resolves almost immediately. The second connection takes almost one minute to complete. \r\n\r\nRelevant logs from first `bitcoind` process (the one receiving the `addnode` command): \r\n\r\n```\r\n2019-03-13T15:14:57Z ThreadRPCServer method=addnode user=__cookie__\r\n2019-03-13T15:14:59Z trying connection localhost:6666 lastseen=0.0hrs\r\n2019-03-13T15:14:59Z Added connection peer=0\r\n2019-03-13T15:14:59Z sending version (104 bytes) peer=0\r\n2019-03-13T15:14:59Z send version message: version 70015, blocks=0, us=[::]:0, peer=0\r\n2019-03-13T15:14:59Z received: version (104 bytes) peer=0\r\n2019-03-13T15:14:59Z sending verack (0 bytes) peer=0\r\n2019-03-13T15:14:59Z sending getaddr (0 bytes) peer=0\r\n2019-03-13T15:14:59Z receive version message: /Satoshi:0.17.0.1/: version 70015, blocks=0, us=[::]:0, peer=0\r\n2019-03-13T15:14:59Z added time data, samples 2, offset +0 (+0 minutes)\r\n2019-03-13T15:14:59Z received: verack (0 bytes) peer=0\r\n2019-03-13T15:14:59Z New outbound peer connected: version: 70015, blocks=0, peer=0\r\n2019-03-13T15:14:59Z sending sendheaders (0 bytes) peer=0\r\n2019-03-13T15:14:59Z sending sendcmpct (9 bytes) peer=0\r\n2019-03-13T15:14:59Z sending sendcmpct (9 bytes) peer=0\r\n2019-03-13T15:14:59Z sending ping (8 bytes) peer=0\r\n2019-03-13T15:14:59Z initial getheaders (0) to peer=0 (startheight:0)\r\n2019-03-13T15:14:59Z sending getheaders (69 bytes) peer=0\r\n2019-03-13T15:14:59Z sending feefilter (8 bytes) peer=0\r\n2019-03-13T15:14:59Z received: sendheaders (0 bytes) peer=0\r\n2019-03-13T15:14:59Z received: sendcmpct (9 bytes) peer=0\r\n2019-03-13T15:14:59Z received: sendcmpct (9 bytes) peer=0\r\n2019-03-13T15:14:59Z received: ping (8 bytes) peer=0\r\n2019-03-13T15:14:59Z sending pong (8 bytes) peer=0\r\n2019-03-13T15:14:59Z received: getheaders (69 bytes) peer=0\r\n2019-03-13T15:14:59Z Ignoring getheaders from peer=0 because node is in initial block download\r\n2019-03-13T15:14:59Z received: feefilter (8 bytes) peer=0\r\n2019-03-13T15:14:59Z received: feefilter of 0.00001000 BTC/kB from peer=0\r\n2019-03-13T15:14:59Z received: pong (8 bytes) peer=0\r\n2019-03-13T15:15:07Z ThreadRPCServer method=addnode user=__cookie__\r\n2019-03-13T15:15:42Z Adding fixed seed nodes as DNS doesn't seem to be available.\r\n2019-03-13T15:15:59Z trying connection localhost:5555 lastseen=0.0hrs\r\n2019-03-13T15:15:59Z Added connection peer=1\r\n```\r\nRelevant logs from the second node (the one being added in step 2):\r\n\r\n```\r\n2019-03-13T15:14:41Z init message: Starting network threads...\r\n2019-03-13T15:14:41Z dnsseed thread start\r\n2019-03-13T15:14:41Z Loading addresses from DNS seeds (could take a while)\r\n2019-03-13T15:14:41Z 0 addresses found from DNS seeds\r\n2019-03-13T15:14:41Z dnsseed thread exit\r\n2019-03-13T15:14:41Z init message: Done loading\r\n2019-03-13T15:14:41Z opencon thread start\r\n2019-03-13T15:14:41Z net thread start\r\n2019-03-13T15:14:41Z msghand thread start\r\n2019-03-13T15:14:41Z addcon thread start\r\n2019-03-13T15:14:59Z Added connection peer=0\r\n2019-03-13T15:14:59Z connection from 127.0.0.1:52358 accepted\r\n```\r\n\r\nRelevant logs from the third node (the one being added in step 3):\r\n```\r\n2019-03-13T15:14:41Z init message: Starting network threads...\r\n2019-03-13T15:14:41Z net thread start\r\n2019-03-13T15:14:41Z dnsseed thread start\r\n2019-03-13T15:14:41Z addcon thread start\r\n2019-03-13T15:14:41Z Loading addresses from DNS seeds (could take a while)\r\n2019-03-13T15:14:41Z 0 addresses found from DNS seeds\r\n2019-03-13T15:14:41Z opencon thread start\r\n2019-03-13T15:14:41Z init message: Done loading\r\n2019-03-13T15:14:41Z dnsseed thread exit\r\n2019-03-13T15:14:41Z msghand thread start\r\n2019-03-13T15:15:42Z Adding fixed seed nodes as DNS doesn't seem to be available.\r\n2019-03-13T15:15:59Z Added connection peer=0\r\n2019-03-13T15:15:59Z connection from 127.0.0.1:35740 accepted\r\n```\r\n<!--- How reliably can you reproduce the issue, what are the steps to do so? -->\r\n#### Reproducing\r\nI'm able to reproduce this consitently. Here's the config file for the `bitcoind` instances: \r\n\r\nFirst: \r\n```\r\nregtest=1\r\nserver=1\r\ndebug=rpc\r\ndebug=net\r\ndaemon=1\r\n\r\nrpcport=18350\r\nport=7777\r\n```\r\n\r\nSecond: \r\n```\r\nregtest=1\r\nserver=1\r\ndebug=rpc\r\ndebug=net\r\ndaemon=1\r\n\r\nrpcport=18336\r\nport=6666\r\n```\r\n\r\nThird: \r\n```\r\nregtest=1\r\nserver=1\r\ndebug=rpc\r\ndebug=net\r\ndaemon=1\r\n\r\nrpcport=18336\r\nport=6666\r\n```\r\n#### Bitcoin Core version\r\nI've been able to reproduce this issue with both 0.16.3 and 0.17.0.1. The binaries were downloaded from bitcoincore.org.\r\n\r\n#### Machine type\r\nUbuntu 18.10 x86_64\r\n",
   "closed_at" : "2019-03-27T21:15:22Z",
   "closed_by" : {
      "avatar_url" : "https://avatars2.githubusercontent.com/u/16610775?v=4",
      "events_url" : "https://api.github.com/users/torkelrogstad/events{/privacy}",
      "followers_url" : "https://api.github.com/users/torkelrogstad/followers",
      "following_url" : "https://api.github.com/users/torkelrogstad/following{/other_user}",
      "gists_url" : "https://api.github.com/users/torkelrogstad/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/torkelrogstad",
      "id" : 16610775,
      "login" : "torkelrogstad",
      "node_id" : "MDQ6VXNlcjE2NjEwNzc1",
      "organizations_url" : "https://api.github.com/users/torkelrogstad/orgs",
      "received_events_url" : "https://api.github.com/users/torkelrogstad/received_events",
      "repos_url" : "https://api.github.com/users/torkelrogstad/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/torkelrogstad/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/torkelrogstad/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/torkelrogstad"
   },
   "comments" : 2,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15593/comments",
   "created_at" : "2019-03-13T15:28:36Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15593/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/15593",
   "id" : 420564655,
   "labels" : [],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15593/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWU0MjA1NjQ2NTU=",
   "number" : 15593,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "addnode RPC call taking a long time on regtest",
   "updated_at" : "2019-03-27T21:15:22Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/15593",
   "user" : {
      "avatar_url" : "https://avatars2.githubusercontent.com/u/16610775?v=4",
      "events_url" : "https://api.github.com/users/torkelrogstad/events{/privacy}",
      "followers_url" : "https://api.github.com/users/torkelrogstad/followers",
      "following_url" : "https://api.github.com/users/torkelrogstad/following{/other_user}",
      "gists_url" : "https://api.github.com/users/torkelrogstad/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/torkelrogstad",
      "id" : 16610775,
      "login" : "torkelrogstad",
      "node_id" : "MDQ6VXNlcjE2NjEwNzc1",
      "organizations_url" : "https://api.github.com/users/torkelrogstad/orgs",
      "received_events_url" : "https://api.github.com/users/torkelrogstad/received_events",
      "repos_url" : "https://api.github.com/users/torkelrogstad/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/torkelrogstad/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/torkelrogstad/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/torkelrogstad"
   }
}
