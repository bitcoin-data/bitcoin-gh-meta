[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#22582](https://github.com/bitcoin/bitcoin/pull/22582) (test: a test to check descendant limits by ritickgoenka)\n* [#22543](https://github.com/bitcoin/bitcoin/pull/22543) (test: Use MiniWallet in mempool_limit.py by ShubhamPalriwala)\n* [#22290](https://github.com/bitcoin/bitcoin/pull/22290) (Package Mempool Submission with Package Fee-Bumping by glozow)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-04-29T05:26:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#issuecomment-828948454",
      "id" : 828948454,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21800",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDgyODk0ODQ1NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-06T17:10:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/828948454",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. Treating every transaction in the package as each other's ancestor and descendant is a good, conservative heuristic to use, since it can never underestimate the true number of ancestors/descendants. If it's too limiting, we could potentially implement looser limits in future.",
      "created_at" : "2021-06-07T17:03:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#issuecomment-856107966",
      "id" : 856107966,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21800",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1NjEwNzk2Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-07T17:03:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/856107966",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r647068181"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/647068181"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In \"[mempool] extend CalculateMemPoolAncestors for packages\"\r\n\r\nFeels a bit wrong to me to return the same \"too many (ancestors|descendants) for tx %s [limit: %u]\" error message when we're basing that conclusion on a heuristic rather than a full evaluation.  Maybe return a slightly different string like \"too many *possible* (ancestors|descendants)...\" if `total_count > 1`.  ",
      "commit_id" : "1061cf457b021ccf24f394dbb5cc00af575598ba",
      "created_at" : "2021-06-08T02:39:50Z",
      "diff_hunk" : "@@ -187,10 +201,13 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n         staged_ancestors.erase(stage);\n         totalSizeWithAncestors += stageit->GetTxSize();\n \n-        if (stageit->GetSizeWithDescendants() + entry.GetTxSize() > limitDescendantSize) {\n+        // When multiple transactions are passed in, the ancestors and descendants of all transactions\n+        // considered together must be within limits even if they are not interdependent. This may be\n+        // stricter than the limits for each individual transaction.\n+        if (stageit->GetSizeWithDescendants() + total_virtual_size > limitDescendantSize) {\n             errString = strprintf(\"exceeds descendant size limit for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString(), limitDescendantSize);\n             return false;\n-        } else if (stageit->GetCountWithDescendants() + 1 > limitDescendantCount) {\n+        } else if (stageit->GetCountWithDescendants() + total_count > limitDescendantCount) {\n             errString = strprintf(\"too many descendants for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString(), limitDescendantCount);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r647068181",
      "id" : 647068181,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NzA2ODE4MQ==",
      "original_commit_id" : "7d0e9c1970ee14032a2be3ee283511f8c85904c5",
      "original_line" : 211,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 678037341,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-08T08:40:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/647068181",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/61096?v=4",
         "events_url" : "https://api.github.com/users/harding/events{/privacy}",
         "followers_url" : "https://api.github.com/users/harding/followers",
         "following_url" : "https://api.github.com/users/harding/following{/other_user}",
         "gists_url" : "https://api.github.com/users/harding/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/harding",
         "id" : 61096,
         "login" : "harding",
         "node_id" : "MDQ6VXNlcjYxMDk2",
         "organizations_url" : "https://api.github.com/users/harding/orgs",
         "received_events_url" : "https://api.github.com/users/harding/received_events",
         "repos_url" : "https://api.github.com/users/harding/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/harding/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/harding/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/harding"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@harding thank you for the review!!!\r\n\r\n> However, the more the results returned by TMPA diverge from the results we'd get from submitting each transaction to our mempool individually, the more I think package validation should be using a different interface than individual transaction validation (e.g., a different parameter to TMPA or a different RPC altogether).\r\n\r\nI agree, and they will likely continue to diverge if we add `bypass_timelocks` and such... Perhaps we can have a regtest-only rawpackage RPC with a `test_accept` parameter (in my opinion users should never have to interact with packages)? And testmempoolaccept can be for users / L2 testing?",
      "created_at" : "2021-06-08T09:07:07Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#issuecomment-856597823",
      "id" : 856597823,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21800",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1NjU5NzgyMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-08T09:07:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/856597823",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@glozow \r\n\r\n> Perhaps we can have a regtest-only rawpackage RPC with a `test_accept` parameter (in my opinion users should never have to interact with packages)?\r\n\r\nThere's certainly no need for users to interact with packages before there's a reliable package relay mechanism, so starting with regtest-only seems like a good idea to me.  If someone later comes along with a reason it should be user-facing, they can put in the (probably trivial) amount of work to make the RPC available on mainnet and the other networks.\r\n\r\n>  And testmempoolaccept can be for users / L2 testing?\r\n\r\nFor users, yes.  I don't think anyone is using it today for L2 testing and I'm not sure it's really well suited to that---testmempoolaccept tells you whether your transaction would be accepted into the current mempool, but L2 testers really want to know whether the transaction will be accepted into a future mempool; a failure now is a reliable harbinger of failure later, but a success now doesn't guarantee success in the future (even ignoring that relay policy can be made more restrictive).",
      "created_at" : "2021-06-08T18:13:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#issuecomment-856986331",
      "id" : 856986331,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21800",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1Njk4NjMzMQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-08T18:13:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/856986331",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/61096?v=4",
         "events_url" : "https://api.github.com/users/harding/events{/privacy}",
         "followers_url" : "https://api.github.com/users/harding/followers",
         "following_url" : "https://api.github.com/users/harding/following{/other_user}",
         "gists_url" : "https://api.github.com/users/harding/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/harding",
         "id" : 61096,
         "login" : "harding",
         "node_id" : "MDQ6VXNlcjYxMDk2",
         "organizations_url" : "https://api.github.com/users/harding/orgs",
         "received_events_url" : "https://api.github.com/users/harding/received_events",
         "repos_url" : "https://api.github.com/users/harding/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/harding/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/harding/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/harding"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r648467544"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/648467544"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks, double negations are real brain teasers.",
      "commit_id" : "1061cf457b021ccf24f394dbb5cc00af575598ba",
      "created_at" : "2021-06-09T16:13:53Z",
      "diff_hunk" : "@@ -472,8 +472,10 @@ class MemPoolAccept\n          */\n         std::vector<COutPoint>& m_coins_to_uncache;\n         const bool m_test_accept;\n-        /** Disable BIP125 RBFing; disallow all conflicts with mempool transactions. */\n-        const bool disallow_mempool_conflicts;\n+        /** Whether we allow transactions to replace mempool transactions by BIP125 rules. If false,\n+         * any transaction spending the same inputs as a transaction in the mempool is considered\n+         * a conflict. */\n+        const bool m_allow_bip125_replacement{true};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r648467544",
      "id" : 648467544,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0ODQ2NzU0NA==",
      "original_commit_id" : "5496b25b6a75f3c4cd65e298f841c7e8b316046f",
      "original_line" : 478,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 679872945,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-09T23:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/648467544",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r648471295"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/648471295"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Optionally, in the same vein as @harding mentioned in his review:\r\n```suggestion\r\n                        errString = strprintf(\"potentially too many unconfirmed parents [limit: %u]\", limitAncestorCount);\r\n```",
      "commit_id" : "1061cf457b021ccf24f394dbb5cc00af575598ba",
      "created_at" : "2021-06-09T16:18:40Z",
      "diff_hunk" : "@@ -151,33 +152,46 @@ void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashes\n     }\n }\n \n-bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString, bool fSearchForParents /* = true */) const\n+bool CTxMemPool::CalculateMemPoolAncestors(const std::vector<CTxMemPoolEntry::CTxMemPoolEntryRef>& entries,\n+                                           setEntries& setAncestors,\n+                                           const uint64_t limitAncestorCount,\n+                                           const uint64_t limitAncestorSize,\n+                                           const uint64_t limitDescendantCount,\n+                                           const uint64_t limitDescendantSize,\n+                                           std::string &errString,\n+                                           const bool fSearchForParents /*=true*/) const\n {\n-    CTxMemPoolEntry::Parents staged_ancestors;\n-    const CTransaction &tx = entry.GetTx();\n+    const size_t total_virtual_size = std::accumulate(entries.cbegin(), entries.cend(), 0,\n+                                      [](int64_t sum, const auto& entry)\n+                                      { return sum + GetVirtualTransactionSize(entry.get().GetTx()); });\n+    const size_t total_count = entries.size();\n \n+    CTxMemPoolEntry::Parents staged_ancestors;\n     if (fSearchForParents) {\n-        // Get parents of this transaction that are in the mempool\n-        // GetMemPoolParents() is only valid for entries in the mempool, so we\n-        // iterate mapTx to find parents.\n-        for (unsigned int i = 0; i < tx.vin.size(); i++) {\n-            std::optional<txiter> piter = GetIter(tx.vin[i].prevout.hash);\n-            if (piter) {\n-                staged_ancestors.insert(**piter);\n-                if (staged_ancestors.size() + 1 > limitAncestorCount) {\n-                    errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n-                    return false;\n+        for (const auto& entry : entries) {\n+            // Get parents of this transaction that are in the mempool\n+            // GetMemPoolParents() is only valid for entries in the mempool, so we\n+            // iterate mapTx to find parents.\n+            for (const auto& input : entry.get().GetTx().vin) {\n+                std::optional<txiter> piter = GetIter(input.prevout.hash);\n+                if (piter) {\n+                    staged_ancestors.insert(**piter);\n+                    if (staged_ancestors.size() + total_count > limitAncestorCount) {\n+                        errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r648471295",
      "id" : 648471295,
      "line" : 180,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0ODQ3MTI5NQ==",
      "original_commit_id" : "7d0e9c1970ee14032a2be3ee283511f8c85904c5",
      "original_line" : 180,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 50,
      "pull_request_review_id" : 679872945,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-09T23:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/648471295",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> For users, yes. I don't think anyone is using it today for L2 testing and I'm not sure it's really well suited to that---testmempoolaccept tells you whether your transaction would be accepted into the current mempool, but L2 testers really want to know whether the transaction will be accepted into a future mempool; a failure now is a reliable harbinger of failure later, but a success now doesn't guarantee success in the future (even ignoring that relay policy can be made more restrictive).\r\n\r\nI'm not convinced this is true. It is impossible for L2 testers to know whether the package would be accepted into a future mempool as fee levels could theoretically be anything up to infinite. So there is nothing to test. The L2 testing would be for checking that the package would be accepted at the current fee levels (e.g. possibly just before broadcasting the package or for general testing at current fee levels) ",
      "created_at" : "2021-06-09T16:21:17Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#issuecomment-857845044",
      "id" : 857845044,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21800",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1Nzg0NTA0NA==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-09T16:23:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/857845044",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/16323900?v=4",
         "events_url" : "https://api.github.com/users/michaelfolkson/events{/privacy}",
         "followers_url" : "https://api.github.com/users/michaelfolkson/followers",
         "following_url" : "https://api.github.com/users/michaelfolkson/following{/other_user}",
         "gists_url" : "https://api.github.com/users/michaelfolkson/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/michaelfolkson",
         "id" : 16323900,
         "login" : "michaelfolkson",
         "node_id" : "MDQ6VXNlcjE2MzIzOTAw",
         "organizations_url" : "https://api.github.com/users/michaelfolkson/orgs",
         "received_events_url" : "https://api.github.com/users/michaelfolkson/received_events",
         "repos_url" : "https://api.github.com/users/michaelfolkson/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/michaelfolkson/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/michaelfolkson/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/michaelfolkson"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r648484989"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/648484989"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Is it fair to assume that all instances of `SIZE` now refer to virtualsize? Otherwise, this should perhaps be explicitly \"vsize\".",
      "commit_id" : "1061cf457b021ccf24f394dbb5cc00af575598ba",
      "created_at" : "2021-06-09T16:36:17Z",
      "diff_hunk" : "@@ -14,6 +15,7 @@\n static constexpr uint32_t MAX_PACKAGE_COUNT{25};\n /** Default maximum total virtual size of transactions in a package in KvB. */\n static constexpr uint32_t MAX_PACKAGE_SIZE{101};\n+static_assert(MAX_PACKAGE_SIZE * 4 * 1000 >= MAX_STANDARD_TX_WEIGHT);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r648484989",
      "id" : 648484989,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0ODQ4NDk4OQ==",
      "original_commit_id" : "0feb2a65e4ca55f9b469c31d3d7d94287328c5f9",
      "original_line" : 18,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/policy/packages.h",
      "position" : null,
      "pull_request_review_id" : 679872945,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-09T23:26:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/648484989",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r649073219"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/649073219"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Added a \"possibly\" to the beginning of the error strings, gated on `total_count > 1`, so that the existing tests that assert expected error messages don't need to be changed.",
      "commit_id" : "1061cf457b021ccf24f394dbb5cc00af575598ba",
      "created_at" : "2021-06-10T10:53:44Z",
      "diff_hunk" : "@@ -187,10 +201,13 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n         staged_ancestors.erase(stage);\n         totalSizeWithAncestors += stageit->GetTxSize();\n \n-        if (stageit->GetSizeWithDescendants() + entry.GetTxSize() > limitDescendantSize) {\n+        // When multiple transactions are passed in, the ancestors and descendants of all transactions\n+        // considered together must be within limits even if they are not interdependent. This may be\n+        // stricter than the limits for each individual transaction.\n+        if (stageit->GetSizeWithDescendants() + total_virtual_size > limitDescendantSize) {\n             errString = strprintf(\"exceeds descendant size limit for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString(), limitDescendantSize);\n             return false;\n-        } else if (stageit->GetCountWithDescendants() + 1 > limitDescendantCount) {\n+        } else if (stageit->GetCountWithDescendants() + total_count > limitDescendantCount) {\n             errString = strprintf(\"too many descendants for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString(), limitDescendantCount);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r649073219",
      "id" : 649073219,
      "in_reply_to_id" : 647068181,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0OTA3MzIxOQ==",
      "original_commit_id" : "7d0e9c1970ee14032a2be3ee283511f8c85904c5",
      "original_line" : 211,
      "original_position" : 86,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 680634416,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-10T10:53:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/649073219",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r649073470"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/649073470"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done, see https://github.com/bitcoin/bitcoin/pull/21800#discussion_r649073219",
      "commit_id" : "1061cf457b021ccf24f394dbb5cc00af575598ba",
      "created_at" : "2021-06-10T10:54:06Z",
      "diff_hunk" : "@@ -151,33 +152,46 @@ void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashes\n     }\n }\n \n-bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString, bool fSearchForParents /* = true */) const\n+bool CTxMemPool::CalculateMemPoolAncestors(const std::vector<CTxMemPoolEntry::CTxMemPoolEntryRef>& entries,\n+                                           setEntries& setAncestors,\n+                                           const uint64_t limitAncestorCount,\n+                                           const uint64_t limitAncestorSize,\n+                                           const uint64_t limitDescendantCount,\n+                                           const uint64_t limitDescendantSize,\n+                                           std::string &errString,\n+                                           const bool fSearchForParents /*=true*/) const\n {\n-    CTxMemPoolEntry::Parents staged_ancestors;\n-    const CTransaction &tx = entry.GetTx();\n+    const size_t total_virtual_size = std::accumulate(entries.cbegin(), entries.cend(), 0,\n+                                      [](int64_t sum, const auto& entry)\n+                                      { return sum + GetVirtualTransactionSize(entry.get().GetTx()); });\n+    const size_t total_count = entries.size();\n \n+    CTxMemPoolEntry::Parents staged_ancestors;\n     if (fSearchForParents) {\n-        // Get parents of this transaction that are in the mempool\n-        // GetMemPoolParents() is only valid for entries in the mempool, so we\n-        // iterate mapTx to find parents.\n-        for (unsigned int i = 0; i < tx.vin.size(); i++) {\n-            std::optional<txiter> piter = GetIter(tx.vin[i].prevout.hash);\n-            if (piter) {\n-                staged_ancestors.insert(**piter);\n-                if (staged_ancestors.size() + 1 > limitAncestorCount) {\n-                    errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n-                    return false;\n+        for (const auto& entry : entries) {\n+            // Get parents of this transaction that are in the mempool\n+            // GetMemPoolParents() is only valid for entries in the mempool, so we\n+            // iterate mapTx to find parents.\n+            for (const auto& input : entry.get().GetTx().vin) {\n+                std::optional<txiter> piter = GetIter(input.prevout.hash);\n+                if (piter) {\n+                    staged_ancestors.insert(**piter);\n+                    if (staged_ancestors.size() + total_count > limitAncestorCount) {\n+                        errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r649073470",
      "id" : 649073470,
      "in_reply_to_id" : 648471295,
      "line" : 180,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0OTA3MzQ3MA==",
      "original_commit_id" : "7d0e9c1970ee14032a2be3ee283511f8c85904c5",
      "original_line" : 180,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 50,
      "pull_request_review_id" : 680634737,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-10T10:54:06Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/649073470",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Incorporated doc suggestions from #22084 (to make it mergeable) and some review comments here, working on adding more edge casey tests that were discussed in PR Review Club last night.",
      "created_at" : "2021-06-10T10:55:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#issuecomment-858522666",
      "id" : 858522666,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21800",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg1ODUyMjY2Ng==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-10T10:55:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/858522666",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r649848551"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/649848551"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You may find #22097 of interest :)",
      "commit_id" : "1061cf457b021ccf24f394dbb5cc00af575598ba",
      "created_at" : "2021-06-11T09:52:37Z",
      "diff_hunk" : "@@ -14,6 +15,7 @@\n static constexpr uint32_t MAX_PACKAGE_COUNT{25};\n /** Default maximum total virtual size of transactions in a package in KvB. */\n static constexpr uint32_t MAX_PACKAGE_SIZE{101};\n+static_assert(MAX_PACKAGE_SIZE * 4 * 1000 >= MAX_STANDARD_TX_WEIGHT);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r649848551",
      "id" : 649848551,
      "in_reply_to_id" : 648484989,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0OTg0ODU1MQ==",
      "original_commit_id" : "0feb2a65e4ca55f9b469c31d3d7d94287328c5f9",
      "original_line" : 18,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/policy/packages.h",
      "position" : null,
      "pull_request_review_id" : 681656247,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-11T09:52:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/649848551",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r650579050"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650579050"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What do you think about `CalculateMemPoolAncestorsSet` to disambiguate clearly from `CalculateMemPoolAncestors` ? Also add a param comment for `entries` (and the fact they might not been inter-dependent) ?",
      "commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "created_at" : "2021-06-13T21:21:41Z",
      "diff_hunk" : "@@ -681,6 +681,29 @@ class CTxMemPool\n      */\n     bool CalculateMemPoolAncestors(const CTxMemPoolEntry& entry, setEntries& setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string& errString, bool fSearchForParents = true) const EXCLUSIVE_LOCKS_REQUIRED(cs);\n \n+    /** Try to calculate all in-mempool ancestors of a set of entries, and check for ancestor and\n+     * descendant limits (all are inclusive of the transactions in entries). The same limits are\n+     * used no matter how many transactions are passed in. For example, if entries.size() = 3 and\n+     * the limit is 25, the union of all 3 sets of ancestors must be <= 22.\n+     * @param[in,out]   setAncestors            Set of in-mempool ancestors. Updated to include\n+     *                                          any new ancestors found.\n+     * @param[in]       limitAncestorCount      Max number of txns including ancestors.\n+     * @param[in]       limitAncestorSize       Max virtual size including ancestors.\n+     * @param[in]       limitDescendantCount    Max number of txns including descendants.\n+     * @param[in]       limitDescendantSize     Max virtual size including descendants.\n+     * @param[out]      errString               Populated with error reason if a limit is hit.\n+     * @param[in]       fSearchForParents       Whether to search for entries' in-mempool parents.\n+     *                                          Must be true if any entries are not already in mempool.\n+     */\n+    bool CalculateMemPoolAncestors(const std::vector<CTxMemPoolEntry::CTxMemPoolEntryRef>& entries,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r650579050",
      "id" : 650579050,
      "line" : 703,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MDU3OTA1MA==",
      "original_commit_id" : "1061cf457b021ccf24f394dbb5cc00af575598ba",
      "original_line" : 703,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : 23,
      "pull_request_review_id" : 682446051,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-13T23:10:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650579050",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r650579493"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650579493"
         }
      },
      "author_association" : "MEMBER",
      "body" : "by \"inclusive\" do you mean \"for package limits evaluation, assume that the union of ancestors/descendants of each transaction is an ancestor/descendant of every transaction\" or something else?",
      "commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "created_at" : "2021-06-13T21:26:41Z",
      "diff_hunk" : "@@ -681,6 +681,29 @@ class CTxMemPool\n      */\n     bool CalculateMemPoolAncestors(const CTxMemPoolEntry& entry, setEntries& setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string& errString, bool fSearchForParents = true) const EXCLUSIVE_LOCKS_REQUIRED(cs);\n \n+    /** Try to calculate all in-mempool ancestors of a set of entries, and check for ancestor and\n+     * descendant limits (all are inclusive of the transactions in entries). The same limits are",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r650579493",
      "id" : 650579493,
      "line" : 685,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MDU3OTQ5Mw==",
      "original_commit_id" : "1061cf457b021ccf24f394dbb5cc00af575598ba",
      "original_line" : 685,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : 5,
      "pull_request_review_id" : 682446051,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-13T23:10:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650579493",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r650579921"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650579921"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Do you mean `PreChecks()` and under?",
      "commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "created_at" : "2021-06-13T21:30:36Z",
      "diff_hunk" : "@@ -1114,6 +1114,31 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::\n         m_viewmempool.PackageAddTransaction(ws.m_ptx);\n     }\n \n+    // Limit the scope of _entries and _ancestors. We should calculate ancestors for each\n+    // transaction individually when we call Finalize().",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r650579921",
      "id" : 650579921,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MDU3OTkyMQ==",
      "original_commit_id" : "1061cf457b021ccf24f394dbb5cc00af575598ba",
      "original_line" : 1118,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 682446051,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-13T23:10:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650579921",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r650579949"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650579949"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe `package_ancestors` to dissociate?",
      "commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "created_at" : "2021-06-13T21:30:52Z",
      "diff_hunk" : "@@ -1114,6 +1114,31 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::\n         m_viewmempool.PackageAddTransaction(ws.m_ptx);\n     }\n \n+    // Limit the scope of _entries and _ancestors. We should calculate ancestors for each\n+    // transaction individually when we call Finalize().\n+    {\n+        std::vector<CTxMemPoolEntry::CTxMemPoolEntryRef> _entries;\n+        std::transform(workspaces.cbegin(), workspaces.cend(), std::back_inserter(_entries),\n+                       [](const auto& ws) { return std::cref(*ws.m_entry); });\n+        // We won't use the set of ancestors returned for calling Finalize().\n+        CTxMemPool::setEntries _ancestors;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r650579949",
      "id" : 650579949,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MDU3OTk0OQ==",
      "original_commit_id" : "1061cf457b021ccf24f394dbb5cc00af575598ba",
      "original_line" : 1124,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 682446051,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-13T23:10:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650579949",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r650580150"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650580150"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Reject reason could be `package-ancestors/descendants limits`? I think \"too-long\" masks that it can be also a size issue.",
      "commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "created_at" : "2021-06-13T21:32:41Z",
      "diff_hunk" : "@@ -1114,6 +1114,31 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::\n         m_viewmempool.PackageAddTransaction(ws.m_ptx);\n     }\n \n+    // Limit the scope of _entries and _ancestors. We should calculate ancestors for each\n+    // transaction individually when we call Finalize().\n+    {\n+        std::vector<CTxMemPoolEntry::CTxMemPoolEntryRef> _entries;\n+        std::transform(workspaces.cbegin(), workspaces.cend(), std::back_inserter(_entries),\n+                       [](const auto& ws) { return std::cref(*ws.m_entry); });\n+        // We won't use the set of ancestors returned for calling Finalize().\n+        CTxMemPool::setEntries _ancestors;\n+        std::string err_string;\n+        if (!m_pool.CalculateMemPoolAncestors(_entries,\n+                                              _ancestors, m_limit_ancestors, m_limit_ancestor_size, m_limit_descendants,\n+                                              m_limit_descendant_size, err_string, /* fSearchForParents */ true)) {\n+            // All transactions must have individually passed mempool ancestor and descendant limits\n+            // inside of PreChecks(). Figuring out which transaction to attribute this failure to may\n+            // be implementation-dependent, and it's likely to be multiple transactions because we\n+            // evaluated all of them together. Return the same failure for all transactions.\n+            for (auto& ws : workspaces) {\n+                ws.m_state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"too-long-mempool-chain\", err_string);\n+                results.emplace(ws.m_ptx->GetWitnessHash(), MempoolAcceptResult::Failure(ws.m_state));\n+            }\n+            package_state.Invalid(PackageValidationResult::PCKG_POLICY, \"package-too-long-mempool-chain\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r650580150",
      "id" : 650580150,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MDU4MDE1MA==",
      "original_commit_id" : "1061cf457b021ccf24f394dbb5cc00af575598ba",
      "original_line" : 1137,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 682446051,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-13T23:10:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650580150",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I agree, and they will likely continue to diverge if we add bypass_timelocks and such... Perhaps we can have a regtest-only rawpackage RPC with a test_accept parameter (in my opinion users should never have to interact with packages)? And testmempoolaccept can be for users / L2 testing?\r\n\r\nSounds a good idea to introduce a `rawpackage` test-only RPC. I believe switching it to mainet is going to be function of which p2p package version we decide on (either sender-initiated or relay-initiated). W.r.t to `bypass_timelocks`/`bypass_feerate` I think that's ultimately different from the package interface as you can be interested by the mempool acceptance of individual transactions, so we can leave them on `testmempoolaccept` for now ?\r\n\r\n@michaelfolkson \r\n\r\n> I'm not convinced this is true. It is impossible for L2 testers to know whether the package would be accepted into a future mempool as fee levels could theoretically be anything up to infinite. So there is nothing to test. The L2 testing would be for checking that the package would be accepted at the current fee levels (e.g. possibly just before broadcasting the package or for general testing at current fee levels)\r\n\r\nYour point is valid, but note in #20833 we had the discussion to introduce `bypass_feerate` to remedy this pitfall (somewhere in the GH comments, yeah I know it's messy...)",
      "created_at" : "2021-06-13T23:15:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#issuecomment-860283889",
      "id" : 860283889,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21800",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MDI4Mzg4OQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-13T23:28:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/860283889",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r650994842"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650994842"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I should clarify this comment - I mean when we call `addUnchecked` in real package mempool accept, we'll need to recalculate the ancestors for each one as input",
      "commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "created_at" : "2021-06-14T14:23:44Z",
      "diff_hunk" : "@@ -1114,6 +1114,31 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::\n         m_viewmempool.PackageAddTransaction(ws.m_ptx);\n     }\n \n+    // Limit the scope of _entries and _ancestors. We should calculate ancestors for each\n+    // transaction individually when we call Finalize().",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r650994842",
      "id" : 650994842,
      "in_reply_to_id" : 650579921,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MDk5NDg0Mg==",
      "original_commit_id" : "1061cf457b021ccf24f394dbb5cc00af575598ba",
      "original_line" : 1118,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 682978497,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-14T14:23:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/650994842",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r651017757"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651017757"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "It's documenting the way we apply the limits, e.g. if `ancestorcount` is 25, it means the total number of ancestors, including itself, must be within 25.",
      "commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "created_at" : "2021-06-14T14:49:04Z",
      "diff_hunk" : "@@ -681,6 +681,29 @@ class CTxMemPool\n      */\n     bool CalculateMemPoolAncestors(const CTxMemPoolEntry& entry, setEntries& setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string& errString, bool fSearchForParents = true) const EXCLUSIVE_LOCKS_REQUIRED(cs);\n \n+    /** Try to calculate all in-mempool ancestors of a set of entries, and check for ancestor and\n+     * descendant limits (all are inclusive of the transactions in entries). The same limits are",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r651017757",
      "id" : 651017757,
      "in_reply_to_id" : 650579493,
      "line" : 685,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTAxNzc1Nw==",
      "original_commit_id" : "1061cf457b021ccf24f394dbb5cc00af575598ba",
      "original_line" : 685,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : 5,
      "pull_request_review_id" : 683009636,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-14T14:49:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651017757",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r651072189"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651072189"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "done",
      "commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "created_at" : "2021-06-14T15:52:21Z",
      "diff_hunk" : "@@ -1114,6 +1114,31 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::\n         m_viewmempool.PackageAddTransaction(ws.m_ptx);\n     }\n \n+    // Limit the scope of _entries and _ancestors. We should calculate ancestors for each\n+    // transaction individually when we call Finalize().\n+    {\n+        std::vector<CTxMemPoolEntry::CTxMemPoolEntryRef> _entries;\n+        std::transform(workspaces.cbegin(), workspaces.cend(), std::back_inserter(_entries),\n+                       [](const auto& ws) { return std::cref(*ws.m_entry); });\n+        // We won't use the set of ancestors returned for calling Finalize().\n+        CTxMemPool::setEntries _ancestors;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r651072189",
      "id" : 651072189,
      "in_reply_to_id" : 650579949,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTA3MjE4OQ==",
      "original_commit_id" : "1061cf457b021ccf24f394dbb5cc00af575598ba",
      "original_line" : 1124,
      "original_position" : 11,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 683082102,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-14T15:52:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651072189",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r651072541"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651072541"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "changed the tx error to `exceeds-ancestor-descendant-limits` and the package error `package-mempool-limits`",
      "commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "created_at" : "2021-06-14T15:52:47Z",
      "diff_hunk" : "@@ -1114,6 +1114,31 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::\n         m_viewmempool.PackageAddTransaction(ws.m_ptx);\n     }\n \n+    // Limit the scope of _entries and _ancestors. We should calculate ancestors for each\n+    // transaction individually when we call Finalize().\n+    {\n+        std::vector<CTxMemPoolEntry::CTxMemPoolEntryRef> _entries;\n+        std::transform(workspaces.cbegin(), workspaces.cend(), std::back_inserter(_entries),\n+                       [](const auto& ws) { return std::cref(*ws.m_entry); });\n+        // We won't use the set of ancestors returned for calling Finalize().\n+        CTxMemPool::setEntries _ancestors;\n+        std::string err_string;\n+        if (!m_pool.CalculateMemPoolAncestors(_entries,\n+                                              _ancestors, m_limit_ancestors, m_limit_ancestor_size, m_limit_descendants,\n+                                              m_limit_descendant_size, err_string, /* fSearchForParents */ true)) {\n+            // All transactions must have individually passed mempool ancestor and descendant limits\n+            // inside of PreChecks(). Figuring out which transaction to attribute this failure to may\n+            // be implementation-dependent, and it's likely to be multiple transactions because we\n+            // evaluated all of them together. Return the same failure for all transactions.\n+            for (auto& ws : workspaces) {\n+                ws.m_state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"too-long-mempool-chain\", err_string);\n+                results.emplace(ws.m_ptx->GetWitnessHash(), MempoolAcceptResult::Failure(ws.m_state));\n+            }\n+            package_state.Invalid(PackageValidationResult::PCKG_POLICY, \"package-too-long-mempool-chain\");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r651072541",
      "id" : 651072541,
      "in_reply_to_id" : 650580150,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTA3MjU0MQ==",
      "original_commit_id" : "1061cf457b021ccf24f394dbb5cc00af575598ba",
      "original_line" : 1137,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 683082585,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-14T15:52:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651072541",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r651073468"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651073468"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Added doxygen comment for `entries` param, but my intention was to overload the `CalculateMemPoolAncestors` function (the fact that the first argument is a vector instead of a single entry should suffice?)",
      "commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "created_at" : "2021-06-14T15:53:53Z",
      "diff_hunk" : "@@ -681,6 +681,29 @@ class CTxMemPool\n      */\n     bool CalculateMemPoolAncestors(const CTxMemPoolEntry& entry, setEntries& setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string& errString, bool fSearchForParents = true) const EXCLUSIVE_LOCKS_REQUIRED(cs);\n \n+    /** Try to calculate all in-mempool ancestors of a set of entries, and check for ancestor and\n+     * descendant limits (all are inclusive of the transactions in entries). The same limits are\n+     * used no matter how many transactions are passed in. For example, if entries.size() = 3 and\n+     * the limit is 25, the union of all 3 sets of ancestors must be <= 22.\n+     * @param[in,out]   setAncestors            Set of in-mempool ancestors. Updated to include\n+     *                                          any new ancestors found.\n+     * @param[in]       limitAncestorCount      Max number of txns including ancestors.\n+     * @param[in]       limitAncestorSize       Max virtual size including ancestors.\n+     * @param[in]       limitDescendantCount    Max number of txns including descendants.\n+     * @param[in]       limitDescendantSize     Max virtual size including descendants.\n+     * @param[out]      errString               Populated with error reason if a limit is hit.\n+     * @param[in]       fSearchForParents       Whether to search for entries' in-mempool parents.\n+     *                                          Must be true if any entries are not already in mempool.\n+     */\n+    bool CalculateMemPoolAncestors(const std::vector<CTxMemPoolEntry::CTxMemPoolEntryRef>& entries,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r651073468",
      "id" : 651073468,
      "in_reply_to_id" : 650579050,
      "line" : 703,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTA3MzQ2OA==",
      "original_commit_id" : "1061cf457b021ccf24f394dbb5cc00af575598ba",
      "original_line" : 703,
      "original_position" : 18,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : 23,
      "pull_request_review_id" : 683083800,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-14T15:53:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651073468",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r651073759"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651073759"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "fixed",
      "commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "created_at" : "2021-06-14T15:54:14Z",
      "diff_hunk" : "@@ -1114,6 +1114,31 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::\n         m_viewmempool.PackageAddTransaction(ws.m_ptx);\n     }\n \n+    // Limit the scope of _entries and _ancestors. We should calculate ancestors for each\n+    // transaction individually when we call Finalize().",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r651073759",
      "id" : 651073759,
      "in_reply_to_id" : 650579921,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1MTA3Mzc1OQ==",
      "original_commit_id" : "1061cf457b021ccf24f394dbb5cc00af575598ba",
      "original_line" : 1118,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 683084170,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-06-14T15:54:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/651073759",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@ariard thanks for the review, I'm very much looking forward to the IRC discussions to better understand what packages we want to support. In your domino bumping example, I'm not entirely sure why we couldn't use several packages of size 2 to bump them?\r\n\r\n> MAX_PACKAGE_COUNT to 2 transactions for the initial deployement of package-relay\r\n\r\nWe're still a few PRs from package accept with submission to mempool - will put some things up soon - and then a few PRs from package relay but sounds good to me. I personally believe that the P2P requirements can be more stringent than individual transaction mempool policy - I also think it's fine for peers to negotiate their maximum package size they're willing to receive in a `SENDPACKAGES` message. Starting with a default of 2 sounds good to me. However, I don't think package ancestor/descendant limits should be explicitly less than individual ones within a node, because I think it could give an adversary the chance to prevent a package from being accepted by submitting a very large descendant to the top transaction.\r\n\r\n> implementing \"intersection-dedup\" evaluation, where duplicated ancestors/descendants aren't accounted for package limits ?\r\n\r\nI'm not sure I understand, could you elaborate? The `setAncestors` used in `CalculateMemPoolAncestors()` is not duplicated between transactions. I am working on a branch to \"trim\" packages when it overlaps with mempool (i.e. one or more transactions are already in the mempool), and will add test cases for ancestor/descendant limits with it.\r\n\r\n(Recent push addresses inline review comments)",
      "created_at" : "2021-06-14T17:08:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#issuecomment-860846503",
      "id" : 860846503,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21800",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MDg0NjUwMw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-14T17:08:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/860846503",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> If you already have {A,B,C,D} in the mempools, and try to broadcast {E,F,G,H,I,J,K,L) in a single package it's going to be rejected (4 * 8 > DEFAULT_ANCESTOR_LIMITS), though if you broadcast components by pair, it will be accepted.\r\n\r\n@ariard: I don't understand the reasoning that leads to \"4 * 8\" here.",
      "created_at" : "2021-06-16T18:34:35Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#issuecomment-862616983",
      "id" : 862616983,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21800",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg2MjYxNjk4Mw==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-06-16T18:34:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/862616983",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Bump, this is the next step for package validation logic.\r\n\r\nThe heuristic used in this implementation still results in an exact calculation of in-mempool and in-package ancestors for packages of parent + child (the MVP/basic package use case as discussed in the IRC meetings). It can be slightly more restrictive in scenarios such as batched fee bumping, but is extensible if we want to implement something more granular in the future.",
      "created_at" : "2021-07-06T16:49:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#issuecomment-874921861",
      "id" : 874921861,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21800",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDg3NDkyMTg2MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-06T16:49:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/874921861",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665238840"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665238840"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This generic helper function is used for more than mempool acceptance (eg the `getmempoolancestors` RPC calls `CalculateMempoolAncestors(const CTxMemPoolEntry& entry, ...)`, which calls `CalculateMemPoolAncestors(const std::vector<CTxMemPoolEntry::CTxMemPoolEntryRef>& entries, ...)`. I suggest you remove the reference to \"acceptance to mempool\" here.",
      "commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "created_at" : "2021-07-07T10:17:29Z",
      "diff_hunk" : "@@ -681,6 +681,34 @@ class CTxMemPool\n      */\n     bool CalculateMemPoolAncestors(const CTxMemPoolEntry& entry, setEntries& setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string& errString, bool fSearchForParents = true) const EXCLUSIVE_LOCKS_REQUIRED(cs);\n \n+    /** Try to calculate all in-mempool ancestors of a set of entries, and check for ancestor and\n+     * descendant limits (all are inclusive of the transactions in entries). The same limits are\n+     * used no matter how many transactions are passed in. For example, if entries.size() = 3 and\n+     * the limit is 25, the union of all 3 sets of ancestors must be <= 22.\n+     * @param[in]       entries                 Entries corresponding to transaction(s) being\n+     *                                          evaluated for acceptance to mempool. If there are",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665238840",
      "id" : 665238840,
      "line" : 689,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTIzODg0MA==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 689,
      "original_position" : 9,
      "original_start_line" : 688,
      "path" : "src/txmempool.h",
      "position" : 9,
      "pull_request_review_id" : 700830368,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : 688,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-07T11:21:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665238840",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665239317"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665239317"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't understand the \"if there are multiple\" part of this sentence. This function can be called with a single tx, and in that case the tx must not already be in the mempool.",
      "commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "created_at" : "2021-07-07T10:18:12Z",
      "diff_hunk" : "@@ -681,6 +681,34 @@ class CTxMemPool\n      */\n     bool CalculateMemPoolAncestors(const CTxMemPoolEntry& entry, setEntries& setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string& errString, bool fSearchForParents = true) const EXCLUSIVE_LOCKS_REQUIRED(cs);\n \n+    /** Try to calculate all in-mempool ancestors of a set of entries, and check for ancestor and\n+     * descendant limits (all are inclusive of the transactions in entries). The same limits are\n+     * used no matter how many transactions are passed in. For example, if entries.size() = 3 and\n+     * the limit is 25, the union of all 3 sets of ancestors must be <= 22.\n+     * @param[in]       entries                 Entries corresponding to transaction(s) being\n+     *                                          evaluated for acceptance to mempool. If there are\n+     *                                          multiple, they must not already be in the mempool.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665239317",
      "id" : 665239317,
      "line" : 690,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTIzOTMxNw==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 690,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : 10,
      "pull_request_review_id" : 700830368,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T11:21:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665239317",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665240182"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665240182"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this is actually just an out param. The caller shouldn't be calling this function with `setAncestors` already populated. Perhaps an assert should be added to the top of the function that `setAncestors` is empty?",
      "commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "created_at" : "2021-07-07T10:19:32Z",
      "diff_hunk" : "@@ -681,6 +681,34 @@ class CTxMemPool\n      */\n     bool CalculateMemPoolAncestors(const CTxMemPoolEntry& entry, setEntries& setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string& errString, bool fSearchForParents = true) const EXCLUSIVE_LOCKS_REQUIRED(cs);\n \n+    /** Try to calculate all in-mempool ancestors of a set of entries, and check for ancestor and\n+     * descendant limits (all are inclusive of the transactions in entries). The same limits are\n+     * used no matter how many transactions are passed in. For example, if entries.size() = 3 and\n+     * the limit is 25, the union of all 3 sets of ancestors must be <= 22.\n+     * @param[in]       entries                 Entries corresponding to transaction(s) being\n+     *                                          evaluated for acceptance to mempool. If there are\n+     *                                          multiple, they must not already be in the mempool.\n+     *                                          They need not be direct ancestors/descendants of\n+     *                                          each other, though they will be treated as such.\n+     * @param[in,out]   setAncestors            Set of in-mempool ancestors. Updated to include\n+     *                                          any new ancestors found.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665240182",
      "id" : 665240182,
      "line" : 694,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTI0MDE4Mg==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 694,
      "original_position" : 14,
      "original_start_line" : 693,
      "path" : "src/txmempool.h",
      "position" : 14,
      "pull_request_review_id" : 700830368,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : 693,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-07T11:21:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665240182",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665258130"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665258130"
         }
      },
      "author_association" : "MEMBER",
      "body" : "There's a silent merge conflict with master: `CTransaction` is no longer imported into rpc_packages.py (since 2ce7b47958c4a10ba20dc86c011d71cda4b070a5).\r\n\r\nThis should fix it:\r\n\r\n```diff\r\ndiff --git a/test/functional/rpc_packages.py b/test/functional/rpc_packages.py\r\nindex 447c3cb08f..a084d0d9cb 100755\r\n--- a/test/functional/rpc_packages.py\r\n+++ b/test/functional/rpc_packages.py\r\n@@ -12,6 +12,7 @@ from test_framework.test_framework import BitcoinTestFramework\r\n from test_framework.messages import (\r\n     BIP125_SEQUENCE_NUMBER,\r\n     COIN,\r\n+    CTransaction,\r\n     CTxInWitness,\r\n     tx_from_hex,\r\n )\r\n@@ -256,7 +257,7 @@ class RPCPackagesTest(BitcoinTestFramework):\r\n         parent_signed = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=self.privkeys)\r\n         parent_tx = CTransaction()\r\n         assert parent_signed[\"complete\"]\r\n-        parent_tx.deserialize(BytesIO(hex_str_to_bytes(parent_signed[\"hex\"])))\r\n+        parent_tx = tx_from_hex(parent_signed[\"hex\"])\r\n         parent_txid = parent_tx.rehash()\r\n         node.sendrawtransaction(parent_signed[\"hex\"])\r\n \r\n@@ -278,7 +279,7 @@ class RPCPackagesTest(BitcoinTestFramework):\r\n         value = parent_value - Decimal(\"0.0001\")\r\n         rawtx_b = node.createrawtransaction([{\"txid\": parent_txid, \"vout\": 1}], {self.address : value})\r\n         tx_child_b = CTransaction() # M2b\r\n-        tx_child_b.deserialize(BytesIO(hex_str_to_bytes(rawtx_b)))\r\n+        tx_child_b = tx_from_hex(rawtx_b)\r\n         tx_child_b.wit.vtxinwit = [CTxInWitness()]\r\n         tx_child_b.wit.vtxinwit[0].scriptWitness.stack = [CScript([OP_TRUE])]\r\n         tx_child_b_hex = tx_child_b.serialize().hex()\r\n```",
      "commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "created_at" : "2021-07-07T10:47:29Z",
      "diff_hunk" : "@@ -187,6 +190,178 @@ def test_chain(self):\n         # Clean up by clearing the mempool\n         node.generate(1)\n \n+    def test_chain_limits_helper(self, mempool_count, package_count):\n+        node = self.nodes[0]\n+        first_coin = self.coins.pop()\n+        parent_locking_script = None\n+        txid = first_coin[\"txid\"]\n+        chain_hex = []\n+        chain_txns = []\n+        value = first_coin[\"amount\"]\n+\n+        for i in range(mempool_count + package_count):\n+            (tx, txhex, value, parent_locking_script) = self.chain_transaction(txid, value, 0, parent_locking_script)\n+            txid = tx.rehash()\n+            if i < mempool_count:\n+                node.sendrawtransaction(txhex)\n+                assert_equal(node.getrawmempool(verbose=True)[txid][\"ancestorcount\"], i + 1)\n+            else:\n+                chain_hex.append(txhex)\n+                chain_txns.append(tx)\n+        testres_too_long = node.testmempoolaccept(rawtxs=chain_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"reject-reason\"], \"exceeds-ancestor-descendant-limits\")\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=chain_hex)])\n+\n+    def test_chain_limits(self):\n+        \"\"\"Create chains from mempool and package transactions that are longer than 25,\n+        but only if both in-mempool and in-package transactions are considered together.\n+        This checks that both mempool and in-package transactions are taken into account when\n+        calculating ancestors/descendant limits.\n+        \"\"\"\n+        self.log.info(\"Check that in-package ancestors count for mempool ancestor limits\")\n+\n+        # 24 transactions in the mempool and 2 in the package. The parent in the package has\n+        # 24 in-mempool ancestors and 1 in-package descendant. The child has 0 direct parents\n+        # in the mempool, but 25 in-mempool and in-package ancestors in total.\n+        self.test_chain_limits_helper(24, 2)\n+        # 2 transactions in the mempool and 24 in the package.\n+        self.test_chain_limits_helper(2, 24)\n+        # 13 transactions in the mempool and 13 in the package.\n+        self.test_chain_limits_helper(13, 13)\n+\n+    def test_descendant_limits(self):\n+        \"\"\"Create an 'A' shaped package with 25 transactions in the mempool and 2 in the package:\n+                    M1\n+                   ^  ^\n+                 M2a  M2b\n+                .       .\n+               .         .\n+              .           .\n+             M11a          ^\n+            ^              M12b\n+           ^                 ^\n+          Pa                  Pb\n+        The top ancestor in the package exceeds descendant limits but only if the in-mempool and in-package\n+        descendants are all considered together (24 including in-mempool descendants and 26 including both\n+        package transactions).\n+        \"\"\"\n+        node = self.nodes[0]\n+        self.log.info(\"Check that in-mempool and in-package descendants are calculated properly in packages\")\n+        # Top parent in mempool, M1\n+        first_coin = self.coins.pop()\n+        parent_value = (first_coin[\"amount\"] - Decimal(\"0.0002\")) / 2 # Deduct reasonable fee and make 2 outputs\n+        inputs = [{\"txid\": first_coin[\"txid\"], \"vout\": 0}]\n+        outputs = [{self.address : parent_value}, {ADDRESS_BCRT1_P2WSH_OP_TRUE : parent_value}]\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+\n+        parent_signed = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=self.privkeys)\n+        parent_tx = CTransaction()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665258130",
      "id" : 665258130,
      "line" : 263,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTI1ODEzMA==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 263,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "test/functional/rpc_packages.py",
      "position" : 84,
      "pull_request_review_id" : 700830368,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T11:21:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665258130",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665264021"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665264021"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this (and other instances) would need to be:\r\n\r\n```suggestion\r\n                                  total_count > 1 ? \"possibly \" : \"\",\r\n```\r\n\r\notherwise the log would be `possiblyexceeds descendant ...`",
      "commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "created_at" : "2021-07-07T10:57:00Z",
      "diff_hunk" : "@@ -187,14 +202,22 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n         staged_ancestors.erase(stage);\n         totalSizeWithAncestors += stageit->GetTxSize();\n \n-        if (stageit->GetSizeWithDescendants() + entry.GetTxSize() > limitDescendantSize) {\n-            errString = strprintf(\"exceeds descendant size limit for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString(), limitDescendantSize);\n+        // When multiple transactions are passed in, the ancestors and descendants of all transactions\n+        // considered together must be within limits even if they are not interdependent. This may be\n+        // stricter than the limits for each individual transaction.\n+        if (stageit->GetSizeWithDescendants() + total_virtual_size > limitDescendantSize) {\n+            errString = strprintf(\"%sexceeds descendant size limit for tx %s [limit: %u]\",\n+                                  total_count > 1 ? \"possibly\" : \"\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665264021",
      "id" : 665264021,
      "line" : 210,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTI2NDAyMQ==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 210,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 85,
      "pull_request_review_id" : 700830368,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T11:21:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665264021",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665268971"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665268971"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What happened to the `Const` here? This used to be `GetMemPoolParentsConst()`.",
      "commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "created_at" : "2021-07-07T11:05:06Z",
      "diff_hunk" : "@@ -151,33 +152,47 @@ void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashes\n     }\n }\n \n-bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString, bool fSearchForParents /* = true */) const\n+bool CTxMemPool::CalculateMemPoolAncestors(const std::vector<CTxMemPoolEntry::CTxMemPoolEntryRef>& entries,\n+                                           setEntries& setAncestors,\n+                                           const uint64_t limitAncestorCount,\n+                                           const uint64_t limitAncestorSize,\n+                                           const uint64_t limitDescendantCount,\n+                                           const uint64_t limitDescendantSize,\n+                                           std::string &errString,\n+                                           const bool fSearchForParents /*=true*/) const\n {\n-    CTxMemPoolEntry::Parents staged_ancestors;\n-    const CTransaction &tx = entry.GetTx();\n+    const size_t total_virtual_size = std::accumulate(entries.cbegin(), entries.cend(), 0,\n+                                      [](int64_t sum, const auto& entry)\n+                                      { return sum + GetVirtualTransactionSize(entry.get().GetTx()); });\n+    const size_t total_count = entries.size();\n \n+    CTxMemPoolEntry::Parents staged_ancestors;\n     if (fSearchForParents) {\n-        // Get parents of this transaction that are in the mempool\n-        // GetMemPoolParents() is only valid for entries in the mempool, so we\n-        // iterate mapTx to find parents.\n-        for (unsigned int i = 0; i < tx.vin.size(); i++) {\n-            std::optional<txiter> piter = GetIter(tx.vin[i].prevout.hash);\n-            if (piter) {\n-                staged_ancestors.insert(**piter);\n-                if (staged_ancestors.size() + 1 > limitAncestorCount) {\n-                    errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n-                    return false;\n+        for (const auto& entry : entries) {\n+            // Get parents of this transaction that are in the mempool\n+            // GetMemPoolParents() is only valid for entries in the mempool, so we\n+            // iterate mapTx to find parents.\n+            for (const auto& input : entry.get().GetTx().vin) {\n+                std::optional<txiter> piter = GetIter(input.prevout.hash);\n+                if (piter) {\n+                    staged_ancestors.insert(**piter);\n+                    if (staged_ancestors.size() + total_count > limitAncestorCount) {\n+                        errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                        return false;\n+                    }\n                 }\n             }\n         }\n     } else {\n-        // If we're not searching for parents, we require this to be an\n-        // entry in the mempool already.\n-        txiter it = mapTx.iterator_to(entry);\n-        staged_ancestors = it->GetMemPoolParentsConst();\n+        // If we're not searching for parents, we require all entries to be in the mempool already.\n+        // We should never use CalculateMemPoolAncestors on a set of transactions that are already\n+        // in the mempool.\n+        assert(entries.size() == 1);\n+        txiter it = mapTx.iterator_to(entries[0].get());\n+        staged_ancestors = it->GetMemPoolParents();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665268971",
      "id" : 665268971,
      "line" : 192,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTI2ODk3MQ==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 192,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 66,
      "pull_request_review_id" : 700830368,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T11:21:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665268971",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665272611"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665272611"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think that `CalculateMemPoolAncestors()` was already doing too much, and this adds just a little bit more complication. Instead of overloading CMPA and having CMPA(tx) call CMPA(package), what do you think about the splitting it into two parts:\r\n\r\n- calculate parents (two different functions - one for a single transaction which may have fSearchForParents=false, and one for a package)\r\n- check package limits (everything from `while (!staged_ancestors.empty())` downwards, which is the same function for an individual transaction and a package if parametrized correctly)\r\n\r\nand then roughly:\r\n\r\n```\r\nCMPA(tx) {\r\n    set_ancestors = CalculateParents(tx);\r\n    CheckPackageLimits(set_ancestors);\r\n}\r\n\r\nCMPA(package) {\r\n    set_ancestors = CalculateParents(package);\r\n    CheckPackageLimits(set_ancestors);\r\n}\r\n```",
      "commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "created_at" : "2021-07-07T11:11:03Z",
      "diff_hunk" : "@@ -151,33 +152,47 @@ void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashes\n     }\n }\n \n-bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString, bool fSearchForParents /* = true */) const\n+bool CTxMemPool::CalculateMemPoolAncestors(const std::vector<CTxMemPoolEntry::CTxMemPoolEntryRef>& entries,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665272611",
      "id" : 665272611,
      "line" : 155,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTI3MjYxMQ==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 155,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 13,
      "pull_request_review_id" : 700830368,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T11:21:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665272611",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665275481"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665275481"
         }
      },
      "author_association" : "MEMBER",
      "body" : "What do you think about not making these const, and then decrementing from them and checking that we don't go below zero? That would avoid the need for the local variables and make the logic for individual txs and packages more similar.",
      "commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "created_at" : "2021-07-07T11:15:50Z",
      "diff_hunk" : "@@ -151,33 +152,47 @@ void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashes\n     }\n }\n \n-bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString, bool fSearchForParents /* = true */) const\n+bool CTxMemPool::CalculateMemPoolAncestors(const std::vector<CTxMemPoolEntry::CTxMemPoolEntryRef>& entries,\n+                                           setEntries& setAncestors,\n+                                           const uint64_t limitAncestorCount,\n+                                           const uint64_t limitAncestorSize,\n+                                           const uint64_t limitDescendantCount,\n+                                           const uint64_t limitDescendantSize,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665275481",
      "id" : 665275481,
      "line" : 160,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTI3NTQ4MQ==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 160,
      "original_position" : 18,
      "original_start_line" : 157,
      "path" : "src/txmempool.cpp",
      "position" : 18,
      "pull_request_review_id" : 700830368,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : 157,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-07T11:21:20Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665275481",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665671316"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665671316"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: use function signatures with spans when passing a const vec, removes the need to allocate for passing a single tx (can span without allocating from pointer).",
      "commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "created_at" : "2021-07-07T20:05:17Z",
      "diff_hunk" : "@@ -151,33 +152,47 @@ void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashes\n     }\n }\n \n-bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString, bool fSearchForParents /* = true */) const\n+bool CTxMemPool::CalculateMemPoolAncestors(const std::vector<CTxMemPoolEntry::CTxMemPoolEntryRef>& entries,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665671316",
      "id" : 665671316,
      "in_reply_to_id" : 665272611,
      "line" : 155,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTY3MTMxNg==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 155,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 13,
      "pull_request_review_id" : 701401155,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T20:05:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665671316",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665674868"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665674868"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think it is clearer to make these as const personally, decrement until 0 is always confusing to me (is it at 0 or below zero that the error comes in? These are currently uint64_t, so we'd also need to either convert to int64_t or detect wraparound...).",
      "commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "created_at" : "2021-07-07T20:11:00Z",
      "diff_hunk" : "@@ -151,33 +152,47 @@ void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashes\n     }\n }\n \n-bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString, bool fSearchForParents /* = true */) const\n+bool CTxMemPool::CalculateMemPoolAncestors(const std::vector<CTxMemPoolEntry::CTxMemPoolEntryRef>& entries,\n+                                           setEntries& setAncestors,\n+                                           const uint64_t limitAncestorCount,\n+                                           const uint64_t limitAncestorSize,\n+                                           const uint64_t limitDescendantCount,\n+                                           const uint64_t limitDescendantSize,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665674868",
      "id" : 665674868,
      "in_reply_to_id" : 665275481,
      "line" : 160,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTY3NDg2OA==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 160,
      "original_position" : 18,
      "original_start_line" : 157,
      "path" : "src/txmempool.cpp",
      "position" : 18,
      "pull_request_review_id" : 701405814,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : 157,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-07T20:11:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665674868",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665676930"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665676930"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Never? Why is this new constraint present? I thought it's safe to use as long as we aren't searching for parents?",
      "commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "created_at" : "2021-07-07T20:14:31Z",
      "diff_hunk" : "@@ -151,33 +152,47 @@ void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashes\n     }\n }\n \n-bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString, bool fSearchForParents /* = true */) const\n+bool CTxMemPool::CalculateMemPoolAncestors(const std::vector<CTxMemPoolEntry::CTxMemPoolEntryRef>& entries,\n+                                           setEntries& setAncestors,\n+                                           const uint64_t limitAncestorCount,\n+                                           const uint64_t limitAncestorSize,\n+                                           const uint64_t limitDescendantCount,\n+                                           const uint64_t limitDescendantSize,\n+                                           std::string &errString,\n+                                           const bool fSearchForParents /*=true*/) const\n {\n-    CTxMemPoolEntry::Parents staged_ancestors;\n-    const CTransaction &tx = entry.GetTx();\n+    const size_t total_virtual_size = std::accumulate(entries.cbegin(), entries.cend(), 0,\n+                                      [](int64_t sum, const auto& entry)\n+                                      { return sum + GetVirtualTransactionSize(entry.get().GetTx()); });\n+    const size_t total_count = entries.size();\n \n+    CTxMemPoolEntry::Parents staged_ancestors;\n     if (fSearchForParents) {\n-        // Get parents of this transaction that are in the mempool\n-        // GetMemPoolParents() is only valid for entries in the mempool, so we\n-        // iterate mapTx to find parents.\n-        for (unsigned int i = 0; i < tx.vin.size(); i++) {\n-            std::optional<txiter> piter = GetIter(tx.vin[i].prevout.hash);\n-            if (piter) {\n-                staged_ancestors.insert(**piter);\n-                if (staged_ancestors.size() + 1 > limitAncestorCount) {\n-                    errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n-                    return false;\n+        for (const auto& entry : entries) {\n+            // Get parents of this transaction that are in the mempool\n+            // GetMemPoolParents() is only valid for entries in the mempool, so we\n+            // iterate mapTx to find parents.\n+            for (const auto& input : entry.get().GetTx().vin) {\n+                std::optional<txiter> piter = GetIter(input.prevout.hash);\n+                if (piter) {\n+                    staged_ancestors.insert(**piter);\n+                    if (staged_ancestors.size() + total_count > limitAncestorCount) {\n+                        errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                        return false;\n+                    }\n                 }\n             }\n         }\n     } else {\n-        // If we're not searching for parents, we require this to be an\n-        // entry in the mempool already.\n-        txiter it = mapTx.iterator_to(entry);\n-        staged_ancestors = it->GetMemPoolParentsConst();\n+        // If we're not searching for parents, we require all entries to be in the mempool already.\n+        // We should never use CalculateMemPoolAncestors on a set of transactions that are already",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665676930",
      "id" : 665676930,
      "line" : 188,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTY3NjkzMA==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 188,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 62,
      "pull_request_review_id" : 701408475,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T20:14:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665676930",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665677347"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665677347"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "this assert is pretty scary? why do we not permit >1?",
      "commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "created_at" : "2021-07-07T20:15:14Z",
      "diff_hunk" : "@@ -151,33 +152,47 @@ void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashes\n     }\n }\n \n-bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString, bool fSearchForParents /* = true */) const\n+bool CTxMemPool::CalculateMemPoolAncestors(const std::vector<CTxMemPoolEntry::CTxMemPoolEntryRef>& entries,\n+                                           setEntries& setAncestors,\n+                                           const uint64_t limitAncestorCount,\n+                                           const uint64_t limitAncestorSize,\n+                                           const uint64_t limitDescendantCount,\n+                                           const uint64_t limitDescendantSize,\n+                                           std::string &errString,\n+                                           const bool fSearchForParents /*=true*/) const\n {\n-    CTxMemPoolEntry::Parents staged_ancestors;\n-    const CTransaction &tx = entry.GetTx();\n+    const size_t total_virtual_size = std::accumulate(entries.cbegin(), entries.cend(), 0,\n+                                      [](int64_t sum, const auto& entry)\n+                                      { return sum + GetVirtualTransactionSize(entry.get().GetTx()); });\n+    const size_t total_count = entries.size();\n \n+    CTxMemPoolEntry::Parents staged_ancestors;\n     if (fSearchForParents) {\n-        // Get parents of this transaction that are in the mempool\n-        // GetMemPoolParents() is only valid for entries in the mempool, so we\n-        // iterate mapTx to find parents.\n-        for (unsigned int i = 0; i < tx.vin.size(); i++) {\n-            std::optional<txiter> piter = GetIter(tx.vin[i].prevout.hash);\n-            if (piter) {\n-                staged_ancestors.insert(**piter);\n-                if (staged_ancestors.size() + 1 > limitAncestorCount) {\n-                    errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n-                    return false;\n+        for (const auto& entry : entries) {\n+            // Get parents of this transaction that are in the mempool\n+            // GetMemPoolParents() is only valid for entries in the mempool, so we\n+            // iterate mapTx to find parents.\n+            for (const auto& input : entry.get().GetTx().vin) {\n+                std::optional<txiter> piter = GetIter(input.prevout.hash);\n+                if (piter) {\n+                    staged_ancestors.insert(**piter);\n+                    if (staged_ancestors.size() + total_count > limitAncestorCount) {\n+                        errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                        return false;\n+                    }\n                 }\n             }\n         }\n     } else {\n-        // If we're not searching for parents, we require this to be an\n-        // entry in the mempool already.\n-        txiter it = mapTx.iterator_to(entry);\n-        staged_ancestors = it->GetMemPoolParentsConst();\n+        // If we're not searching for parents, we require all entries to be in the mempool already.\n+        // We should never use CalculateMemPoolAncestors on a set of transactions that are already\n+        // in the mempool.\n+        assert(entries.size() == 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665677347",
      "id" : 665677347,
      "line" : 190,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTY3NzM0Nw==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 190,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 64,
      "pull_request_review_id" : 701408997,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T20:15:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665677347",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665677948"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665677948"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: @jnewbery's feedback to split, I think that might be right if fsearchforparents should never be used as false with a package? the asserts confuse me...",
      "commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "created_at" : "2021-07-07T20:16:18Z",
      "diff_hunk" : "@@ -151,33 +152,47 @@ void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashes\n     }\n }\n \n-bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString, bool fSearchForParents /* = true */) const\n+bool CTxMemPool::CalculateMemPoolAncestors(const std::vector<CTxMemPoolEntry::CTxMemPoolEntryRef>& entries,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665677948",
      "id" : 665677948,
      "in_reply_to_id" : 665272611,
      "line" : 155,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTY3Nzk0OA==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 155,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 13,
      "pull_request_review_id" : 701409789,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T20:16:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665677948",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665678189"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665678189"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "What if it's a package of size 1? Is this code safe? Or only if it's called in non package contexts?",
      "commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "created_at" : "2021-07-07T20:16:42Z",
      "diff_hunk" : "@@ -151,33 +152,47 @@ void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashes\n     }\n }\n \n-bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString, bool fSearchForParents /* = true */) const\n+bool CTxMemPool::CalculateMemPoolAncestors(const std::vector<CTxMemPoolEntry::CTxMemPoolEntryRef>& entries,\n+                                           setEntries& setAncestors,\n+                                           const uint64_t limitAncestorCount,\n+                                           const uint64_t limitAncestorSize,\n+                                           const uint64_t limitDescendantCount,\n+                                           const uint64_t limitDescendantSize,\n+                                           std::string &errString,\n+                                           const bool fSearchForParents /*=true*/) const\n {\n-    CTxMemPoolEntry::Parents staged_ancestors;\n-    const CTransaction &tx = entry.GetTx();\n+    const size_t total_virtual_size = std::accumulate(entries.cbegin(), entries.cend(), 0,\n+                                      [](int64_t sum, const auto& entry)\n+                                      { return sum + GetVirtualTransactionSize(entry.get().GetTx()); });\n+    const size_t total_count = entries.size();\n \n+    CTxMemPoolEntry::Parents staged_ancestors;\n     if (fSearchForParents) {\n-        // Get parents of this transaction that are in the mempool\n-        // GetMemPoolParents() is only valid for entries in the mempool, so we\n-        // iterate mapTx to find parents.\n-        for (unsigned int i = 0; i < tx.vin.size(); i++) {\n-            std::optional<txiter> piter = GetIter(tx.vin[i].prevout.hash);\n-            if (piter) {\n-                staged_ancestors.insert(**piter);\n-                if (staged_ancestors.size() + 1 > limitAncestorCount) {\n-                    errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n-                    return false;\n+        for (const auto& entry : entries) {\n+            // Get parents of this transaction that are in the mempool\n+            // GetMemPoolParents() is only valid for entries in the mempool, so we\n+            // iterate mapTx to find parents.\n+            for (const auto& input : entry.get().GetTx().vin) {\n+                std::optional<txiter> piter = GetIter(input.prevout.hash);\n+                if (piter) {\n+                    staged_ancestors.insert(**piter);\n+                    if (staged_ancestors.size() + total_count > limitAncestorCount) {\n+                        errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                        return false;\n+                    }\n                 }\n             }\n         }\n     } else {\n-        // If we're not searching for parents, we require this to be an\n-        // entry in the mempool already.\n-        txiter it = mapTx.iterator_to(entry);\n-        staged_ancestors = it->GetMemPoolParentsConst();\n+        // If we're not searching for parents, we require all entries to be in the mempool already.\n+        // We should never use CalculateMemPoolAncestors on a set of transactions that are already\n+        // in the mempool.\n+        assert(entries.size() == 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665678189",
      "id" : 665678189,
      "in_reply_to_id" : 665677347,
      "line" : 190,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTY3ODE4OQ==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 190,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 64,
      "pull_request_review_id" : 701410097,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T20:16:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665678189",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665678766"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665678766"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "if you update to a span, you get rid of an allocation here!",
      "commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "created_at" : "2021-07-07T20:17:39Z",
      "diff_hunk" : "@@ -216,6 +240,17 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n     return true;\n }\n \n+bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors,\n+                                           uint64_t limitAncestorCount, uint64_t limitAncestorSize,\n+                                           uint64_t limitDescendantCount, uint64_t limitDescendantSize,\n+                                           std::string &errString, bool fSearchForParents /* = true */) const\n+{\n+    std::vector<CTxMemPoolEntry::CTxMemPoolEntryRef> entry_vec{std::cref(entry)};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r665678766",
      "id" : 665678766,
      "line" : 248,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NTY3ODc2Ng==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 248,
      "original_position" : 123,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 123,
      "pull_request_review_id" : 701410882,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-07T20:17:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/665678766",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r666235253"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666235253"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Sorry, I've clarified this now. CMPA for a vector of transactions always searches for parents. If we call CMPA with multiple transactions (also handling the case if called with a vector of size 1), those transactions shouldn't already be in the mempool.",
      "commit_id" : "9d90a5d44cc4f14aa8a020e2b2f9ebe9bc294b2e",
      "created_at" : "2021-07-08T14:15:57Z",
      "diff_hunk" : "@@ -151,33 +152,47 @@ void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashes\n     }\n }\n \n-bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString, bool fSearchForParents /* = true */) const\n+bool CTxMemPool::CalculateMemPoolAncestors(const std::vector<CTxMemPoolEntry::CTxMemPoolEntryRef>& entries,\n+                                           setEntries& setAncestors,\n+                                           const uint64_t limitAncestorCount,\n+                                           const uint64_t limitAncestorSize,\n+                                           const uint64_t limitDescendantCount,\n+                                           const uint64_t limitDescendantSize,\n+                                           std::string &errString,\n+                                           const bool fSearchForParents /*=true*/) const\n {\n-    CTxMemPoolEntry::Parents staged_ancestors;\n-    const CTransaction &tx = entry.GetTx();\n+    const size_t total_virtual_size = std::accumulate(entries.cbegin(), entries.cend(), 0,\n+                                      [](int64_t sum, const auto& entry)\n+                                      { return sum + GetVirtualTransactionSize(entry.get().GetTx()); });\n+    const size_t total_count = entries.size();\n \n+    CTxMemPoolEntry::Parents staged_ancestors;\n     if (fSearchForParents) {\n-        // Get parents of this transaction that are in the mempool\n-        // GetMemPoolParents() is only valid for entries in the mempool, so we\n-        // iterate mapTx to find parents.\n-        for (unsigned int i = 0; i < tx.vin.size(); i++) {\n-            std::optional<txiter> piter = GetIter(tx.vin[i].prevout.hash);\n-            if (piter) {\n-                staged_ancestors.insert(**piter);\n-                if (staged_ancestors.size() + 1 > limitAncestorCount) {\n-                    errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n-                    return false;\n+        for (const auto& entry : entries) {\n+            // Get parents of this transaction that are in the mempool\n+            // GetMemPoolParents() is only valid for entries in the mempool, so we\n+            // iterate mapTx to find parents.\n+            for (const auto& input : entry.get().GetTx().vin) {\n+                std::optional<txiter> piter = GetIter(input.prevout.hash);\n+                if (piter) {\n+                    staged_ancestors.insert(**piter);\n+                    if (staged_ancestors.size() + total_count > limitAncestorCount) {\n+                        errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                        return false;\n+                    }\n                 }\n             }\n         }\n     } else {\n-        // If we're not searching for parents, we require this to be an\n-        // entry in the mempool already.\n-        txiter it = mapTx.iterator_to(entry);\n-        staged_ancestors = it->GetMemPoolParentsConst();\n+        // If we're not searching for parents, we require all entries to be in the mempool already.\n+        // We should never use CalculateMemPoolAncestors on a set of transactions that are already\n+        // in the mempool.\n+        assert(entries.size() == 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r666235253",
      "id" : 666235253,
      "in_reply_to_id" : 665677347,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjIzNTI1Mw==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 190,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 702121199,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T14:15:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666235253",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r666235587"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666235587"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "GONE! ð ",
      "commit_id" : "9d90a5d44cc4f14aa8a020e2b2f9ebe9bc294b2e",
      "created_at" : "2021-07-08T14:16:18Z",
      "diff_hunk" : "@@ -216,6 +240,17 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n     return true;\n }\n \n+bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors,\n+                                           uint64_t limitAncestorCount, uint64_t limitAncestorSize,\n+                                           uint64_t limitDescendantCount, uint64_t limitDescendantSize,\n+                                           std::string &errString, bool fSearchForParents /* = true */) const\n+{\n+    std::vector<CTxMemPoolEntry::CTxMemPoolEntryRef> entry_vec{std::cref(entry)};",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r666235587",
      "id" : 666235587,
      "in_reply_to_id" : 665678766,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjIzNTU4Nw==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 248,
      "original_position" : 123,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 702121652,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T14:16:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666235587",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r666236601"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666236601"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "(Same idea) if we're calling this with multiple transactions, they shouldn't already be in the mempool.",
      "commit_id" : "9d90a5d44cc4f14aa8a020e2b2f9ebe9bc294b2e",
      "created_at" : "2021-07-08T14:17:24Z",
      "diff_hunk" : "@@ -151,33 +152,47 @@ void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashes\n     }\n }\n \n-bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString, bool fSearchForParents /* = true */) const\n+bool CTxMemPool::CalculateMemPoolAncestors(const std::vector<CTxMemPoolEntry::CTxMemPoolEntryRef>& entries,\n+                                           setEntries& setAncestors,\n+                                           const uint64_t limitAncestorCount,\n+                                           const uint64_t limitAncestorSize,\n+                                           const uint64_t limitDescendantCount,\n+                                           const uint64_t limitDescendantSize,\n+                                           std::string &errString,\n+                                           const bool fSearchForParents /*=true*/) const\n {\n-    CTxMemPoolEntry::Parents staged_ancestors;\n-    const CTransaction &tx = entry.GetTx();\n+    const size_t total_virtual_size = std::accumulate(entries.cbegin(), entries.cend(), 0,\n+                                      [](int64_t sum, const auto& entry)\n+                                      { return sum + GetVirtualTransactionSize(entry.get().GetTx()); });\n+    const size_t total_count = entries.size();\n \n+    CTxMemPoolEntry::Parents staged_ancestors;\n     if (fSearchForParents) {\n-        // Get parents of this transaction that are in the mempool\n-        // GetMemPoolParents() is only valid for entries in the mempool, so we\n-        // iterate mapTx to find parents.\n-        for (unsigned int i = 0; i < tx.vin.size(); i++) {\n-            std::optional<txiter> piter = GetIter(tx.vin[i].prevout.hash);\n-            if (piter) {\n-                staged_ancestors.insert(**piter);\n-                if (staged_ancestors.size() + 1 > limitAncestorCount) {\n-                    errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n-                    return false;\n+        for (const auto& entry : entries) {\n+            // Get parents of this transaction that are in the mempool\n+            // GetMemPoolParents() is only valid for entries in the mempool, so we\n+            // iterate mapTx to find parents.\n+            for (const auto& input : entry.get().GetTx().vin) {\n+                std::optional<txiter> piter = GetIter(input.prevout.hash);\n+                if (piter) {\n+                    staged_ancestors.insert(**piter);\n+                    if (staged_ancestors.size() + total_count > limitAncestorCount) {\n+                        errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                        return false;\n+                    }\n                 }\n             }\n         }\n     } else {\n-        // If we're not searching for parents, we require this to be an\n-        // entry in the mempool already.\n-        txiter it = mapTx.iterator_to(entry);\n-        staged_ancestors = it->GetMemPoolParentsConst();\n+        // If we're not searching for parents, we require all entries to be in the mempool already.\n+        // We should never use CalculateMemPoolAncestors on a set of transactions that are already",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r666236601",
      "id" : 666236601,
      "in_reply_to_id" : 665676930,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjIzNjYwMQ==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 188,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 702123026,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T14:17:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666236601",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r666238907"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666238907"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done, with Span :D\r\n\r\nI've made it so that the CMPA with a vector of transactions doesn't have a `fSearchForParents` param, we just always search for parents. The only call site (other than tests) should be in `MemPoolAccept::AcceptMultipleTransactions()` so the transactions shouldn't already be in the mempool. It wouldn't make sense to use this heuristic on transactions that are already in the mempool, since it's potentially stricter.",
      "commit_id" : "9d90a5d44cc4f14aa8a020e2b2f9ebe9bc294b2e",
      "created_at" : "2021-07-08T14:19:59Z",
      "diff_hunk" : "@@ -151,33 +152,47 @@ void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashes\n     }\n }\n \n-bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString, bool fSearchForParents /* = true */) const\n+bool CTxMemPool::CalculateMemPoolAncestors(const std::vector<CTxMemPoolEntry::CTxMemPoolEntryRef>& entries,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r666238907",
      "id" : 666238907,
      "in_reply_to_id" : 665272611,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjIzODkwNw==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 155,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 702126182,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T14:19:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666238907",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r666238986"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666238986"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed",
      "commit_id" : "9d90a5d44cc4f14aa8a020e2b2f9ebe9bc294b2e",
      "created_at" : "2021-07-08T14:20:04Z",
      "diff_hunk" : "@@ -187,14 +202,22 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n         staged_ancestors.erase(stage);\n         totalSizeWithAncestors += stageit->GetTxSize();\n \n-        if (stageit->GetSizeWithDescendants() + entry.GetTxSize() > limitDescendantSize) {\n-            errString = strprintf(\"exceeds descendant size limit for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString(), limitDescendantSize);\n+        // When multiple transactions are passed in, the ancestors and descendants of all transactions\n+        // considered together must be within limits even if they are not interdependent. This may be\n+        // stricter than the limits for each individual transaction.\n+        if (stageit->GetSizeWithDescendants() + total_virtual_size > limitDescendantSize) {\n+            errString = strprintf(\"%sexceeds descendant size limit for tx %s [limit: %u]\",\n+                                  total_count > 1 ? \"possibly\" : \"\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r666238986",
      "id" : 666238986,
      "in_reply_to_id" : 665264021,
      "line" : 180,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjIzODk4Ng==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 180,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 58,
      "pull_request_review_id" : 702126290,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T14:20:05Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666238986",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r666239406"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666239406"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed",
      "commit_id" : "9d90a5d44cc4f14aa8a020e2b2f9ebe9bc294b2e",
      "created_at" : "2021-07-08T14:20:29Z",
      "diff_hunk" : "@@ -151,33 +152,47 @@ void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashes\n     }\n }\n \n-bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString, bool fSearchForParents /* = true */) const\n+bool CTxMemPool::CalculateMemPoolAncestors(const std::vector<CTxMemPoolEntry::CTxMemPoolEntryRef>& entries,\n+                                           setEntries& setAncestors,\n+                                           const uint64_t limitAncestorCount,\n+                                           const uint64_t limitAncestorSize,\n+                                           const uint64_t limitDescendantCount,\n+                                           const uint64_t limitDescendantSize,\n+                                           std::string &errString,\n+                                           const bool fSearchForParents /*=true*/) const\n {\n-    CTxMemPoolEntry::Parents staged_ancestors;\n-    const CTransaction &tx = entry.GetTx();\n+    const size_t total_virtual_size = std::accumulate(entries.cbegin(), entries.cend(), 0,\n+                                      [](int64_t sum, const auto& entry)\n+                                      { return sum + GetVirtualTransactionSize(entry.get().GetTx()); });\n+    const size_t total_count = entries.size();\n \n+    CTxMemPoolEntry::Parents staged_ancestors;\n     if (fSearchForParents) {\n-        // Get parents of this transaction that are in the mempool\n-        // GetMemPoolParents() is only valid for entries in the mempool, so we\n-        // iterate mapTx to find parents.\n-        for (unsigned int i = 0; i < tx.vin.size(); i++) {\n-            std::optional<txiter> piter = GetIter(tx.vin[i].prevout.hash);\n-            if (piter) {\n-                staged_ancestors.insert(**piter);\n-                if (staged_ancestors.size() + 1 > limitAncestorCount) {\n-                    errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n-                    return false;\n+        for (const auto& entry : entries) {\n+            // Get parents of this transaction that are in the mempool\n+            // GetMemPoolParents() is only valid for entries in the mempool, so we\n+            // iterate mapTx to find parents.\n+            for (const auto& input : entry.get().GetTx().vin) {\n+                std::optional<txiter> piter = GetIter(input.prevout.hash);\n+                if (piter) {\n+                    staged_ancestors.insert(**piter);\n+                    if (staged_ancestors.size() + total_count > limitAncestorCount) {\n+                        errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                        return false;\n+                    }\n                 }\n             }\n         }\n     } else {\n-        // If we're not searching for parents, we require this to be an\n-        // entry in the mempool already.\n-        txiter it = mapTx.iterator_to(entry);\n-        staged_ancestors = it->GetMemPoolParentsConst();\n+        // If we're not searching for parents, we require all entries to be in the mempool already.\n+        // We should never use CalculateMemPoolAncestors on a set of transactions that are already\n+        // in the mempool.\n+        assert(entries.size() == 1);\n+        txiter it = mapTx.iterator_to(entries[0].get());\n+        staged_ancestors = it->GetMemPoolParents();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r666239406",
      "id" : 666239406,
      "in_reply_to_id" : 665268971,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjIzOTQwNg==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 192,
      "original_position" : 66,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 702126827,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T14:20:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666239406",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r666239507"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666239507"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Fixed",
      "commit_id" : "9d90a5d44cc4f14aa8a020e2b2f9ebe9bc294b2e",
      "created_at" : "2021-07-08T14:20:37Z",
      "diff_hunk" : "@@ -187,6 +190,178 @@ def test_chain(self):\n         # Clean up by clearing the mempool\n         node.generate(1)\n \n+    def test_chain_limits_helper(self, mempool_count, package_count):\n+        node = self.nodes[0]\n+        first_coin = self.coins.pop()\n+        parent_locking_script = None\n+        txid = first_coin[\"txid\"]\n+        chain_hex = []\n+        chain_txns = []\n+        value = first_coin[\"amount\"]\n+\n+        for i in range(mempool_count + package_count):\n+            (tx, txhex, value, parent_locking_script) = self.chain_transaction(txid, value, 0, parent_locking_script)\n+            txid = tx.rehash()\n+            if i < mempool_count:\n+                node.sendrawtransaction(txhex)\n+                assert_equal(node.getrawmempool(verbose=True)[txid][\"ancestorcount\"], i + 1)\n+            else:\n+                chain_hex.append(txhex)\n+                chain_txns.append(tx)\n+        testres_too_long = node.testmempoolaccept(rawtxs=chain_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"reject-reason\"], \"exceeds-ancestor-descendant-limits\")\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=chain_hex)])\n+\n+    def test_chain_limits(self):\n+        \"\"\"Create chains from mempool and package transactions that are longer than 25,\n+        but only if both in-mempool and in-package transactions are considered together.\n+        This checks that both mempool and in-package transactions are taken into account when\n+        calculating ancestors/descendant limits.\n+        \"\"\"\n+        self.log.info(\"Check that in-package ancestors count for mempool ancestor limits\")\n+\n+        # 24 transactions in the mempool and 2 in the package. The parent in the package has\n+        # 24 in-mempool ancestors and 1 in-package descendant. The child has 0 direct parents\n+        # in the mempool, but 25 in-mempool and in-package ancestors in total.\n+        self.test_chain_limits_helper(24, 2)\n+        # 2 transactions in the mempool and 24 in the package.\n+        self.test_chain_limits_helper(2, 24)\n+        # 13 transactions in the mempool and 13 in the package.\n+        self.test_chain_limits_helper(13, 13)\n+\n+    def test_descendant_limits(self):\n+        \"\"\"Create an 'A' shaped package with 25 transactions in the mempool and 2 in the package:\n+                    M1\n+                   ^  ^\n+                 M2a  M2b\n+                .       .\n+               .         .\n+              .           .\n+             M11a          ^\n+            ^              M12b\n+           ^                 ^\n+          Pa                  Pb\n+        The top ancestor in the package exceeds descendant limits but only if the in-mempool and in-package\n+        descendants are all considered together (24 including in-mempool descendants and 26 including both\n+        package transactions).\n+        \"\"\"\n+        node = self.nodes[0]\n+        self.log.info(\"Check that in-mempool and in-package descendants are calculated properly in packages\")\n+        # Top parent in mempool, M1\n+        first_coin = self.coins.pop()\n+        parent_value = (first_coin[\"amount\"] - Decimal(\"0.0002\")) / 2 # Deduct reasonable fee and make 2 outputs\n+        inputs = [{\"txid\": first_coin[\"txid\"], \"vout\": 0}]\n+        outputs = [{self.address : parent_value}, {ADDRESS_BCRT1_P2WSH_OP_TRUE : parent_value}]\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+\n+        parent_signed = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=self.privkeys)\n+        parent_tx = CTransaction()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r666239507",
      "id" : 666239507,
      "in_reply_to_id" : 665258130,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjIzOTUwNw==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 263,
      "original_position" : 84,
      "original_start_line" : null,
      "path" : "test/functional/rpc_packages.py",
      "position" : null,
      "pull_request_review_id" : 702126993,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-08T14:20:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666239507",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r666239846"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666239846"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "You're right it's just an out param, fixed.",
      "commit_id" : "9d90a5d44cc4f14aa8a020e2b2f9ebe9bc294b2e",
      "created_at" : "2021-07-08T14:20:59Z",
      "diff_hunk" : "@@ -681,6 +681,34 @@ class CTxMemPool\n      */\n     bool CalculateMemPoolAncestors(const CTxMemPoolEntry& entry, setEntries& setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string& errString, bool fSearchForParents = true) const EXCLUSIVE_LOCKS_REQUIRED(cs);\n \n+    /** Try to calculate all in-mempool ancestors of a set of entries, and check for ancestor and\n+     * descendant limits (all are inclusive of the transactions in entries). The same limits are\n+     * used no matter how many transactions are passed in. For example, if entries.size() = 3 and\n+     * the limit is 25, the union of all 3 sets of ancestors must be <= 22.\n+     * @param[in]       entries                 Entries corresponding to transaction(s) being\n+     *                                          evaluated for acceptance to mempool. If there are\n+     *                                          multiple, they must not already be in the mempool.\n+     *                                          They need not be direct ancestors/descendants of\n+     *                                          each other, though they will be treated as such.\n+     * @param[in,out]   setAncestors            Set of in-mempool ancestors. Updated to include\n+     *                                          any new ancestors found.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r666239846",
      "id" : 666239846,
      "in_reply_to_id" : 665240182,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjIzOTg0Ng==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 694,
      "original_position" : 14,
      "original_start_line" : 693,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 702127482,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-08T14:20:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666239846",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r666240721"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666240721"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Took it out. Also kind of different now that the two CMPAs are slightly different",
      "commit_id" : "9d90a5d44cc4f14aa8a020e2b2f9ebe9bc294b2e",
      "created_at" : "2021-07-08T14:21:54Z",
      "diff_hunk" : "@@ -681,6 +681,34 @@ class CTxMemPool\n      */\n     bool CalculateMemPoolAncestors(const CTxMemPoolEntry& entry, setEntries& setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string& errString, bool fSearchForParents = true) const EXCLUSIVE_LOCKS_REQUIRED(cs);\n \n+    /** Try to calculate all in-mempool ancestors of a set of entries, and check for ancestor and\n+     * descendant limits (all are inclusive of the transactions in entries). The same limits are\n+     * used no matter how many transactions are passed in. For example, if entries.size() = 3 and\n+     * the limit is 25, the union of all 3 sets of ancestors must be <= 22.\n+     * @param[in]       entries                 Entries corresponding to transaction(s) being\n+     *                                          evaluated for acceptance to mempool. If there are",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r666240721",
      "id" : 666240721,
      "in_reply_to_id" : 665238840,
      "line" : 705,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NjI0MDcyMQ==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 705,
      "original_position" : 9,
      "original_start_line" : 688,
      "path" : "src/txmempool.h",
      "position" : 32,
      "pull_request_review_id" : 702128628,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : 704,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-08T14:21:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/666240721",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r667063611"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667063611"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "did you tho? looks same",
      "commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "created_at" : "2021-07-09T16:12:38Z",
      "diff_hunk" : "@@ -187,14 +202,22 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n         staged_ancestors.erase(stage);\n         totalSizeWithAncestors += stageit->GetTxSize();\n \n-        if (stageit->GetSizeWithDescendants() + entry.GetTxSize() > limitDescendantSize) {\n-            errString = strprintf(\"exceeds descendant size limit for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString(), limitDescendantSize);\n+        // When multiple transactions are passed in, the ancestors and descendants of all transactions\n+        // considered together must be within limits even if they are not interdependent. This may be\n+        // stricter than the limits for each individual transaction.\n+        if (stageit->GetSizeWithDescendants() + total_virtual_size > limitDescendantSize) {\n+            errString = strprintf(\"%sexceeds descendant size limit for tx %s [limit: %u]\",\n+                                  total_count > 1 ? \"possibly\" : \"\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r667063611",
      "id" : 667063611,
      "in_reply_to_id" : 665264021,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2NzA2MzYxMQ==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 180,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 703203578,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-09T16:12:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/667063611",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r670187216"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/670187216"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Removed this condition",
      "commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "created_at" : "2021-07-15T06:58:52Z",
      "diff_hunk" : "@@ -151,33 +152,47 @@ void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashes\n     }\n }\n \n-bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString, bool fSearchForParents /* = true */) const\n+bool CTxMemPool::CalculateMemPoolAncestors(const std::vector<CTxMemPoolEntry::CTxMemPoolEntryRef>& entries,\n+                                           setEntries& setAncestors,\n+                                           const uint64_t limitAncestorCount,\n+                                           const uint64_t limitAncestorSize,\n+                                           const uint64_t limitDescendantCount,\n+                                           const uint64_t limitDescendantSize,\n+                                           std::string &errString,\n+                                           const bool fSearchForParents /*=true*/) const\n {\n-    CTxMemPoolEntry::Parents staged_ancestors;\n-    const CTransaction &tx = entry.GetTx();\n+    const size_t total_virtual_size = std::accumulate(entries.cbegin(), entries.cend(), 0,\n+                                      [](int64_t sum, const auto& entry)\n+                                      { return sum + GetVirtualTransactionSize(entry.get().GetTx()); });\n+    const size_t total_count = entries.size();\n \n+    CTxMemPoolEntry::Parents staged_ancestors;\n     if (fSearchForParents) {\n-        // Get parents of this transaction that are in the mempool\n-        // GetMemPoolParents() is only valid for entries in the mempool, so we\n-        // iterate mapTx to find parents.\n-        for (unsigned int i = 0; i < tx.vin.size(); i++) {\n-            std::optional<txiter> piter = GetIter(tx.vin[i].prevout.hash);\n-            if (piter) {\n-                staged_ancestors.insert(**piter);\n-                if (staged_ancestors.size() + 1 > limitAncestorCount) {\n-                    errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n-                    return false;\n+        for (const auto& entry : entries) {\n+            // Get parents of this transaction that are in the mempool\n+            // GetMemPoolParents() is only valid for entries in the mempool, so we\n+            // iterate mapTx to find parents.\n+            for (const auto& input : entry.get().GetTx().vin) {\n+                std::optional<txiter> piter = GetIter(input.prevout.hash);\n+                if (piter) {\n+                    staged_ancestors.insert(**piter);\n+                    if (staged_ancestors.size() + total_count > limitAncestorCount) {\n+                        errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                        return false;\n+                    }\n                 }\n             }\n         }\n     } else {\n-        // If we're not searching for parents, we require this to be an\n-        // entry in the mempool already.\n-        txiter it = mapTx.iterator_to(entry);\n-        staged_ancestors = it->GetMemPoolParentsConst();\n+        // If we're not searching for parents, we require all entries to be in the mempool already.\n+        // We should never use CalculateMemPoolAncestors on a set of transactions that are already\n+        // in the mempool.\n+        assert(entries.size() == 1);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r670187216",
      "id" : 670187216,
      "in_reply_to_id" : 665677347,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MDE4NzIxNg==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 190,
      "original_position" : 64,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 706991489,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-15T06:58:52Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/670187216",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r670187368"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/670187368"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Removed this constraint",
      "commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "created_at" : "2021-07-15T06:59:08Z",
      "diff_hunk" : "@@ -151,33 +152,47 @@ void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashes\n     }\n }\n \n-bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString, bool fSearchForParents /* = true */) const\n+bool CTxMemPool::CalculateMemPoolAncestors(const std::vector<CTxMemPoolEntry::CTxMemPoolEntryRef>& entries,\n+                                           setEntries& setAncestors,\n+                                           const uint64_t limitAncestorCount,\n+                                           const uint64_t limitAncestorSize,\n+                                           const uint64_t limitDescendantCount,\n+                                           const uint64_t limitDescendantSize,\n+                                           std::string &errString,\n+                                           const bool fSearchForParents /*=true*/) const\n {\n-    CTxMemPoolEntry::Parents staged_ancestors;\n-    const CTransaction &tx = entry.GetTx();\n+    const size_t total_virtual_size = std::accumulate(entries.cbegin(), entries.cend(), 0,\n+                                      [](int64_t sum, const auto& entry)\n+                                      { return sum + GetVirtualTransactionSize(entry.get().GetTx()); });\n+    const size_t total_count = entries.size();\n \n+    CTxMemPoolEntry::Parents staged_ancestors;\n     if (fSearchForParents) {\n-        // Get parents of this transaction that are in the mempool\n-        // GetMemPoolParents() is only valid for entries in the mempool, so we\n-        // iterate mapTx to find parents.\n-        for (unsigned int i = 0; i < tx.vin.size(); i++) {\n-            std::optional<txiter> piter = GetIter(tx.vin[i].prevout.hash);\n-            if (piter) {\n-                staged_ancestors.insert(**piter);\n-                if (staged_ancestors.size() + 1 > limitAncestorCount) {\n-                    errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n-                    return false;\n+        for (const auto& entry : entries) {\n+            // Get parents of this transaction that are in the mempool\n+            // GetMemPoolParents() is only valid for entries in the mempool, so we\n+            // iterate mapTx to find parents.\n+            for (const auto& input : entry.get().GetTx().vin) {\n+                std::optional<txiter> piter = GetIter(input.prevout.hash);\n+                if (piter) {\n+                    staged_ancestors.insert(**piter);\n+                    if (staged_ancestors.size() + total_count > limitAncestorCount) {\n+                        errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                        return false;\n+                    }\n                 }\n             }\n         }\n     } else {\n-        // If we're not searching for parents, we require this to be an\n-        // entry in the mempool already.\n-        txiter it = mapTx.iterator_to(entry);\n-        staged_ancestors = it->GetMemPoolParentsConst();\n+        // If we're not searching for parents, we require all entries to be in the mempool already.\n+        // We should never use CalculateMemPoolAncestors on a set of transactions that are already",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r670187368",
      "id" : 670187368,
      "in_reply_to_id" : 665676930,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MDE4NzM2OA==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 188,
      "original_position" : 62,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 706991683,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-15T06:59:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/670187368",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r670191602"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/670191602"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Right, removed",
      "commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "created_at" : "2021-07-15T07:06:37Z",
      "diff_hunk" : "@@ -681,6 +681,34 @@ class CTxMemPool\n      */\n     bool CalculateMemPoolAncestors(const CTxMemPoolEntry& entry, setEntries& setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string& errString, bool fSearchForParents = true) const EXCLUSIVE_LOCKS_REQUIRED(cs);\n \n+    /** Try to calculate all in-mempool ancestors of a set of entries, and check for ancestor and\n+     * descendant limits (all are inclusive of the transactions in entries). The same limits are\n+     * used no matter how many transactions are passed in. For example, if entries.size() = 3 and\n+     * the limit is 25, the union of all 3 sets of ancestors must be <= 22.\n+     * @param[in]       entries                 Entries corresponding to transaction(s) being\n+     *                                          evaluated for acceptance to mempool. If there are\n+     *                                          multiple, they must not already be in the mempool.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r670191602",
      "id" : 670191602,
      "in_reply_to_id" : 665239317,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MDE5MTYwMg==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 706,
      "original_position" : 10,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 706997151,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-15T07:06:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/670191602",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r670193900"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/670193900"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Another problem with editing these variables is we'd need to change the error logging (current log would use the decremented count instead of actual limit), so I've left it as is.",
      "commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "created_at" : "2021-07-15T07:10:07Z",
      "diff_hunk" : "@@ -151,33 +152,47 @@ void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashes\n     }\n }\n \n-bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString, bool fSearchForParents /* = true */) const\n+bool CTxMemPool::CalculateMemPoolAncestors(const std::vector<CTxMemPoolEntry::CTxMemPoolEntryRef>& entries,\n+                                           setEntries& setAncestors,\n+                                           const uint64_t limitAncestorCount,\n+                                           const uint64_t limitAncestorSize,\n+                                           const uint64_t limitDescendantCount,\n+                                           const uint64_t limitDescendantSize,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r670193900",
      "id" : 670193900,
      "in_reply_to_id" : 665275481,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3MDE5MzkwMA==",
      "original_commit_id" : "ef6004ca88f8033074898687b18dc0b156702dc6",
      "original_line" : 160,
      "original_position" : 18,
      "original_start_line" : 157,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 706999888,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : "RIGHT",
      "updated_at" : "2021-07-15T07:10:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/670193900",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r674769853"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/674769853"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Current project style is to name functions and methods with UpperCaseCamel:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/36aee0f3538ec3399a3838041ea5993aba5f518b/doc/developer-notes.md#L92",
      "commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "created_at" : "2021-07-22T12:55:55Z",
      "diff_hunk" : "@@ -151,34 +151,17 @@ void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashes\n     }\n }\n \n-bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString, bool fSearchForParents /* = true */) const\n+bool CTxMemPool::calculateAncestorsAndCheckLimits(size_t entry_size,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r674769853",
      "id" : 674769853,
      "line" : 154,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NDc2OTg1Mw==",
      "original_commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "original_line" : 154,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 5,
      "pull_request_review_id" : 712704251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-22T13:57:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/674769853",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r674772033"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/674772033"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n                                          CTxMemPoolEntry::Parents& staged_ancestors,\r\n```",
      "commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "created_at" : "2021-07-22T12:58:56Z",
      "diff_hunk" : "@@ -585,6 +586,25 @@ class CTxMemPool\n      */\n     std::set<uint256> m_unbroadcast_txids GUARDED_BY(cs);\n \n+\n+    /**\n+     * Helper function to calculate all in-mempool ancestors of staged_ancestors and apply\n+     * ancestor/descendant limits. Inclusive of entry_size and entry_count.\n+     * param@[in]   entry_size          Virtual size to include in the limits.\n+     * param@[in]   entry_count         How many entries to include in the limits.\n+     * param@[in]   staged_ancestors    Should contain entries in the mempool.\n+     * param@[out]  setAncestors        Will be populated with all mempool ancestors.\n+     */\n+    bool calculateAncestorsAndCheckLimits(size_t entry_size,\n+                                          size_t entry_count,\n+                                          setEntries& setAncestors,\n+                                          CTxMemPoolEntry::Parents &staged_ancestors,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r674772033",
      "id" : 674772033,
      "line" : 601,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NDc3MjAzMw==",
      "original_commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "original_line" : 601,
      "original_position" : 24,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : 24,
      "pull_request_review_id" : 712704251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-22T13:57:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/674772033",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r674782488"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/674782488"
         }
      },
      "author_association" : "MEMBER",
      "body" : "```suggestion\r\n     * Helper function to calculate all in-mempool ancestors of staged_ancestors (including staged_ancestors themselves) and apply\r\n```\r\n\r\nor similar to document that setAncestors will include the transactions in staged_ancestors.",
      "commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "created_at" : "2021-07-22T13:12:45Z",
      "diff_hunk" : "@@ -585,6 +586,25 @@ class CTxMemPool\n      */\n     std::set<uint256> m_unbroadcast_txids GUARDED_BY(cs);\n \n+\n+    /**\n+     * Helper function to calculate all in-mempool ancestors of staged_ancestors and apply",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r674782488",
      "id" : 674782488,
      "line" : 591,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NDc4MjQ4OA==",
      "original_commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "original_line" : 591,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : 14,
      "pull_request_review_id" : 712704251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-22T13:57:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/674782488",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r674785456"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/674785456"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The `&` jumps from right to left between commits. Perhaps just have this as `setEntries& setAncestors` in commit _MOVEONLY: add helper function for calculating ancestors and checking limits_",
      "commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "created_at" : "2021-07-22T13:16:28Z",
      "diff_hunk" : "@@ -585,6 +586,25 @@ class CTxMemPool\n      */\n     std::set<uint256> m_unbroadcast_txids GUARDED_BY(cs);\n \n+\n+    /**\n+     * Helper function to calculate all in-mempool ancestors of staged_ancestors and apply\n+     * ancestor/descendant limits. Inclusive of entry_size and entry_count.\n+     * param@[in]   entry_size          Virtual size to include in the limits.\n+     * param@[in]   entry_count         How many entries to include in the limits.\n+     * param@[in]   staged_ancestors    Should contain entries in the mempool.\n+     * param@[out]  setAncestors        Will be populated with all mempool ancestors.\n+     */\n+    bool calculateAncestorsAndCheckLimits(size_t entry_size,\n+                                          size_t entry_count,\n+                                          setEntries& setAncestors,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r674785456",
      "id" : 674785456,
      "line" : 600,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NDc4NTQ1Ng==",
      "original_commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "original_line" : 600,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : 23,
      "pull_request_review_id" : 712704251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-22T13:57:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/674785456",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r674801171"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/674801171"
         }
      },
      "author_association" : "MEMBER",
      "body" : "These conditional log changes make the function less generic (it now knows something semantic about the caller). If you really want this \"possibly \" prefix, you could prepend it in the calling function:\r\n\r\n```diff\r\n     // When multiple transactions are passed in, the ancestors and descendants of all transactions\r\n     // considered together must be within limits even if they are not interdependent. This may be\r\n     // stricter than the limits for each individual transaction.\r\n-    return calculateAncestorsAndCheckLimits(total_size, package.size(),\r\n-                                            setAncestors, staged_ancestors,\r\n-                                            limitAncestorCount, limitAncestorSize,\r\n-                                            limitDescendantCount, limitDescendantSize, errString);\r\n+    auto ret = calculateAncestorsAndCheckLimits(total_size, package.size(),\r\n+                                                setAncestors, staged_ancestors,\r\n+                                                limitAncestorCount, limitAncestorSize,\r\n+                                                limitDescendantCount, limitDescendantSize, errString);\r\n+\r\n+    errString.insert(0, \"possibly \");\r\n+    return ret;\r\n }\r\n```\r\n\r\nAlthough I don't think you really need it. If someone is submitting packages through the RPC, then presumably they're a sophisticated user and they'll be able to understand that a heuristic is being used to calculate ancestor/descendant limits.\r\n\r\nYou could also update the only place that this string is used:\r\n\r\n```diff\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -1094,7 +1094,7 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::\r\n             // be implementation-dependent, and it's likely to be multiple transactions because we\r\n             // evaluated all of them together. Return the same failure for all transactions.\r\n             for (auto& ws : workspaces) {\r\n-                ws.m_state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"exceeds-ancestor-descendant-limits\", err_string);\r\n+                ws.m_state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"exceeds-ancestor-descendant-limits-heuristic\", err_string);\r\n                 results.emplace(ws.m_ptx->GetWitnessHash(), MempoolAcceptResult::Failure(ws.m_state));\r\n             }\r\n             package_state.Invalid(PackageValidationResult::PCKG_POLICY, \"package-mempool-limits\");\r\n```",
      "commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "created_at" : "2021-07-22T13:35:25Z",
      "diff_hunk" : "@@ -187,14 +170,20 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n         staged_ancestors.erase(stage);\n         totalSizeWithAncestors += stageit->GetTxSize();\n \n-        if (stageit->GetSizeWithDescendants() + entry.GetTxSize() > limitDescendantSize) {\n-            errString = strprintf(\"exceeds descendant size limit for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString(), limitDescendantSize);\n+        if (stageit->GetSizeWithDescendants() + entry_size > limitDescendantSize) {\n+            errString = strprintf(\"%sexceeds descendant size limit for tx %s [limit: %u]\",\n+                                  entry_count > 1 ? \"possibly \" : \"\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r674801171",
      "id" : 674801171,
      "line" : 175,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NDgwMTE3MQ==",
      "original_commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "original_line" : 175,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 53,
      "pull_request_review_id" : 712704251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-22T13:57:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/674801171",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r674803415"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/674803415"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Document basic type arguments:\r\n\r\n```suggestion\r\n    return calculateAncestorsAndCheckLimits(entry.GetTxSize(), /* entry_count */ 1, setAncestors, staged_ancestors,\r\n```",
      "commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "created_at" : "2021-07-22T13:38:07Z",
      "diff_hunk" : "@@ -216,6 +207,69 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n     return true;\n }\n \n+bool CTxMemPool::CalculateMemPoolAncestors(const Package& package,\n+                                           setEntries& setAncestors,\n+                                           uint64_t limitAncestorCount,\n+                                           uint64_t limitAncestorSize,\n+                                           uint64_t limitDescendantCount,\n+                                           uint64_t limitDescendantSize,\n+                                           std::string &errString) const\n+{\n+    CTxMemPoolEntry::Parents staged_ancestors;\n+    size_t total_size = 0;\n+    for (const auto& tx : package) {\n+        total_size += GetVirtualTransactionSize(*tx);\n+        for (const auto& input : tx->vin) {\n+            std::optional<txiter> piter = GetIter(input.prevout.hash);\n+            if (piter) {\n+                staged_ancestors.insert(**piter);\n+                if (staged_ancestors.size() + package.size() > limitAncestorCount) {\n+                    errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                    return false;\n+                }\n+            }\n+        }\n+    }\n+    // When multiple transactions are passed in, the ancestors and descendants of all transactions\n+    // considered together must be within limits even if they are not interdependent. This may be\n+    // stricter than the limits for each individual transaction.\n+    return calculateAncestorsAndCheckLimits(total_size, package.size(),\n+                                            setAncestors, staged_ancestors,\n+                                            limitAncestorCount, limitAncestorSize,\n+                                            limitDescendantCount, limitDescendantSize, errString);\n+}\n+\n+bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString, bool fSearchForParents /* = true */) const\n+{\n+    CTxMemPoolEntry::Parents staged_ancestors;\n+    const CTransaction &tx = entry.GetTx();\n+\n+    if (fSearchForParents) {\n+        // Get parents of this transaction that are in the mempool\n+        // GetMemPoolParents() is only valid for entries in the mempool, so we\n+        // iterate mapTx to find parents.\n+        for (unsigned int i = 0; i < tx.vin.size(); i++) {\n+            std::optional<txiter> piter = GetIter(tx.vin[i].prevout.hash);\n+            if (piter) {\n+                staged_ancestors.insert(**piter);\n+                if (staged_ancestors.size() + 1 > limitAncestorCount) {\n+                    errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                    return false;\n+                }\n+            }\n+        }\n+    } else {\n+        // If we're not searching for parents, we require this to already be an\n+        // entry in the mempool and use the entry's cached parents.\n+        txiter it = mapTx.iterator_to(entry);\n+        staged_ancestors = it->GetMemPoolParentsConst();\n+    }\n+\n+    return calculateAncestorsAndCheckLimits(entry.GetTxSize(), 1, setAncestors, staged_ancestors,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r674803415",
      "id" : 674803415,
      "line" : 268,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NDgwMzQxNQ==",
      "original_commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "original_line" : 268,
      "original_position" : 146,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 146,
      "pull_request_review_id" : 712704251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-22T13:57:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/674803415",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r674806029"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/674806029"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Would it make sense to have an early exit here if `total_size` exceeds `limitAncestorSize` (similar to if the ancestor count exceeds `limitAncestorCount`)?",
      "commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "created_at" : "2021-07-22T13:41:11Z",
      "diff_hunk" : "@@ -216,6 +207,69 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n     return true;\n }\n \n+bool CTxMemPool::CalculateMemPoolAncestors(const Package& package,\n+                                           setEntries& setAncestors,\n+                                           uint64_t limitAncestorCount,\n+                                           uint64_t limitAncestorSize,\n+                                           uint64_t limitDescendantCount,\n+                                           uint64_t limitDescendantSize,\n+                                           std::string &errString) const\n+{\n+    CTxMemPoolEntry::Parents staged_ancestors;\n+    size_t total_size = 0;\n+    for (const auto& tx : package) {\n+        total_size += GetVirtualTransactionSize(*tx);\n+        for (const auto& input : tx->vin) {\n+            std::optional<txiter> piter = GetIter(input.prevout.hash);\n+            if (piter) {\n+                staged_ancestors.insert(**piter);\n+                if (staged_ancestors.size() + package.size() > limitAncestorCount) {\n+                    errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                    return false;\n+                }\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r674806029",
      "id" : 674806029,
      "line" : 230,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NDgwNjAyOQ==",
      "original_commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "original_line" : 230,
      "original_position" : 108,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 108,
      "pull_request_review_id" : 712704251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-22T13:57:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/674806029",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r674810604"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/674810604"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This function doesn't need to have a `setAncestors` out param, since the only place that it's called doesn't use it. In fact, you could rename this function to something like `CheckPackageLimits()` to better document what it's used for.",
      "commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "created_at" : "2021-07-22T13:46:26Z",
      "diff_hunk" : "@@ -216,6 +207,69 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n     return true;\n }\n \n+bool CTxMemPool::CalculateMemPoolAncestors(const Package& package,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r674810604",
      "id" : 674810604,
      "line" : 210,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NDgxMDYwNA==",
      "original_commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "original_line" : 210,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 88,
      "pull_request_review_id" : 712704251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-22T13:57:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/674810604",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r674848246"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/674848246"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Not sure. In practice, it wouldn't happen since we would have checked the package limits already",
      "commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "created_at" : "2021-07-22T14:25:17Z",
      "diff_hunk" : "@@ -216,6 +207,69 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n     return true;\n }\n \n+bool CTxMemPool::CalculateMemPoolAncestors(const Package& package,\n+                                           setEntries& setAncestors,\n+                                           uint64_t limitAncestorCount,\n+                                           uint64_t limitAncestorSize,\n+                                           uint64_t limitDescendantCount,\n+                                           uint64_t limitDescendantSize,\n+                                           std::string &errString) const\n+{\n+    CTxMemPoolEntry::Parents staged_ancestors;\n+    size_t total_size = 0;\n+    for (const auto& tx : package) {\n+        total_size += GetVirtualTransactionSize(*tx);\n+        for (const auto& input : tx->vin) {\n+            std::optional<txiter> piter = GetIter(input.prevout.hash);\n+            if (piter) {\n+                staged_ancestors.insert(**piter);\n+                if (staged_ancestors.size() + package.size() > limitAncestorCount) {\n+                    errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                    return false;\n+                }\n+            }",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r674848246",
      "id" : 674848246,
      "in_reply_to_id" : 674806029,
      "line" : 230,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NDg0ODI0Ng==",
      "original_commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "original_line" : 230,
      "original_position" : 108,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 108,
      "pull_request_review_id" : 712856832,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-22T14:25:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/674848246",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "tACK \r\n\r\nRan the tests locally and also tried to tweak the tests to make sure everything was working fine. \r\n\r\nWhile checking for ancestors limit for a transaction we are checking the total number of ancestors including itself should be within 25, but when we are checking for descendants limit for a transaction we are checking the total number of descendants excluding itself should be within 25. Is this the expected behavior? Or do we want to include the transaction also while checking the descendant limits?\r\n\r\nTo test that the transaction itself is excluded when checking descendants limit I changed the 'A' shaped test a little, I reduced the number of in mempool transactions in the left limb from 12 to 11 (total 26 transactions, 24 in mempool and 2 in package) and kept everything else the same and the test failed.\r\n\r\nSimilarly, to test that the transaction itself is included when checking ancestor limit I changed the 'V' shaped test, I reduced the number of in mempool transactions in the left limb from 12 to 11 (total 26 transactions, 23 in mempool and 3 in package) and kept everything else the same and the test Passed.\r\n\r\n\r\nTested 27986f8 on Ubuntu 18.04 ",
      "created_at" : "2021-07-25T18:18:43Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#issuecomment-886239343",
      "id" : 886239343,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21800",
      "node_id" : "IC_kwDOABII58400vBv",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-25T18:18:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/886239343",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32807799?v=4",
         "events_url" : "https://api.github.com/users/ritickgoenka/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ritickgoenka/followers",
         "following_url" : "https://api.github.com/users/ritickgoenka/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ritickgoenka/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ritickgoenka",
         "id" : 32807799,
         "login" : "ritickgoenka",
         "node_id" : "MDQ6VXNlcjMyODA3Nzk5",
         "organizations_url" : "https://api.github.com/users/ritickgoenka/orgs",
         "received_events_url" : "https://api.github.com/users/ritickgoenka/received_events",
         "repos_url" : "https://api.github.com/users/ritickgoenka/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ritickgoenka/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ritickgoenka/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ritickgoenka"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for the review @ritickgoenka!\r\n\r\n> While checking for ancestors limit for a transaction we are checking the total number of ancestors including itself should be within 25, but when we are checking for descendants limit for a transaction we are checking the total number of descendants excluding itself should be within 25. \r\n\r\nI don't think this is true. Descendant limits are also inclusive of the transaction.\r\n\r\n> To test that the transaction itself is excluded when checking descendants limit I changed the 'A' shaped test a little, I reduced the number of in mempool transactions in the left limb from 12 to 11 (total 26 transactions, 24 in mempool and 2 in package) and kept everything else the same and the test failed.\r\n\r\nI looked into this, and realized that I mislabeled the transactions in the diagram - my bad. The current test has 24 transactions in the mempool and 2 in the package, so if you reduced the mempool transactions, it's 23+2 which is within limits. That's why the test would fail. I've updated the comment and added assertions for the number of transactions in mempool and package.",
      "created_at" : "2021-07-26T10:45:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#issuecomment-886588979",
      "id" : 886588979,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21800",
      "node_id" : "IC_kwDOABII58402EYz",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-26T10:45:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/886588979",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Addressed @jnewbery's comments and added another test",
      "created_at" : "2021-07-26T10:46:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#issuecomment-886589456",
      "id" : 886589456,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21800",
      "node_id" : "IC_kwDOABII58402EgQ",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-26T10:46:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/886589456",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r676493060"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676493060"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good point - done :)",
      "commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "created_at" : "2021-07-26T10:46:20Z",
      "diff_hunk" : "@@ -216,6 +207,69 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n     return true;\n }\n \n+bool CTxMemPool::CalculateMemPoolAncestors(const Package& package,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r676493060",
      "id" : 676493060,
      "in_reply_to_id" : 674810604,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NjQ5MzA2MA==",
      "original_commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "original_line" : 210,
      "original_position" : 88,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 714700738,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-26T10:46:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676493060",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r676493156"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676493156"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Added",
      "commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "created_at" : "2021-07-26T10:46:30Z",
      "diff_hunk" : "@@ -216,6 +207,69 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n     return true;\n }\n \n+bool CTxMemPool::CalculateMemPoolAncestors(const Package& package,\n+                                           setEntries& setAncestors,\n+                                           uint64_t limitAncestorCount,\n+                                           uint64_t limitAncestorSize,\n+                                           uint64_t limitDescendantCount,\n+                                           uint64_t limitDescendantSize,\n+                                           std::string &errString) const\n+{\n+    CTxMemPoolEntry::Parents staged_ancestors;\n+    size_t total_size = 0;\n+    for (const auto& tx : package) {\n+        total_size += GetVirtualTransactionSize(*tx);\n+        for (const auto& input : tx->vin) {\n+            std::optional<txiter> piter = GetIter(input.prevout.hash);\n+            if (piter) {\n+                staged_ancestors.insert(**piter);\n+                if (staged_ancestors.size() + package.size() > limitAncestorCount) {\n+                    errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                    return false;\n+                }\n+            }\n+        }\n+    }\n+    // When multiple transactions are passed in, the ancestors and descendants of all transactions\n+    // considered together must be within limits even if they are not interdependent. This may be\n+    // stricter than the limits for each individual transaction.\n+    return calculateAncestorsAndCheckLimits(total_size, package.size(),\n+                                            setAncestors, staged_ancestors,\n+                                            limitAncestorCount, limitAncestorSize,\n+                                            limitDescendantCount, limitDescendantSize, errString);\n+}\n+\n+bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString, bool fSearchForParents /* = true */) const\n+{\n+    CTxMemPoolEntry::Parents staged_ancestors;\n+    const CTransaction &tx = entry.GetTx();\n+\n+    if (fSearchForParents) {\n+        // Get parents of this transaction that are in the mempool\n+        // GetMemPoolParents() is only valid for entries in the mempool, so we\n+        // iterate mapTx to find parents.\n+        for (unsigned int i = 0; i < tx.vin.size(); i++) {\n+            std::optional<txiter> piter = GetIter(tx.vin[i].prevout.hash);\n+            if (piter) {\n+                staged_ancestors.insert(**piter);\n+                if (staged_ancestors.size() + 1 > limitAncestorCount) {\n+                    errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                    return false;\n+                }\n+            }\n+        }\n+    } else {\n+        // If we're not searching for parents, we require this to already be an\n+        // entry in the mempool and use the entry's cached parents.\n+        txiter it = mapTx.iterator_to(entry);\n+        staged_ancestors = it->GetMemPoolParentsConst();\n+    }\n+\n+    return calculateAncestorsAndCheckLimits(entry.GetTxSize(), 1, setAncestors, staged_ancestors,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r676493156",
      "id" : 676493156,
      "in_reply_to_id" : 674803415,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NjQ5MzE1Ng==",
      "original_commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "original_line" : 268,
      "original_position" : 146,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 714701084,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-26T10:46:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676493156",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r676493617"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676493617"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good point, added the \"possibly \" prefix outside",
      "commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "created_at" : "2021-07-26T10:47:07Z",
      "diff_hunk" : "@@ -187,14 +170,20 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n         staged_ancestors.erase(stage);\n         totalSizeWithAncestors += stageit->GetTxSize();\n \n-        if (stageit->GetSizeWithDescendants() + entry.GetTxSize() > limitDescendantSize) {\n-            errString = strprintf(\"exceeds descendant size limit for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString(), limitDescendantSize);\n+        if (stageit->GetSizeWithDescendants() + entry_size > limitDescendantSize) {\n+            errString = strprintf(\"%sexceeds descendant size limit for tx %s [limit: %u]\",\n+                                  entry_count > 1 ? \"possibly \" : \"\",",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r676493617",
      "id" : 676493617,
      "in_reply_to_id" : 674801171,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NjQ5MzYxNw==",
      "original_commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "original_line" : 175,
      "original_position" : 53,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 714702344,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-26T10:47:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676493617",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r676493830"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676493830"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "created_at" : "2021-07-26T10:47:17Z",
      "diff_hunk" : "@@ -585,6 +586,25 @@ class CTxMemPool\n      */\n     std::set<uint256> m_unbroadcast_txids GUARDED_BY(cs);\n \n+\n+    /**\n+     * Helper function to calculate all in-mempool ancestors of staged_ancestors and apply",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r676493830",
      "id" : 676493830,
      "in_reply_to_id" : 674782488,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NjQ5MzgzMA==",
      "original_commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "original_line" : 591,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : null,
      "pull_request_review_id" : 714702492,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-26T10:47:17Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676493830",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r676494012"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676494012"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "created_at" : "2021-07-26T10:47:27Z",
      "diff_hunk" : "@@ -585,6 +586,25 @@ class CTxMemPool\n      */\n     std::set<uint256> m_unbroadcast_txids GUARDED_BY(cs);\n \n+\n+    /**\n+     * Helper function to calculate all in-mempool ancestors of staged_ancestors and apply\n+     * ancestor/descendant limits. Inclusive of entry_size and entry_count.\n+     * param@[in]   entry_size          Virtual size to include in the limits.\n+     * param@[in]   entry_count         How many entries to include in the limits.\n+     * param@[in]   staged_ancestors    Should contain entries in the mempool.\n+     * param@[out]  setAncestors        Will be populated with all mempool ancestors.\n+     */\n+    bool calculateAncestorsAndCheckLimits(size_t entry_size,\n+                                          size_t entry_count,\n+                                          setEntries& setAncestors,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r676494012",
      "id" : 676494012,
      "in_reply_to_id" : 674785456,
      "line" : 600,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NjQ5NDAxMg==",
      "original_commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "original_line" : 600,
      "original_position" : 23,
      "original_start_line" : null,
      "path" : "src/txmempool.h",
      "position" : 23,
      "pull_request_review_id" : 714702609,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-26T10:47:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676494012",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r676494133"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676494133"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "created_at" : "2021-07-26T10:47:35Z",
      "diff_hunk" : "@@ -151,34 +151,17 @@ void CTxMemPool::UpdateTransactionsFromBlock(const std::vector<uint256> &vHashes\n     }\n }\n \n-bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntries &setAncestors, uint64_t limitAncestorCount, uint64_t limitAncestorSize, uint64_t limitDescendantCount, uint64_t limitDescendantSize, std::string &errString, bool fSearchForParents /* = true */) const\n+bool CTxMemPool::calculateAncestorsAndCheckLimits(size_t entry_size,",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r676494133",
      "id" : 676494133,
      "in_reply_to_id" : 674769853,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NjQ5NDEzMw==",
      "original_commit_id" : "27986f86c6fce4ceef232b0955bfbaef80a18977",
      "original_line" : 154,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 714702689,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-26T10:47:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676494133",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r676527653"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676527653"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No need for these new calls to `generate(1)`.",
      "commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "created_at" : "2021-07-26T11:41:42Z",
      "diff_hunk" : "@@ -181,6 +185,232 @@ def test_chain(self):\n         # Clean up by clearing the mempool\n         node.generate(1)\n \n+    def test_chain_limits_helper(self, mempool_count, package_count):\n+        node = self.nodes[0]\n+        first_coin = self.coins.pop()\n+        parent_locking_script = None\n+        txid = first_coin[\"txid\"]\n+        chain_hex = []\n+        chain_txns = []\n+        value = first_coin[\"amount\"]\n+\n+        for i in range(mempool_count + package_count):\n+            (tx, txhex, value, parent_locking_script) = self.chain_transaction(txid, value, 0, parent_locking_script)\n+            txid = tx.rehash()\n+            if i < mempool_count:\n+                node.sendrawtransaction(txhex)\n+                assert_equal(node.getrawmempool(verbose=True)[txid][\"ancestorcount\"], i + 1)\n+            else:\n+                chain_hex.append(txhex)\n+                chain_txns.append(tx)\n+        testres_too_long = node.testmempoolaccept(rawtxs=chain_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"reject-reason\"], \"exceeds-ancestor-descendant-limits\")\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=chain_hex)])\n+\n+    def test_chain_limits(self):\n+        \"\"\"Create chains from mempool and package transactions that are longer than 25,\n+        but only if both in-mempool and in-package transactions are considered together.\n+        This checks that both mempool and in-package transactions are taken into account when\n+        calculating ancestors/descendant limits.\n+        \"\"\"\n+        self.log.info(\"Check that in-package ancestors count for mempool ancestor limits\")\n+\n+        # 24 transactions in the mempool and 2 in the package. The parent in the package has\n+        # 24 in-mempool ancestors and 1 in-package descendant. The child has 0 direct parents\n+        # in the mempool, but 25 in-mempool and in-package ancestors in total.\n+        self.test_chain_limits_helper(24, 2)\n+        # 2 transactions in the mempool and 24 in the package.\n+        self.test_chain_limits_helper(2, 24)\n+        # 13 transactions in the mempool and 13 in the package.\n+        self.test_chain_limits_helper(13, 13)\n+\n+    def test_descendant_limits(self):\n+        \"\"\"Create an 'A' shaped package with 24 transactions in the mempool and 2 in the package:\n+                    M1\n+                   ^  ^\n+                 M2a  M2b\n+                .       .\n+               .         .\n+              .           .\n+             M12a          ^\n+            ^              M13b\n+           ^                 ^\n+          Pa                  Pb\n+        The top ancestor in the package exceeds descendant limits but only if the in-mempool and in-package\n+        descendants are all considered together (24 including in-mempool descendants and 26 including both\n+        package transactions).\n+        \"\"\"\n+        node = self.nodes[0]\n+        self.log.info(\"Check that in-mempool and in-package descendants are calculated properly in packages\")\n+        # Top parent in mempool, M1\n+        first_coin = self.coins.pop()\n+        parent_value = (first_coin[\"amount\"] - Decimal(\"0.0002\")) / 2 # Deduct reasonable fee and make 2 outputs\n+        inputs = [{\"txid\": first_coin[\"txid\"], \"vout\": 0}]\n+        outputs = [{self.address : parent_value}, {ADDRESS_BCRT1_P2WSH_OP_TRUE : parent_value}]\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+\n+        parent_signed = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=self.privkeys)\n+        assert parent_signed[\"complete\"]\n+        parent_tx = tx_from_hex(parent_signed[\"hex\"])\n+        parent_txid = parent_tx.rehash()\n+        node.sendrawtransaction(parent_signed[\"hex\"])\n+\n+        package_hex = []\n+\n+        # Chain A\n+        parent_locking_script = parent_tx.vout[0].scriptPubKey.hex()\n+        value = parent_value\n+        txid = parent_txid\n+        for i in range(12):\n+            (tx, txhex, value, parent_locking_script) = self.chain_transaction(txid, value, 0, parent_locking_script)\n+            txid = tx.rehash()\n+            if i < 11: # M2a... M12a\n+                node.sendrawtransaction(txhex)\n+            else: # Pa\n+                package_hex.append(txhex)\n+\n+        # Chain B\n+        value = parent_value - Decimal(\"0.0001\")\n+        rawtx_b = node.createrawtransaction([{\"txid\": parent_txid, \"vout\": 1}], {self.address : value})\n+        tx_child_b = tx_from_hex(rawtx_b) # M2b\n+        tx_child_b.wit.vtxinwit = [CTxInWitness()]\n+        tx_child_b.wit.vtxinwit[0].scriptWitness.stack = [CScript([OP_TRUE])]\n+        tx_child_b_hex = tx_child_b.serialize().hex()\n+        node.sendrawtransaction(tx_child_b_hex)\n+        parent_locking_script = tx_child_b.vout[0].scriptPubKey.hex()\n+        txid = tx_child_b.rehash()\n+        for i in range(12):\n+            (tx, txhex, value, parent_locking_script) = self.chain_transaction(txid, value, 0, parent_locking_script)\n+            txid = tx.rehash()\n+            if i < 11: # M3b... M13b\n+                node.sendrawtransaction(txhex)\n+            else: # Pb\n+                package_hex.append(txhex)\n+\n+        assert_equal(24, node.getmempoolinfo()[\"size\"])\n+        assert_equal(2, len(package_hex))\n+        testres_too_long = node.testmempoolaccept(rawtxs=package_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"reject-reason\"], \"exceeds-ancestor-descendant-limits\")\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=package_hex)])\n+        node.generate(1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r676527653",
      "id" : 676527653,
      "line" : 305,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NjUyNzY1Mw==",
      "original_commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "original_line" : 305,
      "original_position" : 132,
      "original_start_line" : null,
      "path" : "test/functional/rpc_packages.py",
      "position" : 132,
      "pull_request_review_id" : 714744880,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-26T11:48:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676527653",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r676530625"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676530625"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Might be worth commenting why you're prefixing the error string with \"possibly\" here.",
      "commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "created_at" : "2021-07-26T11:46:39Z",
      "diff_hunk" : "@@ -216,6 +200,79 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n     return true;\n }\n \n+bool CTxMemPool::CheckPackageLimits(const Package& package,\n+                                    uint64_t limitAncestorCount,\n+                                    uint64_t limitAncestorSize,\n+                                    uint64_t limitDescendantCount,\n+                                    uint64_t limitDescendantSize,\n+                                    std::string &errString) const\n+{\n+    CTxMemPoolEntry::Parents staged_ancestors;\n+    size_t total_size = 0;\n+    for (const auto& tx : package) {\n+        total_size += GetVirtualTransactionSize(*tx);\n+        for (const auto& input : tx->vin) {\n+            std::optional<txiter> piter = GetIter(input.prevout.hash);\n+            if (piter) {\n+                staged_ancestors.insert(**piter);\n+                if (staged_ancestors.size() + package.size() > limitAncestorCount) {\n+                    errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                    return false;\n+                }\n+            }\n+        }\n+    }\n+    // When multiple transactions are passed in, the ancestors and descendants of all transactions\n+    // considered together must be within limits even if they are not interdependent. This may be\n+    // stricter than the limits for each individual transaction.\n+    setEntries setAncestors;\n+    const auto ret = CalculateAncestorsAndCheckLimits(total_size, package.size(),\n+                                                      setAncestors, staged_ancestors,\n+                                                      limitAncestorCount, limitAncestorSize,\n+                                                      limitDescendantCount, limitDescendantSize, errString);\n+    if (!ret) errString.insert(0, \"possibly \");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r676530625",
      "id" : 676530625,
      "line" : 233,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3NjUzMDYyNQ==",
      "original_commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "original_line" : 233,
      "original_position" : 100,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 100,
      "pull_request_review_id" : 714744880,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-07-26T11:48:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/676530625",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "reACK 6d8f687\r\n\r\nTested the new test which was added. \r\nAlso, wrote a new test to check the overestimation of descendant limits and it was working fine.\r\n\r\nTested on Ubuntu 18.04",
      "created_at" : "2021-07-27T13:20:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#issuecomment-887506781",
      "id" : 887506781,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21800",
      "node_id" : "IC_kwDOABII58405kdd",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-27T13:20:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/887506781",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32807799?v=4",
         "events_url" : "https://api.github.com/users/ritickgoenka/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ritickgoenka/followers",
         "following_url" : "https://api.github.com/users/ritickgoenka/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ritickgoenka/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ritickgoenka",
         "id" : 32807799,
         "login" : "ritickgoenka",
         "node_id" : "MDQ6VXNlcjMyODA3Nzk5",
         "organizations_url" : "https://api.github.com/users/ritickgoenka/orgs",
         "received_events_url" : "https://api.github.com/users/ritickgoenka/received_events",
         "repos_url" : "https://api.github.com/users/ritickgoenka/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ritickgoenka/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ritickgoenka/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ritickgoenka"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Concept ACK\r\n\r\nReally nice work!",
      "created_at" : "2021-07-30T01:51:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#issuecomment-889569576",
      "id" : 889569576,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21800",
      "node_id" : "IC_kwDOABII5841BcEo",
      "performed_via_github_app" : null,
      "updated_at" : "2021-07-30T01:51:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/889569576",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/8435003?v=4",
         "events_url" : "https://api.github.com/users/tryphe/events{/privacy}",
         "followers_url" : "https://api.github.com/users/tryphe/followers",
         "following_url" : "https://api.github.com/users/tryphe/following{/other_user}",
         "gists_url" : "https://api.github.com/users/tryphe/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/tryphe",
         "id" : 8435003,
         "login" : "tryphe",
         "node_id" : "MDQ6VXNlcjg0MzUwMDM=",
         "organizations_url" : "https://api.github.com/users/tryphe/orgs",
         "received_events_url" : "https://api.github.com/users/tryphe/received_events",
         "repos_url" : "https://api.github.com/users/tryphe/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/tryphe/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/tryphe/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/tryphe"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r681490129"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/681490129"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Agree",
      "commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "created_at" : "2021-08-03T07:03:16Z",
      "diff_hunk" : "@@ -216,6 +200,79 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n     return true;\n }\n \n+bool CTxMemPool::CheckPackageLimits(const Package& package,\n+                                    uint64_t limitAncestorCount,\n+                                    uint64_t limitAncestorSize,\n+                                    uint64_t limitDescendantCount,\n+                                    uint64_t limitDescendantSize,\n+                                    std::string &errString) const\n+{\n+    CTxMemPoolEntry::Parents staged_ancestors;\n+    size_t total_size = 0;\n+    for (const auto& tx : package) {\n+        total_size += GetVirtualTransactionSize(*tx);\n+        for (const auto& input : tx->vin) {\n+            std::optional<txiter> piter = GetIter(input.prevout.hash);\n+            if (piter) {\n+                staged_ancestors.insert(**piter);\n+                if (staged_ancestors.size() + package.size() > limitAncestorCount) {\n+                    errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                    return false;\n+                }\n+            }\n+        }\n+    }\n+    // When multiple transactions are passed in, the ancestors and descendants of all transactions\n+    // considered together must be within limits even if they are not interdependent. This may be\n+    // stricter than the limits for each individual transaction.\n+    setEntries setAncestors;\n+    const auto ret = CalculateAncestorsAndCheckLimits(total_size, package.size(),\n+                                                      setAncestors, staged_ancestors,\n+                                                      limitAncestorCount, limitAncestorSize,\n+                                                      limitDescendantCount, limitDescendantSize, errString);\n+    if (!ret) errString.insert(0, \"possibly \");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r681490129",
      "id" : 681490129,
      "in_reply_to_id" : 676530625,
      "line" : 233,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MTQ5MDEyOQ==",
      "original_commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "original_line" : 233,
      "original_position" : 100,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 100,
      "pull_request_review_id" : 720847603,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-03T07:42:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/681490129",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r682704976"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/682704976"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In the future, if packages are allowed to replace in-mempool transactions do we have concerns of the same transaction accounted _twice_ falsifying this check ?\r\n\r\nLet's say you have in-mempool { Tx_A } and in-package { Tx_A, Tx_B } where Tx_A is parent of Tx_B. Within this configuration, Tx_A is going to be counted twice, firstly as a `staged_ancestors` member and secondly as a `package` member. \r\n\r\nIf this reasoning holds, one solution to be future-proof could be to proceed to the evaluation against `limitAncestorCount` after the for iteration, and once dedup between `staged_ancestors` and `package` has been done.",
      "commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "created_at" : "2021-08-04T15:05:31Z",
      "diff_hunk" : "@@ -216,6 +200,79 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n     return true;\n }\n \n+bool CTxMemPool::CheckPackageLimits(const Package& package,\n+                                    uint64_t limitAncestorCount,\n+                                    uint64_t limitAncestorSize,\n+                                    uint64_t limitDescendantCount,\n+                                    uint64_t limitDescendantSize,\n+                                    std::string &errString) const\n+{\n+    CTxMemPoolEntry::Parents staged_ancestors;\n+    size_t total_size = 0;\n+    for (const auto& tx : package) {\n+        total_size += GetVirtualTransactionSize(*tx);\n+        for (const auto& input : tx->vin) {\n+            std::optional<txiter> piter = GetIter(input.prevout.hash);\n+            if (piter) {\n+                staged_ancestors.insert(**piter);\n+                if (staged_ancestors.size() + package.size() > limitAncestorCount) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r682704976",
      "id" : 682704976,
      "line" : 218,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MjcwNDk3Ng==",
      "original_commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "original_line" : 218,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 85,
      "pull_request_review_id" : 722403138,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-04T16:32:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/682704976",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r682714869"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/682714869"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Note, I think for the other package policy checks in `CheckPackage` we only return a `PackageValidationResult` without per-transaction results. If we want the package acceptance interface to be consistent, I believe we can leave `results` empty. As such, package policy failure overrides transaction policy one ?\r\n\r\nAt least `m_tx_results` doc in `src/validation.h` L216 could be clearer on this point. ",
      "commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "created_at" : "2021-08-04T15:16:25Z",
      "diff_hunk" : "@@ -1084,6 +1084,22 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::\n         m_viewmempool.PackageAddTransaction(ws.m_ptx);\n     }\n \n+    // Apply package mempool ancestor/descendant limits.\n+    std::string err_string;\n+    if (!m_pool.CheckPackageLimits(txns, m_limit_ancestors, m_limit_ancestor_size, m_limit_descendants,\n+                                   m_limit_descendant_size, err_string)) {\n+        // All transactions must have individually passed mempool ancestor and descendant limits\n+        // inside of PreChecks(). Figuring out which transaction to attribute this failure to may be\n+        // implementation-dependent, and it's likely to be multiple transactions because we\n+        // evaluated all of them together. Return the same failure for all transactions.\n+        for (auto& ws : workspaces) {\n+            ws.m_state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"exceeds-ancestor-descendant-limits\", err_string);\n+            results.emplace(ws.m_ptx->GetWitnessHash(), MempoolAcceptResult::Failure(ws.m_state));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r682714869",
      "id" : 682714869,
      "line" : 1097,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MjcxNDg2OQ==",
      "original_commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "original_line" : 1097,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 14,
      "pull_request_review_id" : 722403138,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-04T16:32:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/682714869",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r682734547"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/682734547"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think this check doesn't have new coverage in `rpc_package.py ? I got a success for the following diff:\r\n```\r\ndiff --git a/src/txmempool.cpp b/src/txmempool.cpp\r\nindex 85911e15d..c7fa9fc62 100644\r\n--- a/src/txmempool.cpp\r\n+++ b/src/txmempool.cpp\r\n@@ -173,7 +173,7 @@ bool CTxMemPool::CalculateAncestorsAndCheckLimits(size_t entry_size,\r\n \r\n         if (stageit->GetSizeWithDescendants() + entry_size > limitDescendantSize) {\r\n             errString = strprintf(\"exceeds descendant size limit for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString(), limitDescendantSize);\r\n-            return false;\r\n+            return true;\r\n         } else if (stageit->GetCountWithDescendants() + entry_count > limitDescendantCount) {\r\n             errString = strprintf(\"too many descendants for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString(), limitDescendantCount);\r\n             return false;\r\n```",
      "commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "created_at" : "2021-08-04T15:38:52Z",
      "diff_hunk" : "@@ -187,10 +171,10 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n         staged_ancestors.erase(stage);\n         totalSizeWithAncestors += stageit->GetTxSize();\n \n-        if (stageit->GetSizeWithDescendants() + entry.GetTxSize() > limitDescendantSize) {\n+        if (stageit->GetSizeWithDescendants() + entry_size > limitDescendantSize) {\n             errString = strprintf(\"exceeds descendant size limit for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString(), limitDescendantSize);\n             return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r682734547",
      "id" : 682734547,
      "line" : 176,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MjczNDU0Nw==",
      "original_commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "original_line" : 176,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 51,
      "pull_request_review_id" : 722403138,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-04T16:32:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/682734547",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r682776019"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/682776019"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think we have topologies of in-mempool transactions and packages bypassing this limit.\r\n\r\nLet's say you have in-mempool, independent Tx_A and Tx_B where their virtual sizes are 30 KvB each.\r\nLet's say you have packages transactions Tx_C and _Tx_D where Tx_C is a child of A and B and Tx_D is a child of Tx_C their virtual sizes are 30 KvB each.\r\n\r\nIn `CheckPackageLimits`, Tx_C isn't already in the mempool (`mapTx` is only updated in `Finalize`) and as such shouldn't part of `staged_ancestors`. This set should be composed of Tx_A and Tx_B only.\r\n\r\nIn `CalculateAncestorsAndCheckLimits`, `totalSizeWithAncestors` is the union Tx_A and Tx_B and its sum of 60 KvB is inferior to 101 KvB. After Tx_C and Tx_D are added to the mempool, the chain of transactions ABCD is of the sum 120 KvB.\r\n\r\nFurther, I don't think it's rejected by the check against `limitDescendantSize`, as Tx_A and Tx_B are evaluated independently, and not as a single cluster as they should be (Tx_A + Tx_C + Tx_D or Tx_B + Tx_C + Tx_D)\r\n\r\nNote, you need to replace Tx by chain of transactions because of `MAX_STANDARD_TX_WEIGHT` but I think this reasoning holds ?",
      "commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "created_at" : "2021-08-04T16:29:23Z",
      "diff_hunk" : "@@ -187,10 +171,10 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n         staged_ancestors.erase(stage);\n         totalSizeWithAncestors += stageit->GetTxSize();\n \n-        if (stageit->GetSizeWithDescendants() + entry.GetTxSize() > limitDescendantSize) {\n+        if (stageit->GetSizeWithDescendants() + entry_size > limitDescendantSize) {\n             errString = strprintf(\"exceeds descendant size limit for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString(), limitDescendantSize);\n             return false;\n-        } else if (stageit->GetCountWithDescendants() + 1 > limitDescendantCount) {\n+        } else if (stageit->GetCountWithDescendants() + entry_count > limitDescendantCount) {\n             errString = strprintf(\"too many descendants for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString(), limitDescendantCount);\n             return false;\n         } else if (totalSizeWithAncestors > limitAncestorSize) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r682776019",
      "id" : 682776019,
      "line" : 180,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4Mjc3NjAxOQ==",
      "original_commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "original_line" : 180,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 56,
      "pull_request_review_id" : 722403138,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-04T16:32:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/682776019",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r683256913"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683256913"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yep, this is absolutely a consideration for replacements and duplicates in packages in the future. I agree, we'll want to de-duplicate first (CMPA and CheckPackageLimits wouldn't be called for transactions already in the mempool, since PreChecks looks for `txn-already-in-mempool` before this). Additionally, we'll want to subtract the size/count of transactions being replaced from descendant limits before calling this function.",
      "commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "created_at" : "2021-08-05T08:48:24Z",
      "diff_hunk" : "@@ -216,6 +200,79 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n     return true;\n }\n \n+bool CTxMemPool::CheckPackageLimits(const Package& package,\n+                                    uint64_t limitAncestorCount,\n+                                    uint64_t limitAncestorSize,\n+                                    uint64_t limitDescendantCount,\n+                                    uint64_t limitDescendantSize,\n+                                    std::string &errString) const\n+{\n+    CTxMemPoolEntry::Parents staged_ancestors;\n+    size_t total_size = 0;\n+    for (const auto& tx : package) {\n+        total_size += GetVirtualTransactionSize(*tx);\n+        for (const auto& input : tx->vin) {\n+            std::optional<txiter> piter = GetIter(input.prevout.hash);\n+            if (piter) {\n+                staged_ancestors.insert(**piter);\n+                if (staged_ancestors.size() + package.size() > limitAncestorCount) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r683256913",
      "id" : 683256913,
      "in_reply_to_id" : 682704976,
      "line" : 218,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MzI1NjkxMw==",
      "original_commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "original_line" : 218,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 85,
      "pull_request_review_id" : 723096659,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-05T08:48:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683256913",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r683258608"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683258608"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "That's a good point - perhaps it would be better to copy the error string from the `TxValidationState` into the `PackageValidationState` and always return results empty when we have a package-wide error.",
      "commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "created_at" : "2021-08-05T08:50:34Z",
      "diff_hunk" : "@@ -1084,6 +1084,22 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::\n         m_viewmempool.PackageAddTransaction(ws.m_ptx);\n     }\n \n+    // Apply package mempool ancestor/descendant limits.\n+    std::string err_string;\n+    if (!m_pool.CheckPackageLimits(txns, m_limit_ancestors, m_limit_ancestor_size, m_limit_descendants,\n+                                   m_limit_descendant_size, err_string)) {\n+        // All transactions must have individually passed mempool ancestor and descendant limits\n+        // inside of PreChecks(). Figuring out which transaction to attribute this failure to may be\n+        // implementation-dependent, and it's likely to be multiple transactions because we\n+        // evaluated all of them together. Return the same failure for all transactions.\n+        for (auto& ws : workspaces) {\n+            ws.m_state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"exceeds-ancestor-descendant-limits\", err_string);\n+            results.emplace(ws.m_ptx->GetWitnessHash(), MempoolAcceptResult::Failure(ws.m_state));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r683258608",
      "id" : 683258608,
      "in_reply_to_id" : 682714869,
      "line" : 1097,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MzI1ODYwOA==",
      "original_commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "original_line" : 1097,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 14,
      "pull_request_review_id" : 723098852,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-05T08:50:34Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683258608",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r683259424"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683259424"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This error should be caught in the mempool_tests unit test?\r\n\r\nIt's true, though, that I didn't write tests for the size limits, just did count limits. I can add size limit tests.",
      "commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "created_at" : "2021-08-05T08:51:32Z",
      "diff_hunk" : "@@ -187,10 +171,10 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n         staged_ancestors.erase(stage);\n         totalSizeWithAncestors += stageit->GetTxSize();\n \n-        if (stageit->GetSizeWithDescendants() + entry.GetTxSize() > limitDescendantSize) {\n+        if (stageit->GetSizeWithDescendants() + entry_size > limitDescendantSize) {\n             errString = strprintf(\"exceeds descendant size limit for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString(), limitDescendantSize);\n             return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r683259424",
      "id" : 683259424,
      "in_reply_to_id" : 682734547,
      "line" : 176,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MzI1OTQyNA==",
      "original_commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "original_line" : 176,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 51,
      "pull_request_review_id" : 723099871,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-05T09:03:43Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683259424",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r683263216"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683263216"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "(I will note this down for the future - I think we're on the same page about this, and it's not yet applicable for this PR)",
      "commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "created_at" : "2021-08-05T08:56:15Z",
      "diff_hunk" : "@@ -216,6 +200,79 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n     return true;\n }\n \n+bool CTxMemPool::CheckPackageLimits(const Package& package,\n+                                    uint64_t limitAncestorCount,\n+                                    uint64_t limitAncestorSize,\n+                                    uint64_t limitDescendantCount,\n+                                    uint64_t limitDescendantSize,\n+                                    std::string &errString) const\n+{\n+    CTxMemPoolEntry::Parents staged_ancestors;\n+    size_t total_size = 0;\n+    for (const auto& tx : package) {\n+        total_size += GetVirtualTransactionSize(*tx);\n+        for (const auto& input : tx->vin) {\n+            std::optional<txiter> piter = GetIter(input.prevout.hash);\n+            if (piter) {\n+                staged_ancestors.insert(**piter);\n+                if (staged_ancestors.size() + package.size() > limitAncestorCount) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r683263216",
      "id" : 683263216,
      "in_reply_to_id" : 682704976,
      "line" : 218,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MzI2MzIxNg==",
      "original_commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "original_line" : 218,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 85,
      "pull_request_review_id" : 723104604,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-05T08:56:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683263216",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r683647947"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683647947"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Done",
      "commit_id" : "5d513c0698dfe088e6dcd77ade59a0b34d92efbd",
      "created_at" : "2021-08-05T17:22:24Z",
      "diff_hunk" : "@@ -216,6 +200,79 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n     return true;\n }\n \n+bool CTxMemPool::CheckPackageLimits(const Package& package,\n+                                    uint64_t limitAncestorCount,\n+                                    uint64_t limitAncestorSize,\n+                                    uint64_t limitDescendantCount,\n+                                    uint64_t limitDescendantSize,\n+                                    std::string &errString) const\n+{\n+    CTxMemPoolEntry::Parents staged_ancestors;\n+    size_t total_size = 0;\n+    for (const auto& tx : package) {\n+        total_size += GetVirtualTransactionSize(*tx);\n+        for (const auto& input : tx->vin) {\n+            std::optional<txiter> piter = GetIter(input.prevout.hash);\n+            if (piter) {\n+                staged_ancestors.insert(**piter);\n+                if (staged_ancestors.size() + package.size() > limitAncestorCount) {\n+                    errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                    return false;\n+                }\n+            }\n+        }\n+    }\n+    // When multiple transactions are passed in, the ancestors and descendants of all transactions\n+    // considered together must be within limits even if they are not interdependent. This may be\n+    // stricter than the limits for each individual transaction.\n+    setEntries setAncestors;\n+    const auto ret = CalculateAncestorsAndCheckLimits(total_size, package.size(),\n+                                                      setAncestors, staged_ancestors,\n+                                                      limitAncestorCount, limitAncestorSize,\n+                                                      limitDescendantCount, limitDescendantSize, errString);\n+    if (!ret) errString.insert(0, \"possibly \");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r683647947",
      "id" : 683647947,
      "in_reply_to_id" : 676530625,
      "line" : 234,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MzY0Nzk0Nw==",
      "original_commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "original_line" : 234,
      "original_position" : 100,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 101,
      "pull_request_review_id" : 723615008,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-05T17:22:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683647947",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r683648206"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683648206"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Good point :P removed. Added asserts for empty mempool in each of the subtests.",
      "commit_id" : "5d513c0698dfe088e6dcd77ade59a0b34d92efbd",
      "created_at" : "2021-08-05T17:22:45Z",
      "diff_hunk" : "@@ -181,6 +185,232 @@ def test_chain(self):\n         # Clean up by clearing the mempool\n         node.generate(1)\n \n+    def test_chain_limits_helper(self, mempool_count, package_count):\n+        node = self.nodes[0]\n+        first_coin = self.coins.pop()\n+        parent_locking_script = None\n+        txid = first_coin[\"txid\"]\n+        chain_hex = []\n+        chain_txns = []\n+        value = first_coin[\"amount\"]\n+\n+        for i in range(mempool_count + package_count):\n+            (tx, txhex, value, parent_locking_script) = self.chain_transaction(txid, value, 0, parent_locking_script)\n+            txid = tx.rehash()\n+            if i < mempool_count:\n+                node.sendrawtransaction(txhex)\n+                assert_equal(node.getrawmempool(verbose=True)[txid][\"ancestorcount\"], i + 1)\n+            else:\n+                chain_hex.append(txhex)\n+                chain_txns.append(tx)\n+        testres_too_long = node.testmempoolaccept(rawtxs=chain_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"reject-reason\"], \"exceeds-ancestor-descendant-limits\")\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=chain_hex)])\n+\n+    def test_chain_limits(self):\n+        \"\"\"Create chains from mempool and package transactions that are longer than 25,\n+        but only if both in-mempool and in-package transactions are considered together.\n+        This checks that both mempool and in-package transactions are taken into account when\n+        calculating ancestors/descendant limits.\n+        \"\"\"\n+        self.log.info(\"Check that in-package ancestors count for mempool ancestor limits\")\n+\n+        # 24 transactions in the mempool and 2 in the package. The parent in the package has\n+        # 24 in-mempool ancestors and 1 in-package descendant. The child has 0 direct parents\n+        # in the mempool, but 25 in-mempool and in-package ancestors in total.\n+        self.test_chain_limits_helper(24, 2)\n+        # 2 transactions in the mempool and 24 in the package.\n+        self.test_chain_limits_helper(2, 24)\n+        # 13 transactions in the mempool and 13 in the package.\n+        self.test_chain_limits_helper(13, 13)\n+\n+    def test_descendant_limits(self):\n+        \"\"\"Create an 'A' shaped package with 24 transactions in the mempool and 2 in the package:\n+                    M1\n+                   ^  ^\n+                 M2a  M2b\n+                .       .\n+               .         .\n+              .           .\n+             M12a          ^\n+            ^              M13b\n+           ^                 ^\n+          Pa                  Pb\n+        The top ancestor in the package exceeds descendant limits but only if the in-mempool and in-package\n+        descendants are all considered together (24 including in-mempool descendants and 26 including both\n+        package transactions).\n+        \"\"\"\n+        node = self.nodes[0]\n+        self.log.info(\"Check that in-mempool and in-package descendants are calculated properly in packages\")\n+        # Top parent in mempool, M1\n+        first_coin = self.coins.pop()\n+        parent_value = (first_coin[\"amount\"] - Decimal(\"0.0002\")) / 2 # Deduct reasonable fee and make 2 outputs\n+        inputs = [{\"txid\": first_coin[\"txid\"], \"vout\": 0}]\n+        outputs = [{self.address : parent_value}, {ADDRESS_BCRT1_P2WSH_OP_TRUE : parent_value}]\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+\n+        parent_signed = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=self.privkeys)\n+        assert parent_signed[\"complete\"]\n+        parent_tx = tx_from_hex(parent_signed[\"hex\"])\n+        parent_txid = parent_tx.rehash()\n+        node.sendrawtransaction(parent_signed[\"hex\"])\n+\n+        package_hex = []\n+\n+        # Chain A\n+        parent_locking_script = parent_tx.vout[0].scriptPubKey.hex()\n+        value = parent_value\n+        txid = parent_txid\n+        for i in range(12):\n+            (tx, txhex, value, parent_locking_script) = self.chain_transaction(txid, value, 0, parent_locking_script)\n+            txid = tx.rehash()\n+            if i < 11: # M2a... M12a\n+                node.sendrawtransaction(txhex)\n+            else: # Pa\n+                package_hex.append(txhex)\n+\n+        # Chain B\n+        value = parent_value - Decimal(\"0.0001\")\n+        rawtx_b = node.createrawtransaction([{\"txid\": parent_txid, \"vout\": 1}], {self.address : value})\n+        tx_child_b = tx_from_hex(rawtx_b) # M2b\n+        tx_child_b.wit.vtxinwit = [CTxInWitness()]\n+        tx_child_b.wit.vtxinwit[0].scriptWitness.stack = [CScript([OP_TRUE])]\n+        tx_child_b_hex = tx_child_b.serialize().hex()\n+        node.sendrawtransaction(tx_child_b_hex)\n+        parent_locking_script = tx_child_b.vout[0].scriptPubKey.hex()\n+        txid = tx_child_b.rehash()\n+        for i in range(12):\n+            (tx, txhex, value, parent_locking_script) = self.chain_transaction(txid, value, 0, parent_locking_script)\n+            txid = tx.rehash()\n+            if i < 11: # M3b... M13b\n+                node.sendrawtransaction(txhex)\n+            else: # Pb\n+                package_hex.append(txhex)\n+\n+        assert_equal(24, node.getmempoolinfo()[\"size\"])\n+        assert_equal(2, len(package_hex))\n+        testres_too_long = node.testmempoolaccept(rawtxs=package_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"reject-reason\"], \"exceeds-ancestor-descendant-limits\")\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=package_hex)])\n+        node.generate(1)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r683648206",
      "id" : 683648206,
      "in_reply_to_id" : 676527653,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MzY0ODIwNg==",
      "original_commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "original_line" : 305,
      "original_position" : 132,
      "original_start_line" : null,
      "path" : "test/functional/rpc_packages.py",
      "position" : null,
      "pull_request_review_id" : 723615365,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-05T17:22:46Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683648206",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r683648914"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683648914"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for the suggestion - I got rid of the tx results when there's a package-wide error, and added a comment explaining what to expect for `m_tx_results` in validation.h",
      "commit_id" : "5d513c0698dfe088e6dcd77ade59a0b34d92efbd",
      "created_at" : "2021-08-05T17:23:44Z",
      "diff_hunk" : "@@ -1084,6 +1084,22 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::\n         m_viewmempool.PackageAddTransaction(ws.m_ptx);\n     }\n \n+    // Apply package mempool ancestor/descendant limits.\n+    std::string err_string;\n+    if (!m_pool.CheckPackageLimits(txns, m_limit_ancestors, m_limit_ancestor_size, m_limit_descendants,\n+                                   m_limit_descendant_size, err_string)) {\n+        // All transactions must have individually passed mempool ancestor and descendant limits\n+        // inside of PreChecks(). Figuring out which transaction to attribute this failure to may be\n+        // implementation-dependent, and it's likely to be multiple transactions because we\n+        // evaluated all of them together. Return the same failure for all transactions.\n+        for (auto& ws : workspaces) {\n+            ws.m_state.Invalid(TxValidationResult::TX_MEMPOOL_POLICY, \"exceeds-ancestor-descendant-limits\", err_string);\n+            results.emplace(ws.m_ptx->GetWitnessHash(), MempoolAcceptResult::Failure(ws.m_state));",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r683648914",
      "id" : 683648914,
      "in_reply_to_id" : 682714869,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MzY0ODkxNA==",
      "original_commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "original_line" : 1097,
      "original_position" : 14,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : null,
      "pull_request_review_id" : 723616276,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-05T17:23:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683648914",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r683649480"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683649480"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Added a functional test for size limits - `test_desc_size_limits()` will fail if you apply this diff",
      "commit_id" : "5d513c0698dfe088e6dcd77ade59a0b34d92efbd",
      "created_at" : "2021-08-05T17:24:38Z",
      "diff_hunk" : "@@ -187,10 +171,10 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n         staged_ancestors.erase(stage);\n         totalSizeWithAncestors += stageit->GetTxSize();\n \n-        if (stageit->GetSizeWithDescendants() + entry.GetTxSize() > limitDescendantSize) {\n+        if (stageit->GetSizeWithDescendants() + entry_size > limitDescendantSize) {\n             errString = strprintf(\"exceeds descendant size limit for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString(), limitDescendantSize);\n             return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r683649480",
      "id" : 683649480,
      "in_reply_to_id" : 682734547,
      "line" : 176,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MzY0OTQ4MA==",
      "original_commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "original_line" : 176,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 51,
      "pull_request_review_id" : 723617106,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-05T17:24:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683649480",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r683651128"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683651128"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hm, I don't think this case bypasses the algorithm. I've implemented this test in the latest push (see `test_anc_size_limits()`) and it passes for me. It's possible I misunderstood your description, but it seems like we're good here?",
      "commit_id" : "5d513c0698dfe088e6dcd77ade59a0b34d92efbd",
      "created_at" : "2021-08-05T17:27:00Z",
      "diff_hunk" : "@@ -187,10 +171,10 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n         staged_ancestors.erase(stage);\n         totalSizeWithAncestors += stageit->GetTxSize();\n \n-        if (stageit->GetSizeWithDescendants() + entry.GetTxSize() > limitDescendantSize) {\n+        if (stageit->GetSizeWithDescendants() + entry_size > limitDescendantSize) {\n             errString = strprintf(\"exceeds descendant size limit for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString(), limitDescendantSize);\n             return false;\n-        } else if (stageit->GetCountWithDescendants() + 1 > limitDescendantCount) {\n+        } else if (stageit->GetCountWithDescendants() + entry_count > limitDescendantCount) {\n             errString = strprintf(\"too many descendants for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString(), limitDescendantCount);\n             return false;\n         } else if (totalSizeWithAncestors > limitAncestorSize) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r683651128",
      "id" : 683651128,
      "in_reply_to_id" : 682776019,
      "line" : 180,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MzY1MTEyOA==",
      "original_commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "original_line" : 180,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 56,
      "pull_request_review_id" : 723619273,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-05T17:27:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683651128",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r683700379"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683700379"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It's somewhat surprising to have an existing error message prefixed with 'possibly', I checked that it works for the current messages in `CalculateAncestorsAndCheckLimits`, but the validity of this text manipulation seems to be hard to guarantee over future changes to the code.\r\nBut I don't know a better solution to this, The grammatical correctness of the error message is not super critical.",
      "commit_id" : "5d513c0698dfe088e6dcd77ade59a0b34d92efbd",
      "created_at" : "2021-08-05T18:39:18Z",
      "diff_hunk" : "@@ -216,6 +200,79 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n     return true;\n }\n \n+bool CTxMemPool::CheckPackageLimits(const Package& package,\n+                                    uint64_t limitAncestorCount,\n+                                    uint64_t limitAncestorSize,\n+                                    uint64_t limitDescendantCount,\n+                                    uint64_t limitDescendantSize,\n+                                    std::string &errString) const\n+{\n+    CTxMemPoolEntry::Parents staged_ancestors;\n+    size_t total_size = 0;\n+    for (const auto& tx : package) {\n+        total_size += GetVirtualTransactionSize(*tx);\n+        for (const auto& input : tx->vin) {\n+            std::optional<txiter> piter = GetIter(input.prevout.hash);\n+            if (piter) {\n+                staged_ancestors.insert(**piter);\n+                if (staged_ancestors.size() + package.size() > limitAncestorCount) {\n+                    errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                    return false;\n+                }\n+            }\n+        }\n+    }\n+    // When multiple transactions are passed in, the ancestors and descendants of all transactions\n+    // considered together must be within limits even if they are not interdependent. This may be\n+    // stricter than the limits for each individual transaction.\n+    setEntries setAncestors;\n+    const auto ret = CalculateAncestorsAndCheckLimits(total_size, package.size(),\n+                                                      setAncestors, staged_ancestors,\n+                                                      limitAncestorCount, limitAncestorSize,\n+                                                      limitDescendantCount, limitDescendantSize, errString);\n+    if (!ret) errString.insert(0, \"possibly \");",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r683700379",
      "id" : 683700379,
      "in_reply_to_id" : 676530625,
      "line" : 234,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4MzcwMDM3OQ==",
      "original_commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "original_line" : 234,
      "original_position" : 100,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 101,
      "pull_request_review_id" : 723681762,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-05T18:39:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/683700379",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review ACK 5d513c0698dfe088e6dcd77ade59a0b34d92efbd",
      "created_at" : "2021-08-05T18:57:47Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#issuecomment-893704289",
      "id" : 893704289,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21800",
      "node_id" : "IC_kwDOABII5841RNhh",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-05T18:57:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/893704289",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "https://cirrus-ci.com/task/6628050143019008:\r\n```bash\r\nRun tx_pool_standard with args ['/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz', '-runs=1', '/tmp/cirrus-ci-build/ci/scratch/qa-assets/fuzz_seed_corpus/tx_pool_standard']INFO: Seed: 517370066\r\nINFO: Loaded 1 modules   (547316 inline 8-bit counters): 547316 [0x556b20760ed8, 0x556b207e68cc), \r\nINFO: Loaded 1 PC tables (547316 PCs): 547316 [0x556b207e68d0,0x556b21040810), \r\nINFO:     3949 files found in /tmp/cirrus-ci-build/ci/scratch/qa-assets/fuzz_seed_corpus/tx_pool_standard\r\nINFO: -max_len is not provided; libFuzzer will not generate inputs larger than 1048576 bytes\r\nINFO: seed corpus: files: 3949 min: 1b max: 1048576b total: 95048838b rss: 213Mb\r\n#128\tpulse  cov: 17131 ft: 25503 corp: 122/895b exec/s: 64 rss: 225Mb\r\n#256\tpulse  cov: 17352 ft: 36520 corp: 244/2752b exec/s: 64 rss: 247Mb\r\n#512\tpulse  cov: 23370 ft: 57316 corp: 399/6397b exec/s: 56 rss: 292Mb\r\n#1024\tpulse  cov: 25687 ft: 82402 corp: 673/19Kb exec/s: 44 rss: 400Mb\r\nfuzz: test/fuzz/tx_pool.cpp:232: auto (anonymous namespace)::tx_pool_standard_fuzz_target(FuzzBufferType)::(anonymous class)::operator()() const: Assertion `\"it != result_package.m_tx_results.end()\" && check' failed.\r\n==24597== ERROR: libFuzzer: deadly signal\r\n    #0 0x556b1cad4ab1  (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x278fab1)\r\n    #1 0x556b1ca1fc08  (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x26dac08)\r\n    #2 0x556b1ca04d53  (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x26bfd53)\r\n    #3 0x7f50944353bf  (/lib/x86_64-linux-gnu/libpthread.so.0+0x153bf)\r\n    #4 0x7f509407918a  (/lib/x86_64-linux-gnu/libc.so.6+0x4618a)\r\n    #5 0x7f5094058858  (/lib/x86_64-linux-gnu/libc.so.6+0x25858)\r\n    #6 0x7f5094058728  (/lib/x86_64-linux-gnu/libc.so.6+0x25728)\r\n    #7 0x7f5094069f35  (/lib/x86_64-linux-gnu/libc.so.6+0x36f35)\r\n    #8 0x556b1cf8b787  (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x2c46787)\r\n    #9 0x556b1cb00a77  (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x27bba77)\r\n    #10 0x556b1e4256f7  (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x40e06f7)\r\n    #11 0x556b1e4253a5  (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x40e03a5)\r\n    #12 0x556b1ca06411  (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x26c1411)\r\n    #13 0x556b1ca05b55  (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x26c0b55)\r\n    #14 0x556b1ca08477  (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x26c3477)\r\n    #15 0x556b1ca087d9  (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x26c37d9)\r\n    #16 0x556b1c9f74ae  (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x26b24ae)\r\n    #17 0x556b1ca202f2  (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x26db2f2)\r\n    #18 0x7f509405a0b2  (/lib/x86_64-linux-gnu/libc.so.6+0x270b2)\r\n    #19 0x556b1c9cc24d  (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x268724d)\r\nNOTE: libFuzzer has rudimentary signal handlers.\r\n      Combine libFuzzer with AddressSanitizer or similar for better crash reports.\r\nSUMMARY: libFuzzer: deadly signal\r\nMS: 0 ; base unit: 0000000000000000000000000000000000000000\r\n0xb3,0xb3,0xb3,0xb3,0x83,0x83,0x2f,0x2f,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xb,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x65,0x65,0x65,0x65,0x65,0x65,0x65,0x65,0x65,0x65,0x65,0xc9,0xc9,0xcb,0x1,0x0,0xcb,\r\n\\xb3\\xb3\\xb3\\xb3\\x83\\x83//\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\x0b\\x00\\x00\\x00\\x00\\x00\\x00\\x00eeeeeeeeeee\\xc9\\xc9\\xcb\\x01\\x00\\xcb\r\nartifact_prefix='./'; Test unit written to ./crash-8bc5eec8ddffef064fc1834346b11548218b6153\r\nBase64: s7Ozs4ODLy/Ly8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLCwAAAAAAAABlZWVlZWVlZWVlZcnJywEAyw==Run tx_pool_standard with args ['/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz', '-runs=1', '/tmp/cirrus-ci-build/ci/scratch/qa-assets/fuzz_seed_corpus/tx_pool_standard']INFO: Seed: 517370066\r\nINFO: Loaded 1 modules   (547316 inline 8-bit counters): 547316 [0x556b20760ed8, 0x556b207e68cc), \r\nINFO: Loaded 1 PC tables (547316 PCs): 547316 [0x556b207e68d0,0x556b21040810), \r\nINFO:     3949 files found in /tmp/cirrus-ci-build/ci/scratch/qa-assets/fuzz_seed_corpus/tx_pool_standard\r\nINFO: -max_len is not provided; libFuzzer will not generate inputs larger than 1048576 bytes\r\nINFO: seed corpus: files: 3949 min: 1b max: 1048576b total: 95048838b rss: 213Mb\r\n#128\tpulse  cov: 17131 ft: 25503 corp: 122/895b exec/s: 64 rss: 225Mb\r\n#256\tpulse  cov: 17352 ft: 36520 corp: 244/2752b exec/s: 64 rss: 247Mb\r\n#512\tpulse  cov: 23370 ft: 57316 corp: 399/6397b exec/s: 56 rss: 292Mb\r\n#1024\tpulse  cov: 25687 ft: 82402 corp: 673/19Kb exec/s: 44 rss: 400Mb\r\nfuzz: test/fuzz/tx_pool.cpp:232: auto (anonymous namespace)::tx_pool_standard_fuzz_target(FuzzBufferType)::(anonymous class)::operator()() const: Assertion `\"it != result_package.m_tx_results.end()\" && check' failed.\r\n==24597== ERROR: libFuzzer: deadly signal\r\n    #0 0x556b1cad4ab1  (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x278fab1)\r\n    #1 0x556b1ca1fc08  (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x26dac08)\r\n    #2 0x556b1ca04d53  (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x26bfd53)\r\n    #3 0x7f50944353bf  (/lib/x86_64-linux-gnu/libpthread.so.0+0x153bf)\r\n    #4 0x7f509407918a  (/lib/x86_64-linux-gnu/libc.so.6+0x4618a)\r\n    #5 0x7f5094058858  (/lib/x86_64-linux-gnu/libc.so.6+0x25858)\r\n    #6 0x7f5094058728  (/lib/x86_64-linux-gnu/libc.so.6+0x25728)\r\n    #7 0x7f5094069f35  (/lib/x86_64-linux-gnu/libc.so.6+0x36f35)\r\n    #8 0x556b1cf8b787  (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x2c46787)\r\n    #9 0x556b1cb00a77  (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x27bba77)\r\n    #10 0x556b1e4256f7  (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x40e06f7)\r\n    #11 0x556b1e4253a5  (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x40e03a5)\r\n    #12 0x556b1ca06411  (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x26c1411)\r\n    #13 0x556b1ca05b55  (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x26c0b55)\r\n    #14 0x556b1ca08477  (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x26c3477)\r\n    #15 0x556b1ca087d9  (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x26c37d9)\r\n    #16 0x556b1c9f74ae  (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x26b24ae)\r\n    #17 0x556b1ca202f2  (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x26db2f2)\r\n    #18 0x7f509405a0b2  (/lib/x86_64-linux-gnu/libc.so.6+0x270b2)\r\n    #19 0x556b1c9cc24d  (/tmp/cirrus-ci-build/ci/scratch/build/bitcoin-x86_64-pc-linux-gnu/src/test/fuzz/fuzz+0x268724d)\r\nNOTE: libFuzzer has rudimentary signal handlers.\r\n      Combine libFuzzer with AddressSanitizer or similar for better crash reports.\r\nSUMMARY: libFuzzer: deadly signal\r\nMS: 0 ; base unit: 0000000000000000000000000000000000000000\r\n0xb3,0xb3,0xb3,0xb3,0x83,0x83,0x2f,0x2f,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xcb,0xb,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x65,0x65,0x65,0x65,0x65,0x65,0x65,0x65,0x65,0x65,0x65,0xc9,0xc9,0xcb,0x1,0x0,0xcb,\r\n\\xb3\\xb3\\xb3\\xb3\\x83\\x83//\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\xcb\\x0b\\x00\\x00\\x00\\x00\\x00\\x00\\x00eeeeeeeeeee\\xc9\\xc9\\xcb\\x01\\x00\\xcb\r\nartifact_prefix='./'; Test unit written to ./crash-8bc5eec8ddffef064fc1834346b11548218b6153\r\nBase64: s7Ozs4ODLy/Ly8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLCwAAAAAAAABlZWVlZWVlZWVlZcnJywEAyw==\r\n```",
      "created_at" : "2021-08-06T00:02:09Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#issuecomment-893902886",
      "id" : 893902886,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21800",
      "node_id" : "IC_kwDOABII5841R-Am",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-06T00:02:09Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/893902886",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks @fanquake. I've pushed a fix for what I expect is the culprit - single transaction ancestor/descendant limits can sometimes be slightly looser due to CPFP carve out; the decision to not return any tx results here would have caused that crash. I've gated `CheckPackageLimits()` to only run when there's more than one transaction.",
      "created_at" : "2021-08-06T09:23:25Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#issuecomment-894129689",
      "id" : 894129689,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21800",
      "node_id" : "IC_kwDOABII5841S1YZ",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-06T12:12:25Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/894129689",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Addressed review comments and added tests for size limits (thanks @ariard for motivating) Ready for review again! ",
      "created_at" : "2021-08-06T12:11:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#issuecomment-894217264",
      "id" : 894217264,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21800",
      "node_id" : "IC_kwDOABII5841TKww",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-06T12:11:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/894217264",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r684743188"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/684743188"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> Additionally, we'll want to subtract the size/count of transactions being replaced from descendant limits before calling this function.\r\n\r\nExactly, this is another limit case to be aware of. And even trickier one like an ancestor of a second-stage package member being replaced by a first-stage package member and thus failing the whole package acceptance.\r\n\r\nYes, not yet applicable for this PR, good to not forget about it!",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-08T09:16:11Z",
      "diff_hunk" : "@@ -216,6 +200,79 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n     return true;\n }\n \n+bool CTxMemPool::CheckPackageLimits(const Package& package,\n+                                    uint64_t limitAncestorCount,\n+                                    uint64_t limitAncestorSize,\n+                                    uint64_t limitDescendantCount,\n+                                    uint64_t limitDescendantSize,\n+                                    std::string &errString) const\n+{\n+    CTxMemPoolEntry::Parents staged_ancestors;\n+    size_t total_size = 0;\n+    for (const auto& tx : package) {\n+        total_size += GetVirtualTransactionSize(*tx);\n+        for (const auto& input : tx->vin) {\n+            std::optional<txiter> piter = GetIter(input.prevout.hash);\n+            if (piter) {\n+                staged_ancestors.insert(**piter);\n+                if (staged_ancestors.size() + package.size() > limitAncestorCount) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r684743188",
      "id" : 684743188,
      "in_reply_to_id" : 682704976,
      "line" : 218,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NDc0MzE4OA==",
      "original_commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "original_line" : 218,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 85,
      "pull_request_review_id" : 724880577,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-08T09:16:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/684743188",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r684747959"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/684747959"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> This error should be caught in the mempool_tests unit test?\r\n\r\nIt should but I don't' get an error for any `mempool_*` unit tests. Won't be surprised there is a hole coverage before to this PR. \r\n\r\n> Added a functional test for size limits - test_desc_size_limits() will fail if you apply this diff\r\n\r\nThanks for adding one, there is at least one behavior change to cover introduce with this PR, `entry_size` can be > 1.",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-08T09:56:15Z",
      "diff_hunk" : "@@ -187,10 +171,10 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n         staged_ancestors.erase(stage);\n         totalSizeWithAncestors += stageit->GetTxSize();\n \n-        if (stageit->GetSizeWithDescendants() + entry.GetTxSize() > limitDescendantSize) {\n+        if (stageit->GetSizeWithDescendants() + entry_size > limitDescendantSize) {\n             errString = strprintf(\"exceeds descendant size limit for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString(), limitDescendantSize);\n             return false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r684747959",
      "id" : 684747959,
      "in_reply_to_id" : 682734547,
      "line" : 176,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NDc0Nzk1OQ==",
      "original_commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "original_line" : 176,
      "original_position" : 51,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 51,
      "pull_request_review_id" : 724883690,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-08T09:56:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/684747959",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r684752492"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/684752492"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks for writing the test, I noticed where my reasoning was flawed! \r\n\r\n>  totalSizeWithAncestors is the union Tx_A and Tx_B and its sum of 60 KvB is inferior to 101 KvB. \r\n\r\nWe init `totalSizeWithAncestors` with the whole package size from now, instead of the entry only (L164 in `src/txmempool.cpp`). So we have A+B+C+D  and the check against `limitAncestorSize` rejects the package. Maybe the variable could be renamed `packageSizeWithAncestors`, but that's a nit.",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-08T10:31:18Z",
      "diff_hunk" : "@@ -187,10 +171,10 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n         staged_ancestors.erase(stage);\n         totalSizeWithAncestors += stageit->GetTxSize();\n \n-        if (stageit->GetSizeWithDescendants() + entry.GetTxSize() > limitDescendantSize) {\n+        if (stageit->GetSizeWithDescendants() + entry_size > limitDescendantSize) {\n             errString = strprintf(\"exceeds descendant size limit for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString(), limitDescendantSize);\n             return false;\n-        } else if (stageit->GetCountWithDescendants() + 1 > limitDescendantCount) {\n+        } else if (stageit->GetCountWithDescendants() + entry_count > limitDescendantCount) {\n             errString = strprintf(\"too many descendants for tx %s [limit: %u]\", stageit->GetTx().GetHash().ToString(), limitDescendantCount);\n             return false;\n         } else if (totalSizeWithAncestors > limitAncestorSize) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r684752492",
      "id" : 684752492,
      "in_reply_to_id" : 682776019,
      "line" : 180,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NDc1MjQ5Mg==",
      "original_commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "original_line" : 180,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 56,
      "pull_request_review_id" : 724886623,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-08T10:31:18Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/684752492",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r684754153"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/684754153"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Note, I still wonder if we need to make CPFP carve-out composable with package acceptance in the future. Otherwise a counterparty can build a branch of descendants from an output A on a multi-party unconfirmed ancestor to block package acceptance on an output B.\r\n\r\nI don't think this is required for current LN safety, as least as long as implementation backends don't try to chain their commitment+CPFP transactions. But it might be useful for other second-layers applications (e.g Lightning Pool's batch execution+commitment txn).",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-08T10:45:21Z",
      "diff_hunk" : "@@ -1079,6 +1079,19 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::\n         m_viewmempool.PackageAddTransaction(ws.m_ptx);\n     }\n \n+    // Apply package mempool ancestor/descendant limits. Skip if there is only one transaction,\n+    // because it's unnecessary. Also, CPFP carve out can increase the limit for individual",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r684754153",
      "id" : 684754153,
      "line" : 1083,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NDc1NDE1Mw==",
      "original_commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "original_line" : 1083,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 5,
      "pull_request_review_id" : 724887771,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-08T10:53:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/684754153",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r684789387"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/684789387"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "can we use packages to just remove the carve out?",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-08T15:13:07Z",
      "diff_hunk" : "@@ -1079,6 +1079,19 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::\n         m_viewmempool.PackageAddTransaction(ws.m_ptx);\n     }\n \n+    // Apply package mempool ancestor/descendant limits. Skip if there is only one transaction,\n+    // because it's unnecessary. Also, CPFP carve out can increase the limit for individual",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r684789387",
      "id" : 684789387,
      "in_reply_to_id" : 684754153,
      "line" : 1083,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NDc4OTM4Nw==",
      "original_commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "original_line" : 1083,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 5,
      "pull_request_review_id" : 724912756,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-08T15:13:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/684789387",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r684806036"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/684806036"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "i think a simpler API would be to have staged always contain all the entries themselves? is there a reason not to (I think the epoch algorithm is relatively lightweight for this).",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-08T17:33:13Z",
      "diff_hunk" : "@@ -216,6 +200,79 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n     return true;\n }\n \n+bool CTxMemPool::CheckPackageLimits(const Package& package,\n+                                    uint64_t limitAncestorCount,\n+                                    uint64_t limitAncestorSize,\n+                                    uint64_t limitDescendantCount,\n+                                    uint64_t limitDescendantSize,\n+                                    std::string &errString) const\n+{\n+    CTxMemPoolEntry::Parents staged_ancestors;\n+    size_t total_size = 0;\n+    for (const auto& tx : package) {\n+        total_size += GetVirtualTransactionSize(*tx);\n+        for (const auto& input : tx->vin) {\n+            std::optional<txiter> piter = GetIter(input.prevout.hash);\n+            if (piter) {\n+                staged_ancestors.insert(**piter);\n+                if (staged_ancestors.size() + package.size() > limitAncestorCount) {",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r684806036",
      "id" : 684806036,
      "in_reply_to_id" : 682704976,
      "line" : 218,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NDgwNjAzNg==",
      "original_commit_id" : "6d8f687bfc0fde94a98a8bc9ad013e99987b0b8b",
      "original_line" : 218,
      "original_position" : 85,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 85,
      "pull_request_review_id" : 724923248,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-08T17:33:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/684806036",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "utACK accf3d5\r\n",
      "created_at" : "2021-08-08T17:33:40Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#issuecomment-894829834",
      "id" : 894829834,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21800",
      "node_id" : "IC_kwDOABII5841VgUK",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-08T17:33:40Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/894829834",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/886523?v=4",
         "events_url" : "https://api.github.com/users/JeremyRubin/events{/privacy}",
         "followers_url" : "https://api.github.com/users/JeremyRubin/followers",
         "following_url" : "https://api.github.com/users/JeremyRubin/following{/other_user}",
         "gists_url" : "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/JeremyRubin",
         "id" : 886523,
         "login" : "JeremyRubin",
         "node_id" : "MDQ6VXNlcjg4NjUyMw==",
         "organizations_url" : "https://api.github.com/users/JeremyRubin/orgs",
         "received_events_url" : "https://api.github.com/users/JeremyRubin/received_events",
         "repos_url" : "https://api.github.com/users/JeremyRubin/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/JeremyRubin/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/JeremyRubin"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "@darosior good point. I agree sigop limits should be properly enforced for packages. At the moment, since the sigops limit is checked in `PreChecks` as you said, the limit is essentially `MAX_STANDARD_TX_SIGOPS_COST` * `MAX_PACKAGE_COUNT`, or 25x the single transaction size. Should that be changed?\r\n\r\nFor `CheckPackageLimits`, I'm not sure that sigops are relevant for mempool DoS protections. We mostly care about the serialized transaction size because we don't want really large transactions to exhaust space in our mempool and we care about feerates. But we don't verify signatures after a transaction has been added to the mempool or removed from it, and don't need to know how many sigops are in our ancestors/descendants, so sigop limits probably don't make a difference?",
      "created_at" : "2021-08-09T08:32:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#issuecomment-895044275",
      "id" : 895044275,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21800",
      "node_id" : "IC_kwDOABII5841WUqz",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-09T08:32:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/895044275",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> For CheckPackageLimits, I'm not sure that sigops are relevant for mempool DoS protections\r\n\r\nThe signature ops check is not about avoiding checking too many signatures in the mempool, but to keep the mempool consistent with what could be included in the next blocks by rational miners.\r\nMiners have a size budget (and therefore we care about feerate) but also a signature ops budget and we must take care about them too as otherwise our mempool could \"diverge\" (the top of the mempool wouldn't represent what would likely be included in the next block). Mixing the sig op with the feerate was a neat way to avoid the multidimensional optimization problem, since only ill-crafted transactions could get near that budget.",
      "created_at" : "2021-08-09T08:47:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#issuecomment-895052140",
      "id" : 895052140,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21800",
      "node_id" : "IC_kwDOABII5841WWls",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-09T08:47:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/895052140",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/22457751?v=4",
         "events_url" : "https://api.github.com/users/darosior/events{/privacy}",
         "followers_url" : "https://api.github.com/users/darosior/followers",
         "following_url" : "https://api.github.com/users/darosior/following{/other_user}",
         "gists_url" : "https://api.github.com/users/darosior/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/darosior",
         "id" : 22457751,
         "login" : "darosior",
         "node_id" : "MDQ6VXNlcjIyNDU3NzUx",
         "organizations_url" : "https://api.github.com/users/darosior/orgs",
         "received_events_url" : "https://api.github.com/users/darosior/received_events",
         "repos_url" : "https://api.github.com/users/darosior/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/darosior/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/darosior/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/darosior"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685040048"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685040048"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Now that this errString is only used for the `PackageMempoolAcceptResult`, I think you can just drop the \"possibly\" prefix. It may have been useful on individual `MempoolAcceptResult` to disambiguate between failure because a single transaction definitely exceeded the limits and failure because a transaction was in a package that possibly exceeded limits. Now that we're not using it there, I think it should just be removed.",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-09T09:25:42Z",
      "diff_hunk" : "@@ -216,6 +200,80 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n     return true;\n }\n \n+bool CTxMemPool::CheckPackageLimits(const Package& package,\n+                                    uint64_t limitAncestorCount,\n+                                    uint64_t limitAncestorSize,\n+                                    uint64_t limitDescendantCount,\n+                                    uint64_t limitDescendantSize,\n+                                    std::string &errString) const\n+{\n+    CTxMemPoolEntry::Parents staged_ancestors;\n+    size_t total_size = 0;\n+    for (const auto& tx : package) {\n+        total_size += GetVirtualTransactionSize(*tx);\n+        for (const auto& input : tx->vin) {\n+            std::optional<txiter> piter = GetIter(input.prevout.hash);\n+            if (piter) {\n+                staged_ancestors.insert(**piter);\n+                if (staged_ancestors.size() + package.size() > limitAncestorCount) {\n+                    errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                    return false;\n+                }\n+            }\n+        }\n+    }\n+    // When multiple transactions are passed in, the ancestors and descendants of all transactions\n+    // considered together must be within limits even if they are not interdependent. This may be\n+    // stricter than the limits for each individual transaction.\n+    setEntries setAncestors;\n+    const auto ret = CalculateAncestorsAndCheckLimits(total_size, package.size(),\n+                                                      setAncestors, staged_ancestors,\n+                                                      limitAncestorCount, limitAncestorSize,\n+                                                      limitDescendantCount, limitDescendantSize, errString);\n+    // It's possible to overestimate the ancestor/descendant totals.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685040048",
      "id" : 685040048,
      "line" : 233,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NTA0MDA0OA==",
      "original_commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "original_line" : 233,
      "original_position" : 100,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 100,
      "pull_request_review_id" : 725180293,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-09T12:47:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685040048",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685056148"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685056148"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No need for these parens. You can just assign to the individual variables:\r\n\r\n```suggestion\r\n        chain_hex, chain_txns = create_raw_chain(node, first_coin, self.address, self.privkeys)\r\n```\r\n\r\nSame for several other assignments below.",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-09T09:50:51Z",
      "diff_hunk" : "@@ -148,20 +133,7 @@ def test_independent(self):\n     def test_chain(self):\n         node = self.nodes[0]\n         first_coin = self.coins.pop()\n-\n-        # Chain of 25 transactions\n-        parent_locking_script = None\n-        txid = first_coin[\"txid\"]\n-        chain_hex = []\n-        chain_txns = []\n-        value = first_coin[\"amount\"]\n-\n-        for _ in range(25):\n-            (tx, txhex, value, parent_locking_script) = self.chain_transaction(txid, value, 0, parent_locking_script)\n-            txid = tx.rehash()\n-            chain_hex.append(txhex)\n-            chain_txns.append(tx)\n-\n+        (chain_hex, chain_txns) = create_raw_chain(node, first_coin, self.address, self.privkeys)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685056148",
      "id" : 685056148,
      "line" : 136,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NTA1NjE0OA==",
      "original_commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "original_line" : 136,
      "original_position" : 57,
      "original_start_line" : null,
      "path" : "test/functional/rpc_packages.py",
      "position" : 57,
      "pull_request_review_id" : 725180293,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-09T12:47:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685056148",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685061119"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685061119"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No need to construct a tuple here. In python you can just use an [expression list](https://docs.python.org/3.9/reference/expressions.html#grammar-token-expression-list) in a return statement:\r\n\r\n```suggestion\r\n    return tx, signedtx[\"hex\"], my_value, tx.vout[0].scriptPubKey.hex()\r\n```\r\n\r\nHowever, both of these are dangerous interfaces with an untyped language like Python, since users of this function could easily assign the return expressions to the wrong variables. A safer interface would be to return a [named tuple](https://docs.python.org/3.9/library/collections.html?highlight=namedtuple#collections.namedtuple) so that the caller needs to explicitly unpack the wanted values from the return object.",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-09T09:58:40Z",
      "diff_hunk" : "@@ -176,3 +181,75 @@ def create_self_transfer(self, *, fee_rate=Decimal(\"0.003\"), from_node, utxo_to_\n     def sendrawtransaction(self, *, from_node, tx_hex):\n         from_node.sendrawtransaction(tx_hex)\n         self.scan_tx(from_node.decoderawtransaction(tx_hex))\n+\n+def make_chain(node, address, privkeys, parent_txid, parent_value, n=0, parent_locking_script=None, fee=DEFAULT_FEE):\n+    \"\"\"Build a transaction that spends parent_txid.vout[n] and produces one output with\n+    amount = parent_value with a fee deducted.\n+    Return tuple (CTransaction object, raw hex, nValue, scriptPubKey of the output created).\n+    \"\"\"\n+    inputs = [{\"txid\": parent_txid, \"vout\": n}]\n+    my_value = parent_value - fee\n+    outputs = {address : my_value}\n+    rawtx = node.createrawtransaction(inputs, outputs)\n+    prevtxs = [{\n+        \"txid\": parent_txid,\n+        \"vout\": n,\n+        \"scriptPubKey\": parent_locking_script,\n+        \"amount\": parent_value,\n+    }] if parent_locking_script else None\n+    signedtx = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=privkeys, prevtxs=prevtxs)\n+    assert signedtx[\"complete\"]\n+    tx = tx_from_hex(signedtx[\"hex\"])\n+    return (tx, signedtx[\"hex\"], my_value, tx.vout[0].scriptPubKey.hex())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685061119",
      "id" : 685061119,
      "line" : 203,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NTA2MTExOQ==",
      "original_commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "original_line" : 203,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/wallet.py",
      "position" : 54,
      "pull_request_review_id" : 725180293,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-09T12:47:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685061119",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> The signature ops check is not about avoiding checking too many signatures in the mempool, but to keep the mempool consistent with what could be included in the next blocks by rational miners.\r\nMiners have a size budget (and therefore we care about feerate) but also a signature ops budget and we must take care about them too as otherwise our mempool could \"diverge\" (the top of the mempool wouldn't represent what would likely be included in the next block). Mixing the sig op with the feerate was a neat way to avoid the multidimensional optimization problem, since only ill-crafted transactions could get near that budget.\r\n\r\nMy takeaway from this is that thinking of feerate as `fee / max(sigops size, serialized size)` the same way virtual size is `max(sigops size, serialized size)` is a heuristic to address the fact that blocks are constrained by both size and sigops, which would be 2D knapsack. (I still don't think it's a DoS attack but that might just be me being nitpicky). So, what I should do is go through the validation code and make sure that the correct virtual size (including sigops) is used for checks and recorded in the mempool entries.",
      "created_at" : "2021-08-09T10:34:52Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#issuecomment-895117719",
      "id" : 895117719,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21800",
      "node_id" : "IC_kwDOABII5841WmmX",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-09T10:36:54Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/895117719",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685084219"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685084219"
         }
      },
      "author_association" : "MEMBER",
      "body" : "the default `chain_length` parameter seems too specific to the specific packages test. Perhaps remove it and call the function with that specific value:\r\n\r\n```suggestion\r\ndef create_raw_chain(node, first_coin, address, privkeys, chain_length):\r\n```",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-09T10:37:54Z",
      "diff_hunk" : "@@ -176,3 +181,75 @@ def create_self_transfer(self, *, fee_rate=Decimal(\"0.003\"), from_node, utxo_to_\n     def sendrawtransaction(self, *, from_node, tx_hex):\n         from_node.sendrawtransaction(tx_hex)\n         self.scan_tx(from_node.decoderawtransaction(tx_hex))\n+\n+def make_chain(node, address, privkeys, parent_txid, parent_value, n=0, parent_locking_script=None, fee=DEFAULT_FEE):\n+    \"\"\"Build a transaction that spends parent_txid.vout[n] and produces one output with\n+    amount = parent_value with a fee deducted.\n+    Return tuple (CTransaction object, raw hex, nValue, scriptPubKey of the output created).\n+    \"\"\"\n+    inputs = [{\"txid\": parent_txid, \"vout\": n}]\n+    my_value = parent_value - fee\n+    outputs = {address : my_value}\n+    rawtx = node.createrawtransaction(inputs, outputs)\n+    prevtxs = [{\n+        \"txid\": parent_txid,\n+        \"vout\": n,\n+        \"scriptPubKey\": parent_locking_script,\n+        \"amount\": parent_value,\n+    }] if parent_locking_script else None\n+    signedtx = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=privkeys, prevtxs=prevtxs)\n+    assert signedtx[\"complete\"]\n+    tx = tx_from_hex(signedtx[\"hex\"])\n+    return (tx, signedtx[\"hex\"], my_value, tx.vout[0].scriptPubKey.hex())\n+\n+def create_child_with_parents(node, address, privkeys, parents_tx, values, locking_scripts, fee=DEFAULT_FEE):\n+    \"\"\"Creates a transaction that spends the first output of each parent in parents_tx.\"\"\"\n+    num_parents = len(parents_tx)\n+    total_value = sum(values)\n+    inputs = [{\"txid\": tx.rehash(), \"vout\": 0} for tx in parents_tx]\n+    outputs = {address : total_value - fee}\n+    rawtx_child = node.createrawtransaction(inputs, outputs)\n+    prevtxs = []\n+    for i in range(num_parents):\n+        prevtxs.append({\"txid\": parents_tx[i].rehash(), \"vout\": 0, \"scriptPubKey\": locking_scripts[i], \"amount\": values[i]})\n+    signedtx_child = node.signrawtransactionwithkey(hexstring=rawtx_child, privkeys=privkeys, prevtxs=prevtxs)\n+    assert signedtx_child[\"complete\"]\n+    return signedtx_child[\"hex\"]\n+\n+def create_raw_chain(node, first_coin, address, privkeys, chain_length=25):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685084219",
      "id" : 685084219,
      "line" : 219,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NTA4NDIxOQ==",
      "original_commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "original_line" : 219,
      "original_position" : 70,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/wallet.py",
      "position" : 70,
      "pull_request_review_id" : 725180293,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-09T12:47:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685084219",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685091478"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685091478"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`make_chain()` doesn't seem like the right name for this function. I'd expect such a function to return a _chain_ of transactions, rather than an individual transaction.\r\n\r\nIt looks like the `n` parameter isn't ever used by any of the callers. Perhaps remove it and update the function documentation to say that the function spends the first output. The function can always be updated in future to allow n to be different.",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-09T10:50:31Z",
      "diff_hunk" : "@@ -176,3 +181,75 @@ def create_self_transfer(self, *, fee_rate=Decimal(\"0.003\"), from_node, utxo_to_\n     def sendrawtransaction(self, *, from_node, tx_hex):\n         from_node.sendrawtransaction(tx_hex)\n         self.scan_tx(from_node.decoderawtransaction(tx_hex))\n+\n+def make_chain(node, address, privkeys, parent_txid, parent_value, n=0, parent_locking_script=None, fee=DEFAULT_FEE):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685091478",
      "id" : 685091478,
      "line" : 185,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NTA5MTQ3OA==",
      "original_commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "original_line" : 185,
      "original_position" : 36,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/wallet.py",
      "position" : 36,
      "pull_request_review_id" : 725180293,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-09T12:47:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685091478",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685096946"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685096946"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Ideally yes, carve-out don't scale for multi-party (n > 2) fee-bumping.\r\n\r\nThough extending the carve-out to safely chain CPFPs was argued by Matt on the LDK side (see here https://lightningdevkit.slack.com/archives/CTBLT3CAU/p1625786787422100). Personally, I think this approach is a bit doomed as we can assume first-stage of the CPFP-chain can always be replaced by a valid claim of a counterparty, thus downgrading the feerate of your other broadcasted commitments and I prefer the concurrent domino fee-bumping approach even if it's more complexity swallowed by the LN backend.\r\n\r\nFurther, I think there is another multi-party contract issue we have to solve. Namely, the first-stage state transaction can be symmetric but the second-stage states asymmetric-though-composable. E.g a CTV tree with a root transaction with branch A/branch B spending 2 isolated outputs. Alice broadcast root+branch A and Bob broadcast root+branch B, thus accidentally or maliciously evicting Alice's branch. I think we would like the mempool logic to aggregate those in-flight packages by conserving the highest-feerate subgraphs and that would require some form of carve-out to avoid package limits interfering ?",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-09T11:00:20Z",
      "diff_hunk" : "@@ -1079,6 +1079,19 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::\n         m_viewmempool.PackageAddTransaction(ws.m_ptx);\n     }\n \n+    // Apply package mempool ancestor/descendant limits. Skip if there is only one transaction,\n+    // because it's unnecessary. Also, CPFP carve out can increase the limit for individual",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685096946",
      "id" : 685096946,
      "in_reply_to_id" : 684754153,
      "line" : 1083,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NTA5Njk0Ng==",
      "original_commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "original_line" : 1083,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/validation.cpp",
      "position" : 5,
      "pull_request_review_id" : 725252760,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-09T11:00:21Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685096946",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685098476"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685098476"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Why do these outputs need to have different (and random) scriptPubKeys? It looks like none of the callers use any of these added outputs, so they could all just spend to the same (arbitrary) spk.",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-09T11:03:05Z",
      "diff_hunk" : "@@ -176,3 +181,75 @@ def create_self_transfer(self, *, fee_rate=Decimal(\"0.003\"), from_node, utxo_to_\n     def sendrawtransaction(self, *, from_node, tx_hex):\n         from_node.sendrawtransaction(tx_hex)\n         self.scan_tx(from_node.decoderawtransaction(tx_hex))\n+\n+def make_chain(node, address, privkeys, parent_txid, parent_value, n=0, parent_locking_script=None, fee=DEFAULT_FEE):\n+    \"\"\"Build a transaction that spends parent_txid.vout[n] and produces one output with\n+    amount = parent_value with a fee deducted.\n+    Return tuple (CTransaction object, raw hex, nValue, scriptPubKey of the output created).\n+    \"\"\"\n+    inputs = [{\"txid\": parent_txid, \"vout\": n}]\n+    my_value = parent_value - fee\n+    outputs = {address : my_value}\n+    rawtx = node.createrawtransaction(inputs, outputs)\n+    prevtxs = [{\n+        \"txid\": parent_txid,\n+        \"vout\": n,\n+        \"scriptPubKey\": parent_locking_script,\n+        \"amount\": parent_value,\n+    }] if parent_locking_script else None\n+    signedtx = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=privkeys, prevtxs=prevtxs)\n+    assert signedtx[\"complete\"]\n+    tx = tx_from_hex(signedtx[\"hex\"])\n+    return (tx, signedtx[\"hex\"], my_value, tx.vout[0].scriptPubKey.hex())\n+\n+def create_child_with_parents(node, address, privkeys, parents_tx, values, locking_scripts, fee=DEFAULT_FEE):\n+    \"\"\"Creates a transaction that spends the first output of each parent in parents_tx.\"\"\"\n+    num_parents = len(parents_tx)\n+    total_value = sum(values)\n+    inputs = [{\"txid\": tx.rehash(), \"vout\": 0} for tx in parents_tx]\n+    outputs = {address : total_value - fee}\n+    rawtx_child = node.createrawtransaction(inputs, outputs)\n+    prevtxs = []\n+    for i in range(num_parents):\n+        prevtxs.append({\"txid\": parents_tx[i].rehash(), \"vout\": 0, \"scriptPubKey\": locking_scripts[i], \"amount\": values[i]})\n+    signedtx_child = node.signrawtransactionwithkey(hexstring=rawtx_child, privkeys=privkeys, prevtxs=prevtxs)\n+    assert signedtx_child[\"complete\"]\n+    return signedtx_child[\"hex\"]\n+\n+def create_raw_chain(node, first_coin, address, privkeys, chain_length=25):\n+    \"\"\"Helper function: create a \"chain\" of chain_length transactions. The nth transaction in the\n+    chain is a child of the n-1th transaction and parent of the n+1th transaction.\n+    \"\"\"\n+    parent_locking_script = None\n+    txid = first_coin[\"txid\"]\n+    chain_hex = []\n+    chain_txns = []\n+    value = first_coin[\"amount\"]\n+\n+    for _ in range(chain_length):\n+        (tx, txhex, value, parent_locking_script) = make_chain(node, address, privkeys, txid, value, 0, parent_locking_script)\n+        txid = tx.rehash()\n+        chain_hex.append(txhex)\n+        chain_txns.append(tx)\n+\n+    return (chain_hex, chain_txns)\n+\n+def bulk_transaction(tx, node, target_weight, privkeys, prevtxs=None):\n+    \"\"\"Pad a transaction with extra outputs until it reaches a target weight (or higher).\n+    returns CTransaction object\n+    \"\"\"\n+    tx_heavy = deepcopy(tx)\n+    assert_greater_than_or_equal(target_weight, tx_heavy.get_weight())\n+    while tx_heavy.get_weight() < target_weight:\n+        random_spk = \"6a4d0200\"  # OP_RETURN OP_PUSH2 512 bytes\n+        for _ in range(512*2):\n+            random_spk += choice(\"0123456789ABCDEF\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685098476",
      "id" : 685098476,
      "line" : 246,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NTA5ODQ3Ng==",
      "original_commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "original_line" : 246,
      "original_position" : 97,
      "original_start_line" : 244,
      "path" : "test/functional/test_framework/wallet.py",
      "position" : 97,
      "pull_request_review_id" : 725180293,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : 244,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-09T12:47:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685098476",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685099588"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685099588"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is there a reason that you're copying this rather than just mutating `tx` and returning it?",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-09T11:05:07Z",
      "diff_hunk" : "@@ -176,3 +181,75 @@ def create_self_transfer(self, *, fee_rate=Decimal(\"0.003\"), from_node, utxo_to_\n     def sendrawtransaction(self, *, from_node, tx_hex):\n         from_node.sendrawtransaction(tx_hex)\n         self.scan_tx(from_node.decoderawtransaction(tx_hex))\n+\n+def make_chain(node, address, privkeys, parent_txid, parent_value, n=0, parent_locking_script=None, fee=DEFAULT_FEE):\n+    \"\"\"Build a transaction that spends parent_txid.vout[n] and produces one output with\n+    amount = parent_value with a fee deducted.\n+    Return tuple (CTransaction object, raw hex, nValue, scriptPubKey of the output created).\n+    \"\"\"\n+    inputs = [{\"txid\": parent_txid, \"vout\": n}]\n+    my_value = parent_value - fee\n+    outputs = {address : my_value}\n+    rawtx = node.createrawtransaction(inputs, outputs)\n+    prevtxs = [{\n+        \"txid\": parent_txid,\n+        \"vout\": n,\n+        \"scriptPubKey\": parent_locking_script,\n+        \"amount\": parent_value,\n+    }] if parent_locking_script else None\n+    signedtx = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=privkeys, prevtxs=prevtxs)\n+    assert signedtx[\"complete\"]\n+    tx = tx_from_hex(signedtx[\"hex\"])\n+    return (tx, signedtx[\"hex\"], my_value, tx.vout[0].scriptPubKey.hex())\n+\n+def create_child_with_parents(node, address, privkeys, parents_tx, values, locking_scripts, fee=DEFAULT_FEE):\n+    \"\"\"Creates a transaction that spends the first output of each parent in parents_tx.\"\"\"\n+    num_parents = len(parents_tx)\n+    total_value = sum(values)\n+    inputs = [{\"txid\": tx.rehash(), \"vout\": 0} for tx in parents_tx]\n+    outputs = {address : total_value - fee}\n+    rawtx_child = node.createrawtransaction(inputs, outputs)\n+    prevtxs = []\n+    for i in range(num_parents):\n+        prevtxs.append({\"txid\": parents_tx[i].rehash(), \"vout\": 0, \"scriptPubKey\": locking_scripts[i], \"amount\": values[i]})\n+    signedtx_child = node.signrawtransactionwithkey(hexstring=rawtx_child, privkeys=privkeys, prevtxs=prevtxs)\n+    assert signedtx_child[\"complete\"]\n+    return signedtx_child[\"hex\"]\n+\n+def create_raw_chain(node, first_coin, address, privkeys, chain_length=25):\n+    \"\"\"Helper function: create a \"chain\" of chain_length transactions. The nth transaction in the\n+    chain is a child of the n-1th transaction and parent of the n+1th transaction.\n+    \"\"\"\n+    parent_locking_script = None\n+    txid = first_coin[\"txid\"]\n+    chain_hex = []\n+    chain_txns = []\n+    value = first_coin[\"amount\"]\n+\n+    for _ in range(chain_length):\n+        (tx, txhex, value, parent_locking_script) = make_chain(node, address, privkeys, txid, value, 0, parent_locking_script)\n+        txid = tx.rehash()\n+        chain_hex.append(txhex)\n+        chain_txns.append(tx)\n+\n+    return (chain_hex, chain_txns)\n+\n+def bulk_transaction(tx, node, target_weight, privkeys, prevtxs=None):\n+    \"\"\"Pad a transaction with extra outputs until it reaches a target weight (or higher).\n+    returns CTransaction object\n+    \"\"\"\n+    tx_heavy = deepcopy(tx)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685099588",
      "id" : 685099588,
      "line" : 241,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NTA5OTU4OA==",
      "original_commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "original_line" : 241,
      "original_position" : 92,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/wallet.py",
      "position" : 92,
      "pull_request_review_id" : 725180293,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-09T12:47:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685099588",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685101671"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685101671"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This doesn't need to pass `prevtxs` (since `privkeys` is `None`):\r\n\r\n```suggestion\r\n                mempool_tx = bulk_transaction(small_tx, node, target_weight, None, None)\r\n```\r\n\r\nYou could also make `privkeys` an optional parameter in `bulk_transaction()` that defaults to `None`.\r\n\r\nThis means that `spk` and `prevtxs` could go inside the `j == 0` branch, since they're not used in the `j == 1` branch.",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-09T11:08:53Z",
      "diff_hunk" : "@@ -0,0 +1,475 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test logic for limiting mempool and package ancestors/descendants.\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.address import ADDRESS_BCRT1_P2WSH_OP_TRUE\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    COIN,\n+    CTransaction,\n+    CTxInWitness,\n+    tx_from_hex,\n+    WITNESS_SCALE_FACTOR,\n+)\n+from test_framework.script import (\n+    CScript,\n+    OP_TRUE,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+from test_framework.wallet import (\n+    bulk_transaction,\n+    create_child_with_parents,\n+    make_chain,\n+)\n+\n+class MempoolPackageLimitsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.setup_clean_chain = True\n+\n+    def run_test(self):\n+        self.log.info(\"Generate blocks to create UTXOs\")\n+        node = self.nodes[0]\n+        self.privkeys = [node.get_deterministic_priv_key().key]\n+        self.address = node.get_deterministic_priv_key().address\n+        self.coins = []\n+        # The last 100 coinbase transactions are premature\n+        for b in node.generatetoaddress(200, self.address)[:100]:\n+            coinbase = node.getblock(blockhash=b, verbosity=2)[\"tx\"][0]\n+            self.coins.append({\n+                \"txid\": coinbase[\"txid\"],\n+                \"amount\": coinbase[\"vout\"][0][\"value\"],\n+                \"scriptPubKey\": coinbase[\"vout\"][0][\"scriptPubKey\"],\n+            })\n+\n+        self.test_chain_limits()\n+        self.test_desc_count_limits()\n+        self.test_anc_count_limits()\n+        self.test_anc_count_limits_2()\n+        self.test_anc_count_limits_bushy()\n+\n+        # The node will accept our (nonstandard) extra large OP_RETURN outputs\n+        self.restart_node(0, extra_args=[\"-acceptnonstdtxn=1\"])\n+        self.test_anc_size_limits()\n+        self.test_desc_size_limits()\n+\n+    def test_chain_limits_helper(self, mempool_count, package_count):\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        first_coin = self.coins.pop()\n+        spk = None\n+        txid = first_coin[\"txid\"]\n+        chain_hex = []\n+        chain_txns = []\n+        value = first_coin[\"amount\"]\n+\n+        for i in range(mempool_count + package_count):\n+            (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+            txid = tx.rehash()\n+            if i < mempool_count:\n+                node.sendrawtransaction(txhex)\n+                assert_equal(node.getrawmempool(verbose=True)[txid][\"ancestorcount\"], i + 1)\n+            else:\n+                chain_hex.append(txhex)\n+                chain_txns.append(tx)\n+        testres_too_long = node.testmempoolaccept(rawtxs=chain_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=chain_hex)])\n+\n+    def test_chain_limits(self):\n+        \"\"\"Create chains from mempool and package transactions that are longer than 25,\n+        but only if both in-mempool and in-package transactions are considered together.\n+        This checks that both mempool and in-package transactions are taken into account when\n+        calculating ancestors/descendant limits.\n+        \"\"\"\n+        self.log.info(\"Check that in-package ancestors count for mempool ancestor limits\")\n+\n+        # 24 transactions in the mempool and 2 in the package. The parent in the package has\n+        # 24 in-mempool ancestors and 1 in-package descendant. The child has 0 direct parents\n+        # in the mempool, but 25 in-mempool and in-package ancestors in total.\n+        self.test_chain_limits_helper(24, 2)\n+        # 2 transactions in the mempool and 24 in the package.\n+        self.test_chain_limits_helper(2, 24)\n+        # 13 transactions in the mempool and 13 in the package.\n+        self.test_chain_limits_helper(13, 13)\n+\n+    def test_desc_count_limits(self):\n+        \"\"\"Create an 'A' shaped package with 24 transactions in the mempool and 2 in the package:\n+                    M1\n+                   ^  ^\n+                 M2a  M2b\n+                .       .\n+               .         .\n+              .           .\n+             M12a          ^\n+            ^              M13b\n+           ^                 ^\n+          Pa                  Pb\n+        The top ancestor in the package exceeds descendant limits but only if the in-mempool and in-package\n+        descendants are all considered together (24 including in-mempool descendants and 26 including both\n+        package transactions).\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        self.log.info(\"Check that in-mempool and in-package descendants are calculated properly in packages\")\n+        # Top parent in mempool, M1\n+        first_coin = self.coins.pop()\n+        parent_value = (first_coin[\"amount\"] - Decimal(\"0.0002\")) / 2 # Deduct reasonable fee and make 2 outputs\n+        inputs = [{\"txid\": first_coin[\"txid\"], \"vout\": 0}]\n+        outputs = [{self.address : parent_value}, {ADDRESS_BCRT1_P2WSH_OP_TRUE : parent_value}]\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+\n+        parent_signed = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=self.privkeys)\n+        assert parent_signed[\"complete\"]\n+        parent_tx = tx_from_hex(parent_signed[\"hex\"])\n+        parent_txid = parent_tx.rehash()\n+        node.sendrawtransaction(parent_signed[\"hex\"])\n+\n+        package_hex = []\n+\n+        # Chain A\n+        spk = parent_tx.vout[0].scriptPubKey.hex()\n+        value = parent_value\n+        txid = parent_txid\n+        for i in range(12):\n+            (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+            txid = tx.rehash()\n+            if i < 11: # M2a... M12a\n+                node.sendrawtransaction(txhex)\n+            else: # Pa\n+                package_hex.append(txhex)\n+\n+        # Chain B\n+        value = parent_value - Decimal(\"0.0001\")\n+        rawtx_b = node.createrawtransaction([{\"txid\": parent_txid, \"vout\": 1}], {self.address : value})\n+        tx_child_b = tx_from_hex(rawtx_b) # M2b\n+        tx_child_b.wit.vtxinwit = [CTxInWitness()]\n+        tx_child_b.wit.vtxinwit[0].scriptWitness.stack = [CScript([OP_TRUE])]\n+        tx_child_b_hex = tx_child_b.serialize().hex()\n+        node.sendrawtransaction(tx_child_b_hex)\n+        spk = tx_child_b.vout[0].scriptPubKey.hex()\n+        txid = tx_child_b.rehash()\n+        for i in range(12):\n+            (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+            txid = tx.rehash()\n+            if i < 11: # M3b... M13b\n+                node.sendrawtransaction(txhex)\n+            else: # Pb\n+                package_hex.append(txhex)\n+\n+        assert_equal(24, node.getmempoolinfo()[\"size\"])\n+        assert_equal(2, len(package_hex))\n+        testres_too_long = node.testmempoolaccept(rawtxs=package_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=package_hex)])\n+\n+    def test_anc_count_limits(self):\n+        \"\"\"Create a 'V' shaped chain with 24 transactions in the mempool and 3 in the package:\n+        M1a                    M1b\n+         ^                     ^\n+          M2a                M2b\n+           .                 .\n+            .               .\n+             .             .\n+             M12a        M12b\n+               ^         ^\n+                Pa     Pb\n+                 ^    ^\n+                   Pc\n+        The lowest descendant, Pc, exceeds ancestor limits, but only if the in-mempool\n+        and in-package ancestors are all considered together.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        package_hex = []\n+        parents_tx = []\n+        values = []\n+        scripts = []\n+\n+        self.log.info(\"Check that in-mempool and in-package ancestors are calculated properly in packages\")\n+\n+        # Two chains of 13 transactions each\n+        for _ in range(2):\n+            spk = None\n+            top_coin = self.coins.pop()\n+            txid = top_coin[\"txid\"]\n+            value = top_coin[\"amount\"]\n+            for i in range(13):\n+                (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+                txid = tx.rehash()\n+                if i < 12:\n+                    node.sendrawtransaction(txhex)\n+                else: # Save the 13th transaction for the package\n+                    package_hex.append(txhex)\n+                    parents_tx.append(tx)\n+                    scripts.append(spk)\n+                    values.append(value)\n+\n+        # Child Pc\n+        child_hex = create_child_with_parents(node, self.address, self.privkeys, parents_tx, values, scripts)\n+        package_hex.append(child_hex)\n+\n+        assert_equal(24, node.getmempoolinfo()[\"size\"])\n+        assert_equal(3, len(package_hex))\n+        testres_too_long = node.testmempoolaccept(rawtxs=package_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=package_hex)])\n+\n+    def test_anc_count_limits_2(self):\n+        \"\"\"Create a 'Y' shaped chain with 24 transactions in the mempool and 2 in the package:\n+        M1a                M1b\n+         ^                ^\n+          M2a            M2b\n+           .            .\n+            .          .\n+             .        .\n+            M12a    M12b\n+               ^    ^\n+                 Pc\n+                 ^\n+                 Pd\n+        The lowest descendant, Pd, exceeds ancestor limits, but only if the in-mempool\n+        and in-package ancestors are all considered together.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        parents_tx = []\n+        values = []\n+        scripts = []\n+\n+        self.log.info(\"Check that in-mempool and in-package ancestors are calculated properly in packages\")\n+        # Two chains of 12 transactions each\n+        for _ in range(2):\n+            spk = None\n+            top_coin = self.coins.pop()\n+            txid = top_coin[\"txid\"]\n+            value = top_coin[\"amount\"]\n+            for i in range(12):\n+                (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+                txid = tx.rehash()\n+                value -= Decimal(\"0.0001\")\n+                node.sendrawtransaction(txhex)\n+                if i == 11:\n+                    # last 2 transactions will be the parents of Pc\n+                    parents_tx.append(tx)\n+                    values.append(value)\n+                    scripts.append(spk)\n+\n+        # Child Pc\n+        pc_hex = create_child_with_parents(node, self.address, self.privkeys, parents_tx, values, scripts)\n+        pc_tx = tx_from_hex(pc_hex)\n+        pc_value = sum(values) - Decimal(\"0.0002\")\n+        pc_spk = pc_tx.vout[0].scriptPubKey.hex()\n+\n+        # Child Pd\n+        (_, pd_hex, _, _) = make_chain(node, self.address, self.privkeys, pc_tx.rehash(), pc_value, 0, pc_spk)\n+\n+        assert_equal(24, node.getmempoolinfo()[\"size\"])\n+        testres_too_long = node.testmempoolaccept(rawtxs=[pc_hex, pd_hex])\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=[pc_hex, pd_hex])])\n+\n+    def test_anc_count_limits_bushy(self):\n+        \"\"\"Create a tree with 20 transactions in the mempool and 6 in the package:\n+        M1...M4 M5...M8 M9...M12 M13...M16 M17...M20\n+            ^      ^       ^        ^         ^             (each with 4 parents)\n+            P0     P1      P2      P3        P4\n+             ^     ^       ^       ^         ^              (5 parents)\n+                           PC\n+        Where M(4i+1)...M+(4i+4) are the parents of Pi and P0, P1, P2, P3, and P4 are the parents of PC.\n+        P0... P4 individually only have 4 parents each, and PC has no in-mempool parents. But\n+        combined, PC has 25 in-mempool and in-package parents.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        package_hex = []\n+        parent_txns = []\n+        parent_values = []\n+        scripts = []\n+        for _ in range(5): # Make package transactions P0 ... P4\n+            gp_tx = []\n+            gp_values = []\n+            gp_scripts = []\n+            for _ in range(4): # Make mempool transactions M(4i+1)...M(4i+4)\n+                parent_coin = self.coins.pop()\n+                value = parent_coin[\"amount\"]\n+                txid = parent_coin[\"txid\"]\n+                (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value)\n+                gp_tx.append(tx)\n+                gp_values.append(value)\n+                gp_scripts.append(spk)\n+                node.sendrawtransaction(txhex)\n+            # Package transaction Pi\n+            pi_hex = create_child_with_parents(node, self.address, self.privkeys, gp_tx, gp_values, gp_scripts)\n+            package_hex.append(pi_hex)\n+            pi_tx = tx_from_hex(pi_hex)\n+            parent_txns.append(pi_tx)\n+            parent_values.append(Decimal(pi_tx.vout[0].nValue) / COIN)\n+            scripts.append(pi_tx.vout[0].scriptPubKey.hex())\n+        # Package transaction PC\n+        package_hex.append(create_child_with_parents(node, self.address, self.privkeys, parent_txns, parent_values, scripts))\n+\n+        assert_equal(20, node.getmempoolinfo()[\"size\"])\n+        assert_equal(6, len(package_hex))\n+        testres = node.testmempoolaccept(rawtxs=package_hex)\n+        for txres in testres:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=package_hex)])\n+\n+    def test_anc_size_limits(self):\n+        \"\"\"Test Case with 2 independent transactions in the mempool and a parent + child in the\n+        package, where the package parent is the child of both mempool transactions (30KvB each):\n+              A     B\n+               ^   ^\n+                 C\n+                 ^\n+                 D\n+        The lowest descendant, D, exceeds ancestor size limits, but only if the in-mempool\n+        and in-package ancestors are all considered together.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        parents_tx = []\n+        values = []\n+        scripts = []\n+        target_weight = WITNESS_SCALE_FACTOR * 1000 * 30 # 30KvB\n+        high_fee = Decimal(\"0.003\") # 10 sats/vB\n+        self.log.info(\"Check that in-mempool and in-package ancestor size limits are calculated properly in packages\")\n+        # Mempool transactions A and B\n+        for _ in range(2):\n+            spk = None\n+            top_coin = self.coins.pop()\n+            txid = top_coin[\"txid\"]\n+            value = top_coin[\"amount\"]\n+            (tx, _, _, _) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk, high_fee)\n+            bulked_tx = bulk_transaction(tx, node, target_weight, self.privkeys)\n+            node.sendrawtransaction(bulked_tx.serialize().hex())\n+            parents_tx.append(bulked_tx)\n+            values.append(Decimal(bulked_tx.vout[0].nValue) / COIN)\n+            scripts.append(bulked_tx.vout[0].scriptPubKey.hex())\n+\n+        # Package transaction C\n+        small_pc_hex = create_child_with_parents(node, self.address, self.privkeys, parents_tx, values, scripts, high_fee)\n+        pc_tx = bulk_transaction(tx_from_hex(small_pc_hex), node, target_weight, self.privkeys)\n+        pc_value = Decimal(pc_tx.vout[0].nValue) / COIN\n+        pc_spk = pc_tx.vout[0].scriptPubKey.hex()\n+        pc_hex = pc_tx.serialize().hex()\n+\n+        # Package transaction D\n+        (small_pd, _, val, spk) = make_chain(node, self.address, self.privkeys, pc_tx.rehash(), pc_value, 0, pc_spk, high_fee)\n+        prevtxs = [{\n+            \"txid\": pc_tx.rehash(),\n+            \"vout\": 0,\n+            \"scriptPubKey\": spk,\n+            \"amount\": val,\n+        }]\n+        pd_tx = bulk_transaction(small_pd, node, target_weight, self.privkeys, prevtxs)\n+        pd_hex = pd_tx.serialize().hex()\n+\n+        assert_equal(2, node.getmempoolinfo()[\"size\"])\n+        testres_too_heavy = node.testmempoolaccept(rawtxs=[pc_hex, pd_hex])\n+        for txres in testres_too_heavy:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=[pc_hex, pd_hex])])\n+\n+    def test_desc_size_limits(self):\n+        \"\"\"Create 3 mempool transactions and 2 package transactions (25KvB each):\n+              Ma\n+             ^ ^\n+            Mb  Mc\n+           ^     ^\n+          Pd      Pe\n+        The top ancestor in the package exceeds descendant size limits but only if the in-mempool\n+        and in-package descendants are all considered together.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        target_weight = 21 * 1000 * WITNESS_SCALE_FACTOR\n+        high_fee = Decimal(\"0.0021\") # 10 sats/vB\n+        self.log.info(\"Check that in-mempool and in-package descendant sizes are calculated properly in packages\")\n+        # Top parent in mempool, Ma\n+        first_coin = self.coins.pop()\n+        parent_value = (first_coin[\"amount\"] - high_fee) / 2 # Deduct fee and make 2 outputs\n+        inputs = [{\"txid\": first_coin[\"txid\"], \"vout\": 0}]\n+        outputs = [{self.address : parent_value}, {ADDRESS_BCRT1_P2WSH_OP_TRUE:  parent_value}]\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+        parent_tx = bulk_transaction(tx_from_hex(rawtx), node, target_weight, self.privkeys)\n+        node.sendrawtransaction(parent_tx.serialize().hex())\n+\n+        package_hex = []\n+        for j in range(2): # Two legs (left and right)\n+            # Mempool transaction (Mb and Mc)\n+            mempool_tx = CTransaction()\n+            spk = parent_tx.vout[j].scriptPubKey.hex()\n+            value = Decimal(parent_tx.vout[j].nValue) / COIN\n+            txid = parent_tx.rehash()\n+            prevtxs = [{\n+                \"txid\": txid,\n+                \"vout\": j,\n+                \"scriptPubKey\": spk,\n+                \"amount\": value,\n+            }]\n+            if j == 0: # normal key\n+                (tx_small, _, _, _) = make_chain(node, self.address, self.privkeys, txid, value, j, spk, high_fee)\n+                mempool_tx = bulk_transaction(tx_small, node, target_weight, self.privkeys, prevtxs)\n+            else: # OP_TRUE\n+                inputs = [{\"txid\": txid, \"vout\": 1}]\n+                outputs = {self.address: value - high_fee}\n+                small_tx = tx_from_hex(node.createrawtransaction(inputs, outputs))\n+                mempool_tx = bulk_transaction(small_tx, node, target_weight, None, prevtxs)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685101671",
      "id" : 685101671,
      "line" : 447,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NTEwMTY3MQ==",
      "original_commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "original_line" : 447,
      "original_position" : 447,
      "original_start_line" : null,
      "path" : "test/functional/mempool_package_limits.py",
      "position" : 447,
      "pull_request_review_id" : 725180293,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-09T12:47:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685101671",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685102052"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685102052"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Perhaps make this an `else` branch to make it very clear that this is the alternative to signing with provided privkeys.",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-09T11:09:30Z",
      "diff_hunk" : "@@ -176,3 +181,75 @@ def create_self_transfer(self, *, fee_rate=Decimal(\"0.003\"), from_node, utxo_to_\n     def sendrawtransaction(self, *, from_node, tx_hex):\n         from_node.sendrawtransaction(tx_hex)\n         self.scan_tx(from_node.decoderawtransaction(tx_hex))\n+\n+def make_chain(node, address, privkeys, parent_txid, parent_value, n=0, parent_locking_script=None, fee=DEFAULT_FEE):\n+    \"\"\"Build a transaction that spends parent_txid.vout[n] and produces one output with\n+    amount = parent_value with a fee deducted.\n+    Return tuple (CTransaction object, raw hex, nValue, scriptPubKey of the output created).\n+    \"\"\"\n+    inputs = [{\"txid\": parent_txid, \"vout\": n}]\n+    my_value = parent_value - fee\n+    outputs = {address : my_value}\n+    rawtx = node.createrawtransaction(inputs, outputs)\n+    prevtxs = [{\n+        \"txid\": parent_txid,\n+        \"vout\": n,\n+        \"scriptPubKey\": parent_locking_script,\n+        \"amount\": parent_value,\n+    }] if parent_locking_script else None\n+    signedtx = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=privkeys, prevtxs=prevtxs)\n+    assert signedtx[\"complete\"]\n+    tx = tx_from_hex(signedtx[\"hex\"])\n+    return (tx, signedtx[\"hex\"], my_value, tx.vout[0].scriptPubKey.hex())\n+\n+def create_child_with_parents(node, address, privkeys, parents_tx, values, locking_scripts, fee=DEFAULT_FEE):\n+    \"\"\"Creates a transaction that spends the first output of each parent in parents_tx.\"\"\"\n+    num_parents = len(parents_tx)\n+    total_value = sum(values)\n+    inputs = [{\"txid\": tx.rehash(), \"vout\": 0} for tx in parents_tx]\n+    outputs = {address : total_value - fee}\n+    rawtx_child = node.createrawtransaction(inputs, outputs)\n+    prevtxs = []\n+    for i in range(num_parents):\n+        prevtxs.append({\"txid\": parents_tx[i].rehash(), \"vout\": 0, \"scriptPubKey\": locking_scripts[i], \"amount\": values[i]})\n+    signedtx_child = node.signrawtransactionwithkey(hexstring=rawtx_child, privkeys=privkeys, prevtxs=prevtxs)\n+    assert signedtx_child[\"complete\"]\n+    return signedtx_child[\"hex\"]\n+\n+def create_raw_chain(node, first_coin, address, privkeys, chain_length=25):\n+    \"\"\"Helper function: create a \"chain\" of chain_length transactions. The nth transaction in the\n+    chain is a child of the n-1th transaction and parent of the n+1th transaction.\n+    \"\"\"\n+    parent_locking_script = None\n+    txid = first_coin[\"txid\"]\n+    chain_hex = []\n+    chain_txns = []\n+    value = first_coin[\"amount\"]\n+\n+    for _ in range(chain_length):\n+        (tx, txhex, value, parent_locking_script) = make_chain(node, address, privkeys, txid, value, 0, parent_locking_script)\n+        txid = tx.rehash()\n+        chain_hex.append(txhex)\n+        chain_txns.append(tx)\n+\n+    return (chain_hex, chain_txns)\n+\n+def bulk_transaction(tx, node, target_weight, privkeys, prevtxs=None):\n+    \"\"\"Pad a transaction with extra outputs until it reaches a target weight (or higher).\n+    returns CTransaction object\n+    \"\"\"\n+    tx_heavy = deepcopy(tx)\n+    assert_greater_than_or_equal(target_weight, tx_heavy.get_weight())\n+    while tx_heavy.get_weight() < target_weight:\n+        random_spk = \"6a4d0200\"  # OP_RETURN OP_PUSH2 512 bytes\n+        for _ in range(512*2):\n+            random_spk += choice(\"0123456789ABCDEF\")\n+        tx_heavy.vout.append(CTxOut(0, bytes.fromhex(random_spk)))\n+    # Re-sign the transaction\n+    if privkeys:\n+        signed = node.signrawtransactionwithkey(tx_heavy.serialize().hex(), privkeys, prevtxs)\n+        return tx_from_hex(signed[\"hex\"])\n+    # OP_TRUE\n+    tx_heavy.wit.vtxinwit = [CTxInWitness()]\n+    tx_heavy.wit.vtxinwit[0].scriptWitness.stack = [CScript([OP_TRUE])]\n+    return tx_heavy",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685102052",
      "id" : 685102052,
      "line" : 255,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NTEwMjA1Mg==",
      "original_commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "original_line" : 255,
      "original_position" : 106,
      "original_start_line" : 253,
      "path" : "test/functional/test_framework/wallet.py",
      "position" : 106,
      "pull_request_review_id" : 725180293,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : 253,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-09T12:47:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685102052",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685104075"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685104075"
         }
      },
      "author_association" : "MEMBER",
      "body" : "[No need for a space after the key](https://www.python.org/dev/peps/pep-0008/#pet-peeves):\r\n\r\n```suggestion\r\n    outputs = {address: my_value}\r\n```\r\n\r\nSame in `create_child_with_parents()` below",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-09T11:13:07Z",
      "diff_hunk" : "@@ -176,3 +181,75 @@ def create_self_transfer(self, *, fee_rate=Decimal(\"0.003\"), from_node, utxo_to_\n     def sendrawtransaction(self, *, from_node, tx_hex):\n         from_node.sendrawtransaction(tx_hex)\n         self.scan_tx(from_node.decoderawtransaction(tx_hex))\n+\n+def make_chain(node, address, privkeys, parent_txid, parent_value, n=0, parent_locking_script=None, fee=DEFAULT_FEE):\n+    \"\"\"Build a transaction that spends parent_txid.vout[n] and produces one output with\n+    amount = parent_value with a fee deducted.\n+    Return tuple (CTransaction object, raw hex, nValue, scriptPubKey of the output created).\n+    \"\"\"\n+    inputs = [{\"txid\": parent_txid, \"vout\": n}]\n+    my_value = parent_value - fee\n+    outputs = {address : my_value}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685104075",
      "id" : 685104075,
      "line" : 192,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NTEwNDA3NQ==",
      "original_commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "original_line" : 192,
      "original_position" : 43,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/wallet.py",
      "position" : 43,
      "pull_request_review_id" : 725180293,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-09T12:47:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685104075",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685105589"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685105589"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This implicitly assumes that `len(parents_tx)` == `len(locking_scripts)` == `len(values)`. Perhaps assert that explicitly at the top of the function, or change the function signature to take a `parents` parameter which is a list of (tx, value, locking_script) tuples.",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-09T11:15:58Z",
      "diff_hunk" : "@@ -176,3 +181,75 @@ def create_self_transfer(self, *, fee_rate=Decimal(\"0.003\"), from_node, utxo_to_\n     def sendrawtransaction(self, *, from_node, tx_hex):\n         from_node.sendrawtransaction(tx_hex)\n         self.scan_tx(from_node.decoderawtransaction(tx_hex))\n+\n+def make_chain(node, address, privkeys, parent_txid, parent_value, n=0, parent_locking_script=None, fee=DEFAULT_FEE):\n+    \"\"\"Build a transaction that spends parent_txid.vout[n] and produces one output with\n+    amount = parent_value with a fee deducted.\n+    Return tuple (CTransaction object, raw hex, nValue, scriptPubKey of the output created).\n+    \"\"\"\n+    inputs = [{\"txid\": parent_txid, \"vout\": n}]\n+    my_value = parent_value - fee\n+    outputs = {address : my_value}\n+    rawtx = node.createrawtransaction(inputs, outputs)\n+    prevtxs = [{\n+        \"txid\": parent_txid,\n+        \"vout\": n,\n+        \"scriptPubKey\": parent_locking_script,\n+        \"amount\": parent_value,\n+    }] if parent_locking_script else None\n+    signedtx = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=privkeys, prevtxs=prevtxs)\n+    assert signedtx[\"complete\"]\n+    tx = tx_from_hex(signedtx[\"hex\"])\n+    return (tx, signedtx[\"hex\"], my_value, tx.vout[0].scriptPubKey.hex())\n+\n+def create_child_with_parents(node, address, privkeys, parents_tx, values, locking_scripts, fee=DEFAULT_FEE):\n+    \"\"\"Creates a transaction that spends the first output of each parent in parents_tx.\"\"\"\n+    num_parents = len(parents_tx)\n+    total_value = sum(values)\n+    inputs = [{\"txid\": tx.rehash(), \"vout\": 0} for tx in parents_tx]\n+    outputs = {address : total_value - fee}\n+    rawtx_child = node.createrawtransaction(inputs, outputs)\n+    prevtxs = []\n+    for i in range(num_parents):\n+        prevtxs.append({\"txid\": parents_tx[i].rehash(), \"vout\": 0, \"scriptPubKey\": locking_scripts[i], \"amount\": values[i]})",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685105589",
      "id" : 685105589,
      "line" : 214,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NTEwNTU4OQ==",
      "original_commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "original_line" : 214,
      "original_position" : 65,
      "original_start_line" : 213,
      "path" : "test/functional/test_framework/wallet.py",
      "position" : 65,
      "pull_request_review_id" : 725180293,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : 213,
      "start_side" : "RIGHT",
      "updated_at" : "2021-08-09T12:47:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685105589",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685115251"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685115251"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I think it's fine for both outputs to have the same scriptPubKey (and would make the test logic below simpler as well).",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-09T11:32:30Z",
      "diff_hunk" : "@@ -0,0 +1,475 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test logic for limiting mempool and package ancestors/descendants.\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.address import ADDRESS_BCRT1_P2WSH_OP_TRUE\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    COIN,\n+    CTransaction,\n+    CTxInWitness,\n+    tx_from_hex,\n+    WITNESS_SCALE_FACTOR,\n+)\n+from test_framework.script import (\n+    CScript,\n+    OP_TRUE,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+from test_framework.wallet import (\n+    bulk_transaction,\n+    create_child_with_parents,\n+    make_chain,\n+)\n+\n+class MempoolPackageLimitsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.setup_clean_chain = True\n+\n+    def run_test(self):\n+        self.log.info(\"Generate blocks to create UTXOs\")\n+        node = self.nodes[0]\n+        self.privkeys = [node.get_deterministic_priv_key().key]\n+        self.address = node.get_deterministic_priv_key().address\n+        self.coins = []\n+        # The last 100 coinbase transactions are premature\n+        for b in node.generatetoaddress(200, self.address)[:100]:\n+            coinbase = node.getblock(blockhash=b, verbosity=2)[\"tx\"][0]\n+            self.coins.append({\n+                \"txid\": coinbase[\"txid\"],\n+                \"amount\": coinbase[\"vout\"][0][\"value\"],\n+                \"scriptPubKey\": coinbase[\"vout\"][0][\"scriptPubKey\"],\n+            })\n+\n+        self.test_chain_limits()\n+        self.test_desc_count_limits()\n+        self.test_anc_count_limits()\n+        self.test_anc_count_limits_2()\n+        self.test_anc_count_limits_bushy()\n+\n+        # The node will accept our (nonstandard) extra large OP_RETURN outputs\n+        self.restart_node(0, extra_args=[\"-acceptnonstdtxn=1\"])\n+        self.test_anc_size_limits()\n+        self.test_desc_size_limits()\n+\n+    def test_chain_limits_helper(self, mempool_count, package_count):\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        first_coin = self.coins.pop()\n+        spk = None\n+        txid = first_coin[\"txid\"]\n+        chain_hex = []\n+        chain_txns = []\n+        value = first_coin[\"amount\"]\n+\n+        for i in range(mempool_count + package_count):\n+            (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+            txid = tx.rehash()\n+            if i < mempool_count:\n+                node.sendrawtransaction(txhex)\n+                assert_equal(node.getrawmempool(verbose=True)[txid][\"ancestorcount\"], i + 1)\n+            else:\n+                chain_hex.append(txhex)\n+                chain_txns.append(tx)\n+        testres_too_long = node.testmempoolaccept(rawtxs=chain_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=chain_hex)])\n+\n+    def test_chain_limits(self):\n+        \"\"\"Create chains from mempool and package transactions that are longer than 25,\n+        but only if both in-mempool and in-package transactions are considered together.\n+        This checks that both mempool and in-package transactions are taken into account when\n+        calculating ancestors/descendant limits.\n+        \"\"\"\n+        self.log.info(\"Check that in-package ancestors count for mempool ancestor limits\")\n+\n+        # 24 transactions in the mempool and 2 in the package. The parent in the package has\n+        # 24 in-mempool ancestors and 1 in-package descendant. The child has 0 direct parents\n+        # in the mempool, but 25 in-mempool and in-package ancestors in total.\n+        self.test_chain_limits_helper(24, 2)\n+        # 2 transactions in the mempool and 24 in the package.\n+        self.test_chain_limits_helper(2, 24)\n+        # 13 transactions in the mempool and 13 in the package.\n+        self.test_chain_limits_helper(13, 13)\n+\n+    def test_desc_count_limits(self):\n+        \"\"\"Create an 'A' shaped package with 24 transactions in the mempool and 2 in the package:\n+                    M1\n+                   ^  ^\n+                 M2a  M2b\n+                .       .\n+               .         .\n+              .           .\n+             M12a          ^\n+            ^              M13b\n+           ^                 ^\n+          Pa                  Pb\n+        The top ancestor in the package exceeds descendant limits but only if the in-mempool and in-package\n+        descendants are all considered together (24 including in-mempool descendants and 26 including both\n+        package transactions).\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        self.log.info(\"Check that in-mempool and in-package descendants are calculated properly in packages\")\n+        # Top parent in mempool, M1\n+        first_coin = self.coins.pop()\n+        parent_value = (first_coin[\"amount\"] - Decimal(\"0.0002\")) / 2 # Deduct reasonable fee and make 2 outputs\n+        inputs = [{\"txid\": first_coin[\"txid\"], \"vout\": 0}]\n+        outputs = [{self.address : parent_value}, {ADDRESS_BCRT1_P2WSH_OP_TRUE : parent_value}]",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685115251",
      "id" : 685115251,
      "line" : 129,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NTExNTI1MQ==",
      "original_commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "original_line" : 129,
      "original_position" : 129,
      "original_start_line" : null,
      "path" : "test/functional/mempool_package_limits.py",
      "position" : 129,
      "pull_request_review_id" : 725180293,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-09T12:47:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685115251",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685121977"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685121977"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This isn't needed. `make_chain` already removes the fee from the output values.",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-09T11:44:23Z",
      "diff_hunk" : "@@ -0,0 +1,475 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test logic for limiting mempool and package ancestors/descendants.\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.address import ADDRESS_BCRT1_P2WSH_OP_TRUE\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    COIN,\n+    CTransaction,\n+    CTxInWitness,\n+    tx_from_hex,\n+    WITNESS_SCALE_FACTOR,\n+)\n+from test_framework.script import (\n+    CScript,\n+    OP_TRUE,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+from test_framework.wallet import (\n+    bulk_transaction,\n+    create_child_with_parents,\n+    make_chain,\n+)\n+\n+class MempoolPackageLimitsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.setup_clean_chain = True\n+\n+    def run_test(self):\n+        self.log.info(\"Generate blocks to create UTXOs\")\n+        node = self.nodes[0]\n+        self.privkeys = [node.get_deterministic_priv_key().key]\n+        self.address = node.get_deterministic_priv_key().address\n+        self.coins = []\n+        # The last 100 coinbase transactions are premature\n+        for b in node.generatetoaddress(200, self.address)[:100]:\n+            coinbase = node.getblock(blockhash=b, verbosity=2)[\"tx\"][0]\n+            self.coins.append({\n+                \"txid\": coinbase[\"txid\"],\n+                \"amount\": coinbase[\"vout\"][0][\"value\"],\n+                \"scriptPubKey\": coinbase[\"vout\"][0][\"scriptPubKey\"],\n+            })\n+\n+        self.test_chain_limits()\n+        self.test_desc_count_limits()\n+        self.test_anc_count_limits()\n+        self.test_anc_count_limits_2()\n+        self.test_anc_count_limits_bushy()\n+\n+        # The node will accept our (nonstandard) extra large OP_RETURN outputs\n+        self.restart_node(0, extra_args=[\"-acceptnonstdtxn=1\"])\n+        self.test_anc_size_limits()\n+        self.test_desc_size_limits()\n+\n+    def test_chain_limits_helper(self, mempool_count, package_count):\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        first_coin = self.coins.pop()\n+        spk = None\n+        txid = first_coin[\"txid\"]\n+        chain_hex = []\n+        chain_txns = []\n+        value = first_coin[\"amount\"]\n+\n+        for i in range(mempool_count + package_count):\n+            (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+            txid = tx.rehash()\n+            if i < mempool_count:\n+                node.sendrawtransaction(txhex)\n+                assert_equal(node.getrawmempool(verbose=True)[txid][\"ancestorcount\"], i + 1)\n+            else:\n+                chain_hex.append(txhex)\n+                chain_txns.append(tx)\n+        testres_too_long = node.testmempoolaccept(rawtxs=chain_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=chain_hex)])\n+\n+    def test_chain_limits(self):\n+        \"\"\"Create chains from mempool and package transactions that are longer than 25,\n+        but only if both in-mempool and in-package transactions are considered together.\n+        This checks that both mempool and in-package transactions are taken into account when\n+        calculating ancestors/descendant limits.\n+        \"\"\"\n+        self.log.info(\"Check that in-package ancestors count for mempool ancestor limits\")\n+\n+        # 24 transactions in the mempool and 2 in the package. The parent in the package has\n+        # 24 in-mempool ancestors and 1 in-package descendant. The child has 0 direct parents\n+        # in the mempool, but 25 in-mempool and in-package ancestors in total.\n+        self.test_chain_limits_helper(24, 2)\n+        # 2 transactions in the mempool and 24 in the package.\n+        self.test_chain_limits_helper(2, 24)\n+        # 13 transactions in the mempool and 13 in the package.\n+        self.test_chain_limits_helper(13, 13)\n+\n+    def test_desc_count_limits(self):\n+        \"\"\"Create an 'A' shaped package with 24 transactions in the mempool and 2 in the package:\n+                    M1\n+                   ^  ^\n+                 M2a  M2b\n+                .       .\n+               .         .\n+              .           .\n+             M12a          ^\n+            ^              M13b\n+           ^                 ^\n+          Pa                  Pb\n+        The top ancestor in the package exceeds descendant limits but only if the in-mempool and in-package\n+        descendants are all considered together (24 including in-mempool descendants and 26 including both\n+        package transactions).\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        self.log.info(\"Check that in-mempool and in-package descendants are calculated properly in packages\")\n+        # Top parent in mempool, M1\n+        first_coin = self.coins.pop()\n+        parent_value = (first_coin[\"amount\"] - Decimal(\"0.0002\")) / 2 # Deduct reasonable fee and make 2 outputs\n+        inputs = [{\"txid\": first_coin[\"txid\"], \"vout\": 0}]\n+        outputs = [{self.address : parent_value}, {ADDRESS_BCRT1_P2WSH_OP_TRUE : parent_value}]\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+\n+        parent_signed = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=self.privkeys)\n+        assert parent_signed[\"complete\"]\n+        parent_tx = tx_from_hex(parent_signed[\"hex\"])\n+        parent_txid = parent_tx.rehash()\n+        node.sendrawtransaction(parent_signed[\"hex\"])\n+\n+        package_hex = []\n+\n+        # Chain A\n+        spk = parent_tx.vout[0].scriptPubKey.hex()\n+        value = parent_value\n+        txid = parent_txid\n+        for i in range(12):\n+            (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+            txid = tx.rehash()\n+            if i < 11: # M2a... M12a\n+                node.sendrawtransaction(txhex)\n+            else: # Pa\n+                package_hex.append(txhex)\n+\n+        # Chain B\n+        value = parent_value - Decimal(\"0.0001\")\n+        rawtx_b = node.createrawtransaction([{\"txid\": parent_txid, \"vout\": 1}], {self.address : value})\n+        tx_child_b = tx_from_hex(rawtx_b) # M2b\n+        tx_child_b.wit.vtxinwit = [CTxInWitness()]\n+        tx_child_b.wit.vtxinwit[0].scriptWitness.stack = [CScript([OP_TRUE])]\n+        tx_child_b_hex = tx_child_b.serialize().hex()\n+        node.sendrawtransaction(tx_child_b_hex)\n+        spk = tx_child_b.vout[0].scriptPubKey.hex()\n+        txid = tx_child_b.rehash()\n+        for i in range(12):\n+            (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+            txid = tx.rehash()\n+            if i < 11: # M3b... M13b\n+                node.sendrawtransaction(txhex)\n+            else: # Pb\n+                package_hex.append(txhex)\n+\n+        assert_equal(24, node.getmempoolinfo()[\"size\"])\n+        assert_equal(2, len(package_hex))\n+        testres_too_long = node.testmempoolaccept(rawtxs=package_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=package_hex)])\n+\n+    def test_anc_count_limits(self):\n+        \"\"\"Create a 'V' shaped chain with 24 transactions in the mempool and 3 in the package:\n+        M1a                    M1b\n+         ^                     ^\n+          M2a                M2b\n+           .                 .\n+            .               .\n+             .             .\n+             M12a        M12b\n+               ^         ^\n+                Pa     Pb\n+                 ^    ^\n+                   Pc\n+        The lowest descendant, Pc, exceeds ancestor limits, but only if the in-mempool\n+        and in-package ancestors are all considered together.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        package_hex = []\n+        parents_tx = []\n+        values = []\n+        scripts = []\n+\n+        self.log.info(\"Check that in-mempool and in-package ancestors are calculated properly in packages\")\n+\n+        # Two chains of 13 transactions each\n+        for _ in range(2):\n+            spk = None\n+            top_coin = self.coins.pop()\n+            txid = top_coin[\"txid\"]\n+            value = top_coin[\"amount\"]\n+            for i in range(13):\n+                (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+                txid = tx.rehash()\n+                if i < 12:\n+                    node.sendrawtransaction(txhex)\n+                else: # Save the 13th transaction for the package\n+                    package_hex.append(txhex)\n+                    parents_tx.append(tx)\n+                    scripts.append(spk)\n+                    values.append(value)\n+\n+        # Child Pc\n+        child_hex = create_child_with_parents(node, self.address, self.privkeys, parents_tx, values, scripts)\n+        package_hex.append(child_hex)\n+\n+        assert_equal(24, node.getmempoolinfo()[\"size\"])\n+        assert_equal(3, len(package_hex))\n+        testres_too_long = node.testmempoolaccept(rawtxs=package_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=package_hex)])\n+\n+    def test_anc_count_limits_2(self):\n+        \"\"\"Create a 'Y' shaped chain with 24 transactions in the mempool and 2 in the package:\n+        M1a                M1b\n+         ^                ^\n+          M2a            M2b\n+           .            .\n+            .          .\n+             .        .\n+            M12a    M12b\n+               ^    ^\n+                 Pc\n+                 ^\n+                 Pd\n+        The lowest descendant, Pd, exceeds ancestor limits, but only if the in-mempool\n+        and in-package ancestors are all considered together.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        parents_tx = []\n+        values = []\n+        scripts = []\n+\n+        self.log.info(\"Check that in-mempool and in-package ancestors are calculated properly in packages\")\n+        # Two chains of 12 transactions each\n+        for _ in range(2):\n+            spk = None\n+            top_coin = self.coins.pop()\n+            txid = top_coin[\"txid\"]\n+            value = top_coin[\"amount\"]\n+            for i in range(12):\n+                (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+                txid = tx.rehash()\n+                value -= Decimal(\"0.0001\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685121977",
      "id" : 685121977,
      "line" : 268,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NTEyMTk3Nw==",
      "original_commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "original_line" : 268,
      "original_position" : 268,
      "original_start_line" : null,
      "path" : "test/functional/mempool_package_limits.py",
      "position" : 268,
      "pull_request_review_id" : 725180293,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-09T12:47:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685121977",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685129826"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685129826"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This doesn't need to be `0.0002` and works equally well with `0.0001` now that `create_child_with_parents()` always sets the fee to `0.0001` regardless of number of inputs.\r\n\r\nRather than using a magic number here, perhaps just grab the output amount from the transaction:\r\n\r\n```suggestion\r\n        pc_value = Decimal(pc_tx.vout[0].nValue) / COIN\r\n```",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-09T11:57:30Z",
      "diff_hunk" : "@@ -0,0 +1,475 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test logic for limiting mempool and package ancestors/descendants.\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.address import ADDRESS_BCRT1_P2WSH_OP_TRUE\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    COIN,\n+    CTransaction,\n+    CTxInWitness,\n+    tx_from_hex,\n+    WITNESS_SCALE_FACTOR,\n+)\n+from test_framework.script import (\n+    CScript,\n+    OP_TRUE,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+from test_framework.wallet import (\n+    bulk_transaction,\n+    create_child_with_parents,\n+    make_chain,\n+)\n+\n+class MempoolPackageLimitsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.setup_clean_chain = True\n+\n+    def run_test(self):\n+        self.log.info(\"Generate blocks to create UTXOs\")\n+        node = self.nodes[0]\n+        self.privkeys = [node.get_deterministic_priv_key().key]\n+        self.address = node.get_deterministic_priv_key().address\n+        self.coins = []\n+        # The last 100 coinbase transactions are premature\n+        for b in node.generatetoaddress(200, self.address)[:100]:\n+            coinbase = node.getblock(blockhash=b, verbosity=2)[\"tx\"][0]\n+            self.coins.append({\n+                \"txid\": coinbase[\"txid\"],\n+                \"amount\": coinbase[\"vout\"][0][\"value\"],\n+                \"scriptPubKey\": coinbase[\"vout\"][0][\"scriptPubKey\"],\n+            })\n+\n+        self.test_chain_limits()\n+        self.test_desc_count_limits()\n+        self.test_anc_count_limits()\n+        self.test_anc_count_limits_2()\n+        self.test_anc_count_limits_bushy()\n+\n+        # The node will accept our (nonstandard) extra large OP_RETURN outputs\n+        self.restart_node(0, extra_args=[\"-acceptnonstdtxn=1\"])\n+        self.test_anc_size_limits()\n+        self.test_desc_size_limits()\n+\n+    def test_chain_limits_helper(self, mempool_count, package_count):\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        first_coin = self.coins.pop()\n+        spk = None\n+        txid = first_coin[\"txid\"]\n+        chain_hex = []\n+        chain_txns = []\n+        value = first_coin[\"amount\"]\n+\n+        for i in range(mempool_count + package_count):\n+            (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+            txid = tx.rehash()\n+            if i < mempool_count:\n+                node.sendrawtransaction(txhex)\n+                assert_equal(node.getrawmempool(verbose=True)[txid][\"ancestorcount\"], i + 1)\n+            else:\n+                chain_hex.append(txhex)\n+                chain_txns.append(tx)\n+        testres_too_long = node.testmempoolaccept(rawtxs=chain_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=chain_hex)])\n+\n+    def test_chain_limits(self):\n+        \"\"\"Create chains from mempool and package transactions that are longer than 25,\n+        but only if both in-mempool and in-package transactions are considered together.\n+        This checks that both mempool and in-package transactions are taken into account when\n+        calculating ancestors/descendant limits.\n+        \"\"\"\n+        self.log.info(\"Check that in-package ancestors count for mempool ancestor limits\")\n+\n+        # 24 transactions in the mempool and 2 in the package. The parent in the package has\n+        # 24 in-mempool ancestors and 1 in-package descendant. The child has 0 direct parents\n+        # in the mempool, but 25 in-mempool and in-package ancestors in total.\n+        self.test_chain_limits_helper(24, 2)\n+        # 2 transactions in the mempool and 24 in the package.\n+        self.test_chain_limits_helper(2, 24)\n+        # 13 transactions in the mempool and 13 in the package.\n+        self.test_chain_limits_helper(13, 13)\n+\n+    def test_desc_count_limits(self):\n+        \"\"\"Create an 'A' shaped package with 24 transactions in the mempool and 2 in the package:\n+                    M1\n+                   ^  ^\n+                 M2a  M2b\n+                .       .\n+               .         .\n+              .           .\n+             M12a          ^\n+            ^              M13b\n+           ^                 ^\n+          Pa                  Pb\n+        The top ancestor in the package exceeds descendant limits but only if the in-mempool and in-package\n+        descendants are all considered together (24 including in-mempool descendants and 26 including both\n+        package transactions).\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        self.log.info(\"Check that in-mempool and in-package descendants are calculated properly in packages\")\n+        # Top parent in mempool, M1\n+        first_coin = self.coins.pop()\n+        parent_value = (first_coin[\"amount\"] - Decimal(\"0.0002\")) / 2 # Deduct reasonable fee and make 2 outputs\n+        inputs = [{\"txid\": first_coin[\"txid\"], \"vout\": 0}]\n+        outputs = [{self.address : parent_value}, {ADDRESS_BCRT1_P2WSH_OP_TRUE : parent_value}]\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+\n+        parent_signed = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=self.privkeys)\n+        assert parent_signed[\"complete\"]\n+        parent_tx = tx_from_hex(parent_signed[\"hex\"])\n+        parent_txid = parent_tx.rehash()\n+        node.sendrawtransaction(parent_signed[\"hex\"])\n+\n+        package_hex = []\n+\n+        # Chain A\n+        spk = parent_tx.vout[0].scriptPubKey.hex()\n+        value = parent_value\n+        txid = parent_txid\n+        for i in range(12):\n+            (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+            txid = tx.rehash()\n+            if i < 11: # M2a... M12a\n+                node.sendrawtransaction(txhex)\n+            else: # Pa\n+                package_hex.append(txhex)\n+\n+        # Chain B\n+        value = parent_value - Decimal(\"0.0001\")\n+        rawtx_b = node.createrawtransaction([{\"txid\": parent_txid, \"vout\": 1}], {self.address : value})\n+        tx_child_b = tx_from_hex(rawtx_b) # M2b\n+        tx_child_b.wit.vtxinwit = [CTxInWitness()]\n+        tx_child_b.wit.vtxinwit[0].scriptWitness.stack = [CScript([OP_TRUE])]\n+        tx_child_b_hex = tx_child_b.serialize().hex()\n+        node.sendrawtransaction(tx_child_b_hex)\n+        spk = tx_child_b.vout[0].scriptPubKey.hex()\n+        txid = tx_child_b.rehash()\n+        for i in range(12):\n+            (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+            txid = tx.rehash()\n+            if i < 11: # M3b... M13b\n+                node.sendrawtransaction(txhex)\n+            else: # Pb\n+                package_hex.append(txhex)\n+\n+        assert_equal(24, node.getmempoolinfo()[\"size\"])\n+        assert_equal(2, len(package_hex))\n+        testres_too_long = node.testmempoolaccept(rawtxs=package_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=package_hex)])\n+\n+    def test_anc_count_limits(self):\n+        \"\"\"Create a 'V' shaped chain with 24 transactions in the mempool and 3 in the package:\n+        M1a                    M1b\n+         ^                     ^\n+          M2a                M2b\n+           .                 .\n+            .               .\n+             .             .\n+             M12a        M12b\n+               ^         ^\n+                Pa     Pb\n+                 ^    ^\n+                   Pc\n+        The lowest descendant, Pc, exceeds ancestor limits, but only if the in-mempool\n+        and in-package ancestors are all considered together.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        package_hex = []\n+        parents_tx = []\n+        values = []\n+        scripts = []\n+\n+        self.log.info(\"Check that in-mempool and in-package ancestors are calculated properly in packages\")\n+\n+        # Two chains of 13 transactions each\n+        for _ in range(2):\n+            spk = None\n+            top_coin = self.coins.pop()\n+            txid = top_coin[\"txid\"]\n+            value = top_coin[\"amount\"]\n+            for i in range(13):\n+                (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+                txid = tx.rehash()\n+                if i < 12:\n+                    node.sendrawtransaction(txhex)\n+                else: # Save the 13th transaction for the package\n+                    package_hex.append(txhex)\n+                    parents_tx.append(tx)\n+                    scripts.append(spk)\n+                    values.append(value)\n+\n+        # Child Pc\n+        child_hex = create_child_with_parents(node, self.address, self.privkeys, parents_tx, values, scripts)\n+        package_hex.append(child_hex)\n+\n+        assert_equal(24, node.getmempoolinfo()[\"size\"])\n+        assert_equal(3, len(package_hex))\n+        testres_too_long = node.testmempoolaccept(rawtxs=package_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=package_hex)])\n+\n+    def test_anc_count_limits_2(self):\n+        \"\"\"Create a 'Y' shaped chain with 24 transactions in the mempool and 2 in the package:\n+        M1a                M1b\n+         ^                ^\n+          M2a            M2b\n+           .            .\n+            .          .\n+             .        .\n+            M12a    M12b\n+               ^    ^\n+                 Pc\n+                 ^\n+                 Pd\n+        The lowest descendant, Pd, exceeds ancestor limits, but only if the in-mempool\n+        and in-package ancestors are all considered together.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        parents_tx = []\n+        values = []\n+        scripts = []\n+\n+        self.log.info(\"Check that in-mempool and in-package ancestors are calculated properly in packages\")\n+        # Two chains of 12 transactions each\n+        for _ in range(2):\n+            spk = None\n+            top_coin = self.coins.pop()\n+            txid = top_coin[\"txid\"]\n+            value = top_coin[\"amount\"]\n+            for i in range(12):\n+                (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+                txid = tx.rehash()\n+                value -= Decimal(\"0.0001\")\n+                node.sendrawtransaction(txhex)\n+                if i == 11:\n+                    # last 2 transactions will be the parents of Pc\n+                    parents_tx.append(tx)\n+                    values.append(value)\n+                    scripts.append(spk)\n+\n+        # Child Pc\n+        pc_hex = create_child_with_parents(node, self.address, self.privkeys, parents_tx, values, scripts)\n+        pc_tx = tx_from_hex(pc_hex)\n+        pc_value = sum(values) - Decimal(\"0.0002\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685129826",
      "id" : 685129826,
      "line" : 279,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NTEyOTgyNg==",
      "original_commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "original_line" : 279,
      "original_position" : 279,
      "original_start_line" : null,
      "path" : "test/functional/mempool_package_limits.py",
      "position" : 279,
      "pull_request_review_id" : 725180293,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-09T12:47:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685129826",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685132739"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685132739"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I have a slight preference for the previous `grandparent_` naming here (I don't think `gp` will be obvious to readers). Also perhaps change this to `txs` so it's clearer that it's multiple transactions.",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-09T12:02:24Z",
      "diff_hunk" : "@@ -0,0 +1,475 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test logic for limiting mempool and package ancestors/descendants.\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.address import ADDRESS_BCRT1_P2WSH_OP_TRUE\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    COIN,\n+    CTransaction,\n+    CTxInWitness,\n+    tx_from_hex,\n+    WITNESS_SCALE_FACTOR,\n+)\n+from test_framework.script import (\n+    CScript,\n+    OP_TRUE,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+from test_framework.wallet import (\n+    bulk_transaction,\n+    create_child_with_parents,\n+    make_chain,\n+)\n+\n+class MempoolPackageLimitsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.setup_clean_chain = True\n+\n+    def run_test(self):\n+        self.log.info(\"Generate blocks to create UTXOs\")\n+        node = self.nodes[0]\n+        self.privkeys = [node.get_deterministic_priv_key().key]\n+        self.address = node.get_deterministic_priv_key().address\n+        self.coins = []\n+        # The last 100 coinbase transactions are premature\n+        for b in node.generatetoaddress(200, self.address)[:100]:\n+            coinbase = node.getblock(blockhash=b, verbosity=2)[\"tx\"][0]\n+            self.coins.append({\n+                \"txid\": coinbase[\"txid\"],\n+                \"amount\": coinbase[\"vout\"][0][\"value\"],\n+                \"scriptPubKey\": coinbase[\"vout\"][0][\"scriptPubKey\"],\n+            })\n+\n+        self.test_chain_limits()\n+        self.test_desc_count_limits()\n+        self.test_anc_count_limits()\n+        self.test_anc_count_limits_2()\n+        self.test_anc_count_limits_bushy()\n+\n+        # The node will accept our (nonstandard) extra large OP_RETURN outputs\n+        self.restart_node(0, extra_args=[\"-acceptnonstdtxn=1\"])\n+        self.test_anc_size_limits()\n+        self.test_desc_size_limits()\n+\n+    def test_chain_limits_helper(self, mempool_count, package_count):\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        first_coin = self.coins.pop()\n+        spk = None\n+        txid = first_coin[\"txid\"]\n+        chain_hex = []\n+        chain_txns = []\n+        value = first_coin[\"amount\"]\n+\n+        for i in range(mempool_count + package_count):\n+            (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+            txid = tx.rehash()\n+            if i < mempool_count:\n+                node.sendrawtransaction(txhex)\n+                assert_equal(node.getrawmempool(verbose=True)[txid][\"ancestorcount\"], i + 1)\n+            else:\n+                chain_hex.append(txhex)\n+                chain_txns.append(tx)\n+        testres_too_long = node.testmempoolaccept(rawtxs=chain_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=chain_hex)])\n+\n+    def test_chain_limits(self):\n+        \"\"\"Create chains from mempool and package transactions that are longer than 25,\n+        but only if both in-mempool and in-package transactions are considered together.\n+        This checks that both mempool and in-package transactions are taken into account when\n+        calculating ancestors/descendant limits.\n+        \"\"\"\n+        self.log.info(\"Check that in-package ancestors count for mempool ancestor limits\")\n+\n+        # 24 transactions in the mempool and 2 in the package. The parent in the package has\n+        # 24 in-mempool ancestors and 1 in-package descendant. The child has 0 direct parents\n+        # in the mempool, but 25 in-mempool and in-package ancestors in total.\n+        self.test_chain_limits_helper(24, 2)\n+        # 2 transactions in the mempool and 24 in the package.\n+        self.test_chain_limits_helper(2, 24)\n+        # 13 transactions in the mempool and 13 in the package.\n+        self.test_chain_limits_helper(13, 13)\n+\n+    def test_desc_count_limits(self):\n+        \"\"\"Create an 'A' shaped package with 24 transactions in the mempool and 2 in the package:\n+                    M1\n+                   ^  ^\n+                 M2a  M2b\n+                .       .\n+               .         .\n+              .           .\n+             M12a          ^\n+            ^              M13b\n+           ^                 ^\n+          Pa                  Pb\n+        The top ancestor in the package exceeds descendant limits but only if the in-mempool and in-package\n+        descendants are all considered together (24 including in-mempool descendants and 26 including both\n+        package transactions).\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        self.log.info(\"Check that in-mempool and in-package descendants are calculated properly in packages\")\n+        # Top parent in mempool, M1\n+        first_coin = self.coins.pop()\n+        parent_value = (first_coin[\"amount\"] - Decimal(\"0.0002\")) / 2 # Deduct reasonable fee and make 2 outputs\n+        inputs = [{\"txid\": first_coin[\"txid\"], \"vout\": 0}]\n+        outputs = [{self.address : parent_value}, {ADDRESS_BCRT1_P2WSH_OP_TRUE : parent_value}]\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+\n+        parent_signed = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=self.privkeys)\n+        assert parent_signed[\"complete\"]\n+        parent_tx = tx_from_hex(parent_signed[\"hex\"])\n+        parent_txid = parent_tx.rehash()\n+        node.sendrawtransaction(parent_signed[\"hex\"])\n+\n+        package_hex = []\n+\n+        # Chain A\n+        spk = parent_tx.vout[0].scriptPubKey.hex()\n+        value = parent_value\n+        txid = parent_txid\n+        for i in range(12):\n+            (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+            txid = tx.rehash()\n+            if i < 11: # M2a... M12a\n+                node.sendrawtransaction(txhex)\n+            else: # Pa\n+                package_hex.append(txhex)\n+\n+        # Chain B\n+        value = parent_value - Decimal(\"0.0001\")\n+        rawtx_b = node.createrawtransaction([{\"txid\": parent_txid, \"vout\": 1}], {self.address : value})\n+        tx_child_b = tx_from_hex(rawtx_b) # M2b\n+        tx_child_b.wit.vtxinwit = [CTxInWitness()]\n+        tx_child_b.wit.vtxinwit[0].scriptWitness.stack = [CScript([OP_TRUE])]\n+        tx_child_b_hex = tx_child_b.serialize().hex()\n+        node.sendrawtransaction(tx_child_b_hex)\n+        spk = tx_child_b.vout[0].scriptPubKey.hex()\n+        txid = tx_child_b.rehash()\n+        for i in range(12):\n+            (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+            txid = tx.rehash()\n+            if i < 11: # M3b... M13b\n+                node.sendrawtransaction(txhex)\n+            else: # Pb\n+                package_hex.append(txhex)\n+\n+        assert_equal(24, node.getmempoolinfo()[\"size\"])\n+        assert_equal(2, len(package_hex))\n+        testres_too_long = node.testmempoolaccept(rawtxs=package_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=package_hex)])\n+\n+    def test_anc_count_limits(self):\n+        \"\"\"Create a 'V' shaped chain with 24 transactions in the mempool and 3 in the package:\n+        M1a                    M1b\n+         ^                     ^\n+          M2a                M2b\n+           .                 .\n+            .               .\n+             .             .\n+             M12a        M12b\n+               ^         ^\n+                Pa     Pb\n+                 ^    ^\n+                   Pc\n+        The lowest descendant, Pc, exceeds ancestor limits, but only if the in-mempool\n+        and in-package ancestors are all considered together.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        package_hex = []\n+        parents_tx = []\n+        values = []\n+        scripts = []\n+\n+        self.log.info(\"Check that in-mempool and in-package ancestors are calculated properly in packages\")\n+\n+        # Two chains of 13 transactions each\n+        for _ in range(2):\n+            spk = None\n+            top_coin = self.coins.pop()\n+            txid = top_coin[\"txid\"]\n+            value = top_coin[\"amount\"]\n+            for i in range(13):\n+                (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+                txid = tx.rehash()\n+                if i < 12:\n+                    node.sendrawtransaction(txhex)\n+                else: # Save the 13th transaction for the package\n+                    package_hex.append(txhex)\n+                    parents_tx.append(tx)\n+                    scripts.append(spk)\n+                    values.append(value)\n+\n+        # Child Pc\n+        child_hex = create_child_with_parents(node, self.address, self.privkeys, parents_tx, values, scripts)\n+        package_hex.append(child_hex)\n+\n+        assert_equal(24, node.getmempoolinfo()[\"size\"])\n+        assert_equal(3, len(package_hex))\n+        testres_too_long = node.testmempoolaccept(rawtxs=package_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=package_hex)])\n+\n+    def test_anc_count_limits_2(self):\n+        \"\"\"Create a 'Y' shaped chain with 24 transactions in the mempool and 2 in the package:\n+        M1a                M1b\n+         ^                ^\n+          M2a            M2b\n+           .            .\n+            .          .\n+             .        .\n+            M12a    M12b\n+               ^    ^\n+                 Pc\n+                 ^\n+                 Pd\n+        The lowest descendant, Pd, exceeds ancestor limits, but only if the in-mempool\n+        and in-package ancestors are all considered together.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        parents_tx = []\n+        values = []\n+        scripts = []\n+\n+        self.log.info(\"Check that in-mempool and in-package ancestors are calculated properly in packages\")\n+        # Two chains of 12 transactions each\n+        for _ in range(2):\n+            spk = None\n+            top_coin = self.coins.pop()\n+            txid = top_coin[\"txid\"]\n+            value = top_coin[\"amount\"]\n+            for i in range(12):\n+                (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+                txid = tx.rehash()\n+                value -= Decimal(\"0.0001\")\n+                node.sendrawtransaction(txhex)\n+                if i == 11:\n+                    # last 2 transactions will be the parents of Pc\n+                    parents_tx.append(tx)\n+                    values.append(value)\n+                    scripts.append(spk)\n+\n+        # Child Pc\n+        pc_hex = create_child_with_parents(node, self.address, self.privkeys, parents_tx, values, scripts)\n+        pc_tx = tx_from_hex(pc_hex)\n+        pc_value = sum(values) - Decimal(\"0.0002\")\n+        pc_spk = pc_tx.vout[0].scriptPubKey.hex()\n+\n+        # Child Pd\n+        (_, pd_hex, _, _) = make_chain(node, self.address, self.privkeys, pc_tx.rehash(), pc_value, 0, pc_spk)\n+\n+        assert_equal(24, node.getmempoolinfo()[\"size\"])\n+        testres_too_long = node.testmempoolaccept(rawtxs=[pc_hex, pd_hex])\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=[pc_hex, pd_hex])])\n+\n+    def test_anc_count_limits_bushy(self):\n+        \"\"\"Create a tree with 20 transactions in the mempool and 6 in the package:\n+        M1...M4 M5...M8 M9...M12 M13...M16 M17...M20\n+            ^      ^       ^        ^         ^             (each with 4 parents)\n+            P0     P1      P2      P3        P4\n+             ^     ^       ^       ^         ^              (5 parents)\n+                           PC\n+        Where M(4i+1)...M+(4i+4) are the parents of Pi and P0, P1, P2, P3, and P4 are the parents of PC.\n+        P0... P4 individually only have 4 parents each, and PC has no in-mempool parents. But\n+        combined, PC has 25 in-mempool and in-package parents.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        package_hex = []\n+        parent_txns = []\n+        parent_values = []\n+        scripts = []\n+        for _ in range(5): # Make package transactions P0 ... P4\n+            gp_tx = []",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685132739",
      "id" : 685132739,
      "line" : 312,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NTEzMjczOQ==",
      "original_commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "original_line" : 312,
      "original_position" : 312,
      "original_start_line" : null,
      "path" : "test/functional/mempool_package_limits.py",
      "position" : 312,
      "pull_request_review_id" : 725180293,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-09T12:47:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685132739",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685133231"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685133231"
         }
      },
      "author_association" : "MEMBER",
      "body" : "why not `parent_scipts` to go with the other `parent_...` (or even `parent_spks`).",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-09T12:03:18Z",
      "diff_hunk" : "@@ -0,0 +1,475 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test logic for limiting mempool and package ancestors/descendants.\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.address import ADDRESS_BCRT1_P2WSH_OP_TRUE\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    COIN,\n+    CTransaction,\n+    CTxInWitness,\n+    tx_from_hex,\n+    WITNESS_SCALE_FACTOR,\n+)\n+from test_framework.script import (\n+    CScript,\n+    OP_TRUE,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+from test_framework.wallet import (\n+    bulk_transaction,\n+    create_child_with_parents,\n+    make_chain,\n+)\n+\n+class MempoolPackageLimitsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.setup_clean_chain = True\n+\n+    def run_test(self):\n+        self.log.info(\"Generate blocks to create UTXOs\")\n+        node = self.nodes[0]\n+        self.privkeys = [node.get_deterministic_priv_key().key]\n+        self.address = node.get_deterministic_priv_key().address\n+        self.coins = []\n+        # The last 100 coinbase transactions are premature\n+        for b in node.generatetoaddress(200, self.address)[:100]:\n+            coinbase = node.getblock(blockhash=b, verbosity=2)[\"tx\"][0]\n+            self.coins.append({\n+                \"txid\": coinbase[\"txid\"],\n+                \"amount\": coinbase[\"vout\"][0][\"value\"],\n+                \"scriptPubKey\": coinbase[\"vout\"][0][\"scriptPubKey\"],\n+            })\n+\n+        self.test_chain_limits()\n+        self.test_desc_count_limits()\n+        self.test_anc_count_limits()\n+        self.test_anc_count_limits_2()\n+        self.test_anc_count_limits_bushy()\n+\n+        # The node will accept our (nonstandard) extra large OP_RETURN outputs\n+        self.restart_node(0, extra_args=[\"-acceptnonstdtxn=1\"])\n+        self.test_anc_size_limits()\n+        self.test_desc_size_limits()\n+\n+    def test_chain_limits_helper(self, mempool_count, package_count):\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        first_coin = self.coins.pop()\n+        spk = None\n+        txid = first_coin[\"txid\"]\n+        chain_hex = []\n+        chain_txns = []\n+        value = first_coin[\"amount\"]\n+\n+        for i in range(mempool_count + package_count):\n+            (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+            txid = tx.rehash()\n+            if i < mempool_count:\n+                node.sendrawtransaction(txhex)\n+                assert_equal(node.getrawmempool(verbose=True)[txid][\"ancestorcount\"], i + 1)\n+            else:\n+                chain_hex.append(txhex)\n+                chain_txns.append(tx)\n+        testres_too_long = node.testmempoolaccept(rawtxs=chain_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=chain_hex)])\n+\n+    def test_chain_limits(self):\n+        \"\"\"Create chains from mempool and package transactions that are longer than 25,\n+        but only if both in-mempool and in-package transactions are considered together.\n+        This checks that both mempool and in-package transactions are taken into account when\n+        calculating ancestors/descendant limits.\n+        \"\"\"\n+        self.log.info(\"Check that in-package ancestors count for mempool ancestor limits\")\n+\n+        # 24 transactions in the mempool and 2 in the package. The parent in the package has\n+        # 24 in-mempool ancestors and 1 in-package descendant. The child has 0 direct parents\n+        # in the mempool, but 25 in-mempool and in-package ancestors in total.\n+        self.test_chain_limits_helper(24, 2)\n+        # 2 transactions in the mempool and 24 in the package.\n+        self.test_chain_limits_helper(2, 24)\n+        # 13 transactions in the mempool and 13 in the package.\n+        self.test_chain_limits_helper(13, 13)\n+\n+    def test_desc_count_limits(self):\n+        \"\"\"Create an 'A' shaped package with 24 transactions in the mempool and 2 in the package:\n+                    M1\n+                   ^  ^\n+                 M2a  M2b\n+                .       .\n+               .         .\n+              .           .\n+             M12a          ^\n+            ^              M13b\n+           ^                 ^\n+          Pa                  Pb\n+        The top ancestor in the package exceeds descendant limits but only if the in-mempool and in-package\n+        descendants are all considered together (24 including in-mempool descendants and 26 including both\n+        package transactions).\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        self.log.info(\"Check that in-mempool and in-package descendants are calculated properly in packages\")\n+        # Top parent in mempool, M1\n+        first_coin = self.coins.pop()\n+        parent_value = (first_coin[\"amount\"] - Decimal(\"0.0002\")) / 2 # Deduct reasonable fee and make 2 outputs\n+        inputs = [{\"txid\": first_coin[\"txid\"], \"vout\": 0}]\n+        outputs = [{self.address : parent_value}, {ADDRESS_BCRT1_P2WSH_OP_TRUE : parent_value}]\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+\n+        parent_signed = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=self.privkeys)\n+        assert parent_signed[\"complete\"]\n+        parent_tx = tx_from_hex(parent_signed[\"hex\"])\n+        parent_txid = parent_tx.rehash()\n+        node.sendrawtransaction(parent_signed[\"hex\"])\n+\n+        package_hex = []\n+\n+        # Chain A\n+        spk = parent_tx.vout[0].scriptPubKey.hex()\n+        value = parent_value\n+        txid = parent_txid\n+        for i in range(12):\n+            (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+            txid = tx.rehash()\n+            if i < 11: # M2a... M12a\n+                node.sendrawtransaction(txhex)\n+            else: # Pa\n+                package_hex.append(txhex)\n+\n+        # Chain B\n+        value = parent_value - Decimal(\"0.0001\")\n+        rawtx_b = node.createrawtransaction([{\"txid\": parent_txid, \"vout\": 1}], {self.address : value})\n+        tx_child_b = tx_from_hex(rawtx_b) # M2b\n+        tx_child_b.wit.vtxinwit = [CTxInWitness()]\n+        tx_child_b.wit.vtxinwit[0].scriptWitness.stack = [CScript([OP_TRUE])]\n+        tx_child_b_hex = tx_child_b.serialize().hex()\n+        node.sendrawtransaction(tx_child_b_hex)\n+        spk = tx_child_b.vout[0].scriptPubKey.hex()\n+        txid = tx_child_b.rehash()\n+        for i in range(12):\n+            (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+            txid = tx.rehash()\n+            if i < 11: # M3b... M13b\n+                node.sendrawtransaction(txhex)\n+            else: # Pb\n+                package_hex.append(txhex)\n+\n+        assert_equal(24, node.getmempoolinfo()[\"size\"])\n+        assert_equal(2, len(package_hex))\n+        testres_too_long = node.testmempoolaccept(rawtxs=package_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=package_hex)])\n+\n+    def test_anc_count_limits(self):\n+        \"\"\"Create a 'V' shaped chain with 24 transactions in the mempool and 3 in the package:\n+        M1a                    M1b\n+         ^                     ^\n+          M2a                M2b\n+           .                 .\n+            .               .\n+             .             .\n+             M12a        M12b\n+               ^         ^\n+                Pa     Pb\n+                 ^    ^\n+                   Pc\n+        The lowest descendant, Pc, exceeds ancestor limits, but only if the in-mempool\n+        and in-package ancestors are all considered together.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        package_hex = []\n+        parents_tx = []\n+        values = []\n+        scripts = []\n+\n+        self.log.info(\"Check that in-mempool and in-package ancestors are calculated properly in packages\")\n+\n+        # Two chains of 13 transactions each\n+        for _ in range(2):\n+            spk = None\n+            top_coin = self.coins.pop()\n+            txid = top_coin[\"txid\"]\n+            value = top_coin[\"amount\"]\n+            for i in range(13):\n+                (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+                txid = tx.rehash()\n+                if i < 12:\n+                    node.sendrawtransaction(txhex)\n+                else: # Save the 13th transaction for the package\n+                    package_hex.append(txhex)\n+                    parents_tx.append(tx)\n+                    scripts.append(spk)\n+                    values.append(value)\n+\n+        # Child Pc\n+        child_hex = create_child_with_parents(node, self.address, self.privkeys, parents_tx, values, scripts)\n+        package_hex.append(child_hex)\n+\n+        assert_equal(24, node.getmempoolinfo()[\"size\"])\n+        assert_equal(3, len(package_hex))\n+        testres_too_long = node.testmempoolaccept(rawtxs=package_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=package_hex)])\n+\n+    def test_anc_count_limits_2(self):\n+        \"\"\"Create a 'Y' shaped chain with 24 transactions in the mempool and 2 in the package:\n+        M1a                M1b\n+         ^                ^\n+          M2a            M2b\n+           .            .\n+            .          .\n+             .        .\n+            M12a    M12b\n+               ^    ^\n+                 Pc\n+                 ^\n+                 Pd\n+        The lowest descendant, Pd, exceeds ancestor limits, but only if the in-mempool\n+        and in-package ancestors are all considered together.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        parents_tx = []\n+        values = []\n+        scripts = []\n+\n+        self.log.info(\"Check that in-mempool and in-package ancestors are calculated properly in packages\")\n+        # Two chains of 12 transactions each\n+        for _ in range(2):\n+            spk = None\n+            top_coin = self.coins.pop()\n+            txid = top_coin[\"txid\"]\n+            value = top_coin[\"amount\"]\n+            for i in range(12):\n+                (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+                txid = tx.rehash()\n+                value -= Decimal(\"0.0001\")\n+                node.sendrawtransaction(txhex)\n+                if i == 11:\n+                    # last 2 transactions will be the parents of Pc\n+                    parents_tx.append(tx)\n+                    values.append(value)\n+                    scripts.append(spk)\n+\n+        # Child Pc\n+        pc_hex = create_child_with_parents(node, self.address, self.privkeys, parents_tx, values, scripts)\n+        pc_tx = tx_from_hex(pc_hex)\n+        pc_value = sum(values) - Decimal(\"0.0002\")\n+        pc_spk = pc_tx.vout[0].scriptPubKey.hex()\n+\n+        # Child Pd\n+        (_, pd_hex, _, _) = make_chain(node, self.address, self.privkeys, pc_tx.rehash(), pc_value, 0, pc_spk)\n+\n+        assert_equal(24, node.getmempoolinfo()[\"size\"])\n+        testres_too_long = node.testmempoolaccept(rawtxs=[pc_hex, pd_hex])\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=[pc_hex, pd_hex])])\n+\n+    def test_anc_count_limits_bushy(self):\n+        \"\"\"Create a tree with 20 transactions in the mempool and 6 in the package:\n+        M1...M4 M5...M8 M9...M12 M13...M16 M17...M20\n+            ^      ^       ^        ^         ^             (each with 4 parents)\n+            P0     P1      P2      P3        P4\n+             ^     ^       ^       ^         ^              (5 parents)\n+                           PC\n+        Where M(4i+1)...M+(4i+4) are the parents of Pi and P0, P1, P2, P3, and P4 are the parents of PC.\n+        P0... P4 individually only have 4 parents each, and PC has no in-mempool parents. But\n+        combined, PC has 25 in-mempool and in-package parents.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        package_hex = []\n+        parent_txns = []\n+        parent_values = []\n+        scripts = []",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685133231",
      "id" : 685133231,
      "line" : 310,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NTEzMzIzMQ==",
      "original_commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "original_line" : 310,
      "original_position" : 310,
      "original_start_line" : null,
      "path" : "test/functional/mempool_package_limits.py",
      "position" : 310,
      "pull_request_review_id" : 725180293,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-09T12:47:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685133231",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685140674"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685140674"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is it possible to make this test work without using `-acceptnonstdtxn`, perhaps by having `bulk_transaction` just add standard outputs? Since this test is all about mempool policy, it seems better to have the policy of the node being tested to be as close to realistic as possible.",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-09T12:15:16Z",
      "diff_hunk" : "@@ -0,0 +1,475 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test logic for limiting mempool and package ancestors/descendants.\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.address import ADDRESS_BCRT1_P2WSH_OP_TRUE\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    COIN,\n+    CTransaction,\n+    CTxInWitness,\n+    tx_from_hex,\n+    WITNESS_SCALE_FACTOR,\n+)\n+from test_framework.script import (\n+    CScript,\n+    OP_TRUE,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+from test_framework.wallet import (\n+    bulk_transaction,\n+    create_child_with_parents,\n+    make_chain,\n+)\n+\n+class MempoolPackageLimitsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.setup_clean_chain = True\n+\n+    def run_test(self):\n+        self.log.info(\"Generate blocks to create UTXOs\")\n+        node = self.nodes[0]\n+        self.privkeys = [node.get_deterministic_priv_key().key]\n+        self.address = node.get_deterministic_priv_key().address\n+        self.coins = []\n+        # The last 100 coinbase transactions are premature\n+        for b in node.generatetoaddress(200, self.address)[:100]:\n+            coinbase = node.getblock(blockhash=b, verbosity=2)[\"tx\"][0]\n+            self.coins.append({\n+                \"txid\": coinbase[\"txid\"],\n+                \"amount\": coinbase[\"vout\"][0][\"value\"],\n+                \"scriptPubKey\": coinbase[\"vout\"][0][\"scriptPubKey\"],\n+            })\n+\n+        self.test_chain_limits()\n+        self.test_desc_count_limits()\n+        self.test_anc_count_limits()\n+        self.test_anc_count_limits_2()\n+        self.test_anc_count_limits_bushy()\n+\n+        # The node will accept our (nonstandard) extra large OP_RETURN outputs\n+        self.restart_node(0, extra_args=[\"-acceptnonstdtxn=1\"])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685140674",
      "id" : 685140674,
      "line" : 58,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NTE0MDY3NA==",
      "original_commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "original_line" : 58,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "test/functional/mempool_package_limits.py",
      "position" : 58,
      "pull_request_review_id" : 725180293,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-09T12:47:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685140674",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685145567"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685145567"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In fact, I don't think this string ever gets used (in logging or returned to users). Should `testmempoolaccept` be updated to return the reject reason and debug message for the transaction result and package result (see `ValidationState::ToString()`, which indirectly gets called if `sendrawtransaction` fails).",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-09T12:23:01Z",
      "diff_hunk" : "@@ -216,6 +200,80 @@ bool CTxMemPool::CalculateMemPoolAncestors(const CTxMemPoolEntry &entry, setEntr\n     return true;\n }\n \n+bool CTxMemPool::CheckPackageLimits(const Package& package,\n+                                    uint64_t limitAncestorCount,\n+                                    uint64_t limitAncestorSize,\n+                                    uint64_t limitDescendantCount,\n+                                    uint64_t limitDescendantSize,\n+                                    std::string &errString) const\n+{\n+    CTxMemPoolEntry::Parents staged_ancestors;\n+    size_t total_size = 0;\n+    for (const auto& tx : package) {\n+        total_size += GetVirtualTransactionSize(*tx);\n+        for (const auto& input : tx->vin) {\n+            std::optional<txiter> piter = GetIter(input.prevout.hash);\n+            if (piter) {\n+                staged_ancestors.insert(**piter);\n+                if (staged_ancestors.size() + package.size() > limitAncestorCount) {\n+                    errString = strprintf(\"too many unconfirmed parents [limit: %u]\", limitAncestorCount);\n+                    return false;\n+                }\n+            }\n+        }\n+    }\n+    // When multiple transactions are passed in, the ancestors and descendants of all transactions\n+    // considered together must be within limits even if they are not interdependent. This may be\n+    // stricter than the limits for each individual transaction.\n+    setEntries setAncestors;\n+    const auto ret = CalculateAncestorsAndCheckLimits(total_size, package.size(),\n+                                                      setAncestors, staged_ancestors,\n+                                                      limitAncestorCount, limitAncestorSize,\n+                                                      limitDescendantCount, limitDescendantSize, errString);\n+    // It's possible to overestimate the ancestor/descendant totals.",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685145567",
      "id" : 685145567,
      "in_reply_to_id" : 685040048,
      "line" : 233,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NTE0NTU2Nw==",
      "original_commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "original_line" : 233,
      "original_position" : 100,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : 100,
      "pull_request_review_id" : 725180293,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-09T12:47:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685145567",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685150952"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685150952"
         }
      },
      "author_association" : "MEMBER",
      "body" : "If we improved the error messages being returned to the user, we could more precisely check that the package was rejected due to _exceeds ancestor size limits_.",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-09T12:31:21Z",
      "diff_hunk" : "@@ -0,0 +1,475 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test logic for limiting mempool and package ancestors/descendants.\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.address import ADDRESS_BCRT1_P2WSH_OP_TRUE\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    COIN,\n+    CTransaction,\n+    CTxInWitness,\n+    tx_from_hex,\n+    WITNESS_SCALE_FACTOR,\n+)\n+from test_framework.script import (\n+    CScript,\n+    OP_TRUE,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+from test_framework.wallet import (\n+    bulk_transaction,\n+    create_child_with_parents,\n+    make_chain,\n+)\n+\n+class MempoolPackageLimitsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.setup_clean_chain = True\n+\n+    def run_test(self):\n+        self.log.info(\"Generate blocks to create UTXOs\")\n+        node = self.nodes[0]\n+        self.privkeys = [node.get_deterministic_priv_key().key]\n+        self.address = node.get_deterministic_priv_key().address\n+        self.coins = []\n+        # The last 100 coinbase transactions are premature\n+        for b in node.generatetoaddress(200, self.address)[:100]:\n+            coinbase = node.getblock(blockhash=b, verbosity=2)[\"tx\"][0]\n+            self.coins.append({\n+                \"txid\": coinbase[\"txid\"],\n+                \"amount\": coinbase[\"vout\"][0][\"value\"],\n+                \"scriptPubKey\": coinbase[\"vout\"][0][\"scriptPubKey\"],\n+            })\n+\n+        self.test_chain_limits()\n+        self.test_desc_count_limits()\n+        self.test_anc_count_limits()\n+        self.test_anc_count_limits_2()\n+        self.test_anc_count_limits_bushy()\n+\n+        # The node will accept our (nonstandard) extra large OP_RETURN outputs\n+        self.restart_node(0, extra_args=[\"-acceptnonstdtxn=1\"])\n+        self.test_anc_size_limits()\n+        self.test_desc_size_limits()\n+\n+    def test_chain_limits_helper(self, mempool_count, package_count):\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        first_coin = self.coins.pop()\n+        spk = None\n+        txid = first_coin[\"txid\"]\n+        chain_hex = []\n+        chain_txns = []\n+        value = first_coin[\"amount\"]\n+\n+        for i in range(mempool_count + package_count):\n+            (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+            txid = tx.rehash()\n+            if i < mempool_count:\n+                node.sendrawtransaction(txhex)\n+                assert_equal(node.getrawmempool(verbose=True)[txid][\"ancestorcount\"], i + 1)\n+            else:\n+                chain_hex.append(txhex)\n+                chain_txns.append(tx)\n+        testres_too_long = node.testmempoolaccept(rawtxs=chain_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=chain_hex)])\n+\n+    def test_chain_limits(self):\n+        \"\"\"Create chains from mempool and package transactions that are longer than 25,\n+        but only if both in-mempool and in-package transactions are considered together.\n+        This checks that both mempool and in-package transactions are taken into account when\n+        calculating ancestors/descendant limits.\n+        \"\"\"\n+        self.log.info(\"Check that in-package ancestors count for mempool ancestor limits\")\n+\n+        # 24 transactions in the mempool and 2 in the package. The parent in the package has\n+        # 24 in-mempool ancestors and 1 in-package descendant. The child has 0 direct parents\n+        # in the mempool, but 25 in-mempool and in-package ancestors in total.\n+        self.test_chain_limits_helper(24, 2)\n+        # 2 transactions in the mempool and 24 in the package.\n+        self.test_chain_limits_helper(2, 24)\n+        # 13 transactions in the mempool and 13 in the package.\n+        self.test_chain_limits_helper(13, 13)\n+\n+    def test_desc_count_limits(self):\n+        \"\"\"Create an 'A' shaped package with 24 transactions in the mempool and 2 in the package:\n+                    M1\n+                   ^  ^\n+                 M2a  M2b\n+                .       .\n+               .         .\n+              .           .\n+             M12a          ^\n+            ^              M13b\n+           ^                 ^\n+          Pa                  Pb\n+        The top ancestor in the package exceeds descendant limits but only if the in-mempool and in-package\n+        descendants are all considered together (24 including in-mempool descendants and 26 including both\n+        package transactions).\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        self.log.info(\"Check that in-mempool and in-package descendants are calculated properly in packages\")\n+        # Top parent in mempool, M1\n+        first_coin = self.coins.pop()\n+        parent_value = (first_coin[\"amount\"] - Decimal(\"0.0002\")) / 2 # Deduct reasonable fee and make 2 outputs\n+        inputs = [{\"txid\": first_coin[\"txid\"], \"vout\": 0}]\n+        outputs = [{self.address : parent_value}, {ADDRESS_BCRT1_P2WSH_OP_TRUE : parent_value}]\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+\n+        parent_signed = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=self.privkeys)\n+        assert parent_signed[\"complete\"]\n+        parent_tx = tx_from_hex(parent_signed[\"hex\"])\n+        parent_txid = parent_tx.rehash()\n+        node.sendrawtransaction(parent_signed[\"hex\"])\n+\n+        package_hex = []\n+\n+        # Chain A\n+        spk = parent_tx.vout[0].scriptPubKey.hex()\n+        value = parent_value\n+        txid = parent_txid\n+        for i in range(12):\n+            (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+            txid = tx.rehash()\n+            if i < 11: # M2a... M12a\n+                node.sendrawtransaction(txhex)\n+            else: # Pa\n+                package_hex.append(txhex)\n+\n+        # Chain B\n+        value = parent_value - Decimal(\"0.0001\")\n+        rawtx_b = node.createrawtransaction([{\"txid\": parent_txid, \"vout\": 1}], {self.address : value})\n+        tx_child_b = tx_from_hex(rawtx_b) # M2b\n+        tx_child_b.wit.vtxinwit = [CTxInWitness()]\n+        tx_child_b.wit.vtxinwit[0].scriptWitness.stack = [CScript([OP_TRUE])]\n+        tx_child_b_hex = tx_child_b.serialize().hex()\n+        node.sendrawtransaction(tx_child_b_hex)\n+        spk = tx_child_b.vout[0].scriptPubKey.hex()\n+        txid = tx_child_b.rehash()\n+        for i in range(12):\n+            (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+            txid = tx.rehash()\n+            if i < 11: # M3b... M13b\n+                node.sendrawtransaction(txhex)\n+            else: # Pb\n+                package_hex.append(txhex)\n+\n+        assert_equal(24, node.getmempoolinfo()[\"size\"])\n+        assert_equal(2, len(package_hex))\n+        testres_too_long = node.testmempoolaccept(rawtxs=package_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=package_hex)])\n+\n+    def test_anc_count_limits(self):\n+        \"\"\"Create a 'V' shaped chain with 24 transactions in the mempool and 3 in the package:\n+        M1a                    M1b\n+         ^                     ^\n+          M2a                M2b\n+           .                 .\n+            .               .\n+             .             .\n+             M12a        M12b\n+               ^         ^\n+                Pa     Pb\n+                 ^    ^\n+                   Pc\n+        The lowest descendant, Pc, exceeds ancestor limits, but only if the in-mempool\n+        and in-package ancestors are all considered together.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        package_hex = []\n+        parents_tx = []\n+        values = []\n+        scripts = []\n+\n+        self.log.info(\"Check that in-mempool and in-package ancestors are calculated properly in packages\")\n+\n+        # Two chains of 13 transactions each\n+        for _ in range(2):\n+            spk = None\n+            top_coin = self.coins.pop()\n+            txid = top_coin[\"txid\"]\n+            value = top_coin[\"amount\"]\n+            for i in range(13):\n+                (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+                txid = tx.rehash()\n+                if i < 12:\n+                    node.sendrawtransaction(txhex)\n+                else: # Save the 13th transaction for the package\n+                    package_hex.append(txhex)\n+                    parents_tx.append(tx)\n+                    scripts.append(spk)\n+                    values.append(value)\n+\n+        # Child Pc\n+        child_hex = create_child_with_parents(node, self.address, self.privkeys, parents_tx, values, scripts)\n+        package_hex.append(child_hex)\n+\n+        assert_equal(24, node.getmempoolinfo()[\"size\"])\n+        assert_equal(3, len(package_hex))\n+        testres_too_long = node.testmempoolaccept(rawtxs=package_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=package_hex)])\n+\n+    def test_anc_count_limits_2(self):\n+        \"\"\"Create a 'Y' shaped chain with 24 transactions in the mempool and 2 in the package:\n+        M1a                M1b\n+         ^                ^\n+          M2a            M2b\n+           .            .\n+            .          .\n+             .        .\n+            M12a    M12b\n+               ^    ^\n+                 Pc\n+                 ^\n+                 Pd\n+        The lowest descendant, Pd, exceeds ancestor limits, but only if the in-mempool\n+        and in-package ancestors are all considered together.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        parents_tx = []\n+        values = []\n+        scripts = []\n+\n+        self.log.info(\"Check that in-mempool and in-package ancestors are calculated properly in packages\")\n+        # Two chains of 12 transactions each\n+        for _ in range(2):\n+            spk = None\n+            top_coin = self.coins.pop()\n+            txid = top_coin[\"txid\"]\n+            value = top_coin[\"amount\"]\n+            for i in range(12):\n+                (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+                txid = tx.rehash()\n+                value -= Decimal(\"0.0001\")\n+                node.sendrawtransaction(txhex)\n+                if i == 11:\n+                    # last 2 transactions will be the parents of Pc\n+                    parents_tx.append(tx)\n+                    values.append(value)\n+                    scripts.append(spk)\n+\n+        # Child Pc\n+        pc_hex = create_child_with_parents(node, self.address, self.privkeys, parents_tx, values, scripts)\n+        pc_tx = tx_from_hex(pc_hex)\n+        pc_value = sum(values) - Decimal(\"0.0002\")\n+        pc_spk = pc_tx.vout[0].scriptPubKey.hex()\n+\n+        # Child Pd\n+        (_, pd_hex, _, _) = make_chain(node, self.address, self.privkeys, pc_tx.rehash(), pc_value, 0, pc_spk)\n+\n+        assert_equal(24, node.getmempoolinfo()[\"size\"])\n+        testres_too_long = node.testmempoolaccept(rawtxs=[pc_hex, pd_hex])\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=[pc_hex, pd_hex])])\n+\n+    def test_anc_count_limits_bushy(self):\n+        \"\"\"Create a tree with 20 transactions in the mempool and 6 in the package:\n+        M1...M4 M5...M8 M9...M12 M13...M16 M17...M20\n+            ^      ^       ^        ^         ^             (each with 4 parents)\n+            P0     P1      P2      P3        P4\n+             ^     ^       ^       ^         ^              (5 parents)\n+                           PC\n+        Where M(4i+1)...M+(4i+4) are the parents of Pi and P0, P1, P2, P3, and P4 are the parents of PC.\n+        P0... P4 individually only have 4 parents each, and PC has no in-mempool parents. But\n+        combined, PC has 25 in-mempool and in-package parents.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        package_hex = []\n+        parent_txns = []\n+        parent_values = []\n+        scripts = []\n+        for _ in range(5): # Make package transactions P0 ... P4\n+            gp_tx = []\n+            gp_values = []\n+            gp_scripts = []\n+            for _ in range(4): # Make mempool transactions M(4i+1)...M(4i+4)\n+                parent_coin = self.coins.pop()\n+                value = parent_coin[\"amount\"]\n+                txid = parent_coin[\"txid\"]\n+                (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value)\n+                gp_tx.append(tx)\n+                gp_values.append(value)\n+                gp_scripts.append(spk)\n+                node.sendrawtransaction(txhex)\n+            # Package transaction Pi\n+            pi_hex = create_child_with_parents(node, self.address, self.privkeys, gp_tx, gp_values, gp_scripts)\n+            package_hex.append(pi_hex)\n+            pi_tx = tx_from_hex(pi_hex)\n+            parent_txns.append(pi_tx)\n+            parent_values.append(Decimal(pi_tx.vout[0].nValue) / COIN)\n+            scripts.append(pi_tx.vout[0].scriptPubKey.hex())\n+        # Package transaction PC\n+        package_hex.append(create_child_with_parents(node, self.address, self.privkeys, parent_txns, parent_values, scripts))\n+\n+        assert_equal(20, node.getmempoolinfo()[\"size\"])\n+        assert_equal(6, len(package_hex))\n+        testres = node.testmempoolaccept(rawtxs=package_hex)\n+        for txres in testres:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=package_hex)])\n+\n+    def test_anc_size_limits(self):\n+        \"\"\"Test Case with 2 independent transactions in the mempool and a parent + child in the\n+        package, where the package parent is the child of both mempool transactions (30KvB each):\n+              A     B\n+               ^   ^\n+                 C\n+                 ^\n+                 D\n+        The lowest descendant, D, exceeds ancestor size limits, but only if the in-mempool\n+        and in-package ancestors are all considered together.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        parents_tx = []\n+        values = []\n+        scripts = []\n+        target_weight = WITNESS_SCALE_FACTOR * 1000 * 30 # 30KvB\n+        high_fee = Decimal(\"0.003\") # 10 sats/vB\n+        self.log.info(\"Check that in-mempool and in-package ancestor size limits are calculated properly in packages\")\n+        # Mempool transactions A and B\n+        for _ in range(2):\n+            spk = None\n+            top_coin = self.coins.pop()\n+            txid = top_coin[\"txid\"]\n+            value = top_coin[\"amount\"]\n+            (tx, _, _, _) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk, high_fee)\n+            bulked_tx = bulk_transaction(tx, node, target_weight, self.privkeys)\n+            node.sendrawtransaction(bulked_tx.serialize().hex())\n+            parents_tx.append(bulked_tx)\n+            values.append(Decimal(bulked_tx.vout[0].nValue) / COIN)\n+            scripts.append(bulked_tx.vout[0].scriptPubKey.hex())\n+\n+        # Package transaction C\n+        small_pc_hex = create_child_with_parents(node, self.address, self.privkeys, parents_tx, values, scripts, high_fee)\n+        pc_tx = bulk_transaction(tx_from_hex(small_pc_hex), node, target_weight, self.privkeys)\n+        pc_value = Decimal(pc_tx.vout[0].nValue) / COIN\n+        pc_spk = pc_tx.vout[0].scriptPubKey.hex()\n+        pc_hex = pc_tx.serialize().hex()\n+\n+        # Package transaction D\n+        (small_pd, _, val, spk) = make_chain(node, self.address, self.privkeys, pc_tx.rehash(), pc_value, 0, pc_spk, high_fee)\n+        prevtxs = [{\n+            \"txid\": pc_tx.rehash(),\n+            \"vout\": 0,\n+            \"scriptPubKey\": spk,\n+            \"amount\": val,\n+        }]\n+        pd_tx = bulk_transaction(small_pd, node, target_weight, self.privkeys, prevtxs)\n+        pd_hex = pd_tx.serialize().hex()\n+\n+        assert_equal(2, node.getmempoolinfo()[\"size\"])\n+        testres_too_heavy = node.testmempoolaccept(rawtxs=[pc_hex, pd_hex])\n+        for txres in testres_too_heavy:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685150952",
      "id" : 685150952,
      "line" : 397,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NTE1MDk1Mg==",
      "original_commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "original_line" : 397,
      "original_position" : 397,
      "original_start_line" : null,
      "path" : "test/functional/mempool_package_limits.py",
      "position" : 397,
      "pull_request_review_id" : 725180293,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-09T12:47:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685150952",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685152884"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685152884"
         }
      },
      "author_association" : "MEMBER",
      "body" : "No need to declare variables in Python",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-09T12:34:21Z",
      "diff_hunk" : "@@ -0,0 +1,475 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test logic for limiting mempool and package ancestors/descendants.\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.address import ADDRESS_BCRT1_P2WSH_OP_TRUE\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    COIN,\n+    CTransaction,\n+    CTxInWitness,\n+    tx_from_hex,\n+    WITNESS_SCALE_FACTOR,\n+)\n+from test_framework.script import (\n+    CScript,\n+    OP_TRUE,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+from test_framework.wallet import (\n+    bulk_transaction,\n+    create_child_with_parents,\n+    make_chain,\n+)\n+\n+class MempoolPackageLimitsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.setup_clean_chain = True\n+\n+    def run_test(self):\n+        self.log.info(\"Generate blocks to create UTXOs\")\n+        node = self.nodes[0]\n+        self.privkeys = [node.get_deterministic_priv_key().key]\n+        self.address = node.get_deterministic_priv_key().address\n+        self.coins = []\n+        # The last 100 coinbase transactions are premature\n+        for b in node.generatetoaddress(200, self.address)[:100]:\n+            coinbase = node.getblock(blockhash=b, verbosity=2)[\"tx\"][0]\n+            self.coins.append({\n+                \"txid\": coinbase[\"txid\"],\n+                \"amount\": coinbase[\"vout\"][0][\"value\"],\n+                \"scriptPubKey\": coinbase[\"vout\"][0][\"scriptPubKey\"],\n+            })\n+\n+        self.test_chain_limits()\n+        self.test_desc_count_limits()\n+        self.test_anc_count_limits()\n+        self.test_anc_count_limits_2()\n+        self.test_anc_count_limits_bushy()\n+\n+        # The node will accept our (nonstandard) extra large OP_RETURN outputs\n+        self.restart_node(0, extra_args=[\"-acceptnonstdtxn=1\"])\n+        self.test_anc_size_limits()\n+        self.test_desc_size_limits()\n+\n+    def test_chain_limits_helper(self, mempool_count, package_count):\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        first_coin = self.coins.pop()\n+        spk = None\n+        txid = first_coin[\"txid\"]\n+        chain_hex = []\n+        chain_txns = []\n+        value = first_coin[\"amount\"]\n+\n+        for i in range(mempool_count + package_count):\n+            (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+            txid = tx.rehash()\n+            if i < mempool_count:\n+                node.sendrawtransaction(txhex)\n+                assert_equal(node.getrawmempool(verbose=True)[txid][\"ancestorcount\"], i + 1)\n+            else:\n+                chain_hex.append(txhex)\n+                chain_txns.append(tx)\n+        testres_too_long = node.testmempoolaccept(rawtxs=chain_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=chain_hex)])\n+\n+    def test_chain_limits(self):\n+        \"\"\"Create chains from mempool and package transactions that are longer than 25,\n+        but only if both in-mempool and in-package transactions are considered together.\n+        This checks that both mempool and in-package transactions are taken into account when\n+        calculating ancestors/descendant limits.\n+        \"\"\"\n+        self.log.info(\"Check that in-package ancestors count for mempool ancestor limits\")\n+\n+        # 24 transactions in the mempool and 2 in the package. The parent in the package has\n+        # 24 in-mempool ancestors and 1 in-package descendant. The child has 0 direct parents\n+        # in the mempool, but 25 in-mempool and in-package ancestors in total.\n+        self.test_chain_limits_helper(24, 2)\n+        # 2 transactions in the mempool and 24 in the package.\n+        self.test_chain_limits_helper(2, 24)\n+        # 13 transactions in the mempool and 13 in the package.\n+        self.test_chain_limits_helper(13, 13)\n+\n+    def test_desc_count_limits(self):\n+        \"\"\"Create an 'A' shaped package with 24 transactions in the mempool and 2 in the package:\n+                    M1\n+                   ^  ^\n+                 M2a  M2b\n+                .       .\n+               .         .\n+              .           .\n+             M12a          ^\n+            ^              M13b\n+           ^                 ^\n+          Pa                  Pb\n+        The top ancestor in the package exceeds descendant limits but only if the in-mempool and in-package\n+        descendants are all considered together (24 including in-mempool descendants and 26 including both\n+        package transactions).\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        self.log.info(\"Check that in-mempool and in-package descendants are calculated properly in packages\")\n+        # Top parent in mempool, M1\n+        first_coin = self.coins.pop()\n+        parent_value = (first_coin[\"amount\"] - Decimal(\"0.0002\")) / 2 # Deduct reasonable fee and make 2 outputs\n+        inputs = [{\"txid\": first_coin[\"txid\"], \"vout\": 0}]\n+        outputs = [{self.address : parent_value}, {ADDRESS_BCRT1_P2WSH_OP_TRUE : parent_value}]\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+\n+        parent_signed = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=self.privkeys)\n+        assert parent_signed[\"complete\"]\n+        parent_tx = tx_from_hex(parent_signed[\"hex\"])\n+        parent_txid = parent_tx.rehash()\n+        node.sendrawtransaction(parent_signed[\"hex\"])\n+\n+        package_hex = []\n+\n+        # Chain A\n+        spk = parent_tx.vout[0].scriptPubKey.hex()\n+        value = parent_value\n+        txid = parent_txid\n+        for i in range(12):\n+            (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+            txid = tx.rehash()\n+            if i < 11: # M2a... M12a\n+                node.sendrawtransaction(txhex)\n+            else: # Pa\n+                package_hex.append(txhex)\n+\n+        # Chain B\n+        value = parent_value - Decimal(\"0.0001\")\n+        rawtx_b = node.createrawtransaction([{\"txid\": parent_txid, \"vout\": 1}], {self.address : value})\n+        tx_child_b = tx_from_hex(rawtx_b) # M2b\n+        tx_child_b.wit.vtxinwit = [CTxInWitness()]\n+        tx_child_b.wit.vtxinwit[0].scriptWitness.stack = [CScript([OP_TRUE])]\n+        tx_child_b_hex = tx_child_b.serialize().hex()\n+        node.sendrawtransaction(tx_child_b_hex)\n+        spk = tx_child_b.vout[0].scriptPubKey.hex()\n+        txid = tx_child_b.rehash()\n+        for i in range(12):\n+            (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+            txid = tx.rehash()\n+            if i < 11: # M3b... M13b\n+                node.sendrawtransaction(txhex)\n+            else: # Pb\n+                package_hex.append(txhex)\n+\n+        assert_equal(24, node.getmempoolinfo()[\"size\"])\n+        assert_equal(2, len(package_hex))\n+        testres_too_long = node.testmempoolaccept(rawtxs=package_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=package_hex)])\n+\n+    def test_anc_count_limits(self):\n+        \"\"\"Create a 'V' shaped chain with 24 transactions in the mempool and 3 in the package:\n+        M1a                    M1b\n+         ^                     ^\n+          M2a                M2b\n+           .                 .\n+            .               .\n+             .             .\n+             M12a        M12b\n+               ^         ^\n+                Pa     Pb\n+                 ^    ^\n+                   Pc\n+        The lowest descendant, Pc, exceeds ancestor limits, but only if the in-mempool\n+        and in-package ancestors are all considered together.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        package_hex = []\n+        parents_tx = []\n+        values = []\n+        scripts = []\n+\n+        self.log.info(\"Check that in-mempool and in-package ancestors are calculated properly in packages\")\n+\n+        # Two chains of 13 transactions each\n+        for _ in range(2):\n+            spk = None\n+            top_coin = self.coins.pop()\n+            txid = top_coin[\"txid\"]\n+            value = top_coin[\"amount\"]\n+            for i in range(13):\n+                (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+                txid = tx.rehash()\n+                if i < 12:\n+                    node.sendrawtransaction(txhex)\n+                else: # Save the 13th transaction for the package\n+                    package_hex.append(txhex)\n+                    parents_tx.append(tx)\n+                    scripts.append(spk)\n+                    values.append(value)\n+\n+        # Child Pc\n+        child_hex = create_child_with_parents(node, self.address, self.privkeys, parents_tx, values, scripts)\n+        package_hex.append(child_hex)\n+\n+        assert_equal(24, node.getmempoolinfo()[\"size\"])\n+        assert_equal(3, len(package_hex))\n+        testres_too_long = node.testmempoolaccept(rawtxs=package_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=package_hex)])\n+\n+    def test_anc_count_limits_2(self):\n+        \"\"\"Create a 'Y' shaped chain with 24 transactions in the mempool and 2 in the package:\n+        M1a                M1b\n+         ^                ^\n+          M2a            M2b\n+           .            .\n+            .          .\n+             .        .\n+            M12a    M12b\n+               ^    ^\n+                 Pc\n+                 ^\n+                 Pd\n+        The lowest descendant, Pd, exceeds ancestor limits, but only if the in-mempool\n+        and in-package ancestors are all considered together.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        parents_tx = []\n+        values = []\n+        scripts = []\n+\n+        self.log.info(\"Check that in-mempool and in-package ancestors are calculated properly in packages\")\n+        # Two chains of 12 transactions each\n+        for _ in range(2):\n+            spk = None\n+            top_coin = self.coins.pop()\n+            txid = top_coin[\"txid\"]\n+            value = top_coin[\"amount\"]\n+            for i in range(12):\n+                (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+                txid = tx.rehash()\n+                value -= Decimal(\"0.0001\")\n+                node.sendrawtransaction(txhex)\n+                if i == 11:\n+                    # last 2 transactions will be the parents of Pc\n+                    parents_tx.append(tx)\n+                    values.append(value)\n+                    scripts.append(spk)\n+\n+        # Child Pc\n+        pc_hex = create_child_with_parents(node, self.address, self.privkeys, parents_tx, values, scripts)\n+        pc_tx = tx_from_hex(pc_hex)\n+        pc_value = sum(values) - Decimal(\"0.0002\")\n+        pc_spk = pc_tx.vout[0].scriptPubKey.hex()\n+\n+        # Child Pd\n+        (_, pd_hex, _, _) = make_chain(node, self.address, self.privkeys, pc_tx.rehash(), pc_value, 0, pc_spk)\n+\n+        assert_equal(24, node.getmempoolinfo()[\"size\"])\n+        testres_too_long = node.testmempoolaccept(rawtxs=[pc_hex, pd_hex])\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=[pc_hex, pd_hex])])\n+\n+    def test_anc_count_limits_bushy(self):\n+        \"\"\"Create a tree with 20 transactions in the mempool and 6 in the package:\n+        M1...M4 M5...M8 M9...M12 M13...M16 M17...M20\n+            ^      ^       ^        ^         ^             (each with 4 parents)\n+            P0     P1      P2      P3        P4\n+             ^     ^       ^       ^         ^              (5 parents)\n+                           PC\n+        Where M(4i+1)...M+(4i+4) are the parents of Pi and P0, P1, P2, P3, and P4 are the parents of PC.\n+        P0... P4 individually only have 4 parents each, and PC has no in-mempool parents. But\n+        combined, PC has 25 in-mempool and in-package parents.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        package_hex = []\n+        parent_txns = []\n+        parent_values = []\n+        scripts = []\n+        for _ in range(5): # Make package transactions P0 ... P4\n+            gp_tx = []\n+            gp_values = []\n+            gp_scripts = []\n+            for _ in range(4): # Make mempool transactions M(4i+1)...M(4i+4)\n+                parent_coin = self.coins.pop()\n+                value = parent_coin[\"amount\"]\n+                txid = parent_coin[\"txid\"]\n+                (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value)\n+                gp_tx.append(tx)\n+                gp_values.append(value)\n+                gp_scripts.append(spk)\n+                node.sendrawtransaction(txhex)\n+            # Package transaction Pi\n+            pi_hex = create_child_with_parents(node, self.address, self.privkeys, gp_tx, gp_values, gp_scripts)\n+            package_hex.append(pi_hex)\n+            pi_tx = tx_from_hex(pi_hex)\n+            parent_txns.append(pi_tx)\n+            parent_values.append(Decimal(pi_tx.vout[0].nValue) / COIN)\n+            scripts.append(pi_tx.vout[0].scriptPubKey.hex())\n+        # Package transaction PC\n+        package_hex.append(create_child_with_parents(node, self.address, self.privkeys, parent_txns, parent_values, scripts))\n+\n+        assert_equal(20, node.getmempoolinfo()[\"size\"])\n+        assert_equal(6, len(package_hex))\n+        testres = node.testmempoolaccept(rawtxs=package_hex)\n+        for txres in testres:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=package_hex)])\n+\n+    def test_anc_size_limits(self):\n+        \"\"\"Test Case with 2 independent transactions in the mempool and a parent + child in the\n+        package, where the package parent is the child of both mempool transactions (30KvB each):\n+              A     B\n+               ^   ^\n+                 C\n+                 ^\n+                 D\n+        The lowest descendant, D, exceeds ancestor size limits, but only if the in-mempool\n+        and in-package ancestors are all considered together.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        parents_tx = []\n+        values = []\n+        scripts = []\n+        target_weight = WITNESS_SCALE_FACTOR * 1000 * 30 # 30KvB\n+        high_fee = Decimal(\"0.003\") # 10 sats/vB\n+        self.log.info(\"Check that in-mempool and in-package ancestor size limits are calculated properly in packages\")\n+        # Mempool transactions A and B\n+        for _ in range(2):\n+            spk = None\n+            top_coin = self.coins.pop()\n+            txid = top_coin[\"txid\"]\n+            value = top_coin[\"amount\"]\n+            (tx, _, _, _) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk, high_fee)\n+            bulked_tx = bulk_transaction(tx, node, target_weight, self.privkeys)\n+            node.sendrawtransaction(bulked_tx.serialize().hex())\n+            parents_tx.append(bulked_tx)\n+            values.append(Decimal(bulked_tx.vout[0].nValue) / COIN)\n+            scripts.append(bulked_tx.vout[0].scriptPubKey.hex())\n+\n+        # Package transaction C\n+        small_pc_hex = create_child_with_parents(node, self.address, self.privkeys, parents_tx, values, scripts, high_fee)\n+        pc_tx = bulk_transaction(tx_from_hex(small_pc_hex), node, target_weight, self.privkeys)\n+        pc_value = Decimal(pc_tx.vout[0].nValue) / COIN\n+        pc_spk = pc_tx.vout[0].scriptPubKey.hex()\n+        pc_hex = pc_tx.serialize().hex()\n+\n+        # Package transaction D\n+        (small_pd, _, val, spk) = make_chain(node, self.address, self.privkeys, pc_tx.rehash(), pc_value, 0, pc_spk, high_fee)\n+        prevtxs = [{\n+            \"txid\": pc_tx.rehash(),\n+            \"vout\": 0,\n+            \"scriptPubKey\": spk,\n+            \"amount\": val,\n+        }]\n+        pd_tx = bulk_transaction(small_pd, node, target_weight, self.privkeys, prevtxs)\n+        pd_hex = pd_tx.serialize().hex()\n+\n+        assert_equal(2, node.getmempoolinfo()[\"size\"])\n+        testres_too_heavy = node.testmempoolaccept(rawtxs=[pc_hex, pd_hex])\n+        for txres in testres_too_heavy:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=[pc_hex, pd_hex])])\n+\n+    def test_desc_size_limits(self):\n+        \"\"\"Create 3 mempool transactions and 2 package transactions (25KvB each):\n+              Ma\n+             ^ ^\n+            Mb  Mc\n+           ^     ^\n+          Pd      Pe\n+        The top ancestor in the package exceeds descendant size limits but only if the in-mempool\n+        and in-package descendants are all considered together.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        target_weight = 21 * 1000 * WITNESS_SCALE_FACTOR\n+        high_fee = Decimal(\"0.0021\") # 10 sats/vB\n+        self.log.info(\"Check that in-mempool and in-package descendant sizes are calculated properly in packages\")\n+        # Top parent in mempool, Ma\n+        first_coin = self.coins.pop()\n+        parent_value = (first_coin[\"amount\"] - high_fee) / 2 # Deduct fee and make 2 outputs\n+        inputs = [{\"txid\": first_coin[\"txid\"], \"vout\": 0}]\n+        outputs = [{self.address : parent_value}, {ADDRESS_BCRT1_P2WSH_OP_TRUE:  parent_value}]\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+        parent_tx = bulk_transaction(tx_from_hex(rawtx), node, target_weight, self.privkeys)\n+        node.sendrawtransaction(parent_tx.serialize().hex())\n+\n+        package_hex = []\n+        for j in range(2): # Two legs (left and right)\n+            # Mempool transaction (Mb and Mc)\n+            mempool_tx = CTransaction()",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685152884",
      "id" : 685152884,
      "line" : 430,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NTE1Mjg4NA==",
      "original_commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "original_line" : 430,
      "original_position" : 430,
      "original_start_line" : null,
      "path" : "test/functional/mempool_package_limits.py",
      "position" : 430,
      "pull_request_review_id" : 725180293,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-09T12:47:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685152884",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685158927"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685158927"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe choose between `tx_small` and `small_tx` and stick to it :)",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-09T12:43:35Z",
      "diff_hunk" : "@@ -0,0 +1,475 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test logic for limiting mempool and package ancestors/descendants.\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.address import ADDRESS_BCRT1_P2WSH_OP_TRUE\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    COIN,\n+    CTransaction,\n+    CTxInWitness,\n+    tx_from_hex,\n+    WITNESS_SCALE_FACTOR,\n+)\n+from test_framework.script import (\n+    CScript,\n+    OP_TRUE,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+from test_framework.wallet import (\n+    bulk_transaction,\n+    create_child_with_parents,\n+    make_chain,\n+)\n+\n+class MempoolPackageLimitsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.setup_clean_chain = True\n+\n+    def run_test(self):\n+        self.log.info(\"Generate blocks to create UTXOs\")\n+        node = self.nodes[0]\n+        self.privkeys = [node.get_deterministic_priv_key().key]\n+        self.address = node.get_deterministic_priv_key().address\n+        self.coins = []\n+        # The last 100 coinbase transactions are premature\n+        for b in node.generatetoaddress(200, self.address)[:100]:\n+            coinbase = node.getblock(blockhash=b, verbosity=2)[\"tx\"][0]\n+            self.coins.append({\n+                \"txid\": coinbase[\"txid\"],\n+                \"amount\": coinbase[\"vout\"][0][\"value\"],\n+                \"scriptPubKey\": coinbase[\"vout\"][0][\"scriptPubKey\"],\n+            })\n+\n+        self.test_chain_limits()\n+        self.test_desc_count_limits()\n+        self.test_anc_count_limits()\n+        self.test_anc_count_limits_2()\n+        self.test_anc_count_limits_bushy()\n+\n+        # The node will accept our (nonstandard) extra large OP_RETURN outputs\n+        self.restart_node(0, extra_args=[\"-acceptnonstdtxn=1\"])\n+        self.test_anc_size_limits()\n+        self.test_desc_size_limits()\n+\n+    def test_chain_limits_helper(self, mempool_count, package_count):\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        first_coin = self.coins.pop()\n+        spk = None\n+        txid = first_coin[\"txid\"]\n+        chain_hex = []\n+        chain_txns = []\n+        value = first_coin[\"amount\"]\n+\n+        for i in range(mempool_count + package_count):\n+            (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+            txid = tx.rehash()\n+            if i < mempool_count:\n+                node.sendrawtransaction(txhex)\n+                assert_equal(node.getrawmempool(verbose=True)[txid][\"ancestorcount\"], i + 1)\n+            else:\n+                chain_hex.append(txhex)\n+                chain_txns.append(tx)\n+        testres_too_long = node.testmempoolaccept(rawtxs=chain_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=chain_hex)])\n+\n+    def test_chain_limits(self):\n+        \"\"\"Create chains from mempool and package transactions that are longer than 25,\n+        but only if both in-mempool and in-package transactions are considered together.\n+        This checks that both mempool and in-package transactions are taken into account when\n+        calculating ancestors/descendant limits.\n+        \"\"\"\n+        self.log.info(\"Check that in-package ancestors count for mempool ancestor limits\")\n+\n+        # 24 transactions in the mempool and 2 in the package. The parent in the package has\n+        # 24 in-mempool ancestors and 1 in-package descendant. The child has 0 direct parents\n+        # in the mempool, but 25 in-mempool and in-package ancestors in total.\n+        self.test_chain_limits_helper(24, 2)\n+        # 2 transactions in the mempool and 24 in the package.\n+        self.test_chain_limits_helper(2, 24)\n+        # 13 transactions in the mempool and 13 in the package.\n+        self.test_chain_limits_helper(13, 13)\n+\n+    def test_desc_count_limits(self):\n+        \"\"\"Create an 'A' shaped package with 24 transactions in the mempool and 2 in the package:\n+                    M1\n+                   ^  ^\n+                 M2a  M2b\n+                .       .\n+               .         .\n+              .           .\n+             M12a          ^\n+            ^              M13b\n+           ^                 ^\n+          Pa                  Pb\n+        The top ancestor in the package exceeds descendant limits but only if the in-mempool and in-package\n+        descendants are all considered together (24 including in-mempool descendants and 26 including both\n+        package transactions).\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        self.log.info(\"Check that in-mempool and in-package descendants are calculated properly in packages\")\n+        # Top parent in mempool, M1\n+        first_coin = self.coins.pop()\n+        parent_value = (first_coin[\"amount\"] - Decimal(\"0.0002\")) / 2 # Deduct reasonable fee and make 2 outputs\n+        inputs = [{\"txid\": first_coin[\"txid\"], \"vout\": 0}]\n+        outputs = [{self.address : parent_value}, {ADDRESS_BCRT1_P2WSH_OP_TRUE : parent_value}]\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+\n+        parent_signed = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=self.privkeys)\n+        assert parent_signed[\"complete\"]\n+        parent_tx = tx_from_hex(parent_signed[\"hex\"])\n+        parent_txid = parent_tx.rehash()\n+        node.sendrawtransaction(parent_signed[\"hex\"])\n+\n+        package_hex = []\n+\n+        # Chain A\n+        spk = parent_tx.vout[0].scriptPubKey.hex()\n+        value = parent_value\n+        txid = parent_txid\n+        for i in range(12):\n+            (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+            txid = tx.rehash()\n+            if i < 11: # M2a... M12a\n+                node.sendrawtransaction(txhex)\n+            else: # Pa\n+                package_hex.append(txhex)\n+\n+        # Chain B\n+        value = parent_value - Decimal(\"0.0001\")\n+        rawtx_b = node.createrawtransaction([{\"txid\": parent_txid, \"vout\": 1}], {self.address : value})\n+        tx_child_b = tx_from_hex(rawtx_b) # M2b\n+        tx_child_b.wit.vtxinwit = [CTxInWitness()]\n+        tx_child_b.wit.vtxinwit[0].scriptWitness.stack = [CScript([OP_TRUE])]\n+        tx_child_b_hex = tx_child_b.serialize().hex()\n+        node.sendrawtransaction(tx_child_b_hex)\n+        spk = tx_child_b.vout[0].scriptPubKey.hex()\n+        txid = tx_child_b.rehash()\n+        for i in range(12):\n+            (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+            txid = tx.rehash()\n+            if i < 11: # M3b... M13b\n+                node.sendrawtransaction(txhex)\n+            else: # Pb\n+                package_hex.append(txhex)\n+\n+        assert_equal(24, node.getmempoolinfo()[\"size\"])\n+        assert_equal(2, len(package_hex))\n+        testres_too_long = node.testmempoolaccept(rawtxs=package_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=package_hex)])\n+\n+    def test_anc_count_limits(self):\n+        \"\"\"Create a 'V' shaped chain with 24 transactions in the mempool and 3 in the package:\n+        M1a                    M1b\n+         ^                     ^\n+          M2a                M2b\n+           .                 .\n+            .               .\n+             .             .\n+             M12a        M12b\n+               ^         ^\n+                Pa     Pb\n+                 ^    ^\n+                   Pc\n+        The lowest descendant, Pc, exceeds ancestor limits, but only if the in-mempool\n+        and in-package ancestors are all considered together.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        package_hex = []\n+        parents_tx = []\n+        values = []\n+        scripts = []\n+\n+        self.log.info(\"Check that in-mempool and in-package ancestors are calculated properly in packages\")\n+\n+        # Two chains of 13 transactions each\n+        for _ in range(2):\n+            spk = None\n+            top_coin = self.coins.pop()\n+            txid = top_coin[\"txid\"]\n+            value = top_coin[\"amount\"]\n+            for i in range(13):\n+                (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+                txid = tx.rehash()\n+                if i < 12:\n+                    node.sendrawtransaction(txhex)\n+                else: # Save the 13th transaction for the package\n+                    package_hex.append(txhex)\n+                    parents_tx.append(tx)\n+                    scripts.append(spk)\n+                    values.append(value)\n+\n+        # Child Pc\n+        child_hex = create_child_with_parents(node, self.address, self.privkeys, parents_tx, values, scripts)\n+        package_hex.append(child_hex)\n+\n+        assert_equal(24, node.getmempoolinfo()[\"size\"])\n+        assert_equal(3, len(package_hex))\n+        testres_too_long = node.testmempoolaccept(rawtxs=package_hex)\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=package_hex)])\n+\n+    def test_anc_count_limits_2(self):\n+        \"\"\"Create a 'Y' shaped chain with 24 transactions in the mempool and 2 in the package:\n+        M1a                M1b\n+         ^                ^\n+          M2a            M2b\n+           .            .\n+            .          .\n+             .        .\n+            M12a    M12b\n+               ^    ^\n+                 Pc\n+                 ^\n+                 Pd\n+        The lowest descendant, Pd, exceeds ancestor limits, but only if the in-mempool\n+        and in-package ancestors are all considered together.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        parents_tx = []\n+        values = []\n+        scripts = []\n+\n+        self.log.info(\"Check that in-mempool and in-package ancestors are calculated properly in packages\")\n+        # Two chains of 12 transactions each\n+        for _ in range(2):\n+            spk = None\n+            top_coin = self.coins.pop()\n+            txid = top_coin[\"txid\"]\n+            value = top_coin[\"amount\"]\n+            for i in range(12):\n+                (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk)\n+                txid = tx.rehash()\n+                value -= Decimal(\"0.0001\")\n+                node.sendrawtransaction(txhex)\n+                if i == 11:\n+                    # last 2 transactions will be the parents of Pc\n+                    parents_tx.append(tx)\n+                    values.append(value)\n+                    scripts.append(spk)\n+\n+        # Child Pc\n+        pc_hex = create_child_with_parents(node, self.address, self.privkeys, parents_tx, values, scripts)\n+        pc_tx = tx_from_hex(pc_hex)\n+        pc_value = sum(values) - Decimal(\"0.0002\")\n+        pc_spk = pc_tx.vout[0].scriptPubKey.hex()\n+\n+        # Child Pd\n+        (_, pd_hex, _, _) = make_chain(node, self.address, self.privkeys, pc_tx.rehash(), pc_value, 0, pc_spk)\n+\n+        assert_equal(24, node.getmempoolinfo()[\"size\"])\n+        testres_too_long = node.testmempoolaccept(rawtxs=[pc_hex, pd_hex])\n+        for txres in testres_too_long:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=[pc_hex, pd_hex])])\n+\n+    def test_anc_count_limits_bushy(self):\n+        \"\"\"Create a tree with 20 transactions in the mempool and 6 in the package:\n+        M1...M4 M5...M8 M9...M12 M13...M16 M17...M20\n+            ^      ^       ^        ^         ^             (each with 4 parents)\n+            P0     P1      P2      P3        P4\n+             ^     ^       ^       ^         ^              (5 parents)\n+                           PC\n+        Where M(4i+1)...M+(4i+4) are the parents of Pi and P0, P1, P2, P3, and P4 are the parents of PC.\n+        P0... P4 individually only have 4 parents each, and PC has no in-mempool parents. But\n+        combined, PC has 25 in-mempool and in-package parents.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        package_hex = []\n+        parent_txns = []\n+        parent_values = []\n+        scripts = []\n+        for _ in range(5): # Make package transactions P0 ... P4\n+            gp_tx = []\n+            gp_values = []\n+            gp_scripts = []\n+            for _ in range(4): # Make mempool transactions M(4i+1)...M(4i+4)\n+                parent_coin = self.coins.pop()\n+                value = parent_coin[\"amount\"]\n+                txid = parent_coin[\"txid\"]\n+                (tx, txhex, value, spk) = make_chain(node, self.address, self.privkeys, txid, value)\n+                gp_tx.append(tx)\n+                gp_values.append(value)\n+                gp_scripts.append(spk)\n+                node.sendrawtransaction(txhex)\n+            # Package transaction Pi\n+            pi_hex = create_child_with_parents(node, self.address, self.privkeys, gp_tx, gp_values, gp_scripts)\n+            package_hex.append(pi_hex)\n+            pi_tx = tx_from_hex(pi_hex)\n+            parent_txns.append(pi_tx)\n+            parent_values.append(Decimal(pi_tx.vout[0].nValue) / COIN)\n+            scripts.append(pi_tx.vout[0].scriptPubKey.hex())\n+        # Package transaction PC\n+        package_hex.append(create_child_with_parents(node, self.address, self.privkeys, parent_txns, parent_values, scripts))\n+\n+        assert_equal(20, node.getmempoolinfo()[\"size\"])\n+        assert_equal(6, len(package_hex))\n+        testres = node.testmempoolaccept(rawtxs=package_hex)\n+        for txres in testres:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=package_hex)])\n+\n+    def test_anc_size_limits(self):\n+        \"\"\"Test Case with 2 independent transactions in the mempool and a parent + child in the\n+        package, where the package parent is the child of both mempool transactions (30KvB each):\n+              A     B\n+               ^   ^\n+                 C\n+                 ^\n+                 D\n+        The lowest descendant, D, exceeds ancestor size limits, but only if the in-mempool\n+        and in-package ancestors are all considered together.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        parents_tx = []\n+        values = []\n+        scripts = []\n+        target_weight = WITNESS_SCALE_FACTOR * 1000 * 30 # 30KvB\n+        high_fee = Decimal(\"0.003\") # 10 sats/vB\n+        self.log.info(\"Check that in-mempool and in-package ancestor size limits are calculated properly in packages\")\n+        # Mempool transactions A and B\n+        for _ in range(2):\n+            spk = None\n+            top_coin = self.coins.pop()\n+            txid = top_coin[\"txid\"]\n+            value = top_coin[\"amount\"]\n+            (tx, _, _, _) = make_chain(node, self.address, self.privkeys, txid, value, 0, spk, high_fee)\n+            bulked_tx = bulk_transaction(tx, node, target_weight, self.privkeys)\n+            node.sendrawtransaction(bulked_tx.serialize().hex())\n+            parents_tx.append(bulked_tx)\n+            values.append(Decimal(bulked_tx.vout[0].nValue) / COIN)\n+            scripts.append(bulked_tx.vout[0].scriptPubKey.hex())\n+\n+        # Package transaction C\n+        small_pc_hex = create_child_with_parents(node, self.address, self.privkeys, parents_tx, values, scripts, high_fee)\n+        pc_tx = bulk_transaction(tx_from_hex(small_pc_hex), node, target_weight, self.privkeys)\n+        pc_value = Decimal(pc_tx.vout[0].nValue) / COIN\n+        pc_spk = pc_tx.vout[0].scriptPubKey.hex()\n+        pc_hex = pc_tx.serialize().hex()\n+\n+        # Package transaction D\n+        (small_pd, _, val, spk) = make_chain(node, self.address, self.privkeys, pc_tx.rehash(), pc_value, 0, pc_spk, high_fee)\n+        prevtxs = [{\n+            \"txid\": pc_tx.rehash(),\n+            \"vout\": 0,\n+            \"scriptPubKey\": spk,\n+            \"amount\": val,\n+        }]\n+        pd_tx = bulk_transaction(small_pd, node, target_weight, self.privkeys, prevtxs)\n+        pd_hex = pd_tx.serialize().hex()\n+\n+        assert_equal(2, node.getmempoolinfo()[\"size\"])\n+        testres_too_heavy = node.testmempoolaccept(rawtxs=[pc_hex, pd_hex])\n+        for txres in testres_too_heavy:\n+            assert_equal(txres[\"package-error\"], \"package-mempool-limits\")\n+\n+        # Clear mempool and check that the package passes now\n+        node.generate(1)\n+        assert all([res[\"allowed\"] for res in node.testmempoolaccept(rawtxs=[pc_hex, pd_hex])])\n+\n+    def test_desc_size_limits(self):\n+        \"\"\"Create 3 mempool transactions and 2 package transactions (25KvB each):\n+              Ma\n+             ^ ^\n+            Mb  Mc\n+           ^     ^\n+          Pd      Pe\n+        The top ancestor in the package exceeds descendant size limits but only if the in-mempool\n+        and in-package descendants are all considered together.\n+        \"\"\"\n+        node = self.nodes[0]\n+        assert_equal(0, node.getmempoolinfo()[\"size\"])\n+        target_weight = 21 * 1000 * WITNESS_SCALE_FACTOR\n+        high_fee = Decimal(\"0.0021\") # 10 sats/vB\n+        self.log.info(\"Check that in-mempool and in-package descendant sizes are calculated properly in packages\")\n+        # Top parent in mempool, Ma\n+        first_coin = self.coins.pop()\n+        parent_value = (first_coin[\"amount\"] - high_fee) / 2 # Deduct fee and make 2 outputs\n+        inputs = [{\"txid\": first_coin[\"txid\"], \"vout\": 0}]\n+        outputs = [{self.address : parent_value}, {ADDRESS_BCRT1_P2WSH_OP_TRUE:  parent_value}]\n+        rawtx = node.createrawtransaction(inputs, outputs)\n+        parent_tx = bulk_transaction(tx_from_hex(rawtx), node, target_weight, self.privkeys)\n+        node.sendrawtransaction(parent_tx.serialize().hex())\n+\n+        package_hex = []\n+        for j in range(2): # Two legs (left and right)\n+            # Mempool transaction (Mb and Mc)\n+            mempool_tx = CTransaction()\n+            spk = parent_tx.vout[j].scriptPubKey.hex()\n+            value = Decimal(parent_tx.vout[j].nValue) / COIN\n+            txid = parent_tx.rehash()\n+            prevtxs = [{\n+                \"txid\": txid,\n+                \"vout\": j,\n+                \"scriptPubKey\": spk,\n+                \"amount\": value,\n+            }]\n+            if j == 0: # normal key\n+                (tx_small, _, _, _) = make_chain(node, self.address, self.privkeys, txid, value, j, spk, high_fee)\n+                mempool_tx = bulk_transaction(tx_small, node, target_weight, self.privkeys, prevtxs)\n+            else: # OP_TRUE\n+                inputs = [{\"txid\": txid, \"vout\": 1}]\n+                outputs = {self.address: value - high_fee}\n+                small_tx = tx_from_hex(node.createrawtransaction(inputs, outputs))",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r685158927",
      "id" : 685158927,
      "line" : 446,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NTE1ODkyNw==",
      "original_commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "original_line" : 446,
      "original_position" : 446,
      "original_start_line" : null,
      "path" : "test/functional/mempool_package_limits.py",
      "position" : 446,
      "pull_request_review_id" : 725180293,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-09T12:47:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/685158927",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1063656?v=4",
         "events_url" : "https://api.github.com/users/jnewbery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jnewbery/followers",
         "following_url" : "https://api.github.com/users/jnewbery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jnewbery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jnewbery",
         "id" : 1063656,
         "login" : "jnewbery",
         "node_id" : "MDQ6VXNlcjEwNjM2NTY=",
         "organizations_url" : "https://api.github.com/users/jnewbery/orgs",
         "received_events_url" : "https://api.github.com/users/jnewbery/received_events",
         "repos_url" : "https://api.github.com/users/jnewbery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jnewbery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jnewbery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I've left a bunch of small comments. None are critical, so feel free to ignore or take them in a follow-up PR.\r\n\r\nI think there's enough here to warrant a followup.",
      "created_at" : "2021-08-11T02:47:55Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#issuecomment-896457688",
      "id" : 896457688,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/21800",
      "node_id" : "IC_kwDOABII5841btvY",
      "performed_via_github_app" : null,
      "updated_at" : "2021-08-11T02:47:55Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/896457688",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r686704354"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686704354"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I definitely agree, it's a shame to turn off standardness in a policy-based tests. Will try to do this in a followup.",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-11T10:30:28Z",
      "diff_hunk" : "@@ -0,0 +1,475 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test logic for limiting mempool and package ancestors/descendants.\"\"\"\n+\n+from decimal import Decimal\n+\n+from test_framework.address import ADDRESS_BCRT1_P2WSH_OP_TRUE\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.messages import (\n+    COIN,\n+    CTransaction,\n+    CTxInWitness,\n+    tx_from_hex,\n+    WITNESS_SCALE_FACTOR,\n+)\n+from test_framework.script import (\n+    CScript,\n+    OP_TRUE,\n+)\n+from test_framework.util import (\n+    assert_equal,\n+)\n+from test_framework.wallet import (\n+    bulk_transaction,\n+    create_child_with_parents,\n+    make_chain,\n+)\n+\n+class MempoolPackageLimitsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.setup_clean_chain = True\n+\n+    def run_test(self):\n+        self.log.info(\"Generate blocks to create UTXOs\")\n+        node = self.nodes[0]\n+        self.privkeys = [node.get_deterministic_priv_key().key]\n+        self.address = node.get_deterministic_priv_key().address\n+        self.coins = []\n+        # The last 100 coinbase transactions are premature\n+        for b in node.generatetoaddress(200, self.address)[:100]:\n+            coinbase = node.getblock(blockhash=b, verbosity=2)[\"tx\"][0]\n+            self.coins.append({\n+                \"txid\": coinbase[\"txid\"],\n+                \"amount\": coinbase[\"vout\"][0][\"value\"],\n+                \"scriptPubKey\": coinbase[\"vout\"][0][\"scriptPubKey\"],\n+            })\n+\n+        self.test_chain_limits()\n+        self.test_desc_count_limits()\n+        self.test_anc_count_limits()\n+        self.test_anc_count_limits_2()\n+        self.test_anc_count_limits_bushy()\n+\n+        # The node will accept our (nonstandard) extra large OP_RETURN outputs\n+        self.restart_node(0, extra_args=[\"-acceptnonstdtxn=1\"])",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r686704354",
      "id" : 686704354,
      "in_reply_to_id" : 685140674,
      "line" : 58,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY4NjcwNDM1NA==",
      "original_commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "original_line" : 58,
      "original_position" : 58,
      "original_start_line" : null,
      "path" : "test/functional/mempool_package_limits.py",
      "position" : 58,
      "pull_request_review_id" : 727317944,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-11T10:30:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/686704354",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/glozow/events{/privacy}",
         "followers_url" : "https://api.github.com/users/glozow/followers",
         "following_url" : "https://api.github.com/users/glozow/following{/other_user}",
         "gists_url" : "https://api.github.com/users/glozow/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/glozow",
         "id" : 25183001,
         "login" : "glozow",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/glozow/orgs",
         "received_events_url" : "https://api.github.com/users/glozow/received_events",
         "repos_url" : "https://api.github.com/users/glozow/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/glozow/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/glozow/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/glozow"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r691598949"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/691598949"
         }
      },
      "author_association" : "NONE",
      "body" : "Users of named tuples are not forced to access them by name, because they are also tuples as the name suggests:\r\n\r\n```\r\n>>> A = namedtuple('A', ['x','y'])\r\n>>> A(1,2)\r\nA(x=1, y=2)\r\n>>> y, x = A(1,2)\r\n>>> x, y\r\n(2, 1)\r\n```\r\n\r\nDataclasses seem closer to what you want:\r\n\r\n```\r\n>>> from dataclasses import dataclass\r\n>>> @dataclass\r\n... class A:\r\n...     x: int\r\n...     y: int\r\n... \r\n>>> A(1,2)\r\nA(x=1, y=2)\r\n>>> x,y = A(1,2)\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\nTypeError: cannot unpack non-iterable A object\r\n```",
      "commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "created_at" : "2021-08-18T20:59:08Z",
      "diff_hunk" : "@@ -176,3 +181,75 @@ def create_self_transfer(self, *, fee_rate=Decimal(\"0.003\"), from_node, utxo_to_\n     def sendrawtransaction(self, *, from_node, tx_hex):\n         from_node.sendrawtransaction(tx_hex)\n         self.scan_tx(from_node.decoderawtransaction(tx_hex))\n+\n+def make_chain(node, address, privkeys, parent_txid, parent_value, n=0, parent_locking_script=None, fee=DEFAULT_FEE):\n+    \"\"\"Build a transaction that spends parent_txid.vout[n] and produces one output with\n+    amount = parent_value with a fee deducted.\n+    Return tuple (CTransaction object, raw hex, nValue, scriptPubKey of the output created).\n+    \"\"\"\n+    inputs = [{\"txid\": parent_txid, \"vout\": n}]\n+    my_value = parent_value - fee\n+    outputs = {address : my_value}\n+    rawtx = node.createrawtransaction(inputs, outputs)\n+    prevtxs = [{\n+        \"txid\": parent_txid,\n+        \"vout\": n,\n+        \"scriptPubKey\": parent_locking_script,\n+        \"amount\": parent_value,\n+    }] if parent_locking_script else None\n+    signedtx = node.signrawtransactionwithkey(hexstring=rawtx, privkeys=privkeys, prevtxs=prevtxs)\n+    assert signedtx[\"complete\"]\n+    tx = tx_from_hex(signedtx[\"hex\"])\n+    return (tx, signedtx[\"hex\"], my_value, tx.vout[0].scriptPubKey.hex())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/21800#discussion_r691598949",
      "id" : 691598949,
      "in_reply_to_id" : 685061119,
      "line" : 203,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY5MTU5ODk0OQ==",
      "original_commit_id" : "accf3d5868460b4b14ab607fd66ac985b086fbb3",
      "original_line" : 203,
      "original_position" : 54,
      "original_start_line" : null,
      "path" : "test/functional/test_framework/wallet.py",
      "position" : 54,
      "pull_request_review_id" : 733345949,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/21800",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2021-08-18T20:59:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/691598949",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/284023?v=4",
         "events_url" : "https://api.github.com/users/ysangkok/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ysangkok/followers",
         "following_url" : "https://api.github.com/users/ysangkok/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ysangkok/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ysangkok",
         "id" : 284023,
         "login" : "ysangkok",
         "node_id" : "MDQ6VXNlcjI4NDAyMw==",
         "organizations_url" : "https://api.github.com/users/ysangkok/orgs",
         "received_events_url" : "https://api.github.com/users/ysangkok/received_events",
         "repos_url" : "https://api.github.com/users/ysangkok/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ysangkok/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ysangkok/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ysangkok"
      }
   }
]
