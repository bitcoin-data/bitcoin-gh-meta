[
   {
      "author_association" : "MEMBER",
      "body" : "This seems like a very roundabout way of fixing that bug. Can't you just break the inner loop whenever the requested height is exceeded?",
      "created_at" : "2018-06-18T00:53:15Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13490#issuecomment-397918523",
      "id" : 397918523,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13490",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDM5NzkxODUyMw==",
      "updated_at" : "2018-06-18T00:53:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/397918523",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "NONE",
      "body" : "@sipa Thanks for pointing that out. Fixed and tested.\r\n\r\nAlso, would it be worth it to implement a \"rewind\" functionality so the block can be rewinded to the desired height, like my original commit did?",
      "created_at" : "2018-06-18T01:42:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13490#issuecomment-397922595",
      "id" : 397922595,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13490",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDM5NzkyMjU5NQ==",
      "updated_at" : "2018-06-18T01:42:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/397922595",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5808517?v=4",
         "events_url" : "https://api.github.com/users/qmma70/events{/privacy}",
         "followers_url" : "https://api.github.com/users/qmma70/followers",
         "following_url" : "https://api.github.com/users/qmma70/following{/other_user}",
         "gists_url" : "https://api.github.com/users/qmma70/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/qmma70",
         "id" : 5808517,
         "login" : "qmma70",
         "node_id" : "MDQ6VXNlcjU4MDg1MTc=",
         "organizations_url" : "https://api.github.com/users/qmma70/orgs",
         "received_events_url" : "https://api.github.com/users/qmma70/received_events",
         "repos_url" : "https://api.github.com/users/qmma70/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/qmma70/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/qmma70/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/qmma70"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@qmma70 You can use the `invalidateblock` RPC for that.",
      "created_at" : "2018-06-18T01:45:39Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13490#issuecomment-397922859",
      "id" : 397922859,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13490",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDM5NzkyMjg1OQ==",
      "updated_at" : "2018-06-18T01:45:39Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/397922859",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/548488?v=4",
         "events_url" : "https://api.github.com/users/sipa/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipa/followers",
         "following_url" : "https://api.github.com/users/sipa/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipa/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipa",
         "id" : 548488,
         "login" : "sipa",
         "node_id" : "MDQ6VXNlcjU0ODQ4OA==",
         "organizations_url" : "https://api.github.com/users/sipa/orgs",
         "received_events_url" : "https://api.github.com/users/sipa/received_events",
         "repos_url" : "https://api.github.com/users/sipa/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipa/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipa/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipa"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "I'll start by saying that I don't really like the way `-stopatheight` works in the first place -- it's a useful feature but I don't like that we clutter up consensus code with it.\r\n\r\nThe issue reported in #13477 arises because when ABC invokes `StartShutdown()`, it can take a while before bitcoind exits, and in the meantime `ProcessNewBlock()` can continue to fire, resulting in one more block at a time being connected in ABC (since before this patch ABC only checks for the stopheight after connecting a block).  However, there is no guarantee that this code would work, because it is possible that ABCStep() could connect multiple blocks, taking us past the stop-height.\r\n\r\nIn practice, this is not currently an issue during IBD, because ABCStep will just connect one block at a time except in the case of a reorg.  But we only do this to avoid holding cs_main too long; however it's possible we could change this behavior in the future and therefore break the `-stopatheight` behavior again.\r\n\r\nSo the most correct fix, I think, would involve embedding this into ABCStep... But I like spreading out the knowledge of this feature in multiple consensus functions even less than I like the potential bug with this...  So I'd propose that we instead just (a) return at the top of ~ABCStep~ ABC() if our tip is at or past our stop-height (so not inside the inner loop at all), and (b) also add a comment explaining that this is not-guaranteed behavior, because ABCStep is allowed to take us past our stop height, even if it's unlikely.  That would help mitigate developer confusion at least at wondering how this code could be correct (since it technically isn't).",
      "created_at" : "2018-06-18T14:16:21Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/13490#issuecomment-398069237",
      "id" : 398069237,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/13490",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDM5ODA2OTIzNw==",
      "updated_at" : "2018-06-18T15:12:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/398069237",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/7463573?v=4",
         "events_url" : "https://api.github.com/users/sdaftuar/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sdaftuar/followers",
         "following_url" : "https://api.github.com/users/sdaftuar/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sdaftuar/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sdaftuar",
         "id" : 7463573,
         "login" : "sdaftuar",
         "node_id" : "MDQ6VXNlcjc0NjM1NzM=",
         "organizations_url" : "https://api.github.com/users/sdaftuar/orgs",
         "received_events_url" : "https://api.github.com/users/sdaftuar/received_events",
         "repos_url" : "https://api.github.com/users/sdaftuar/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sdaftuar/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sdaftuar"
      }
   }
]
