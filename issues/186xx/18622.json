{
   "assignee" : null,
   "assignees" : [],
   "author_association" : "NONE",
   "body" : "<!-- Describe the issue -->\r\n\r\nI was building Bitcoin Core on my Windows machine, on WSL/Ubuntu. I tried to run the tests and ran into a problem. The test in `test/functional/wallet_multiwallet.py` failed. Follows the output of the test: \r\n\r\n```\r\nmtrycz@LAPTOP-00AACAV2:~/git/bitcoin/test/functional$ ./test_runner.py wallet_multiwallet.py\r\nTemporary test directory at /tmp/test_runner_â¿_ð_20200413_152720\r\nRemaining jobs: [wallet_multiwallet.py]\r\n1/1 - wallet_multiwallet.py failed, Duration: 9 s\r\n\r\nstdout:\r\n2020-04-13T13:27:20.407000Z TestFramework (INFO): Initializing test directory /tmp/test_runner_â¿_ð_20200413_152720/wallet_multiwallet_0\r\n2020-04-13T13:27:24.947000Z TestFramework (INFO): Do not allow -zapwallettxes with multiwallet\r\n2020-04-13T13:27:25.745000Z TestFramework (INFO): Do not allow -salvagewallet with multiwallet\r\n2020-04-13T13:27:26.278000Z TestFramework (INFO): Do not allow -upgradewallet with multiwallet\r\n2020-04-13T13:27:29.060000Z TestFramework (ERROR): Assertion failed\r\nTraceback (most recent call last):\r\n  File \"/home/mtrycz/git/bitcoin/test/functional/test_framework/test_framework.py\", line 112, in main\r\n    self.run_test()\r\n  File \"/home/mtrycz/git/bitcoin/test/functional/wallet_multiwallet.py\", line 152, in run_test\r\n    self.nodes[1].assert_start_raises_init_error(['-walletdir=' + competing_wallet_dir], exp_stderr, match=ErrorMatch.PARTIAL_REGEX)\r\n  File \"/home/mtrycz/git/bitcoin/test/functional/test_framework/test_node.py\", line 460, in assert_start_raises_init_error\r\n    self._raise_assertion_error(assert_msg)\r\n  File \"/home/mtrycz/git/bitcoin/test/functional/test_framework/test_node.py\", line 157, in _raise_assertion_error\r\n    raise AssertionError(self._node_msg(msg))\r\nAssertionError: [node 1] bitcoind should have exited with expected error Error: Error initializing wallet database environment \\\"\\S+competing_walletdir\\\"!\r\n2020-04-13T13:27:29.113000Z TestFramework (INFO): Stopping nodes\r\n2020-04-13T13:27:29.215000Z TestFramework (WARNING): Not cleaning up dir /tmp/test_runner_â¿_ð_20200413_152720/wallet_multiwallet_0\r\n2020-04-13T13:27:29.215000Z TestFramework (ERROR): Test failed. Test logging available at /tmp/test_runner_â¿_ð_20200413_152720/wallet_multiwallet_0/test_framework.log\r\n2020-04-13T13:27:29.215000Z TestFramework (ERROR): Hint: Call /home/mtrycz/git/bitcoin/test/functional/combine_logs.py '/tmp/test_runner_â¿_ð_20200413_152720/wallet_multiwallet_0' to consolidate all logs\r\n\r\n\r\nstderr:\r\n\r\n\r\n\r\nTEST                  | STATUS    | DURATION\r\n\r\nwallet_multiwallet.py | â Failed  | 9 s\r\n\r\nALL                   | â Failed  | 9 s (accumulated)\r\nRuntime: 9 s\r\n```\r\n\r\nI traced the cause to a node being able to open a wallet that is already open by another node. \r\n\r\nTo the best of my understanding mutliple bitcoind instances shouldn't be able to point to the same datadirs or walletdirs. On Windows it is possible to have multiple bitcoind instances to point to the same walletdir, leading to possible data corruption. To the best of my understanding this is not possible on Linux (can't confirm atm).\r\n\r\n<!--- What was the actual behavior (provide screenshots if the issue is GUI-related)? -->\r\n\r\nManual test plan:\r\n1. Download the latest Windows release binaries (version v.0.19.1)\r\n1. Create two directories, for example `C:\\node0` and `C:\\node1`; create a `bitcoin.conf` file in `C:\\node1` with a single line `rpcport=8333` (otherwise the second node will fail for an unrelated reason)\r\n1. Open a command prompt and run `bitcoind.exe -datadir=C:\\node0 -walletdir=D:\\bchwallettest`\r\n2. Open a second prompt and run `bitcoind.exe -datadir=C:\\node1 -walletdir=D:\\bchwallettest`\r\n3. Expect the second node to fail at startup\r\n\r\nI've run this test myself and can confirm that the second node erroneously starts. The bug was reproduced on Windows 10 Pro, both in cmd and in WSL shell, with the latest release v.0.19.1.\r\n\r\n",
   "closed_at" : "2020-05-28T15:55:33Z",
   "closed_by" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
      "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
      "followers_url" : "https://api.github.com/users/laanwj/followers",
      "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/laanwj",
      "id" : 126646,
      "login" : "laanwj",
      "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
      "organizations_url" : "https://api.github.com/users/laanwj/orgs",
      "received_events_url" : "https://api.github.com/users/laanwj/received_events",
      "repos_url" : "https://api.github.com/users/laanwj/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/laanwj"
   },
   "comments" : 4,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18622/comments",
   "created_at" : "2020-04-13T13:28:11Z",
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18622/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/issues/18622",
   "id" : 598889036,
   "labels" : [
      {
         "color" : "FBBAAB",
         "default" : false,
         "description" : null,
         "id" : 64585,
         "name" : "Bug",
         "node_id" : "MDU6TGFiZWw2NDU4NQ==",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Bug"
      },
      {
         "color" : "bfd4f2",
         "default" : false,
         "description" : null,
         "id" : 159815356,
         "name" : "Upstream",
         "node_id" : "MDU6TGFiZWwxNTk4MTUzNTY=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Upstream"
      },
      {
         "color" : "884400",
         "default" : false,
         "description" : null,
         "id" : 234877,
         "name" : "Windows",
         "node_id" : "MDU6TGFiZWwyMzQ4Nzc=",
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/labels/Windows"
      }
   ],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18622/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "MDU6SXNzdWU1OTg4ODkwMzY=",
   "number" : 18622,
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "closed",
   "title" : "Multiple bitcoind instances can point to the same -walletdir on Windows",
   "updated_at" : "2020-05-28T15:55:33Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18622",
   "user" : {
      "avatar_url" : "https://avatars0.githubusercontent.com/u/6586406?v=4",
      "events_url" : "https://api.github.com/users/mtrycz/events{/privacy}",
      "followers_url" : "https://api.github.com/users/mtrycz/followers",
      "following_url" : "https://api.github.com/users/mtrycz/following{/other_user}",
      "gists_url" : "https://api.github.com/users/mtrycz/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/mtrycz",
      "id" : 6586406,
      "login" : "mtrycz",
      "node_id" : "MDQ6VXNlcjY1ODY0MDY=",
      "organizations_url" : "https://api.github.com/users/mtrycz/orgs",
      "received_events_url" : "https://api.github.com/users/mtrycz/received_events",
      "repos_url" : "https://api.github.com/users/mtrycz/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/mtrycz/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/mtrycz/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/mtrycz"
   }
}
