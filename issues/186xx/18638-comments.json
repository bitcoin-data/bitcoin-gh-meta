[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19472 ([net processing] Reduce cs_main scope in MaybeDiscourageAndDisconnect() by jnewbery)\n* #19107 (p2p: Move all header verification into the network layer, extend logging by troygiorshev)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.<!--2502f1a698b3751726fa55edcda76cd3-->\n\n### Coverage\n\n| Coverage  | Change ([pull 18638](https://drahtbot.github.io/reports/coverage/bitcoin/bitcoin/18638/total.coverage/index.html), 0f96c4b9c8eed32c3fdf1203a2f9a2be59a5f4a2) | Reference ([master](https://drahtbot.github.io/reports/coverage/bitcoin/bitcoin/master/total.coverage/index.html), 75fcfdaf8b4b68ef1d1fcd606fb36c9265e15918)   |\n|-----------|-------------------------|--------------------|\n| Lines     | +0.0020 %            | 90.3582 %        |\n| Functions | +0.1431 %            | 85.0787 %        |\n| Branches  | +0.0089 %            | 51.8202 %        |\n\n<sup>Updated at: 2020-04-15T00:09:25.322904.</sup>\n",
      "created_at" : "2020-04-14T20:24:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#issuecomment-613662430",
      "id" : 613662430,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18638",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxMzY2MjQzMA==",
      "updated_at" : "2020-07-10T07:47:53Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/613662430",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Coverage changes:\r\n\r\n* https://drahtbot.github.io/reports/coverage/bitcoin/bitcoin/master/total.coverage/src/net.cpp.gcov.html#1123\r\n* https://drahtbot.github.io/reports/coverage/bitcoin/bitcoin/18638/total.coverage/src/net.cpp.gcov.html#1123\r\n\r\nand\r\n\r\n* https://drahtbot.github.io/reports/coverage/bitcoin/bitcoin/master/total.coverage/src/net_processing.cpp.gcov.html#3095\r\n* https://drahtbot.github.io/reports/coverage/bitcoin/bitcoin/18638/total.coverage/src/net_processing.cpp.gcov.html#3095",
      "created_at" : "2020-04-15T00:50:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#issuecomment-613753413",
      "id" : 613753413,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18638",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxMzc1MzQxMw==",
      "updated_at" : "2020-04-15T00:50:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/613753413",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-04-24T22:34:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#issuecomment-619266542",
      "id" : 619266542,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18638",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxOTI2NjU0Mg==",
      "updated_at" : "2020-04-24T22:34:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/619266542",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased",
      "created_at" : "2020-04-25T12:44:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#issuecomment-619374262",
      "id" : 619374262,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18638",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxOTM3NDI2Mg==",
      "updated_at" : "2020-04-25T12:44:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/619374262",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK.\r\n\r\nWon't this potentially cause issues (e.g. ping timeouts) in P2P tests that already use mockable time for other things, but are not expecting it to have an effect on pings?\r\n\r\n(seems not, given that all the tests still pass)\r\n",
      "created_at" : "2020-05-04T13:22:12Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#issuecomment-623460571",
      "id" : 623460571,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18638",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMzQ2MDU3MQ==",
      "updated_at" : "2020-05-04T13:22:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/623460571",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/126646?v=4",
         "events_url" : "https://api.github.com/users/laanwj/events{/privacy}",
         "followers_url" : "https://api.github.com/users/laanwj/followers",
         "following_url" : "https://api.github.com/users/laanwj/following{/other_user}",
         "gists_url" : "https://api.github.com/users/laanwj/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/laanwj",
         "id" : 126646,
         "login" : "laanwj",
         "node_id" : "MDQ6VXNlcjEyNjY0Ng==",
         "organizations_url" : "https://api.github.com/users/laanwj/orgs",
         "received_events_url" : "https://api.github.com/users/laanwj/received_events",
         "repos_url" : "https://api.github.com/users/laanwj/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/laanwj/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/laanwj"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "The `-peertimeout` is still measured in wall clock time, and because most of the test run through faster than what the `-peertimeout` is, this should not lead to issues in general. There are two tests `test/functional/feature_maxuploadtarget.py` and `test/functional/feature_bip68_sequence.py` which mine a lot of blocks (more than 100) under mocktime. This can take time when the tests are run under valgrind, so I had to bump the `-peertimeout` for those tests.\r\n\r\nOther tests should not be affected. If they are, it should be trivial to fix them up.",
      "created_at" : "2020-05-04T13:42:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#issuecomment-623471752",
      "id" : 623471752,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18638",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMzQ3MTc1Mg==",
      "updated_at" : "2020-05-04T13:43:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/623471752",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK: mockable is better than non-mockable :)",
      "created_at" : "2020-05-04T14:03:04Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#issuecomment-623483202",
      "id" : 623483202,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18638",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMzQ4MzIwMg==",
      "updated_at" : "2020-05-04T14:03:04Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/623483202",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased",
      "created_at" : "2020-05-12T22:16:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#issuecomment-627627968",
      "id" : 627627968,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18638",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyNzYyNzk2OA==",
      "updated_at" : "2020-05-12T22:16:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/627627968",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r426916085"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426916085"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "From what I understand, `minping` is the best/shortest round trip time measured so far. Thus, would it be a good idea to repeat this chunk with a shorter `ping_delay` in order to check that `minping` gets updated correctly? I tried with `ping_delay` = 25 locally and it was updated from 29 to 25 as expected.",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-05-18T22:00:18Z",
      "diff_hunk" : "@@ -0,0 +1,113 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test ping message\n+\"\"\"\n+\n+import time\n+\n+from test_framework.messages import (\n+    msg_pong,\n+)\n+from test_framework.mininode import (\n+    P2PInterface,\n+    wait_until,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+PING_INTERVAL = 2 * 60\n+\n+\n+class msg_pong_corrupt(msg_pong):\n+    def serialize(self):\n+        return b\"\"\n+\n+\n+class NodePongAdd1(P2PInterface):\n+    def on_ping(self, message):\n+        self.send_message(msg_pong(message.nonce + 1))\n+\n+\n+class NodeNoPong(P2PInterface):\n+    def on_ping(self, message):\n+        pass\n+\n+\n+class PingPongTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+        self.extra_args = [['-peertimeout=3']]\n+\n+    def check_peer_info(self, *, pingtime, minping, pingwait):\n+        stats = self.nodes[0].getpeerinfo()[0]\n+        assert_equal(stats.pop('pingtime', None), pingtime)\n+        assert_equal(stats.pop('minping', None), minping)\n+        assert_equal(stats.pop('pingwait', None), pingwait)\n+\n+    def mock_forward(self, delta):\n+        self.mock_time += delta\n+        self.nodes[0].setmocktime(self.mock_time)\n+\n+    def run_test(self):\n+        self.mock_time = int(time.time())\n+        self.mock_forward(0)\n+\n+        self.log.info('Check that ping is sent after connection is established')\n+        no_pong_node = self.nodes[0].add_p2p_connection(NodeNoPong())\n+        self.mock_forward(3)\n+        assert no_pong_node.last_message.pop('ping').nonce != 0\n+        self.check_peer_info(pingtime=None, minping=None, pingwait=3)\n+\n+        self.log.info('Reply without nonce cancels ping')\n+        with self.nodes[0].assert_debug_log(['pong peer=0: Short payload']):\n+            no_pong_node.send_and_ping(msg_pong_corrupt())\n+        self.check_peer_info(pingtime=None, minping=None, pingwait=None)\n+\n+        self.log.info('Reply without ping')\n+        with self.nodes[0].assert_debug_log([\n+                'pong peer=0: Unsolicited pong without ping, 0 expected, 0 received, 8 bytes',\n+        ]):\n+            no_pong_node.send_and_ping(msg_pong())\n+        self.check_peer_info(pingtime=None, minping=None, pingwait=None)\n+\n+        self.log.info('Reply with wrong nonce does not cancel ping')\n+        assert 'ping' not in no_pong_node.last_message\n+        with self.nodes[0].assert_debug_log(['pong peer=0: Nonce mismatch']):\n+            # mock time PING_INTERVAL ahead to trigger node into sending a ping\n+            self.mock_forward(PING_INTERVAL + 1)\n+            wait_until(lambda: 'ping' in no_pong_node.last_message)\n+            self.mock_forward(9)\n+            # Send the wrong pong\n+            no_pong_node.send_and_ping(msg_pong(no_pong_node.last_message.pop('ping').nonce - 1))\n+        self.check_peer_info(pingtime=None, minping=None, pingwait=9)\n+\n+        self.log.info('Reply with zero nonce does cancel ping')\n+        with self.nodes[0].assert_debug_log(['pong peer=0: Nonce zero']):\n+            no_pong_node.send_and_ping(msg_pong(0))\n+        self.check_peer_info(pingtime=None, minping=None, pingwait=None)\n+\n+        self.log.info('Check that ping is properly reported on RPC')\n+        assert 'ping' not in no_pong_node.last_message\n+        # mock time PING_INTERVAL ahead to trigger node into sending a ping\n+        self.mock_forward(PING_INTERVAL + 1)\n+        wait_until(lambda: 'ping' in no_pong_node.last_message)\n+        ping_delay = 29\n+        self.mock_forward(ping_delay)\n+        wait_until(lambda: 'ping' in no_pong_node.last_message)\n+        no_pong_node.send_and_ping(msg_pong(no_pong_node.last_message.pop('ping').nonce))\n+        self.check_peer_info(pingtime=ping_delay, minping=ping_delay, pingwait=None)\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r426916085",
      "id" : 426916085,
      "line" : 102,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxNjA4NQ==",
      "original_commit_id" : "fac63aba8db1d0198391414a3867894f837e9df3",
      "original_line" : 102,
      "original_position" : 102,
      "original_start_line" : null,
      "path" : "test/functional/p2p_ping.py",
      "position" : 102,
      "pull_request_review_id" : 413967888,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-19T11:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426916085",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/gzhao408/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gzhao408/followers",
         "following_url" : "https://api.github.com/users/gzhao408/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gzhao408/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gzhao408",
         "id" : 25183001,
         "login" : "gzhao408",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/gzhao408/orgs",
         "received_events_url" : "https://api.github.com/users/gzhao408/received_events",
         "repos_url" : "https://api.github.com/users/gzhao408/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gzhao408/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gzhao408/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gzhao408"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r426917683"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426917683"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Also I'm just wondering, why is `ping_delay` 29? I'm not sure if it's arbitrary or a chosen magic number.",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-05-18T22:04:44Z",
      "diff_hunk" : "@@ -0,0 +1,113 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test ping message\n+\"\"\"\n+\n+import time\n+\n+from test_framework.messages import (\n+    msg_pong,\n+)\n+from test_framework.mininode import (\n+    P2PInterface,\n+    wait_until,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+PING_INTERVAL = 2 * 60\n+\n+\n+class msg_pong_corrupt(msg_pong):\n+    def serialize(self):\n+        return b\"\"\n+\n+\n+class NodePongAdd1(P2PInterface):\n+    def on_ping(self, message):\n+        self.send_message(msg_pong(message.nonce + 1))\n+\n+\n+class NodeNoPong(P2PInterface):\n+    def on_ping(self, message):\n+        pass\n+\n+\n+class PingPongTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+        self.extra_args = [['-peertimeout=3']]\n+\n+    def check_peer_info(self, *, pingtime, minping, pingwait):\n+        stats = self.nodes[0].getpeerinfo()[0]\n+        assert_equal(stats.pop('pingtime', None), pingtime)\n+        assert_equal(stats.pop('minping', None), minping)\n+        assert_equal(stats.pop('pingwait', None), pingwait)\n+\n+    def mock_forward(self, delta):\n+        self.mock_time += delta\n+        self.nodes[0].setmocktime(self.mock_time)\n+\n+    def run_test(self):\n+        self.mock_time = int(time.time())\n+        self.mock_forward(0)\n+\n+        self.log.info('Check that ping is sent after connection is established')\n+        no_pong_node = self.nodes[0].add_p2p_connection(NodeNoPong())\n+        self.mock_forward(3)\n+        assert no_pong_node.last_message.pop('ping').nonce != 0\n+        self.check_peer_info(pingtime=None, minping=None, pingwait=3)\n+\n+        self.log.info('Reply without nonce cancels ping')\n+        with self.nodes[0].assert_debug_log(['pong peer=0: Short payload']):\n+            no_pong_node.send_and_ping(msg_pong_corrupt())\n+        self.check_peer_info(pingtime=None, minping=None, pingwait=None)\n+\n+        self.log.info('Reply without ping')\n+        with self.nodes[0].assert_debug_log([\n+                'pong peer=0: Unsolicited pong without ping, 0 expected, 0 received, 8 bytes',\n+        ]):\n+            no_pong_node.send_and_ping(msg_pong())\n+        self.check_peer_info(pingtime=None, minping=None, pingwait=None)\n+\n+        self.log.info('Reply with wrong nonce does not cancel ping')\n+        assert 'ping' not in no_pong_node.last_message\n+        with self.nodes[0].assert_debug_log(['pong peer=0: Nonce mismatch']):\n+            # mock time PING_INTERVAL ahead to trigger node into sending a ping\n+            self.mock_forward(PING_INTERVAL + 1)\n+            wait_until(lambda: 'ping' in no_pong_node.last_message)\n+            self.mock_forward(9)\n+            # Send the wrong pong\n+            no_pong_node.send_and_ping(msg_pong(no_pong_node.last_message.pop('ping').nonce - 1))\n+        self.check_peer_info(pingtime=None, minping=None, pingwait=9)\n+\n+        self.log.info('Reply with zero nonce does cancel ping')\n+        with self.nodes[0].assert_debug_log(['pong peer=0: Nonce zero']):\n+            no_pong_node.send_and_ping(msg_pong(0))\n+        self.check_peer_info(pingtime=None, minping=None, pingwait=None)\n+\n+        self.log.info('Check that ping is properly reported on RPC')\n+        assert 'ping' not in no_pong_node.last_message\n+        # mock time PING_INTERVAL ahead to trigger node into sending a ping\n+        self.mock_forward(PING_INTERVAL + 1)\n+        wait_until(lambda: 'ping' in no_pong_node.last_message)\n+        ping_delay = 29\n+        self.mock_forward(ping_delay)\n+        wait_until(lambda: 'ping' in no_pong_node.last_message)\n+        no_pong_node.send_and_ping(msg_pong(no_pong_node.last_message.pop('ping').nonce))\n+        self.check_peer_info(pingtime=ping_delay, minping=ping_delay, pingwait=None)\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r426917683",
      "id" : 426917683,
      "in_reply_to_id" : 426916085,
      "line" : 102,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkxNzY4Mw==",
      "original_commit_id" : "fac63aba8db1d0198391414a3867894f837e9df3",
      "original_line" : 102,
      "original_position" : 102,
      "original_start_line" : null,
      "path" : "test/functional/p2p_ping.py",
      "position" : 102,
      "pull_request_review_id" : 413967888,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-19T11:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426917683",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/gzhao408/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gzhao408/followers",
         "following_url" : "https://api.github.com/users/gzhao408/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gzhao408/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gzhao408",
         "id" : 25183001,
         "login" : "gzhao408",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/gzhao408/orgs",
         "received_events_url" : "https://api.github.com/users/gzhao408/received_events",
         "repos_url" : "https://api.github.com/users/gzhao408/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gzhao408/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gzhao408/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gzhao408"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r426923791"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426923791"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Hm, I'm surprised it isn't `Nonce zero`? I thought no nonce is equivalent to nonce=0 for [msg_pong](https://github.com/bitcoin/bitcoin/blob/dc5333d31f280e09bb1e8cdacfbe842f4ab9e69b/test/functional/test_framework/messages.py#L1210). The test failed when I changed the error message, though.",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-05-18T22:20:56Z",
      "diff_hunk" : "@@ -0,0 +1,113 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test ping message\n+\"\"\"\n+\n+import time\n+\n+from test_framework.messages import (\n+    msg_pong,\n+)\n+from test_framework.mininode import (\n+    P2PInterface,\n+    wait_until,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+PING_INTERVAL = 2 * 60\n+\n+\n+class msg_pong_corrupt(msg_pong):\n+    def serialize(self):\n+        return b\"\"\n+\n+\n+class NodePongAdd1(P2PInterface):\n+    def on_ping(self, message):\n+        self.send_message(msg_pong(message.nonce + 1))\n+\n+\n+class NodeNoPong(P2PInterface):\n+    def on_ping(self, message):\n+        pass\n+\n+\n+class PingPongTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+        self.extra_args = [['-peertimeout=3']]\n+\n+    def check_peer_info(self, *, pingtime, minping, pingwait):\n+        stats = self.nodes[0].getpeerinfo()[0]\n+        assert_equal(stats.pop('pingtime', None), pingtime)\n+        assert_equal(stats.pop('minping', None), minping)\n+        assert_equal(stats.pop('pingwait', None), pingwait)\n+\n+    def mock_forward(self, delta):\n+        self.mock_time += delta\n+        self.nodes[0].setmocktime(self.mock_time)\n+\n+    def run_test(self):\n+        self.mock_time = int(time.time())\n+        self.mock_forward(0)\n+\n+        self.log.info('Check that ping is sent after connection is established')\n+        no_pong_node = self.nodes[0].add_p2p_connection(NodeNoPong())\n+        self.mock_forward(3)\n+        assert no_pong_node.last_message.pop('ping').nonce != 0\n+        self.check_peer_info(pingtime=None, minping=None, pingwait=3)\n+\n+        self.log.info('Reply without nonce cancels ping')\n+        with self.nodes[0].assert_debug_log(['pong peer=0: Short payload']):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r426923791",
      "id" : 426923791,
      "line" : 65,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkyMzc5MQ==",
      "original_commit_id" : "fac63aba8db1d0198391414a3867894f837e9df3",
      "original_line" : 65,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "test/functional/p2p_ping.py",
      "position" : 65,
      "pull_request_review_id" : 413967888,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-19T11:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426923791",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/gzhao408/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gzhao408/followers",
         "following_url" : "https://api.github.com/users/gzhao408/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gzhao408/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gzhao408",
         "id" : 25183001,
         "login" : "gzhao408",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/gzhao408/orgs",
         "received_events_url" : "https://api.github.com/users/gzhao408/received_events",
         "repos_url" : "https://api.github.com/users/gzhao408/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gzhao408/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gzhao408/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gzhao408"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r426929454"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426929454"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I think microseconds is correct (I think millis would be a bug if this wasn't in a unit test), but since it looks like you're switching from millis to micros, could this be an issue at all? The test passes for me.",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-05-18T22:37:32Z",
      "diff_hunk" : "@@ -74,7 +74,7 @@ void test_one_input(const std::vector<uint8_t>& buffer)\n     p2p_node.SetSendVersion(PROTOCOL_VERSION);\n     g_setup->m_node.peer_logic->InitializeNode(&p2p_node);\n     try {\n-        (void)ProcessMessage(&p2p_node, random_message_type, random_bytes_data_stream, GetTimeMillis(), Params(), *g_setup->m_node.mempool, g_setup->m_node.connman.get(), g_setup->m_node.banman.get(), std::atomic<bool>{false});",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r426929454",
      "id" : 426929454,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkyOTQ1NA==",
      "original_commit_id" : "fac63aba8db1d0198391414a3867894f837e9df3",
      "original_line" : 77,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/test/fuzz/process_message.cpp",
      "position" : null,
      "pull_request_review_id" : 413967888,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-19T11:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426929454",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/gzhao408/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gzhao408/followers",
         "following_url" : "https://api.github.com/users/gzhao408/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gzhao408/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gzhao408",
         "id" : 25183001,
         "login" : "gzhao408",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/gzhao408/orgs",
         "received_events_url" : "https://api.github.com/users/gzhao408/received_events",
         "repos_url" : "https://api.github.com/users/gzhao408/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gzhao408/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gzhao408/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gzhao408"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r427638935"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427638935"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes, this looks like a bug in the test to me as well. Luckily by making the time type safe, this is less likely to happen in the future.\r\n\r\nRegardless, instead of depending on the current time, which is not deterministic and might cause issues while fuzzing, the fuzz test should ask the fuzz engine for a time value.\r\n\r\nHowever, this seems out of scope for the changes in this pull request.",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-05-19T22:35:16Z",
      "diff_hunk" : "@@ -74,7 +74,7 @@ void test_one_input(const std::vector<uint8_t>& buffer)\n     p2p_node.SetSendVersion(PROTOCOL_VERSION);\n     g_setup->m_node.peer_logic->InitializeNode(&p2p_node);\n     try {\n-        (void)ProcessMessage(&p2p_node, random_message_type, random_bytes_data_stream, GetTimeMillis(), Params(), *g_setup->m_node.mempool, g_setup->m_node.connman.get(), g_setup->m_node.banman.get(), std::atomic<bool>{false});",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r427638935",
      "id" : 427638935,
      "in_reply_to_id" : 426929454,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYzODkzNQ==",
      "original_commit_id" : "fac63aba8db1d0198391414a3867894f837e9df3",
      "original_line" : 77,
      "original_position" : 13,
      "original_start_line" : null,
      "path" : "src/test/fuzz/process_message.cpp",
      "position" : null,
      "pull_request_review_id" : 414870779,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "LEFT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-19T11:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427638935",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r427639581"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427639581"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Be aware that a `msg_pong_corrupt` is sent (not a `msg_pong`)",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-05-19T22:37:14Z",
      "diff_hunk" : "@@ -0,0 +1,113 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test ping message\n+\"\"\"\n+\n+import time\n+\n+from test_framework.messages import (\n+    msg_pong,\n+)\n+from test_framework.mininode import (\n+    P2PInterface,\n+    wait_until,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+PING_INTERVAL = 2 * 60\n+\n+\n+class msg_pong_corrupt(msg_pong):\n+    def serialize(self):\n+        return b\"\"\n+\n+\n+class NodePongAdd1(P2PInterface):\n+    def on_ping(self, message):\n+        self.send_message(msg_pong(message.nonce + 1))\n+\n+\n+class NodeNoPong(P2PInterface):\n+    def on_ping(self, message):\n+        pass\n+\n+\n+class PingPongTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+        self.extra_args = [['-peertimeout=3']]\n+\n+    def check_peer_info(self, *, pingtime, minping, pingwait):\n+        stats = self.nodes[0].getpeerinfo()[0]\n+        assert_equal(stats.pop('pingtime', None), pingtime)\n+        assert_equal(stats.pop('minping', None), minping)\n+        assert_equal(stats.pop('pingwait', None), pingwait)\n+\n+    def mock_forward(self, delta):\n+        self.mock_time += delta\n+        self.nodes[0].setmocktime(self.mock_time)\n+\n+    def run_test(self):\n+        self.mock_time = int(time.time())\n+        self.mock_forward(0)\n+\n+        self.log.info('Check that ping is sent after connection is established')\n+        no_pong_node = self.nodes[0].add_p2p_connection(NodeNoPong())\n+        self.mock_forward(3)\n+        assert no_pong_node.last_message.pop('ping').nonce != 0\n+        self.check_peer_info(pingtime=None, minping=None, pingwait=3)\n+\n+        self.log.info('Reply without nonce cancels ping')\n+        with self.nodes[0].assert_debug_log(['pong peer=0: Short payload']):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r427639581",
      "id" : 427639581,
      "in_reply_to_id" : 426923791,
      "line" : 65,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYzOTU4MQ==",
      "original_commit_id" : "fac63aba8db1d0198391414a3867894f837e9df3",
      "original_line" : 65,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "test/functional/p2p_ping.py",
      "position" : 65,
      "pull_request_review_id" : 414871622,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-19T11:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427639581",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r427639815"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427639815"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point! Will extend the test as suggested by you.",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-05-19T22:37:54Z",
      "diff_hunk" : "@@ -0,0 +1,113 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test ping message\n+\"\"\"\n+\n+import time\n+\n+from test_framework.messages import (\n+    msg_pong,\n+)\n+from test_framework.mininode import (\n+    P2PInterface,\n+    wait_until,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+PING_INTERVAL = 2 * 60\n+\n+\n+class msg_pong_corrupt(msg_pong):\n+    def serialize(self):\n+        return b\"\"\n+\n+\n+class NodePongAdd1(P2PInterface):\n+    def on_ping(self, message):\n+        self.send_message(msg_pong(message.nonce + 1))\n+\n+\n+class NodeNoPong(P2PInterface):\n+    def on_ping(self, message):\n+        pass\n+\n+\n+class PingPongTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+        self.extra_args = [['-peertimeout=3']]\n+\n+    def check_peer_info(self, *, pingtime, minping, pingwait):\n+        stats = self.nodes[0].getpeerinfo()[0]\n+        assert_equal(stats.pop('pingtime', None), pingtime)\n+        assert_equal(stats.pop('minping', None), minping)\n+        assert_equal(stats.pop('pingwait', None), pingwait)\n+\n+    def mock_forward(self, delta):\n+        self.mock_time += delta\n+        self.nodes[0].setmocktime(self.mock_time)\n+\n+    def run_test(self):\n+        self.mock_time = int(time.time())\n+        self.mock_forward(0)\n+\n+        self.log.info('Check that ping is sent after connection is established')\n+        no_pong_node = self.nodes[0].add_p2p_connection(NodeNoPong())\n+        self.mock_forward(3)\n+        assert no_pong_node.last_message.pop('ping').nonce != 0\n+        self.check_peer_info(pingtime=None, minping=None, pingwait=3)\n+\n+        self.log.info('Reply without nonce cancels ping')\n+        with self.nodes[0].assert_debug_log(['pong peer=0: Short payload']):\n+            no_pong_node.send_and_ping(msg_pong_corrupt())\n+        self.check_peer_info(pingtime=None, minping=None, pingwait=None)\n+\n+        self.log.info('Reply without ping')\n+        with self.nodes[0].assert_debug_log([\n+                'pong peer=0: Unsolicited pong without ping, 0 expected, 0 received, 8 bytes',\n+        ]):\n+            no_pong_node.send_and_ping(msg_pong())\n+        self.check_peer_info(pingtime=None, minping=None, pingwait=None)\n+\n+        self.log.info('Reply with wrong nonce does not cancel ping')\n+        assert 'ping' not in no_pong_node.last_message\n+        with self.nodes[0].assert_debug_log(['pong peer=0: Nonce mismatch']):\n+            # mock time PING_INTERVAL ahead to trigger node into sending a ping\n+            self.mock_forward(PING_INTERVAL + 1)\n+            wait_until(lambda: 'ping' in no_pong_node.last_message)\n+            self.mock_forward(9)\n+            # Send the wrong pong\n+            no_pong_node.send_and_ping(msg_pong(no_pong_node.last_message.pop('ping').nonce - 1))\n+        self.check_peer_info(pingtime=None, minping=None, pingwait=9)\n+\n+        self.log.info('Reply with zero nonce does cancel ping')\n+        with self.nodes[0].assert_debug_log(['pong peer=0: Nonce zero']):\n+            no_pong_node.send_and_ping(msg_pong(0))\n+        self.check_peer_info(pingtime=None, minping=None, pingwait=None)\n+\n+        self.log.info('Check that ping is properly reported on RPC')\n+        assert 'ping' not in no_pong_node.last_message\n+        # mock time PING_INTERVAL ahead to trigger node into sending a ping\n+        self.mock_forward(PING_INTERVAL + 1)\n+        wait_until(lambda: 'ping' in no_pong_node.last_message)\n+        ping_delay = 29\n+        self.mock_forward(ping_delay)\n+        wait_until(lambda: 'ping' in no_pong_node.last_message)\n+        no_pong_node.send_and_ping(msg_pong(no_pong_node.last_message.pop('ping').nonce))\n+        self.check_peer_info(pingtime=ping_delay, minping=ping_delay, pingwait=None)\n+",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r427639815",
      "id" : 427639815,
      "in_reply_to_id" : 426916085,
      "line" : 102,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYzOTgxNQ==",
      "original_commit_id" : "fac63aba8db1d0198391414a3867894f837e9df3",
      "original_line" : 102,
      "original_position" : 102,
      "original_start_line" : null,
      "path" : "test/functional/p2p_ping.py",
      "position" : 102,
      "pull_request_review_id" : 414871909,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-19T11:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427639815",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Addressed feedback by @gzhao408 ",
      "created_at" : "2020-05-19T23:28:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#issuecomment-631140601",
      "id" : 631140601,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18638",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMTE0MDYwMQ==",
      "updated_at" : "2020-05-19T23:28:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/631140601",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r427667427"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427667427"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Ah, that's it ð ",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-05-20T00:01:59Z",
      "diff_hunk" : "@@ -0,0 +1,113 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test ping message\n+\"\"\"\n+\n+import time\n+\n+from test_framework.messages import (\n+    msg_pong,\n+)\n+from test_framework.mininode import (\n+    P2PInterface,\n+    wait_until,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+PING_INTERVAL = 2 * 60\n+\n+\n+class msg_pong_corrupt(msg_pong):\n+    def serialize(self):\n+        return b\"\"\n+\n+\n+class NodePongAdd1(P2PInterface):\n+    def on_ping(self, message):\n+        self.send_message(msg_pong(message.nonce + 1))\n+\n+\n+class NodeNoPong(P2PInterface):\n+    def on_ping(self, message):\n+        pass\n+\n+\n+class PingPongTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+        self.extra_args = [['-peertimeout=3']]\n+\n+    def check_peer_info(self, *, pingtime, minping, pingwait):\n+        stats = self.nodes[0].getpeerinfo()[0]\n+        assert_equal(stats.pop('pingtime', None), pingtime)\n+        assert_equal(stats.pop('minping', None), minping)\n+        assert_equal(stats.pop('pingwait', None), pingwait)\n+\n+    def mock_forward(self, delta):\n+        self.mock_time += delta\n+        self.nodes[0].setmocktime(self.mock_time)\n+\n+    def run_test(self):\n+        self.mock_time = int(time.time())\n+        self.mock_forward(0)\n+\n+        self.log.info('Check that ping is sent after connection is established')\n+        no_pong_node = self.nodes[0].add_p2p_connection(NodeNoPong())\n+        self.mock_forward(3)\n+        assert no_pong_node.last_message.pop('ping').nonce != 0\n+        self.check_peer_info(pingtime=None, minping=None, pingwait=3)\n+\n+        self.log.info('Reply without nonce cancels ping')\n+        with self.nodes[0].assert_debug_log(['pong peer=0: Short payload']):",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r427667427",
      "id" : 427667427,
      "in_reply_to_id" : 426923791,
      "line" : 65,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2NzQyNw==",
      "original_commit_id" : "fac63aba8db1d0198391414a3867894f837e9df3",
      "original_line" : 65,
      "original_position" : 65,
      "original_start_line" : null,
      "path" : "test/functional/p2p_ping.py",
      "position" : 65,
      "pull_request_review_id" : 414904669,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-19T11:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427667427",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/25183001?v=4",
         "events_url" : "https://api.github.com/users/gzhao408/events{/privacy}",
         "followers_url" : "https://api.github.com/users/gzhao408/followers",
         "following_url" : "https://api.github.com/users/gzhao408/following{/other_user}",
         "gists_url" : "https://api.github.com/users/gzhao408/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/gzhao408",
         "id" : 25183001,
         "login" : "gzhao408",
         "node_id" : "MDQ6VXNlcjI1MTgzMDAx",
         "organizations_url" : "https://api.github.com/users/gzhao408/orgs",
         "received_events_url" : "https://api.github.com/users/gzhao408/received_events",
         "repos_url" : "https://api.github.com/users/gzhao408/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/gzhao408/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/gzhao408/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/gzhao408"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK. Reviewing/testing.",
      "created_at" : "2020-05-22T18:49:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#issuecomment-632857115",
      "id" : 632857115,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18638",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMjg1NzExNQ==",
      "updated_at" : "2020-05-22T18:49:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/632857115",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-05-23T12:06:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#issuecomment-633038703",
      "id" : 633038703,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18638",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMzAzODcwMw==",
      "updated_at" : "2020-05-23T12:06:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/633038703",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429614142"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429614142"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`std::chrono` times are cheaply copied ints; would it be simpler/safer/faster to pass by value rather than reference to const?\r\n\r\nIf yes, idem in `net.h::L645+698`, `net_processing.cpp::L2085`, and `fuzz/process_message.cpp::L32`\r\n\r\nReference: https://isocpp.github.io/CppCoreGuidelines/CppCoreGuidelines#Rf-in",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-05-24T08:52:13Z",
      "diff_hunk" : "@@ -686,7 +686,8 @@ const uint256& V1TransportDeserializer::GetMessageHash() const\n     return data_hash;\n }\n \n-CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time) {\n+CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, const std::chrono::microseconds& time)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429614142",
      "id" : 429614142,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYxNDE0Mg==",
      "original_commit_id" : "fa704719529cb928b242ecfe055e8a7b25df3a5b",
      "original_line" : 689,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 417339295,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-19T11:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429614142",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429616393"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429616393"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Not changed by this PR, but noting that this seems to be the only place in the codebase where `nPingNonceSent` is tested for truthiness with implicit conversion instead of against an integer value.",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-05-24T09:21:18Z",
      "diff_hunk" : "@@ -1141,9 +1142,9 @@ void CConnman::InactivityCheck(CNode *pnode)\n             LogPrintf(\"socket receive timeout: %is\\n\", nTime - pnode->nLastRecv);\n             pnode->fDisconnect = true;\n         }\n-        else if (pnode->nPingNonceSent && pnode->nPingUsecStart + TIMEOUT_INTERVAL * 1000000 < GetTimeMicros())\n+        else if (pnode->nPingNonceSent && pnode->m_ping_start.load() + std::chrono::seconds{TIMEOUT_INTERVAL} < GetTime<std::chrono::microseconds>())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429616393",
      "id" : 429616393,
      "line" : 1158,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYxNjM5Mw==",
      "original_commit_id" : "fa704719529cb928b242ecfe055e8a7b25df3a5b",
      "original_line" : 1158,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 56,
      "pull_request_review_id" : 417339295,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-19T11:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429616393",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429616840"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429616840"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Do you think it would be better to eventually convert these primitives to `duration` to no longer need helpers like `count_microseconds`? (or am I confused)",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-05-24T09:26:29Z",
      "diff_hunk" : "@@ -550,15 +550,15 @@ void CNode::copyStats(CNodeStats &stats, const std::vector<bool> &m_asmap)\n     // since pingtime does not update until the ping is complete, which might take a while.\n     // So, if a ping is taking an unusually long time in flight,\n     // the caller can immediately detect that this is happening.\n-    int64_t nPingUsecWait = 0;\n-    if ((0 != nPingNonceSent) && (0 != nPingUsecStart)) {\n-        nPingUsecWait = GetTimeMicros() - nPingUsecStart;\n+    std::chrono::microseconds ping_wait{0};\n+    if ((0 != nPingNonceSent) && (0 != m_ping_start.load().count())) {\n+        ping_wait = GetTime<std::chrono::microseconds>() - m_ping_start.load();\n     }\n \n     // Raw ping time is in microseconds, but show it to user as whole seconds (Bitcoin users should be well used to small numbers with many decimal places by now :)\n     stats.m_ping_usec = nPingUsecTime;\n     stats.m_min_ping_usec  = nMinPingUsecTime;\n-    stats.m_ping_wait_usec = nPingUsecWait;\n+    stats.m_ping_wait_usec = count_microseconds(ping_wait);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429616840",
      "id" : 429616840,
      "line" : 574,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYxNjg0MA==",
      "original_commit_id" : "fa704719529cb928b242ecfe055e8a7b25df3a5b",
      "original_line" : 574,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 16,
      "pull_request_review_id" : 417339295,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-19T11:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429616840",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429623460"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429623460"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Is a clean chain needed for p2p testing here? The tests seem to be fine with this set to the default of false. ",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-05-24T10:49:54Z",
      "diff_hunk" : "@@ -0,0 +1,123 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test ping message\n+\"\"\"\n+\n+import time\n+\n+from test_framework.messages import (\n+    msg_pong,\n+)\n+from test_framework.mininode import (\n+    P2PInterface,\n+    wait_until,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+PING_INTERVAL = 2 * 60\n+\n+\n+class msg_pong_corrupt(msg_pong):\n+    def serialize(self):\n+        return b\"\"\n+\n+\n+class NodePongAdd1(P2PInterface):\n+    def on_ping(self, message):\n+        self.send_message(msg_pong(message.nonce + 1))\n+\n+\n+class NodeNoPong(P2PInterface):\n+    def on_ping(self, message):\n+        pass\n+\n+\n+class PingPongTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429623460",
      "id" : 429623460,
      "line" : 40,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYyMzQ2MA==",
      "original_commit_id" : "fa704719529cb928b242ecfe055e8a7b25df3a5b",
      "original_line" : 40,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "test/functional/p2p_ping.py",
      "position" : 40,
      "pull_request_review_id" : 417346950,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-19T11:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429623460",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429625966"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429625966"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Sending a ping/pong shouldn't require any blocks, so I set this to false for now. This can be removed when the test is extended and needs blocks.",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-05-24T11:21:39Z",
      "diff_hunk" : "@@ -0,0 +1,123 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test ping message\n+\"\"\"\n+\n+import time\n+\n+from test_framework.messages import (\n+    msg_pong,\n+)\n+from test_framework.mininode import (\n+    P2PInterface,\n+    wait_until,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+PING_INTERVAL = 2 * 60\n+\n+\n+class msg_pong_corrupt(msg_pong):\n+    def serialize(self):\n+        return b\"\"\n+\n+\n+class NodePongAdd1(P2PInterface):\n+    def on_ping(self, message):\n+        self.send_message(msg_pong(message.nonce + 1))\n+\n+\n+class NodeNoPong(P2PInterface):\n+    def on_ping(self, message):\n+        pass\n+\n+\n+class PingPongTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429625966",
      "id" : 429625966,
      "in_reply_to_id" : 429623460,
      "line" : 40,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYyNTk2Ng==",
      "original_commit_id" : "fa704719529cb928b242ecfe055e8a7b25df3a5b",
      "original_line" : 40,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "test/functional/p2p_ping.py",
      "position" : 40,
      "pull_request_review_id" : 417349116,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-19T11:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429625966",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429626189"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429626189"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I admit that the documentation isn't the best https://doxygen.bitcoincore.org/time_8h.html#a50aae909d5edf426afb66cd4d30c8d00\r\n\r\nHowever, those helpers will be needed to convert durations to raw integers for:\r\n\r\n* The RPC interface\r\n* The GUI\r\n* The logs\r\n* ... so pretty much anywhere the value \"leaves\" Bitcoin Core",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-05-24T11:24:10Z",
      "diff_hunk" : "@@ -550,15 +550,15 @@ void CNode::copyStats(CNodeStats &stats, const std::vector<bool> &m_asmap)\n     // since pingtime does not update until the ping is complete, which might take a while.\n     // So, if a ping is taking an unusually long time in flight,\n     // the caller can immediately detect that this is happening.\n-    int64_t nPingUsecWait = 0;\n-    if ((0 != nPingNonceSent) && (0 != nPingUsecStart)) {\n-        nPingUsecWait = GetTimeMicros() - nPingUsecStart;\n+    std::chrono::microseconds ping_wait{0};\n+    if ((0 != nPingNonceSent) && (0 != m_ping_start.load().count())) {\n+        ping_wait = GetTime<std::chrono::microseconds>() - m_ping_start.load();\n     }\n \n     // Raw ping time is in microseconds, but show it to user as whole seconds (Bitcoin users should be well used to small numbers with many decimal places by now :)\n     stats.m_ping_usec = nPingUsecTime;\n     stats.m_min_ping_usec  = nMinPingUsecTime;\n-    stats.m_ping_wait_usec = nPingUsecWait;\n+    stats.m_ping_wait_usec = count_microseconds(ping_wait);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429626189",
      "id" : 429626189,
      "in_reply_to_id" : 429616840,
      "line" : 574,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYyNjE4OQ==",
      "original_commit_id" : "fa704719529cb928b242ecfe055e8a7b25df3a5b",
      "original_line" : 574,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 16,
      "pull_request_review_id" : 417349309,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-19T11:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429626189",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429631222"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429631222"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I always follow rule 1 (const&), because it is always cheap and prevents the overhead of having to think how many words a type has.\r\n\r\n```\r\nvoid f1(const string& s);  // OK: pass by reference to const; always cheap",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-05-24T12:25:46Z",
      "diff_hunk" : "@@ -686,7 +686,8 @@ const uint256& V1TransportDeserializer::GetMessageHash() const\n     return data_hash;\n }\n \n-CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time) {\n+CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, const std::chrono::microseconds& time)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429631222",
      "id" : 429631222,
      "in_reply_to_id" : 429614142,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYzMTIyMg==",
      "original_commit_id" : "fa704719529cb928b242ecfe055e8a7b25df3a5b",
      "original_line" : 689,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 417353777,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-19T11:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429631222",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429631246"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429631246"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Changed, though.",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-05-24T12:25:55Z",
      "diff_hunk" : "@@ -686,7 +686,8 @@ const uint256& V1TransportDeserializer::GetMessageHash() const\n     return data_hash;\n }\n \n-CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time) {\n+CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, const std::chrono::microseconds& time)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429631246",
      "id" : 429631246,
      "in_reply_to_id" : 429614142,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYzMTI0Ng==",
      "original_commit_id" : "fa704719529cb928b242ecfe055e8a7b25df3a5b",
      "original_line" : 689,
      "original_position" : 46,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : null,
      "pull_request_review_id" : 417353789,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-19T11:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429631246",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429631324"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429631324"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Indeed unrelated.",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-05-24T12:27:09Z",
      "diff_hunk" : "@@ -1141,9 +1142,9 @@ void CConnman::InactivityCheck(CNode *pnode)\n             LogPrintf(\"socket receive timeout: %is\\n\", nTime - pnode->nLastRecv);\n             pnode->fDisconnect = true;\n         }\n-        else if (pnode->nPingNonceSent && pnode->nPingUsecStart + TIMEOUT_INTERVAL * 1000000 < GetTimeMicros())\n+        else if (pnode->nPingNonceSent && pnode->m_ping_start.load() + std::chrono::seconds{TIMEOUT_INTERVAL} < GetTime<std::chrono::microseconds>())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429631324",
      "id" : 429631324,
      "in_reply_to_id" : 429616393,
      "line" : 1158,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYzMTMyNA==",
      "original_commit_id" : "fa704719529cb928b242ecfe055e8a7b25df3a5b",
      "original_line" : 1158,
      "original_position" : 56,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 56,
      "pull_request_review_id" : 417353886,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-19T11:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429631324",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429631352"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429631352"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Extended documentation",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-05-24T12:27:27Z",
      "diff_hunk" : "@@ -550,15 +550,15 @@ void CNode::copyStats(CNodeStats &stats, const std::vector<bool> &m_asmap)\n     // since pingtime does not update until the ping is complete, which might take a while.\n     // So, if a ping is taking an unusually long time in flight,\n     // the caller can immediately detect that this is happening.\n-    int64_t nPingUsecWait = 0;\n-    if ((0 != nPingNonceSent) && (0 != nPingUsecStart)) {\n-        nPingUsecWait = GetTimeMicros() - nPingUsecStart;\n+    std::chrono::microseconds ping_wait{0};\n+    if ((0 != nPingNonceSent) && (0 != m_ping_start.load().count())) {\n+        ping_wait = GetTime<std::chrono::microseconds>() - m_ping_start.load();\n     }\n \n     // Raw ping time is in microseconds, but show it to user as whole seconds (Bitcoin users should be well used to small numbers with many decimal places by now :)\n     stats.m_ping_usec = nPingUsecTime;\n     stats.m_min_ping_usec  = nMinPingUsecTime;\n-    stats.m_ping_wait_usec = nPingUsecWait;\n+    stats.m_ping_wait_usec = count_microseconds(ping_wait);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429631352",
      "id" : 429631352,
      "in_reply_to_id" : 429616840,
      "line" : 574,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYzMTM1Mg==",
      "original_commit_id" : "fa704719529cb928b242ecfe055e8a7b25df3a5b",
      "original_line" : 574,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 16,
      "pull_request_review_id" : 417353910,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-19T11:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429631352",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Added documentation to address @jonatack's feedback",
      "created_at" : "2020-05-24T12:28:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#issuecomment-633223791",
      "id" : 633223791,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18638",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMzIyMzc5MQ==",
      "updated_at" : "2020-05-24T12:28:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/633223791",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429645464"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429645464"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Did you still want to set this to false? :angel: ",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-05-24T15:00:33Z",
      "diff_hunk" : "@@ -0,0 +1,123 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test ping message\n+\"\"\"\n+\n+import time\n+\n+from test_framework.messages import (\n+    msg_pong,\n+)\n+from test_framework.mininode import (\n+    P2PInterface,\n+    wait_until,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+PING_INTERVAL = 2 * 60\n+\n+\n+class msg_pong_corrupt(msg_pong):\n+    def serialize(self):\n+        return b\"\"\n+\n+\n+class NodePongAdd1(P2PInterface):\n+    def on_ping(self, message):\n+        self.send_message(msg_pong(message.nonce + 1))\n+\n+\n+class NodeNoPong(P2PInterface):\n+    def on_ping(self, message):\n+        pass\n+\n+\n+class PingPongTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429645464",
      "id" : 429645464,
      "in_reply_to_id" : 429623460,
      "line" : 40,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY0NTQ2NA==",
      "original_commit_id" : "fa704719529cb928b242ecfe055e8a7b25df3a5b",
      "original_line" : 40,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "test/functional/p2p_ping.py",
      "position" : 40,
      "pull_request_review_id" : 417366341,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-19T11:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429645464",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429645503"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429645503"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Thanks!",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-05-24T15:00:56Z",
      "diff_hunk" : "@@ -550,15 +550,15 @@ void CNode::copyStats(CNodeStats &stats, const std::vector<bool> &m_asmap)\n     // since pingtime does not update until the ping is complete, which might take a while.\n     // So, if a ping is taking an unusually long time in flight,\n     // the caller can immediately detect that this is happening.\n-    int64_t nPingUsecWait = 0;\n-    if ((0 != nPingNonceSent) && (0 != nPingUsecStart)) {\n-        nPingUsecWait = GetTimeMicros() - nPingUsecStart;\n+    std::chrono::microseconds ping_wait{0};\n+    if ((0 != nPingNonceSent) && (0 != m_ping_start.load().count())) {\n+        ping_wait = GetTime<std::chrono::microseconds>() - m_ping_start.load();\n     }\n \n     // Raw ping time is in microseconds, but show it to user as whole seconds (Bitcoin users should be well used to small numbers with many decimal places by now :)\n     stats.m_ping_usec = nPingUsecTime;\n     stats.m_min_ping_usec  = nMinPingUsecTime;\n-    stats.m_ping_wait_usec = nPingUsecWait;\n+    stats.m_ping_wait_usec = count_microseconds(ping_wait);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429645503",
      "id" : 429645503,
      "in_reply_to_id" : 429616840,
      "line" : 574,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY0NTUwMw==",
      "original_commit_id" : "fa704719529cb928b242ecfe055e8a7b25df3a5b",
      "original_line" : 574,
      "original_position" : 16,
      "original_start_line" : null,
      "path" : "src/net.cpp",
      "position" : 16,
      "pull_request_review_id" : 417366372,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-19T11:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429645503",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Code review re-ACK fabb382 changes since last review per `git diff fa70471 fabb382` are passing time by value to `GetMessage` and `ProcessMessage` and improved documentation.",
      "created_at" : "2020-05-24T15:01:13Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#issuecomment-633243961",
      "id" : 633243961,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18638",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMzI0Mzk2MQ==",
      "updated_at" : "2020-05-24T15:01:13Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/633243961",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429649084"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429649084"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Seems overly expensive to copy the blockchain when it is not needed, no?",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-05-24T15:41:44Z",
      "diff_hunk" : "@@ -0,0 +1,123 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test ping message\n+\"\"\"\n+\n+import time\n+\n+from test_framework.messages import (\n+    msg_pong,\n+)\n+from test_framework.mininode import (\n+    P2PInterface,\n+    wait_until,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+PING_INTERVAL = 2 * 60\n+\n+\n+class msg_pong_corrupt(msg_pong):\n+    def serialize(self):\n+        return b\"\"\n+\n+\n+class NodePongAdd1(P2PInterface):\n+    def on_ping(self, message):\n+        self.send_message(msg_pong(message.nonce + 1))\n+\n+\n+class NodeNoPong(P2PInterface):\n+    def on_ping(self, message):\n+        pass\n+\n+\n+class PingPongTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429649084",
      "id" : 429649084,
      "in_reply_to_id" : 429623460,
      "line" : 40,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY0OTA4NA==",
      "original_commit_id" : "fa704719529cb928b242ecfe055e8a7b25df3a5b",
      "original_line" : 40,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "test/functional/p2p_ping.py",
      "position" : 40,
      "pull_request_review_id" : 417369456,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-19T11:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429649084",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429650644"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429650644"
         }
      },
      "author_association" : "MEMBER",
      "body" : "This might be a wrong conception I've had for a long time. I thought it was cheaper to use the cached data directories rather than set up a clean chain, and that the test framework defaults to `self.setup_clean_chain = False` for this reason. I reckoned the default was the cheaper option and the more expensive one was opt-in, so I always used `False` where possible.",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-05-24T15:58:34Z",
      "diff_hunk" : "@@ -0,0 +1,123 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test ping message\n+\"\"\"\n+\n+import time\n+\n+from test_framework.messages import (\n+    msg_pong,\n+)\n+from test_framework.mininode import (\n+    P2PInterface,\n+    wait_until,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+PING_INTERVAL = 2 * 60\n+\n+\n+class msg_pong_corrupt(msg_pong):\n+    def serialize(self):\n+        return b\"\"\n+\n+\n+class NodePongAdd1(P2PInterface):\n+    def on_ping(self, message):\n+        self.send_message(msg_pong(message.nonce + 1))\n+\n+\n+class NodeNoPong(P2PInterface):\n+    def on_ping(self, message):\n+        pass\n+\n+\n+class PingPongTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429650644",
      "id" : 429650644,
      "in_reply_to_id" : 429623460,
      "line" : 40,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY1MDY0NA==",
      "original_commit_id" : "fa704719529cb928b242ecfe055e8a7b25df3a5b",
      "original_line" : 40,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "test/functional/p2p_ping.py",
      "position" : 40,
      "pull_request_review_id" : 417370761,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-19T11:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429650644",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429651218"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429651218"
         }
      },
      "author_association" : "MEMBER",
      "body" : "It might be a good idea to add a sentence on performance in the \"General test-writing advice\" section in `functional/README.md` where it states \"Set the `self.setup_clean_chain` variable in `set_test_params()` to control whether or not to use the cached data directories.\"",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-05-24T16:05:52Z",
      "diff_hunk" : "@@ -0,0 +1,123 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test ping message\n+\"\"\"\n+\n+import time\n+\n+from test_framework.messages import (\n+    msg_pong,\n+)\n+from test_framework.mininode import (\n+    P2PInterface,\n+    wait_until,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+PING_INTERVAL = 2 * 60\n+\n+\n+class msg_pong_corrupt(msg_pong):\n+    def serialize(self):\n+        return b\"\"\n+\n+\n+class NodePongAdd1(P2PInterface):\n+    def on_ping(self, message):\n+        self.send_message(msg_pong(message.nonce + 1))\n+\n+\n+class NodeNoPong(P2PInterface):\n+    def on_ping(self, message):\n+        pass\n+\n+\n+class PingPongTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429651218",
      "id" : 429651218,
      "in_reply_to_id" : 429623460,
      "line" : 40,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY1MTIxOA==",
      "original_commit_id" : "fa704719529cb928b242ecfe055e8a7b25df3a5b",
      "original_line" : 40,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "test/functional/p2p_ping.py",
      "position" : 40,
      "pull_request_review_id" : 417371251,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-19T11:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429651218",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429652879"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429652879"
         }
      },
      "author_association" : "MEMBER",
      "body" : "The reason this default to a chain is that most tests require a chain, so so the least verbose option is the default.\r\n\r\nAlso, defaulting to a chain prevents test writers from accidentally mining a chain when it is not needed. Mining is orders of magnitude slower than copying.",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-05-24T16:25:23Z",
      "diff_hunk" : "@@ -0,0 +1,123 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test ping message\n+\"\"\"\n+\n+import time\n+\n+from test_framework.messages import (\n+    msg_pong,\n+)\n+from test_framework.mininode import (\n+    P2PInterface,\n+    wait_until,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+PING_INTERVAL = 2 * 60\n+\n+\n+class msg_pong_corrupt(msg_pong):\n+    def serialize(self):\n+        return b\"\"\n+\n+\n+class NodePongAdd1(P2PInterface):\n+    def on_ping(self, message):\n+        self.send_message(msg_pong(message.nonce + 1))\n+\n+\n+class NodeNoPong(P2PInterface):\n+    def on_ping(self, message):\n+        pass\n+\n+\n+class PingPongTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r429652879",
      "id" : 429652879,
      "in_reply_to_id" : 429623460,
      "line" : 40,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTY1Mjg3OQ==",
      "original_commit_id" : "fa704719529cb928b242ecfe055e8a7b25df3a5b",
      "original_line" : 40,
      "original_position" : 40,
      "original_start_line" : null,
      "path" : "test/functional/p2p_ping.py",
      "position" : 40,
      "pull_request_review_id" : 417372667,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-19T11:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429652879",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-06-04T20:36:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#issuecomment-639102512",
      "id" : 639102512,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18638",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzOTEwMjUxMg==",
      "updated_at" : "2020-06-04T20:36:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/639102512",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r436736726"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436736726"
         }
      },
      "author_association" : "MEMBER",
      "body" : "nit: if you retouch, could add a comment expressing the time units or along the lines of:\r\n```python3\r\nPING_INTERVAL = 2 * 60  # 2 minutes (corresponds to net_processing::PING_INTERVAL)\r\n```",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-06-08T14:08:22Z",
      "diff_hunk" : "@@ -0,0 +1,123 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test ping message\n+\"\"\"\n+\n+import time\n+\n+from test_framework.messages import (\n+    msg_pong,\n+)\n+from test_framework.mininode import (\n+    P2PInterface,\n+    wait_until,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+PING_INTERVAL = 2 * 60",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r436736726",
      "id" : 436736726,
      "line" : 20,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjczNjcyNg==",
      "original_commit_id" : "fa94d6fef799a900c15dce9638eace5cc10087ae",
      "original_line" : 20,
      "original_position" : 20,
      "original_start_line" : null,
      "path" : "test/functional/p2p_ping.py",
      "position" : 20,
      "pull_request_review_id" : 426279785,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-19T11:26:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436736726",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-06-19T10:25:11Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#issuecomment-646560711",
      "id" : 646560711,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18638",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NjU2MDcxMQ==",
      "updated_at" : "2020-06-19T10:25:11Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/646560711",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Rebased. Should be easy to re-ACK with `git range-diff bitcoin-core/master A B`",
      "created_at" : "2020-06-19T11:51:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#issuecomment-646593845",
      "id" : 646593845,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18638",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NjU5Mzg0NQ==",
      "updated_at" : "2020-06-19T11:51:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/646593845",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r443501995"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443501995"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "This is `peertimeout` right? If yes, we use `peertimeout` at 3 places any maybe it's more clear to define it at the outermost scope as well like `PING_INTERVAL`? Or maybe there's no need :)",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-06-22T11:48:14Z",
      "diff_hunk" : "@@ -0,0 +1,123 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test ping message\n+\"\"\"\n+\n+import time\n+\n+from test_framework.messages import (\n+    msg_pong,\n+)\n+from test_framework.mininode import (\n+    P2PInterface,\n+    wait_until,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+PING_INTERVAL = 2 * 60\n+\n+\n+class msg_pong_corrupt(msg_pong):\n+    def serialize(self):\n+        return b\"\"\n+\n+\n+class NodePongAdd1(P2PInterface):\n+    def on_ping(self, message):\n+        self.send_message(msg_pong(message.nonce + 1))\n+\n+\n+class NodeNoPong(P2PInterface):\n+    def on_ping(self, message):\n+        pass\n+\n+\n+class PingPongTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+        self.extra_args = [['-peertimeout=3']]\n+\n+    def check_peer_info(self, *, pingtime, minping, pingwait):\n+        stats = self.nodes[0].getpeerinfo()[0]\n+        assert_equal(stats.pop('pingtime', None), pingtime)\n+        assert_equal(stats.pop('minping', None), minping)\n+        assert_equal(stats.pop('pingwait', None), pingwait)\n+\n+    def mock_forward(self, delta):\n+        self.mock_time += delta\n+        self.nodes[0].setmocktime(self.mock_time)\n+\n+    def run_test(self):\n+        self.mock_time = int(time.time())\n+        self.mock_forward(0)\n+\n+        self.log.info('Check that ping is sent after connection is established')\n+        no_pong_node = self.nodes[0].add_p2p_connection(NodeNoPong())\n+        self.mock_forward(3)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r443501995",
      "id" : 443501995,
      "line" : 60,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzUwMTk5NQ==",
      "original_commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "original_line" : 60,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "test/functional/p2p_ping.py",
      "position" : 60,
      "pull_request_review_id" : 434847045,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-22T11:48:15Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443501995",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/16291842?v=4",
         "events_url" : "https://api.github.com/users/fridokus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fridokus/followers",
         "following_url" : "https://api.github.com/users/fridokus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fridokus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fridokus",
         "id" : 16291842,
         "login" : "fridokus",
         "node_id" : "MDQ6VXNlcjE2MjkxODQy",
         "organizations_url" : "https://api.github.com/users/fridokus/orgs",
         "received_events_url" : "https://api.github.com/users/fridokus/received_events",
         "repos_url" : "https://api.github.com/users/fridokus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fridokus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fridokus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fridokus"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "ACK faab4aaf2fa1153c6d76efc8113fa01b06943ece, ran functional tests and read the python scripts.\r\n\r\n",
      "created_at" : "2020-06-22T11:48:28Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#issuecomment-647466665",
      "id" : 647466665,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18638",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY0NzQ2NjY2NQ==",
      "updated_at" : "2020-06-22T11:48:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/647466665",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/16291842?v=4",
         "events_url" : "https://api.github.com/users/fridokus/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fridokus/followers",
         "following_url" : "https://api.github.com/users/fridokus/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fridokus/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fridokus",
         "id" : 16291842,
         "login" : "fridokus",
         "node_id" : "MDQ6VXNlcjE2MjkxODQy",
         "organizations_url" : "https://api.github.com/users/fridokus/orgs",
         "received_events_url" : "https://api.github.com/users/fridokus/received_events",
         "repos_url" : "https://api.github.com/users/fridokus/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fridokus/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fridokus/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fridokus"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r444582868"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444582868"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why pop here, as opposed to just accessing the value?  Seems like having `(message_count['ping'] == 1 and 'ping' not in last_message) == True` could be confusing.\r\n\r\nMaybe decrementing `message_count['ping']` every pop is an easier solution, being that this idea is used throughout the test.\r\n\r\n```suggestion\r\n        assert no_pong_node.last_message['ping'].nonce != 0\r\n```\r\nOr maybe\r\n```suggestion\r\n        assert no_pong_node.last_message.get('ping').nonce != 0\r\n```\r\nor\r\n```suggestion\r\n        assert no_pong_node.last_message.pop('ping').nonce != 0\r\n        no_pong_node.message_count['ping'] -= 1\r\n```",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-06-24T00:43:41Z",
      "diff_hunk" : "@@ -0,0 +1,123 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test ping message\n+\"\"\"\n+\n+import time\n+\n+from test_framework.messages import (\n+    msg_pong,\n+)\n+from test_framework.mininode import (\n+    P2PInterface,\n+    wait_until,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+PING_INTERVAL = 2 * 60\n+\n+\n+class msg_pong_corrupt(msg_pong):\n+    def serialize(self):\n+        return b\"\"\n+\n+\n+class NodePongAdd1(P2PInterface):\n+    def on_ping(self, message):\n+        self.send_message(msg_pong(message.nonce + 1))\n+\n+\n+class NodeNoPong(P2PInterface):\n+    def on_ping(self, message):\n+        pass\n+\n+\n+class PingPongTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+        self.extra_args = [['-peertimeout=3']]\n+\n+    def check_peer_info(self, *, pingtime, minping, pingwait):\n+        stats = self.nodes[0].getpeerinfo()[0]\n+        assert_equal(stats.pop('pingtime', None), pingtime)\n+        assert_equal(stats.pop('minping', None), minping)\n+        assert_equal(stats.pop('pingwait', None), pingwait)\n+\n+    def mock_forward(self, delta):\n+        self.mock_time += delta\n+        self.nodes[0].setmocktime(self.mock_time)\n+\n+    def run_test(self):\n+        self.mock_time = int(time.time())\n+        self.mock_forward(0)\n+\n+        self.log.info('Check that ping is sent after connection is established')\n+        no_pong_node = self.nodes[0].add_p2p_connection(NodeNoPong())\n+        self.mock_forward(3)\n+        assert no_pong_node.last_message.pop('ping').nonce != 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r444582868",
      "id" : 444582868,
      "line" : 61,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU4Mjg2OA==",
      "original_commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "original_line" : 61,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "test/functional/p2p_ping.py",
      "position" : 61,
      "pull_request_review_id" : 436250936,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-24T01:30:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444582868",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r444583585"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444583585"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Why `send_and_ping` and not `send_message`, here and throughout?  Doesn't seem like it would make a difference, and maybe it's best that we don't have extraneous pings and pongs.",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-06-24T00:46:35Z",
      "diff_hunk" : "@@ -0,0 +1,123 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test ping message\n+\"\"\"\n+\n+import time\n+\n+from test_framework.messages import (\n+    msg_pong,\n+)\n+from test_framework.mininode import (\n+    P2PInterface,\n+    wait_until,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+PING_INTERVAL = 2 * 60\n+\n+\n+class msg_pong_corrupt(msg_pong):\n+    def serialize(self):\n+        return b\"\"\n+\n+\n+class NodePongAdd1(P2PInterface):\n+    def on_ping(self, message):\n+        self.send_message(msg_pong(message.nonce + 1))\n+\n+\n+class NodeNoPong(P2PInterface):\n+    def on_ping(self, message):\n+        pass\n+\n+\n+class PingPongTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+        self.extra_args = [['-peertimeout=3']]\n+\n+    def check_peer_info(self, *, pingtime, minping, pingwait):\n+        stats = self.nodes[0].getpeerinfo()[0]\n+        assert_equal(stats.pop('pingtime', None), pingtime)\n+        assert_equal(stats.pop('minping', None), minping)\n+        assert_equal(stats.pop('pingwait', None), pingwait)\n+\n+    def mock_forward(self, delta):\n+        self.mock_time += delta\n+        self.nodes[0].setmocktime(self.mock_time)\n+\n+    def run_test(self):\n+        self.mock_time = int(time.time())\n+        self.mock_forward(0)\n+\n+        self.log.info('Check that ping is sent after connection is established')\n+        no_pong_node = self.nodes[0].add_p2p_connection(NodeNoPong())\n+        self.mock_forward(3)\n+        assert no_pong_node.last_message.pop('ping').nonce != 0\n+        self.check_peer_info(pingtime=None, minping=None, pingwait=3)\n+\n+        self.log.info('Reply without nonce cancels ping')\n+        with self.nodes[0].assert_debug_log(['pong peer=0: Short payload']):\n+            no_pong_node.send_and_ping(msg_pong_corrupt())\n+        self.check_peer_info(pingtime=None, minping=None, pingwait=None)\n+\n+        self.log.info('Reply without ping')\n+        with self.nodes[0].assert_debug_log([\n+                'pong peer=0: Unsolicited pong without ping, 0 expected, 0 received, 8 bytes',\n+        ]):\n+            no_pong_node.send_and_ping(msg_pong())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r444583585",
      "id" : 444583585,
      "line" : 73,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU4MzU4NQ==",
      "original_commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "original_line" : 73,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "test/functional/p2p_ping.py",
      "position" : 73,
      "pull_request_review_id" : 436250936,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-06-24T01:30:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444583585",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r444585462"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444585462"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "nit: single line for a single import?",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-06-24T00:53:44Z",
      "diff_hunk" : "@@ -0,0 +1,123 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test ping message\n+\"\"\"\n+\n+import time\n+\n+from test_framework.messages import (\n+    msg_pong,\n+)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r444585462",
      "id" : 444585462,
      "line" : 12,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU4NTQ2Mg==",
      "original_commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "original_line" : 12,
      "original_position" : 12,
      "original_start_line" : 10,
      "path" : "test/functional/p2p_ping.py",
      "position" : 12,
      "pull_request_review_id" : 436250936,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : 10,
      "start_side" : "RIGHT",
      "updated_at" : "2020-06-24T01:30:01Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444585462",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/5553787?v=4",
         "events_url" : "https://api.github.com/users/troygiorshev/events{/privacy}",
         "followers_url" : "https://api.github.com/users/troygiorshev/followers",
         "following_url" : "https://api.github.com/users/troygiorshev/following{/other_user}",
         "gists_url" : "https://api.github.com/users/troygiorshev/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/troygiorshev",
         "id" : 5553787,
         "login" : "troygiorshev",
         "node_id" : "MDQ6VXNlcjU1NTM3ODc=",
         "organizations_url" : "https://api.github.com/users/troygiorshev/orgs",
         "received_events_url" : "https://api.github.com/users/troygiorshev/received_events",
         "repos_url" : "https://api.github.com/users/troygiorshev/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/troygiorshev/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/troygiorshev"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r452859253"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452859253"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't like to use `assert_debug_log` as a way to synchronize/poll for a change\r\n\r\n`send_and_ping` is a way to flush all messages in the buffer (on both sides, send and receive) and ensure they are processed (and any errors have been logged).",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-07-10T13:55:34Z",
      "diff_hunk" : "@@ -0,0 +1,123 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test ping message\n+\"\"\"\n+\n+import time\n+\n+from test_framework.messages import (\n+    msg_pong,\n+)\n+from test_framework.mininode import (\n+    P2PInterface,\n+    wait_until,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+PING_INTERVAL = 2 * 60\n+\n+\n+class msg_pong_corrupt(msg_pong):\n+    def serialize(self):\n+        return b\"\"\n+\n+\n+class NodePongAdd1(P2PInterface):\n+    def on_ping(self, message):\n+        self.send_message(msg_pong(message.nonce + 1))\n+\n+\n+class NodeNoPong(P2PInterface):\n+    def on_ping(self, message):\n+        pass\n+\n+\n+class PingPongTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+        self.extra_args = [['-peertimeout=3']]\n+\n+    def check_peer_info(self, *, pingtime, minping, pingwait):\n+        stats = self.nodes[0].getpeerinfo()[0]\n+        assert_equal(stats.pop('pingtime', None), pingtime)\n+        assert_equal(stats.pop('minping', None), minping)\n+        assert_equal(stats.pop('pingwait', None), pingwait)\n+\n+    def mock_forward(self, delta):\n+        self.mock_time += delta\n+        self.nodes[0].setmocktime(self.mock_time)\n+\n+    def run_test(self):\n+        self.mock_time = int(time.time())\n+        self.mock_forward(0)\n+\n+        self.log.info('Check that ping is sent after connection is established')\n+        no_pong_node = self.nodes[0].add_p2p_connection(NodeNoPong())\n+        self.mock_forward(3)\n+        assert no_pong_node.last_message.pop('ping').nonce != 0\n+        self.check_peer_info(pingtime=None, minping=None, pingwait=3)\n+\n+        self.log.info('Reply without nonce cancels ping')\n+        with self.nodes[0].assert_debug_log(['pong peer=0: Short payload']):\n+            no_pong_node.send_and_ping(msg_pong_corrupt())\n+        self.check_peer_info(pingtime=None, minping=None, pingwait=None)\n+\n+        self.log.info('Reply without ping')\n+        with self.nodes[0].assert_debug_log([\n+                'pong peer=0: Unsolicited pong without ping, 0 expected, 0 received, 8 bytes',\n+        ]):\n+            no_pong_node.send_and_ping(msg_pong())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r452859253",
      "id" : 452859253,
      "in_reply_to_id" : 444583585,
      "line" : 73,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg1OTI1Mw==",
      "original_commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "original_line" : 73,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "test/functional/p2p_ping.py",
      "position" : 73,
      "pull_request_review_id" : 446421613,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-10T13:55:35Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452859253",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r452860611"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452860611"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I wasn't aware that `message_count` exists, nor am I using it in this test. Given that it is almost unused right now and causes (potential) confusion, I'd say to remove it",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-07-10T13:57:44Z",
      "diff_hunk" : "@@ -0,0 +1,123 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test ping message\n+\"\"\"\n+\n+import time\n+\n+from test_framework.messages import (\n+    msg_pong,\n+)\n+from test_framework.mininode import (\n+    P2PInterface,\n+    wait_until,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+PING_INTERVAL = 2 * 60\n+\n+\n+class msg_pong_corrupt(msg_pong):\n+    def serialize(self):\n+        return b\"\"\n+\n+\n+class NodePongAdd1(P2PInterface):\n+    def on_ping(self, message):\n+        self.send_message(msg_pong(message.nonce + 1))\n+\n+\n+class NodeNoPong(P2PInterface):\n+    def on_ping(self, message):\n+        pass\n+\n+\n+class PingPongTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+        self.extra_args = [['-peertimeout=3']]\n+\n+    def check_peer_info(self, *, pingtime, minping, pingwait):\n+        stats = self.nodes[0].getpeerinfo()[0]\n+        assert_equal(stats.pop('pingtime', None), pingtime)\n+        assert_equal(stats.pop('minping', None), minping)\n+        assert_equal(stats.pop('pingwait', None), pingwait)\n+\n+    def mock_forward(self, delta):\n+        self.mock_time += delta\n+        self.nodes[0].setmocktime(self.mock_time)\n+\n+    def run_test(self):\n+        self.mock_time = int(time.time())\n+        self.mock_forward(0)\n+\n+        self.log.info('Check that ping is sent after connection is established')\n+        no_pong_node = self.nodes[0].add_p2p_connection(NodeNoPong())\n+        self.mock_forward(3)\n+        assert no_pong_node.last_message.pop('ping').nonce != 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r452860611",
      "id" : 452860611,
      "in_reply_to_id" : 444582868,
      "line" : 61,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg2MDYxMQ==",
      "original_commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "original_line" : 61,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "test/functional/p2p_ping.py",
      "position" : 61,
      "pull_request_review_id" : 446423325,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-10T13:57:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452860611",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r452861030"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452861030"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Good point. Can be fixed in a follow-up",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-07-10T13:58:26Z",
      "diff_hunk" : "@@ -0,0 +1,123 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test ping message\n+\"\"\"\n+\n+import time\n+\n+from test_framework.messages import (\n+    msg_pong,\n+)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r452861030",
      "id" : 452861030,
      "in_reply_to_id" : 444585462,
      "line" : 12,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg2MTAzMA==",
      "original_commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "original_line" : 12,
      "original_position" : 12,
      "original_start_line" : 10,
      "path" : "test/functional/p2p_ping.py",
      "position" : 12,
      "pull_request_review_id" : 446423905,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : 10,
      "start_side" : "RIGHT",
      "updated_at" : "2020-07-10T13:58:27Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452861030",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r452863651"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452863651"
         }
      },
      "author_association" : "MEMBER",
      "body" : "the reason I use pop is to ensure the value is discarded after a read and has no way to poison follow-up test cases",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-07-10T14:03:00Z",
      "diff_hunk" : "@@ -0,0 +1,123 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test ping message\n+\"\"\"\n+\n+import time\n+\n+from test_framework.messages import (\n+    msg_pong,\n+)\n+from test_framework.mininode import (\n+    P2PInterface,\n+    wait_until,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+PING_INTERVAL = 2 * 60\n+\n+\n+class msg_pong_corrupt(msg_pong):\n+    def serialize(self):\n+        return b\"\"\n+\n+\n+class NodePongAdd1(P2PInterface):\n+    def on_ping(self, message):\n+        self.send_message(msg_pong(message.nonce + 1))\n+\n+\n+class NodeNoPong(P2PInterface):\n+    def on_ping(self, message):\n+        pass\n+\n+\n+class PingPongTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+        self.extra_args = [['-peertimeout=3']]\n+\n+    def check_peer_info(self, *, pingtime, minping, pingwait):\n+        stats = self.nodes[0].getpeerinfo()[0]\n+        assert_equal(stats.pop('pingtime', None), pingtime)\n+        assert_equal(stats.pop('minping', None), minping)\n+        assert_equal(stats.pop('pingwait', None), pingwait)\n+\n+    def mock_forward(self, delta):\n+        self.mock_time += delta\n+        self.nodes[0].setmocktime(self.mock_time)\n+\n+    def run_test(self):\n+        self.mock_time = int(time.time())\n+        self.mock_forward(0)\n+\n+        self.log.info('Check that ping is sent after connection is established')\n+        no_pong_node = self.nodes[0].add_p2p_connection(NodeNoPong())\n+        self.mock_forward(3)\n+        assert no_pong_node.last_message.pop('ping').nonce != 0",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r452863651",
      "id" : 452863651,
      "in_reply_to_id" : 444582868,
      "line" : 61,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg2MzY1MQ==",
      "original_commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "original_line" : 61,
      "original_position" : 61,
      "original_start_line" : null,
      "path" : "test/functional/p2p_ping.py",
      "position" : 61,
      "pull_request_review_id" : 446427537,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-10T14:03:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452863651",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r452864246"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452864246"
         }
      },
      "author_association" : "MEMBER",
      "body" : "`peertimeout` is wall clock time, not mock time, I think. So this can be any value, as long as it matches pingwait=3 below, I'd say",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-07-10T14:04:03Z",
      "diff_hunk" : "@@ -0,0 +1,123 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test ping message\n+\"\"\"\n+\n+import time\n+\n+from test_framework.messages import (\n+    msg_pong,\n+)\n+from test_framework.mininode import (\n+    P2PInterface,\n+    wait_until,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+PING_INTERVAL = 2 * 60\n+\n+\n+class msg_pong_corrupt(msg_pong):\n+    def serialize(self):\n+        return b\"\"\n+\n+\n+class NodePongAdd1(P2PInterface):\n+    def on_ping(self, message):\n+        self.send_message(msg_pong(message.nonce + 1))\n+\n+\n+class NodeNoPong(P2PInterface):\n+    def on_ping(self, message):\n+        pass\n+\n+\n+class PingPongTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+        self.extra_args = [['-peertimeout=3']]\n+\n+    def check_peer_info(self, *, pingtime, minping, pingwait):\n+        stats = self.nodes[0].getpeerinfo()[0]\n+        assert_equal(stats.pop('pingtime', None), pingtime)\n+        assert_equal(stats.pop('minping', None), minping)\n+        assert_equal(stats.pop('pingwait', None), pingwait)\n+\n+    def mock_forward(self, delta):\n+        self.mock_time += delta\n+        self.nodes[0].setmocktime(self.mock_time)\n+\n+    def run_test(self):\n+        self.mock_time = int(time.time())\n+        self.mock_forward(0)\n+\n+        self.log.info('Check that ping is sent after connection is established')\n+        no_pong_node = self.nodes[0].add_p2p_connection(NodeNoPong())\n+        self.mock_forward(3)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r452864246",
      "id" : 452864246,
      "in_reply_to_id" : 443501995,
      "line" : 60,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg2NDI0Ng==",
      "original_commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "original_line" : 60,
      "original_position" : 60,
      "original_start_line" : null,
      "path" : "test/functional/p2p_ping.py",
      "position" : 60,
      "pull_request_review_id" : 446428329,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-10T14:04:03Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452864246",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r452864695"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452864695"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Also, sending a ping and receiving a ping should never interfere, unless I am missing something obvious",
      "commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "created_at" : "2020-07-10T14:04:46Z",
      "diff_hunk" : "@@ -0,0 +1,123 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test ping message\n+\"\"\"\n+\n+import time\n+\n+from test_framework.messages import (\n+    msg_pong,\n+)\n+from test_framework.mininode import (\n+    P2PInterface,\n+    wait_until,\n+)\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+PING_INTERVAL = 2 * 60\n+\n+\n+class msg_pong_corrupt(msg_pong):\n+    def serialize(self):\n+        return b\"\"\n+\n+\n+class NodePongAdd1(P2PInterface):\n+    def on_ping(self, message):\n+        self.send_message(msg_pong(message.nonce + 1))\n+\n+\n+class NodeNoPong(P2PInterface):\n+    def on_ping(self, message):\n+        pass\n+\n+\n+class PingPongTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+        self.extra_args = [['-peertimeout=3']]\n+\n+    def check_peer_info(self, *, pingtime, minping, pingwait):\n+        stats = self.nodes[0].getpeerinfo()[0]\n+        assert_equal(stats.pop('pingtime', None), pingtime)\n+        assert_equal(stats.pop('minping', None), minping)\n+        assert_equal(stats.pop('pingwait', None), pingwait)\n+\n+    def mock_forward(self, delta):\n+        self.mock_time += delta\n+        self.nodes[0].setmocktime(self.mock_time)\n+\n+    def run_test(self):\n+        self.mock_time = int(time.time())\n+        self.mock_forward(0)\n+\n+        self.log.info('Check that ping is sent after connection is established')\n+        no_pong_node = self.nodes[0].add_p2p_connection(NodeNoPong())\n+        self.mock_forward(3)\n+        assert no_pong_node.last_message.pop('ping').nonce != 0\n+        self.check_peer_info(pingtime=None, minping=None, pingwait=3)\n+\n+        self.log.info('Reply without nonce cancels ping')\n+        with self.nodes[0].assert_debug_log(['pong peer=0: Short payload']):\n+            no_pong_node.send_and_ping(msg_pong_corrupt())\n+        self.check_peer_info(pingtime=None, minping=None, pingwait=None)\n+\n+        self.log.info('Reply without ping')\n+        with self.nodes[0].assert_debug_log([\n+                'pong peer=0: Unsolicited pong without ping, 0 expected, 0 received, 8 bytes',\n+        ]):\n+            no_pong_node.send_and_ping(msg_pong())",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#discussion_r452864695",
      "id" : 452864695,
      "in_reply_to_id" : 444583585,
      "line" : 73,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mjg2NDY5NQ==",
      "original_commit_id" : "fa3365430c5fb57d7c0b5f2bce9fbbe290be93c3",
      "original_line" : 73,
      "original_position" : 73,
      "original_start_line" : null,
      "path" : "test/functional/p2p_ping.py",
      "position" : 73,
      "pull_request_review_id" : 446428908,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18638",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-07-10T14:04:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/452864695",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Thanks for the review everyone. If there are ways to improve the test, I am happy to review them in a follow-up",
      "created_at" : "2020-07-10T14:05:59Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18638#issuecomment-656694715",
      "id" : 656694715,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18638",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDY1NjY5NDcxNQ==",
      "updated_at" : "2020-07-10T14:05:59Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/656694715",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   }
]
