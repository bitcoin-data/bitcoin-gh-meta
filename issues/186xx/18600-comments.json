[
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18982 (wallet: Minimal fix to restore conflicted transaction notifications by ryanofsky)\n* #18354 (Use shared pointers only in validation interface by bvbfan)\n* #17443 (Drop checkFinalTx and use Median Time Past to check finality of wallet transactions by ariard)\n* #15719 (Wallet passive startup by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-04-12T04:13:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#issuecomment-612561562",
      "id" : 612561562,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18600",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxMjU2MTU2Mg==",
      "updated_at" : "2020-06-02T06:42:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/612561562",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r407511482"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407511482"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[validationinterface] Extend TransactionRemovedFromMempool with fIsConflicted\" (9eb9af6c56f52628cca4cc5241c0f88adb9f689d)\r\n\r\nShould just call this argument `conflicted` or `is_conflicted`",
      "commit_id" : "e9ffced8bebe7451d5e8d97b5e88fbedb7675cc6",
      "created_at" : "2020-04-13T14:37:42Z",
      "diff_hunk" : "@@ -158,7 +158,7 @@ class NotificationsProxy : public CValidationInterface\n     {\n         m_notifications->transactionAddedToMempool(tx);\n     }\n-    void TransactionRemovedFromMempool(const CTransactionRef& tx) override\n+    void TransactionRemovedFromMempool(const CTransactionRef& tx, bool fIsConflicted) override",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r407511482",
      "id" : 407511482,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUxMTQ4Mg==",
      "original_commit_id" : "9eb9af6c56f52628cca4cc5241c0f88adb9f689d",
      "original_line" : 161,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.cpp",
      "position" : null,
      "pull_request_review_id" : 392185125,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-22T01:05:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407511482",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r407516183"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407516183"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[validationinterface] Extend TransactionRemovedFromMempool with fIsConflicted\" (9eb9af6c56f52628cca4cc5241c0f88adb9f689d)\r\n\r\nI'd think it'd be more straightforward to just pass along the reason instead of having the mempool interpret it on behalf of the wallet. But this is just a guess, and I think since @jnewbery proposed this, you both probably know the tradeoffs between `bool conflicted` and `MemPoolRemovalReason reason` better than me and this is probably fine",
      "commit_id" : "e9ffced8bebe7451d5e8d97b5e88fbedb7675cc6",
      "created_at" : "2020-04-13T14:46:53Z",
      "diff_hunk" : "@@ -410,7 +410,8 @@ void CTxMemPool::removeUnchecked(txiter it, MemPoolRemovalReason reason)\n         // for any reason except being included in a block. Clients interested\n         // in transactions included in blocks can subscribe to the BlockConnected\n         // notification.\n-        GetMainSignals().TransactionRemovedFromMempool(it->GetSharedTx());\n+        GetMainSignals().TransactionRemovedFromMempool(it->GetSharedTx(), reason == MemPoolRemovalReason::CONFLICT",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r407516183",
      "id" : 407516183,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUxNjE4Mw==",
      "original_commit_id" : "9eb9af6c56f52628cca4cc5241c0f88adb9f689d",
      "original_line" : 413,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 392185125,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-22T01:05:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407516183",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r407544261"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407544261"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "In commit \"[rpcwallet] Add `conflicted` as transaction description field\" (1af561a8f2bc93ac029b7304fb6da12e6094b860)\r\n\r\nI think this should probably be Status::UNCONFIRMED rather than Status::CONFLICTED. That should restore the original behavior before #16624 (a31be09bfd77eed497a8e251d31358e16e2f2eb1 +   7e89994133725125dddbfa8d45484e3b9ed51c6e) and avoid introducing an entirely new transaction state that wallet code has never had to deal with, where a transaction is conflicting with something not in a specific block. This should also allow reverting `GetDepthInMainChain` below and leaving it unchanged.\r\n\r\nAt a high level I think it makes sense to mark these transactions unconfirmed instead of conflicted because we know there are cases the wallet can't detect unconfirmed transactions becoming conflicted, and cases where it can't detect a conflicting transactions becoming unconfirmed, and unconfirmed is the more conservative choice than conflicted for balances, etc\r\n\r\nI haven't looked at your `wallet_txn_doublespend.py` test yet, so I'm not sure how changing this would interact that. Another way of testing this code which might be better from the point of view of #18600 is to add a regression test to `feature_notifications.py` to ensure that this commit restores the `-walletnotify` notifications that were lost in #16624",
      "commit_id" : "e9ffced8bebe7451d5e8d97b5e88fbedb7675cc6",
      "created_at" : "2020-04-13T15:39:10Z",
      "diff_hunk" : "@@ -1105,12 +1105,16 @@ void CWallet::transactionAddedToMempool(const CTransactionRef& ptx) {\n     }\n }\n \n-void CWallet::transactionRemovedFromMempool(const CTransactionRef &ptx) {\n+void CWallet::transactionRemovedFromMempool(const CTransactionRef &ptx, bool fIsConflicted) {\n     LOCK(cs_wallet);\n     auto it = mapWallet.find(ptx->GetHash());\n     if (it != mapWallet.end()) {\n         it->second.fInMempool = false;\n     }\n+    if (fIsConflicted) {\n+        CWalletTx::Confirmation confirm(CWalletTx::Status::CONFLICTED, /* block_height */ 0, /* block_hash */ {}, /* nIndex */ 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r407544261",
      "id" : 407544261,
      "line" : 1118,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU0NDI2MQ==",
      "original_commit_id" : "497c50205534aa32931a048d02a3a2004460fe64",
      "original_line" : 1118,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 21,
      "pull_request_review_id" : 392185125,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-22T01:05:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407544261",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r407550301"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407550301"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Maybe even just pass the original removal reason to the sink? Compressing `REPLACED` into a boolean called `conflicted` is not wrong, but maybe not the most straightforward either.",
      "commit_id" : "e9ffced8bebe7451d5e8d97b5e88fbedb7675cc6",
      "created_at" : "2020-04-13T15:50:34Z",
      "diff_hunk" : "@@ -158,7 +158,7 @@ class NotificationsProxy : public CValidationInterface\n     {\n         m_notifications->transactionAddedToMempool(tx);\n     }\n-    void TransactionRemovedFromMempool(const CTransactionRef& tx) override\n+    void TransactionRemovedFromMempool(const CTransactionRef& tx, bool fIsConflicted) override",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r407550301",
      "id" : 407550301,
      "in_reply_to_id" : 407511482,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU1MDMwMQ==",
      "original_commit_id" : "9eb9af6c56f52628cca4cc5241c0f88adb9f689d",
      "original_line" : 161,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.cpp",
      "position" : null,
      "pull_request_review_id" : 392232926,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-22T01:05:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407550301",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r407555257"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407555257"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Some comments might be better as log statements, to aid debugability. See https://github.com/bitcoin/bitcoin/tree/master/test/functional#general-test-writing-advice\r\n```suggestion\r\n        self.log.info('Verify node0 sees children as conflicted')\r\n```",
      "commit_id" : "e9ffced8bebe7451d5e8d97b5e88fbedb7675cc6",
      "created_at" : "2020-04-13T15:59:29Z",
      "diff_hunk" : "@@ -139,5 +140,99 @@ def run_test(self):\n         # Node1's balance should be its initial balance (1250 for 25 block rewards) plus the doublespend:\n         assert_equal(self.nodes[1].getbalance(), 1250 + 1240)\n \n+        # Following test limb check that if a transaction of concern conflicted due to its parent\n+        # or anterior transaction being conflicted, wallet is able to detect it, independently of\n+        # reason (either block or mempool)\n+\n+        # Get a \"blind\" address from node0\n+        connect_nodes(self.nodes[0], 1)\n+        node0_address_blind = self.nodes[0].getnewaddress()\n+        txid_origin = self.nodes[1].sendtoaddress(self.nodes[1].getnewaddress(), Decimal(\"10\"))\n+        self.nodes[1].generate(1)\n+        self.sync_blocks([self.nodes[0], self.nodes[1]])\n+\n+        # Build parent conflicted tx from node1 to node1\n+        nA = next(tx_out[\"vout\"] for tx_out in self.nodes[1].gettransaction(txid_origin)[\"details\"] if tx_out[\"amount\"] == Decimal(\"10\"))\n+        inputs_parent_conflicted_tx = []\n+        inputs_parent_conflicted_tx.append({\"txid\": txid_origin, \"vout\": nA, \"sequence\": BIP125_SEQUENCE_NUMBER})\n+        outputs_parent_conflicted_tx = {}\n+        outputs_parent_conflicted_tx[self.nodes[1].getnewaddress()] = Decimal(\"9.99998\")\n+\n+        # Broadcast parent conflicted tx\n+        parent_conflicted_tx = self.nodes[1].signrawtransactionwithwallet(self.nodes[1].createrawtransaction(inputs_parent_conflicted_tx, outputs_parent_conflicted_tx))\n+        parent_conflicted_txid = self.nodes[1].sendrawtransaction(parent_conflicted_tx[\"hex\"])\n+\n+        # Build children conflicted tx\n+        inputs_children_conflicted_tx = []\n+        inputs_children_conflicted_tx.append({\"txid\": parent_conflicted_txid, \"vout\": 0})\n+        outputs_children_conflicted_tx = {}\n+        outputs_children_conflicted_tx[node0_address_blind] = Decimal(\"9.99996\")\n+\n+        #Broadcast children conflicted tx\n+        node1s_children_conflicted_tx = self.nodes[1].signrawtransactionwithwallet(self.nodes[1].createrawtransaction(inputs_children_conflicted_tx, outputs_children_conflicted_tx))\n+        children_conflicted_txid = self.nodes[1].sendrawtransaction(node1s_children_conflicted_tx[\"hex\"])\n+        self.sync_mempools([self.nodes[0], self.nodes[1]])\n+\n+        # Verify node0 sees conflicted paying back\n+        node0s_children_conflicted_tx = self.nodes[0].gettransaction(children_conflicted_txid)\n+\n+        assert_equal(node0s_children_conflicted_tx[\"confirmations\"], 0)\n+        assert_equal(node0s_children_conflicted_tx[\"details\"][0][\"category\"], \"receive\")\n+\n+        # Build conflicting tx, double-spending parent conflicted\n+        inputs_conflicting_tx = []\n+        inputs_conflicting_tx.append({\"txid\": txid_origin, \"vout\": nA})\n+        outputs_conflicting_tx = {}\n+        outputs_conflicting_tx[self.nodes[1].getnewaddress()] = Decimal(\"9.99980\")\n+\n+        # Broadcast conflicting tx to node1 mempool and generate a block\n+        conflicting_tx= self.nodes[1].signrawtransactionwithwallet(self.nodes[1].createrawtransaction(inputs_conflicting_tx, outputs_conflicting_tx))\n+        conflicting_txid = self.nodes[1].sendrawtransaction(conflicting_tx[\"hex\"])\n+        self.nodes[1].generate(1)\n+        self.sync_blocks([self.nodes[0], self.nodes[1]])\n+\n+        # Verify node0 sees children as conflicted",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r407555257",
      "id" : 407555257,
      "line" : 195,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzU1NTI1Nw==",
      "original_commit_id" : "b34318d4cc27d61d2b9cc6a97c9584eb0dada6e4",
      "original_line" : 195,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "test/functional/wallet_txn_doublespend.py",
      "position" : 64,
      "pull_request_review_id" : 392239037,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-22T01:05:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407555257",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r407937260"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407937260"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Yes I hesitated at first to call it is_conflicted but it's still an implementation of a `CValidationInterface`  method so `fIsConflicted` is more reasonable so `is_ibd` should be `fInitialDownload` ?\r\n\r\n@MarcoFalke, you suggest doing the filtering in `NotificationsProxy` ? Shouldn't this be as lean as possible and just call notifications handler ? My motivation was avoiding linking mempool code in wallet but didn't think specifically about this point.",
      "commit_id" : "e9ffced8bebe7451d5e8d97b5e88fbedb7675cc6",
      "created_at" : "2020-04-14T07:55:20Z",
      "diff_hunk" : "@@ -158,7 +158,7 @@ class NotificationsProxy : public CValidationInterface\n     {\n         m_notifications->transactionAddedToMempool(tx);\n     }\n-    void TransactionRemovedFromMempool(const CTransactionRef& tx) override\n+    void TransactionRemovedFromMempool(const CTransactionRef& tx, bool fIsConflicted) override",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r407937260",
      "id" : 407937260,
      "in_reply_to_id" : 407511482,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzkzNzI2MA==",
      "original_commit_id" : "9eb9af6c56f52628cca4cc5241c0f88adb9f689d",
      "original_line" : 161,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.cpp",
      "position" : null,
      "pull_request_review_id" : 392685713,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-22T01:05:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407937260",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r407944782"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407944782"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "See above, on the practical-side I wanted to avoid linking mempool code in wallet. But we can overcome this, so real question, above fixing behavior, is if we pass `EXPIRY` or `SIZELIMIT` to the wallet, does it going to adapt its broadcast on this or take any other action ?\r\n\r\nRight now I think the wallet doesn't have any code to do this, so I think the discussion is worthwhile but beyond this PR ?\r\n\r\nActually, digging into this,  `MemPoolRemovalReason` purpose seems weak right now because we only use it in `removeUnchecked` to decide if we should trigger `TransactionsRemovedFromMempool` ?",
      "commit_id" : "e9ffced8bebe7451d5e8d97b5e88fbedb7675cc6",
      "created_at" : "2020-04-14T08:07:56Z",
      "diff_hunk" : "@@ -410,7 +410,8 @@ void CTxMemPool::removeUnchecked(txiter it, MemPoolRemovalReason reason)\n         // for any reason except being included in a block. Clients interested\n         // in transactions included in blocks can subscribe to the BlockConnected\n         // notification.\n-        GetMainSignals().TransactionRemovedFromMempool(it->GetSharedTx());\n+        GetMainSignals().TransactionRemovedFromMempool(it->GetSharedTx(), reason == MemPoolRemovalReason::CONFLICT",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r407944782",
      "id" : 407944782,
      "in_reply_to_id" : 407516183,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk0NDc4Mg==",
      "original_commit_id" : "9eb9af6c56f52628cca4cc5241c0f88adb9f689d",
      "original_line" : 413,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 392694942,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-22T01:05:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407944782",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r407954092"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407954092"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Thanks for your comment, I didn't reverse to the previous behavior starting from the user viewpoint. Unconfirmed funds allow you to spend from then or consider likely-yours as part of your balance, but here we know, as of mempool state, they are conflicted and likely-but-not-certain not going to confirm. We don't want the user to take decisions based on funds he has not. You can spend from unconfirmed, right ? \r\n\r\nKnowing there are cases the wallet can't detect unconfirmed transactions becoming conflicted doesn't mean that when we have the information available we shouldn't act on this.\r\n\r\nThanks for `feature_notifications.py`, we will modify to test notifications, didn't know its existence.",
      "commit_id" : "e9ffced8bebe7451d5e8d97b5e88fbedb7675cc6",
      "created_at" : "2020-04-14T08:23:21Z",
      "diff_hunk" : "@@ -1105,12 +1105,16 @@ void CWallet::transactionAddedToMempool(const CTransactionRef& ptx) {\n     }\n }\n \n-void CWallet::transactionRemovedFromMempool(const CTransactionRef &ptx) {\n+void CWallet::transactionRemovedFromMempool(const CTransactionRef &ptx, bool fIsConflicted) {\n     LOCK(cs_wallet);\n     auto it = mapWallet.find(ptx->GetHash());\n     if (it != mapWallet.end()) {\n         it->second.fInMempool = false;\n     }\n+    if (fIsConflicted) {\n+        CWalletTx::Confirmation confirm(CWalletTx::Status::CONFLICTED, /* block_height */ 0, /* block_hash */ {}, /* nIndex */ 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r407954092",
      "id" : 407954092,
      "in_reply_to_id" : 407544261,
      "line" : 1118,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk1NDA5Mg==",
      "original_commit_id" : "497c50205534aa32931a048d02a3a2004460fe64",
      "original_line" : 1118,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 21,
      "pull_request_review_id" : 392706560,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-22T01:05:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407954092",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r407959639"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407959639"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "Can I turn every new comment as a log ? That would my personal flavor but that's hard to judge if it suits everyone. In practice, this advice maybe a bit loosely, I expect anyone to tweak tests as wish for debugging, that's easy and you may not want to observe same thing for everyone. ",
      "commit_id" : "e9ffced8bebe7451d5e8d97b5e88fbedb7675cc6",
      "created_at" : "2020-04-14T08:32:18Z",
      "diff_hunk" : "@@ -139,5 +140,99 @@ def run_test(self):\n         # Node1's balance should be its initial balance (1250 for 25 block rewards) plus the doublespend:\n         assert_equal(self.nodes[1].getbalance(), 1250 + 1240)\n \n+        # Following test limb check that if a transaction of concern conflicted due to its parent\n+        # or anterior transaction being conflicted, wallet is able to detect it, independently of\n+        # reason (either block or mempool)\n+\n+        # Get a \"blind\" address from node0\n+        connect_nodes(self.nodes[0], 1)\n+        node0_address_blind = self.nodes[0].getnewaddress()\n+        txid_origin = self.nodes[1].sendtoaddress(self.nodes[1].getnewaddress(), Decimal(\"10\"))\n+        self.nodes[1].generate(1)\n+        self.sync_blocks([self.nodes[0], self.nodes[1]])\n+\n+        # Build parent conflicted tx from node1 to node1\n+        nA = next(tx_out[\"vout\"] for tx_out in self.nodes[1].gettransaction(txid_origin)[\"details\"] if tx_out[\"amount\"] == Decimal(\"10\"))\n+        inputs_parent_conflicted_tx = []\n+        inputs_parent_conflicted_tx.append({\"txid\": txid_origin, \"vout\": nA, \"sequence\": BIP125_SEQUENCE_NUMBER})\n+        outputs_parent_conflicted_tx = {}\n+        outputs_parent_conflicted_tx[self.nodes[1].getnewaddress()] = Decimal(\"9.99998\")\n+\n+        # Broadcast parent conflicted tx\n+        parent_conflicted_tx = self.nodes[1].signrawtransactionwithwallet(self.nodes[1].createrawtransaction(inputs_parent_conflicted_tx, outputs_parent_conflicted_tx))\n+        parent_conflicted_txid = self.nodes[1].sendrawtransaction(parent_conflicted_tx[\"hex\"])\n+\n+        # Build children conflicted tx\n+        inputs_children_conflicted_tx = []\n+        inputs_children_conflicted_tx.append({\"txid\": parent_conflicted_txid, \"vout\": 0})\n+        outputs_children_conflicted_tx = {}\n+        outputs_children_conflicted_tx[node0_address_blind] = Decimal(\"9.99996\")\n+\n+        #Broadcast children conflicted tx\n+        node1s_children_conflicted_tx = self.nodes[1].signrawtransactionwithwallet(self.nodes[1].createrawtransaction(inputs_children_conflicted_tx, outputs_children_conflicted_tx))\n+        children_conflicted_txid = self.nodes[1].sendrawtransaction(node1s_children_conflicted_tx[\"hex\"])\n+        self.sync_mempools([self.nodes[0], self.nodes[1]])\n+\n+        # Verify node0 sees conflicted paying back\n+        node0s_children_conflicted_tx = self.nodes[0].gettransaction(children_conflicted_txid)\n+\n+        assert_equal(node0s_children_conflicted_tx[\"confirmations\"], 0)\n+        assert_equal(node0s_children_conflicted_tx[\"details\"][0][\"category\"], \"receive\")\n+\n+        # Build conflicting tx, double-spending parent conflicted\n+        inputs_conflicting_tx = []\n+        inputs_conflicting_tx.append({\"txid\": txid_origin, \"vout\": nA})\n+        outputs_conflicting_tx = {}\n+        outputs_conflicting_tx[self.nodes[1].getnewaddress()] = Decimal(\"9.99980\")\n+\n+        # Broadcast conflicting tx to node1 mempool and generate a block\n+        conflicting_tx= self.nodes[1].signrawtransactionwithwallet(self.nodes[1].createrawtransaction(inputs_conflicting_tx, outputs_conflicting_tx))\n+        conflicting_txid = self.nodes[1].sendrawtransaction(conflicting_tx[\"hex\"])\n+        self.nodes[1].generate(1)\n+        self.sync_blocks([self.nodes[0], self.nodes[1]])\n+\n+        # Verify node0 sees children as conflicted",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r407959639",
      "id" : 407959639,
      "in_reply_to_id" : 407555257,
      "line" : 195,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk1OTYzOQ==",
      "original_commit_id" : "b34318d4cc27d61d2b9cc6a97c9584eb0dada6e4",
      "original_line" : 195,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "test/functional/wallet_txn_doublespend.py",
      "position" : 64,
      "pull_request_review_id" : 392713214,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-22T01:05:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407959639",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r408063282"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/408063282"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I don't think you need to link any mempool code when you want access to the enum RemovalReason in the wallet.\r\n\r\nRight? cc @ryanofsky ",
      "commit_id" : "e9ffced8bebe7451d5e8d97b5e88fbedb7675cc6",
      "created_at" : "2020-04-14T11:27:06Z",
      "diff_hunk" : "@@ -158,7 +158,7 @@ class NotificationsProxy : public CValidationInterface\n     {\n         m_notifications->transactionAddedToMempool(tx);\n     }\n-    void TransactionRemovedFromMempool(const CTransactionRef& tx) override\n+    void TransactionRemovedFromMempool(const CTransactionRef& tx, bool fIsConflicted) override",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r408063282",
      "id" : 408063282,
      "in_reply_to_id" : 407511482,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA2MzI4Mg==",
      "original_commit_id" : "9eb9af6c56f52628cca4cc5241c0f88adb9f689d",
      "original_line" : 161,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.cpp",
      "position" : null,
      "pull_request_review_id" : 392836910,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-22T01:05:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/408063282",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r408064561"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/408064561"
         }
      },
      "author_association" : "MEMBER",
      "body" : "I mean mostly for the comments that start a new \"section\" or \"paragraph\" or subtest/test case. In the failing logs you could then easily identify when the new test section begins.",
      "commit_id" : "e9ffced8bebe7451d5e8d97b5e88fbedb7675cc6",
      "created_at" : "2020-04-14T11:29:34Z",
      "diff_hunk" : "@@ -139,5 +140,99 @@ def run_test(self):\n         # Node1's balance should be its initial balance (1250 for 25 block rewards) plus the doublespend:\n         assert_equal(self.nodes[1].getbalance(), 1250 + 1240)\n \n+        # Following test limb check that if a transaction of concern conflicted due to its parent\n+        # or anterior transaction being conflicted, wallet is able to detect it, independently of\n+        # reason (either block or mempool)\n+\n+        # Get a \"blind\" address from node0\n+        connect_nodes(self.nodes[0], 1)\n+        node0_address_blind = self.nodes[0].getnewaddress()\n+        txid_origin = self.nodes[1].sendtoaddress(self.nodes[1].getnewaddress(), Decimal(\"10\"))\n+        self.nodes[1].generate(1)\n+        self.sync_blocks([self.nodes[0], self.nodes[1]])\n+\n+        # Build parent conflicted tx from node1 to node1\n+        nA = next(tx_out[\"vout\"] for tx_out in self.nodes[1].gettransaction(txid_origin)[\"details\"] if tx_out[\"amount\"] == Decimal(\"10\"))\n+        inputs_parent_conflicted_tx = []\n+        inputs_parent_conflicted_tx.append({\"txid\": txid_origin, \"vout\": nA, \"sequence\": BIP125_SEQUENCE_NUMBER})\n+        outputs_parent_conflicted_tx = {}\n+        outputs_parent_conflicted_tx[self.nodes[1].getnewaddress()] = Decimal(\"9.99998\")\n+\n+        # Broadcast parent conflicted tx\n+        parent_conflicted_tx = self.nodes[1].signrawtransactionwithwallet(self.nodes[1].createrawtransaction(inputs_parent_conflicted_tx, outputs_parent_conflicted_tx))\n+        parent_conflicted_txid = self.nodes[1].sendrawtransaction(parent_conflicted_tx[\"hex\"])\n+\n+        # Build children conflicted tx\n+        inputs_children_conflicted_tx = []\n+        inputs_children_conflicted_tx.append({\"txid\": parent_conflicted_txid, \"vout\": 0})\n+        outputs_children_conflicted_tx = {}\n+        outputs_children_conflicted_tx[node0_address_blind] = Decimal(\"9.99996\")\n+\n+        #Broadcast children conflicted tx\n+        node1s_children_conflicted_tx = self.nodes[1].signrawtransactionwithwallet(self.nodes[1].createrawtransaction(inputs_children_conflicted_tx, outputs_children_conflicted_tx))\n+        children_conflicted_txid = self.nodes[1].sendrawtransaction(node1s_children_conflicted_tx[\"hex\"])\n+        self.sync_mempools([self.nodes[0], self.nodes[1]])\n+\n+        # Verify node0 sees conflicted paying back\n+        node0s_children_conflicted_tx = self.nodes[0].gettransaction(children_conflicted_txid)\n+\n+        assert_equal(node0s_children_conflicted_tx[\"confirmations\"], 0)\n+        assert_equal(node0s_children_conflicted_tx[\"details\"][0][\"category\"], \"receive\")\n+\n+        # Build conflicting tx, double-spending parent conflicted\n+        inputs_conflicting_tx = []\n+        inputs_conflicting_tx.append({\"txid\": txid_origin, \"vout\": nA})\n+        outputs_conflicting_tx = {}\n+        outputs_conflicting_tx[self.nodes[1].getnewaddress()] = Decimal(\"9.99980\")\n+\n+        # Broadcast conflicting tx to node1 mempool and generate a block\n+        conflicting_tx= self.nodes[1].signrawtransactionwithwallet(self.nodes[1].createrawtransaction(inputs_conflicting_tx, outputs_conflicting_tx))\n+        conflicting_txid = self.nodes[1].sendrawtransaction(conflicting_tx[\"hex\"])\n+        self.nodes[1].generate(1)\n+        self.sync_blocks([self.nodes[0], self.nodes[1]])\n+\n+        # Verify node0 sees children as conflicted",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r408064561",
      "id" : 408064561,
      "in_reply_to_id" : 407555257,
      "line" : 195,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA2NDU2MQ==",
      "original_commit_id" : "b34318d4cc27d61d2b9cc6a97c9584eb0dada6e4",
      "original_line" : 195,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "test/functional/wallet_txn_doublespend.py",
      "position" : 64,
      "pull_request_review_id" : 392838450,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-22T01:05:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/408064561",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-04-14T12:10:19Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#issuecomment-613405605",
      "id" : 613405605,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18600",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxMzQwNTYwNQ==",
      "updated_at" : "2020-04-14T12:10:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/613405605",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r408516146"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/408516146"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/18600#discussion_r407937260\r\n\r\n> Yes I hesitated at first to call it is_conflicted but it's still an implementation of a `CValidationInterface` method so `fIsConflicted` is more reasonable so `is_ibd` should be `fInitialDownload` ?\r\n\r\nJust following the naming conventions is \"[preferred in new code](https://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md)\". We try to take a long term view. Eventually things will be updated to follow the conventions, and following them when it's possible and the cost is low helps get there quicker.\r\n\r\n> @MarcoFalke, you suggest doing the filtering in `NotificationsProxy` ? Shouldn't this be as lean as possible and just call notifications handler ? My motivation was avoiding linking mempool code in wallet but didn't think specifically about this point.\r\n\r\nWould worry more about semantics than linking here. Link errors are easy to detect and fix. An ambiguous API can lead to confusion and bugs and workarounds that never fix the original problem. If it makes semantic sense for the mempool to have different definitions of \"conflicted\" internally and externally and to translate reason == CONFLICT or reason == REPLACED to conflicted == true, then this is API is fine. If it makes more sense to use consistent reason codes everywhere, this should just pass the codes.\r\n\r\nIn terms of building and linking, it's fine for wallet code to include txmempool.h and share the enum data type. Linker will only complain if the wallet is calling mempool functions. `src/interfaces` code could forward declare `enum class MemPoolRemovalReason;` for now, and longer term if the interface stabilizes the actual enum definition could move there.",
      "commit_id" : "e9ffced8bebe7451d5e8d97b5e88fbedb7675cc6",
      "created_at" : "2020-04-15T00:42:58Z",
      "diff_hunk" : "@@ -158,7 +158,7 @@ class NotificationsProxy : public CValidationInterface\n     {\n         m_notifications->transactionAddedToMempool(tx);\n     }\n-    void TransactionRemovedFromMempool(const CTransactionRef& tx) override\n+    void TransactionRemovedFromMempool(const CTransactionRef& tx, bool fIsConflicted) override",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r408516146",
      "id" : 408516146,
      "in_reply_to_id" : 407511482,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUxNjE0Ng==",
      "original_commit_id" : "9eb9af6c56f52628cca4cc5241c0f88adb9f689d",
      "original_line" : 161,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.cpp",
      "position" : null,
      "pull_request_review_id" : 393386277,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-22T01:05:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/408516146",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r408516222"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/408516222"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/18600#discussion_r407954092\r\n\r\n> Thanks for your comment, I didn't reverse to the previous behavior starting from the user viewpoint. Unconfirmed funds allow you to spend from then or consider likely-yours as part of your balance, but here we know, as of mempool state, they are conflicted and likely-but-not-certain not going to confirm. We don't want the user to take decisions based on funds he has not. You can spend from unconfirmed, right ?\r\n> \r\n> Knowing there are cases the wallet can't detect unconfirmed transactions becoming conflicted doesn't mean that when we have the information available we shouldn't act on this.\r\n> \r\n> Thanks for `feature_notifications.py`, we will modify to test notifications, didn't know its existence.\r\n\r\nI think you can't generally spend from unconfirmed transactions unless the transaction is \"trusted\" (coming from you), in which case the normal wallet conflict detection should work. So I don't think there's a strong rationale for introducing new behavior and a new transaction state instead of just fixing the bug more simply and restoring previous behavior.\r\n\r\nI'm also not sure the change to `GetDepthInMainChain` is sufficient to handle the new conflicted state. For example in `LoadToWallet` I see\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/4d793bcfe81479d1bf34805c3960c4611eb8fc9b/src/wallet/wallet.cpp#L907-L909\r\n\r\nIs this going to work correctly when `m_confirm.hashBlock` is null, or does it need to be updated too? If `GetDepthInMainChain` and `LoadToWallet` have to be updated to deal with the new state, and these transactions are serialized to wallet files, what happens if the wallets are loaded by older wallet software? Will 0.20 and 0.19 `GetDepthInMainChain` and `LoadToWallet` implementations handle the new state correctly without bugs and crashes?",
      "commit_id" : "e9ffced8bebe7451d5e8d97b5e88fbedb7675cc6",
      "created_at" : "2020-04-15T00:43:14Z",
      "diff_hunk" : "@@ -1105,12 +1105,16 @@ void CWallet::transactionAddedToMempool(const CTransactionRef& ptx) {\n     }\n }\n \n-void CWallet::transactionRemovedFromMempool(const CTransactionRef &ptx) {\n+void CWallet::transactionRemovedFromMempool(const CTransactionRef &ptx, bool fIsConflicted) {\n     LOCK(cs_wallet);\n     auto it = mapWallet.find(ptx->GetHash());\n     if (it != mapWallet.end()) {\n         it->second.fInMempool = false;\n     }\n+    if (fIsConflicted) {\n+        CWalletTx::Confirmation confirm(CWalletTx::Status::CONFLICTED, /* block_height */ 0, /* block_hash */ {}, /* nIndex */ 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r408516222",
      "id" : 408516222,
      "in_reply_to_id" : 407544261,
      "line" : 1118,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODUxNjIyMg==",
      "original_commit_id" : "497c50205534aa32931a048d02a3a2004460fe64",
      "original_line" : 1118,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 21,
      "pull_request_review_id" : 393386277,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-22T01:05:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/408516222",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r412587833"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/412587833"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : " > avoid introducing an entirely new transaction state that wallet code has never had to deal with, where a transaction is conflicting with something not in a specific block.\r\n\r\nAh sorry reading this again, in fact in `transactionRemovedFromMempool` you may have case of transaction block conflicted but not covered by `BlockConnected` due to the conflicting transaction not involving us. \r\n\r\nLike unconfirmed txA spent by unconfirmed txB, txB paying a wallet address. txA is conflicted by txA' in a block, we won't see it in BlockConnected right now.\r\n\r\nSo this PR restores UI notifications and _extend_ scope of block conflicted transactions in the lightweight way I think. Detecting them at block connection is not possible without tracking whole chain of unconfirmed transactions AFAICT.\r\n\r\n> Is this going to work correctly when m_confirm.hashBlock is null, or does it need to be updated too?\r\n\r\nChild conflicted transactions is going to inherit `m_confirm.hashBlock` null from parent.\r\n\r\n>  If GetDepthInMainChain and LoadToWallet have to be updated to deal with the new state, and these transactions are serialized to wallet files, what happens if the wallets are loaded by older wallet software?\r\n\r\nIt's not a new state, as `Confirmation::Status::CONFLICTED\" is already there. I think what matters is among `CONFLICTED` transactions is there any code path relying on `hashBlock` or `block_height`, beyond display code, there is `MarkConflicted` to keep track of the most conflicting code and `GetDepthInMainChain` ofc. \r\n\r\n> Will 0.20 and 0.19 GetDepthInMainChain and LoadToWallet implementations handle the new state correctly without bugs and crashes?\r\n\r\nAs said previously, it's not a new state, and you already have of course `UNCONFIRMED` with null hash and zero-height on which current serialization/deserialization logic relies on : https://github.com/bitcoin/bitcoin/blob/b6a5dc90bfd4640cf9f914e59bf8e21cd265b51e/src/wallet/wallet.h#L434\r\n\r\nTrying to go forward, I think best would be to pass block height and hash in `transactionsRemovedFromMempool` even if it  seems counter-intuitive, for block conflicting transaction we do have a block height/hash. \r\n\r\nWhat do you think ? ",
      "commit_id" : "e9ffced8bebe7451d5e8d97b5e88fbedb7675cc6",
      "created_at" : "2020-04-22T00:44:23Z",
      "diff_hunk" : "@@ -1105,12 +1105,16 @@ void CWallet::transactionAddedToMempool(const CTransactionRef& ptx) {\n     }\n }\n \n-void CWallet::transactionRemovedFromMempool(const CTransactionRef &ptx) {\n+void CWallet::transactionRemovedFromMempool(const CTransactionRef &ptx, bool fIsConflicted) {\n     LOCK(cs_wallet);\n     auto it = mapWallet.find(ptx->GetHash());\n     if (it != mapWallet.end()) {\n         it->second.fInMempool = false;\n     }\n+    if (fIsConflicted) {\n+        CWalletTx::Confirmation confirm(CWalletTx::Status::CONFLICTED, /* block_height */ 0, /* block_hash */ {}, /* nIndex */ 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r412587833",
      "id" : 412587833,
      "in_reply_to_id" : 407544261,
      "line" : 1118,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU4NzgzMw==",
      "original_commit_id" : "497c50205534aa32931a048d02a3a2004460fe64",
      "original_line" : 1118,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 21,
      "pull_request_review_id" : 397768492,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-22T01:05:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/412587833",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r412589720"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/412589720"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "I restrained conflict to block only, not including anymore mempool replacement which means API is far-more straightforward as wallet conflict == mempool conflict.\r\n\r\nIf we really  want to use consistent reason codes among clients, we may pull them out of txmempool.h in some node/*.h ?",
      "commit_id" : "e9ffced8bebe7451d5e8d97b5e88fbedb7675cc6",
      "created_at" : "2020-04-22T00:50:12Z",
      "diff_hunk" : "@@ -158,7 +158,7 @@ class NotificationsProxy : public CValidationInterface\n     {\n         m_notifications->transactionAddedToMempool(tx);\n     }\n-    void TransactionRemovedFromMempool(const CTransactionRef& tx) override\n+    void TransactionRemovedFromMempool(const CTransactionRef& tx, bool fIsConflicted) override",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r412589720",
      "id" : 412589720,
      "in_reply_to_id" : 407511482,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjU4OTcyMA==",
      "original_commit_id" : "9eb9af6c56f52628cca4cc5241c0f88adb9f689d",
      "original_line" : 161,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.cpp",
      "position" : null,
      "pull_request_review_id" : 397770164,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-04-22T01:05:29Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/412589720",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Rebased with few comments addressed.\r\n\r\nI hear you on this https://github.com/bitcoin/bitcoin/pull/18600#discussion_r412587833 @ryanofsky, I may have to pass down block height/hash through mempool code but at least that would make reasoning the same than it is today for `CONFLICTED` state.\r\n\r\nI also know you're not a great fan of these states, IMO I find pretty nice to have well-defined states for wallet transactions and grepp'ing for `is*`/`set*` to know state transitions, but I agree too we may refine them to only `UNCONFIRMED/CONFIRMED`, conflicting is a per-input problem stricto sensu but I think that's outside PR scope ?\r\n\r\nI also dropped mempool replacement considered as conflict in wallet code as it was controversial.",
      "created_at" : "2020-04-22T01:05:44Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#issuecomment-617487831",
      "id" : 617487831,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18600",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNzQ4NzgzMQ==",
      "updated_at" : "2020-04-22T01:05:44Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/617487831",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I also know you're not a great fan of these states, IMO I find pretty nice to have well-defined states for wallet transactions and grepp'ing for `is*`/`set*` to know state transitions, but I agree too we may refine them to only `UNCONFIRMED/CONFIRMED`, conflicting is a per-input problem stricto sensu but I think that's outside PR scope ?\r\n\r\nI need to catch up on the newest comments and changes, but I think it'd be great to improve state tracking in the ways you're suggesting, and I think #16624 was a big code improvement. I was just expecting this PR to be smaller and to just restore previous notification behavior, fixing the regression instead of doing bigger things in ways that looked like they could affect backwards compatibility.\r\n\r\nIn the end since the wallet has incomplete information, there probably isn't going to be an obviously ideal way to track states, and we'll need to consider a lot of individual use cases. I think the main goal should be eliminating cases where the wallet displays misleading information or forces users into workarounds like calling `abandontransaction`. Seeing specific test cases and examples that are improved will really help motivate future changes.",
      "created_at" : "2020-04-22T04:04:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#issuecomment-617536160",
      "id" : 617536160,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18600",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNzUzNjE2MA==",
      "updated_at" : "2020-04-22T04:04:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/617536160",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Tests fail",
      "created_at" : "2020-04-29T22:59:32Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#issuecomment-621512219",
      "id" : 621512219,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18600",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyMTUxMjIxOQ==",
      "updated_at" : "2020-04-29T22:59:32Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/621512219",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r420194547"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420194547"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/18600#discussion_r412589720\r\n\r\n> I restrained conflict to block only\r\n\r\nThanks, this seems ok now that the definition of conflicted here matches up with the MemPoolRemovalReason definition. I do think the API would be more useful and clear if it just passed the existing MemPoolRemovalReason value instead introducing a new way to communicate the same information. But thanks for resolving the original concern!\r\n\r\n> If we really want to use consistent reason codes among clients, we may pull them out of txmempool.h in some node/*.h ?\r\n\r\nI suggested moving it to `src/interfaces/` in https://github.com/bitcoin/bitcoin/pull/18600#discussion_r408516146 because `src/interfaces/` is meant to be a home for types used at the node/wallet boundary. But `src/node/` would be also ok, and leaving it in `txmempool.h` is perfectly fine. I would leave it in `txmempool.h` if using it in this PR, because this PR is already doing a lot of things. The current source code organization is not ideal and is gradually being improved, so design of the `interfaces::Chain::Notifications::transactionRemovedFromMempool` API shouldn't be decided based on what source file an enum definition is located in. The design should try to be useful and consistent and clear, and source code organization should follow the design instead of the other way around\r\n",
      "commit_id" : "e9ffced8bebe7451d5e8d97b5e88fbedb7675cc6",
      "created_at" : "2020-05-05T15:22:29Z",
      "diff_hunk" : "@@ -158,7 +158,7 @@ class NotificationsProxy : public CValidationInterface\n     {\n         m_notifications->transactionAddedToMempool(tx);\n     }\n-    void TransactionRemovedFromMempool(const CTransactionRef& tx) override\n+    void TransactionRemovedFromMempool(const CTransactionRef& tx, bool fIsConflicted) override",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r420194547",
      "id" : 420194547,
      "in_reply_to_id" : 407511482,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE5NDU0Nw==",
      "original_commit_id" : "9eb9af6c56f52628cca4cc5241c0f88adb9f689d",
      "original_line" : 161,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.cpp",
      "position" : null,
      "pull_request_review_id" : 405896365,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-05T15:22:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420194547",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r420195260"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420195260"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/18600#discussion_r407944782\r\n\r\n> Actually, digging into this, `MemPoolRemovalReason` purpose seems weak right now because we only use it in `removeUnchecked` to decide if we should trigger `TransactionsRemovedFromMempool` ?\r\n\r\nThis thread was continued https://github.com/bitcoin/bitcoin/pull/18600#discussion_r407550301 where Marco made a similar suggestion. But to respond to \"purpose seems weak\", the suggestion wasn't based on what wallet conflict tracking code is currently doing. Wallet conflict tracking has changed before and will likely change in the future. The suggestion to use the existing reason code was avoid to being inconsistent and confusing and avoid implementing wallet behavior outside of the wallet\r\n",
      "commit_id" : "e9ffced8bebe7451d5e8d97b5e88fbedb7675cc6",
      "created_at" : "2020-05-05T15:23:29Z",
      "diff_hunk" : "@@ -410,7 +410,8 @@ void CTxMemPool::removeUnchecked(txiter it, MemPoolRemovalReason reason)\n         // for any reason except being included in a block. Clients interested\n         // in transactions included in blocks can subscribe to the BlockConnected\n         // notification.\n-        GetMainSignals().TransactionRemovedFromMempool(it->GetSharedTx());\n+        GetMainSignals().TransactionRemovedFromMempool(it->GetSharedTx(), reason == MemPoolRemovalReason::CONFLICT",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r420195260",
      "id" : 420195260,
      "in_reply_to_id" : 407516183,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE5NTI2MA==",
      "original_commit_id" : "9eb9af6c56f52628cca4cc5241c0f88adb9f689d",
      "original_line" : 413,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/txmempool.cpp",
      "position" : null,
      "pull_request_review_id" : 405897274,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-05T15:23:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420195260",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r420195993"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420195993"
         }
      },
      "author_association" : "CONTRIBUTOR",
      "body" : "re: https://github.com/bitcoin/bitcoin/pull/18600#discussion_r412587833\r\n\r\n> It's not a new state\r\n\r\nThe new state which this writes is:\r\n\r\n| `uint256 hashBlock` | `int nIndex` | interpretation                             |\r\n|---------------------|--------------|--------------------------------------------|\r\n| 0                   | -1           | conflicted since #16624, unconfirmed prior |\r\n\r\nThe existing states written are:\r\n\r\n| `uint256 hashBlock` | `int nIndex` | interpretation                             |\r\n|---------------------|--------------|--------------------------------------------|\r\n| 0                   | 0            | unconfirmed                                |\r\n| >1                  | >=0          | confirmed                                  |\r\n| >1                  | -1           | conflicted since #7105, unconfirmed prior  |\r\n| 1                   | -1           | abandoned since #7312, unconfirmed prior   |\r\n\r\nNever written and still unused states are:\r\n\r\n| `uint256 hashBlock` | `int nIndex` | interpretation                             |\r\n|---------------------|--------------|--------------------------------------------|\r\n| 0                   | not 0 or -1  | unconfirmed                                |\r\n| 1                   | not -1       | abandoned between #7312 and #16624, unconfirmed before and after |\r\n| >1                  | <-1          | confirmed                                  |\r\n\r\nMaybe it's good to add a new state, or maybe it's bad, but it doesn't seem like enough thought has gone into it the decision so far. Looking at `CWalletTx::GetDepthInMainChain`, `CWallet::ComputeTimeSmart`, `CWallet::MarkConflicted` all of these methods seem broken by the new state. If I am reading correctly, GetDepthInMainChain will return large bogus negative height values, MarkConflicted 'more conflicted' check will start overwriting valid conflicted blocks with null conflict blocks, ComputeTimeSmart will logging spurious found in block not in index errors. Am I misreading the code in seeing these behaviors? Or do you see the same behaviors, but think side effects are minimal? Do you think existing 0.17, 0.18, 0.19 wallet code handles transactions in the new state safely?\r\n\r\n> Trying to go forward, I think best would be to pass block height and hash in `transactionsRemovedFromMempool`\r\n\r\nThis does seem like a safer way forward, and probably a good approach. Only caveat is the usual caveat with changing the wallet conflicted transaction heuristic: that if we start marking transactions conflicted instead of unconfirmed, the wallet can fail to notice them becoming unconfirmed again if they become unconflicted later. This should be less likely when the conflict is coming from a block transaction instead of a mempool transaction, but not certain. I think if we are going to change the heuristic, we can't just think about it abstractly. We should be looking at specific cases and trying to figure out if users are helped or hurt by the change in each case.",
      "commit_id" : "e9ffced8bebe7451d5e8d97b5e88fbedb7675cc6",
      "created_at" : "2020-05-05T15:24:30Z",
      "diff_hunk" : "@@ -1105,12 +1105,16 @@ void CWallet::transactionAddedToMempool(const CTransactionRef& ptx) {\n     }\n }\n \n-void CWallet::transactionRemovedFromMempool(const CTransactionRef &ptx) {\n+void CWallet::transactionRemovedFromMempool(const CTransactionRef &ptx, bool fIsConflicted) {\n     LOCK(cs_wallet);\n     auto it = mapWallet.find(ptx->GetHash());\n     if (it != mapWallet.end()) {\n         it->second.fInMempool = false;\n     }\n+    if (fIsConflicted) {\n+        CWalletTx::Confirmation confirm(CWalletTx::Status::CONFLICTED, /* block_height */ 0, /* block_hash */ {}, /* nIndex */ 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r420195993",
      "id" : 420195993,
      "in_reply_to_id" : 407544261,
      "line" : 1118,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE5NTk5Mw==",
      "original_commit_id" : "497c50205534aa32931a048d02a3a2004460fe64",
      "original_line" : 1118,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 21,
      "pull_request_review_id" : 405898189,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-05T18:20:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420195993",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Needs rebase due to conflict with #18878",
      "created_at" : "2020-05-13T14:31:22Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#issuecomment-628029131",
      "id" : 628029131,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18600",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyODAyOTEzMQ==",
      "updated_at" : "2020-05-13T14:31:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/628029131",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Needs rebase due to conflict with #18878\r\n\r\nChanges should be minor. Should just need to update lines like [`expect_wallet_notify([bump2])`](https://github.com/bitcoin/bitcoin/blob/51825aea7fa068877ea77e3121def58005df3510/test/functional/feature_notifications.py#L141) to `expect_wallet_notify([bump2, tx2])` for new transaction notifications",
      "created_at" : "2020-05-13T19:23:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#issuecomment-628196235",
      "id" : 628196235,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18600",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyODE5NjIzNQ==",
      "updated_at" : "2020-05-13T19:23:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/628196235",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Moved milestone as per https://github.com/bitcoin/bitcoin/issues/18325#issuecomment-629196468",
      "created_at" : "2020-05-15T12:04:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#issuecomment-629196900",
      "id" : 629196900,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18600",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYyOTE5NjkwMA==",
      "updated_at" : "2020-05-15T12:04:14Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/629196900",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r427776758"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427776758"
         }
      },
      "author_association" : "MEMBER",
      "body" : "Yes I agree on source code organization following the design. I think `MemPoolRemovalReason` may be dry-ed up in itself, IIRC it's not used beyond `::CONFLICTED`. But outside PR scope.",
      "commit_id" : "e9ffced8bebe7451d5e8d97b5e88fbedb7675cc6",
      "created_at" : "2020-05-20T06:46:49Z",
      "diff_hunk" : "@@ -158,7 +158,7 @@ class NotificationsProxy : public CValidationInterface\n     {\n         m_notifications->transactionAddedToMempool(tx);\n     }\n-    void TransactionRemovedFromMempool(const CTransactionRef& tx) override\n+    void TransactionRemovedFromMempool(const CTransactionRef& tx, bool fIsConflicted) override",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r427776758",
      "id" : 427776758,
      "in_reply_to_id" : 407511482,
      "line" : null,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc3Njc1OA==",
      "original_commit_id" : "9eb9af6c56f52628cca4cc5241c0f88adb9f689d",
      "original_line" : 161,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/interfaces/chain.cpp",
      "position" : null,
      "pull_request_review_id" : 415035617,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-20T06:46:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427776758",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r427784304"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427784304"
         }
      },
      "author_association" : "MEMBER",
      "body" : "You're right this approach by introducing a new state is broken. I think I've been confused by trying to solve #18325 and at same time try to harden conflict detection on non-connected wallet transaction.\r\n\r\nI think the safe approach is to pass block height and hash in `transactionsRemovedFromMempool` but in another PR to reason on its own.\r\n\r\nNote: IIRC we don't have undo conflict logic, that was the whole intent of https://github.com/bitcoin/bitcoin/pull/17543.",
      "commit_id" : "e9ffced8bebe7451d5e8d97b5e88fbedb7675cc6",
      "created_at" : "2020-05-20T07:03:24Z",
      "diff_hunk" : "@@ -1105,12 +1105,16 @@ void CWallet::transactionAddedToMempool(const CTransactionRef& ptx) {\n     }\n }\n \n-void CWallet::transactionRemovedFromMempool(const CTransactionRef &ptx) {\n+void CWallet::transactionRemovedFromMempool(const CTransactionRef &ptx, bool fIsConflicted) {\n     LOCK(cs_wallet);\n     auto it = mapWallet.find(ptx->GetHash());\n     if (it != mapWallet.end()) {\n         it->second.fInMempool = false;\n     }\n+    if (fIsConflicted) {\n+        CWalletTx::Confirmation confirm(CWalletTx::Status::CONFLICTED, /* block_height */ 0, /* block_hash */ {}, /* nIndex */ 0);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r427784304",
      "id" : 427784304,
      "in_reply_to_id" : 407544261,
      "line" : 1118,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzc4NDMwNA==",
      "original_commit_id" : "497c50205534aa32931a048d02a3a2004460fe64",
      "original_line" : 1118,
      "original_position" : 12,
      "original_start_line" : null,
      "path" : "src/wallet/wallet.cpp",
      "position" : 21,
      "pull_request_review_id" : 415045231,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-20T07:03:24Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/427784304",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@ryanofsky Finally getting back to this, \r\n\r\nAs of e9ffced, I think I removed 2) after this discussion https://github.com/bitcoin/bitcoin/pull/18600#discussion_r408516146.\r\n\r\nWith regards to (4) it's a direct dependency on (3), and used only to signal a 0-blockhash conflict to user. So dropping (3) would also drop (4). \r\n\r\nLooking on #18982 ",
      "created_at" : "2020-05-20T07:04:37Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#issuecomment-631279640",
      "id" : 631279640,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18600",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMTI3OTY0MA==",
      "updated_at" : "2020-05-20T07:04:37Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/631279640",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/23310655?v=4",
         "events_url" : "https://api.github.com/users/ariard/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ariard/followers",
         "following_url" : "https://api.github.com/users/ariard/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ariard/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ariard",
         "id" : 23310655,
         "login" : "ariard",
         "node_id" : "MDQ6VXNlcjIzMzEwNjU1",
         "organizations_url" : "https://api.github.com/users/ariard/orgs",
         "received_events_url" : "https://api.github.com/users/ariard/received_events",
         "repos_url" : "https://api.github.com/users/ariard/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ariard/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ariard/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ariard"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "re: ariard https://github.com/bitcoin/bitcoin/pull/18600#issuecomment-631279640\r\nre: ryanofsky https://github.com/bitcoin/bitcoin/pull/18600#pullrequestreview-405898189\r\n\r\n> As of [e9ffced](https://github.com/bitcoin/bitcoin/commit/e9ffced8bebe7451d5e8d97b5e88fbedb7675cc6), I think I removed 2) after this discussion [#18600 (comment)](https://github.com/bitcoin/bitcoin/pull/18600#discussion_r408516146).\r\n\r\nYes, good point. I didn't really internalize the changed definition of the conflicted bool (one reason I prefer the enum to the bool!) and I missed this.\r\n\r\nI actually think it'd be good to bring back behavior (2). We already have an [existing test for this case](https://github.com/bitcoin/bitcoin/blob/3eda7ea9ba724bfa53ad6f4f63af85fccb46da00/test/functional/feature_notifications.py#L104-L111) and I think after #18982 it should be safe and very easy to do as a followup.\r\n\r\nI also like your idea in https://github.com/bitcoin/bitcoin/pull/18600#issuecomment-617487831 of passing down the block hash/height so it is safe to mark transactions that conflict with a specific block as conflicted instead of unconfirmed.\r\n\r\nI think changes (3) and (4) are good too, my concerns there were just about compatibility and bugs.\r\n\r\n> Looking on #18982\r\n\r\nThanks for reviewing that! I starting implementing your suggestions there.",
      "created_at" : "2020-05-20T23:14:51Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#issuecomment-631786344",
      "id" : 631786344,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18600",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMTc4NjM0NA==",
      "updated_at" : "2020-05-20T23:14:51Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/631786344",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r429347629"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429347629"
         }
      },
      "author_association" : "MEMBER",
      "body" : "> I mean mostly for the comments that start a new \"section\" or \"paragraph\" or subtest/test case. In the failing logs you could then easily identify when the new test section begins.\r\n\r\nYes! and logging like this also makes it clear where the slower tests are to possibly speed them up.",
      "commit_id" : "e9ffced8bebe7451d5e8d97b5e88fbedb7675cc6",
      "created_at" : "2020-05-22T16:40:56Z",
      "diff_hunk" : "@@ -139,5 +140,99 @@ def run_test(self):\n         # Node1's balance should be its initial balance (1250 for 25 block rewards) plus the doublespend:\n         assert_equal(self.nodes[1].getbalance(), 1250 + 1240)\n \n+        # Following test limb check that if a transaction of concern conflicted due to its parent\n+        # or anterior transaction being conflicted, wallet is able to detect it, independently of\n+        # reason (either block or mempool)\n+\n+        # Get a \"blind\" address from node0\n+        connect_nodes(self.nodes[0], 1)\n+        node0_address_blind = self.nodes[0].getnewaddress()\n+        txid_origin = self.nodes[1].sendtoaddress(self.nodes[1].getnewaddress(), Decimal(\"10\"))\n+        self.nodes[1].generate(1)\n+        self.sync_blocks([self.nodes[0], self.nodes[1]])\n+\n+        # Build parent conflicted tx from node1 to node1\n+        nA = next(tx_out[\"vout\"] for tx_out in self.nodes[1].gettransaction(txid_origin)[\"details\"] if tx_out[\"amount\"] == Decimal(\"10\"))\n+        inputs_parent_conflicted_tx = []\n+        inputs_parent_conflicted_tx.append({\"txid\": txid_origin, \"vout\": nA, \"sequence\": BIP125_SEQUENCE_NUMBER})\n+        outputs_parent_conflicted_tx = {}\n+        outputs_parent_conflicted_tx[self.nodes[1].getnewaddress()] = Decimal(\"9.99998\")\n+\n+        # Broadcast parent conflicted tx\n+        parent_conflicted_tx = self.nodes[1].signrawtransactionwithwallet(self.nodes[1].createrawtransaction(inputs_parent_conflicted_tx, outputs_parent_conflicted_tx))\n+        parent_conflicted_txid = self.nodes[1].sendrawtransaction(parent_conflicted_tx[\"hex\"])\n+\n+        # Build children conflicted tx\n+        inputs_children_conflicted_tx = []\n+        inputs_children_conflicted_tx.append({\"txid\": parent_conflicted_txid, \"vout\": 0})\n+        outputs_children_conflicted_tx = {}\n+        outputs_children_conflicted_tx[node0_address_blind] = Decimal(\"9.99996\")\n+\n+        #Broadcast children conflicted tx\n+        node1s_children_conflicted_tx = self.nodes[1].signrawtransactionwithwallet(self.nodes[1].createrawtransaction(inputs_children_conflicted_tx, outputs_children_conflicted_tx))\n+        children_conflicted_txid = self.nodes[1].sendrawtransaction(node1s_children_conflicted_tx[\"hex\"])\n+        self.sync_mempools([self.nodes[0], self.nodes[1]])\n+\n+        # Verify node0 sees conflicted paying back\n+        node0s_children_conflicted_tx = self.nodes[0].gettransaction(children_conflicted_txid)\n+\n+        assert_equal(node0s_children_conflicted_tx[\"confirmations\"], 0)\n+        assert_equal(node0s_children_conflicted_tx[\"details\"][0][\"category\"], \"receive\")\n+\n+        # Build conflicting tx, double-spending parent conflicted\n+        inputs_conflicting_tx = []\n+        inputs_conflicting_tx.append({\"txid\": txid_origin, \"vout\": nA})\n+        outputs_conflicting_tx = {}\n+        outputs_conflicting_tx[self.nodes[1].getnewaddress()] = Decimal(\"9.99980\")\n+\n+        # Broadcast conflicting tx to node1 mempool and generate a block\n+        conflicting_tx= self.nodes[1].signrawtransactionwithwallet(self.nodes[1].createrawtransaction(inputs_conflicting_tx, outputs_conflicting_tx))\n+        conflicting_txid = self.nodes[1].sendrawtransaction(conflicting_tx[\"hex\"])\n+        self.nodes[1].generate(1)\n+        self.sync_blocks([self.nodes[0], self.nodes[1]])\n+\n+        # Verify node0 sees children as conflicted",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#discussion_r429347629",
      "id" : 429347629,
      "in_reply_to_id" : 407555257,
      "line" : 195,
      "node_id" : "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTM0NzYyOQ==",
      "original_commit_id" : "b34318d4cc27d61d2b9cc6a97c9584eb0dada6e4",
      "original_line" : 195,
      "original_position" : 63,
      "original_start_line" : null,
      "path" : "test/functional/wallet_txn_doublespend.py",
      "position" : 64,
      "pull_request_review_id" : 417046016,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/18600",
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "updated_at" : "2020-05-22T16:40:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429347629",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> I actually think it'd be good to bring back behavior (2). We already have an [existing test for this case](https://github.com/bitcoin/bitcoin/blob/3eda7ea9ba724bfa53ad6f4f63af85fccb46da00/test/functional/feature_notifications.py#L104-L111) and I think after #18982 it should be safe and very easy to do as a followup.\r\n> \r\n> I also like your idea in [#18600 (comment)](https://github.com/bitcoin/bitcoin/pull/18600#issuecomment-617487831) of passing down the block hash/height so it is safe to mark transactions that conflict with a specific block as conflicted instead of unconfirmed.\r\n> \r\n> I think changes (3) and (4) are good too, my concerns there were just about compatibility and bugs.\r\n\r\nConcept ACK. I'll try to review this when it's updated. Edit: I second the preference for an enum over a bool in many cases; it's often clearer and generally more extensible for handling state.",
      "created_at" : "2020-05-22T16:43:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#issuecomment-632794516",
      "id" : 632794516,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18600",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzMjc5NDUxNg==",
      "updated_at" : "2020-05-22T16:49:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/632794516",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/2415484?v=4",
         "events_url" : "https://api.github.com/users/jonatack/events{/privacy}",
         "followers_url" : "https://api.github.com/users/jonatack/followers",
         "following_url" : "https://api.github.com/users/jonatack/following{/other_user}",
         "gists_url" : "https://api.github.com/users/jonatack/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/jonatack",
         "id" : 2415484,
         "login" : "jonatack",
         "node_id" : "MDQ6VXNlcjI0MTU0ODQ=",
         "organizations_url" : "https://api.github.com/users/jonatack/orgs",
         "received_events_url" : "https://api.github.com/users/jonatack/received_events",
         "repos_url" : "https://api.github.com/users/jonatack/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/jonatack/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/jonatack"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-06-02T22:30:42Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#issuecomment-637842067",
      "id" : 637842067,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18600",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYzNzg0MjA2Nw==",
      "updated_at" : "2020-06-02T22:30:42Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/637842067",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Since this PR has merge conflicts and the underlying code has changed a lot, I'm marking it closed and up for grabs. This way if it's updated it can be a new PR with less comment history, and the comments in this PR can stay in line with diffs.\r\n\r\nThe main change implemented by this PR is treating wallet transactions that conflict with newly connected blocks as conflicted. There is more information about this idea in [*idea-more-conflicts*](https://github.com/bitcoin-core/bitcoin-devwiki/wiki/Wallet-Transaction-Conflict-Tracking#idea-more-conflicts), and it requires some more work to implement correctly. To avoid the state representation problems described https://github.com/bitcoin/bitcoin/pull/18600#discussion_r420195993, it needs some updates to node code to pass along the conflicting block hash with conflicted removal notifications. It also needs extra wallet code to undo conflicts during reorgs.\r\n\r\nA related idea [*idea-mempool-conflicted*](https://github.com/bitcoin-core/bitcoin-devwiki/wiki/Wallet-Transaction-Conflict-Tracking#idea-mempool-conflicted) could be a way of treating conflicts similarly but requiring fewer changes. The PR's current approach of pretending block-connected conflicts are mempool conflicts instead of block conflicts could be kept, with serialization tweaks to just treat the mempool-conflicted state as temporary and not write it to the database.\r\n\r\nThe other changes in this PR like adding a \"conflicted\" RPC field and new test coverage (see https://github.com/bitcoin/bitcoin/pull/18600#pullrequestreview-405898189) could probably also be made into standalone PRs that could be merged pretty quickly.",
      "created_at" : "2021-01-11T14:27:24Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18600#issuecomment-757985581",
      "id" : 757985581,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18600",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDc1Nzk4NTU4MQ==",
      "performed_via_github_app" : null,
      "updated_at" : "2021-01-11T14:28:28Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/757985581",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   }
]
