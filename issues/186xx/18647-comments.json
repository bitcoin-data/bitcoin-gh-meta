[
   {
      "author_association" : "MEMBER",
      "body" : "Concept ACK on fixing #17548\r\n\r\nThanks for tackling this issue!",
      "created_at" : "2020-04-15T10:39:50Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18647#issuecomment-613961712",
      "id" : 613961712,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18647",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxMzk2MTcxMg==",
      "updated_at" : "2020-04-15T17:57:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/613961712",
      "user" : {
         "avatar_url" : "https://avatars3.githubusercontent.com/u/7826565?v=4",
         "events_url" : "https://api.github.com/users/practicalswift/events{/privacy}",
         "followers_url" : "https://api.github.com/users/practicalswift/followers",
         "following_url" : "https://api.github.com/users/practicalswift/following{/other_user}",
         "gists_url" : "https://api.github.com/users/practicalswift/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/practicalswift",
         "id" : 7826565,
         "login" : "practicalswift",
         "node_id" : "MDQ6VXNlcjc4MjY1NjU=",
         "organizations_url" : "https://api.github.com/users/practicalswift/orgs",
         "received_events_url" : "https://api.github.com/users/practicalswift/received_events",
         "repos_url" : "https://api.github.com/users/practicalswift/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/practicalswift/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/practicalswift"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Few thoughts:\r\n\r\n* This changes rpc method signature every every method from `UniValue(const JSONRPCRequest&)` by adding NodeContext parameter, but Marco's #18531 is already changing method signatures a different way. You should work with Marco to come up with signature for rpc methods that doesn't conflict\r\n* This PR doesn't actually get rid of the `g_rpc_node` variable, just a handful of uses. Maybe that is temporary (you could mark this PR a draft), but otherwise title is kind of misleading.\r\n* `NodeContext& rpc_node` arguments should be renamed `NodeContext& node`, RPC prefix is misleading and not doing anything\r\n* `NodeContext* pnode_ctx` followed by `CHECK_NONFATAL(pnode_ctx)` should probably be `NodeContext& node` and not using a pointer. Also current coding convention doesn't prefix pointers variable with p.\r\n* Wallet RPC methods shouldn't have access to NodeContext. At some point we should have WalletContext struct that will hold things like vpwallets and let us get rid of wallet globals, and it would make sense for wallet RPC methods to have access to this. That is why suggestion from #17548 was to just add a new member to JSONRPCRequest that could hold a generic context, not something tied to the wallet or node. Other advantage of using JSONRPCRequest is that you dont' have to change RPC method signatures.\r\n* This appears to be adding `NodeContext&` parameters to many RPC methods that don't use it. Again this may be another reason to just make it accessible through JSONRPCRequest",
      "created_at" : "2020-04-15T14:02:36Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18647#issuecomment-614059391",
      "id" : 614059391,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18647",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNDA1OTM5MQ==",
      "updated_at" : "2020-04-15T14:02:36Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/614059391",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "#18531 Doesn't change how RPC methods are dispatched, but it wraps them into an RPCMan. Assuming my pull makes it in first, it is going to reduce the diff of this pull significantly. Though, when `JSONRPCRequest` is used to pass in context, the two pulls should not conflict at all.",
      "created_at" : "2020-04-15T14:21:48Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18647#issuecomment-614069686",
      "id" : 614069686,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18647",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNDA2OTY4Ng==",
      "updated_at" : "2020-04-15T14:21:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/614069686",
      "user" : {
         "avatar_url" : "https://avatars0.githubusercontent.com/u/6399679?v=4",
         "events_url" : "https://api.github.com/users/MarcoFalke/events{/privacy}",
         "followers_url" : "https://api.github.com/users/MarcoFalke/followers",
         "following_url" : "https://api.github.com/users/MarcoFalke/following{/other_user}",
         "gists_url" : "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/MarcoFalke",
         "id" : 6399679,
         "login" : "MarcoFalke",
         "node_id" : "MDQ6VXNlcjYzOTk2Nzk=",
         "organizations_url" : "https://api.github.com/users/MarcoFalke/orgs",
         "received_events_url" : "https://api.github.com/users/MarcoFalke/received_events",
         "repos_url" : "https://api.github.com/users/MarcoFalke/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/MarcoFalke/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/MarcoFalke"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Hi @ryanofsky, and many thanks!\r\n\r\n> Few thoughts:\r\n> \r\n> * This changes rpc method signature every every method from `UniValue(const JSONRPCRequest&)` by adding NodeContext parameter, but Marco's #18531 is already changing method signatures a different way. You should work with Marco to come up with signature for rpc methods that doesn't conflict\r\n\r\nDidn't know about that.  Could not find anything in the original issue. Anyway, thanks for pointing this out!\r\n\r\n> * This PR doesn't actually get rid of the `g_rpc_node` variable, just a handful of uses. Maybe that is temporary (you could mark this PR a draft), but otherwise title is kind of misleading.\r\n\r\nI never wanted to get rid of it, only make it: \r\n\r\n* **const ref**\r\n* forwarded to actors directly and in one place (and not scattered around as it currently is)\r\n* while keeping **JSONRPCRequest** structure as it is. Why should JSONRPCRequest know anything about NodeContext? I see no reason to let a passive object (a request) that's going back and forth knowing anything about its environment. But maybe there are other things I know nothing about that would mandate such behavior.\r\n\r\nAnd yes, there are still a few places where we still need *g_rpc_node*, but those aren't directly related to this PR, so I deliberately didn't change them. \r\n\r\n**--EDIT**: *My sentence \"never wanted to get rid of it\" might have been misleading. Actually, I want to get rid of it as a global, but wanted to keep the NodeContext itself available to all RPC methods by forwarding it to Actors, of course.*\r\n\r\n**--EDIT 2**: Now the **g_rpc_node** is completely gone.\r\n\r\n> * `NodeContext& rpc_node` arguments should be renamed `NodeContext& node`, RPC prefix is misleading and not doing anything\r\n\r\nOk.\r\n\r\n**--EDIT**: Was changed and force-pushed.\r\n\r\n> * `NodeContext* pnode_ctx` followed by `CHECK_NONFATAL(pnode_ctx)` should probably be `NodeContext& node` and not using a pointer. Also current coding convention doesn't prefix pointers variable with p.\r\n\r\nOk. Will check it again.\r\n\r\n**--EDIT**: *Have checked it. Sadly, not possible because copy assignment operator of NodeContext is implicitly deleted. So, will keep it a pointer there, and the check, unless someone comes with a better idea. Any inputs that help me get rid of raw pointers are highly welcome :)*\r\n\r\n> * Wallet RPC methods shouldn't have access to NodeContext. \r\n\r\nI didn't know about his. I thought it's the right place to put the context in, because those methods are being executed *within* a NodeContext. It's like \"self\" variable in python, for example. It's simply there, be it used or not, because at no point in time is an RPC method being used outside NodeContext. But I might be mistaken.\r\n\r\n> At some point we should have WalletContext struct that will hold things like vpwallets and let us get rid of wallet globals, and it would make sense for wallet RPC methods to have access to this. That is why suggestion from #17548 was to just add a new member to JSONRPCRequest that could hold a generic context, not something tied to the wallet or node. Other advantage of using JSONRPCRequest is that you dont' have to change RPC method signatures.\r\n\r\nAgain, why should a passive object, like a request, know anything about the environment that's using it? Why not create some kind of *MetaContext* that holds both Node- and WalletContext and forwards it directly to actors? This way one could easily extend contexts, if there might be a need to do so in future (*I'm only speculating here*)\r\n\r\n**--EDIT**: Another option would be to create a MetaContext that's based on aliasing shared_ptr. Something like this: \r\n\r\n```cpp\r\nstruct MetaContext {\r\n    NodeContext node;\r\n    WalletContext wallet;\r\n};\r\n```\r\n\r\nWe then initialize the meta-context first:\r\n\r\n```cpp\r\nauto meta_ctx = std::shared_ptr<MetaContext>(new MetaContext());\r\n```\r\n\r\nNow, when we want to forward the \"correct\" context to a particular actor, we would do this:\r\n\r\n```cpp\r\nauto subctx_node = std::shared_ptr<NodeContext>(meta_ctx, &meta_ctx->node);  \r\n```\r\n\r\nFor functions that should only deal with Wallet, we then go this way:\r\n\r\n```cpp\r\nauto subctx_wallet = std::shared_ptr<WalletContext>(meta_ctx, &meta_ctx->wallet);  \r\n```\r\n\r\nWith this strategy we could put any number of different contexts in the same place, but only reveal those that are of use to functions which will consume them.\r\n\r\n> * This appears to be adding `NodeContext&` parameters to many RPC methods that don't use it. Again this may be another reason to just make it accessible through JSONRPCRequest\r\n\r\nI see it like the \"self\" or \"this\" pointers. They're always there, regardless of usage. \"Some\" context is always there.\r\n\r\nAnyway, thanks again!\r\n",
      "created_at" : "2020-04-15T14:23:05Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18647#issuecomment-614070351",
      "id" : 614070351,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18647",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNDA3MDM1MQ==",
      "updated_at" : "2020-04-15T19:58:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/614070351",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/56779?v=4",
         "events_url" : "https://api.github.com/users/brakmic/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brakmic/followers",
         "following_url" : "https://api.github.com/users/brakmic/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brakmic/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brakmic",
         "id" : 56779,
         "login" : "brakmic",
         "node_id" : "MDQ6VXNlcjU2Nzc5",
         "organizations_url" : "https://api.github.com/users/brakmic/orgs",
         "received_events_url" : "https://api.github.com/users/brakmic/received_events",
         "repos_url" : "https://api.github.com/users/brakmic/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brakmic/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brakmic/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brakmic"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18699 (wallet: Avoid translating RPC errors by MarcoFalke)\n* #18698 (Make g_chainman internal to validation by MarcoFalke)\n* #18671 (wallet: Add BlockUntilSyncedToCurrentChain to dumpwallet by MarcoFalke)\n* #18654 (rpc: separate bumpfee's psbt creation function into psbtbumpfee by achow101)\n* #18606 (test: checks that bitcoin-cli autocomplete is in sync by pierreN)\n* #18453 (rpc, cli: add multiwallet balances rpc and use it in -getinfo by jonatack)\n* #17356 (RPC: Internal named params by luke-jr)\n* #16528 (Native Descriptor Wallets using DescriptorScriptPubKeyMan by achow101)\n* #16365 (Log RPC parameters (arguments) if -debug=rpcparams by LarryRuane)\n* #16224 (gui: Bilingual GUI error messages by hebasto)\n* #14707 ([RPC] Include coinbase transactions in receivedby RPCs by andrewtoth)\n* #12674 (RPC: Support addnode onetry without making the connection priviliged by luke-jr)\n* #11413 ([wallet] [rpc] sendtoaddress/sendmany: Add explicit feerate option by kallewoof)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2020-04-15T14:32:29Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18647#issuecomment-614075590",
      "id" : 614075590,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18647",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNDA3NTU5MA==",
      "updated_at" : "2020-04-20T21:48:47Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/614075590",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> I never wanted to get rid of it, only make it:\r\n> \r\n> * **const ref**\r\n\r\nI don't think the the const part is good. RPC methods can start/stop the node, initiate connections, load wallets, so I don't think they should be prevented from changing all context members that exist now and all new context members we may add in the future.\r\n\r\n> * forwarded to actors directly and in one place (and not scattered around as it currently is)\r\n\r\nThis seems good. Maybe list it as a benefit in PR description. If you think of examples where it could help practically, those are good to mention too.\r\n\r\n> * while keeping **JSONRPCRequest** structure as it is. Why should JSONRPCRequest know anything about NodeContext? I see no reason to let a passive object (a request) that's going back and forth knowing anything about its environment.\r\n\r\nMaybe my suggestion here and in #17548 wasn't clear, but I'm not saying add a NodeContext member to JSONRPCRequest. I'm saying add a generic context member so it can be a vehicle for information about the environment without knowing about the environment, the same way it is vehicle for params without knowing about the meaning of params\r\n\r\n\r\n\r\n",
      "created_at" : "2020-04-15T15:28:45Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18647#issuecomment-614108634",
      "id" : 614108634,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18647",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNDEwODYzNA==",
      "updated_at" : "2020-04-15T15:28:45Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/614108634",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> > I never wanted to get rid of it, only make it:\r\n> > \r\n> > * **const ref**\r\n> \r\n> I don't think the the const part is good. RPC methods can start/stop the node, initiate connections, load wallets, so I don't think they should be prevented from changing all context members that exist now and all new context members we may add in the future.\r\n> \r\n\r\nWell, then I think we should have different variants of contexts at our disposal. Maybe something similar to the example with aliasing shared_ptrs (*in the EDIT-ed part of my previous posting*). Read-only contexts, writeable ones etc.\r\n\r\n> > * forwarded to actors directly and in one place (and not scattered around as it currently is)\r\n> \r\n> This seems good. Maybe list it as a benefit in PR description. If you think of examples where it could help practically, those are good to mention too.\r\n> \r\n\r\nThanks for pointing this out. I will update the PR description.\r\n\r\n> > * while keeping **JSONRPCRequest** structure as it is. Why should JSONRPCRequest know anything about NodeContext? I see no reason to let a passive object (a request) that's going back and forth knowing anything about its environment.\r\n> \r\n> Maybe my suggestion here and in #17548 wasn't clear, but I'm not saying add a NodeContext member to JSONRPCRequest. I'm saying add a generic context member so it can be a vehicle for information about the environment without knowing about the environment, the same way it is vehicle for params without knowing about the meaning of params\r\n\r\nI would not extend JSONRPCRequest in any way. It should be a message carrier in the purest KISS sense. \r\n",
      "created_at" : "2020-04-15T15:32:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18647#issuecomment-614111139",
      "id" : 614111139,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18647",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNDExMTEzOQ==",
      "updated_at" : "2020-04-15T15:38:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/614111139",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/56779?v=4",
         "events_url" : "https://api.github.com/users/brakmic/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brakmic/followers",
         "following_url" : "https://api.github.com/users/brakmic/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brakmic/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brakmic",
         "id" : 56779,
         "login" : "brakmic",
         "node_id" : "MDQ6VXNlcjU2Nzc5",
         "organizations_url" : "https://api.github.com/users/brakmic/orgs",
         "received_events_url" : "https://api.github.com/users/brakmic/received_events",
         "repos_url" : "https://api.github.com/users/brakmic/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brakmic/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brakmic/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brakmic"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Well, then I think we should need different variant of contexts.\r\n\r\nIt would be good to elaborate on the problem being solved in the PR description. It seems to have something to do with data data hiding, but specifics are unclear. \r\n\r\nI think the goal of #17548 is remove the global variable, though, so I wouldn't say this fixes that issue, even though it could help",
      "created_at" : "2020-04-15T15:40:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18647#issuecomment-614115427",
      "id" : 614115427,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18647",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNDExNTQyNw==",
      "updated_at" : "2020-04-15T15:40:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/614115427",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> > Well, then I think we should need different variant of contexts.\r\n> \r\n> It would be good to elaborate on the problem being solved in the PR description. It seems to have something to do with data data hiding, but specifics are unclear.\r\n> \r\n> I think the goal of #17548 is remove the global variable, though, so I wouldn't say this fixes that issue, even though it could help\r\n\r\nYes, of course. I am very glad that my PR found much attention within such a short time frame. The learning process I went through while thinking about \"*this damn global NodeContext and how to make it less exposed*\" is already a win for me.\r\n\r\nWe will surely find a way. ",
      "created_at" : "2020-04-15T15:43:46Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18647#issuecomment-614117585",
      "id" : 614117585,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18647",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNDExNzU4NQ==",
      "updated_at" : "2020-04-15T15:44:22Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/614117585",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/56779?v=4",
         "events_url" : "https://api.github.com/users/brakmic/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brakmic/followers",
         "following_url" : "https://api.github.com/users/brakmic/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brakmic/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brakmic",
         "id" : 56779,
         "login" : "brakmic",
         "node_id" : "MDQ6VXNlcjU2Nzc5",
         "organizations_url" : "https://api.github.com/users/brakmic/orgs",
         "received_events_url" : "https://api.github.com/users/brakmic/received_events",
         "repos_url" : "https://api.github.com/users/brakmic/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brakmic/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brakmic/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brakmic"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\nð This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).",
      "created_at" : "2020-04-19T13:08:49Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18647#issuecomment-616130591",
      "id" : 616130591,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18647",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNjEzMDU5MQ==",
      "updated_at" : "2020-04-19T13:08:49Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/616130591",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "> Instead of changing all RPC handlers I think you could override `CRPCCommand` constructor to take\r\n> a `UniValue (*rpcfn_type)(const JSONRPCRequest& jsonRequest)`. The same approach can be done in Marco PR, `RPCMan` can take different method signatures.\r\n\r\nYes, this approach would be less invasive. Maybe I could rebase after Marco's PR gets merged? ",
      "created_at" : "2020-04-22T11:54:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18647#issuecomment-617731473",
      "id" : 617731473,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18647",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNzczMTQ3Mw==",
      "updated_at" : "2020-04-22T11:54:02Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/617731473",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/56779?v=4",
         "events_url" : "https://api.github.com/users/brakmic/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brakmic/followers",
         "following_url" : "https://api.github.com/users/brakmic/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brakmic/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brakmic",
         "id" : 56779,
         "login" : "brakmic",
         "node_id" : "MDQ6VXNlcjU2Nzc5",
         "organizations_url" : "https://api.github.com/users/brakmic/orgs",
         "received_events_url" : "https://api.github.com/users/brakmic/received_events",
         "repos_url" : "https://api.github.com/users/brakmic/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brakmic/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brakmic/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brakmic"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "I really appreciate the effort here, but I don't think this PR is teneble, and I have a simpler alternative in #18740. This PR is too wide in scope changing things that don't need to be changed, and is accessing node context in places that will make changes we do want more difficult. Specifically this PR is:\r\n\r\n- Making spurious changes to httpserver which aren't necessary because it already supports context passing. These changes also have potential to cause bugs given fragility of libevent.\r\n- Using node type in httprpc rpc/server layers that don't otherwise contain node specific code (or even bitcoin specific code). These changes will make multiprocess and offline wallet work more difficult, and get in the way of any features that want to accept RPC requests outside of the node process.\r\n- Adding NodeContext parameter to every single RPC method when most of these methods don't need it and some of them (wallet methods) should not have access to it. This makes the change bigger and harder to review, and will potentially cause confusion and accidental changes that will again make multiprocess and offline wallet work more difficult.\r\n- Making unit test initialization inconsistent with application initialization. Passing context through tableRPC.addNodeContext in one case and AppInitServers in the other case.\r\n- Not safely or consistently handling errors. Removing null checks in rest and rpc code and segfaulting when the context isn't available instead of returning HTTP errors\r\n- Making spurious changes that complicate review, adding consts, removing consts, changing indentation, making manual changes that would be safer as scripted-diffs\r\n- Not using recommended style, using pointers instead of references, using hungarian notation, using #include where a forward declaration would be more efficient\r\n- Making `NodeContext` a more ubiquitous presence in the codebase than it was ever meant to be (increasing from 66 to 266 usages).\r\n\r\nIt was good to see this PR opened and have progress on #17548, and be useful as an experiment, but I think this is not the best way forward and would recommend not doing more work on this PR",
      "created_at" : "2020-04-22T16:15:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18647#issuecomment-617878826",
      "id" : 617878826,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18647",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNzg3ODgyNg==",
      "updated_at" : "2020-04-22T16:15:10Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/617878826",
      "user" : {
         "avatar_url" : "https://avatars2.githubusercontent.com/u/7133040?v=4",
         "events_url" : "https://api.github.com/users/ryanofsky/events{/privacy}",
         "followers_url" : "https://api.github.com/users/ryanofsky/followers",
         "following_url" : "https://api.github.com/users/ryanofsky/following{/other_user}",
         "gists_url" : "https://api.github.com/users/ryanofsky/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/ryanofsky",
         "id" : 7133040,
         "login" : "ryanofsky",
         "node_id" : "MDQ6VXNlcjcxMzMwNDA=",
         "organizations_url" : "https://api.github.com/users/ryanofsky/orgs",
         "received_events_url" : "https://api.github.com/users/ryanofsky/received_events",
         "repos_url" : "https://api.github.com/users/ryanofsky/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/ryanofsky/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/ryanofsky"
      }
   },
   {
      "author_association" : "CONTRIBUTOR",
      "body" : "Hi @ryanofsky \r\n\r\n> I really appreciate the effort here, but I don't think this PR is teneble, and I have a simpler alternative in #18740. \r\n\r\nSimpler is very often better!\r\n\r\n> This PR is too wide in scope changing things that don't need to be changed, and is accessing > node context in places that will make changes we do want more difficult. \r\n\r\nThis indeed is the case, but mostly because *g_rpc_node*, and later *g_rpc_chain*, were basically \"everywhere\". This of course should not serve as an excuse to write an even bigger \"solution\" for the original problem. \r\n\r\n> Specifically this PR is:\r\n> * Making spurious changes to httpserver which aren't necessary because it already supports context passing. These changes also have potential to cause bugs given fragility of libevent.\r\n\r\nAs I don't know much about libevent, I will simply agree on that.\r\n\r\n> * Using node type in httprpc rpc/server layers that don't otherwise contain node specific code (or even bitcoin specific code). These changes will make multiprocess and offline wallet work more difficult, and get in the way of any features that want to accept RPC requests outside of the node process.\r\n\r\nThe NodeContext structure is actually even bigger. It contains various things, so you are right. But also: _maybe NodeContext itself should be split into smaller parts_? To me, it looks like NodeContext carries many heavy things. I actually never needed NodeContext as a whole but merely a pointer/ref to one of its members. However, this is not important here, imo, so I'll leave it for another discussion.\r\n\r\n> * Adding NodeContext parameter to every single RPC method when most of these methods don't need it and some of them (wallet methods) should not have access to it. \r\n\r\nYes, it's not the cutest thing to do, but a bit less ugly than a global pointer. And as I said, I never needed NodeContext itself, only a pointer/ref from it.\r\n\r\n> This makes the change bigger and harder to review, \r\n\r\nTo understand why *g_rpc_node* is everywhere and how to deal with it correctly, was hard to me. :)\r\n\r\nLater then, *g_rpc_chain* came to the party. \r\n\r\n> and will potentially cause confusion and\r\n> accidental changes that will again make multiprocess and offline wallet work more difficult.\r\n\r\nAs I still lack enough knowledge about these areas, I can only agree with you.\r\n\r\n> * Making unit test initialization inconsistent with application initialization. Passing context through tableRPC.addNodeContext in one case and AppInitServers in the other case.\r\n\r\nOk.\r\n\r\n> * Not safely or consistently handling errors. Removing null checks in rest and rpc code and segfaulting when the context isn't available instead of returning HTTP errors\r\n\r\nI was actually checking for *nullptr* at the very beginning of the initialization. But, this is not important here, so the code as it is, is not stable enough. Accepted.\r\n\r\n> * Making spurious changes that complicate review, adding consts, removing consts, changing indentation, making manual changes that would be safer as scripted-diffs\r\n\r\nI use *clang format* as stated in Bitcoin docs. \r\n\r\n```shell\r\ngit diff -U0 HEAD~1.. | ./contrib/devtools/clang-format-diff.py -p1 -i -v\r\n```\r\n\r\nRegarding **const/non-costs**: it was because the NodeContext has an implicitly deleted copy assignment constructor, because one of its members is a **unique_ptr**. So, I had to find a way around this impasse. This too is one of the things that make me believe, that NodeContext itself should be split into smaller parts. But, this is not that important here, I think.\r\n\r\n> * Not using recommended style, using pointers instead of references, using hungarian notation, using #include where a forward declaration would be more efficient\r\n\r\nI would like to know more about the *bitcoinic* coding style. If you have any doc/link please, let me know. I could not find anything. \r\n\r\n> * Making `NodeContext` a more ubiquitous presence in the codebase than it was ever meant to be (increasing from 66 to 266 usages).\r\n\r\nNodeContext should maybe be made even smaller, imo. So, yes, I agree with you.\r\n\r\n> \r\n> It was good to see this PR opened and have progress on #17548, and be useful as an experiment, \r\n\r\nYes, that was the initial motivation. The original issue https://github.com/bitcoin/bitcoin/issues/17548 was hanging around for some time, so I thought, let's do something about it.\r\n\r\n> but I think this is not the best way forward and would recommend not doing more work on this PR\r\n\r\nIn my opinion, it was the best way to forward *for me*, as it helped me a lot to understand some interesting parts of Bitcoin. And I thank you for that! However, you are right, it's not the best way to forward *for the project*, so I will close my PR, and will study your code and try it out. \r\n\r\nThanks again!",
      "created_at" : "2020-04-22T16:49:03Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/18647#issuecomment-617898847",
      "id" : 617898847,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/18647",
      "node_id" : "MDEyOklzc3VlQ29tbWVudDYxNzg5ODg0Nw==",
      "updated_at" : "2020-04-22T16:50:00Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/617898847",
      "user" : {
         "avatar_url" : "https://avatars1.githubusercontent.com/u/56779?v=4",
         "events_url" : "https://api.github.com/users/brakmic/events{/privacy}",
         "followers_url" : "https://api.github.com/users/brakmic/followers",
         "following_url" : "https://api.github.com/users/brakmic/following{/other_user}",
         "gists_url" : "https://api.github.com/users/brakmic/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/brakmic",
         "id" : 56779,
         "login" : "brakmic",
         "node_id" : "MDQ6VXNlcjU2Nzc5",
         "organizations_url" : "https://api.github.com/users/brakmic/orgs",
         "received_events_url" : "https://api.github.com/users/brakmic/received_events",
         "repos_url" : "https://api.github.com/users/brakmic/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/brakmic/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/brakmic/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/brakmic"
      }
   }
]
