[
   {
      "author_association" : "MEMBER",
      "body" : "Isn't this almost the same as #23215? Why can't it be done in that PR? It's nearly impossible to keep track of the constant changes for these Windows CIs.",
      "created_at" : "2021-10-20T23:22:31Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23329#issuecomment-948108399",
      "id" : 948108399,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23329",
      "node_id" : "IC_kwDOABII5844gvxv",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/948108399/reactions"
      },
      "updated_at" : "2021-10-20T23:22:31Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/948108399",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/863730?v=4",
         "events_url" : "https://api.github.com/users/fanquake/events{/privacy}",
         "followers_url" : "https://api.github.com/users/fanquake/followers",
         "following_url" : "https://api.github.com/users/fanquake/following{/other_user}",
         "gists_url" : "https://api.github.com/users/fanquake/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/fanquake",
         "id" : 863730,
         "login" : "fanquake",
         "node_id" : "MDQ6VXNlcjg2MzczMA==",
         "organizations_url" : "https://api.github.com/users/fanquake/orgs",
         "received_events_url" : "https://api.github.com/users/fanquake/received_events",
         "repos_url" : "https://api.github.com/users/fanquake/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/fanquake/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/fanquake"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> It's nearly impossible to keep track of the constant changes for these Windows CIs.\r\n\r\nSorry about that.\r\n\r\n> Isn't this almost the same as #23215?\r\n\r\nYes, this PR is split from #23215.\r\n\r\n> Why can't it be done in that PR?\r\n\r\nThat was my initial idea when I opened #23215. But it created a confusion (at least, I have such an impression), that the goal of such combined PR was _introducing_ a vcpkg binary caching. It is not the case. So I decided to leave #23215 solely on purpose of introducing of vcpkg downloads cache which has completely different goal in comparison to binary cache.\r\n\r\nTherefore, this PR is focused on an improvement of already used vcpkg binary caching feature.\r\n\r\nAnd #23215 will be focused on an introducing a new vcpkg downloads cache.",
      "created_at" : "2021-10-21T06:30:08Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23329#issuecomment-948298846",
      "id" : 948298846,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23329",
      "node_id" : "IC_kwDOABII5844heRe",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/948298846/reactions"
      },
      "updated_at" : "2021-10-21T06:30:08Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/948298846",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "Friendly ping @sipsorcery :tiger2: ",
      "created_at" : "2021-10-21T06:30:58Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23329#issuecomment-948299261",
      "id" : 948299261,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23329",
      "node_id" : "IC_kwDOABII5844heX9",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/948299261/reactions"
      },
      "updated_at" : "2021-10-21T06:30:58Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/948299261",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@hebasto are you sure that you're caching the correct vcpkg directory?\r\n\r\nIt's my understanding that the `C:\\Users\\ContainerAdministrator\\AppData\\Local\\vcpkg\\archives` will hold the zipped source files that will then need to be built.\r\n\r\nOn my local machine the vcpkg manifest mechanism puts the built binaries in `build_msvc/vcpkg_installed`.",
      "created_at" : "2021-10-21T17:52:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23329#issuecomment-948865837",
      "id" : 948865837,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23329",
      "node_id" : "IC_kwDOABII5844jost",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/948865837/reactions"
      },
      "updated_at" : "2021-10-21T17:52:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/948865837",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/197660?v=4",
         "events_url" : "https://api.github.com/users/sipsorcery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipsorcery/followers",
         "following_url" : "https://api.github.com/users/sipsorcery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipsorcery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipsorcery",
         "id" : 197660,
         "login" : "sipsorcery",
         "node_id" : "MDQ6VXNlcjE5NzY2MA==",
         "organizations_url" : "https://api.github.com/users/sipsorcery/orgs",
         "received_events_url" : "https://api.github.com/users/sipsorcery/received_events",
         "repos_url" : "https://api.github.com/users/sipsorcery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipsorcery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipsorcery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipsorcery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@sipsorcery \r\n> @hebasto are you sure that you're caching the correct vcpkg directory?\r\n\r\nYes, I am :tiger2: \r\n\r\nOne could track any dependency package (`berkeleydb`, for example):\r\n\r\n- https://github.com/bitcoin/bitcoin/commit/16df28c3e3617814cd48c05120a4d766f1480c74, the binary cache is unpopulated, i.e., `C:\\Users\\ContainerAdministrator\\AppData\\Local\\vcpkg\\archives` is empty:\r\n\r\nIn the [build log](https://api.cirrus-ci.com/v1/task/4612904495349760/logs/build.log) one can see:\r\n```\r\n...\r\n  The following packages will be built and installed:\r\n      berkeleydb[core]:x64-windows-static -> 4.8.30#5\r\n...\r\n  Could not locate cached archive: C:\\Users\\ContainerAdministrator\\AppData\\Local\\vcpkg\\archives\\62\\62c79c2f0c0d9d79208917f62e9cc30952a57354.zip\r\n...\r\n  Starting package 1/80: berkeleydb:x64-windows-static\r\n  Building package berkeleydb[core]:x64-windows-static...\r\n  -- Downloading http://download.oracle.com/berkeley-db/db-4.8.30.NC.zip -> db-4.8.30.NC.zip...\r\n  -- Extracting source C:/Users/ContainerAdministrator/AppData/Local/Temp/vcpkg/downloads/db-4.8.30.NC.zip\r\n  -- Applying patch fix-conflict-macro.patch\r\n  -- Using source at C:/Users/ContainerAdministrator/AppData/Local/Temp/vcpkg/buildtrees/berkeleydb/src/db-4-87fc9a5730.clean\r\n  -- Found external ninja('1.10.2').\r\n  -- Configuring x64-windows-static\r\n  -- Building x64-windows-static-rel\r\n  -- Installing: C:/Users/ContainerAdministrator/AppData/Local/Temp/vcpkg/packages/berkeleydb_x64-windows-static/share/berkeleydb/copyright\r\n  -- Performing post-build validation\r\n  -- Performing post-build validation done\r\n  Stored binary cache: C:\\Users\\ContainerAdministrator\\AppData\\Local\\vcpkg\\archives\\62\\62c79c2f0c0d9d79208917f62e9cc30952a57354.zip\r\n  Building package berkeleydb[core]:x64-windows-static... done\r\n  Installing package berkeleydb[core]:x64-windows-static...\r\n  Installing package berkeleydb[core]:x64-windows-static... done\r\n  Elapsed time for package berkeleydb:x64-windows-static: 52.01 s\r\n...\r\n```\r\n\r\n- https://github.com/bitcoin/bitcoin/commit/a7f28af4372a9d6ebe1c596ec455cbeac703f69d, now the binary cache is fully populated, and in the [build log](https://api.cirrus-ci.com/v1/task/6089316683218944/logs/build.log):\r\n```\r\n...\r\n  The following packages will be built and installed:\r\n      berkeleydb[core]:x64-windows-static -> 4.8.30#5\r\n...\r\n  Using cached binary package: C:\\Users\\ContainerAdministrator\\AppData\\Local\\vcpkg\\archives\\62\\62c79c2f0c0d9d79208917f62e9cc30952a57354.zip\r\n...\r\n  Starting package 1/80: berkeleydb:x64-windows-static\r\n  Building package berkeleydb[core]:x64-windows-static...\r\n  Building package berkeleydb[core]:x64-windows-static... done\r\n  Installing package berkeleydb[core]:x64-windows-static...\r\n  Installing package berkeleydb[core]:x64-windows-static... done\r\n  Elapsed time for package berkeleydb:x64-windows-static: 27.04 ms\r\n...\r\n```\r\n\r\n> It's my understanding that the `C:\\Users\\ContainerAdministrator\\AppData\\Local\\vcpkg\\archives` will hold the zipped source files that will then need to be built.\r\n\r\nActually, the `C:\\Users\\ContainerAdministrator\\AppData\\Local\\vcpkg\\archives\\62\\62c79c2f0c0d9d79208917f62e9cc30952a57354.zip` archive also contains a compiled `lib\\libdb48.lib`.\r\n\r\n> On my local machine the vcpkg manifest mechanism puts the built binaries in `build_msvc/vcpkg_installed`.\r\n\r\nCorrect. But this action seems orthogonal to the vcpkg \"Binary Caching\" mechanism.",
      "created_at" : "2021-10-21T20:24:53Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23329#issuecomment-948976478",
      "id" : 948976478,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23329",
      "node_id" : "IC_kwDOABII5844kDte",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/948976478/reactions"
      },
      "updated_at" : "2021-10-21T20:28:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/948976478",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "\r\n>> @hebasto are you sure that you're caching the correct vcpkg directory?\r\n\r\n> Yes, I am ð\r\n\r\nI stand corrected. I did a build, deleted the `build_msvc/vcpkg_installed` directory, built again and the binary dependencies were copied from `C:\\Users\\aaron\\AppData\\Local\\vcpkg\\archives`.\r\n\r\nAm I correct that the CI snippet below deletes and re-creates the `%VCPKG_DEFAULT_BINARY_CACHE%` directory is the `msbuild` version changes? And that's the mechanism to stop it growing when the vcpkg dependencies need to get rebuilt?\r\n\r\n````\r\n  vcpkg_binary_cache:\r\n    folder: '%VCPKG_DEFAULT_BINARY_CACHE%'\r\n    reupload_on_changes: true\r\n    fingerprint_script:\r\n      - echo %CI_VCPKG_TAG%\r\n      - msbuild -version\r\n    populate_script:\r\n      - mkdir %VCPKG_DEFAULT_BINARY_CACHE%\r\n  ````",
      "created_at" : "2021-10-21T20:52:30Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23329#issuecomment-948993885",
      "id" : 948993885,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23329",
      "node_id" : "IC_kwDOABII5844kH9d",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/948993885/reactions"
      },
      "updated_at" : "2021-10-21T20:52:30Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/948993885",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/197660?v=4",
         "events_url" : "https://api.github.com/users/sipsorcery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipsorcery/followers",
         "following_url" : "https://api.github.com/users/sipsorcery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipsorcery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipsorcery",
         "id" : 197660,
         "login" : "sipsorcery",
         "node_id" : "MDQ6VXNlcjE5NzY2MA==",
         "organizations_url" : "https://api.github.com/users/sipsorcery/orgs",
         "received_events_url" : "https://api.github.com/users/sipsorcery/received_events",
         "repos_url" : "https://api.github.com/users/sipsorcery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipsorcery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipsorcery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipsorcery"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "@sipsorcery \r\n> Am I correct that the CI snippet below deletes and re-creates the `%VCPKG_DEFAULT_BINARY_CACHE%` directory is the `msbuild` version changes?\r\n\r\nTo be precise, an old cache is not loaded, rather \"deleted\". Cases for such cache invalidation are any of the following: `CI_VCPKG_TAG` is changed and/or `msbuild -version` is changed.\r\n\r\n> And that's the mechanism to stop it growing when the vcpkg dependencies need to get rebuilt?\r\n\r\nYes, it is. But only in two explicit cases: `CI_VCPKG_TAG` is changed and/or `msbuild -version` is changed.\r\n\r\nFWIW, usual binary cache expected size is 83 MB, on master (8a083bc5b57ff98f2e3c550f1b10dba202e3aa79) it is 334 MB now.\r\n\r\n---\r\n\r\nJust in case: https://cirrus-ci.org/guide/writing-tasks/#cache-instruction",
      "created_at" : "2021-10-21T21:16:02Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23329#issuecomment-949009405",
      "id" : 949009405,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23329",
      "node_id" : "IC_kwDOABII5844kLv9",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/949009405/reactions"
      },
      "updated_at" : "2021-10-21T21:22:07Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/949009405",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/32963518?v=4",
         "events_url" : "https://api.github.com/users/hebasto/events{/privacy}",
         "followers_url" : "https://api.github.com/users/hebasto/followers",
         "following_url" : "https://api.github.com/users/hebasto/following{/other_user}",
         "gists_url" : "https://api.github.com/users/hebasto/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/hebasto",
         "id" : 32963518,
         "login" : "hebasto",
         "node_id" : "MDQ6VXNlcjMyOTYzNTE4",
         "organizations_url" : "https://api.github.com/users/hebasto/orgs",
         "received_events_url" : "https://api.github.com/users/hebasto/received_events",
         "repos_url" : "https://api.github.com/users/hebasto/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/hebasto/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/hebasto"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ACK e8692cf2c151d2abc206ca699e04ae05d4c31dcd.",
      "created_at" : "2021-10-21T21:56:41Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23329#issuecomment-949032741",
      "id" : 949032741,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23329",
      "node_id" : "IC_kwDOABII5844kRcl",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 1,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/949032741/reactions"
      },
      "updated_at" : "2021-10-21T21:56:41Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/949032741",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/197660?v=4",
         "events_url" : "https://api.github.com/users/sipsorcery/events{/privacy}",
         "followers_url" : "https://api.github.com/users/sipsorcery/followers",
         "following_url" : "https://api.github.com/users/sipsorcery/following{/other_user}",
         "gists_url" : "https://api.github.com/users/sipsorcery/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/sipsorcery",
         "id" : 197660,
         "login" : "sipsorcery",
         "node_id" : "MDQ6VXNlcjE5NzY2MA==",
         "organizations_url" : "https://api.github.com/users/sipsorcery/orgs",
         "received_events_url" : "https://api.github.com/users/sipsorcery/received_events",
         "repos_url" : "https://api.github.com/users/sipsorcery/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/sipsorcery/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/sipsorcery/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/sipsorcery"
      }
   }
]
