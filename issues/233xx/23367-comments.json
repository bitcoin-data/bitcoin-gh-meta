[
   {
      "author_association" : "MEMBER",
      "body" : "Thanks @Xekyo for the feedback on the original idea. cc @achow101 ",
      "created_at" : "2021-10-27T07:52:56Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23367#issuecomment-952634736",
      "id" : 952634736,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23367",
      "node_id" : "IC_kwDOABII5844yA1w",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/952634736/reactions"
      },
      "updated_at" : "2021-10-27T07:52:56Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/952634736",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#23810](https://github.com/bitcoin/bitcoin/pull/23810) (refactor: destroy all C-style casts; use modern C++ casts, enforce via `-Wold-style-cast` by PastaPastaPasta)\n* [#23545](https://github.com/bitcoin/bitcoin/pull/23545) (scripted-diff: Use clang-tidy syntax for C++ named arguments by MarcoFalke)\n* [#23534](https://github.com/bitcoin/bitcoin/pull/23534) (wallet: Allow negative effective value inputs when subtracting fee from outputs by achow101)\n* [#23497](https://github.com/bitcoin/bitcoin/pull/23497) (Add `src/node/` and `src/wallet/` code to `node::` and `wallet::` namespaces by ryanofsky)\n* [#23475](https://github.com/bitcoin/bitcoin/pull/23475) (wallet: add config to prioritize a solution that doesn't create change in coin selection by brunoerg)\n* [#23202](https://github.com/bitcoin/bitcoin/pull/23202) (wallet: allow psbtbumpfee to work with txs with external inputs by achow101)\n* [#23201](https://github.com/bitcoin/bitcoin/pull/23201) (wallet: Allow users to specify input weights when funding a transaction by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
      "created_at" : "2021-10-27T14:39:10Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23367#issuecomment-952997298",
      "id" : 952997298,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23367",
      "node_id" : "IC_kwDOABII5844zZWy",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/952997298/reactions"
      },
      "updated_at" : "2022-01-10T09:11:48Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/952997298",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "As discussed, @achow101 ran his simulation with this modification. It did find 10% more changeless solutions and an overall decrease in fee expenditure, but there were a few outcomes where the final input set that was used to fund transactions caused change output to be created that just exceeded the dust limit. \r\n\r\nEdit: I see that you appear to always drop everything below `min_change` to fees, so we'd have to see how that changes the overall fee, and whether we might still need a limit for the overshoot of BnB inputs. Or perhaps whether we have to weight the excess differently than other types of costs that are less avoidable.",
      "created_at" : "2021-10-28T14:24:14Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23367#issuecomment-953899056",
      "id" : 953899056,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23367",
      "node_id" : "IC_kwDOABII584421gw",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/953899056/reactions"
      },
      "updated_at" : "2021-10-28T14:43:12Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/953899056",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/4060799?v=4",
         "events_url" : "https://api.github.com/users/Xekyo/events{/privacy}",
         "followers_url" : "https://api.github.com/users/Xekyo/followers",
         "following_url" : "https://api.github.com/users/Xekyo/following{/other_user}",
         "gists_url" : "https://api.github.com/users/Xekyo/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/Xekyo",
         "id" : 4060799,
         "login" : "Xekyo",
         "node_id" : "MDQ6VXNlcjQwNjA3OTk=",
         "organizations_url" : "https://api.github.com/users/Xekyo/orgs",
         "received_events_url" : "https://api.github.com/users/Xekyo/received_events",
         "repos_url" : "https://api.github.com/users/Xekyo/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/Xekyo/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/Xekyo/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/Xekyo"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "> Edit: I see that you appear to always drop everything below `min_change` to fees, so we'd have to see how that changes the overall fee, and whether we might still need a limit for the overshoot of BnB inputs. \r\n\r\nJust to clarify, dropping to fees behaviour is not changed. I just moved it higher and passed the threshold to coin selection so waste calculation is based on the same tx structure as transaction building. What's new is that in case of BnB we will never created change now. \r\n\r\nWe already limit max absolute fee by `DEFAULT_TRANSACTION_MAXFEE = COIN / 10`. Maybe we can just lower the default?\r\n\r\nI tend to think that whenever we have a solution with huge excess from BnB, we should get the same solution but with change instead of excess found by other selection algorithms. The problem is that SRD has min change of COIN/100/2, and knapsack is not deterministic AFAIK. Maybe need to try to prove this more formally? Or consider adding another algo in the mix that will deterministically produce a solution with change\r\n",
      "created_at" : "2021-10-29T07:00:33Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23367#issuecomment-954480452",
      "id" : 954480452,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23367",
      "node_id" : "IC_kwDOABII58445DdE",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/954480452/reactions"
      },
      "updated_at" : "2021-10-29T07:00:33Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/954480452",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "ISTM what this is really showing is that our calculation for the upper bound is incorrect. It's a bit overkill to remove the upper bound entirely; rather we should fix the calculation such that it finds the correct upper bound for what we are willing to throw away.",
      "created_at" : "2021-12-15T19:02:16Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23367#issuecomment-995094431",
      "id" : 995094431,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23367",
      "node_id" : "IC_kwDOABII5847T--f",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/995094431/reactions"
      },
      "updated_at" : "2021-12-15T19:02:16Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/995094431",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23367#discussion_r772646102"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23367"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772646102"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 5f035efcef059922afb32bd2f75f32f6cd953984 \"wallet: do not count wallet utxos as external\"\r\n\r\nnit: don't use camelCase",
      "commit_id" : "2dc0471378037f4084dda345ac27b71ddb82b42d",
      "created_at" : "2021-12-20T20:22:47Z",
      "diff_hunk" : "@@ -992,14 +992,28 @@ bool FundTransaction(CWallet& wallet, CMutableTransaction& tx, CAmount& nFeeRet,\n \n     coinControl.fAllowOtherInputs = true;\n \n-    for (const CTxIn& txin : tx.vin) {\n-        coinControl.Select(txin.prevout);\n-    }\n-\n     // Acquire the locks to prevent races to the new locked unspents between the\n     // CreateTransaction call and LockCoin calls (when lockUnspents is true).\n     LOCK(wallet.cs_wallet);\n \n+    // Fetch specified UTXOs from the UTXO set to get the scriptPubKeys and values of the outputs being selected\n+    // and to match with the given solving_data. Only used for non-wallet outputs.\n+    std::map<COutPoint, Coin> coins;\n+    for (const CTxIn& txin : tx.vin) {\n+        coins[txin.prevout]; // Create empty map entry keyed by prevout.\n+    }\n+    wallet.chain().findCoins(coins);\n+\n+    for (const CTxIn& txin : tx.vin) {\n+        // if it's not in the wallet and corresponding UTXO is found than select as external output\n+        const auto& outPoint = txin.prevout;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23367#discussion_r772646102",
      "id" : 772646102,
      "line" : 1015,
      "node_id" : "PRRC_kwDOABII584uDaTW",
      "original_commit_id" : "5f035efcef059922afb32bd2f75f32f6cd953984",
      "original_line" : 1009,
      "original_position" : 22,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 22,
      "pull_request_review_id" : 836783624,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23367",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772646102/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2021-12-20T21:21:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772646102",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23367#discussion_r772649929"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23367"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772649929"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In ea7056bf511f4b61f693dba4fc7691379ea21f36 \"test: verify waste for coinselection\"\r\n\r\nThis doesn't compile\r\n\r\n```suggestion\r\n        result10->ComputeAndSetWaste(coin_selection_params_bnb.m_cost_of_change);\r\n```",
      "commit_id" : "2dc0471378037f4084dda345ac27b71ddb82b42d",
      "created_at" : "2021-12-20T20:30:20Z",
      "diff_hunk" : "@@ -343,8 +343,10 @@ BOOST_AUTO_TEST_CASE(bnb_search_test)\n         coin_control.fAllowOtherInputs = true;\n         coin_control.Select(COutPoint(coins.at(0).tx->GetHash(), coins.at(0).i));\n         coin_selection_params_bnb.m_effective_feerate = CFeeRate(0);\n-        const auto result10 = SelectCoins(*wallet, coins, 10 * CENT, coin_control, coin_selection_params_bnb);\n+        auto result10 = SelectCoins(*wallet, coins, 10 * CENT, coin_control, coin_selection_params_bnb);\n         BOOST_CHECK(result10);\n+        result10->ComputeAndSetWaste(coin_selection_params_bnb);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23367#discussion_r772649929",
      "id" : 772649929,
      "line" : 342,
      "node_id" : "PRRC_kwDOABII584uDbPJ",
      "original_commit_id" : "ea7056bf511f4b61f693dba4fc7691379ea21f36",
      "original_line" : 348,
      "original_position" : 7,
      "original_start_line" : null,
      "path" : "src/wallet/test/coinselector_tests.cpp",
      "position" : 7,
      "pull_request_review_id" : 836783624,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23367",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772649929/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2021-12-20T21:21:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772649929",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23367#discussion_r772653438"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23367"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772653438"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In ea7056bf511f4b61f693dba4fc7691379ea21f36 \"test: verify waste for coinselection\"\r\n\r\nThis fails.",
      "commit_id" : "2dc0471378037f4084dda345ac27b71ddb82b42d",
      "created_at" : "2021-12-20T20:37:25Z",
      "diff_hunk" : "@@ -343,8 +343,10 @@ BOOST_AUTO_TEST_CASE(bnb_search_test)\n         coin_control.fAllowOtherInputs = true;\n         coin_control.Select(COutPoint(coins.at(0).tx->GetHash(), coins.at(0).i));\n         coin_selection_params_bnb.m_effective_feerate = CFeeRate(0);\n-        const auto result10 = SelectCoins(*wallet, coins, 10 * CENT, coin_control, coin_selection_params_bnb);\n+        auto result10 = SelectCoins(*wallet, coins, 10 * CENT, coin_control, coin_selection_params_bnb);\n         BOOST_CHECK(result10);\n+        result10->ComputeAndSetWaste(coin_selection_params_bnb);\n+        BOOST_CHECK(result10->GetWaste() == -68 * 3); // - (long_term_fee * input) * 3coins",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23367#discussion_r772653438",
      "id" : 772653438,
      "line" : 343,
      "node_id" : "PRRC_kwDOABII584uDcF-",
      "original_commit_id" : "ea7056bf511f4b61f693dba4fc7691379ea21f36",
      "original_line" : 349,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/wallet/test/coinselector_tests.cpp",
      "position" : 8,
      "pull_request_review_id" : 836783624,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23367",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772653438/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2021-12-20T21:21:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772653438",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23367#discussion_r772654819"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23367"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772654819"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 803ae6e65a94495b81158147a715f03f117dc700 \"wallet: unify max signature logic\"\r\n\r\nnit: Did these have to move?",
      "commit_id" : "2dc0471378037f4084dda345ac27b71ddb82b42d",
      "created_at" : "2021-12-20T20:40:08Z",
      "diff_hunk" : "@@ -66,14 +63,13 @@ class COutput\n };\n \n //Get the marginal bytes of spending the specified output\n-int CalculateMaximumSignedInputSize(const CTxOut& txout, const CWallet* pwallet, bool use_max_sig = false);\n-int CalculateMaximumSignedInputSize(const CTxOut& txout, const SigningProvider* pwallet, bool use_max_sig = false);\n-\n struct TxSize {\n     int64_t vsize{-1};\n     int64_t weight{-1};\n };\n \n+int CalculateMaximumSignedInputSize(const CTxOut& txout, const CWallet* pwallet, const CCoinControl* coin_control = nullptr);\n+int CalculateMaximumSignedInputSize(const CTxOut& txout, const COutPoint outpoint, const SigningProvider* pwallet, const CCoinControl* coin_control = nullptr);",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23367#discussion_r772654819",
      "id" : 772654819,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584uDcbj",
      "original_commit_id" : "803ae6e65a94495b81158147a715f03f117dc700",
      "original_line" : 72,
      "original_position" : 50,
      "original_start_line" : null,
      "path" : "src/wallet/spend.h",
      "position" : 50,
      "pull_request_review_id" : 836783624,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23367",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772654819/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2021-12-20T21:21:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772654819",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23367#discussion_r772658059"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23367"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772658059"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 7d839eb13f579e61b1048b756f84b07aadd05e75 \"wallet: CInputCoin store weight\"\r\n\r\nSince the callers have to be changed to use `TxSize` anyways, why not just take a `TxSize` here rather than the two components individually?",
      "commit_id" : "2dc0471378037f4084dda345ac27b71ddb82b42d",
      "created_at" : "2021-12-20T20:46:22Z",
      "diff_hunk" : "@@ -32,9 +32,10 @@ class CInputCoin {\n         effective_value = txout.nValue;\n     }\n \n-    CInputCoin(const CTransactionRef& tx, unsigned int i, int input_bytes) : CInputCoin(tx, i)\n+    CInputCoin(const CTransactionRef& tx, unsigned int i, int input_bytes, int input_weight) : CInputCoin(tx, i)",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23367#discussion_r772658059",
      "id" : 772658059,
      "line" : null,
      "node_id" : "PRRC_kwDOABII584uDdOL",
      "original_commit_id" : "7d839eb13f579e61b1048b756f84b07aadd05e75",
      "original_line" : 35,
      "original_position" : 5,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.h",
      "position" : 5,
      "pull_request_review_id" : 836783624,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23367",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772658059/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2021-12-20T21:21:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772658059",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23367#discussion_r772658314"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23367"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772658314"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 7d839eb13f579e61b1048b756f84b07aadd05e75 \"wallet: CInputCoin store weight\"\r\n\r\nPerhaps store a `TxSize` instead of the two components?",
      "commit_id" : "2dc0471378037f4084dda345ac27b71ddb82b42d",
      "created_at" : "2021-12-20T20:46:54Z",
      "diff_hunk" : "@@ -32,9 +32,10 @@ class CInputCoin {\n         effective_value = txout.nValue;\n     }\n \n-    CInputCoin(const CTransactionRef& tx, unsigned int i, int input_bytes) : CInputCoin(tx, i)\n+    CInputCoin(const CTransactionRef& tx, unsigned int i, int input_bytes, int input_weight) : CInputCoin(tx, i)\n     {\n         m_input_bytes = input_bytes;\n+        m_input_weight = input_weight;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23367#discussion_r772658314",
      "id" : 772658314,
      "line" : 38,
      "node_id" : "PRRC_kwDOABII584uDdSK",
      "original_commit_id" : "7d839eb13f579e61b1048b756f84b07aadd05e75",
      "original_line" : 38,
      "original_position" : 8,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.h",
      "position" : 8,
      "pull_request_review_id" : 836783624,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23367",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772658314/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2021-12-20T21:21:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772658314",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23367#discussion_r772659439"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23367"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772659439"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 3b7d2d7ecd78f6c32c731293049a059f1da7cdc6 \"WIP. Add CInputCoint::m_isSegwit\"\r\n\r\nnit: snake_case is preferred.",
      "commit_id" : "2dc0471378037f4084dda345ac27b71ddb82b42d",
      "created_at" : "2021-12-20T20:49:16Z",
      "diff_hunk" : "@@ -32,10 +32,11 @@ class CInputCoin {\n         effective_value = txout.nValue;\n     }\n \n-    CInputCoin(const CTransactionRef& tx, unsigned int i, int input_bytes, int input_weight) : CInputCoin(tx, i)\n+    CInputCoin(const CTransactionRef& tx, unsigned int i, int input_bytes, int input_weight, bool isSegwit) : CInputCoin(tx, i)\n     {\n         m_input_bytes = input_bytes;\n         m_input_weight = input_weight;\n+        m_isSegwit = isSegwit;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23367#discussion_r772659439",
      "id" : 772659439,
      "line" : 39,
      "node_id" : "PRRC_kwDOABII584uDdjv",
      "original_commit_id" : "3b7d2d7ecd78f6c32c731293049a059f1da7cdc6",
      "original_line" : 39,
      "original_position" : 9,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.h",
      "position" : 9,
      "pull_request_review_id" : 836783624,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23367",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772659439/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2021-12-20T21:21:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772659439",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23367#discussion_r772662729"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23367"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772662729"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 6423998409736be5728bb5826cfa89e1033ed816 \"WIP. Return change from SelectionResult\"\r\n\r\nnit: snake_case is preferred",
      "commit_id" : "2dc0471378037f4084dda345ac27b71ddb82b42d",
      "created_at" : "2021-12-20T20:55:35Z",
      "diff_hunk" : "@@ -432,3 +448,52 @@ bool SelectionResult::operator<(SelectionResult other) const\n     // As this operator is only used in std::min_element, we want the result that has more inputs when waste are equal.\n     return *m_waste < *other.m_waste || (*m_waste == *other.m_waste && m_selected_inputs.size() > other.m_selected_inputs.size());\n }\n+\n+CAmount SelectionResult::GetInputsWeight() const\n+{\n+    // WU required to store input counter\n+    // 1 vbyte for the default case already counted in non_input_size\n+    int weight = (GetSizeOfCompactSize(m_selected_inputs.size()) - 1)*4;\n+    bool hasWitnessInputs = false;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23367#discussion_r772662729",
      "id" : 772662729,
      "line" : 456,
      "node_id" : "PRRC_kwDOABII584uDeXJ",
      "original_commit_id" : "6423998409736be5728bb5826cfa89e1033ed816",
      "original_line" : 457,
      "original_position" : 52,
      "original_start_line" : null,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 52,
      "pull_request_review_id" : 836783624,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23367",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772662729/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2021-12-20T21:21:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772662729",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23367#discussion_r772667838"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23367"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772667838"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 6423998409736be5728bb5826cfa89e1033ed816 \"WIP. Return change from SelectionResult\"\r\n\r\nThis is currently unnecessary because in the loop above, the values of preset inputs are subtracted from `value_to_select`.",
      "commit_id" : "2dc0471378037f4084dda345ac27b71ddb82b42d",
      "created_at" : "2021-12-20T21:05:13Z",
      "diff_hunk" : "@@ -492,6 +499,7 @@ std::optional<SelectionResult> SelectCoins(const CWallet& wallet, const std::vec\n          */\n         preset_inputs.Insert(coin, 0, false, 0, 0, false);\n     }\n+    // TODO: value_to_select -= preset_inputs.GetSelectionAmount();",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23367#discussion_r772667838",
      "id" : 772667838,
      "line" : 502,
      "node_id" : "PRRC_kwDOABII584uDfm-",
      "original_commit_id" : "6423998409736be5728bb5826cfa89e1033ed816",
      "original_line" : 502,
      "original_position" : 48,
      "original_start_line" : null,
      "path" : "src/wallet/spend.cpp",
      "position" : 48,
      "pull_request_review_id" : 836783624,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23367",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772667838/reactions"
      },
      "side" : "RIGHT",
      "start_line" : null,
      "start_side" : null,
      "subject_type" : "line",
      "updated_at" : "2021-12-20T21:21:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772667838",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23367#discussion_r772668947"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23367"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772668947"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 6423998409736be5728bb5826cfa89e1033ed816 \"WIP. Return change from SelectionResult\"\r\n\r\n```suggestion\r\n    coin_selection_params.m_cost_of_change = std::max(GetDustThreshold(change_prototype_txout, coin_selection_params.m_discard_feerate), coin_selection_params.m_cost_of_change);\r\n```",
      "commit_id" : "2dc0471378037f4084dda345ac27b71ddb82b42d",
      "created_at" : "2021-12-20T21:07:38Z",
      "diff_hunk" : "@@ -744,9 +756,17 @@ static bool CreateTransactionInternal(\n     coin_selection_params.m_change_fee = coin_selection_params.m_effective_feerate.GetFee(coin_selection_params.change_output_size);\n     coin_selection_params.m_cost_of_change = coin_selection_params.m_discard_feerate.GetFee(coin_selection_params.change_spend_size) + coin_selection_params.m_change_fee;\n \n+    // We want to drop the change to fees if:\n+    // 1. The change output would be dust\n+    // 2. The change is within the (almost) exact match window, i.e. it is less than or equal to the cost of the change output (cost_of_change)\n+    const auto dust = GetDustThreshold(change_prototype_txout, coin_selection_params.m_discard_feerate);\n+    // TODO: disambiguate between min_change and m_cost_of_change\n+    if (dust > coin_selection_params.m_cost_of_change) coin_selection_params.m_cost_of_change = dust;",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23367#discussion_r772668947",
      "id" : 772668947,
      "line" : 764,
      "node_id" : "PRRC_kwDOABII584uDf4T",
      "original_commit_id" : "6423998409736be5728bb5826cfa89e1033ed816",
      "original_line" : 764,
      "original_position" : 88,
      "original_start_line" : 762,
      "path" : "src/wallet/spend.cpp",
      "position" : 88,
      "pull_request_review_id" : 836783624,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23367",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772668947/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 762,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2021-12-20T21:21:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772668947",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "_links" : {
         "html" : {
            "href" : "https://github.com/bitcoin/bitcoin/pull/23367#discussion_r772672988"
         },
         "pull_request" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23367"
         },
         "self" : {
            "href" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772672988"
         }
      },
      "author_association" : "MEMBER",
      "body" : "In 6423998409736be5728bb5826cfa89e1033ed816 \"WIP. Return change from SelectionResult\"\r\n\r\nI feel like all of the size calculation stuff in this function is unnecessary. We don't need `GetChange` to be exact down to the satoshi. Rather it just needs to be close enough to the real change (and essentially be whether there is going to be a change output) and its exact value can be adjusted later in `CreateTransaction` once we know the real size of the transaction. That adjustment doesn't need to account for dust because that should be taken care of here.\r\n\r\nIt also seems like it is not necessary to calculate the change on the fly like this. Rather the coin selection algorithms should already know what the change is based on their parameters when they selected. While we don't know the fees exactly due to rolling them into the target, we do know how much was selected and what the input fees should be, so we can calculate the change in the `SelectCoins*` functions and just set it in `SelectionResult`.",
      "commit_id" : "2dc0471378037f4084dda345ac27b71ddb82b42d",
      "created_at" : "2021-12-20T21:15:58Z",
      "diff_hunk" : "@@ -432,3 +448,52 @@ bool SelectionResult::operator<(SelectionResult other) const\n     // As this operator is only used in std::min_element, we want the result that has more inputs when waste are equal.\n     return *m_waste < *other.m_waste || (*m_waste == *other.m_waste && m_selected_inputs.size() > other.m_selected_inputs.size());\n }\n+\n+CAmount SelectionResult::GetInputsWeight() const\n+{\n+    // WU required to store input counter\n+    // 1 vbyte for the default case already counted in non_input_size\n+    int weight = (GetSizeOfCompactSize(m_selected_inputs.size()) - 1)*4;\n+    bool hasWitnessInputs = false;\n+\n+    for (const auto& coin : m_selected_inputs) {\n+        weight += coin.m_input_weight;\n+        hasWitnessInputs |= coin.m_isSegwit;\n+    }\n+\n+    // non_input_size counted witness marker and flag as 1vbyte, correcting this now for correct final fee\n+    if (hasWitnessInputs) {\n+        weight -= 2;\n+    } else {\n+        weight -= 4;\n+\n+        // correct for witness stack size counted but not serialized when there is not witness inputs\n+        weight -= m_selected_inputs.size();\n+    }\n+\n+    return weight;\n+}\n+\n+CAmount SelectionResult::GetChange(const CoinSelectionParams& coin_selection_params) const\n+{\n+    if (m_force_no_change) return 0;\n+\n+    CAmount change = GetSelectedValue() - m_target;\n+    // TODO: rename var maybe?\n+    if (!m_use_effective) { // opposite of m_subtract_fee_outputs\n+        // m_target already includes not_input_fees\n+        // but as they are payed by recipients we can add them back to our change\n+        const CAmount not_input_fees = coin_selection_params.m_effective_feerate.GetFee(coin_selection_params.tx_noinputs_size);\n+        change += not_input_fees;\n+    } else {\n+        const auto size = GetVirtualTransactionSize(GetInputsWeight(), 0, 0);\n+        change -= coin_selection_params.m_effective_feerate.GetFee(size);\n+    }\n+    assert(change >= 0);\n+\n+    if (change <= coin_selection_params.m_cost_of_change) { // TODO: less or less_or_equal\n+        change = 0;\n+    }\n+\n+    return change;\n+}",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23367#discussion_r772672988",
      "id" : 772672988,
      "line" : 498,
      "node_id" : "PRRC_kwDOABII584uDg3c",
      "original_commit_id" : "6423998409736be5728bb5826cfa89e1033ed816",
      "original_line" : 499,
      "original_position" : 94,
      "original_start_line" : 477,
      "path" : "src/wallet/coinselection.cpp",
      "position" : 94,
      "pull_request_review_id" : 836783624,
      "pull_request_url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23367",
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772672988/reactions"
      },
      "side" : "RIGHT",
      "start_line" : 476,
      "start_side" : "RIGHT",
      "subject_type" : "line",
      "updated_at" : "2021-12-20T21:21:19Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/772672988",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/3782274?v=4",
         "events_url" : "https://api.github.com/users/achow101/events{/privacy}",
         "followers_url" : "https://api.github.com/users/achow101/followers",
         "following_url" : "https://api.github.com/users/achow101/following{/other_user}",
         "gists_url" : "https://api.github.com/users/achow101/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/achow101",
         "id" : 3782274,
         "login" : "achow101",
         "node_id" : "MDQ6VXNlcjM3ODIyNzQ=",
         "organizations_url" : "https://api.github.com/users/achow101/orgs",
         "received_events_url" : "https://api.github.com/users/achow101/received_events",
         "repos_url" : "https://api.github.com/users/achow101/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/achow101/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/achow101/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/achow101"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "<!--cf906140f33d8803c4a75a2196329ecb-->\n This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
      "created_at" : "2022-01-11T10:36:57Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23367#issuecomment-1009830877",
      "id" : 1009830877,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23367",
      "node_id" : "IC_kwDOABII5848MMvd",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 0,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 0,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1009830877/reactions"
      },
      "updated_at" : "2022-01-11T10:36:57Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1009830877",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/39886733?v=4",
         "events_url" : "https://api.github.com/users/DrahtBot/events{/privacy}",
         "followers_url" : "https://api.github.com/users/DrahtBot/followers",
         "following_url" : "https://api.github.com/users/DrahtBot/following{/other_user}",
         "gists_url" : "https://api.github.com/users/DrahtBot/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/DrahtBot",
         "id" : 39886733,
         "login" : "DrahtBot",
         "node_id" : "MDQ6VXNlcjM5ODg2NzMz",
         "organizations_url" : "https://api.github.com/users/DrahtBot/orgs",
         "received_events_url" : "https://api.github.com/users/DrahtBot/received_events",
         "repos_url" : "https://api.github.com/users/DrahtBot/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/DrahtBot/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/DrahtBot"
      }
   },
   {
      "author_association" : "MEMBER",
      "body" : "This approach drops huge amounts to fees in the cases introduced in #24580. In the short-term I'll work on just increasing the boundary for BnB search to improve efficiency of coin selection.",
      "created_at" : "2022-03-30T07:36:38Z",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23367#issuecomment-1082732678",
      "id" : 1082732678,
      "issue_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23367",
      "node_id" : "IC_kwDOABII585AiTCG",
      "performed_via_github_app" : null,
      "reactions" : {
         "+1" : 1,
         "-1" : 0,
         "confused" : 0,
         "eyes" : 0,
         "heart" : 0,
         "hooray" : 0,
         "laugh" : 0,
         "rocket" : 0,
         "total_count" : 1,
         "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1082732678/reactions"
      },
      "updated_at" : "2022-03-30T07:36:38Z",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/1082732678",
      "user" : {
         "avatar_url" : "https://avatars.githubusercontent.com/u/1466284?v=4",
         "events_url" : "https://api.github.com/users/S3RK/events{/privacy}",
         "followers_url" : "https://api.github.com/users/S3RK/followers",
         "following_url" : "https://api.github.com/users/S3RK/following{/other_user}",
         "gists_url" : "https://api.github.com/users/S3RK/gists{/gist_id}",
         "gravatar_id" : "",
         "html_url" : "https://github.com/S3RK",
         "id" : 1466284,
         "login" : "S3RK",
         "node_id" : "MDQ6VXNlcjE0NjYyODQ=",
         "organizations_url" : "https://api.github.com/users/S3RK/orgs",
         "received_events_url" : "https://api.github.com/users/S3RK/received_events",
         "repos_url" : "https://api.github.com/users/S3RK/repos",
         "site_admin" : false,
         "starred_url" : "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
         "subscriptions_url" : "https://api.github.com/users/S3RK/subscriptions",
         "type" : "User",
         "url" : "https://api.github.com/users/S3RK"
      }
   }
]
