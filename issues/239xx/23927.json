{
   "active_lock_reason" : null,
   "assignee" : null,
   "assignees" : [],
   "author_association" : "CONTRIBUTOR",
   "body" : "This PR prevents `getblockfrompeer` from getting used on blocks that the node has not synced past yet if the node is in running in prune mode.\r\n\r\n### Problem\r\n\r\nWhile a node is still catching up to the tip that it is aware of via the headers, the user can currently use  to fetch blocks close to or at the tip. These blocks are stored in the block/rev file that otherwise contains blocks the node is receiving as part of the syncing process.\r\n\r\nThis creates a problem for pruned nodes: The files containing a fetched block are not pruned during syncing because they contain a block close to the tip. This means the entire file (~130MB) will not be pruned until the tip has moved on far enough from the fetched block. In extreme cases with heavy pruning (like 550) and multiple blocks being fetched this could mean that the disc usage far exceeds what the user expects, potentially running out of space.\r\n\r\n### Approach\r\n\r\nThere would be certainly other approaches that could fix the problem while still allowing the current behavior, but all of the ideas I came up with seemed like overkill for a niche problem on a new RPC where it's still unclear how and how much it will be used.\r\n\r\n### Testing\r\n\r\nSo far I did not see a simple enough way to test this I am still looking into it and if it's complex will potentially add it in a follow-up. What would be needed is a way to have a node fetch headers but not sync the blocks yet, that seems like a pattern that could be generally useful.\r\n\r\nTo manually reproduce the problematic behavior:\r\n1. Start a node with current `master` with `-prune=550` and an empty/new datadir, Testnet and Mainnet should both work.\r\n2. While the node is syncing run `getblockfrompeer` on the current tip and a few other recent blocks.\r\n3. Go to your datadir and observe the blocks folder: There should be a few full `blk*.dat` and `rev*.dat` files that are not being pruned. When you \"pinned\" a few of these files the blocks folder should be significantly above the target size of 550MB.",
   "closed_at" : null,
   "closed_by" : null,
   "comments" : 0,
   "comments_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23927/comments",
   "created_at" : "2021-12-31T16:37:56Z",
   "draft" : false,
   "events_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23927/events",
   "html_url" : "https://github.com/bitcoin/bitcoin/pull/23927",
   "id" : 1091622245,
   "labels" : [],
   "labels_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23927/labels{/name}",
   "locked" : false,
   "milestone" : null,
   "node_id" : "PR_kwDOABII584wbHDQ",
   "number" : 23927,
   "performed_via_github_app" : null,
   "pull_request" : {
      "diff_url" : "https://github.com/bitcoin/bitcoin/pull/23927.diff",
      "html_url" : "https://github.com/bitcoin/bitcoin/pull/23927",
      "merged_at" : null,
      "patch_url" : "https://github.com/bitcoin/bitcoin/pull/23927.patch",
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/pulls/23927"
   },
   "reactions" : {
      "+1" : 0,
      "-1" : 0,
      "confused" : 0,
      "eyes" : 0,
      "heart" : 0,
      "hooray" : 0,
      "laugh" : 0,
      "rocket" : 0,
      "total_count" : 0,
      "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23927/reactions"
   },
   "repository_url" : "https://api.github.com/repos/bitcoin/bitcoin",
   "state" : "open",
   "timeline_url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23927/timeline",
   "title" : "rpc: Pruning nodes can not fetch blocks before syncing past their height",
   "updated_at" : "2021-12-31T16:37:56Z",
   "url" : "https://api.github.com/repos/bitcoin/bitcoin/issues/23927",
   "user" : {
      "avatar_url" : "https://avatars.githubusercontent.com/u/1322187?v=4",
      "events_url" : "https://api.github.com/users/fjahr/events{/privacy}",
      "followers_url" : "https://api.github.com/users/fjahr/followers",
      "following_url" : "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url" : "https://api.github.com/users/fjahr/gists{/gist_id}",
      "gravatar_id" : "",
      "html_url" : "https://github.com/fjahr",
      "id" : 1322187,
      "login" : "fjahr",
      "node_id" : "MDQ6VXNlcjEzMjIxODc=",
      "organizations_url" : "https://api.github.com/users/fjahr/orgs",
      "received_events_url" : "https://api.github.com/users/fjahr/received_events",
      "repos_url" : "https://api.github.com/users/fjahr/repos",
      "site_admin" : false,
      "starred_url" : "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url" : "https://api.github.com/users/fjahr/subscriptions",
      "type" : "User",
      "url" : "https://api.github.com/users/fjahr"
   }
}
